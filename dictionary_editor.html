<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dictionary Editor v3 + OSM Import</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;--danger:#ef4444;--accent:#4aa8ff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;display:flex;justify-content:space-between;align-items:center}
main{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:4px 8px;border-radius:8px;cursor:pointer;margin:2px;font-size:12px}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.btn.accent{background:#123a66;border-color:#1e5391}
.tree{list-style:none;padding-left:18px}
.tree li{margin:4px 0}
.coords{color:var(--muted);font-size:12px;margin-left:6px}
.tools{display:inline-flex;gap:4px;flex-wrap:wrap;margin-left:6px}
input.search{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);margin:8px 0;background:#0f1624;color:#fff}
#mapModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
#mapBox{background:#111;padding:10px;border-radius:8px;width:82%;height:82%;display:flex;flex-direction:column}
#map{flex:1;border:1px solid var(--border)}
#previewMap{height:320px;margin-top:10px;border:1px solid var(--border);border-radius:8px}
.levels{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
.levels input{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.levels .btn{height:32px}
.badge{display:inline-block;background:#23314d;border:1px solid #334567;border-radius:6px;padding:2px 6px;margin-left:6px;color:#cfe0ff}
.muted{color:var(--muted)}
@media (max-width:1000px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div>
    <strong>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–æ–∫–∞—Ü–∏–π v3 + OSM</strong>
    <span class="badge">–∏–º–ø–æ—Ä—Ç —Ä–∞–π–æ–Ω–æ–≤ + –º–µ—Ç—Ä–æ</span>
  </div>
  <div>
    <button class="btn accent" onclick="importOSM()">–ò–º–ø–æ—Ä—Ç –∏–∑ OSM (–¢–∞—à–∫–µ–Ω—Ç)</button>
    <button class="btn" onclick="exportDict()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <label class="btn"><input type="file" id="importFile" style="display:none">–ò–º–ø–æ—Ä—Ç JSON</label>
  </div>
</header>

<main>
  <section class="panel">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä</h3>
    <input class="search" id="locSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º...">
    <div style="margin-bottom:6px">
      <button class="btn" onclick="addRoot()">+ –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
    </div>
    <ul id="tree" class="tree"></ul>
  </section>

  <section class="panel">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div id="selectsBox"></div>
    <div id="previewMap"></div>
  </section>
</main>

<div id="mapModal">
  <div id="mapBox">
    <div style="margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
      <span id="mapTitle" style="color:#fff"></span>
      <div>
        <button class="btn" onclick="clearCoords()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn danger" onclick="closeMap()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const KEY="dictionaryInfiniteLocationsV3_OSM";
let dict = JSON.parse(localStorage.getItem(KEY) || JSON.stringify({
  levelLabels: ["–°—Ç—Ä–∞–Ω–∞","–ì–æ—Ä–æ–¥","–†–∞–π–æ–Ω/–ú–µ—Ç—Ä–æ"],
  tree: {}
}));
function save(){ localStorage.setItem(KEY, JSON.stringify(dict)); }
function sortKeys(o){ return Object.keys(o||{}).filter(k=>k!=="coords" && k!=="children").sort((a,b)=>a.localeCompare(b,'ru',{sensitivity:'base'})); }

// ====== TREE RENDER ======
function renderTree(){
  const filter = (document.getElementById('locSearch').value||'').trim().toLowerCase();
  const ul = document.getElementById('tree'); ul.innerHTML='';
  function matches(name,node){
    if(!filter) return true;
    if(name.toLowerCase().includes(filter)) return true;
    for(const k of Object.keys(node.children||{})){ if(matches(k, node.children[k])) return true; }
    return false;
  }
  function renderLevel(obj, parentUl, path){
    const keys = sortKeys(obj);
    keys.forEach(key=>{
      const node = obj[key]; if(!matches(key,node)) return;
      const li=document.createElement('li');
      const title=document.createElement('span'); title.textContent=key; li.appendChild(title);
      if(node.coords){ const c=document.createElement('span'); c.className='coords'; c.textContent=node.coords.join(', '); li.appendChild(c); }
      const tools=document.createElement('span'); tools.className='tools';
      const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å'; addBtn.onclick=()=>addNode(path.concat(key));
      const renBtn=document.createElement('button'); renBtn.className='btn'; renBtn.textContent='‚úé'; renBtn.onclick=()=>renameNode(path.concat(key));
      const delBtn=document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='‚ùå'; delBtn.onclick=()=>deleteNode(path.concat(key));
      const geoBtn=document.createElement('button'); geoBtn.className='btn accent'; geoBtn.textContent='üìç'; geoBtn.onclick=()=>setCoords(path.concat(key));
      tools.append(addBtn,renBtn,delBtn,geoBtn); li.appendChild(tools);
      const subUl=document.createElement('ul'); subUl.className='tree'; renderLevel(node.children||{}, subUl, path.concat(key)); if(subUl.children.length) li.appendChild(subUl);
      parentUl.appendChild(li);
    });
  }
  renderLevel(dict.tree, ul, []);
}
document.getElementById('locSearch').addEventListener('input', renderTree);

function getNodeByPath(path){ let cur=dict.tree,node=null; for(const name of path){ if(!cur[name]) return null; node=cur[name]; cur=node.children||{}; } return node; }
function getParentAndKey(path){ if(path.length===0) return {parentObj:dict.tree,key:null}; const key=path[path.length-1]; let cur=dict.tree; for(let i=0;i<path.length-1;i++){ const name=path[i]; if(!cur[name]) return null; cur=cur[name].children||(cur[name].children={}); } return {parentObj:cur,key}; }
function addRoot(){ const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ'); if(!name) return; dict.tree[name]=dict.tree[name]||{children:{}}; save(); renderTree(); renderPreview(); }
function addNode(path){ const parentNode=path.length?getNodeByPath(path):null; const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ'); if(!name) return; const children=parentNode?(parentNode.children||(parentNode.children={})):dict.tree; if(children[name]){alert('–£–∂–µ –µ—Å—Ç—å');return;} children[name]={children:{}}; save(); renderTree(); renderPreview(); }
function renameNode(path){ const {parentObj,key}=getParentAndKey(path); if(!parentObj) return; const node=parentObj[key]; const name=prompt('–ù–æ–≤–æ–µ –∏–º—è',key); if(!name||name===key) return; if(parentObj[name]){alert('–£–∂–µ –µ—Å—Ç—å');return;} parentObj[name]=node; delete parentObj[key]; save(); renderTree(); renderPreview(); }
function deleteNode(path){ const {parentObj,key}=getParentAndKey(path); if(!parentObj) return; if(!confirm('–£–¥–∞–ª–∏—Ç—å '+key+'?')) return; delete parentObj[key]; save(); renderTree(); renderPreview(); }

// ====== MAP COORDS ======
let map,mapPath=null,previewMap,previewMarker=null;
function setCoords(path){ mapPath=path.slice(); document.getElementById('mapModal').style.display='flex'; document.getElementById('mapTitle').textContent='–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: '+path.join(' ‚Üí '); setTimeout(()=>{ if(!map){ map=L.map('map').setView([41.31,69.28],11); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); map.on('click', e=>{ if(!mapPath) return; const node=getNodeByPath(mapPath); if(!node) return; node.coords=[+e.latlng.lat.toFixed(6),+e.latlng.lng.toFixed(6)]; save(); renderTree(); updateMap(); }); } map.invalidateSize(); },80); }
function closeMap(){ document.getElementById('mapModal').style.display='none'; mapPath=null; }
function clearCoords(){ if(!mapPath) return; const node=getNodeByPath(mapPath); if(node&&node.coords){ delete node.coords; save(); renderTree(); updateMap(); } }

// ====== PREVIEW ======
function renderPreview(){ const box=document.getElementById('selectsBox'); box.innerHTML=''; addSelectLevel(dict.tree,0); if(!previewMap){ previewMap=L.map('previewMap').setView([41.31,69.28],5); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(previewMap);} updateMap(); function addSelectLevel(childrenObj,depth){ const wrap=document.createElement('div'); const label=document.createElement('label'); const niceLabel=dict.levelLabels[depth]||('–£—Ä–æ–≤–µ–Ω—å '+(depth+1)); label.textContent=niceLabel; const sel=document.createElement('select'); sel.innerHTML='<option value="">‚Äî</option>'; sortKeys(childrenObj).forEach(name=>{ const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt); }); sel.onchange=()=>{ while(wrap.nextSibling){ box.removeChild(wrap.nextSibling);} if(!sel.value){ updateMap(); return;} const node=childrenObj[sel.value]; updateMap(node); if(node&&node.children&&Object.keys(node.children).length){ addSelectLevel(node.children,depth+1);} }; wrap.appendChild(label); wrap.appendChild(sel); box.appendChild(wrap);} }
function updateMap(node){ if(previewMarker){ previewMap.removeLayer(previewMarker); previewMarker=null;} if(node&&node.coords){ previewMarker=L.marker(node.coords).addTo(previewMap).bindPopup('–í—ã–±—Ä–∞–Ω–æ: '+node._name||''); previewMap.setView(node.coords,12);} }

// ====== IMPORT OSM ======
async function importOSM(){
  alert('–ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ OSM. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 5‚Äì10 —Å–µ–∫—É–Ω–¥...');
  const overpass='https://overpass-api.de/api/interpreter';
  const query=`
  [out:json][timeout:25];
  area["name"="Tashkent"]->.a;
  (
    relation["admin_level"="9"](area.a);
    node["railway"="station"]["subway"="yes"](area.a);
  );
  out center;`;
  try{
    const res=await fetch(overpass,{method:'POST',body:query});
    const data=await res.json();
    if(!dict.tree["–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"]) dict.tree["–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"]={children:{}};
    if(!dict.tree["–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"].children["–¢–∞—à–∫–µ–Ω—Ç"]) dict.tree["–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"].children["–¢–∞—à–∫–µ–Ω—Ç"]={children:{}};
    const tash=dict.tree["–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"].children["–¢–∞—à–∫–µ–Ω—Ç"];
    if(!tash.children["–†–∞–π–æ–Ω—ã"]) tash.children["–†–∞–π–æ–Ω—ã"]={children:{}};
    if(!tash.children["–ú–µ—Ç—Ä–æ"]) tash.children["–ú–µ—Ç—Ä–æ"]={children:{}};
    data.elements.forEach(el=>{
      let name=(el.tags&& (el.tags.name:ru||el.tags.name_ru||el.tags.name))||el.tags.name||("–ë–µ–∑—ã–º—è–Ω–Ω—ã–π");
      if(el.type==="relation"){ // —Ä–∞–π–æ–Ω
        tash.children["–†–∞–π–æ–Ω—ã"].children[name]={coords:[el.center.lat,el.center.lon],children:{}};
      }
      if(el.type==="node"){ // –º–µ—Ç—Ä–æ
        tash.children["–ú–µ—Ç—Ä–æ"].children[name]={coords:[el.lat,el.lon],children:{}};
      }
    });
    save(); renderTree(); renderPreview(); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω: —Ä–∞–π–æ–Ω—ã + –º–µ—Ç—Ä–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ ¬´–¢–∞—à–∫–µ–Ω—Ç¬ª.');
  }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
}

// ====== EXPORT / IMPORT FILE ======
function exportDict(){ const blob=new Blob([JSON.stringify(dict,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='locations_v3_osm.json'; a.click(); }
document.getElementById('importFile').onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); dict=obj; save(); renderTree(); renderPreview(); alert('–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω'); }catch(err){ alert('–û—à–∏–±–∫–∞: '+err.message);} }; r.readAsText(f); };

renderTree(); renderPreview();
</script>
</body>
</html>
