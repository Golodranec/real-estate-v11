<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –ª–æ–∫–∞—Ü–∏–π ‚Äî –¢–∞—à–∫–µ–Ω—Ç</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body{margin:0;font-family:sans-serif;background:#0b0f16;color:#d7e2f2}
header{padding:10px;background:#0e1420;border-bottom:1px solid #273248;display:flex;gap:8px;align-items:center}
button{padding:6px 10px;border-radius:6px;border:1px solid #273248;background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:#4aa8ff}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.tabs{display:flex;gap:8px;margin:10px}
.tab{padding:6px 12px;background:#1a2234;border:1px solid #273248;border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:340px 1fr;height:calc(100vh - 60px)}
.sidebar{padding:10px;overflow:auto;background:#121826;border-right:1px solid #273248}
.list{margin-top:10px}
.item{padding:6px;border:1px solid #273248;margin-bottom:6px;border-radius:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.item:hover{border-color:#4aa8ff}
.tools{display:flex;gap:4px}
#map{width:100%;height:100%}
input,select{width:100%;padding:6px;margin:6px 0;border-radius:6px;border:1px solid #31405a;background:#0f1624;color:#fff}
.searchResults{background:#172133;border:1px solid #31405a;border-radius:6px;margin-top:4px;max-height:200px;overflow:auto}
.searchResults div{padding:6px;cursor:pointer}
.searchResults div:hover{background:#1a2234}
.sectionHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
</style>
</head>
<body>
<header>
  <h2 style="flex:1">–õ–æ–∫–∞—Ü–∏–∏ ‚Äî –¢–∞—à–∫–µ–Ω—Ç</h2>
  <button onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label><input type="file" id="importFile" style="display:none" onchange="importData(event)"><button>–ò–º–ø–æ—Ä—Ç</button></label>
  <button class="danger" onclick="resetData()">–°–±—Ä–æ—Å</button>
</header>
<div class="tabs">
  <div class="tab active" data-tab="metro">–ú–µ—Ç—Ä–æ</div>
  <div class="tab" data-tab="districts">–†–∞–π–æ–Ω—ã</div>
  <div class="tab" data-tab="blocks">–ú–∞—Å—Å–∏–≤—ã</div>
  <div class="tab" data-tab="address">–ê–¥—Ä–µ—Å–∞</div>
</div>
<main>
  <div class="sidebar">
    <div id="metroTab"></div>
    <div id="districtsTab" style="display:none"></div>
    <div id="blocksTab" style="display:none"></div>
    <div id="addressTab" style="display:none">
      <input id="addressInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ"/>
      <div id="searchResults" class="searchResults"></div>
    </div>
  </div>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const KEY="location_dict_v5";
let data=JSON.parse(localStorage.getItem(KEY) || "null");
if(!data){
  data={
    metro:[{name:"–û–ª–º–∞–∑–æ—Ä",lat:41.356,lng:69.203}],
    districts:[{name:"–Æ–Ω—É—Å–∞–±–∞–¥",lat:41.367,lng:69.287}],
    blocks:[{name:"–Æ–Ω—É—Å–∞–±–∞–¥-9",lat:41.370,lng:69.290,parentDistrict:"–Æ–Ω—É—Å–∞–±–∞–¥"}]
  };
  save();
}

let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let marker=null;
let placeMode=null;

function showMarker(lat,lng,label,draggable=false,onDragEnd=null){
  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lng],{draggable}).addTo(map).bindPopup(label).openPopup();
  map.setView([lat,lng],14);
  if(draggable && onDragEnd){
    marker.on("dragend", e=>{
      let pos=e.target.getLatLng();
      onDragEnd(pos.lat,pos.lng);
    });
  }
}

map.on("click",e=>{
  if(placeMode){
    let pos=e.latlng;
    placeMode(pos.lat,pos.lng);
    placeMode=null;
  }
});

function enablePlaceMode(item){
  alert("–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –¥–ª—è: "+item.name);
  placeMode=(lat,lng)=>{
    item.lat=lat; item.lng=lng; save();
    showMarker(lat,lng,item.name,true,(lat,lng)=>{ item.lat=lat; item.lng=lng; save(); });
  };
}

function renderSection(type,label,withParent=false){
  let box=document.getElementById(type+"Tab");
  box.innerHTML="";
  let header=document.createElement("div"); header.className="sectionHeader";
  header.innerHTML=`<b>${label}</b>`;
  let btn=document.createElement("button"); btn.textContent="+ –ù–æ–≤—ã–π";
  btn.onclick=()=>{
    let newItem={name:"–ù–æ–≤—ã–π "+label,lat:41.3111,lng:69.2797};
    if(withParent) newItem.parentDistrict="";
    data[type].push(newItem);
    save(); renderAll();
  };
  header.appendChild(btn); box.appendChild(header);

  data[type].forEach((item,i)=>{
    let div=document.createElement("div"); div.className="item";
    let span=document.createElement("span"); 
    span.textContent=item.name+(item.parentDistrict?` (${item.parentDistrict})`:"");
    div.appendChild(span);
    let tools=document.createElement("div"); tools.className="tools";
    let bEdit=document.createElement("button"); bEdit.textContent="‚úé";
    bEdit.onclick=(e)=>{
      e.stopPropagation();
      let newName=prompt("–ù–æ–≤–æ–µ –∏–º—è",item.name);
      if(newName){ item.name=newName; }
      save(); renderAll();
      showMarker(item.lat,item.lng,item.name,true,(lat,lng)=>{ item.lat=lat; item.lng=lng; save(); });
    };
    let bPlace=document.createElement("button"); bPlace.textContent="üìç";
    bPlace.onclick=(e)=>{ e.stopPropagation(); enablePlaceMode(item); };
    let bDel=document.createElement("button"); bDel.textContent="‚ùå"; bDel.className="danger";
    bDel.onclick=(e)=>{ e.stopPropagation(); if(confirm("–£–¥–∞–ª–∏—Ç—å "+item.name+"?")){ data[type].splice(i,1); save(); renderAll(); } };
    tools.appendChild(bEdit); tools.appendChild(bPlace); tools.appendChild(bDel);
    div.appendChild(tools);
    div.onclick=()=>showMarker(item.lat,item.lng,item.name);
    box.appendChild(div);
  });
}
function renderAll(){ renderSection("metro","–ú–µ—Ç—Ä–æ"); renderSection("districts","–†–∞–π–æ–Ω"); renderSection("blocks","–ú–∞—Å—Å–∏–≤",true); }
renderAll();

document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    ["metro","districts","blocks","address"].forEach(t=>{
      document.getElementById(t+"Tab").style.display=(tab.dataset.tab===t)?"block":"none";
    });
  };
});

document.getElementById("addressInput").addEventListener("input",e=>{
  let q=e.target.value.toLowerCase();
  let box=document.getElementById("searchResults"); box.innerHTML="";
  if(!q) return;
  let results=[];
  data.metro.forEach(it=>{ if(it.name.toLowerCase().includes(q)) results.push({...it,type:"–º–µ—Ç—Ä–æ"}); });
  data.districts.forEach(it=>{ if(it.name.toLowerCase().includes(q)) results.push({...it,type:"—Ä–∞–π–æ–Ω"}); });
  data.blocks.forEach(it=>{ if(it.name.toLowerCase().includes(q)) results.push({...it,type:"–º–∞—Å—Å–∏–≤",parent:it.parentDistrict}); });
  results.forEach(r=>{
    let div=document.createElement("div"); 
    div.textContent=r.name+" ("+r.type+(r.parent?`, —Ä–∞–π–æ–Ω: ${r.parent}`:"")+")";
    div.onclick=()=>showMarker(r.lat,r.lng,r.name);
    box.appendChild(div);
  });
});

function save(){ localStorage.setItem(KEY,JSON.stringify(data)); }
function exportData(){
  let blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="locations.json"; a.click();
}
function importData(e){
  let f=e.target.files[0]; if(!f) return;
  let r=new FileReader(); r.onload=()=>{
    try{ data=JSON.parse(r.result); save(); renderAll(); alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!"); }
    catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞"); }
  };
  r.readAsText(f);
}
function resetData(){ if(confirm("–û—á–∏—Å—Ç–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫?")){ data={metro:[],districts:[],blocks:[]}; save(); renderAll(); } }
</script>
</body>
</html>
