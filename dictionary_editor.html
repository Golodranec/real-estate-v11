<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dictionary Editor v2 ‚Äî Locations Only</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;--danger:#ef4444;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;display:flex;justify-content:space-between;align-items:center}
main{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:4px 8px;border-radius:8px;cursor:pointer;margin:2px;font-size:12px}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.tree{list-style:none;padding-left:20px}
.tree li{margin:4px 0}
.coords{color:var(--muted);font-size:12px;margin-left:6px}
#mapModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
#mapBox{background:#111;padding:10px;border-radius:8px;width:80%;height:80%;display:flex;flex-direction:column}
#map{flex:1;border:1px solid var(--border)}
#previewMap{height:300px;margin-top:10px;border:1px solid var(--border);border-radius:8px}
input.search{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);margin-bottom:8px;background:#0f1624;color:#fff}
</style>
</head>
<body>
<header>
  <h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–æ–∫–∞—Ü–∏–π</h2>
  <div>
    <button class="btn" onclick="exportDict()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <label class="btn"><input type="file" id="importFile" style="display:none">–ò–º–ø–æ—Ä—Ç JSON</label>
  </div>
</header>

<main>
  <!-- —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
  <section class="panel">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä</h3>
    <h4>–õ–æ–∫–∞—Ü–∏–∏</h4>
    <input class="search" id="locSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º..."/>
    <button class="btn" onclick="addNode(null)">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω—É</button>
    <ul id="tree" class="tree"></ul>
  </section>

  <!-- –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
  <section class="panel">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div><label>–°—Ç—Ä–∞–Ω–∞</label><select id="selCountry"><option value="">‚Äî</option></select></div>
    <div><label>–ì–æ—Ä–æ–¥</label><select id="selCity"><option value="">‚Äî</option></select></div>
    <div><label>–†–∞–π–æ–Ω</label><select id="selDistrict"><option value="">‚Äî</option></select></div>
    <div><label>–ú–∞—Å—Å–∏–≤/–î–æ–º/–ú–µ—Ç—Ä–æ</label><select id="selStreet"><option value="">‚Äî</option></select></div>
    <div id="previewMap"></div>
  </section>
</main>

<!-- –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞—Ä—Ç—ã -->
<div id="mapModal">
  <div id="mapBox">
    <div style="margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
      <span id="mapTitle" style="color:#fff"></span>
      <button class="btn danger" onclick="closeMap()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const KEY="dictionaryLocations";
let dict=JSON.parse(localStorage.getItem(KEY)||'{"countries":{}}');
function save(){localStorage.setItem(KEY,JSON.stringify(dict));}
function sortKeys(o){return Object.keys(o).filter(k=>k!=="coords").sort();}

// ===== –†–ï–î–ê–ö–¢–û–† + –ü–û–ò–°–ö =====
function renderLocations(filter=""){
  let ul=document.getElementById("tree"); ul.innerHTML="";
  function renderLevel(obj,parentUl,path){
    sortKeys(obj).forEach(key=>{
      let full=path.concat(key).join(" ").toLowerCase();
      if(filter && !full.includes(filter.toLowerCase())) return;
      let li=document.createElement("li");
      li.innerHTML=`<span>${key}</span>
        <span class="coords">${obj[key].coords?obj[key].coords.join(", "):""}</span>
        <button class="btn" onclick='addNode(${JSON.stringify(path.concat(key))})'>+ –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn" onclick='renameNode(${JSON.stringify(path.concat(key))})'>‚úé</button>
        <button class="btn danger" onclick='deleteNode(${JSON.stringify(path.concat(key))})'>‚ùå</button>
        <button class="btn" onclick='setCoords(${JSON.stringify(path.concat(key))})'>üìç</button>`;
      let subUl=document.createElement("ul"); subUl.className="tree";
      renderLevel(obj[key],subUl,path.concat(key));
      if(subUl.children.length) li.appendChild(subUl);
      parentUl.appendChild(li);
    });
  }
  renderLevel(dict.countries,ul,["countries"]);
}
document.getElementById("locSearch").addEventListener("input",e=>{
  renderLocations(e.target.value.trim());
});
function getNode(path){return path.reduce((acc,k)=>acc[k],dict);}
function addNode(path){let n=prompt("–ù–∞–∑–≤–∞–Ω–∏–µ"); if(!n) return; if(path===null) dict.countries[n]={}; else getNode(path)[n]={}; save(); render();}
function renameNode(path){let last=path[path.length-1]; let parent=path.slice(0,-1).reduce((a,k)=>a[k],dict); let n=prompt("–ù–æ–≤–æ–µ –∏–º—è",last); if(!n)return; parent[n]=parent[last]; delete parent[last]; save(); render();}
function deleteNode(path){if(!confirm("–£–¥–∞–ª–∏—Ç—å?"))return; let last=path[path.length-1]; let parent=path.slice(0,-1).reduce((a,k)=>a[k],dict); delete parent[last]; save(); render();}

// ===== –ö–ê–†–¢–ê –î–õ–Ø –ö–û–û–†–î–ò–ù–ê–¢ =====
let map,mapPath,previewMap,previewMarker;
function setCoords(path){mapPath=path;document.getElementById("mapModal").style.display="flex";setTimeout(()=>{if(!map){map=L.map("map").setView([41.31,69.28],12);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);map.on("click",e=>{if(mapPath){getNode(mapPath).coords=[+e.latlng.lat.toFixed(5),+e.latlng.lng.toFixed(5)]; save(); render(); closeMap();}});} map.invalidateSize();},100);}
function closeMap(){document.getElementById("mapModal").style.display="none"; mapPath=null;}

// ===== –ü–†–ï–î–ü–†–û–°–ú–û–¢–† =====
function renderPreview(){
  let c=document.getElementById("selCountry"),ci=document.getElementById("selCity"),d=document.getElementById("selDistrict"),s=document.getElementById("selStreet");
  [c,ci,d,s].forEach(sel=>sel.innerHTML="<option value=''>‚Äî</option>");
  sortKeys(dict.countries).forEach(cc=>{let o=document.createElement("option");o.value=cc;o.textContent=cc;c.appendChild(o);});
  c.onchange=function(){ci.innerHTML="<option value=''>‚Äî</option>";d.innerHTML="<option value=''>‚Äî</option>";s.innerHTML="<option value=''>‚Äî</option>";if(this.value){sortKeys(dict.countries[this.value]).forEach(x=>{let o=document.createElement("option");o.value=x;o.textContent=x;ci.appendChild(o);});}updateMap();};
  ci.onchange=function(){d.innerHTML="<option value=''>‚Äî</option>";s.innerHTML="<option value=''>‚Äî</option>";if(c.value&&this.value){sortKeys(dict.countries[c.value][this.value]).forEach(x=>{let o=document.createElement("option");o.value=x;o.textContent=x;d.appendChild(o);});}updateMap();};
  d.onchange=function(){s.innerHTML="<option value=''>‚Äî</option>";if(c.value&&ci.value&&this.value){sortKeys(dict.countries[c.value][ci.value][this.value]).forEach(x=>{let o=document.createElement("option");o.value=x;o.textContent=x;s.appendChild(o);});}updateMap();};
  s.onchange=updateMap;
  if(!previewMap){previewMap=L.map("previewMap").setView([41.31,69.28],6);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(previewMap);} updateMap();
}
function updateMap(){if(previewMarker){previewMap.removeLayer(previewMarker);} let c=document.getElementById("selCountry").value,ci=document.getElementById("selCity").value,d=document.getElementById("selDistrict").value,s=document.getElementById("selStreet").value; let node=null; try{if(c&&ci&&d&&s) node=dict.countries[c][ci][d][s]; else if(c&&ci&&d) node=dict.countries[c][ci][d]; else if(c&&ci) node=dict.countries[c][ci]; else if(c) node=dict.countries[c];}catch(e){} if(node&&node.coords){previewMarker=L.marker(node.coords).addTo(previewMap).bindPopup((s||d||ci||c)); previewMap.setView(node.coords,12);}}

// ===== IMPORT/EXPORT =====
function exportDict(){let blob=new Blob([JSON.stringify(dict,null,2)],{type:"application/json"}); let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="locations.json"; a.click();}
document.getElementById("importFile").onchange=function(e){let f=e.target.files[0]; if(!f)return; let r=new FileReader(); r.onload=function(){try{let obj=JSON.parse(r.result); if(obj&&typeof obj==="object"){dict=obj; save(); render(); alert("–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω");}}catch(err){alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+err.message);}}; r.readAsText(f);};

// ===== INIT =====
function render(){renderLocations(); renderPreview();}
render();
</script>
</body>
</html>
