<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>Редактор справочников — OSM</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root {
  --bg:#0b0f16; --panel:#121826; --border:#273248; --text:#d7e2f2; --muted:#9fb0c8; --accent:#4aa8ff; --danger:#ef4444;
}
body {margin:0; font:14px system-ui, sans-serif; background:var(--bg); color:var(--text);}
header {padding:10px; border-bottom:1px solid var(--border); background:#0e1420; display:flex; gap:8px;}
button {padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:#1a2234; color:#d7e2f2; cursor:pointer;}
button:hover {border-color:var(--accent);}
main {display:grid; grid-template-columns:1fr 1fr; height:calc(100vh - 50px);}
#list {padding:10px; overflow:auto; border-right:1px solid var(--border);}
#list .card {background:#172133; border:1px solid var(--border); padding:8px; margin-bottom:8px; border-radius:6px;}
#list .muted {color:var(--muted); font-size:12px;}
#list input {width:100%; margin:4px 0; padding:4px; border-radius:4px; border:1px solid var(--border); background:#0f1624; color:var(--text);}
#map {height:100%; width:100%;}
footer {padding:6px 10px; border-top:1px solid var(--border); font-size:12px; color:var(--muted);}
</style>
</head>
<body>
<header>
  <span style="font-weight:700;color:#fff">dictionary-osm-full v1.1</span>
  <button onclick="addLocation()">+ Локация</button>
  <button onclick="exportDict()">Экспорт</button>
  <button onclick="importDict()">Импорт</button>
  <button onclick="resetDict()" style="color:#f88">Сброс</button>
  <button onclick="importOSM()">Импорт OSM (Ташкент)</button>
</header>

<main>
  <div id="list">Загрузка...</div>
  <div id="map"></div>
</main>

<footer>build: dictionary_editor_osm_full v1.1</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const KEY="dictionary_osm_full";
let dictData = JSON.parse(localStorage.getItem(KEY) || "[]");

let map = L.map('map').setView([41.3111,69.2797], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'© OpenStreetMap'
}).addTo(map);

function saveDict(){ localStorage.setItem(KEY, JSON.stringify(dictData)); }
function resetDict(){ if(confirm("Очистить справочник?")){ dictData=[]; saveDict(); renderList(); } }
function exportDict(){
  let blob=new Blob([JSON.stringify(dictData,null,2)],{type:"application/json"});
  let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="dictionary.json"; a.click();
}
function importDict(){
  let inp=document.createElement("input"); inp.type="file"; inp.accept=".json";
  inp.onchange=e=>{
    let f=e.target.files[0]; if(!f) return;
    let r=new FileReader();
    r.onload=()=>{
      try{ dictData=JSON.parse(r.result); saveDict(); renderList(); alert("Импортировано!"); }
      catch(err){ alert("Ошибка импорта"); }
    };
    r.readAsText(f);
  };
  inp.click();
}
function importOSM(){
  dictData.push({name:"Юнусабад",type:"district",lat:41.367,lng:69.287});
  dictData.push({name:"Чиланзар",type:"district",lat:41.285,lng:69.204});
  dictData.push({name:"М. Гафурова",type:"metro",lat:41.311,lng:69.279});
  saveDict();
  renderList();
  alert("Импорт завершен! Добавлены районы и метро.");
}
function addLocation(){
  dictData.push({name:"Новая локация",type:"custom",lat:41.311,lng:69.279});
  saveDict(); renderList();
}
function updateField(idx,key,value){
  dictData[idx][key]=value;
  saveDict(); renderList();
}
function deleteLocation(idx){
  if(confirm("Удалить локацию "+dictData[idx].name+"?")){
    dictData.splice(idx,1); saveDict(); renderList();
  }
}
function renderList(){
  let box=document.getElementById("list"); box.innerHTML="";
  if(!dictData.length){ box.innerHTML='<div class="muted">Нет локаций</div>'; return; }

  dictData.forEach((loc,idx)=>{
    let div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <input value="${loc.name}" onchange="updateField(${idx},'name',this.value)" placeholder="Название"/>
      <input value="${loc.type}" onchange="updateField(${idx},'type',this.value)" placeholder="Тип (district/metro/…)" />
      <input value="${loc.lat}" onchange="updateField(${idx},'lat',parseFloat(this.value))" placeholder="Широта"/>
      <input value="${loc.lng}" onchange="updateField(${idx},'lng',parseFloat(this.value))" placeholder="Долгота"/>
      <div class="muted">${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}</div>
      <div style="margin-top:4px;display:flex;gap:6px;">
        <button onclick="focusLocation(${idx})">Показать</button>
        <button style="color:#f88" onclick="deleteLocation(${idx})">Удалить</button>
      </div>
    `;
    box.appendChild(div);
  });
}
function focusLocation(idx){
  let loc=dictData[idx];
  map.setView([loc.lat,loc.lng],14);
  if(window.currentMarker) map.removeLayer(window.currentMarker);
  window.currentMarker=L.marker([loc.lat,loc.lng]).addTo(map).bindPopup(loc.name).openPopup();
}

renderList();
</script>
</body>
</html>
