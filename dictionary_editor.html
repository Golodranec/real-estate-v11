<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dictionary Editor + Preview Cascade + Categories + Search</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;--danger:#ef4444;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;display:flex;justify-content:space-between;align-items:center}
main{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:4px 8px;border-radius:8px;cursor:pointer;margin:2px;font-size:12px}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.tree{list-style:none;padding-left:20px}
.tree li{margin:4px 0}
.coords{color:var(--muted);font-size:12px;margin-left:6px}
#mapModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
#mapBox{background:#111;padding:10px;border-radius:8px;width:80%;height:80%;display:flex;flex-direction:column}
#map{flex:1;border:1px solid var(--border)}
#previewMap{height:300px;margin-top:10px;border:1px solid var(--border);border-radius:8px}
.checklist{margin-top:10px}
input.search{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);margin-bottom:8px;background:#0f1624;color:#fff}
</style>
</head>
<body>
<header>
  <h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h2>
  <div>
    <button class="btn" onclick="exportDict()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <label class="btn"><input type="file" id="importFile" style="display:none">–ò–º–ø–æ—Ä—Ç JSON</label>
  </div>
</header>

<main>
  <!-- —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
  <section class="panel">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä</h3>
    <h4>–õ–æ–∫–∞—Ü–∏–∏</h4>
    <input class="search" id="locSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º..."/>
    <button class="btn" onclick="addNode(null)">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω—É</button>
    <ul id="tree" class="tree"></ul>
    <hr>
    <h4>–û–ø—Ü–∏–∏ (–≥–∞–ª–æ—á–∫–∏)</h4>
    <div id="optionsEditor"></div>
    <button class="btn" onclick="addOption()">+ –û–ø—Ü–∏—è</button>
    <hr>
    <h4>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h4>
    <div id="categoriesEditor"></div>
    <button class="btn" onclick="addCategory()">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
  </section>

  <!-- –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
  <section class="panel">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div>
      <label>–°—Ç—Ä–∞–Ω–∞</label>
      <select id="selCountry"><option value="">‚Äî</option></select>
    </div>
    <div>
      <label>–ì–æ—Ä–æ–¥</label>
      <select id="selCity"><option value="">‚Äî</option></select>
    </div>
    <div>
      <label>–†–∞–π–æ–Ω</label>
      <select id="selDistrict"><option value="">‚Äî</option></select>
    </div>
    <div>
      <label>–ú–∞—Å—Å–∏–≤</label>
      <select id="selStreet"><option value="">‚Äî</option></select>
    </div>
    <div class="checklist" id="optionsBox"></div>
    <div>
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="selCategory"><option value="">‚Äî</option></select>
    </div>
    <div>
      <label>–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="selSubcategory"><option value="">‚Äî</option></select>
    </div>
    <div id="previewMap"></div>
  </section>
</main>

<div id="mapModal">
  <div id="mapBox">
    <div style="margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
      <span id="mapTitle" style="color:#fff"></span>
      <button class="btn danger" onclick="closeMap()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const KEY="dictionaryData";
let dict=JSON.parse(localStorage.getItem(KEY)||'{"countries":{},"options":[{"id":"near_metro","label":"–ú–µ—Ç—Ä–æ —Ä—è–¥–æ–º"}],"categories":{}}');

function save(){localStorage.setItem(KEY,JSON.stringify(dict));}
function sortKeys(o){return Object.keys(o).filter(k=>k!=="coords").sort();}

// ====== LOCATIONS + SEARCH ======
function renderLocations(filter=""){
  let ul=document.getElementById("tree"); ul.innerHTML="";
  function renderLevel(obj,parentUl,path){
    sortKeys(obj).forEach(key=>{
      let full=path.concat(key).join(" ").toLowerCase();
      if(filter && !full.includes(filter.toLowerCase())) return;
      let li=document.createElement("li");
      li.innerHTML=`<span>${key}</span> 
        <span class="coords">${obj[key].coords?obj[key].coords.join(", "):""}</span>
        <button class="btn" onclick='addNode(${JSON.stringify(path.concat(key))})'>+ –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn" onclick='renameNode(${JSON.stringify(path.concat(key))})'>‚úé</button>
        <button class="btn danger" onclick='deleteNode(${JSON.stringify(path.concat(key))})'>‚ùå</button>
        <button class="btn" onclick='setCoords(${JSON.stringify(path.concat(key))})'>üìç</button>`;
      let subUl=document.createElement("ul"); subUl.className="tree";
      renderLevel(obj[key],subUl,path.concat(key));
      if(subUl.children.length) li.appendChild(subUl);
      parentUl.appendChild(li);
    });
  }
  renderLevel(dict.countries,ul,["countries"]);
}
document.getElementById("locSearch").addEventListener("input",e=>{
  renderLocations(e.target.value.trim());
});

// –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ (options, categories, preview, map, import/export) –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ
// ...
</script>
</body>
</html>
