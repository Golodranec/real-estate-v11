<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dictionary Editor v3 ‚Äî Infinite Locations</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;--danger:#ef4444;--accent:#4aa8ff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;display:flex;justify-content:space-between;align-items:center}
main{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
h3{margin:0 0 10px 0;color:#cfe0ff}
h4{margin:10px 0 8px 0}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:4px 8px;border-radius:8px;cursor:pointer;margin:2px;font-size:12px}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.btn.accent{background:#123a66;border-color:#1e5391}
.tree{list-style:none;padding-left:18px}
.tree li{margin:4px 0}
.coords{color:var(--muted);font-size:12px;margin-left:6px}
.tools{display:inline-flex;gap:4px;flex-wrap:wrap;margin-left:6px}
input.search{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);margin:8px 0;background:#0f1624;color:#fff}
#mapModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
#mapBox{background:#111;padding:10px;border-radius:8px;width:82%;height:82%;display:flex;flex-direction:column}
#map{flex:1;border:1px solid var(--border)}
#previewMap{height:320px;margin-top:10px;border:1px solid var(--border);border-radius:8px}
.levels{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
.levels input{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.levels .btn{height:32px}
.badge{display:inline-block;background:#23314d;border:1px solid #334567;border-radius:6px;padding:2px 6px;margin-left:6px;color:#cfe0ff}
.muted{color:var(--muted)}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media (max-width:1000px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div>
    <strong>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–æ–∫–∞—Ü–∏–π v3</strong>
    <span class="badge">–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —É—Ä–æ–≤–Ω–∏</span>
  </div>
  <div>
    <button class="btn" onclick="exportDict()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <label class="btn"><input type="file" id="importFile" style="display:none">–ò–º–ø–æ—Ä—Ç JSON</label>
  </div>
</header>

<main>
  <!-- –†–ï–î–ê–ö–¢–û–† -->
  <section class="panel">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä</h3>

    <h4>–ù–∞–∑–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π (–∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏)</h4>
    <div class="levels" id="levelsBox"></div>
    <div style="margin:6px 0">
      <button class="btn" onclick="addLevelLabel()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
      <span class="muted">–≠—Ç–∏ –ø–æ–¥–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ. –ï—Å–ª–∏ –≥–ª—É–±–∏–Ω–∞ –ø—Ä–µ–≤—ã—Å–∏—Ç —Å–ø–∏—Å–æ–∫ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è ¬´–£—Ä–æ–≤–µ–Ω—å N¬ª.</span>
    </div>

    <h4 style="margin-top:12px">–õ–æ–∫–∞—Ü–∏–∏ (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –¥–µ—Ä–µ–≤–æ)</h4>
    <input class="search" id="locSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º... (–Ω–∞–ø—Ä–∏–º–µ—Ä: —é–Ω—É—Å, —á–∏–ª–∞–Ω, –º–µ—Ç—Ä–æ)">
    <div style="margin-bottom:6px">
      <button class="btn" onclick="addRoot()">+ –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
      <span class="muted">–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω¬ª, ¬´–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω¬ª –∏ —Ç.–¥.</span>
    </div>
    <ul id="tree" class="tree"></ul>
  </section>

  <!-- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† -->
  <section class="panel">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div id="selectsBox"></div>
    <div id="previewMap"></div>
    <div style="margin-top:8px" class="muted">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–∑–ª–∞. –ï—Å–ª–∏ —É —É–∑–ª–∞ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî —Ç–æ—á–∫–∏ –Ω–µ –±—É–¥–µ—Ç.</div>
  </section>
</main>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ö–ê–†–¢–´ -->
<div id="mapModal">
  <div id="mapBox">
    <div style="margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
      <span id="mapTitle" style="color:#fff"></span>
      <div>
        <button class="btn" onclick="clearCoords()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn danger" onclick="closeMap()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div id="map"></div>
    <div class="muted" style="margin-top:6px">–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ====== –î–ê–ù–ù–´–ï ======
const KEY="dictionaryInfiniteLocationsV3";
let dict = JSON.parse(localStorage.getItem(KEY) || JSON.stringify({
  levelLabels: ["–°—Ç—Ä–∞–Ω–∞","–ì–æ—Ä–æ–¥","–†–∞–π–æ–Ω","–ú–∞—Å—Å–∏–≤"],
  tree: {} // { "–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω": { coords:[..], children:{ "–¢–∞—à–∫–µ–Ω—Ç":{ children:{..} } } } }
}));

function save(){ localStorage.setItem(KEY, JSON.stringify(dict)); }
function sortKeys(o){ return Object.keys(o||{}).filter(k=>k!=="coords" && k!=="children").sort((a,b)=>a.localeCompare(b,'ru',{sensitivity:'base'})); }

// ====== –†–ï–î–ê–ö–¢–û–† –£–†–û–í–ù–ï–ô ======
function renderLevelLabels(){
  const box = document.getElementById('levelsBox');
  box.innerHTML='';
  dict.levelLabels.forEach((lbl,i)=>{
    const row = document.createElement('div'); row.className='levels';
    const inp = document.createElement('input'); inp.value=lbl; inp.oninput=e=>{ dict.levelLabels[i]=e.target.value; save(); renderPreview(); };
    const del = document.createElement('button'); del.className='btn danger'; del.textContent='‚ùå'; del.title='–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å—å —É—Ä–æ–≤–Ω—è';
    del.onclick=()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å—å —É—Ä–æ–≤–Ω—è?')) return; dict.levelLabels.splice(i,1); save(); renderLevelLabels(); renderPreview(); };
    row.appendChild(inp); row.appendChild(del); box.appendChild(row);
  });
  if(dict.levelLabels.length===0){
    const z = document.createElement('div'); z.className='muted'; z.textContent='–ù–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π. –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è ¬´–£—Ä–æ–≤–µ–Ω—å 1/2/...¬ª.';
    box.appendChild(z);
  }
}
function addLevelLabel(){ dict.levelLabels.push('–£—Ä–æ–≤–µ–Ω—å '+(dict.levelLabels.length+1)); save(); renderLevelLabels(); renderPreview(); }

// ====== –ü–û–ò–°–ö + –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ï–†–ï–í–ê ======
function renderTree(){
  const filter = (document.getElementById('locSearch').value||'').trim().toLowerCase();
  const ul = document.getElementById('tree'); ul.innerHTML='';
  // —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–∑–µ–ª, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–ª –æ–Ω —Å–∞–º –∏–ª–∏ –ª—é–±–æ–π –∏–∑ –µ–≥–æ –ø–æ—Ç–æ–º–∫–æ–≤
  function matches(name,node){
    if(!filter) return true;
    if(name.toLowerCase().includes(filter)) return true;
    const ch = node.children||{};
    for(const k of Object.keys(ch)){ if(matches(k, ch[k])) return true; }
    return false;
  }
  function renderLevel(obj, parentUl, path){
    const keys = sortKeys(obj);
    keys.forEach(key=>{
      const node = obj[key];
      if(!matches(key, node)) return;
      const li = document.createElement('li');

      const title = document.createElement('span'); title.textContent = key;
      li.appendChild(title);

      if(node.coords){
        const c = document.createElement('span'); c.className='coords'; c.textContent = node.coords.join(', ');
        li.appendChild(c);
      }

      const tools = document.createElement('span'); tools.className='tools';
      const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å'; addBtn.onclick = ()=> addNode(path.concat(key));
      const renBtn = document.createElement('button'); renBtn.className='btn'; renBtn.textContent='‚úé'; renBtn.title='–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å'; renBtn.onclick = ()=> renameNode(path.concat(key));
      const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='‚ùå'; delBtn.onclick = ()=> deleteNode(path.concat(key));
      const geoBtn = document.createElement('button'); geoBtn.className='btn accent'; geoBtn.textContent='üìç'; geoBtn.title='–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã'; geoBtn.onclick = ()=> setCoords(path.concat(key));
      tools.append(addBtn, renBtn, delBtn, geoBtn);
      li.appendChild(tools);

      const subUl = document.createElement('ul'); subUl.className='tree';
      renderLevel(node.children||{}, subUl, path.concat(key));
      if(subUl.children.length) li.appendChild(subUl);

      parentUl.appendChild(li);
    });
  }
  renderLevel(dict.tree, ul, []);
}

document.getElementById('locSearch').addEventListener('input', ()=> renderTree());

// ====== –û–ü–ï–†–ê–¶–ò–ò –° –£–ó–õ–ê–ú–ò ======
function getNodeByPath(path){ // path: array of names
  let cur = dict.tree;
  let node = null;
  for(const name of path){
    if(!cur[name]) return null;
    node = cur[name];
    cur = node.children || (node.children = {});
  }
  return node;
}
function getParentAndKey(path){ // returns {parentObj, key}
  if(path.length===0) return { parentObj: dict.tree, key: null };
  const key = path[path.length-1];
  let cur = dict.tree, parentObj=null;
  for(let i=0;i<path.length-1;i++){
    const name = path[i];
    if(!cur[name]) return null;
    parentObj = cur[name].children || (cur[name].children = {});
    cur = parentObj;
  }
  return { parentObj: cur, key };
}

function addRoot(){
  const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω)');
  if(!name) return;
  dict.tree[name] = dict.tree[name] || { children:{} };
  save(); renderTree(); renderPreview();
}
function addNode(path){
  const parentNode = path.length ? getNodeByPath(path) : null;
  const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –¢–∞—à–∫–µ–Ω—Ç, –Æ–Ω—É—Å–∞–±–∞–¥, –ú–µ—Ç—Ä–æ –ß–∏–ª–∞–Ω–∑–∞—Ä)');
  if(!name) return;
  const children = parentNode ? (parentNode.children || (parentNode.children = {})) : dict.tree;
  if(children[name]){ alert('–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ'); return; }
  children[name] = { children:{} };
  save(); renderTree(); renderPreview();
}
function renameNode(path){
  const info = getParentAndKey(path); if(!info) return;
  const { parentObj, key } = info;
  const node = parentObj[key];
  const name = prompt('–ù–æ–≤–æ–µ –∏–º—è', key);
  if(!name || name===key) return;
  if(parentObj[name]){ alert('–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ'); return; }
  parentObj[name] = node; delete parentObj[key];
  save(); renderTree(); renderPreview();
}
function deleteNode(path){
  const info = getParentAndKey(path); if(!info) return;
  const { parentObj, key } = info;
  if(!confirm('–£–¥–∞–ª–∏—Ç—å ¬´'+key+'¬ª –∏ –≤—Å–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã?')) return;
  delete parentObj[key];
  save(); renderTree(); renderPreview();
}

// ====== –ö–ê–†–¢–ê –î–õ–Ø –ö–û–û–†–î–ò–ù–ê–¢ ======
let map, mapPath=null, previewMap, previewMarker=null;
function setCoords(path){
  mapPath = path.slice();
  document.getElementById('mapModal').style.display='flex';
  document.getElementById('mapTitle').textContent = '–í—ã–±–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: ' + path.join(' ‚Üí ');
  setTimeout(()=>{
    if(!map){
      map = L.map('map').setView([41.31,69.28], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"¬© OSM"}).addTo(map);
      map.on('click', e=>{
        if(!mapPath) return;
        const node = getNodeByPath(mapPath);
        if(!node) return;
        node.coords = [ +e.latlng.lat.toFixed(6), +e.latlng.lng.toFixed(6) ];
        save(); renderTree(); updateMap();
      });
    }
    map.invalidateSize();
  }, 80);
}
function closeMap(){ document.getElementById('mapModal').style.display='none'; mapPath=null; }
function clearCoords(){
  if(!mapPath) return;
  const node = getNodeByPath(mapPath);
  if(node && node.coords){
    delete node.coords; save(); renderTree(); updateMap();
  }
}

// ====== –ü–†–ï–î–ü–†–û–°–ú–û–¢–† (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–µ–ª–µ–∫—Ç—ã –ø–æ –≥–ª—É–±–∏–Ω–µ) ======
function renderPreview(){
  const box = document.getElementById('selectsBox');
  box.innerHTML = '';
  // —Å—Ç—Ä–æ–∏–º –∫–∞—Å–∫–∞–¥ —Å–µ–ª–µ–∫—Ç–æ–≤ –Ω–∞ –ª–µ—Ç—É: –ø–æ–∫–∞ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–∑–ª–∞ –µ—Å—Ç—å –¥–µ—Ç–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–µ–ª–µ–∫—Ç
  const chain = []; // –º–∞—Å—Å–∏–≤ –∏–º—ë–Ω
  const nodesChain = []; // —Å–∞–º–∏ —É–∑–ª—ã
  // –ø–µ—Ä–≤—ã–π —Å–µ–ª–µ–∫—Ç –≤—Å–µ–≥–¥–∞ –æ—Ç –∫–æ—Ä–Ω—è
  addSelectLevel(dict.tree, 0);

  function addSelectLevel(childrenObj, depth){
    const wrap = document.createElement('div');
    const label = document.createElement('label');
    const niceLabel = dict.levelLabels[depth] || ('–£—Ä–æ–≤–µ–Ω—å ' + (depth+1));
    label.textContent = niceLabel;
    const sel = document.createElement('select');
    sel.innerHTML = '<option value="">‚Äî</option>';
    sortKeys(childrenObj).forEach(name=>{
      const opt = document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt);
    });
    sel.onchange = ()=>{
      // –æ–±—Ä–µ–∑–∞–µ–º —Ü–µ–ø–æ—á–∫—É –¥–æ —Ç–µ–∫—É—â–µ–π –≥–ª—É–±–∏–Ω—ã
      chain.splice(depth); nodesChain.splice(depth);
      const val = sel.value;
      // —É–¥–∞–ª—è–µ–º –Ω–∏–∂–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç—ã
      while(wrap.nextSibling){ box.removeChild(wrap.nextSibling); }
      if(!val){ updateMap(); return; }
      chain.push(val);
      // –Ω–∞–π—Ç–∏ —É–∑–µ–ª –ø–æ —Ü–µ–ø–æ—á–∫–µ
      let cur = dict.tree, node=null;
      for(const nm of chain){ node = cur[nm]; cur = (node&&node.children) ? node.children : {}; }
      nodesChain.push(node);
      updateMap(node);
      // –µ—Å–ª–∏ —É —É–∑–ª–∞ –µ—Å—Ç—å –¥–µ—Ç–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–µ–ª–µ–∫—Ç
      if(node && node.children && Object.keys(node.children).length){
        addSelectLevel(node.children, depth+1);
      }
    };

    wrap.appendChild(label);
    wrap.appendChild(sel);
    box.appendChild(wrap);
  }
  // –∫–∞—Ä—Ç–∞
  if(!previewMap){
    previewMap = L.map('previewMap').setView([41.31,69.28], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"¬© OSM"}).addTo(previewMap);
  }
  updateMap();
}

function updateMap(node){
  if(previewMarker){ previewMap.removeLayer(previewMarker); previewMarker=null; }
  // –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —É–∑–µ–ª –∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å coords ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
  if(node && node.coords){
    previewMarker = L.marker(node.coords).addTo(previewMap).bindPopup('–í—ã–±—Ä–∞–Ω–æ: '+(node._name||''));
    previewMap.setView(node.coords, 12);
    return;
  }
  // –∏–Ω–∞—á–µ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Å–∞–º—ã–π –≥–ª—É–±–æ–∫–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤ —Ç–µ–∫—É—â–∏—Ö —Å–µ–ª–µ–∫—Ç–∞—Ö
  const selects = Array.from(document.querySelectorAll('#selectsBox select'));
  let cur = dict.tree, chosenNode=null, path=[];
  for(const sel of selects){
    const v = sel.value;
    if(!v) break;
    chosenNode = cur[v];
    path.push(v);
    cur = (chosenNode && chosenNode.children) ? chosenNode.children : {};
  }
  if(chosenNode && chosenNode.coords){
    chosenNode._name = path[path.length-1];
    previewMarker = L.marker(chosenNode.coords).addTo(previewMap).bindPopup('–í—ã–±—Ä–∞–Ω–æ: '+path.join(' ‚Üí '));
    previewMap.setView(chosenNode.coords, 12);
  }
}

// ====== –ò–ú–ü–û–†–¢ / –≠–ö–°–ü–û–†–¢ ======
function exportDict(){
  const blob = new Blob([JSON.stringify(dict,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='locations_v3.json'; a.click();
}
document.getElementById('importFile').onchange = (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const obj=JSON.parse(r.result);
      if(!obj || typeof obj!=='object') throw new Error('–Ω–µ–≤–µ—Ä–Ω—ã–π JSON');
      if(!('tree' in obj)) throw new Error('–Ω–µ—Ç –ø–æ–ª—è "tree"');
      if(!('levelLabels' in obj)) obj.levelLabels = dict.levelLabels || [];
      dict = obj; save(); renderAll(); alert('–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
  };
  r.readAsText(f);
};

// ====== INIT ======
function renderAll(){ renderLevelLabels(); renderTree(); renderPreview(); }
renderAll();
</script>
</body>
</html>
