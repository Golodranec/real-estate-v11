<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–æ–∫–∞—Ü–∏–π ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
button.ghost{background:transparent;border-color:#334}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
main{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 52px)}
.sidebar{display:flex;flex-direction:column;gap:10px;padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:#172133;border:1px solid var(--border);border-radius:12px;padding:10px}
h3{margin:0 0 8px 0}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:#111a2a}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
.tools{display:flex;gap:6px}
small.muted{color:var(--muted)}
#map{width:100%;height:100%}
.searchResults{background:#172133;border:1px solid #31405a;border-radius:8px;margin-top:6px;max-height:220px;overflow:auto}
.searchResults div{padding:6px 8px;cursor:pointer}
.searchResults div:hover{background:#1a2234}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:6px}
@media (max-width:1100px){main{grid-template-columns:1fr;grid-auto-rows:minmax(360px,auto)}} 
</style>
</head>
<body>
<header>
  <span class="badge">dictionary-dynamic v6</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label><input type="file" id="fileImport" style="display:none"><button class="ghost">–ò–º–ø–æ—Ä—Ç</button></label>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
  <span style="margin-left:auto" class="small muted">–•—Ä–∞–Ω–∏–ª–∏—â–µ: localStorage</span>
</header>

<main>
  <aside class="sidebar">
    <section class="panel">
      <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
      <div class="row">
        <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä: –°—Ç—Ä–∞–Ω—ã, –ì–æ—Ä–æ–¥–∞, –†–∞–π–æ–Ω—ã, –ú–µ—Ç—Ä–æ, –ú–∞—Å—Å–∏–≤—ã)"/>
        <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="catList" class="list" style="margin-top:8px"></div>
    </section>

    <section class="panel">
      <h3 id="activeCatTitle">–≠–ª–µ–º–µ–Ω—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
      <div class="row">
        <input id="newItemName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞"/>
        <button id="btnAddItem">+ –ù–æ–≤—ã–π</button>
      </div>
      <div class="row" id="parentCfg" style="margin-top:6px;display:none">
        <select id="parentCategorySelect" title="–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è"></select>
        <small class="muted">–ü—Ä–∏–≤—è–∑–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Å—Å–∏–≤ ‚Üí –†–∞–π–æ–Ω)</small>
      </div>
      <div id="itemList" class="list" style="margin-top:8px"></div>
    </section>

    <section class="panel">
      <h3>–ü–æ–∏—Å–∫ –ø–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫—É</h3>
      <input id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
      <div id="searchResults" class="searchResults"></div>
    </section>
  </aside>

  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ====== STORAGE ====== */
const KEY="dict_dynamic_v6";
let db = JSON.parse(localStorage.getItem(KEY) || "null");
if(!db){
  db = {
    categories:[
      {id:uid(), name:"–†–∞–π–æ–Ω—ã", parentCategoryId:null, items:[
        {id:uid(), name:"–Æ–Ω—É—Å–∞–±–∞–¥", lat:41.367, lng:69.287, parentId:null},
        {id:uid(), name:"–ß–∏–ª–∞–Ω–∑–∞—Ä", lat:41.285, lng:69.204, parentId:null},
        {id:uid(), name:"–ú–∏—Ä–∑–æ-–£–ª—É–≥–±–µ–∫", lat:41.324, lng:69.345, parentId:null}
      ]},
      {id:uid(), name:"–ú–µ—Ç—Ä–æ", parentCategoryId:null, items:[
        {id:uid(), name:"–û–ª–º–∞–∑–æ—Ä", lat:41.356, lng:69.203, parentId:null},
        {id:uid(), name:"–ê–ª–∏—à–µ—Ä –ù–∞–≤–æ–∏", lat:41.311, lng:69.278, parentId:null},
        {id:uid(), name:"–û–π–±–µ–∫", lat:41.308, lng:69.295, parentId:null}
      ]},
      {id:uid(), name:"–ú–∞—Å—Å–∏–≤—ã", parentCategoryId:null, items:[
        {id:uid(), name:"–Æ–Ω—É—Å–∞–±–∞–¥-9", lat:41.370, lng:69.290, parentId:null}
      ]}
    ]
  };
  save();
}
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ====== MAP ====== */
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let marker=null;
let placeMode=null; // —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –≤—ã–∑–æ–≤—ë–º –ø—Ä–∏ –∫–ª–∏–∫–µ

map.on("click", e=>{
  if(placeMode){
    const {lat,lng}=e.latlng;
    placeMode(lat,lng);
    placeMode=null;
  }
});

function showMarker(lat,lng,label,draggable=false,onDragEnd=null){
  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lng],{draggable}).addTo(map).bindPopup(label).openPopup();
  map.setView([lat,lng],14);
  if(draggable && onDragEnd){
    marker.on("dragend", e=>{
      const p=e.target.getLatLng();
      onDragEnd(p.lat,p.lng);
    });
  }
}

/* ====== STATE ====== */
let activeCatId = db.categories[0]?.id || null;

const $ = s=>document.querySelector(s);
const $catList = $("#catList");
const $itemList = $("#itemList");
const $activeCatTitle = $("#activeCatTitle");
const $parentCfg = $("#parentCfg");
const $parentCategorySelect = $("#parentCategorySelect");

/* ====== RENDER CATEGORY LIST ====== */
function renderCategories(){
  $catList.innerHTML="";
  db.categories.forEach((cat,idx)=>{
    const div=document.createElement("div"); div.className="item";
    const left=document.createElement("div");
    left.className="name";
    left.textContent = (cat.id===activeCatId?"‚òÖ ":"") + cat.name;
    left.title="–°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–π";
    left.style.cursor="pointer";
    left.onclick=()=>{ activeCatId=cat.id; renderAll(); };
    const tools=document.createElement("div"); tools.className="tools";

    const up=document.createElement("button"); up.textContent="‚Üë";
    up.onclick=(e)=>{ e.stopPropagation(); if(idx>0){ const t=db.categories[idx]; db.categories.splice(idx,1); db.categories.splice(idx-1,0,t); save(); renderAll(); } };
    const down=document.createElement("button"); down.textContent="‚Üì";
    down.onclick=(e)=>{ e.stopPropagation(); if(idx<db.categories.length-1){ const t=db.categories[idx]; db.categories.splice(idx,1); db.categories.splice(idx+1,0,t); save(); renderAll(); } };

    const rename=document.createElement("button"); rename.textContent="‚úé";
    rename.onclick=(e)=>{ e.stopPropagation(); const nn=prompt("–ù–æ–≤–æ–µ –∏–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", cat.name); if(nn){ cat.name=nn; save(); renderAll(); } };

    const setParent=document.createElement("button"); setParent.textContent="‚Üó —Ä–æ–¥–∏—Ç–µ–ª—å";
    setParent.title="–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)";
    setParent.onclick=(e)=>{
      e.stopPropagation();
      // —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π-—Ä–æ–¥–∏—Ç–µ–ª–µ–π (–≤—Å–µ, –∫—Ä–æ–º–µ —Å–∞–º–æ–π)
      const opts = db.categories.filter(c=>c.id!==cat.id);
      if(!opts.length){ alert("–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –µ—â—ë –æ–¥–Ω—É."); return; }
      const current = cat.parentCategoryId || "";
      const pick = prompt("ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å)\n"+opts.map(o=>`${o.name} ‚Äî ${o.id}`).join("\n"), current);
      if(pick!==null){
        cat.parentCategoryId = pick.trim() || null;
        // –∑–∞—á–∏—Å—Ç–∏–º parentId —É —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ —Å–Ω—è–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—è
        if(!cat.parentCategoryId){ cat.items.forEach(it=>it.parentId=null); }
        save(); renderAll();
      }
    };

    const del=document.createElement("button"); del.textContent="‚ùå"; del.className="danger";
    del.onclick=(e)=>{ e.stopPropagation();
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "'+cat.name+'"? –í—Å–µ –µ—ë —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ–∂–µ —É–¥–∞–ª—è—Ç—Å—è.')) return;
      const idx = db.categories.findIndex(c=>c.id===cat.id);
      db.categories.splice(idx,1);
      if(activeCatId===cat.id){ activeCatId=db.categories[0]?.id||null; }
      save(); renderAll();
    };

    tools.append(up,down,rename,setParent,del);
    div.append(left,tools);
    $catList.appendChild(div);
  });
}

/* ====== RENDER ITEMS OF ACTIVE CATEGORY ====== */
function renderItems(){
  const cat = db.categories.find(c=>c.id===activeCatId);
  if(!cat){ $activeCatTitle.textContent="–≠–ª–µ–º–µ–Ω—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"; $itemList.innerHTML=""; $parentCfg.style.display="none"; return; }

  $activeCatTitle.textContent = "–≠–ª–µ–º–µ–Ω—Ç—ã: "+cat.name;
  // –±–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  $parentCfg.style.display="block";
  $parentCategorySelect.innerHTML="<option value=''>‚Äî –±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è ‚Äî</option>";
  db.categories.forEach(c=>{
    if(c.id===cat.id) return;
    const opt=document.createElement("option");
    opt.value=c.id; opt.textContent=c.name;
    if(cat.parentCategoryId===c.id) opt.selected=true;
    $parentCategorySelect.appendChild(opt);
  });
  $parentCategorySelect.onchange = ()=>{
    const val = $parentCategorySelect.value || null;
    cat.parentCategoryId = val;
    if(!val){ cat.items.forEach(it=>it.parentId=null); }
    save(); renderAll();
  };

  $itemList.innerHTML="";
  cat.items.forEach((it,idx)=>{
    const line=document.createElement("div"); line.className="item";

    const left=document.createElement("div"); left.style.display="grid"; left.style.gap="4px";
    const title=document.createElement("div"); title.className="name"; title.textContent=it.name;
    const meta=document.createElement("div"); meta.innerHTML=`<small class="muted">${(it.lat??'‚Äî')}, ${(it.lng??'‚Äî')}${cat.parentCategoryId? (it.parentId? " ‚Ä¢ —Ä–æ–¥.: "+(nameByParent(it.parentId) || "‚Äî") : " ‚Ä¢ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏"):""}</small>`;
    left.append(title, meta);

    const tools=document.createElement("div"); tools.className="tools";

    const up=document.createElement("button"); up.textContent="‚Üë";
    up.onclick=(e)=>{ e.stopPropagation(); if(idx>0){ const t=cat.items[idx]; cat.items.splice(idx,1); cat.items.splice(idx-1,0,t); save(); renderAll(); } };
    const down=document.createElement("button"); down.textContent="‚Üì";
    down.onclick=(e)=>{ e.stopPropagation(); if(idx<cat.items.length-1){ const t=cat.items[idx]; cat.items.splice(idx,1); cat.items.splice(idx+1,0,t); save(); renderAll(); } };

    const rename=document.createElement("button"); rename.textContent="‚úé";
    rename.onclick=(e)=>{ e.stopPropagation(); const nn=prompt("–ù–æ–≤–æ–µ –∏–º—è", it.name); if(nn){ it.name=nn; save(); renderAll(); } };

    // –≤—ã–±–æ—Ä —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –µ—Å–ª–∏ —É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–¥–∞–Ω —Ä–æ–¥–∏—Ç–µ–ª—å
    if(cat.parentCategoryId){
      const parentCat = db.categories.find(c=>c.id===cat.parentCategoryId);
      const pickParent=document.createElement("button"); pickParent.textContent="‚Üó –ø—Ä–∏–≤—è–∑–∞—Ç—å";
      pickParent.title="–í—ã–±—Ä–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç";
      pickParent.onclick=(e)=>{
        e.stopPropagation();
        const list = parentCat.items;
        if(!list.length){ alert("–í —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤."); return; }
        const hint = "ID —Ä–æ–¥–∏—Ç–µ–ª—è (–∏–ª–∏ –ø—É—Å—Ç–æ —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å)\n"+list.map(x=>`${x.name} ‚Äî ${x.id}`).join("\n");
        const sel = prompt(hint, it.parentId||"");
        if(sel!==null){
          it.parentId = sel.trim() || null;
          save(); renderAll();
        }
      };
      tools.appendChild(pickParent);
    }

    const place=document.createElement("button"); place.textContent="üìç";
    place.title="–ü–æ—Å—Ç–∞–≤–∏—Ç—å/–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –º–µ—Ç–∫—É (–∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ)";
    place.onclick=(e)=>{
      e.stopPropagation();
      alert("–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –¥–ª—è: "+it.name);
      placeMode = (lat,lng)=>{
        it.lat=lat; it.lng=lng; save();
        showMarker(lat,lng,it.name,true,(la,ln)=>{ it.lat=la; it.lng=ln; save(); renderAll(); });
        renderAll();
      };
    };

    const del=document.createElement("button"); del.textContent="‚ùå"; del.className="danger";
    del.onclick=(e)=>{ e.stopPropagation(); if(confirm('–£–¥–∞–ª–∏—Ç—å "'+it.name+'"?')){ cat.items.splice(idx,1); save(); renderAll(); } };

    line.onclick=()=>{ if(it.lat!=null && it.lng!=null) showMarker(it.lat,it.lng,it.name); };
    tools.append(up,down,rename,place,del);
    line.append(left,tools);
    $itemList.appendChild(line);
  });
}
function nameByParent(parentId){
  for(const c of db.categories){
    const found=c.items.find(x=>x.id===parentId);
    if(found) return found.name;
  }
  return null;
}

/* ====== SEARCH ====== */
$("#searchInput").addEventListener("input", e=>{
  const q=(e.target.value||"").trim().toLowerCase();
  const box=$("#searchResults"); box.innerHTML="";
  if(!q) return;
  const rows=[];
  db.categories.forEach(cat=>{
    cat.items.forEach(it=>{
      if((it.name||"").toLowerCase().includes(q)){
        rows.push({cat, it});
      }
    });
  });
  rows.forEach(({cat,it})=>{
    const div=document.createElement("div");
    const parentTxt = it.parentId? ` ‚Ä¢ —Ä–æ–¥.: ${(nameByParent(it.parentId)||"‚Äî")}`:"";
    div.textContent = `${it.name}  ‚Äî  ${cat.name}${parentTxt}`;
    div.onclick=()=>{
      activeCatId=cat.id; renderAll();
      if(it.lat!=null && it.lng!=null) showMarker(it.lat,it.lng,it.name);
    };
    box.appendChild(div);
  });
});

/* ====== HANDLERS (ADD/EXPORT/IMPORT/RESET) ====== */
$("#btnAddCat").onclick=()=>{
  const name=$("#newCatName").value.trim();
  if(!name) return;
  db.categories.push({id:uid(), name, parentCategoryId:null, items:[]});
  $("#newCatName").value="";
  save(); renderAll();
};

$("#btnAddItem").onclick=()=>{
  const cat = db.categories.find(c=>c.id===activeCatId); if(!cat) return;
  const name=$("#newItemName").value.trim() || ("–ù–æ–≤—ã–π "+cat.name.slice(0,-1));
  $("#newItemName").value="";
  cat.items.push({id:uid(), name, lat:41.3111, lng:69.2797, parentId:null});
  save(); renderAll();
};

$("#btnExport").onclick=()=>{
  const blob=new Blob([JSON.stringify(db,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="dictionary_dynamic_v6.json"; a.click();
};

$("#fileImport").addEventListener("change", e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{
      const obj=JSON.parse(r.result);
      if(!obj || !Array.isArray(obj.categories)) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");
      db=obj; save(); // –ø–æ–ø—Ä–∞–≤–∏–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
      activeCatId = db.categories[0]?.id || null;
      renderAll(); alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!");
    }catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+err.message); } };
  r.readAsText(f);
});

$("#btnReset").onclick=()=>{
  if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?")) return;
  localStorage.removeItem(KEY);
  location.reload();
};

/* ====== RENDER ALL ====== */
function renderAll(){ renderCategories(); renderItems(); }
renderAll();
</script>
</body>
</html>
