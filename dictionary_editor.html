<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ v8 ‚Äî —Å–µ–ª–µ–∫—Ç—ã + —á–µ–∫–±–æ–∫—Å—ã</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:#172133;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
input,select{width:100%;padding:6px;border-radius:6px;border:1px solid #31405a;background:#0f1624;color:#fff}
.row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:6px;padding:6px 8px;background:#111a2a}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
.tools{display:flex;gap:6px}
small.muted{color:var(--muted)}
#map{width:100%;height:100%}
.previewSel{margin:6px 0;width:100%}
.checkbox-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:6px}
.checkbox-grid label{display:flex;align-items:center;gap:4px;background:#111a2a;padding:4px 6px;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v8</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label><input type="file" id="fileImport" style="display:none"><button>–ò–º–ø–æ—Ä—Ç</button></label>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel"><h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3><div id="cascadeBox"></div></div>
  </aside>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ====== STORAGE ====== */
const KEY="dict_v8";
let db = JSON.parse(localStorage.getItem(KEY) || "null");
if(!db){
  db = {
    categories:[
      {id:uid(), name:"–°—Ç—Ä–∞–Ω—ã", type:"select", parentCategoryId:null, items:[{id:uid(), name:"–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", lat:41.3, lng:69.2, parentId:null}]},
      {id:uid(), name:"–ì–æ—Ä–æ–¥–∞", type:"select", parentCategoryId:null, items:[{id:uid(), name:"–¢–∞—à–∫–µ–Ω—Ç", lat:41.311, lng:69.279, parentId:null}]},
      {id:uid(), name:"–†–∞–π–æ–Ω—ã", type:"checkbox", parentCategoryId:null, items:[
        {id:uid(), name:"–Æ–Ω—É—Å–∞–±–∞–¥", lat:41.367, lng:69.287, parentId:null},
        {id:uid(), name:"–ú–∏—Ä–∞–±–∞–¥", lat:41.315, lng:69.275, parentId:null},
        {id:uid(), name:"–ß–∏–ª–∞–Ω–∑–∞—Ä", lat:41.285, lng:69.204, parentId:null}
      ]}
    ]
  };
  save();
}
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ====== MAP ====== */
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let markers=[];

function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
function addMarker(lat,lng,label){ const m=L.marker([lat,lng]).addTo(map).bindPopup(label); markers.push(m); }

/* ====== EDITOR ====== */
const $editor=$("#editorTab");
function renderEditor(){
  $editor.innerHTML="";
  db.categories.forEach(cat=>{
    const sec=document.createElement("div"); sec.className="panel";
    const h=document.createElement("h3"); h.textContent=cat.name+" ("+cat.type+")"; sec.appendChild(h);
    const list=document.createElement("div"); list.className="list";
    cat.items.forEach((it,idx)=>{
      const line=document.createElement("div"); line.className="item";
      const name=document.createElement("div"); name.className="name"; name.textContent=it.name;
      const tools=document.createElement("div"); tools.className="tools";
      const edit=document.createElement("button"); edit.textContent="‚úé";
      edit.onclick=()=>{ const nn=prompt("–ù–æ–≤–æ–µ –∏–º—è",it.name); if(nn){ it.name=nn; save(); renderAll(); } };
      const place=document.createElement("button"); place.textContent="üìç";
      place.onclick=()=>{ alert("–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è "+it.name); map.once("click", e=>{it.lat=e.latlng.lat; it.lng=e.latlng.lng; save(); renderAll();}); };
      const del=document.createElement("button"); del.textContent="‚ùå"; del.className="danger";
      del.onclick=()=>{ if(confirm("–£–¥–∞–ª–∏—Ç—å?")){ cat.items.splice(idx,1); save(); renderAll(); } };
      line.onclick=()=>{ if(it.lat&&it.lng) {clearMarkers(); addMarker(it.lat,it.lng,it.name);} };
      tools.append(edit,place,del); line.append(name,tools); list.appendChild(line);
    });
    const row=document.createElement("div"); row.className="row";
    const inp=document.createElement("input"); inp.placeholder="–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç";
    const btn=document.createElement("button"); btn.textContent="+ –ù–æ–≤—ã–π";
    btn.onclick=()=>{ const nm=inp.value.trim()||"–ù–æ–≤—ã–π"; cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:null}); save(); renderAll(); };
    row.append(inp,btn); sec.appendChild(list); sec.appendChild(row);
    $editor.appendChild(sec);
  });
}

/* ====== PREVIEW ====== */
const $cascade=$("#cascadeBox");
function renderPreview(){
  $cascade.innerHTML="";
  clearMarkers();
  db.categories.forEach(cat=>{
    const wrap=document.createElement("div"); wrap.className="panel";
    const title=document.createElement("h4"); title.textContent=cat.name; wrap.appendChild(title);

    if(cat.type==="select"){
      const sel=document.createElement("select"); sel.className="previewSel";
      sel.innerHTML="<option value=''>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>";
      cat.items.forEach(it=>{ sel.innerHTML+=`<option value='${it.id}'>${it.name}</option>`; });
      sel.onchange=()=>{ const it=cat.items.find(x=>x.id===sel.value); if(it&&it.lat&&it.lng){ clearMarkers(); addMarker(it.lat,it.lng,it.name); map.setView([it.lat,it.lng],13);} };
      wrap.appendChild(sel);
    }else if(cat.type==="checkbox"){
      const grid=document.createElement("div"); grid.className="checkbox-grid";
      cat.items.forEach(it=>{
        const label=document.createElement("label");
        const cb=document.createElement("input"); cb.type="checkbox"; cb.value=it.id;
        cb.onchange=()=>{
          clearMarkers();
          cat.items.filter(x=>grid.querySelectorAll("input:checked")).forEach(xx=>{ if(xx.lat&&xx.lng) addMarker(xx.lat,xx.lng,xx.name); });
          grid.querySelectorAll("input:checked").forEach(ch=>{
            const item=cat.items.find(x=>x.id===ch.value);
            if(item&&item.lat&&item.lng) addMarker(item.lat,item.lng,item.name);
          });
        };
        label.append(cb,document.createTextNode(it.name));
        grid.appendChild(label);
      });
      wrap.appendChild(grid);
    }
    $cascade.appendChild(wrap);
  });
}

/* ====== UTILS ====== */
function renderAll(){ renderEditor(); renderPreview(); }
function $(s){ return document.querySelector(s); }

/* ====== EXPORT/IMPORT ====== */
$("#btnExport").onclick=()=>{ const blob=new Blob([JSON.stringify(db,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="dict_v8.json"; a.click(); };
$("#fileImport").onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ db=JSON.parse(r.result); save(); renderAll(); alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!"); }catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞"); } }; r.readAsText(f); };
$("#btnReset").onclick=()=>{ if(confirm("–û—á–∏—Å—Ç–∏—Ç—å?")){ localStorage.removeItem(KEY); location.reload(); } };

/* ====== TAB SWITCH ====== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const which=tab.dataset.tab;
    $("#editorTab").style.display=(which==="editor")?"block":"none";
    $("#previewTab").style.display=(which==="preview")?"block":"none";
  };
});

/* ====== INIT ====== */
renderAll();
</script>
</body>
</html>
