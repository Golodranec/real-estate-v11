<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ª–æ–∫–∞—Ü–∏–π ‚Äî —Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
main{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
h3{margin:0 0 10px 0;color:#cfe0ff}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
input.search{width:100%;margin-bottom:8px}
ul.tree{list-style:none;margin:0;padding-left:18px}
ul.tree>li{margin:6px 0}
.title{cursor:default}
.coords{color:var(--muted);font-size:12px;margin-left:6px}
.tools{display:inline-flex;gap:6px;margin-left:8px;flex-wrap:wrap}
#previewMap{height:320px;border:1px solid var(--border);border-radius:10px;margin-top:10px}
.muted{color:var(--muted)}
/* –º–æ–¥–∞–ª–∫–∞ –∫–∞—Ä—Ç—ã */
#mapModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
#mapBox{background:#111;border:1px solid #333;border-radius:10px;width:84vw;max-width:1200px;height:84vh;display:flex;flex-direction:column}
#mapHead{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #333}
#map{flex:1}
@media (max-width:980px){main{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary-manual v1.0</span>
  <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
  <label class="btn"><input type="file" id="fileImport" style="display:none">–ò–º–ø–æ—Ä—Ç JSON</label>
  <button class="btn danger" id="btnReset">–°–±—Ä–æ—Å</button>
</header>

<main>
  <section class="panel">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä (–¥–µ—Ä–µ–≤–æ)</h3>
    <input id="q" class="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞—Ü–∏—è–º...">
    <div style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnAddRoot">+ –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
    </div>
    <ul id="tree" class="tree"></ul>
  </section>

  <section class="panel">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–∫–∞—Å–∫–∞–¥–Ω—ã–µ —Å–µ–ª–µ–∫—Ç—ã)</h3>
    <div class="muted" style="margin:-4px 0 8px 0">–í—ã–±–∏—Ä–∞–µ—à—å —Å–ª–µ–≤–∞ –≤ –¥–µ—Ä–µ–≤–µ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—à—å. –°–ø—Ä–∞–≤–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—à—å, –∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –Ω–∞ —Å–∞–π—Ç–µ.</div>
    <div id="selectsBox"></div>
    <div id="previewMap"></div>
  </section>
</main>

<!-- –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
<div id="mapModal">
  <div id="mapBox">
    <div id="mapHead">
      <div id="mapTitle">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnClearCoord">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn danger" id="btnCloseMap">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ====== –ë–ê–ó–ê ====== */
const KEY="dict_manual_v1";
let dict = JSON.parse(localStorage.getItem(KEY) || JSON.stringify({
  levelLabels:["–°—Ç—Ä–∞–Ω–∞","–ì–æ—Ä–æ–¥","–†–∞–π–æ–Ω / –ú–µ—Ç—Ä–æ","–ú–∞—Å—Å–∏–≤ / –ú–∏–∫—Ä–æ—Ä–∞–π–æ–Ω"],
  tree:{} // { "–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω": { coords:[...], children:{ "–¢–∞—à–∫–µ–Ω—Ç":{...} } } }
}));
function save(){ localStorage.setItem(KEY, JSON.stringify(dict)); }
function sortKeys(obj){ return Object.keys(obj||{}).filter(k=>k!=="coords"&&k!=="children").sort((a,b)=>a.localeCompare(b,"ru",{sensitivity:"base"})); }

/* ====== –ü–û–ò–°–ö ====== */
document.getElementById('q').addEventListener('input', ()=>{ renderTree(); });

/* ====== –†–ï–ù–î–ï–† –î–ï–†–ï–í–ê ====== */
const treeEl = document.getElementById('tree');
function renderTree(){
  const q=(document.getElementById('q').value||"").trim().toLowerCase();
  treeEl.innerHTML='';
  function match(name,node){
    if(!q) return true;
    if(name.toLowerCase().includes(q)) return true;
    for(const k of Object.keys(node.children||{})){ if(match(k,node.children[k])) return true; }
    return false;
  }
  function drawLevel(obj, parent, path){
    sortKeys(obj).forEach(name=>{
      const node=obj[name]; if(!match(name,node)) return;
      const li=document.createElement('li');

      const title=document.createElement('span'); title.className='title'; title.textContent=name;
      li.appendChild(title);

      if(node.coords){ const c=document.createElement('span'); c.className='coords'; c.textContent=`${node.coords[0]}, ${node.coords[1]}`; li.appendChild(c); }

      const tools=document.createElement('span'); tools.className='tools';
      // + –¥–æ–±–∞–≤–∏—Ç—å
      const bAdd=document.createElement('button'); bAdd.className='btn'; bAdd.textContent='+'; bAdd.title='–î–æ–±–∞–≤–∏—Ç—å –¥–æ—á–µ—Ä–Ω–∏–π';
      bAdd.onclick=()=>addNode(path.concat(name));
      // ‚úé –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
      const bRen=document.createElement('button'); bRen.className='btn'; bRen.textContent='‚úé';
      bRen.onclick=()=>renameNode(path.concat(name));
      // ‚ùå —É–¥–∞–ª–∏—Ç—å
      const bDel=document.createElement('button'); bDel.className='btn danger'; bDel.textContent='‚ùå';
      bDel.onclick=()=>deleteNode(path.concat(name));
      // üìç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
      const bGeo=document.createElement('button'); bGeo.className='btn'; bGeo.textContent='üìç';
      bGeo.onclick=()=>openMapFor(path.concat(name));

      tools.append(bAdd,bRen,bDel,bGeo);
      li.appendChild(tools);

      const ul=document.createElement('ul'); ul.className='tree';
      drawLevel(node.children||{}, ul, path.concat(name));
      if(ul.children.length) li.appendChild(ul);

      parent.appendChild(li);
    });
  }
  drawLevel(dict.tree, treeEl, []);
}

/* ====== –£–¢–ò–õ–ò–¢–´ –î–û–°–¢–£–ü–ê –ü–û –ü–£–¢–ò ====== */
function getNode(path){
  let cur=dict.tree, node=null;
  for(const part of path){ if(!cur[part]) return null; node=cur[part]; cur=node.children||{}; }
  return node;
}
function getParentAndKey(path){
  if(path.length===0) return {parent:dict.tree,key:null};
  const key=path[path.length-1];
  let cur=dict.tree;
  for(let i=0;i<path.length-1;i++){ const name=path[i]; if(!cur[name]) return null; cur=cur[name].children||(cur[name].children={}); }
  return {parent:cur,key};
}

/* ====== –û–ü–ï–†–ê–¶–ò–ò –° –î–ï–†–ï–í–û–ú ====== */
document.getElementById('btnAddRoot').onclick=()=>{
  const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω):'); if(!name) return;
  if(!dict.tree[name]) dict.tree[name]={children:{}};
  save(); renderTree(); renderPreview();
};
function addNode(path){
  const parentNode = path.length? getNode(path) : null;
  const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ:'); if(!name) return;
  const children = parentNode?(parentNode.children||(parentNode.children={})) : dict.tree;
  if(children[name]){ alert('–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å –≤ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ'); return; }
  children[name]={children:{}};
  save(); renderTree(); renderPreview();
}
function renameNode(path){
  const pk=getParentAndKey(path); if(!pk) return;
  const node=pk.parent[pk.key];
  const name=prompt('–ù–æ–≤–æ–µ –∏–º—è', pk.key); if(!name || name===pk.key) return;
  if(pk.parent[name]){ alert('–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å'); return; }
  pk.parent[name]=node; delete pk.parent[pk.key];
  save(); renderTree(); renderPreview();
}
function deleteNode(path){
  const pk=getParentAndKey(path); if(!pk) return;
  if(!confirm('–£–¥–∞–ª–∏—Ç—å "'+pk.key+'"?')) return;
  delete pk.parent[pk.key];
  save(); renderTree(); renderPreview();
}

/* ====== –ö–ê–†–¢–ê (–≤—ã–±–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç) ====== */
let map, mapMarker=null, mapPath=null, previewMap, previewMarker=null;
function ensureMap(){
  if(!map){
    map=L.map('map').setView([41.31,69.28],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    map.on('click', e=>{
      if(!mapPath) return;
      const node=getNode(mapPath); if(!node) return;
      node.coords=[+e.latlng.lat.toFixed(6), +e.latlng.lng.toFixed(6)];
      if(mapMarker){ map.removeLayer(mapMarker); }
      mapMarker=L.marker(node.coords).addTo(map);
      save(); renderTree(); updatePreviewMarker(node);
    });
  }
}
function openMapFor(path){
  mapPath=path.slice();
  const node=getNode(mapPath);
  document.getElementById('mapTitle').textContent='–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: '+path.join(' ‚Üí ');
  document.getElementById('mapModal').style.display='flex';
  setTimeout(()=>{
    ensureMap();
    map.invalidateSize();
    if(node && node.coords){ map.setView(node.coords, 14); if(mapMarker){ map.removeLayer(mapMarker);} mapMarker=L.marker(node.coords).addTo(map); }
  },60);
}
document.getElementById('btnCloseMap').onclick=()=>{ document.getElementById('mapModal').style.display='none'; mapPath=null; };
document.getElementById('btnClearCoord').onclick=()=>{
  if(!mapPath) return;
  const node=getNode(mapPath); if(node && node.coords){ delete node.coords; if(mapMarker){ map.removeLayer(mapMarker); mapMarker=null; } save(); renderTree(); updatePreviewMarker(null); }
};

/* ====== –ü–†–ï–î–ü–†–û–°–ú–û–¢–† ====== */
function renderPreview(){
  const box=document.getElementById('selectsBox');
  box.innerHTML='';
  // –ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ –¥–µ—Ä–µ–≤–∞
  addLevel(dict.tree, 0, box);
  if(!previewMap){
    previewMap=L.map('previewMap').setView([41.31,69.28],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(previewMap);
  }
  updatePreviewMarker(null);
}
function addLevel(childrenObj, depth, container){
  const wrap=document.createElement('div'); wrap.style.marginBottom='8px';
  const label=document.createElement('div'); label.className='muted';
  label.textContent=(dict.levelLabels[depth] || '–£—Ä–æ–≤–µ–Ω—å '+(depth+1));
  const sel=document.createElement('select'); sel.innerHTML='<option value="">‚Äî</option>';
  sortKeys(childrenObj).forEach(name=>{
    const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt);
  });
  sel.onchange=()=>{
    // —É–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —É—Ä–æ–≤–Ω–∏
    while(wrap.nextSibling){ container.removeChild(wrap.nextSibling); }
    if(!sel.value){ updatePreviewMarker(null); return; }
    const node=childrenObj[sel.value];
    updatePreviewMarker(node);
    if(node && node.children && Object.keys(node.children).length){
      addLevel(node.children, depth+1, container);
    }
  };
  wrap.appendChild(label); wrap.appendChild(sel); container.appendChild(wrap);
}
function updatePreviewMarker(node){
  if(previewMarker){ previewMap.removeLayer(previewMarker); previewMarker=null; }
  if(node && node.coords){
    previewMarker=L.marker(node.coords).addTo(previewMap).bindPopup('–í—ã–±—Ä–∞–Ω–æ: '+(node._name||''));
    previewMap.setView(node.coords, 12);
  }
}

/* ====== –≠–ö–°–ü–û–†–¢ / –ò–ú–ü–û–†–¢ / –°–ë–†–û–° ====== */
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify(dict,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='locations_manual.json'; a.click();
};
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{
      const obj=JSON.parse(r.result);
      if(!obj || typeof obj!=='object' || !obj.tree){ throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'); }
      dict=obj; save(); renderTree(); renderPreview(); alert('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); } };
  r.readAsText(f);
};
document.getElementById('btnReset').onclick=()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?')){
    localStorage.removeItem(KEY);
    dict={levelLabels:["–°—Ç—Ä–∞–Ω–∞","–ì–æ—Ä–æ–¥","–†–∞–π–æ–Ω / –ú–µ—Ç—Ä–æ","–ú–∞—Å—Å–∏–≤ / –ú–∏–∫—Ä–æ—Ä–∞–π–æ–Ω"], tree:{}};
    save(); renderTree(); renderPreview();
  }
};

/* ====== –ò–ù–ò–¢ ====== */
renderTree(); renderPreview();
</script>
</body>
</html>
