<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dictionary Editor + Preview</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;--danger:#ef4444;--accent:#4aa8ff;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;display:flex;justify-content:space-between;align-items:center}
main{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:6px 10px;border-radius:8px;cursor:pointer;margin:2px}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.tree{list-style:none;padding-left:20px}
.tree li{margin:4px 0}
.coords{color:var(--muted);font-size:12px;margin-left:6px}
#mapModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
#mapBox{background:#111;padding:10px;border-radius:8px;width:80%;height:80%;display:flex;flex-direction:column}
#map{flex:1;border:1px solid var(--border)}
#previewList{font-size:13px;line-height:1.6}
#previewList .item{margin:2px 0;padding:2px 4px;border-bottom:1px dashed var(--border)}
#previewMap{height:300px;margin-top:10px;border:1px solid var(--border);border-radius:8px}
</style>
</head>
<body>
<header>
  <h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–†–µ–¥–∞–∫—Ç–æ—Ä –ª–æ–∫–∞—Ü–∏–π)</h2>
  <div>
    <button class="btn" onclick="exportDict()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <label class="btn"><input type="file" id="importFile" style="display:none">–ò–º–ø–æ—Ä—Ç JSON</label>
  </div>
</header>

<main>
  <!-- —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
  <section class="panel">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä</h3>
    <button class="btn" onclick="addNode(null)">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω—É</button>
    <ul id="tree" class="tree"></ul>
  </section>

  <!-- –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
  <section class="panel">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div id="previewList"></div>
    <div id="previewMap"></div>
  </section>
</main>

<div id="mapModal">
  <div id="mapBox">
    <div style="margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
      <span id="mapTitle" style="color:#fff"></span>
      <button class="btn danger" onclick="closeMap()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const KEY="dictionaryData";
let dict=JSON.parse(localStorage.getItem(KEY)||"{}");

function save(){localStorage.setItem(KEY,JSON.stringify(dict));}
function render(){
  let ul=document.getElementById("tree"); ul.innerHTML="";
  function renderLevel(obj,parentUl,path){
    Object.keys(obj).forEach(key=>{
      if(key==="coords") return;
      let li=document.createElement("li");
      li.innerHTML=`<span>${key}</span> 
        <span class="coords">${obj[key].coords?obj[key].coords.join(", "):""}</span>
        <button class="btn" onclick='addNode(${JSON.stringify(path.concat(key))})'>+ –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn" onclick='renameNode(${JSON.stringify(path.concat(key))})'>‚úé</button>
        <button class="btn danger" onclick='deleteNode(${JSON.stringify(path.concat(key))})'>–£–¥–∞–ª–∏—Ç—å</button>
        <button class="btn" onclick='setCoords(${JSON.stringify(path.concat(key))})'>üìç –£–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>`;
      let subUl=document.createElement("ul"); subUl.className="tree";
      renderLevel(obj[key],subUl,path.concat(key));
      li.appendChild(subUl); parentUl.appendChild(li);
    });
  }
  renderLevel(dict,ul,[]);
  renderPreview();
}

function getNode(path){return path.reduce((acc,k)=>acc[k],dict);}
function addNode(path){
  let name=prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
  if(!name) return;
  if(path===null){dict[name]={};}
  else{let node=getNode(path);node[name]={};}
  save(); render();
}
function renameNode(path){
  let last=path[path.length-1];
  let parent=path.slice(0,-1).reduce((acc,k)=>acc[k],dict);
  let name=prompt("–ù–æ–≤–æ–µ –∏–º—è",last);
  if(!name) return;
  parent[name]=parent[last]; delete parent[last];
  save(); render();
}
function deleteNode(path){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
  let last=path[path.length-1];
  let parent=path.slice(0,-1).reduce((acc,k)=>acc[k],dict);
  delete parent[last];
  save(); render();
}

let map,mapPath,previewMap;
function setCoords(path){
  mapPath=path;
  document.getElementById("mapModal").style.display="flex";
  setTimeout(()=>{
    if(!map){
      map=L.map("map").setView([41.31,69.28],12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OSM"}).addTo(map);
      map.on("click",e=>{
        if(mapPath){
          let node=getNode(mapPath);
          node.coords=[e.latlng.lat.toFixed(5),e.latlng.lng.toFixed(5)];
          save(); render(); closeMap();
        }
      });
    }
    map.invalidateSize();
  },100);
}
function closeMap(){document.getElementById("mapModal").style.display="none";mapPath=null;}

function renderPreview(){
  let list=document.getElementById("previewList");
  list.innerHTML="";
  let items=[];
  function walk(obj,path){
    Object.keys(obj).forEach(k=>{
      if(k==="coords") return;
      let newPath=path.concat(k);
      items.push({path:newPath.join(" ‚Üí "),coords:obj[k].coords});
      walk(obj[k],newPath);
    });
  }
  walk(dict,[]);
  items.forEach(it=>{
    let div=document.createElement("div");div.className="item";
    div.textContent=it.path+(it.coords?" üìç("+it.coords.join(", ")+")":"");
    list.appendChild(div);
  });

  if(!previewMap){
    previewMap=L.map("previewMap").setView([41.31,69.28],6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OSM"}).addTo(previewMap);
  }
  previewMap.eachLayer(l=>{if(l instanceof L.Marker) previewMap.removeLayer(l);});
  items.forEach(it=>{
    if(it.coords){
      L.marker(it.coords).addTo(previewMap).bindPopup(it.path);
    }
  });
}

function exportDict(){
  let blob=new Blob([JSON.stringify(dict,null,2)],{type:"application/json"});
  let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="dictionaries.json"; a.click();
}
document.getElementById("importFile").onchange=function(e){
  let f=e.target.files[0]; if(!f)return;
  let r=new FileReader();
  r.onload=function(){
    try{let obj=JSON.parse(r.result); if(obj && typeof obj==="object"){dict=obj; save(); render(); alert("–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω");}}
    catch(err){alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+err.message);}
  };
  r.readAsText(f);
};

render();
</script>
</body>
</html>
