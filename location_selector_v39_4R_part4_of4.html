){ alert('–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã'); return; }
          it.lat=parseFloat(m[1]); it.lng=parseFloat(m[3]); commit(); map.setView([it.lat,it.lng],15);
        };
        const clearBtn=document.createElement('button'); clearBtn.textContent='üóë –º–µ—Ç–∫–∞'; clearBtn.onclick=()=>{it.lat=null; it.lng=null; commit();};
        const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger'; del.onclick=()=>{if(confirm('–£–¥–∞–ª–∏—Ç—å "'+it.name+'"?')){cat.items=cat.items.filter(x=>x.id!==it.id); commit();}};

        row.onclick=()=>{ if(it.lat!=null&&it.lng!=null){ map.setView([it.lat,it.lng],16); } };
        tools.append(selCb,edit,upBtn,downBtn,place,copyBtn,pasteBtn,clearBtn,del);
        row.append(left,tools); list.appendChild(row);
      });
      body.appendChild(list);

      // –º–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
      btnMassDelete.onclick=()=>{ if(selectedSet.size===0) return; if(!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${selectedSet.size})?`)) return; cat.items=cat.items.filter(it=>!selectedSet.has(it.id)); selectedSet.clear(); commit(); };
      btnMassMove.onclick=()=>{ if(selectedSet.size===0) return; const destId=prompt('ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', (db.categories.find(c=>c.id!==cat.id)||{}).id||""); if(!destId) return;
        const dest=db.categories.find(c=>c.id===destId); if(!dest){alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');return;}
        const moving=cat.items.filter(it=>selectedSet.has(it.id)); cat.items=cat.items.filter(it=>!selectedSet.has(it.id)); dest.items.push(...moving); selectedSet.clear(); commit();
      };
      btnMassIcon.onclick=()=>{ if(selectedSet.size===0) return; openIconsLib(data=>{ cat.items.forEach(it=>{ if(selectedSet.has(it.id)) it.iconData=data; }); selectedSet.clear(); commit(); }); };

      // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ + –ø–æ–¥—Å–∫–∞–∑–∫–∏
      const addRow=document.createElement('div'); addRow.className='row';
      const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
      const parentPicker=document.createElement('select');
      if(cat.parentCategoryId){
        const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
        parentPicker.innerHTML=`<option value="">(–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+(parentCat?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      }else{ parentPicker.innerHTML=`<option value="">(—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω)</option>`; }
      const addBtn=document.createElement('button'); addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å';
      addBtn.onclick=()=>{ const nm=inp.value.trim(); if(!nm) return; cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:parentPicker.value||null}); inp.value=''; commit(); };
      addRow.append(inp,parentPicker,addBtn); body.appendChild(addRow);
      attachSuggestions(inp);

      sec.appendChild(body);
      head.onclick=()=>{
        if(collapsedCats.has(cat.id)) collapsedCats.delete(cat.id); else collapsedCats.add(cat.id);
        setCollapsedSet('collapsedCats_v2',collapsedCats); sec.classList.toggle('collapsed');
      };

      // drag&drop –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      sec.draggable=true;
      sec.addEventListener('dragstart',e=>{
        e.dataTransfer.setData('text/plain', JSON.stringify({type:'cat',catId:cat.id}));
        sec.classList.add('dragging');
      });
      sec.addEventListener('dragend',()=>sec.classList.remove('dragging'));
      sec.addEventListener('dragover',e=>{ e.preventDefault(); sec.classList.add('dropzone-hover'); });
      sec.addEventListener('dragleave',()=>sec.classList.remove('dropzone-hover'));
      sec.addEventListener('drop',e=>{
        e.preventDefault(); sec.classList.remove('dropzone-hover');
        let payload={}; try{ payload=JSON.parse(e.dataTransfer.getData('text/plain')||'{}'); }catch(_){}
        if(payload.type!=='cat') return;
        const fromIdx=db.categories.findIndex(c=>c.id===payload.catId);
        const toIdx  =db.categories.findIndex(c=>c.id===sec.dataset.catId);
        if(fromIdx<0||toIdx<0||fromIdx===toIdx) return; moveArrayItem(db.categories,fromIdx,toIdx); commit();
      });

      // drag&drop —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      [...list.children].forEach(row=>{
        row.draggable=true;
        row.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain', JSON.stringify({type:'item',catId:cat.id,itemId:row.dataset.itemId}));
          row.classList.add('dragging');
        });
        row.addEventListener('dragend',()=>row.classList.remove('dragging'));
        row.addEventListener('dragover',e=>{ e.preventDefault(); row.classList.add('dropzone-hover'); });
        row.addEventListener('dragleave',()=>row.classList.remove('dropzone-hover'));
        row.addEventListener('drop',e=>{
          e.preventDefault(); row.classList.remove('dropzone-hover');
          let payload={}; try{ payload=JSON.parse(e.dataTransfer.getData('text/plain')||'{}'); }catch(_){}
          if(payload.type!=='item' || payload.catId!==cat.id) return;
          const fromIdx=cat.items.findIndex(x=>x.id===payload.itemId);
          const toIdx  =cat.items.findIndex(x=>x.id===row.dataset.itemId);
          if(fromIdx<0||toIdx<0||fromIdx===toIdx) return; moveArrayItem(cat.items,fromIdx,toIdx); commit();
        });
      });

      $editor.appendChild(sec);
    });

    // –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ
    const infoPanel=document.createElement('div'); infoPanel.className='panel';
    const infoBtn=document.createElement('button'); infoBtn.textContent='–ò–Ω—Ñ–æ / —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞';
    infoBtn.onclick=()=>{ document.getElementById('btnInfo').click(); };
    infoPanel.appendChild(infoBtn);
    $editor.appendChild(infoPanel);
  }

  /***** TABS *****/
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.onclick=()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const which=tab.dataset.tab;
      document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
      document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
    };
  });

  /***** EXPORT/IMPORT (–≤—Å—ë) *****/
  document.getElementById('btnExport').onclick=async ()=>{
    const full=JSON.parse(JSON.stringify(db));
    for(const cat of full.categories){
      if(cat.iconKey && !cat.iconData){ try{ cat.iconData=await lfIcons.getItem(cat.iconKey)||null; }catch(e){} }
      for(const it of (cat.items||[])){
        if(it.iconKey && !it.iconData){ try{ it.iconData=await lfIcons.getItem(it.iconKey)||null; }catch(e){} }
      }
    }
    for(const p of (full.polygons||[])){
      if(!p.geojson){ try{ p.geojson=await lfGeo.getItem(p.id)||null; }catch(e){} }
    }
    const blob=new Blob([JSON.stringify(full,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_full_v39_4R.json'; a.click();
  };

  document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
  document.getElementById('fileImport').onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=async ()=>{
      try{
        let obj=JSON.parse(r.result); if(obj && obj.db) obj=obj.db;
        if(!Array.isArray(obj.categories)) throw new Error('–ù–µ—Ç categories');
        if(!Array.isArray(obj.polygons))   obj.polygons=[];
        for(const cat of obj.categories){
          if(!cat.id) cat.id=uid();
          if(cat.iconData){ const key=cat.iconKey||`cat_${cat.id}`; await lfIcons.setItem(key,cat.iconData); cat.iconKey=key; }
          for(const it of (cat.items||[])){
            if(!it.id) it.id=uid();
            if(it.iconData){ const key=it.iconKey||`item_${it.id}`; await lfIcons.setItem(key,it.iconData); it.iconKey=key; }
          }
        }
        for(const p of obj.polygons){ if(!p.id) p.id=uid(); if(p.geojson){ await lfGeo.setItem(p.id,p.geojson); } }
        localStorage.setItem(KEY, JSON.stringify({
          categories:obj.categories.map(c=>({
            id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId||null,
            color:c.color,shape:c.shape,iconKey:c.iconKey||null,
            items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId||null,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
          })),
          polygons:(obj.polygons||[]).map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
        }));
        db = await loadDB();
        loadSelected(); pushHistory(); renderAll(); resumeEditingIfNeeded(); updatePolygonVisibility();
        alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
      }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
    };
    r.readAsText(f);
  };

  /***** EXPORT/IMPORT –ü–û –ö–ê–¢–ï–ì–û–†–ò–ò *****/
  async function exportCategory(catId){
    const cat=db.categories.find(c=>c.id===catId); if(!cat) return;
    let items=[...(cat.items||[])];
    if(cat.parentCategoryId){
      const parentIds=getSelectedIds(cat.parentCategoryId);
      if(parentIds.length>0) items=items.filter(it=> it.parentId && parentIds.includes(it.parentId));
    }
    const pack={category:{ id:cat.id, name:cat.name, type:cat.type, parentCategoryId:cat.parentCategoryId, items:items }};
    const blob=new Blob([JSON.stringify(pack,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${cat.name}_export.json`; a.click();
  }

  function importIntoCategory(catId){
    const input=document.createElement('input'); input.type='file'; input.accept='.json,.txt';
    input.onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=async ()=>{
        try{
          const target=db.categories.find(c=>c.id===catId);
          if(!target) throw new Error('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          let pack=JSON.parse(r.result);
          let items=[];
          if(Array.isArray(pack.items)) items=pack.items;
          else if(pack.category && Array.isArray(pack.category.items)) items=pack.category.items;
          else if(Array.isArray(pack)) items=pack;
          else throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: –æ–∂–∏–¥–∞—é—Ç—Å—è items');

          let applyAll=null;
          for(const incoming of items){
            const name=(incoming.name||"").trim(); if(!name) continue;
            if(!('id' in incoming)) incoming.id=uid();
            if(!('lat' in incoming)) incoming.lat=null;
            if(!('lng' in incoming)) incoming.lng=null;
            if(!('parentId' in incoming)) incoming.parentId=null;

            const exists=target.items.find(x=>x.name===name);
            if(exists){
              if(applyAll){ if(applyAll==='overwrite'){ Object.assign(exists, {...incoming, id:exists.id}); } continue; }
              const choice = await askConflict(`–≠–ª–µ–º–µ–Ω—Ç "<b>${name}</b>" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "<b>${target.name}</b>". –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?`);
              if(choice==='overwrite'){ Object.assign(exists, {...incoming, id:exists.id}); }
              else if(choice==='applyAllOverwrite'){ Object.assign(exists, {...incoming, id:exists.id}); applyAll='overwrite'; }
            }else{
              target.items.push({id:incoming.id,name,lat:incoming.lat,lng:incoming.lng,parentId:incoming.parentId});
            }
          }
          await commit(); alert('–ò–º–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à—ë–Ω');
        }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: '+err.message); }
      };
      r.readAsText(f);
    };
    input.click();
  }

  /***** –ü–õ–ê–í–ê–Æ–©–ï–ï –û–ö–ù–û –ö–û–û–†–î–ò–ù–ê–¢ *****/
  const $coordTool=document.getElementById('coordTool');
  const $coordLat=document.getElementById('coordLat');
  const $coordLng=document.getElementById('coordLng');
  const $btnCoordFind=document.getElementById('btnCoordFind');
  const $btnCoordAdd=document.getElementById('btnCoordAdd');
  const $btnCoordClear=document.getElementById('btnCoordClear');
  let tempMarker=null;

  document.getElementById('map').appendChild($coordTool);
  (function restoreCoordToolPos(){
    const pos=JSON.parse(localStorage.getItem('coordToolPos')||'null');
    if(pos){ $coordTool.style.left=pos.left; $coordTool.style.top=pos.top; }
    else{ $coordTool.style.right='12px'; $coordTool.style.top='12px'; }
  })();
  $coordTool.style.display='grid';

  (function enableDrag(){
    const handle=document.getElementById('coordDrag');
    let sx=0,sy=0,ox=0,oy=0,isDown=false;
    handle.addEventListener('mousedown',e=>{isDown=true;sx=e.clientX;sy=e.clientY; const r=$coordTool.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault();});
    document.addEventListener('mousemove',e=>{
      if(!isDown) return;
      const dx=e.clientX-sx, dy=e.clientY-sy;
      const mapRect=document.getElementById('map').getBoundingClientRect();
      let left=ox+dx, top=oy+dy;
      const toolRect=$coordTool.getBoundingClientRect();
      const w=toolRect.width, h=toolRect.height;
      if(left<mapRect.left) left=mapRect.left;
      if(top<mapRect.top) top=mapRect.top;
      if(left+w>mapRect.right) left=mapRect.right-w;
      if(top+h>mapRect.bottom) top=mapRect.bottom-h;
      $coordTool.style.left=(left-mapRect.left)+'px';
      $coordTool.style.top =(top -mapRect.top )+'px';
      $coordTool.style.right='auto';
    });
    document.addEventListener('mouseup',()=>{
      if(!isDown) return; isDown=false;
      const style=getComputedStyle($coordTool);
      localStorage.setItem('coordToolPos', JSON.stringify({left:style.left, top:style.top}));
    });
  })();

  function setTempMarker(lat,lng){
    if(tempMarker){ map.removeLayer(tempMarker); tempMarker=null; }
    tempMarker=L.marker([lat,lng],{draggable:true}).addTo(map);
    tempMarker.on('dragend',()=>{
      const p=tempMarker.getLatLng(); $coordLat.value=p.lat.toFixed(6); $coordLng.value=p.lng.toFixed(6);
    });
    map.setView([lat,lng],16);
  }

  $btnCoordFind.onclick=()=>{
    const lat=parseFloat($coordLat.value), lng=parseFloat($coordLng.value);
    if(Number.isFinite(lat)&&Number.isFinite(lng)) setTempMarker(lat,lng);
    else alert('–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
  };
  $btnCoordClear.onclick=()=>{
    if(tempMarker){ map.removeLayer(tempMarker); tempMarker=null; }
    $coordLat.value=''; $coordLng.value='';
  };
  $btnCoordAdd.onclick=()=>{
    if(!tempMarker){ alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ "–ù–∞–π—Ç–∏"'); return; }
    const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏ (—ç–ª–µ–º–µ–Ω—Ç–∞):','–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è'); if(!name) return;
    const catNames=db.categories.map(c=>c.name).join(', ');
    const catName=prompt('–í –∫–∞–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å? –î–æ—Å—Ç—É–ø–Ω—ã: '+catNames);
    const cat=db.categories.find(c=>c.name===catName);
    if(!cat){ alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
    let parentId=null;
    if(cat.parentCategoryId){
      const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
      if(parentCat && (parentCat.items||[]).length){
        const parentName=prompt(`–í—ã–±–µ—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—è –∏–∑ "${parentCat.name}" (—Ç–æ—á–Ω–æ–µ –∏–º—è)`, parentCat.items[0].name);
        const parentItem=parentCat.items.find(i=>i.name===parentName);
        if(parentItem) parentId=parentItem.id;
      }
    }
    const p=tempMarker.getLatLng();
    cat.items.push({id:uid(),name:name.trim(),lat:p.lat,lng:p.lng,parentId});
    commit();
    alert('–ú–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: '+cat.name);
  };

  /***** –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –ö–ê–†–¢–´: –ª–∏–Ω–µ–π–∫–∞/—Ç–æ—á–∫–∞/–ª–∏–Ω–∏—è *****/
  let measureActive=false, drawLineActive=false, drawPointActive=false;
  let measureLayer=null;
  const drawControl=new L.Control.Draw({
    draw:{ polygon:false, rectangle:false, circle:false, circlemarker:false, polyline:true, marker:true },
    edit:false
  });
  map.addControl(drawControl);

  function enableMeasure(){
    if(measureActive) return;
    measureActive=true;
    alert('–†–µ–∂–∏–º –ª–∏–Ω–µ–π–∫–∏: —Å—Ç–∞–≤—å —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å.');
    const drawer=new L.Draw.Polyline(map,{shapeOptions:{color:'#4aa8ff',weight:3,dashArray:'6,6'}});
    drawer.enable();
    const onCreated=(e)=>{
      if(measureLayer) map.removeLayer(measureLayer);
      measureLayer=e.layer.addTo(map);
      const latlngs=e.layer.getLatLngs();
      const dist=L.GeometryUtil.length(latlngs);
      alert('–î–ª–∏–Ω–∞: '+formatLen(dist));
      map.off(L.Draw.Event.CREATED,onCreated);
      measureActive=false;
    };
    map.on(L.Draw.Event.CREATED,onCreated);
  }
  document.getElementById('btnMeasure').onclick=()=>enableMeasure();
  document.getElementById('btnDrawLine').onclick=()=>{
    if(drawLineActive) return;
    drawLineActive=true;
    const drawer=new L.Draw.Polyline(map,{shapeOptions:{color:'#23d1b5',weight:3}});
    drawer.enable();
    const onCreated=(e)=>{ e.layer.addTo(map); map.off(L.Draw.Event.CREATED,onCreated); drawLineActive=false; };
    map.on(L.Draw.Event.CREATED,onCreated);
  };
  document.getElementById('btnDrawPoint').onclick=()=>{
    if(drawPointActive) return;
    drawPointActive=true;
    const drawer=new L.Draw.Marker(map,{});
    drawer.enable();
    const onCreated=(e)=>{ e.layer.addTo(map); map.off(L.Draw.Event.CREATED,onCreated); drawPointActive=false; };
    map.on(L.Draw.Event.CREATED,onCreated);
  };

  /***** RESET *****/
  document.getElementById('btnReset').onclick=()=>{
    if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){
      localStorage.removeItem(KEY);
      localStorage.removeItem('selected_v2');
      localStorage.removeItem('polyEditingId');
      localStorage.removeItem('collapsedPolygons_v2');
      localStorage.removeItem('collapsedCats_v2');
      localStorage.removeItem('coordToolPos');
      lfIcons.clear().then(()=>{}); lfGeo.clear().then(()=>{});
      location.reload();
    }
  };

  /***** MAIN RENDER *****/
  async function renderAll(){
    rebuildPolys();
    renderEditor();
    renderPreview();
    renderPolyList();
  }

  /***** RESUME EDIT MODE *****/
  function resumeEditingIfNeeded(){
    const id=localStorage.getItem('polyEditingId'); if(!id) return;
    const layer=polyIndex.get(id); if(!layer) return;

    if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); }
    polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
    polyEditToolbar.enable(); polyEditing=true;

    polyFG.eachLayer(x=>{
      if(x===layer){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
      else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
    });

    setEditingTarget(id); layer.addTo(map); map.fitBounds(layer.getBounds());
    updateEdgeLabels(id);
  }

  /***** –°–¢–ê–†–¢ *****/
  let db=null;
  (async()=>{
    db = await loadDB();
    loadSelected();
    pushHistory();
    await renderAll();
    resumeEditingIfNeeded();
  })();
  </script>
</body>
</html>
