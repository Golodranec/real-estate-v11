<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v11 ‚Äî –∫–∞—Å–∫–∞–¥ + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ + —É–±—Ä–∞—Ç—å –º–µ—Ç–∫—É</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:420px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
h4{margin:0 0 8px 0}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:#111a2a}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px}
.drag-handle{cursor:grab;opacity:.8}
.dragging{opacity:.5;outline:1px dashed var(--accent)}
#map{width:100%;height:100%}
.checkbox-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px}
.checkbox-grid label{display:flex;align-items:center;gap:6px;background:#111a2a;padding:6px 8px;border:1px solid #273248;border-radius:8px;cursor:pointer}
.muted{color:var(--muted)}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v11</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label><input type="file" id="fileImport" style="display:none"><button>–ò–º–ø–æ—Ä—Ç</button></label>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Å–∫–∞–¥–∞</h3>
      <div class="help">–í—ã–±–∏—Ä–∞–π —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑. –ü–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —Ä–æ–¥–∏—Ç–µ–ª—å ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–∫—Ä—ã—Ç.</div>
      <div id="cascadeBox" style="margin-top:8px"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const KEY="dict_v11";
let db = JSON.parse(localStorage.getItem(KEY) || "null");
if(!db){ db={categories:[]}; save(); }
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Math.random().toString(36).slice(2,9); }

let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let markers=[];
function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
function addMarker(lat,lng,label){
  const m=L.marker([lat,lng]).addTo(map).bindPopup(label);
  markers.push(m);
}

let dnd = {type:null, catIndex:null, itemIndex:null};
function dndStart(e, type, catIndex, itemIndex=null){
  dnd={type,catIndex,itemIndex};
  e.currentTarget.classList.add('dragging'); e.dataTransfer.effectAllowed="move";
}
function dndEnd(e){ e.currentTarget.classList.remove('dragging'); dnd={type:null,catIndex:null,itemIndex:null}; }
function dndOver(e){ e.preventDefault(); e.dataTransfer.dropEffect="move"; }
function dndDropCategory(e, targetIndex){
  e.preventDefault();
  if(dnd.type!=="cat"||dnd.catIndex===targetIndex) return;
  const arr=db.categories; const elem=arr.splice(dnd.catIndex,1)[0];
  arr.splice(targetIndex,0,elem); save(); renderAll();
}
function dndDropItem(e, catIndex, targetItemIndex){
  e.preventDefault();
  if(dnd.type!=="item"||dnd.catIndex!==catIndex||dnd.itemIndex===targetItemIndex) return;
  const arr=db.categories[catIndex].items||[]; const elem=arr.splice(dnd.itemIndex,1)[0];
  arr.splice(targetItemIndex,0,elem); save(); renderAll();
}

const $editor=document.getElementById('editorTab');
function renderEditor(){
  $editor.innerHTML="";
  const addPanel=document.createElement('div'); addPanel.className='panel';
  addPanel.innerHTML=`
    <h3>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
    <div class="row">
      <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
      <select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <select id="newCatParent"><option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select>
      <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>`;
  $editor.appendChild(addPanel);

  db.categories.forEach((cat,ci)=>{
    const sec=document.createElement('div'); sec.className='panel'; sec.draggable=true;
    sec.addEventListener('dragstart', e=>dndStart(e,'cat',ci));
    sec.addEventListener('dragend', dndEnd);
    sec.addEventListener('dragover', dndOver);
    sec.addEventListener('drop', e=>dndDropCategory(e, ci));

    const header=document.createElement('div'); header.className='row';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    header.append(title); sec.appendChild(header);

    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name;
    const selType=document.createElement('select');
    ['select','checkbox'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(cat.type===t)o.selected=true;selType.appendChild(o);});
    const selParent=document.createElement('select');
    selParent.innerHTML=`<option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>${db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join('')}`;
    const btnSave=document.createElement('button'); btnSave.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    btnSave.onclick=()=>{cat.name=inpName.value.trim()||cat.name;cat.type=selType.value;cat.parentCategoryId=selParent.value||null;save();renderAll();};
    cfg.append(inpName,selType,selParent,btnSave);
    sec.appendChild(cfg); sec.appendChild(document.createElement('div')).className='sep';

    const list=document.createElement('div'); list.className='list';
    (cat.items||[]).forEach((it,ii)=>{
      const line=document.createElement('div'); line.className='item'; line.draggable=true;
      line.addEventListener('dragstart', e=>dndStart(e,'item',ci,ii));
      line.addEventListener('dragend', dndEnd);
      line.addEventListener('dragover', dndOver);
      line.addEventListener('drop', e=>dndDropItem(e,ci,ii));
      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'‚Äî'} lng:${it.lng??'‚Äî'}`;
      left.append(nm,meta);
      const tools=document.createElement('div'); tools.className='tools';
      const place=document.createElement('button'); place.textContent='üìç'; place.onclick=()=>{alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è '+it.name);map.once('click',e=>{it.lat=e.latlng.lat;it.lng=e.latlng.lng;save();showDraggable(it);});};
      const clearBtn=document.createElement('button'); clearBtn.textContent='üóë –º–µ—Ç–∫–∞'; clearBtn.onclick=()=>{it.lat=null;it.lng=null;save();clearMarkers();renderAll();};
      tools.append(place,clearBtn);
      line.onclick=()=>{if(it.lat!=null)showDraggable(it);};
      line.append(left,tools); list.appendChild(line);
    });
    sec.appendChild(list);
    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
    const addBtn=document.createElement('button'); addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å';
    addBtn.onclick=()=>{cat.items=cat.items||[];cat.items.push({id:uid(),name:inp.value.trim()||'–ù–æ–≤—ã–π',lat:null,lng:null});inp.value='';save();renderAll();};
    addRow.append(inp,addBtn); sec.appendChild(addRow);
    $editor.appendChild(sec);
  });

  document.getElementById('btnAddCat').onclick=()=>{
    const name=document.getElementById('newCatName').value.trim();
    if(!name)return; db.categories.push({id:uid(),name,type:document.getElementById('newCatType').value,parentCategoryId:document.getElementById('newCatParent').value||null,items:[]}); save();renderAll();
  };
}

function showDraggable(it){
  clearMarkers();
  const marker=L.marker([it.lat,it.lng],{draggable:true}).addTo(map).bindPopup(it.name).openPopup();
  markers.push(marker); map.setView([it.lat,it.lng],14);
  marker.on('dragend', e=>{const p=e.target.getLatLng();it.lat=p.lat;it.lng=p.lng;save();});
}

const $cascade=document.getElementById('cascadeBox'); let selected={};
function renderPreview(){
  $cascade.innerHTML=""; clearMarkers();
  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel';
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);
    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.innerHTML=`<option value="">‚Äî</option>${(cat.items||[]).map(it=>`<option value="${it.id}">${it.name}</option>`).join('')}`;
      sel.onchange=()=>{selected[cat.id]=sel.value||null;clearMarkers();const it=(cat.items||[]).find(x=>x.id===sel.value);if(it&&it.lat!=null)addMarker(it.lat,it.lng,it.name);};
      box.appendChild(sel);
    }else{
      const grid=document.createElement('div'); grid.className='checkbox-grid';
      (cat.items||[]).forEach(it=>{const lbl=document.createElement('label');const cb=document.createElement('input');cb.type='checkbox';cb.value=it.id;cb.onchange=()=>{if(cb.checked)addMarker(it.lat,it.lng,it.name);else clearMarkers();};lbl.append(cb,document.createTextNode(it.name));grid.appendChild(lbl);});
      box.appendChild(grid);
    }
    $cascade.appendChild(box);
  });
}

document.getElementById('btnExport').onclick=()=>{const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='dict_v11.json';a.click();};
document.getElementById('fileImport').onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{db=JSON.parse(r.result);save();renderAll();}catch(err){alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');}};r.readAsText(f);};
document.getElementById('btnReset').onclick=()=>{if(confirm('–û—á–∏—Å—Ç–∏—Ç—å?')){localStorage.removeItem(KEY);location.reload();}};
document.querySelectorAll('.tab').forEach(tab=>{tab.onclick=()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');document.getElementById('editorTab').style.display=tab.dataset.tab==='editor'?'block':'none';document.getElementById('previewTab').style.display=tab.dataset.tab==='preview'?'block':'none';}});
function renderAll(){renderEditor();renderPreview();}
renderAll();
</script>
</body>
</html>
