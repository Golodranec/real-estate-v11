<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v15 — цвет+форма+иконка+удаление</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--border:#273248;--text:#d7e2f2}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:440px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:#172133;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
h4{margin:0 0 8px 0}
input,select{width:100%;padding:6px;border-radius:6px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
#map{width:100%;height:100%}
.checkbox-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px}
.checkbox-grid label{display:flex;align-items:center;gap:6px;background:#111a2a;padding:6px 8px;border:1px solid #273248;border-radius:8px;cursor:pointer}
.preview-icon img{width:18px;height:18px;display:inline-block;vertical-align:middle}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v15</span>
  <button id="btnExport">Экспорт</button>
  <label><input type="file" id="fileImport" style="display:none"><button>Импорт</button></label>
  <button id="btnReset" class="danger">Сброс</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">Редактор</div>
  <div class="tab" data-tab="preview">Предпросмотр</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>Предпросмотр каскада</h3>
      <div id="cascadeBox" style="margin-top:8px"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const KEY="dict_v15";
let db=JSON.parse(localStorage.getItem(KEY)||"null");
if(!db){ db={categories:[]}; save(); }
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Math.random().toString(36).slice(2,9); }

/* MAP */
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let markers=[];
function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }

function markerIcon(cat,it){
  if(cat.iconData){
    return L.icon({iconUrl:cat.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  }
  let shape=cat.shape||"circle";
  let color=cat.color||"#3388ff";
  let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html,iconSize:[20,20],iconAnchor:[10,10]});
}

function addMarker(lat,lng,label,cat,it){
  const m=L.marker([lat,lng],{icon:markerIcon(cat,it)}).addTo(map).bindPopup(label);
  markers.push(m);
}

/* EDITOR */
const $editor=document.getElementById('editorTab');
function renderEditor(){
  $editor.innerHTML="";
  db.categories.forEach((cat,ci)=>{
    const sec=document.createElement('div'); sec.className='panel';
    const iconPrev=document.createElement('span'); 
    iconPrev.className='preview-icon'; 
    iconPrev.innerHTML=cat.iconData?`<img src="${cat.iconData}">`:'icon';
    sec.innerHTML=`
      <h3>${cat.name} (${cat.type})</h3>
      <div class="row">
        <input value="${cat.name}" id="name${ci}" placeholder="Название"/>
        <select id="type${ci}">
          <option value="select"${cat.type==="select"?" selected":""}>Select</option>
          <option value="checkbox"${cat.type==="checkbox"?" selected":""}>Checkbox</option>
        </select>
      </div>
      <div class="row">
        <input type="color" id="color${ci}" value="${cat.color||"#3388ff"}"/>
        <select id="shape${ci}">
          <option value="circle"${cat.shape==="circle"?" selected":""}>Круг</option>
          <option value="square"${cat.shape==="square"?" selected":""}>Квадрат</option>
          <option value="triangle"${cat.shape==="triangle"?" selected":""}>Треугольник</option>
        </select>
      </div>
      <div class="row" id="iconRow${ci}"></div>
      <div class="row">
        <button id="save${ci}">Сохранить</button>
      </div>
    `;
    $editor.appendChild(sec);
    const row=document.getElementById(`iconRow${ci}`);
    const iconInput=document.createElement('input'); 
    iconInput.type='file'; iconInput.accept='image/png,image/svg+xml';
    const btnClearIcon=document.createElement('button'); btnClearIcon.textContent='Убрать иконку';
    row.append(iconPrev,iconInput,btnClearIcon);
    document.getElementById(`save${ci}`).onclick=()=>{
      cat.name=document.getElementById(`name${ci}`).value;
      cat.type=document.getElementById(`type${ci}`).value;
      cat.color=document.getElementById(`color${ci}`).value;
      cat.shape=document.getElementById(`shape${ci}`).value;
      save(); renderAll();
    };
    iconInput.onchange=e=>{
      const f=e.target.files[0]; if(!f)return;
      const r=new FileReader();
      r.onload=ev=>{
        cat.iconData=ev.target.result; 
        iconPrev.innerHTML=`<img src="${cat.iconData}">`; 
        save();
      };
      r.readAsDataURL(f);
    };
    btnClearIcon.onclick=()=>{
      delete cat.iconData;
      iconPrev.textContent='icon';
      save();
    };
  });
  const add=document.createElement('div'); add.className='panel';
  add.innerHTML=`<h3>Новая категория</h3>
    <div class="row">
      <input id="newName" placeholder="Название"/>
      <select id="newType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <input type="color" id="newColor" value="#3388ff"/>
      <select id="newShape"><option value="circle">Круг</option><option value="square">Квадрат</option><option value="triangle">Треугольник</option></select>
      <input type="file" id="newIcon" accept="image/png,image/svg+xml"/>
      <button id="btnAdd">+ Добавить</button>
    </div>`;
  $editor.appendChild(add);
  document.getElementById('btnAdd').onclick=()=>{
    const nm=document.getElementById('newName').value.trim()||"Новая";
    const tp=document.getElementById('newType').value;
    const col=document.getElementById('newColor').value;
    const sh=document.getElementById('newShape').value;
    let newCat={id:uid(),name:nm,type:tp,color:col,shape:sh,items:[]};
    const file=document.getElementById('newIcon').files[0];
    if(file){
      const r=new FileReader();
      r.onload=ev=>{newCat.iconData=ev.target.result; db.categories.push(newCat); save(); renderAll();};
      r.readAsDataURL(file);
    }else{ db.categories.push(newCat); save(); renderAll(); }
  };
}

/* PREVIEW */
const $cascade=document.getElementById('cascadeBox');
let selected={};
function renderPreview(){
  $cascade.innerHTML=""; clearMarkers();
  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel';
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);
    if(cat.type==='select'){
      const sel=document.createElement('select');
      sel.innerHTML='<option value="">— выберите —</option>'+ (cat.items||[]).map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      sel.value=selected[cat.id]||"";
      sel.onchange=()=>{
        selected[cat.id]=sel.value||null; clearMarkers();
        const it=(cat.items||[]).find(x=>x.id===sel.value);
        if(it && it.lat && it.lng){ addMarker(it.lat,it.lng,it.name,cat,it); map.setView([it.lat,it.lng],13); }
      };
      box.appendChild(sel);
    }else{
      const grid=document.createElement('div'); grid.className='checkbox-grid';
      const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();
      (cat.items||[]).forEach(it=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; cb.checked=set.has(it.id);
        cb.onchange=()=>{
          if(cb.checked) set.add(it.id); else set.delete(it.id);
          selected[cat.id]=set; clearMarkers();
          for(const id of set){
            const itm=cat.items.find(x=>x.id===id);
            if(itm && itm.lat && itm.lng) addMarker(itm.lat,itm.lng,itm.name,cat,itm);
          }
        };
        lbl.append(cb,document.createTextNode(it.name)); grid.appendChild(lbl);
      });
      box.appendChild(grid);
    }
    $cascade.appendChild(box);
  });
}

/* EXPORT/IMPORT/RESET */
document.getElementById('btnExport').onclick=()=>{const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='dict_v15.json';a.click();};
document.getElementById('fileImport').onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{db=JSON.parse(r.result);save();selected={};renderAll();}catch(err){alert('Ошибка импорта');}};r.readAsText(f);};
document.getElementById('btnReset').onclick=()=>{localStorage.removeItem(KEY);location.reload();};
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

/* INIT */
function renderAll(){ renderEditor(); renderPreview(); }
renderAll();
</script>
</body>
</html>
