<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v28 ‚Äî feature pack</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:480px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
h4{margin:0 0 8px 0}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:#111a2a}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px}
.drag-handle{cursor:grab;opacity:.8}
.dragging{opacity:.5;outline:1px dashed var(--accent)}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
.note{background:#0e1524;border:1px dashed #32405a;padding:8px;border-radius:8px;color:#9fb0c8}
.note.gray{opacity:.7}
#map{width:100%;height:100%}
.preview-icon{width:20px;height:20px;border-radius:4px;border:1px solid #31405a;background:#0f1624;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview-icon img{max-width:100%;max-height:100%;display:block}

/* —á–µ–∫–±–æ–∫—Å-—Å–µ–ª–µ–∫—Ç */
.multi-select{position:relative;width:100%}
.multi-select-btn{width:100%;padding:6px 8px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.multi-select-menu{position:absolute;top:100%;left:0;right:0;background:var(--panel2);border:1px solid var(--border);border-radius:12px;z-index:1000;max-height:300px;overflow:auto;display:none;padding:0;text-align:left}
.multi-select.open .multi-select-menu{display:block}
.ms-actions{position:sticky;top:0;background:#0f1624;border-bottom:1px solid var(--border);padding:8px;display:flex;gap:8px;align-items:center}
.ms-actions input[type="text"]{flex:1;min-width:120px;padding:6px 8px}
.ms-actions .mini{padding:4px 8px;font-size:12px}
.multi-select-menu label{display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer}
.multi-select-menu label:hover{background:#1f293d}

/* –∫–∞—Å—Ç–æ–º–Ω–∞—è –≥–∞–ª–∫–∞ */
.multi-select-menu input[type="checkbox"]{
  appearance:none;-webkit-appearance:none;width:16px;height:16px;border:2px solid var(--accent);border-radius:4px;background:#1a2234;cursor:pointer;position:relative;flex:0 0 16px
}
.multi-select-menu input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
.multi-select-menu input[type="checkbox"]:checked::after{content:"‚úî";position:absolute;top:-2px;left:2px;font-size:14px;color:#fff}

/* –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ */
.select-toolbar{display:flex;gap:8px;margin-top:8px}
.select-toolbar button{padding:4px 8px;font-size:12px}
.hidden{display:none}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v28</span>
  <button id="btnExportJSON">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
  <button id="btnExportCSV">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
  <button id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Å–∫–∞–¥–∞</h3>
      <div class="help">–ü–æ–∏—Å–∫, –≤—ã–±—Ä–∞—Ç—å/–æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë, –º–∞—Å—Å–æ–≤–∞—è –º–µ—Ç–∫–∞/–ø–æ–ª–∏–≥–æ–Ω, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è.</div>
      <div id="cascadeBox" style="margin-top:8px"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* ================= STORAGE ================= */
const KEY="dict_v14";
let db = loadDB();

function loadDB(){
  const v14 = localStorage.getItem(KEY);
  if(v14){ try{ const obj=JSON.parse(v14); normalize(obj); return obj; }catch(e){} }
  const fresh={categories:[]}; save(fresh); return fresh;
}
function save(obj=db){ localStorage.setItem(KEY, JSON.stringify(obj)); }
function uid(){ return Math.random().toString(36).slice(2,9); }
function normalize(obj){
  if(!obj || typeof obj!=="object") obj={categories:[]};
  obj.categories = Array.isArray(obj.categories)? obj.categories : [];
  obj.categories.forEach(c=>{
    if(!("type" in c)) c.type="select";
    if(!("items" in c)) c.items=[];
    if(!("color" in c)) c.color="#3388ff";
    if(!("shape" in c)) c.shape="circle";
    c.items.forEach(it=>{
      if(!("id" in it)) it.id=uid();
      if(!("name" in it)) it.name="–ë–µ–∑ –∏–º–µ–Ω–∏";
      if(!("lat" in it)) it.lat=null;
      if(!("lng" in it)) it.lng=null;
      if(!("parentId" in it)) it.parentId=null;
      if(!("poly" in it)) it.poly=null; // –º–∞—Å—Å–∏–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ–ª–∏–≥–æ–Ω–∞
    });
  });
}
/* ================= MAP / CLUSTER / DRAW ================= */
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let cluster = L.markerClusterGroup();
map.addLayer(cluster);

let drawLayer = L.featureGroup().addTo(map);
let drawControl = new L.Control.Draw({
  edit: { featureGroup: drawLayer, edit:false, remove:false },
  draw: { polygon:true, polyline:false, rectangle:false, circle:false, marker:false, circlemarker:false }
});
/* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å draw; –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ */
let drawEnabled = false;

let markers=[];
function clearMarkers(){ cluster.clearLayers(); markers=[]; drawLayer.clearLayers(); }

function markerIcon(cat){
  if(cat.iconData){ return L.icon({iconUrl:cat.iconData,iconSize:[24,24],iconAnchor:[12,12]}); }
  const shape=cat.shape||"circle"; const color=cat.color||"#3388ff";
  let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html,iconSize:[20,20],iconAnchor:[10,10]});
}
function addMarkerForItem(it,cat){
  if(it.lat!=null && it.lng!=null){
    const m=L.marker([it.lat,it.lng],{icon:markerIcon(cat)})
      .bindPopup(`<b>${it.name}</b><br/><button onclick="removeMarkerById('${it.id}')">üóë –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É</button>`);
    cluster.addLayer(m); markers.push(m);
  }
  if(it.poly && Array.isArray(it.poly) && it.poly.length){
    const poly=L.polygon(it.poly,{color:cat.color||'#3388ff'});
    drawLayer.addLayer(poly);
  }
}
window.removeMarkerById=function(id){
  for(const c of db.categories){
    const it=(c.items||[]).find(x=>x.id===id);
    if(it){ it.lat=null; it.lng=null; it.poly=null; break; }
  }
  save(); clearMarkers(); renderPreview();
}
function showDraggable(it,cat){
  clearMarkers();
  const mk=L.marker([it.lat,it.lng],{draggable:true,icon:markerIcon(cat)})
    .addTo(map).bindPopup(`<b>${it.name}</b><br/><button onclick="removeMarkerById('${it.id}')">üóë –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É</button>`).openPopup();
  markers.push(mk); map.setView([it.lat,it.lng],14);
  mk.on('dragend', e=>{const p=e.target.getLatLng(); it.lat=p.lat; it.lng=p.lng; it.poly=null; save();});
}

/* ================= DND ================= */
let dnd={type:null,catIndex:null,itemIndex:null};
function dndStart(e,type,catIndex,itemIndex=null){ dnd={type,catIndex,itemIndex}; e.currentTarget.classList.add('dragging'); e.dataTransfer.effectAllowed="move"; }
function dndEnd(e){ e.currentTarget.classList.remove('dragging'); dnd={type:null,catIndex:null,itemIndex:null}; }
function dndOver(e){ e.preventDefault(); e.dataTransfer.dropEffect="move"; }
function dndDropCategory(e,targetIndex){
  e.preventDefault(); if(dnd.type!=="cat"||dnd.catIndex===targetIndex) return;
  const arr=db.categories; const elem=arr.splice(dnd.catIndex,1)[0];
  arr.splice(targetIndex,0,elem); save(); renderAll();
}
function dndDropItem(e,catIndex,targetItemIndex){
  e.preventDefault(); if(dnd.type!=="item"||dnd.catIndex!==catIndex||dnd.itemIndex===targetItemIndex) return;
  const arr=db.categories[catIndex].items||[]; const elem=arr.splice(dnd.itemIndex,1)[0];
  arr.splice(targetItemIndex,0,elem); save(); renderAll();
}

/* ================= MASS ASSIGN / DRAW EVENTS ================= */
let massAssign = {active:false, catId:null};  // –º–∞—Å—Å–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—á–∫–∏ –ø–æ –∫–ª–∏–∫—É
let massPoly   = {active:false, catId:null};  // —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö

map.on('click', e=>{
  if(!massAssign.active) return;
  const {catId} = massAssign;
  const set = selected[catId] instanceof Set ? selected[catId] : new Set();
  const cat = db.categories.find(c=>c.id===catId);
  for(const id of set){
    const it=(cat.items||[]).find(x=>x.id===id);
    if(it){ it.lat=e.latlng.lat; it.lng=e.latlng.lng; it.poly=null; }
  }
  massAssign={active:false,catId:null};
  save(); renderPreview();
});

/* Leaflet.draw: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–∏–≥–æ–Ω –≤ item.poly –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö */
map.on(L.Draw.Event.CREATED, function (ev) {
  if(!massPoly.active) return;
  const layer = ev.layer;
  drawLayer.addLayer(layer);
  const latlngs = layer.getLatLngs()[0].map(p=>[p.lat,p.lng]);
  const {catId} = massPoly;
  const set = selected[catId] instanceof Set ? selected[catId] : new Set();
  const cat = db.categories.find(c=>c.id===catId);
  for(const id of set){
    const it=(cat.items||[]).find(x=>x.id===id);
    if(it){ it.poly=latlngs; /* —Ç–æ—á–∫—É –Ω–µ —Ç—Ä–æ–≥–∞–µ–º */ }
  }
  massPoly={active:false,catId:null};
  map.removeControl(drawControl); drawEnabled=false;
  save(); renderPreview();
});
/* ================= EDITOR ================= */
const $editor=document.getElementById('editorTab');
function renderEditor(){
  $editor.innerHTML="";

  const create=document.createElement('div'); create.className='panel';
  create.innerHTML=`
    <h3>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
    <div class="row">
      <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–°—Ç—Ä–∞–Ω—ã, –ì–æ—Ä–æ–¥–∞, –†–∞–π–æ–Ω—ã, –ú–µ—Ç—Ä–æ...)"/>
      <select id="newCatType">
        <option value="select">Select (–æ–¥–∏–Ω)</option>
        <option value="checkbox">Checkbox (–Ω–µ—Å–∫–æ–ª—å–∫–æ)</option>
      </select>
      <select id="newCatParent">
        <option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
        ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
    </div>
    <div class="row">
      <span class="preview-icon" id="newIconPreview">icon</span>
      <input type="color" id="newCatColor" value="#3388ff"/>
      <select id="newCatShape">
        <option value="circle">–ö—Ä—É–≥</option>
        <option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option>
        <option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option>
      </select>
      <input type="file" id="newCatIcon" accept="image/png,image/svg+xml"/>
      <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div class="help">–ß—Ç–æ–±—ã –∫–∞—Å–∫–∞–¥ —Ä–∞–±–æ—Ç–∞–ª, —É–∫–∞–∂–∏ —Ä–æ–¥–∏—Ç–µ–ª—è —É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</div>
  `;
  $editor.appendChild(create);

  const newIconInput=create.querySelector('#newCatIcon');
  const newIconPreview=create.querySelector('#newIconPreview');
  let newIconData=null;
  newIconInput.onchange=e=>{
    const f=e.target.files[0]; if(!f){ newIconData=null; newIconPreview.textContent='icon'; return; }
    const r=new FileReader(); r.onload=ev=>{ newIconData=ev.target.result; newIconPreview.innerHTML=`<img src="${newIconData}">`; }; r.readAsDataURL(f);
  };
  create.querySelector('#btnAddCat').onclick=()=>{
    const name=document.getElementById('newCatName').value.trim(); if(!name) return;
    const type=document.getElementById('newCatType').value;
    const parent=document.getElementById('newCatParent').value||null;
    const color=document.getElementById('newCatColor').value;
    const shape=document.getElementById('newCatShape').value;
    const cat={id:uid(), name, type, parentCategoryId:parent, color, shape, items:[]};
    if(newIconData) cat.iconData=newIconData;
    db.categories.push(cat); save(); renderAll();
  };

  db.categories.forEach((cat,ci)=>{
    const sec=document.createElement('div'); sec.className='panel'; sec.draggable=true;
    sec.addEventListener('dragstart', e=>dndStart(e,'cat',ci));
    sec.addEventListener('dragend', dndEnd);
    sec.addEventListener('dragover', dndOver);
    sec.addEventListener('drop', e=>dndDropCategory(e,ci));

    const header=document.createElement('div'); header.className='row';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    const handle=document.createElement('span'); handle.textContent='‚Üï'; handle.className='drag-handle';
    header.append(title,handle); sec.appendChild(header);

    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name;
    const selType=document.createElement('select'); ['select','checkbox'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(cat.type===t)o.selected=true;selType.appendChild(o);});
    const selParent=document.createElement('select');
    selParent.innerHTML=`<option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>${db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join('')}`;
    const col=document.createElement('input'); col.type='color'; col.value=cat.color||'#3388ff';
    const shape=document.createElement('select'); ['circle','square','triangle'].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if((cat.shape||'circle')===s) o.selected=true; shape.appendChild(o);});
    const iconInput=document.createElement('input'); iconInput.type='file'; iconInput.accept='image/png,image/svg+xml';
    const iconPrev=document.createElement('span'); iconPrev.className='preview-icon'; iconPrev.innerHTML=cat.iconData?`<img src="${cat.iconData}">`:'icon';
    const btnClearIcon=document.createElement('button'); btnClearIcon.textContent='‚úñ –∏–∫–æ–Ω–∫–∞';
    const btnSave=document.createElement('button'); btnSave.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const btnDel=document.createElement('button'); btnDel.textContent='–£–¥–∞–ª–∏—Ç—å'; btnDel.className='danger';

    iconInput.onchange=e=>{
      const f=e.target.files[0];
      if(!f){ delete cat.iconData; iconPrev.textContent='icon'; save(); return; }
      const r=new FileReader(); r.onload=ev=>{ cat.iconData=ev.target.result; iconPrev.innerHTML=`<img src="${cat.iconData}">`; save(); }; r.readAsDataURL(f);
    };
    btnClearIcon.onclick=()=>{ delete cat.iconData; iconPrev.textContent='icon'; save(); };

    btnSave.onclick=()=>{
      cat.name=inpName.value.trim()||cat.name;
      cat.type=selType.value;
      cat.parentCategoryId=selParent.value||null;
      cat.color=col.value;
      cat.shape=shape.value;
      save(); renderAll();
    };
    btnDel.onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –µ—ë —ç–ª–µ–º–µ–Ω—Ç—ã?')){ db.categories.splice(ci,1); save(); renderAll(); } };

    cfg.append(inpName,selType,selParent,col,shape,iconInput,iconPrev,btnClearIcon,btnSave,btnDel);
    sec.appendChild(cfg);
    sec.appendChild(document.createElement('div')).className='sep';

    const list=document.createElement('div'); list.className='list';
    (cat.items||[]).forEach((it,ii)=>{
      const line=document.createElement('div'); line.className='item'; line.draggable=true;
      line.addEventListener('dragstart', e=>dndStart(e,'item',ci,ii));
      line.addEventListener('dragend', dndEnd);
      line.addEventListener('dragover', dndOver);
      line.addEventListener('drop', e=>dndDropItem(e,ci,ii));

      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'‚Äî'} lng:${it.lng??'‚Äî'} ${it.poly?' ‚Ä¢ poly':''}`;
      left.append(nm,meta);

      const tools=document.createElement('div'); tools.className='tools';
      const edit=document.createElement('button'); edit.textContent='‚úé';
      edit.onclick=()=>{ const nn=prompt('–ù–æ–≤–æ–µ –∏–º—è',it.name); if(nn){ it.name=nn.trim(); save(); renderAll(); } };
      const place=document.createElement('button'); place.textContent='üìç';
      place.onclick=()=>{ alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è: '+it.name); map.once('click', e=>{ it.lat=e.latlng.lat; it.lng=e.latlng.lng; it.poly=null; save(); showDraggable(it,cat); }); };
      const clearBtn=document.createElement('button'); clearBtn.textContent='üóë –º–µ—Ç–∫–∞';
      clearBtn.onclick=()=>{ it.lat=null; it.lng=null; it.poly=null; save(); clearMarkers(); renderAll(); };
      const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger';
      del.onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å "'+it.name+'"?')){ cat.items.splice(ii,1); save(); renderAll(); } };

      line.onclick=()=>{ if(it.lat!=null&&it.lng!=null) showDraggable(it,cat); };
      tools.append(edit,place,clearBtn,del);
      line.append(left,tools); list.appendChild(line);
    });
    sec.appendChild(list);

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º —Ä–æ–¥–∏—Ç–µ–ª—è (–∫–∞–∫ –≤ v27)
    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
    const parentPicker=document.createElement('select');
    if(cat.parentCategoryId){
      const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
      parentPicker.innerHTML=`<option value="">(–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+(parentCat?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    } else {
      parentPicker.innerHTML=`<option value="">(—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω)</option>`;
    }
    const addBtn=document.createElement('button'); addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å';
    addBtn.onclick=()=>{
      const nm=inp.value.trim()||'–ù–æ–≤—ã–π';
      cat.items=cat.items||[];
      cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:parentPicker.value||null,poly:null});
      inp.value=''; save(); renderAll();
    };
    addRow.append(inp,parentPicker,addBtn); sec.appendChild(addRow);

    $editor.appendChild(sec);
  });
}
/* ================= PREVIEW (CASCADE) ================= */
const $cascade=document.getElementById('cascadeBox');
let selected={}; // categoryId -> string | Set<string>

function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId);
  const v=selected[catId];
  if(!v) return [];
  return (cat && cat.type==='checkbox') ? Array.from(v) : (v?[v]:[]);
}
function dropChildrenSelections(parentCatId){
  const children=db.categories.filter(c=>c.parentCategoryId===parentCatId);
  for(const ch of children){ delete selected[ch.id]; dropChildrenSelections(ch.id); }
}

function renderPreview(){
  $cascade.innerHTML="";
  clearMarkers();

  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel';
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);

    // –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–æ–¥–∏—Ç–µ–ª—å?
    let parentIds=null;
    if(cat.parentCategoryId){
      const parentSelected=getSelectedIds(cat.parentCategoryId);
      if(parentSelected.length===0){
        const note=document.createElement('div'); note.className='note';
        note.textContent='–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏: '+(db.categories.find(c=>c.id===cat.parentCategoryId)?.name || '—Ä–æ–¥–∏—Ç–µ–ª—è');
        box.appendChild(note); $cascade.appendChild(box); return;
      }
      parentIds=parentSelected;
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ —Ä–æ–¥–∏—Ç–µ–ª—é
    let items=(cat.items||[]);
    if(parentIds){ items=items.filter(it=> it.parentId && parentIds.includes(it.parentId)); }

    // –ü—É—Å—Ç–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Üí —Å–µ—Ä—ã–π –±–ª–æ–∫
    if(items.length===0){
      const note=document.createElement('div'); note.className='note gray';
      note.textContent='–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤';
      box.appendChild(note); $cascade.appendChild(box); return;
    }

    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.style.width='100%';
      sel.innerHTML=`<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>`+items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      if(typeof selected[cat.id]==='string') sel.value=selected[cat.id]||"";
      sel.onchange=()=>{ selected[cat.id]=sel.value||null; dropChildrenSelections(cat.id); renderPreview(); };
      box.appendChild(sel);
    }else{
      const multi=document.createElement('div'); multi.className='multi-select';
      const btn=document.createElement('div'); btn.className='multi-select-btn'; btn.textContent='–í—ã–±—Ä–∞—Ç—å...';
      const menu=document.createElement('div'); menu.className='multi-select-menu';
      const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();

      function updateBtnText(){
        if(set.size===0){ btn.textContent='–í—ã–±—Ä–∞—Ç—å...'; return; }
        const names=items.filter(x=>set.has(x.id)).map(x=>x.name);
        btn.textContent = names.length <= 5 ? names.join(', ') : `–í—ã–±—Ä–∞–Ω–æ: ${names.length}`;
      }
      updateBtnText();

      // ACTIONS: –ø–æ–∏—Å–∫ + –≤—ã–±—Ä–∞—Ç—å –≤—Å—ë / –æ—á–∏—Å—Ç–∏—Ç—å + –º–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
      const actions=document.createElement('div'); actions.className='ms-actions';
      const search=document.createElement('input'); search.type='text'; search.placeholder='–ü–æ–∏—Å–∫...';
      const btnAll=document.createElement('button'); btnAll.className='mini'; btnAll.textContent='–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
      const btnNone=document.createElement('button'); btnNone.className='mini'; btnNone.textContent='–û—á–∏—Å—Ç–∏—Ç—å';
      const btnMassPoint=document.createElement('button'); btnMassPoint.className='mini'; btnMassPoint.textContent='üìç –≤—ã–±—Ä–∞–Ω–Ω—ã–º';
      const btnMassPoly=document.createElement('button'); btnMassPoly.className='mini'; btnMassPoly.textContent='üü¶ –ø–æ–ª–∏–≥–æ–Ω';

      function renderList(){
        menu.querySelectorAll('label').forEach(l=>l.remove());
        const term=(search.value||'').toLowerCase();
        const show = term ? items.filter(it=>it.name.toLowerCase().includes(term)) : items;
        show.forEach(it=>{
          const lbl=document.createElement('label');
          const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; cb.checked=set.has(it.id);
          cb.onchange=()=>{ if(cb.checked) set.add(it.id); else set.delete(it.id); selected[cat.id]=set; dropChildrenSelections(cat.id); updateBtnText(); redrawAllMarkers(); };
          lbl.append(cb,document.createTextNode(it.name));
          menu.appendChild(lbl);
        });
      }
      function redrawAllMarkers(){
        clearMarkers();
        for(const c of db.categories){
          const ids=getSelectedIds(c.id);
          for(const id of ids){
            const it=(c.items||[]).find(x=>x.id===id);
            if(it) addMarkerForItem(it,c);
          }
        }
      }

      btnAll.onclick=()=>{ items.forEach(it=>set.add(it.id)); selected[cat.id]=set; updateBtnText(); renderList(); redrawAllMarkers(); };
      btnNone.onclick=()=>{ set.clear(); selected[cat.id]=set; updateBtnText(); renderList(); redrawAllMarkers(); };
      btnMassPoint.onclick=()=>{ multi.classList.remove('open'); massAssign={active:true,catId:cat.id}; alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∫–æ –≤—Å–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'); };
      btnMassPoly.onclick=()=>{
        multi.classList.remove('open');
        massPoly={active:true,catId:cat.id};
        if(!drawEnabled){ map.addControl(drawControl); drawEnabled=true; }
        new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
      };

      actions.append(search,btnAll,btnNone,btnMassPoint,btnMassPoly);
      menu.appendChild(actions);
      search.oninput=renderList;
      renderList();

      btn.onclick=()=>{ multi.classList.toggle('open'); };
      multi.append(btn,menu); box.appendChild(multi);
    }

    $cascade.appendChild(box);
  });

  // —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö –æ—Ç–º–µ—Ç–æ–∫ –∏ –ø–æ–ª–∏–≥–æ–Ω–æ–≤
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    for(const id of ids){
      const it=(cat.items||[]).find(x=>x.id===id);
      if(it) addMarkerForItem(it,cat);
    }
  }
}

/* ================= EXPORT / IMPORT / RESET / TABS ================= */
document.getElementById('btnExportJSON').onclick=()=>{
  normalize(db);
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_v28.json'; a.click();
};
document.getElementById('btnExportCSV').onclick=()=>{
  // –ø—Ä–æ—Å—Ç–∞—è –≤—ã–≥—Ä—É–∑–∫–∞: category, item, lat, lng, poly(WKT)
  const lines=['category,item,lat,lng,poly'];
  for(const c of db.categories){
    for(const it of (c.items||[])){
      const poly = it.poly && it.poly.length ? `"POLYGON((${it.poly.map(p=>p[1]+' '+p[0]).join(', ')}))"` : '';
      lines.push([JSON.stringify(c.name), JSON.stringify(it.name), it.lat??'', it.lng??'', poly].join(','));
    }
  }
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_v28.csv'; a.click();
};

document.getElementById('btnImport').onclick=()=> document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      let obj=JSON.parse(r.result);
      if(Array.isArray(obj.categories)){} else if(obj&&obj.db&&Array.isArray(obj.db.categories)){ obj=obj.db; }
      else{ throw new Error('–í —Ñ–∞–π–ª–µ –Ω–µ—Ç categories'); }
      normalize(obj);
      // –¥–µ—Ç–µ–∫—Ç–æ—Ä –¥—É–±–ª–µ–π –ø–æ id
      const oldIds=new Set(db.categories.flatMap(c=>c.items.map(i=>i.id)));
      let dups=0;
      obj.categories.forEach(nc=>{
        let c=db.categories.find(x=>x.id===nc.id);
        if(!c){ db.categories.push(nc); return; }
        // —Å–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ id
        c.items=c.items||[]; nc.items=nc.items||[];
        nc.items.forEach(it=>{ if(oldIds.has(it.id)){ dups++; } else { c.items.push(it); oldIds.add(it.id);} });
      });
      db=obj; save(db); selected={}; renderAll();
      alert(dups?`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ, –¥—É–±–ª–µ–π: ${dups}`:'–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
  };
  r.readAsText(f);
};

document.getElementById('btnReset').onclick=()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){ localStorage.removeItem(KEY); location.reload(); } };
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

/* ================= INIT ================= */
function renderAll(){ renderEditor(); renderPreview(); }
renderAll();
</script>
</body>
</html>
