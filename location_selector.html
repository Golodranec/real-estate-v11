<script>
/***** POLY LIST (—Ñ–∏–∫—Å —Å–∫—Ä–æ–ª–ª–∞ + —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ) *****/
function renderPolyList(){
  if(!$polyList) return;
  const q=($polySearch?.value||"").trim().toLowerCase();

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –î–û –æ—á–∏—Å—Ç–∫–∏
  const scrollTop = $polyList.scrollTop;

  $polyList.innerHTML='';
  const checks=Promise.all(db.polygons.map(async p=>{
    const h=await getHist(p.id);
    return {id:p.id, undo:!!(h&&h.index>0), redo:!!(h&&h.index<h.stack.length-1)};
  }));
  checks.then(states=>{
    const byId=new Map(states.map(x=>[x.id,x]));
    db.polygons
      .filter(p=>!q || (p.name||'').toLowerCase().includes(q))
      .forEach(p=>{
        const st=byId.get(p.id)||{undo:false,redo:false};

        const row=document.createElement('div'); row.className='item'; row.dataset.id=p.id;
        if(p.id===polyEditingTargetId) row.classList.add('active');

        // HEADER
        const header=document.createElement('div'); header.className='item-header';
        const left=document.createElement('div'); left.className='left';
        const name=document.createElement('span'); name.className='name'; name.textContent=p.name||'–ü–æ–ª–∏–≥–æ–Ω';
        const idSpan=document.createElement('span'); idSpan.className='id'; idSpan.textContent=`id: ${p.id}`;
        left.append(name,idSpan);

        const btns=document.createElement('div'); btns.className='btns';
        const collapseBtn=document.createElement('button'); collapseBtn.textContent=collapsedPolygons[p.id]?'‚ñ∂':'‚ñº';
        collapseBtn.title='–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
        collapseBtn.onclick=(ev)=>{ ev.stopPropagation(); toggleCollapse(p.id); };
        const focusHdr=document.createElement('button'); focusHdr.textContent='–§–æ–∫—É—Å';
        focusHdr.onclick=(ev)=>{ ev.stopPropagation(); const l=polyIndex.get(p.id); if(l){ l.addTo(map); map.fitBounds(l.getBounds()); } };
        btns.append(collapseBtn,focusHdr);

        header.append(left,btns);
        header.onclick=()=>toggleCollapse(p.id);
        row.appendChild(header);

        // BODY
        const body=document.createElement('div'); body.className='item-body';
        if(!collapsedPolygons[p.id]) body.classList.add('open');

        // editable name
        const nameRow=document.createElement('div'); nameRow.className='row';
        const nameInput=document.createElement('input'); nameInput.value=p.name||'–ü–æ–ª–∏–≥–æ–Ω';
        nameInput.onchange=async()=>{p.name=nameInput.value.trim()||p.name; await save(db); renderPolyList(); updatePolygonVisibility();};
        nameRow.appendChild(nameInput);
        body.appendChild(nameRow);

        // tools
        const tools=document.createElement('div'); tools.className='tools';
        // color picker
        const color=document.createElement('input'); color.type='color'; color.value=p.color||'#ff4d4f';
        color.onchange=async()=>{p.color=color.value;const l=polyIndex.get(p.id);if(l&&l.setStyle) l.setStyle({color:p.color});await save(db);};
        // visible toggle
        const toggle=document.createElement('button'); toggle.textContent=p.visible!==false?'–°–∫—Ä—ã—Ç—å':'–ü–æ–∫–∞–∑–∞—Ç—å';
        toggle.onclick=async()=>{p.visible=!(p.visible!==false); const l=polyIndex.get(p.id); if(l){ if(p.visible) l.addTo(map); else map.removeLayer(l);} await save(db); renderPolyList(); updatePolygonVisibility();};
        // focus
        const focus=document.createElement('button'); focus.textContent='–§–æ–∫—É—Å'; focus.onclick=()=>{const l=polyIndex.get(p.id);if(l){ l.addTo(map); map.fitBounds(l.getBounds()); }};
        // undo/redo
        const undoBtn=document.createElement('button'); undoBtn.textContent='‚Ü∂ Undo'; if(!st.undo) undoBtn.disabled=true;
        undoBtn.onclick=()=>undoPolygon(p.id);
        const redoBtn=document.createElement('button'); redoBtn.textContent='‚Ü∑ Redo'; if(!st.redo) redoBtn.disabled=true;
        redoBtn.onclick=()=>redoPolygon(p.id);
        // edit
        const editBtn=document.createElement('button'); editBtn.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        editBtn.onclick=async()=>{
          const l=polyIndex.get(p.id);
          if(l){
            l.addTo(map);
            if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); }
            polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
            polyEditToolbar.enable(); polyEditing=true;
            polyFG.eachLayer(x=>{
              if(x===l){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
              else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
            });
            const h=await ensureHistWithCurrent(p);
            if(h.index<0){ await pushHistory(p); }
            setEditingTarget(p.id);
            map.fitBounds(l.getBounds());
          }
        };
        // delete
        const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger';
        del.onclick=async()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω?')) return;
          const l=polyIndex.get(p.id); if(l) polyFG.removeLayer(l); polyIndex.delete(p.id);
          db.polygons=db.polygons.filter(x=>x.id!==p.id);
          await lfGeo.removeItem(p.id); await clearHist(p.id); await save(db);
          if(polyEditingTargetId===p.id){ setEditingTarget(null); }
          renderPolyList(); updatePolygonVisibility();
        };

        tools.append(color,toggle,focus,undoBtn,redoBtn,editBtn,del);
        body.appendChild(tools);

        // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (‚Ä¢) –ø–æ—Å–ª–µ –∏–Ω–ø—É—Ç–∞ –∏–º–µ–Ω–∏
        const hst=byId.get(p.id); if(hst && hst.undo){
          const dot=document.createElement('span'); dot.className='hist-indicator'; dot.textContent='‚Ä¢';
          nameInput.insertAdjacentElement('afterend', dot);
        }

        row.appendChild(body);
        $polyList.appendChild(row);
      });

    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å –º–∞–∫—Ä–æ-–º–∏–∫—Ä–æ —Ç–∏–∫–æ–º –Ω–∞ –≤—Å—è–∫–∏–π
    requestAnimationFrame(()=>{ $polyList.scrollTop = scrollTop; setTimeout(()=>{ $polyList.scrollTop = scrollTop; },0); });
  });
}
$polySearch.oninput=renderPolyList;

/***** VISIBILITY BY SELECTION *****/
function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId);
  const v=selected[catId];
  if(!v) return [];
  return(cat&&cat.type==='checkbox')?Array.from(v):(v?[v]:[]);
}
function getSelectedItemNames(){
  const names=new Set();
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    if(!ids.length) continue;
    (cat.items||[]).forEach(it=>{if(ids.includes(it.id)) names.add(it.name);});
  }
  return names;
}
function updatePolygonVisibility(){
  const names=getSelectedItemNames();
  for(const p of db.polygons){
    const layer=polyIndex.get(p.id); if(!layer) continue;
    const filtered=(p.visible!==false)&&(names.size?names.has(p.name):true);
    const forceVisible=(polyEditingTargetId && p.id===polyEditingTargetId);
    if(filtered||forceVisible) layer.addTo(map); else map.removeLayer(layer);
  }
}

/***** EDITOR (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + —ç–ª–µ–º–µ–Ω—Ç—ã) *****/
const $editor=document.getElementById('editorTab');
function renderEditor(){
  $editor.innerHTML="";

  // –Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
  const create=document.createElement('div'); create.className='panel';
  create.innerHTML=`
    <h3>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
    <div class="row">
      <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
      <select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <select id="newCatParent">
        <option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
        ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
    </div>
    <div class="row">
      <span class="preview-icon" id="newIconPreview">icon</span>
      <input type="color" id="newCatColor" value="#3388ff"/>
      <select id="newCatShape"><option value="circle">–ö—Ä—É–≥</option><option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option><option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option></select>
      <input type="file" id="newCatIcon" accept="image/png,image/svg+xml"/>
      <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>`;
  $editor.appendChild(create);

  const newIconInput=create.querySelector('#newCatIcon');
  const newIconPreview=create.querySelector('#newIconPreview');
  let newIconData=null;
  newIconInput.onchange=e=>{
    const f=e.target.files[0]; if(!f){newIconData=null;newIconPreview.textContent='icon';return;}
    const r=new FileReader(); r.onload=ev=>{newIconData=ev.target.result;newIconPreview.innerHTML=`<img src="${newIconData}">`;}; r.readAsDataURL(f);
  };
  create.querySelector('#btnAddCat').onclick=async()=>{
    const name=document.getElementById('newCatName').value.trim(); if(!name) return;
    const type=document.getElementById('newCatType').value;
    const parent=document.getElementById('newCatParent').value||null;
    const color=document.getElementById('newCatColor').value;
    const shape=document.getElementById('newCatShape').value;
    const cat={id:uid(),name,type,parentCategoryId:parent,color,shape,items:[]};
    if(newIconData){cat.iconData=newIconData;}
    db.categories.push(cat); await save(); renderAll();
  };

  // —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  db.categories.forEach((cat,ci)=>{
    const sec=document.createElement('div'); sec.className='panel';
    const header=document.createElement('div'); header.className='row';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    header.append(title); sec.appendChild(header);

    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name;
    inpName.onchange=()=>{cat.name=inpName.value.trim(); save(); renderAll();};
    const selType=document.createElement('select'); ['select','checkbox'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(cat.type===t)o.selected=true;selType.appendChild(o);});
    selType.onchange=()=>{cat.type=selType.value; save(); renderAll();};
    const selParent=document.createElement('select'); selParent.innerHTML=`<option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join('');
    selParent.onchange=()=>{cat.parentCategoryId=selParent.value||null; save(); renderAll();};
    const col=document.createElement('input'); col.type='color'; col.value=cat.color||'#3388ff'; col.onchange=()=>{cat.color=col.value; save(); renderAll();};
    const shape=document.createElement('select'); ['circle','square','triangle'].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if((cat.shape||'circle')===s)o.selected=true;shape.appendChild(o);});
    shape.onchange=()=>{cat.shape=shape.value; save(); renderAll();};
    const iconPrev=document.createElement('span'); iconPrev.className='preview-icon'; iconPrev.innerHTML=cat.iconData?`<img src="${cat.iconData}">`:'icon';
    const btnClearIcon=document.createElement('button'); btnClearIcon.textContent='‚úñ –∏–∫–æ–Ω–∫–∞';
    btnClearIcon.onclick=()=>{delete cat.iconData; iconPrev.textContent='icon'; save();};

    // –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∫–æ–Ω–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const iconInput=document.createElement('input');
    iconInput.type='file'; iconInput.accept='image/png,image/svg+xml'; iconInput.style.display='none';
    const iconBtn=document.createElement('button'); iconBtn.textContent='üñº'; iconBtn.title='–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∫–æ–Ω–∫—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
    iconBtn.onclick=()=>iconInput.click();
    iconInput.onchange=e=>{
      const f=e.target.files[0];
      if(!f){ delete cat.iconData; iconPrev.textContent='icon'; save(); renderAll(); return; }
      const r=new FileReader();
      r.onload=ev=>{ cat.iconData=ev.target.result; iconPrev.innerHTML=`<img src="${cat.iconData}">`; save(); renderAll(); };
      r.readAsDataURL(f);
    };

    cfg.append(inpName,selType,selParent,col,shape,iconPrev,iconBtn,iconInput,btnClearIcon);
    sec.appendChild(cfg);

    // —ç–ª–µ–º–µ–Ω—Ç—ã
    const list=document.createElement('div'); list.className='list';
    (cat.items||[]).forEach((it,ii)=>{
      const line=document.createElement('div'); line.className='item';
      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'‚Äî'} lng:${it.lng??'‚Äî'}`;
      left.append(nm,meta);

      const tools=document.createElement('div'); tools.className='tools';
      const edit=document.createElement('button'); edit.textContent='‚úé';
      edit.onclick=()=>{const nn=prompt('–ù–æ–≤–æ–µ –∏–º—è',it.name); if(nn!=null){it.name=(nn.trim()||it.name); save(); renderAll();}};
      const place=document.createElement('button'); place.textContent='üìç';
      place.onclick=()=>{
        alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è: '+it.name);
        map.once('click', e=>{
          it.lat=e.latlng.lat; it.lng=e.latlng.lng; save();
          meta.textContent=`lat:${it.lat.toFixed(5)} lng:${it.lng.toFixed(5)}`;
          addMarkerForItem(it,cat);
          map.setView([it.lat,it.lng],14);
        });
      };
      const clearBtn=document.createElement('button'); clearBtn.textContent='üóë –º–µ—Ç–∫–∞';
      clearBtn.onclick=()=>{it.lat=null; it.lng=null; save(); renderAll();};
      const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger';
      del.onclick=()=>{if(confirm('–£–¥–∞–ª–∏—Ç—å "'+it.name+'"?')){cat.items.splice(ii,1); save(); renderAll();}};

      line.onclick=()=>{ if(it.lat!=null&&it.lng!=null){ map.setView([it.lat,it.lng],14); } };
      tools.append(edit,place,clearBtn,del);
      line.append(left,tools); list.appendChild(line);
    });
    sec.appendChild(list);

    // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
    const parentPicker=document.createElement('select');
    if(cat.parentCategoryId){
      const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
      parentPicker.innerHTML=`<option value="">(–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+(parentCat?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }else{
      parentPicker.innerHTML=`<option value="">(—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω)</option>`;
    }
    const addBtn=document.createElement('button'); addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å';
    addBtn.onclick=()=>{ const nm=inp.value.trim()||'–ù–æ–≤—ã–π'; cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:parentPicker.value||null}); inp.value=''; save(); renderAll(); };
    addRow.append(inp,parentPicker,addBtn); sec.appendChild(addRow);

    $editor.appendChild(sec);
  });
}

/***** PREVIEW *****/
const $cascade=document.getElementById('cascadeBox');
let selected={};
let reopenMultiCatId=null;

function dropChildrenSelections(parentCatId){
  const children=db.categories.filter(c=>c.parentCategoryId===parentCatId);
  for(const ch of children){ delete selected[ch.id]; dropChildrenSelections(ch.id); }
}

function renderPreview(){
  $cascade.innerHTML="";
  clearMarkers();

  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel'; box.dataset.catId=cat.id;
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);

    let parentIds=null;
    if(cat.parentCategoryId){
      const parentSelected=getSelectedIds(cat.parentCategoryId);
      if(parentSelected.length===0){
        const note=document.createElement('div'); note.className='note';
        note.textContent='–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏: '+(db.categories.find(c=>c.id===cat.parentCategoryId)?.name||'—Ä–æ–¥–∏—Ç–µ–ª—è');
        box.appendChild(note); $cascade.appendChild(box); return;
      }
      parentIds=parentSelected;
    }

    let items=(cat.items||[]);
    if(parentIds){ items=items.filter(it=>it.parentId && parentIds.includes(it.parentId)); }
    if(items.length===0){
      const note=document.createElement('div'); note.className='note gray'; note.textContent='–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤';
      box.appendChild(note); $cascade.appendChild(box); return;
    }

    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.style.width='100%';
      sel.innerHTML=`<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>`+items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      if(typeof selected[cat.id]==='string') sel.value=selected[cat.id]||"";
      sel.onchange=()=>{ selected[cat.id]=sel.value||null; dropChildrenSelections(cat.id); saveSelected(); renderPreview(); updatePolygonVisibility(); };
      box.appendChild(sel);
    }else{
      const multi=document.createElement('div'); multi.className='multi-select';
      const btn=document.createElement('div'); btn.className='multi-select-btn'; btn.textContent='–í—ã–±—Ä–∞—Ç—å...';
      const menu=document.createElement('div'); menu.className='multi-select-menu';
      const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();

      function updateBtnText(){
        if(set.size===0){ btn.textContent='–í—ã–±—Ä–∞—Ç—å...'; }
        else{
          const names=items.filter(x=>set.has(x.id)).map(x=>x.name);
          btn.textContent = names.length<=5 ? names.join(', ') : `–í—ã–±—Ä–∞–Ω–æ: ${names.length}`;
        }
      }
      updateBtnText();

      items.forEach(it=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; cb.checked=set.has(it.id);
        cb.onchange=()=>{
          if(cb.checked) set.add(it.id); else set.delete(it.id);
          selected[cat.id]=set;
          dropChildrenSelections(cat.id);
          updateBtnText();
          reopenMultiCatId=cat.id;
          saveSelected();
          renderPreview();
          updatePolygonVisibility();
        };
        lbl.append(cb,document.createTextNode(it.name));
        menu.appendChild(lbl);
      });

      btn.onclick=()=>{
        document.querySelectorAll('.multi-select.open').forEach(ms=>{ if(ms!==multi) ms.classList.remove('open'); });
        multi.classList.toggle('open');
      };
      multi.append(btn,menu); box.appendChild(multi);
    }

    $cascade.appendChild(box);
  });

  // –º–µ—Ç–∫–∏
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    for(const id of ids){
      const it=(cat.items||[]).find(x=>x.id===id);
      if(it && it.lat!=null && it.lng!=null) addMarkerForItem(it,cat);
    }
  }

  // –ø–æ–ª–∏–≥–æ–Ω—ã –ø–æ –≤—ã–±–æ—Ä—É
  updatePolygonVisibility();

  if(reopenMultiCatId){
    const panel=$cascade.querySelector(`.panel[data-cat-id="${reopenMultiCatId}"] .multi-select`);
    if(panel) panel.classList.add('open');
    reopenMultiCatId=null;
  }
}

// –∫–ª–∏–∫ –≤–Ω–µ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ ‚Äî –∑–∞–∫—Ä—ã—Ç—å
document.addEventListener('click', e=>{
  document.querySelectorAll('.multi-select.open').forEach(ms=>{
    if(!ms.contains(e.target)) ms.classList.remove('open');
  });
});

/***** SEARCH (—ç–ª–µ–º–µ–Ω—Ç—ã) *****/
const $search=document.getElementById('globalSearch');
const $results=document.getElementById('searchResults');
$search.oninput=()=>{
  const q=$search.value.trim().toLowerCase();
  $results.innerHTML="";
  if(!q) return;

  const out=[];
  db.categories.forEach(cat=>{
    (cat.items||[]).forEach(it=>{
      if(it.name.toLowerCase().includes(q)){
        out.push({cat,it});
      }
    });
  });
  out.forEach(r=>{
    const row=document.createElement('div');
    row.textContent=`${r.it.name} (${r.cat.name})`;
    row.onclick=()=>{
      if(r.cat.type==='select') selected[r.cat.id]=r.it.id;
      else{
        if(!(selected[r.cat.id] instanceof Set)) selected[r.cat.id]=new Set();
        selected[r.cat.id].add(r.it.id);
      }
      saveSelected();
      renderPreview();
      updatePolygonVisibility();
      if(r.it.lat!=null && r.it.lng!=null) map.setView([r.it.lat,r.it.lng],14);
      $search.value=""; $results.innerHTML="";
    };
    $results.appendChild(row);
  });
};

/***** EXPORT/IMPORT/RESET *****/
document.getElementById('btnExport').onclick=async ()=>{
  const full=JSON.parse(JSON.stringify(db));
  for(const cat of full.categories){
    if(cat.iconKey && !cat.iconData){ try{ cat.iconData=await lfIcons.getItem(cat.iconKey)||null; }catch(e){} }
    for(const it of (cat.items||[])){
      if(it.iconKey && !it.iconData){ try{ it.iconData=await lfIcons.getItem(it.iconKey)||null; }catch(e){} }
    }
  }
  for(const p of full.polygons){
    if(!p.geojson){ try{ p.geojson=await lfGeo.getItem(p.id)||null; }catch(e){} }
  }
  const blob=new Blob([JSON.stringify(full,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_full_v38_6_3R.json'; a.click();
};

document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ()=>{
    try{
      let obj=JSON.parse(r.result);
      if(obj && obj.db) obj=obj.db;
      if(!Array.isArray(obj.categories)) throw new Error('–ù–µ—Ç categories');
      if(!Array.isArray(obj.polygons))   obj.polygons=[];

      // –∏–∫–æ–Ω–∫–∏ ‚Üí IndexedDB
      for(const cat of obj.categories){
        if(!cat.id) cat.id=uid();
        if(cat.iconData){
          const key=cat.iconKey||`cat_${cat.id}`;
          await lfIcons.setItem(key,cat.iconData);
          cat.iconKey=key;
        }
        for(const it of (cat.items||[])){
          if(!it.id) it.id=uid();
          if(it.iconData){
            const key=it.iconKey||`item_${it.id}`;
            await lfIcons.setItem(key,it.iconData);
            it.iconKey=key;
          }
        }
      }
      // –ø–æ–ª–∏–≥–æ–Ω—ã ‚Üí IndexedDB + –∏—Å—Ç–æ—Ä–∏—è
      for(const p of obj.polygons){
        if(!p.id) p.id=uid();
        if(p.geojson){ await lfGeo.setItem(p.id,p.geojson); }
        await setHist(p.id,{stack:[p.geojson||null].filter(Boolean),index:(p.geojson?0:-1)});
      }

      // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∞–π—Ç–æ–≤—É—é —á–∞—Å—Ç—å + –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      localStorage.setItem(KEY, JSON.stringify({
        categories:obj.categories.map(c=>({
          id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId,
          color:c.color,shape:c.shape,iconKey:c.iconKey||null,
          items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
        })),
        polygons:obj.polygons.map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
      }));
      db = await loadDB();

      renderAll();
      resumeEditingIfNeeded();
      updatePolygonVisibility();
      alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
  };
  r.readAsText(f);
};

document.getElementById('btnReset').onclick=()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){
    localStorage.removeItem(KEY);
    localStorage.removeItem('selected_v1');
    localStorage.removeItem('polyEditingId');
    localStorage.removeItem('collapsedPolygons');
    lfIcons.clear().then(()=>{}); lfGeo.clear().then(()=>{}); lfHist.clear().then(()=>{});
    location.reload();
  }
};

/***** TABS *****/
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

/***** MAIN RENDER *****/
async function renderAll(){
  rebuildPolys();
  renderEditor();
  renderPreview();
  renderPolyList();

  clearMarkers();
  db.categories.forEach(cat=>{
    (cat.items||[]).forEach(it=>{
      if(it.lat!=null && it.lng!=null) addMarkerForItem(it,cat);
    });
  });
}

/***** RESUME EDIT MODE *****/
function resumeEditingIfNeeded(){
  const id=localStorage.getItem('polyEditingId');
  if(!id) return;
  const layer=polyIndex.get(id);
  if(!layer) return;
  if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); }
  polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
  polyEditToolbar.enable(); polyEditing=true;
  polyFG.eachLayer(x=>{
    if(x===layer){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
    else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
  });
  setEditingTarget(id);
  layer.addTo(map);
  map.fitBounds(layer.getBounds());
}

/***** START *****/
let db=null;
(async()=>{
  db = await loadDB();
  loadSelected();
  await renderAll();
  resumeEditingIfNeeded();
})();
</script>
</body>
</html>
