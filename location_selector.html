<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v37.6 ‚Äî Stable IndexedDB + Polygons Fix</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:460px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3,h4{margin:0 0 8px 0}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:#111a2a}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px;flex-wrap:wrap}
#map{width:100%;height:100%}
.preview-icon{width:22px;height:22px;border-radius:4px;border:1px solid #31405a;background:#0f1624;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview-icon img{max-width:100%;max-height:100%;display:block}
.note{background:#0e1524;border:1px dashed #32405a;padding:8px;border-radius:8px;color:#9fb0c8}
.multi-select{position:relative;width:100%}
.multi-select-btn{width:100%;padding:6px 8px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.multi-select-menu{position:absolute;top:100%;left:0;right:0;background:var(--panel2);border:1px solid var(--border);border-radius:12px;z-index:2000;max-height:260px;overflow:auto;display:none}
.multi-select.open .multi-select-menu{display:block}
.multi-select-menu label{display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer}
.multi-select-menu label:hover{background:#1f293d}
.multi-select-menu input[type="checkbox"]{appearance:none;-webkit-appearance:none;width:16px;height:16px;border:2px solid var(--accent);border-radius:4px;background:#1a2234;cursor:pointer;position:relative;flex:0 0 16px}
.multi-select-menu input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
.multi-select-menu input[type="checkbox"]:checked::after{content:"‚úî";position:absolute;top:-2px;left:2px;font-size:14px;color:#fff}
.poly-item{display:flex;justify-content:space-between;align-items:center;gap:8px;border:1px dashed #31405a;background:#10192a;padding:6px}
.poly-name{font-weight:700}
.poly-meta{font-size:12px;color:#9fb0c8}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v37.6</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <button id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>
<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>
<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>–ü–æ–ª–∏–≥–æ–Ω—ã</h3>
      <div class="row">
        <input id="polyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞)"/>
        <input id="polyColor" type="color" value="#ff4d4f" style="width:56px;height:36px;padding:0"/>
        <button id="btnPolyNew">+ –ü–æ–ª–∏–≥–æ–Ω</button>
        <button id="btnPolyEdit">–†–µ–¥–∞–∫—Ç.</button>
        <button id="btnPolyStop">–°—Ç–æ–ø</button>
      </div>
      <div class="row">
        <button id="btnPolyShowAll">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
        <button id="btnPolyHideAll">–°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
      </div>
      <div id="polyList" class="list"></div>
    </div>
    <div class="panel">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
      <input id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º..."/>
      <div id="searchResults" class="search-results"></div>
      <div id="cascadeBox"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script>
/***** STORAGE: IndexedDB *****/
const DB_NAME="dictionaryDB";
const STORE_NAME="data";
const KEY="dict_v14";
let idb=null; let db=null;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{
      const i=e.target.result;
      if(!i.objectStoreNames.contains(STORE_NAME)) i.createObjectStore(STORE_NAME);
    };
    req.onsuccess=e=>resolve(e.target.result);
    req.onerror=e=>reject(e.target.error);
  });
}
async function initDB(){
  idb=await openDB();
  const tx=idb.transaction(STORE_NAME,"readonly");
  const store=tx.objectStore(STORE_NAME);
  const getReq=store.get(KEY);
  return new Promise((resolve)=>{
    getReq.onsuccess=()=>{
      if(getReq.result){
        try{ db=JSON.parse(getReq.result); normalize(db); }
        catch{ db={categories:[],polygons:[]}; }
      }else{
        db={categories:[],polygons:[]};
      }
      save(); resolve(db);
    };
    getReq.onerror=()=>{ db={categories:[],polygons:[]}; save(); resolve(db); };
  });
}
function save(obj=db){
  if(!idb) return;
  try{
    const tx=idb.transaction(STORE_NAME,"readwrite");
    tx.objectStore(STORE_NAME).put(JSON.stringify(obj),KEY);
  }catch(e){ console.error("IndexedDB save error",e); }
}
function resetDB(){ indexedDB.deleteDatabase(DB_NAME); location.reload(); }
function uid(){ return Math.random().toString(36).slice(2,9); }
function normalize(obj){
  if(!obj||typeof obj!=="object") obj={categories:[],polygons:[]};
  if(!Array.isArray(obj.categories)) obj.categories=[];
  if(!Array.isArray(obj.polygons)) obj.polygons=[];
  obj.categories.forEach(c=>{
    if(!("type" in c)) c.type="select";
    if(!("items" in c)) c.items=[];
    if(!("color" in c)) c.color="#3388ff";
    if(!("shape" in c)) c.shape="circle";
    if(!("parentCategoryId" in c)) c.parentCategoryId=null;
    c.items.forEach(it=>{
      if(!("id" in it)) it.id=uid();
      if(!("name" in it)) it.name="–ë–µ–∑ –∏–º–µ–Ω–∏";
      if(!("lat" in it)) it.lat=null;
      if(!("lng" in it)) it.lng=null;
      if(!("parentId" in it)) it.parentId=null;
    });
  });
}

/***** MAP + CLUSTERS *****/
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let cluster=L.markerClusterGroup();
map.addLayer(cluster);
function clearMarkers(){ cluster.clearLayers(); }
function markerIcon(cat,it=null){
  if(it && it.iconData) return L.icon({iconUrl:it.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  if(cat.iconData) return L.icon({iconUrl:cat.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  const color=cat.color||"#3388ff";
  const shape=cat.shape||"circle";
  let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html,iconSize:[20,20],iconAnchor:[10,10]});
}
function addMarkerForItem(it,cat){
  if(it.lat==null||it.lng==null) return;
  const m=L.marker([it.lat,it.lng],{icon:markerIcon(cat,it)});
  m.bindPopup(`<b>${it.name}</b><br/><button onclick="removeMarkerById('${it.id}')">üóë –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É</button>`);
  cluster.addLayer(m);
}
window.removeMarkerById=function(id){
  for(const c of db.categories){
    const it=(c.items||[]).find(x=>x.id===id);
    if(it){ it.lat=null; it.lng=null; break; }
  }
  save(); renderAll();
};

/***** POLYGONS *****/
const polyFG=new L.FeatureGroup(); map.addLayer(polyFG);
const polyIndex=new Map();

function fmtArea(m2){ return m2<100000?`${m2.toFixed(0)} –º¬≤`:`${(m2/10000).toFixed(2)} –≥–∞`; }
function fmtPerim(m){ return `${m.toFixed(0)} –º`; }
function polygonAreaPerimeter(gj){
  try{ const a=turf.area(gj); const l=turf.polygonToLine(gj); const p=turf.length(l,{units:"kilometers"})*1000; return {a,p}; }
  catch(e){ return {a:0,p:0}; }
}
function layerFromGeo(geo,c){ let l=null; L.geoJSON(geo,{style:{color:c,weight:2,fillOpacity:.12}}).eachLayer(x=>l=x); return l; }
function rebuildPolys(){
  polyIndex.clear(); polyFG.clearLayers();
  for(const p of db.polygons){
    const l=layerFromGeo(p.geojson,p.color||'#ff4d4f'); if(!l) continue;
    polyFG.addLayer(l);
    if(p.visible===false) map.removeLayer(l);
    polyIndex.set(p.id,l);
  }
  renderPolyList();
}
/***** POLYGON UI *****/
const $editor=document.getElementById('editorTab');
function renderPolyList(){
  let wrap=document.getElementById('polyListWrap');
  if(!wrap){ wrap=document.createElement('div'); wrap.id='polyListWrap'; $editor.prepend(wrap); }
  wrap.innerHTML="";
  if(db.polygons.length===0){ wrap.innerHTML='<div class="note gray">–ù–µ—Ç –ø–æ–ª–∏–≥–æ–Ω–æ–≤</div>'; return; }

  const tools=document.createElement('div'); tools.className='row';
  const showAll=document.createElement('button'); showAll.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
  showAll.onclick=()=>{ db.polygons.forEach(p=>p.visible=true); save(); rebuildPolys(); };
  const hideAll=document.createElement('button'); hideAll.textContent='–°–∫—Ä—ã—Ç—å –≤—Å–µ';
  hideAll.onclick=()=>{ db.polygons.forEach(p=>p.visible=false); save(); rebuildPolys(); };
  tools.append(showAll,hideAll); wrap.appendChild(tools);

  db.polygons.forEach(p=>{
    const box=document.createElement('div'); box.className='panel';

    const title=document.createElement('div'); title.textContent=p.name||'(–±–µ–∑ –∏–º–µ–Ω–∏)'; title.style.fontWeight='700';
    box.appendChild(title);

    const meta=document.createElement('div'); meta.className='meta';
    const {a,p:pp}=polygonAreaPerimeter(p.geojson);
    meta.textContent=`–ü–ª–æ—â–∞–¥—å: ${fmtArea(a)} ¬∑ –ü–µ—Ä–∏–º–µ—Ç—Ä: ${fmtPerim(pp)}`;
    box.appendChild(meta);

    const row=document.createElement('div'); row.className='row';

    const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=p.visible!==false;
    chk.onchange=()=>{ p.visible=chk.checked; save(); rebuildPolys(); };
    row.appendChild(chk);

    const focus=document.createElement('button'); focus.textContent='–§–æ–∫—É—Å';
    focus.onclick=()=>{ const l=polyIndex.get(p.id); if(l){ map.fitBounds(l.getBounds()); } };
    row.appendChild(focus);

    const rename=document.createElement('button'); rename.textContent='–ü–µ—Ä–µ–∏–º.';
    rename.onclick=()=>{ const nn=prompt('–ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª–∏–≥–æ–Ω–∞',p.name||''); if(nn){ p.name=nn; save(); renderPolyList(); } };
    row.appendChild(rename);

    const color=document.createElement('input'); color.type='color'; color.value=p.color||'#ff4d4f';
    color.onchange=()=>{ p.color=color.value; const l=polyIndex.get(p.id); if(l) l.setStyle({color:p.color}); save(); };
    row.appendChild(color);

    const del=document.createElement('button'); del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.className='danger';
    del.onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω?')){ db.polygons=db.polygons.filter(x=>x.id!==p.id); save(); rebuildPolys(); } };
    row.appendChild(del);

    box.appendChild(row);
    wrap.appendChild(box);
  });
}

/***** EDITOR *****/
function renderEditor(){
  $editor.innerHTML="";

  // –±–ª–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const create=document.createElement('div'); create.className='panel';
  create.innerHTML=`
    <h3>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
    <div class="row">
      <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–°—Ç—Ä–∞–Ω—ã, –ì–æ—Ä–æ–¥–∞, –†–∞–π–æ–Ω—ã...)"/>
      <select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <select id="newCatParent"><option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
        ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
    </div>
    <div class="row">
      <span class="preview-icon" id="newIconPreview">icon</span>
      <input type="color" id="newCatColor" value="#3388ff"/>
      <select id="newCatShape"><option value="circle">–ö—Ä—É–≥</option><option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option><option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option></select>
      <input type="file" id="newCatIcon" accept="image/png,image/svg+xml" style="display:none"/>
      <button id="btnNewCatIcon">üñº</button>
      <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>`;
  $editor.appendChild(create);

  const newIconInput=create.querySelector('#newCatIcon');
  const newIconPreview=create.querySelector('#newIconPreview');
  let newIconData=null;
  create.querySelector('#btnNewCatIcon').onclick=()=>newIconInput.click();
  newIconInput.onchange=e=>{
    const f=e.target.files[0]; if(!f){newIconData=null; newIconPreview.textContent='icon'; return;}
    const r=new FileReader(); r.onload=ev=>{newIconData=ev.target.result; newIconPreview.innerHTML=`<img src="${newIconData}">`;}; r.readAsDataURL(f);
  };
  create.querySelector('#btnAddCat').onclick=()=>{
    const name=document.getElementById('newCatName').value.trim(); if(!name) return;
    const type=document.getElementById('newCatType').value;
    const parent=document.getElementById('newCatParent').value||null;
    const color=document.getElementById('newCatColor').value;
    const shape=document.getElementById('newCatShape').value;
    const cat={id:uid(),name,type,parentCategoryId:parent,color,shape,items:[]};
    if(newIconData) cat.iconData=newIconData;
    db.categories.push(cat); save(); renderAll();
  };

  // —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  db.categories.forEach((cat,ci)=>{
    const sec=document.createElement('div'); sec.className='panel';
    const header=document.createElement('div'); header.className='row';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    header.append(title); sec.appendChild(header);

    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name;
    inpName.onchange=()=>{cat.name=inpName.value; save();};
    const selType=document.createElement('select'); ['select','checkbox'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(cat.type===t)o.selected=true;selType.appendChild(o);});
    selType.onchange=()=>{cat.type=selType.value; save(); renderAll();};
    const selParent=document.createElement('select');
    selParent.innerHTML=`<option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join('');
    selParent.onchange=()=>{cat.parentCategoryId=selParent.value||null; save(); renderAll();};
    const col=document.createElement('input'); col.type='color'; col.value=cat.color||'#3388ff';
    col.onchange=()=>{cat.color=col.value; save(); renderAll();};
    const shape=document.createElement('select'); ['circle','square','triangle'].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if((cat.shape||'circle')===s)o.selected=true;shape.appendChild(o);});
    shape.onchange=()=>{cat.shape=shape.value; save(); renderAll();};
    const iconPrev=document.createElement('span'); iconPrev.className='preview-icon'; iconPrev.innerHTML=cat.iconData?`<img src="${cat.iconData}">`:'icon';
    const iconFile=document.createElement('input'); iconFile.type='file'; iconFile.accept='image/png,image/svg+xml'; iconFile.style.display='none';
    const btnPick=document.createElement('button'); btnPick.textContent='üñº'; btnPick.onclick=()=>iconFile.click();
    iconFile.onchange=e=>{const f=e.target.files[0]; if(!f){delete cat.iconData; iconPrev.textContent='icon'; save(); return;} const r=new FileReader(); r.onload=ev=>{cat.iconData=ev.target.result; iconPrev.innerHTML=`<img src="${cat.iconData}">`; save();}; r.readAsDataURL(f);};
    const btnClearIcon=document.createElement('button'); btnClearIcon.textContent='‚úñ'; btnClearIcon.onclick=()=>{delete cat.iconData; iconPrev.textContent='icon'; save();};

    cfg.append(inpName,selType,selParent,col,shape,iconPrev,btnPick,btnClearIcon);
    sec.appendChild(cfg);
    // —ç–ª–µ–º–µ–Ω—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const list=document.createElement('div'); list.className='list';
    (cat.items||[]).forEach((it,ii)=>{
      const line=document.createElement('div'); line.className='item';
      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'‚Äî'} lng:${it.lng??'‚Äî'}`;
      left.append(nm,meta);

      const tools=document.createElement('div'); tools.className='tools';

      const itIconPrev=document.createElement('span'); itIconPrev.className='preview-icon'; itIconPrev.innerHTML=it.iconData?`<img src="${it.iconData}">`:'icon';
      const itIconInput=document.createElement('input'); itIconInput.type='file'; itIconInput.accept='image/png,image/svg+xml'; itIconInput.style.display='none';
      const itIconBtn=document.createElement('button'); itIconBtn.textContent='üñº'; itIconBtn.onclick=()=>itIconInput.click();
      itIconInput.onchange=e=>{const f=e.target.files[0]; if(!f){delete it.iconData; itIconPrev.textContent='icon'; save(); renderPreview(); return;} const r=new FileReader(); r.onload=ev=>{it.iconData=ev.target.result; itIconPrev.innerHTML=`<img src="${it.iconData}">`; save(); renderPreview();}; r.readAsDataURL(f);};
      const itIconClear=document.createElement('button'); itIconClear.textContent='‚úñ'; itIconClear.onclick=()=>{delete it.iconData; itIconPrev.textContent='icon'; save(); renderPreview();};

      const edit=document.createElement('button'); edit.textContent='‚úé'; edit.onclick=()=>{const nn=prompt('–ù–æ–≤–æ–µ –∏–º—è',it.name); if(nn){it.name=nn; save(); renderAll();}};
      const place=document.createElement('button'); place.textContent='üìç'; place.onclick=()=>{alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è: '+it.name); map.once('click', e=>{it.lat=e.latlng.lat; it.lng=e.latlng.lng; save(); meta.textContent=`lat:${it.lat.toFixed(5)} lng:${it.lng.toFixed(5)}`; addMarkerForItem(it,cat); map.setView([it.lat,it.lng],14);});};
      const clearBtn=document.createElement('button'); clearBtn.textContent='üóë'; clearBtn.onclick=()=>{it.lat=null; it.lng=null; save(); renderAll();};
      const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger'; del.onclick=()=>{if(confirm('–£–¥–∞–ª–∏—Ç—å "'+it.name+'"?')){cat.items.splice(ii,1); save(); renderAll();}};

      line.onclick=()=>{ if(it.lat!=null&&it.lng!=null){ map.setView([it.lat,it.lng],14);} };
      tools.append(itIconPrev,itIconBtn,itIconClear,edit,place,clearBtn,del,itIconInput);
      line.append(left,tools); list.appendChild(line);
    });
    sec.appendChild(list);

    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
    const parentPicker=document.createElement('select');
    if(cat.parentCategoryId){
      const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
      parentPicker.innerHTML=`<option value="">(–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+(parentCat?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }else{ parentPicker.innerHTML=`<option value="">(—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω)</option>`; }
    const addBtn=document.createElement('button'); addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å';
    addBtn.onclick=()=>{const nm=inp.value.trim()||'–ù–æ–≤—ã–π'; cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:parentPicker.value||null}); inp.value=''; save(); renderAll();};
    addRow.append(inp,parentPicker,addBtn); sec.appendChild(addRow);

    $editor.appendChild(sec);
  });
}

/***** PREVIEW *****/
const $cascade=document.getElementById('cascadeBox');
let selected={}; let reopenMultiCatId=null;
function getSelectedIds(catId){const cat=db.categories.find(x=>x.id===catId); const v=selected[catId]; if(!v) return []; return (cat && cat.type==='checkbox')?Array.from(v):(v?[v]:[]);}
function dropChildrenSelections(parentCatId){const children=db.categories.filter(c=>c.parentCategoryId===parentCatId); for(const ch of children){delete selected[ch.id]; dropChildrenSelections(ch.id);} }

function renderPreview(){
  $cascade.innerHTML=""; clearMarkers();
  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel'; box.dataset.catId=cat.id;
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);
    let parentIds=null;
    if(cat.parentCategoryId){const parentSelected=getSelectedIds(cat.parentCategoryId); if(parentSelected.length===0){const note=document.createElement('div'); note.className='note'; note.textContent='–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏: '+(db.categories.find(c=>c.id===cat.parentCategoryId)?.name||'—Ä–æ–¥–∏—Ç–µ–ª—è'); box.appendChild(note); $cascade.appendChild(box); return;} parentIds=parentSelected;}
    let items=(cat.items||[]); if(parentIds){items=items.filter(it=>it.parentId && parentIds.includes(it.parentId));}
    if(items.length===0){const note=document.createElement('div'); note.className='note'; note.style.opacity='.7'; note.textContent='–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤'; box.appendChild(note); $cascade.appendChild(box); return;}

    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.style.width='100%'; sel.innerHTML=`<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>`+items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      if(typeof selected[cat.id]==='string') sel.value=selected[cat.id]||""; sel.onchange=()=>{selected[cat.id]=sel.value||null; dropChildrenSelections(cat.id); renderPreview();}; box.appendChild(sel);
    }else{
      const multi=document.createElement('div'); multi.className='multi-select'; const btn=document.createElement('div'); btn.className='multi-select-btn'; btn.textContent='–í—ã–±—Ä–∞—Ç—å...'; const menu=document.createElement('div'); menu.className='multi-select-menu'; const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();
      function updateBtnText(){ if(set.size===0){btn.textContent='–í—ã–±—Ä–∞—Ç—å...';} else{const names=items.filter(x=>set.has(x.id)).map(x=>x.name); btn.textContent=names.length<=5?names.join(', '):`–í—ã–±—Ä–∞–Ω–æ: ${names.length}`;} }
      updateBtnText();
      items.forEach(it=>{const lbl=document.createElement('label'); const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; cb.checked=set.has(it.id); cb.onchange=()=>{if(cb.checked) set.add(it.id); else set.delete(it.id); selected[cat.id]=set; dropChildrenSelections(cat.id); updateBtnText(); reopenMultiCatId=cat.id; renderPreview();}; lbl.append(cb,document.createTextNode(it.name)); menu.appendChild(lbl);});
      btn.onclick=()=>{document.querySelectorAll('.multi-select.open').forEach(ms=>{if(ms!==multi) ms.classList.remove('open');}); multi.classList.toggle('open');};
      multi.append(btn,menu); box.appendChild(multi);
    }
    $cascade.appendChild(box);
  });

  for(const cat of db.categories){const ids=getSelectedIds(cat.id); for(const id of ids){const it=(cat.items||[]).find(x=>x.id===id); if(it && it.lat!=null && it.lng!=null) addMarkerForItem(it,cat);} }
  if(reopenMultiCatId){const panel=$cascade.querySelector(`.panel[data-cat-id="${reopenMultiCatId}"] .multi-select`); if(panel) panel.classList.add('open'); reopenMultiCatId=null;}
  updatePolygonVisibility();
}
function updatePolygonVisibility(){
  db.polygons.forEach(p=>{const layer=polyIndex.get(p.id); if(!layer) return; let match=false; for(const cat of db.categories){const ids=getSelectedIds(cat.id); if(!ids.length) continue; const items=(cat.items||[]).filter(it=>ids.includes(it.id)); if(items.some(it=>it.name===p.name)){match=true; break;} } if(match && p.visible!==false) layer.addTo(map); else map.removeLayer(layer);});
}
document.addEventListener('click', e=>{document.querySelectorAll('.multi-select.open').forEach(ms=>{if(!ms.contains(e.target)) ms.classList.remove('open');});});

/***** SEARCH *****/
const $search=document.getElementById('globalSearch'); const $results=document.getElementById('searchResults');
$search.oninput=()=>{const q=$search.value.trim().toLowerCase(); $results.innerHTML=""; if(!q) return; const out=[]; db.categories.forEach(cat=>{(cat.items||[]).forEach(it=>{if(it.name.toLowerCase().includes(q)) out.push({cat,it});});}); out.forEach(r=>{const row=document.createElement('div'); row.textContent=`${r.it.name} (${r.cat.name})`; row.onclick=()=>{if(r.cat.type==='select') selected[r.cat.id]=r.it.id; else{if(!(selected[r.cat.id] instanceof Set)) selected[r.cat.id]=new Set(); selected[r.cat.id].add(r.it.id);} renderPreview(); if(r.it.lat!=null&&r.it.lng!=null) map.setView([r.it.lat,r.it.lng],14); $search.value=""; $results.innerHTML="";}; $results.appendChild(row);});};

/***** EXPORT/IMPORT + INIT *****/
document.getElementById('btnExport').onclick=()=>{normalize(db); const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_v37.6.json'; a.click();};
document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{let obj=JSON.parse(r.result); if(Array.isArray(obj.categories)&&Array.isArray(obj.polygons)){} else if(obj&&obj.db&&(Array.isArray(obj.db.categories)||obj.db.polygons)){obj=obj.db;} else throw new Error('–ù–µ—Ç categories/polygons'); normalize(obj); db=obj; save(); selected={}; renderAll(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');}catch(err){alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message);} }; r.readAsText(f);};
document.getElementById('btnReset').onclick=()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')) resetDB(); };

document.querySelectorAll('.tab').forEach(tab=>{tab.onclick=()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); const which=tab.dataset.tab; document.getElementById('editorTab').style.display=which==='editor'?'block':'none'; document.getElementById('previewTab').style.display=which==='preview'?'block':'none';};});

function renderAll(){ renderEditor(); renderPreview(); rebuildPolys(); }
initDB().then(()=>{ renderAll(); });
</script>
</body>
</html>
