<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v10 ‚Äî –∫–∞—Å–∫–∞–¥ + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ DnD</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:420px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
h4{margin:0 0 8px 0}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:#111a2a}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px}
.drag-handle{cursor:grab;opacity:.8}
.dragging{opacity:.5;outline:1px dashed var(--accent)}
#map{width:100%;height:100%}
.checkbox-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px}
.checkbox-grid label{display:flex;align-items:center;gap:6px;background:#111a2a;padding:6px 8px;border:1px solid #273248;border-radius:8px;cursor:pointer}
.muted{color:var(--muted)}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v10</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label><input type="file" id="fileImport" style="display:none"><button>–ò–º–ø–æ—Ä—Ç</button></label>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Å–∫–∞–¥–∞</h3>
      <div class="help">–í—ã–±–∏—Ä–∞–π —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑. –ü–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —Ä–æ–¥–∏—Ç–µ–ª—å ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–∫—Ä—ã—Ç/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</div>
      <div id="cascadeBox" style="margin-top:8px"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ================= STORAGE ================= */
const KEY="dict_v10";
let db = JSON.parse(localStorage.getItem(KEY) || "null");
if(!db){
  db={
    categories:[
      // –Ω–∞—á–Ω–∏ —Å –ø—É—Å—Ç–æ–≥–æ ‚Äî —Ç—ã —Ö–æ—Ç–µ–ª —Å–∞–º –¥–æ–±–∞–≤–∏—Ç—å
      // –ø—Ä–∏–º–µ—Ä –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—è:
      // {id:uid(), name:"–°—Ç—Ä–∞–Ω—ã", type:"select", parentCategoryId:null, items:[{id:uid(),name:"–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω",lat:41.3,lng:69.2,parentId:null}]}
    ]
  };
  save();
}
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ================= MAP ================= */
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let markers=[];
function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
function addMarker(lat,lng,label){
  const m=L.marker([lat,lng]).addTo(map).bindPopup(label);
  markers.push(m);
}

/* ================= DRAG & DROP UTILS ================= */
let dnd = {type:null, catIndex:null, itemIndex:null}; // type: "cat"|"item"
function dndStart(e, type, catIndex, itemIndex=null){
  dnd={type,catIndex,itemIndex};
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed="move";
}
function dndEnd(e){
  e.currentTarget.classList.remove('dragging');
  dnd={type:null,catIndex:null,itemIndex:null};
}
function dndOver(e){ e.preventDefault(); e.dataTransfer.dropEffect="move"; }
function dndDropCategory(e, targetIndex){
  e.preventDefault();
  if(dnd.type!=="cat" || dnd.catIndex===null || dnd.catIndex===targetIndex) return;
  const arr=db.categories;
  const elem=arr.splice(dnd.catIndex,1)[0];
  arr.splice(targetIndex,0,elem);
  save(); renderAll();
}
function dndDropItem(e, catIndex, targetItemIndex){
  e.preventDefault();
  if(dnd.type!=="item") return;
  if(dnd.catIndex!==catIndex) return; // —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  if(dnd.itemIndex===null || dnd.itemIndex===targetItemIndex) return;
  const arr=db.categories[catIndex].items||[];
  const elem=arr.splice(dnd.itemIndex,1)[0];
  arr.splice(targetItemIndex,0,elem);
  save(); renderAll();
}

/* ================= EDITOR ================= */
const $editor = document.getElementById('editorTab');

function renderEditor(){
  $editor.innerHTML="";

  // –ü–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const addPanel=document.createElement('div'); addPanel.className='panel';
  addPanel.innerHTML=`
    <h3>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
    <div class="row">
      <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°—Ç—Ä–∞–Ω—ã, –ì–æ—Ä–æ–¥–∞, –†–∞–π–æ–Ω—ã, –ú–µ—Ç—Ä–æ)"/>
      <select id="newCatType">
        <option value="select">Select (–æ–¥–∏–Ω)</option>
        <option value="checkbox">Checkbox (–Ω–µ—Å–∫–æ–ª—å–∫–æ)</option>
      </select>
      <select id="newCatParent">
        <option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
        ${db.categories.map((c,i)=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
      <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div class="help">–ü–æ–¥—Å–∫–∞–∑–∫–∞: —á—Ç–æ–±—ã –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–∞—Å–∫–∞–¥, —É–∫–∞–∂–∏ parent –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ì–æ—Ä–æ–¥–∞ ‚Üí –°—Ç—Ä–∞–Ω—ã).</div>
  `;
  $editor.appendChild(addPanel);

  // –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∫ –µ—Å—Ç—å)
  db.categories.forEach((cat,ci)=>{
    const sec=document.createElement('div'); sec.className='panel'; sec.draggable=true;
    sec.addEventListener('dragstart', e=>dndStart(e,'cat',ci));
    sec.addEventListener('dragend', dndEnd);
    sec.addEventListener('dragover', dndOver);
    sec.addEventListener('drop', e=>dndDropCategory(e, ci));

    const header=document.createElement('div'); header.className='row';
    const title=document.createElement('h3'); title.textContent=cat.name + ` (${cat.type})`;
    const handle=document.createElement('span'); handle.textContent='‚Üï'; handle.title='–ü–µ—Ä–µ—Ç–∞—â–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏'; handle.className='drag-handle';
    header.append(title, handle);
    sec.appendChild(header);

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name; inpName.placeholder='–ù–∞–∑–≤–∞–Ω–∏–µ';
    const selType=document.createElement('select');
    ['select','checkbox'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; if(cat.type===t) o.selected=true; selType.appendChild(o); });
    const selParent=document.createElement('select');
    selParent.innerHTML=`<option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>${db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join('')}`;
    const btnSave=document.createElement('button'); btnSave.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const btnDel=document.createElement('button'); btnDel.textContent='–£–¥–∞–ª–∏—Ç—å'; btnDel.className='danger';
    btnSave.onclick=()=>{
      cat.name=inpName.value.trim()||cat.name;
      cat.type=selType.value;
      cat.parentCategoryId=selParent.value||null;
      // –µ—Å–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—è —Å–Ω—è–ª–∏ ‚Äî —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è, parentId —É –Ω–∏—Ö –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
      save(); renderAll();
    };
    btnDel.onclick=()=>{
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${cat.name}" –∏ –≤—Å–µ –µ—ë —ç–ª–µ–º–µ–Ω—Ç—ã?`)) return;
      db.categories.splice(ci,1); save(); renderAll();
    };
    cfg.append(inpName, selType, selParent, btnSave, btnDel);
    sec.appendChild(cfg);

    sec.appendChild(document.createElement('div')).className='sep';

    // –°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const list=document.createElement('div'); list.className='list';

    (cat.items||[]).forEach((it,ii)=>{
      const line=document.createElement('div'); line.className='item'; line.draggable=true;
      line.addEventListener('dragstart', e=>dndStart(e,'item',ci,ii));
      line.addEventListener('dragend', dndEnd);
      line.addEventListener('dragover', dndOver);
      line.addEventListener('drop', e=>dndDropItem(e,ci,ii));

      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta';
      meta.textContent = `lat:${it.lat??'‚Äî'} lng:${it.lng??'‚Äî'} ${it.parentId?(' ‚Ä¢ —Ä–æ–¥.: '+resolveItemName(it.parentId)) : ''}`;
      left.append(nm, meta);

      const tools=document.createElement('div'); tools.className='tools';
      const edit=document.createElement('button'); edit.textContent='‚úé';
      edit.onclick=()=>{
        const nn=prompt('–ù–æ–≤–æ–µ –∏–º—è', it.name);
        if(nn){ it.name=nn.trim(); save(); renderAll(); }
      };
      const parentBtn=document.createElement('button'); parentBtn.textContent='‚Üó —Ä–æ–¥–∏—Ç–µ–ª—å';
      parentBtn.title='–í—ã–±—Ä–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç (–µ—Å–ª–∏ —É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å)';
      parentBtn.onclick=()=>{
        if(!cat.parentCategoryId){ alert('–£ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è. –ó–∞–¥–∞–π —Ä–æ–¥–∏—Ç–µ–ª—è —É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤—ã—à–µ.'); return; }
        const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
        if(!parentCat || !parentCat.items || !parentCat.items.length){ alert('–í —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤.'); return; }
        const choice = prompt(
          'ID —Ä–æ–¥–∏—Ç–µ–ª—è (–ø—É—Å—Ç–æ ‚Äî —É–±—Ä–∞—Ç—å)\n' + parentCat.items.map(x=>`${x.name} ‚Äî ${x.id}`).join('\n'),
          it.parentId||''
        );
        if(choice!==null){ it.parentId=choice.trim()||null; save(); renderAll(); }
      };
      const place=document.createElement('button'); place.textContent='üìç';
      place.title='–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –º–µ—Ç–∫—É. –ü–æ—Ç—è–Ω–∏ –º–∞—Ä–∫–µ—Ä ‚Äî –º–æ–∂–Ω–æ –ø–æ–¥–≤–∏–Ω—É—Ç—å.';
      place.onclick=()=>{
        alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –¥–ª—è: '+it.name);
        map.once('click', e=>{
          it.lat=e.latlng.lat; it.lng=e.latlng.lng; save();
          showDraggable(it);
        });
      };
      const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger';
      del.onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å "'+it.name+'"?')){ cat.items.splice(ii,1); save(); renderAll(); } };
      tools.append(edit,parentBtn,place,del);

      line.onclick=()=>{ if(it.lat!=null && it.lng!=null) showDraggable(it); };
      line.append(left,tools);
      list.appendChild(line);
    });
    sec.appendChild(list);

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
    const parentPicker=document.createElement('select');
    parentPicker.innerHTML = (cat.parentCategoryId
      ? `<option value="">(–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>${(db.categories.find(c=>c.id===cat.parentCategoryId)?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}`
      : `<option value="">(—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω)</option>`
    );
    const addBtn=document.createElement('button'); addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å';
    addBtn.onclick=()=>{
      const nm=inp.value.trim()||'–ù–æ–≤—ã–π';
      cat.items=cat.items||[];
      cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId: parentPicker.value||null});
      inp.value=''; save(); renderAll();
    };
    addRow.append(inp,parentPicker,addBtn);
    sec.appendChild(addRow);

    $editor.appendChild(sec);
  });

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
  document.getElementById('btnAddCat').onclick=()=>{
    const name=document.getElementById('newCatName').value.trim();
    const type=document.getElementById('newCatType').value;
    const parent=document.getElementById('newCatParent').value||null;
    if(!name) return;
    db.categories.push({id:uid(),name,type, parentCategoryId:parent, items:[]});
    save(); renderAll();
  };
}

function resolveItemName(id){
  for(const c of db.categories){
    const f=(c.items||[]).find(x=>x.id===id);
    if(f) return f.name;
  }
  return null;
}
function showDraggable(it){
  clearMarkers();
  const marker=L.marker([it.lat,it.lng],{draggable:true}).addTo(map).bindPopup(it.name).openPopup();
  markers.push(marker);
  map.setView([it.lat,it.lng],14);
  marker.on('dragend', e=>{
    const p=e.target.getLatLng();
    it.lat=p.lat; it.lng=p.lng; save();
  });
}

/* ================= PREVIEW (CASCADE) ================= */
const $cascade = document.getElementById('cascadeBox');

// –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: –¥–ª—è select ‚Äî —Å—Ç—Ä–æ–∫–∞ id, –¥–ª—è checkbox ‚Äî Set<id>
let selected = {}; // key: categoryId -> value: string | Set<string>

function topoOrderCategories(){
  // –ü—Ä–æ—Å—Ç–æ–π —Ç–æ–ø–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫: –∫–æ—Ä–Ω–∏ —Å–Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –¥–µ—Ç–∏ (–ø–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º parentCategoryId)
  const cats = [...db.categories];
  const idToNode = new Map(cats.map(c=>[c.id,{c, indeg:0, kids:[]}]));
  for(const {c} of idToNode.values()){
    if(c.parentCategoryId && idToNode.has(c.parentCategoryId)){
      idToNode.get(c.parentCategoryId).kids.push(c.id);
      idToNode.get(c.id).indeg++;
    }
  }
  const q=[]; for(const [id,node] of idToNode){ if(node.indeg===0) q.push(id); }
  const order=[];
  while(q.length){
    const id=q.shift(); order.push(idToNode.get(id).c);
    for(const kid of idToNode.get(id).kids){
      const kn=idToNode.get(kid); kn.indeg--; if(kn.indeg===0) q.push(kid);
    }
  }
  // –µ—Å–ª–∏ –µ—Å—Ç—å —Ü–∏–∫–ª—ã/–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏–º —Ç–æ —á—Ç–æ –Ω–µ –ø–æ–ø–∞–ª–æ
  const set=new Set(order.map(c=>c.id));
  for(const c of cats) if(!set.has(c.id)) order.push(c);
  return order;
}

function renderPreview(){
  $cascade.innerHTML="";
  clearMarkers();

  const ordered = topoOrderCategories();

  // –≤—Å–ø–æ–º–æ–≥–∞–ª–∫–∞: –ø–æ–ª—É—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ id —Ä–æ–¥–∏—Ç–µ–ª—è (–º–∞—Å—Å–∏–≤)
  function getSelectedIds(catId){
    const cat = db.categories.find(x=>x.id===catId);
    const v = selected[catId];
    if(!v) return [];
    if(cat && cat.type==='checkbox'){
      return Array.from(v); // Set -> array
    }
    return v ? [v] : [];
  }

  // —Ä–µ–Ω–¥–µ—Ä —É—Ä–æ–≤–Ω—è
  function renderLevel(cat){
    const box=document.createElement('div'); box.className='panel';
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);

    // —Ç—Ä–µ–±—É–µ–º, —á—Ç–æ–±—ã —Ä–æ–¥–∏—Ç–µ–ª—å –±—ã–ª –≤—ã–±—Ä–∞–Ω
    if(cat.parentCategoryId){
      const pSel = getSelectedIds(cat.parentCategoryId);
      if(pSel.length===0){
        const note=document.createElement('div'); note.className='muted';
        note.textContent='–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏: '+(db.categories.find(c=>c.id===cat.parentCategoryId)?.name||'—Ä–æ–¥–∏—Ç–µ–ª—è');
        box.appendChild(note);
        $cascade.appendChild(box);
        return;
      }
    }

    // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ä–æ–¥–∏—Ç–µ–ª—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
    let items = (cat.items||[]);
    if(cat.parentCategoryId){
      const pSel = getSelectedIds(cat.parentCategoryId);
      items = items.filter(it=> it.parentId && pSel.includes(it.parentId));
    }

    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.style.width='100%';
      sel.innerHTML = `<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>` + items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      if(typeof selected[cat.id]==='string') sel.value=selected[cat.id];
      sel.onchange=()=>{
        selected[cat.id]=sel.value||null;
        // –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç–∫—É, –µ—Å–ª–∏ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        clearMarkers();
        const it=items.find(x=>x.id===sel.value);
        if(it && it.lat!=null && it.lng!=null){
          addMarker(it.lat,it.lng,it.name);
          map.setView([it.lat,it.lng],13);
        }
        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤
        dropChildrenSelections(cat.id);
        renderPreview();
      };
      box.appendChild(sel);
    }else{ // checkbox
      const grid=document.createElement('div'); grid.className='checkbox-grid';
      const set = selected[cat.id] instanceof Set ? selected[cat.id] : new Set();
      items.forEach(it=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id;
        cb.checked = set.has(it.id);
        cb.onchange=()=>{
          if(cb.checked) set.add(it.id); else set.delete(it.id);
          selected[cat.id]=set;
          // –º–∞—Ä–∫–µ—Ä—ã: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
          clearMarkers();
          // —Å–æ–±–µ—Ä—ë–º –≤—Å–µ –∫–æ–Ω–µ—á–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (–≤–∫–ª—é—á–∞—è —ç—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å)
          for(const oid of set){
            const item = items.find(x=>x.id===oid);
            if(item && item.lat!=null && item.lng!=null) addMarker(item.lat,item.lng,item.name);
          }
          // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —É –ø–æ—Ç–æ–º–∫–æ–≤, —Ç.–∫. –º–µ–Ω—è–µ—Ç—Å—è —Ñ–∏–ª—å—Ç—Ä
          dropChildrenSelections(cat.id);
          renderPreview(); // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –Ω–∏–∂–µ —É—Ä–æ–≤–Ω–∏
        };
        lbl.append(cb, document.createTextNode(it.name));
        grid.appendChild(lbl);
      });
      box.appendChild(grid);
    }
    $cascade.appendChild(box);
  }

  // —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ —É –ø–æ—Ç–æ–º–∫–æ–≤ –ø–æ —Ü–µ–ø–æ—á–∫–µ
  function dropChildrenSelections(parentCatId){
    const children = db.categories.filter(c=>c.parentCategoryId===parentCatId);
    for(const ch of children){
      delete selected[ch.id];
      dropChildrenSelections(ch.id);
    }
  }

  // —Ä–µ–Ω–¥–µ—Ä–∏–º –ø–æ –ø–æ—Ä—è–¥–∫—É
  for(const cat of ordered){
    renderLevel(cat);
  }

  // –µ—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω—ã —á–µ–∫–±–æ–∫—Å—ã –Ω–∞ –Ω–∏–∂–Ω–∏—Ö —É—Ä–æ–≤–Ω—è—Ö ‚Äî –º–µ—Ç–∫–∏ —É–∂–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–ª–∏ –≤ –∏—Ö onchange,
  // –Ω–æ –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã–ª–∞—Å—å ‚Äî –º–æ–∂–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
  for(const cat of ordered){
    if(cat.type==='checkbox' && selected[cat.id] instanceof Set){
      const pSel = cat.parentCategoryId ? getSelectedIds(cat.parentCategoryId) : null;
      let items=(cat.items||[]);
      if(pSel) items=items.filter(it=>it.parentId && pSel.includes(it.parentId));
      for(const oid of selected[cat.id]){
        const it=items.find(x=>x.id===oid);
        if(it && it.lat!=null && it.lng!=null) addMarker(it.lat,it.lng,it.name);
      }
    }else if(cat.type==='select' && typeof selected[cat.id]==='string'){
      const pSel = cat.parentCategoryId ? getSelectedIds(cat.parentCategoryId) : null;
      let items=(cat.items||[]);
      if(pSel) items=items.filter(it=>it.parentId && pSel.includes(it.parentId));
      const it=items.find(x=>x.id===selected[cat.id]);
      if(it && it.lat!=null && it.lng!=null) addMarker(it.lat,it.lng,it.name);
    }
  }
}

/* ================= EXPORT/IMPORT/RESET ================= */
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_v10.json'; a.click();
};
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{
      const obj=JSON.parse(r.result);
      if(!obj || !Array.isArray(obj.categories)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON');
      db=obj; save(); selected={}; renderAll(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); } };
  r.readAsText(f);
};
document.getElementById('btnReset').onclick=()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){ localStorage.removeItem(KEY); location.reload(); }
};

/* ================= TABS ================= */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display = which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display = which==='preview'?'block':'none';
  };
});

/* ================= INIT ================= */
function renderAll(){ renderEditor(); renderPreview(); }
renderAll();
</script>
</body>
</html>
