<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>dictionary v39.0R stable ‚Äî –±–∞–∑–∞ v38.9R + Feather Icons + –≤—ã–±–æ—Ä –∏–∫–æ–Ω–æ–∫ + —ç–∫—Å–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + –∏—Å—Ç–æ—Ä–∏—è + –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</title>

<!-- Leaflet + –ø–ª–∞–≥–∏–Ω—ã -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<!-- Feather Icons (CDN) -->
<script src="https://unpkg.com/feather-icons"></script>

<!-- localForage -->
<script src="https://unpkg.com/localforage@1.10.0/dist/localforage.js"></script>

<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--panel3:#0f1624;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444;--overlay:rgba(10,14,22,.75)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:var(--text);cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:460px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3,h4{margin:0 0 8px 0}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{border:1px solid var(--border);border-radius:8px;padding:10px;background:#111a2a}
.item-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
.note{background:#0e1524;border:1px dashed #32405a;padding:8px;border-radius:8px;color:#9fb0c8}
.note.gray{opacity:.6}
#map{width:100%;height:100%}
.preview-icon{width:20px;height:20px;border-radius:4px;border:1px solid #31405a;background:#0f1624;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview-icon img{max-width:100%;max-height:100%;display:block}

/* –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Äî –∫–Ω–æ–ø–∫–∞ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ */
.multi-select{position:relative;width:100%}
.multi-select-btn{width:100%;padding:6px 8px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* –ø–æ–∏—Å–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º */
#globalSearch{width:100%;padding:6px 8px;margin-bottom:8px;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.search-results{max-height:200px;overflow:auto;margin-top:6px}
.search-results div{padding:4px 6px;border-bottom:1px solid var(--border);cursor:pointer}
.search-results div:hover{background:#1f293d}

/* –ø–æ–ª–∏–≥–æ–Ω—ã */
.item.active{border:1px solid var(--accent);background:#1f2d44}
#polySearch{width:100%;padding:6px 8px;margin:8px 0;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}

/* —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–π */
.collapse-head{display:flex;align-items:center;gap:8px;cursor:pointer}
.caret{width:22px;height:22px;border:1px solid var(--border);border-radius:6px;background:#1a2234;display:flex;align-items:center;justify-content:center}
.caret::after{content:"‚ñæ";font-size:12px;line-height:1}
.collapsed .caret::after{content:"‚ñ∏"}
.section-body{margin-top:8px}
.collapsed .section-body{display:none}

/* –º–æ–¥–∞–ª–∫–∏ */
.modal-overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:5000}
.modal{width:min(980px,90vw);max-height:85vh;background:var(--panel);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;overflow:hidden}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);background:var(--panel3)}
.modal-title{font-weight:700}
.modal-close{border:1px solid var(--border);background:#1a2234;border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.modal-body{padding:12px 14px;overflow:auto}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border);background:var(--panel3)}
.modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
@media (max-width:1024px){.modal-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.modal-grid{grid-template-columns:1fr}}
.modal-item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #1f2a40;border-radius:8px;background:#0f1624}
.modal-item input[type="checkbox"]{
  appearance:none;-webkit-appearance:none;width:16px;height:16px;border:2px solid var(--accent);border-radius:4px;background:#1a2234;cursor:pointer;position:relative;flex:0 0 16px
}
.modal-item input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
.modal-item input[type="checkbox"]:checked::after{content:"‚úî";position:absolute;top:-2px;left:2px;font-size:14px;color:#fff}
.modal-head-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.modal-head-row .grow{flex:1}

/* –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
.suggestions{position:absolute;background:var(--panel2);border:1px solid var(--border);border-radius:8px;z-index:3000;max-height:200px;overflow:auto;width:100%}
.suggestions div{padding:6px 8px;cursor:pointer}
.suggestions div:hover{background:#1f293d}

/* drag */
.draggable{cursor:grab}
.dragging{opacity:.5}
.dropzone-hover{outline:2px dashed var(--accent);outline-offset:4px}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v39.0R</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <button id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnInfo">–ò–Ω—Ñ–æ</button>
  <button id="btnHistory">–ò—Å—Ç–æ—Ä–∏—è</button>
  <button id="btnUndo">Undo</button>
  <button id="btnRedo">Redo</button>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Å–∫–∞–¥–∞</h3>
      <input id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º..."/>
      <div id="searchResults" class="search-results"></div>
      <div class="row">
        <button id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
        <button id="btnClearAll" class="danger">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
      </div>
      <div class="help">–ß–µ–∫–±–æ–∫—Å-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ –±–æ–ª—å—à–æ–º —Å–ø–∏—Å–∫–µ (–∫–∞–∫ –Ω–∞ –ê–≤–∏—Ç–æ). –í–Ω—É—Ç—Ä–∏ —Ç–æ–∂–µ –µ—Å—Ç—å ¬´–≤—ã–±—Ä–∞—Ç—å –≤—Å—ë/—Å–±—Ä–æ—Å–∏—Ç—å¬ª.</div>
      <div id="cascadeBox" style="margin-top:8px"></div>

      <div class="sep"></div>
      <h3>–ü–æ–ª–∏–≥–æ–Ω—ã</h3>
      <input id="polyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞"/>
      <input type="color" id="polyColor" value="#ff4d4f"/>
      <div class="row">
        <button id="btnPolyNew">–ù–æ–≤—ã–π</button>
        <button id="btnPolyEdit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btnPolyStop">–°—Ç–æ–ø</button>
        <button id="btnPolyUndo">Undo</button>
        <button id="btnPolyRedo">Redo</button>
      </div>
      <input id="polySearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª–∏–≥–æ–Ω–∞–º..."/>
      <div id="polyList" class="list"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>

<!-- –ú–æ–¥–∞–ª–∫–∞ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ -->
<div id="msOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <div id="msTitle" class="modal-title">–í—ã–±–æ—Ä</div>
      <div id="msClose" class="modal-close">‚úñ</div>
    </div>
    <div class="modal-body">
      <div class="modal-head-row">
        <input id="msSearch" class="grow" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å–ø–∏—Å–∫—É..."/>
        <button id="msAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
        <button id="msNone" class="danger">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
      </div>
      <div id="msGrid" class="modal-grid"></div>
    </div>
    <div class="modal-actions">
      <button id="msApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button id="msCancel" class="danger">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Feather-–∏–∫–æ–Ω–æ–∫ -->
<div id="icoOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">–í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏</div>
      <div id="icoClose" class="modal-close">‚úñ</div>
    </div>
    <div class="modal-body">
      <div class="modal-head-row">
        <input id="icoSearch" class="grow" placeholder="–ü–æ–∏—Å–∫ –ø–æ Feather... –Ω–∞–ø—Ä–∏–º–µ—Ä: home, map, star"/>
      </div>
      <div id="icoGrid" class="modal-grid"></div>
    </div>
    <div class="modal-actions">
      <button id="icoApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button id="icoCancel" class="danger">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div id="infoOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div><div id="infoClose" class="modal-close">‚úñ</div></div>
  <div class="modal-body"><div id="infoBox"></div></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
<div id="historyOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</div><div id="historyClose" class="modal-close">‚úñ</div></div>
    <div class="modal-body"><div id="historyBox"></div></div>
  </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã –∫–∞—Ä—Ç -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
/***** STORAGE + DB (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á–∏ –∫–∞–∫ –≤ v38.6R, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ) *****/
const KEY="dict_v38_3R";
const lfIcons=localforage.createInstance({name:"dict_icons_v383R"});
const lfGeo=localforage.createInstance({name:"dict_geo_v383R"});
const lfHistory=localforage.createInstance({name:"dict_history_v39R"});

function uid(){return Math.random().toString(36).slice(2,9);}

function normalize(obj){
  if(!obj||typeof obj!=="object")obj={categories:[],polygons:[]};
  if(!Array.isArray(obj.categories)) obj.categories=[];
  if(!Array.isArray(obj.polygons)) obj.polygons=[];
  obj.categories.forEach(c=>{
    if(!("id" in c))c.id=uid();
    if(!("type" in c))c.type="select";
    if(!("items" in c))c.items=[];
    if(!("color" in c))c.color="#3388ff";
    if(!("shape" in c))c.shape="circle";
    if(!("parentCategoryId" in c))c.parentCategoryId=null;
    c.items.forEach(it=>{
      if(!("id" in it))it.id=uid();
      if(!("name" in it))it.name="–ë–µ–∑ –∏–º–µ–Ω–∏";
      if(!("lat" in it))it.lat=null;
      if(!("lng" in it))it.lng=null;
      if(!("parentId" in it))it.parentId=null;
      if(!("iconKey" in it))it.iconKey=null;
    });
  });
  obj.polygons.forEach(p=>{
    if(!("id" in p))p.id=uid();
    if(!("name" in p))p.name="–ü–æ–ª–∏–≥–æ–Ω";
    if(!("color" in p))p.color="#ff4d4f";
    if(!("visible" in p))p.visible=true;
  });
}
</script>
<script>
/***** SAVE / LOAD *****/
async function save(obj=db){
  normalize(obj);
  const lite={
    categories:obj.categories.map(c=>({
      id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId,
      color:c.color,shape:c.shape,iconKey:c.iconKey||null,
      items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
    })),
    polygons:obj.polygons.map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
  };
  localStorage.setItem(KEY,JSON.stringify(lite));

  // –∏–∫–æ–Ω–∫–∏ –≤ IndexedDB
  for(const cat of obj.categories){
    if(cat.iconData){
      const key=cat.iconKey||`cat_${cat.id}`;
      await lfIcons.setItem(key,cat.iconData);
      cat.iconKey=key;
    }
    for(const it of (cat.items||[])){
      if(it.iconData){
        const key=it.iconKey||`item_${it.id}`;
        await lfIcons.setItem(key,it.iconData);
        it.iconKey=key;
      }
    }
  }
  // –ø–æ–ª–∏–≥–æ–Ω—ã –≥–µ–æ–º–µ—Ç—Ä–∏—è
  for(const p of obj.polygons){
    if(p.geojson) await lfGeo.setItem(p.id,p.geojson);
  }
}

async function loadDB(){
  const raw=localStorage.getItem(KEY);
  let obj={categories:[],polygons:[]};
  if(raw){try{obj=JSON.parse(raw)||{};}catch(e){}}
  normalize(obj);
  // –ø–æ–¥—Ç—è–Ω—É—Ç—å –∏–∫–æ–Ω–∫–∏
  for(const cat of obj.categories){
    if(cat.iconKey&&!cat.iconData){
      try{cat.iconData=await lfIcons.getItem(cat.iconKey)||null;}catch(e){}
    }
    for(const it of (cat.items||[])){
      if(it.iconKey&&!it.iconData){
        try{it.iconData=await lfIcons.getItem(it.iconKey)||null;}catch(e){}
      }
    }
  }
  // –ø–æ–¥—Ç—è–Ω—É—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é
  for(const p of obj.polygons){
    if(!p.geojson){
      try{p.geojson=await lfGeo.getItem(p.id)||null;}catch(e){}
    }
  }
  return obj;
}

/***** GLOBAL HISTORY SNAPSHOTS (undo/redo –∫–∞—Ç–µ–≥–æ—Ä–∏–π/—ç–ª–µ–º–µ–Ω—Ç–æ–≤) *****/
let historyStack=[],historyIndex=-1,historyLimit=80;
function pushHistory(){
  const snap=JSON.stringify(db);
  if(historyIndex<historyStack.length-1) historyStack.splice(historyIndex+1);
  historyStack.push(snap);
  if(historyStack.length>historyLimit){ historyStack.shift(); historyIndex=historyStack.length-1; } else { historyIndex=historyStack.length-1; }
}
async function commit(note){ await save(db); pushHistory(); renderAll(); if(note) await logHistory(note.action,note.details||""); }
function undo(){ if(historyIndex>0){ historyIndex--; db=JSON.parse(historyStack[historyIndex]); renderAll(); } }
function redo(){ if(historyIndex<historyStack.length-1){ historyIndex++; db=JSON.parse(historyStack[historyIndex]); renderAll(); } }
document.getElementById('btnUndo').onclick=undo;
document.getElementById('btnRedo').onclick=redo;

/***** COLLAPSE STATE *****/
function getCollapsedSet(key){ try{ return new Set(JSON.parse(localStorage.getItem(key)||"[]")); }catch(_){ return new Set(); } }
function setCollapsedSet(key,set){ localStorage.setItem(key,JSON.stringify([...set])); }
const collapsedPolygons=getCollapsedSet('collapsedPolygons_v1');
const collapsedCats=getCollapsedSet('collapsedCats_v1');

/***** MAP + MARKERS *****/
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let cluster=L.markerClusterGroup(); map.addLayer(cluster);
function clearMarkers(){cluster.clearLayers();}
function markerIcon(cat,it){
  if(it && it.iconData) return L.icon({iconUrl:it.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  if(cat.iconData) return L.icon({iconUrl:cat.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  const color=cat.color||"#3388ff",shape=cat.shape||"circle";let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html:html,iconSize:[20,20],iconAnchor:[10,10]});
}
function addMarkerForItem(it,cat){
  if(it.lat==null||it.lng==null) return;
  const m=L.marker([it.lat,it.lng],{icon:markerIcon(cat,it),_itemId:it.id,_catId:cat.id});
  m.bindPopup(`<b>${it.name}</b><br/><button onclick="removeMarkerById('${it.id}')">üóë –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É</button>`);
  cluster.addLayer(m);
}
window.removeMarkerById=function(id){
  for(const c of db.categories){ const it=(c.items||[]).find(x=>x.id===id); if(it){it.lat=null;it.lng=null;break;} }
  const toRemove=[]; cluster.eachLayer(m=>{ if(m.options && m.options._itemId===id) toRemove.push(m); });
  toRemove.forEach(m=>cluster.removeLayer(m));
  commit({action:"–£–¥–∞–ª–µ–Ω–∞ –º–µ—Ç–∫–∞",details:`itemId=${id}`});
};

/***** POLYGONS + HISTORY PER POLYGON *****/
const polyFG=new L.FeatureGroup(); map.addLayer(polyFG);
const polyIndex=new Map();
const historyById=new Map(); // id -> {stack:[],index}
function getHistoryPoly(id){ if(!historyById.has(id)) historyById.set(id,{stack:[],index:-1}); return historyById.get(id); }
function pushHistoryPoly(p){
  const h=getHistoryPoly(p.id);
  const snap=JSON.parse(JSON.stringify(p.geojson));
  if(h.index<h.stack.length-1) h.stack.splice(h.index+1);
  h.stack.push(snap); h.index=h.stack.length-1;
}
function applyHistoryPoly(p,dir){
  const h=getHistoryPoly(p.id), next=h.index+dir;
  if(next<0||next>=h.stack.length) return false;
  h.index=next; const snap=h.stack[h.index];
  p.geojson=JSON.parse(JSON.stringify(snap));
  const old=polyIndex.get(p.id); if(old) polyFG.removeLayer(old);
  const l=layerFromGeo(p.geojson,p.color); polyFG.addLayer(l); polyIndex.set(p.id,l);
  if(p.visible===false) map.removeLayer(l);
  return true;
}
function layerFromGeo(geo,c){ let l=null; L.geoJSON(geo,{style:{color:c||'#ff4d4f',weight:2,fillOpacity:.12}}).eachLayer(x=>l=x); return l; }
function rebuildPolys(){
  polyIndex.clear(); polyFG.clearLayers();
  for(const p of db.polygons){
    if(!p.geojson) continue;
    const l=layerFromGeo(p.geojson,p.color); if(!l) continue;
    polyFG.addLayer(l); polyIndex.set(p.id,l);
    if(p.visible===false) map.removeLayer(l);
  }
  updatePolygonVisibility();
}

/***** POLYGON UI *****/
const $polyList=document.getElementById('polyList');
const $polyName=document.getElementById('polyName');
const $polyColor=document.getElementById('polyColor');
const $polySearch=document.getElementById('polySearch');

document.getElementById('btnPolyNew').onclick=()=>{
  if(!(window.L && L.Draw && L.Draw.Polygon)) return alert('Leaflet.draw –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
  new L.Draw.Polygon(map,{shapeOptions:{color:$polyColor.value||'#ff4d4f',weight:2,fillOpacity:.12}}).enable();
};

let polyEditToolbar=null, polyEditing=false, polyEditingTargetId=null;

document.getElementById('btnPolyEdit').onclick=()=>{
  if(!(window.L && L.EditToolbar && L.EditToolbar.Edit)) return alert('Leaflet.draw –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
  if(polyEditing) return;
  polyEditingTargetId=null; localStorage.removeItem('polyEditingId');
  polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
  polyEditToolbar.enable(); polyEditing=true;
};
document.getElementById('btnPolyStop').onclick=stopPolyEditing;
function stopPolyEditing(){
  if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); polyEditing=false; if(L.Draw&&L.Draw.Event&&L.Draw.Event.EDITSTOP) map.fire(L.Draw.Event.EDITSTOP); }
  polyEditingTargetId=null; localStorage.removeItem('polyEditingId');
}
document.getElementById('btnPolyUndo').onclick=()=>{
  if(!polyEditingTargetId) return;
  const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
  if(applyHistoryPoly(p,-1)){ save(db).then(()=>{ renderPolyList(); updatePolygonVisibility(); }); }
};
document.getElementById('btnPolyRedo').onclick=()=>{
  if(!polyEditingTargetId) return;
  const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
  if(applyHistoryPoly(p,+1)){ save(db).then(()=>{ renderPolyList(); updatePolygonVisibility(); }); }
};

/* –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è Leaflet.draw ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã */
if(L.Draw && L.Draw.Event){
  if(L.Draw.Event.CREATED){
    map.on(L.Draw.Event.CREATED,async e=>{
      if(!(e.layer instanceof L.Polygon)) return;
      const layer=e.layer; layer.setStyle({color:$polyColor.value||'#ff4d4f',weight:2,fillOpacity:.12});
      polyFG.addLayer(layer);
      const rec={id:uid(),name:($polyName?.value||`–ü–æ–ª–∏–≥–æ–Ω ${db.polygons.length+1}`).trim(),color:$polyColor?.value||'#ff4d4f',visible:true,geojson:layer.toGeoJSON()};
      db.polygons.push(rec); polyIndex.set(rec.id,layer); pushHistoryPoly(rec);
      await commit({action:"–°–æ–∑–¥–∞–Ω –ø–æ–ª–∏–≥–æ–Ω",details:`id=${rec.id}, name=${rec.name}`});
    });
  }
  if(L.Draw.Event.EDITSTOP){
    map.on(L.Draw.Event.EDITSTOP,async ()=>{
      for(const p of db.polygons){ const l=polyIndex.get(p.id); if(l) p.geojson=l.toGeoJSON(); }
      await commit({action:"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ",details:"snapshot"});
    });
  }
  if(L.Draw.Event.EDITVERTEX){
    map.on(L.Draw.Event.EDITVERTEX, ()=>{
      if(!polyEditingTargetId) return;
      const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
      const l=polyIndex.get(p.id); if(!l) return;
      p.geojson=l.toGeoJSON(); pushHistoryPoly(p);
    });
  }
}

function setEditingTarget(id){
  polyEditingTargetId=id||null;
  if(id) localStorage.setItem('polyEditingId',id); else localStorage.removeItem('polyEditingId');
  renderPolyList(); updatePolygonVisibility();
}

function renderPolyList(){
  if(!$polyList) return;
  const q=($polySearch?.value||"").trim().toLowerCase();
  const prevScroll=$polyList.scrollTop; $polyList.innerHTML='';

  db.polygons.filter(p=>!q || (p.name||'').toLowerCase().includes(q)).forEach(p=>{
    const wrapper=document.createElement('div'); wrapper.className='item'+(p.id===polyEditingTargetId?' active':'');
    if(collapsedPolygons.has(p.id)) wrapper.classList.add('collapsed');

    const head=document.createElement('div'); head.className='collapse-head';
    const caret=document.createElement('div'); caret.className='caret';
    const title=document.createElement('div'); title.className='name'; title.textContent=p.name||'–ü–æ–ª–∏–≥–æ–Ω';
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`id: ${p.id}`;
    head.append(caret,title,meta);
    head.onclick=()=>{
      if(collapsedPolygons.has(p.id)) collapsedPolygons.delete(p.id); else collapsedPolygons.add(p.id);
      setCollapsedSet('collapsedPolygons_v1',collapsedPolygons);
      wrapper.classList.toggle('collapsed');
    };
    wrapper.appendChild(head);

    const body=document.createElement('div'); body.className='section-body';
    const row1=document.createElement('div'); row1.className='item-row';
    const nameInput=document.createElement('input'); nameInput.value=p.name||'–ü–æ–ª–∏–≥–æ–Ω';
    nameInput.onchange=async()=>{p.name=nameInput.value.trim()||p.name; await commit({action:"–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –ø–æ–ª–∏–≥–æ–Ω",details:`id=${p.id}, name=${p.name}`});};
    const color=document.createElement('input'); color.type='color'; color.value=p.color||'#ff4d4f';
    color.onchange=async()=>{p.color=color.value;const l=polyIndex.get(p.id);if(l&&l.setStyle) l.setStyle({color:p.color});await save(db);};
    row1.append(nameInput,color);

    const row2=document.createElement('div'); row2.className='tools';
    const toggle=document.createElement('button'); toggle.textContent=p.visible!==false?'–°–∫—Ä—ã—Ç—å':'–ü–æ–∫–∞–∑–∞—Ç—å';
    toggle.onclick=async()=>{p.visible=!(p.visible!==false); const l=polyIndex.get(p.id); if(l){ if(p.visible) l.addTo(map); else map.removeLayer(l);} await commit({action:"–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–∏–≥–æ–Ω–∞",details:`id=${p.id}, visible=${p.visible}`});};
    const focus=document.createElement('button'); focus.textContent='–§–æ–∫—É—Å';
    focus.onclick=()=>{const l=polyIndex.get(p.id);if(l){ l.addTo(map); map.fitBounds(l.getBounds()); }};
    const editBtn=document.createElement('button'); editBtn.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    editBtn.onclick=()=>{
      const l=polyIndex.get(p.id);
      if(l){
        l.addTo(map);
        if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); }
        if(L.EditToolbar && L.EditToolbar.Edit){
          polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
          polyEditToolbar.enable(); polyEditing=true;
          polyFG.eachLayer(x=>{
            if(x===l){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
            else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
          });
        }
        setEditingTarget(p.id); map.fitBounds(l.getBounds());
        const h=getHistoryPoly(p.id); if(h.stack.length===0){ pushHistoryPoly(p); }
      }
    };
    const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger';
    del.onclick=async()=>{if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω?')) return; const l=polyIndex.get(p.id); if(l) polyFG.removeLayer(l); polyIndex.delete(p.id); db.polygons=db.polygons.filter(x=>x.id!==p.id); await lfGeo.removeItem(p.id); await commit({action:"–£–¥–∞–ª—ë–Ω –ø–æ–ª–∏–≥–æ–Ω",details:`id=${p.id}`}); if(polyEditingTargetId===p.id){ setEditingTarget(null);} };

    row2.append(toggle,focus,editBtn,del);
    body.append(row1,row2);
    wrapper.appendChild(body);

    $polyList.appendChild(wrapper);
  });

  $polyList.scrollTop=prevScroll;
}
$polySearch.oninput=renderPolyList;

/***** SELECTED STATE + FILTERING *****/
let selected={};
function saveSelected(){
  const out={};
  for(const [k,v] of Object.entries(selected)){ out[k]=v instanceof Set?Array.from(v):v; }
  localStorage.setItem('selected_v1',JSON.stringify(out));
}
function loadSelected(){
  try{
    const raw=localStorage.getItem('selected_v1'); if(!raw) return;
    const obj=JSON.parse(raw)||{}; selected={};
    for(const [k,v] of Object.entries(obj)){
      const cat=(db?.categories||[]).find(c=>c.id===k);
      if(cat&&cat.type==='checkbox') selected[k]=new Set(Array.isArray(v)?v:[]);
      else selected[k]=v||null;
    }
  }catch(_){selected={};}
}
function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId); const v=selected[catId];
  if(!v) return []; return(cat&&cat.type==='checkbox')?Array.from(v):(v?[v]:[]);
}
function anySelection(){
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    if(ids.length>0) return true;
  }
  return false;
}
function getSelectedItemNames(){
  const names=new Set();
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    if(!ids.length) continue;
    (cat.items||[]).forEach(it=>{if(ids.includes(it.id)) names.add(it.name);});
  }
  return names;
}
function updatePolygonVisibility(){
  const names=getSelectedItemNames();
  for(const p of db.polygons){
    const layer=polyIndex.get(p.id); if(!layer) continue;
    const filtered=(p.visible!==false)&&(names.size?names.has(p.name):true);
    const forceVisible=(polyEditingTargetId && p.id===polyEditingTargetId);
    if(filtered||forceVisible) layer.addTo(map); else map.removeLayer(layer);
  }
}
</script>
<script>
/***** –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ò–ö–û–ù–û–ö (Feather) *****/
const $icoOverlay=document.getElementById('icoOverlay');
const $icoClose=document.getElementById('icoClose');
const $icoSearch=document.getElementById('icoSearch');
const $icoGrid=document.getElementById('icoGrid');
const $icoApply=document.getElementById('icoApply');
const $icoCancel=document.getElementById('icoCancel');

let icoCtx=null; // {mode:'cat'|'item'|'mass', cat, itemIds:Set}
let selectedIconName=null;

function svgToDataUri(svg){ return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg); }

function openIconPicker(ctx){
  icoCtx=ctx; selectedIconName=null;
  $icoSearch.value=""; renderIconGrid();
  $icoOverlay.style.display='flex'; document.body.style.overflow='hidden';
}
function closeIconPicker(){ icoCtx=null; selectedIconName=null; $icoOverlay.style.display='none'; document.body.style.overflow=''; }

function renderIconGrid(){
  const q=($icoSearch.value||"").trim().toLowerCase();
  const all=Object.keys(feather.icons||{});
  const list=all.filter(n=>!q || n.includes(q)).slice(0,200); // –Ω–µ –¥—É—à–∏–º DOM
  $icoGrid.innerHTML = list.map(n=>`<div class="modal-item" data-name="${n}" style="cursor:pointer">
      <span class="preview-icon"><i data-feather="${n}"></i></span>
      <div>${n}</div>
    </div>`).join('');
  // –∏–Ω–∂–µ–∫—Ç–∏–º –∏–∫–æ–Ω–∫–∏
  if(window.feather && feather.replace) feather.replace({width:18,height:18,stroke:'#fff'});
  // –≤—ã–±–æ—Ä
  [...$icoGrid.children].forEach(cell=>{
    cell.onclick=()=>{
      [...$icoGrid.children].forEach(x=>x.style.outline='');
      cell.style.outline='2px solid var(--accent)';
      selectedIconName = cell.dataset.name;
    };
  });
}
$icoSearch.oninput=renderIconGrid;
$icoClose.onclick=closeIconPicker;
$icoCancel.onclick=closeIconPicker;
$icoApply.onclick=async ()=>{
  if(!icoCtx || !selectedIconName) return closeIconPicker();
  const svg = feather.icons[selectedIconName].toSvg({stroke:'#fff'});
  const data = svgToDataUri(svg);

  if(icoCtx.mode==='cat'){
    icoCtx.cat.iconData=data;
    await commit({action:"–ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",details:`cat=${icoCtx.cat.name}, icon=${selectedIconName}`});
  }else if(icoCtx.mode==='item'){
    const it = icoCtx.cat.items.find(x=>x.id===icoCtx.itemId);
    if(it){ it.iconData=data; await commit({action:"–ò–∫–æ–Ω–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞",details:`cat=${icoCtx.cat.name}, item=${it.name}, icon=${selectedIconName}`}); }
  }else if(icoCtx.mode==='mass'){
    icoCtx.cat.items.forEach(it=>{ if(icoCtx.itemIds.has(it.id)) it.iconData=data; });
    await commit({action:"–ú–∞—Å—Å–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞",details:`cat=${icoCtx.cat.name}, count=${icoCtx.itemIds.size}, icon=${selectedIconName}`});
  }
  closeIconPicker();
};

/***** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ò–Ω—Ñ–æ) *****/
const $infoOverlay=document.getElementById('infoOverlay');
const $infoClose=document.getElementById('infoClose');
const $infoBox=document.getElementById('infoBox');
document.getElementById('btnInfo').onclick=()=>{
  const cats=db.categories.length;
  let items=0, itemsWithCoords=0;
  db.categories.forEach(c=>{items+=(c.items||[]).length;(c.items||[]).forEach(it=>{ if(it.lat!=null&&it.lng!=null) itemsWithCoords++; });});
  const polys=(db.polygons||[]).length;
  $infoBox.innerHTML=`
    <div class="list">
      <div class="item"><div class="item-row"><div class="left"><div class="name">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div><div class="meta">–≤—Å–µ–≥–æ</div></div><div>${cats}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">–≠–ª–µ–º–µ–Ω—Ç–æ–≤</div><div class="meta">–≤—Å–µ–≥–æ</div></div><div>${items}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">–° –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏</div><div class="meta">—ç–ª–µ–º–µ–Ω—Ç—ã</div></div><div>${itemsWithCoords}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">–ü–æ–ª–∏–≥–æ–Ω–æ–≤</div><div class="meta">–≤—Å–µ–≥–æ</div></div><div>${polys}</div></div></div>
    </div>`;
  $infoOverlay.style.display='flex'; document.body.style.overflow='hidden';
};
$infoClose.onclick=()=>{$infoOverlay.style.display='none'; document.body.style.overflow='';};

/***** –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ª–æ–≥) *****/
async function logHistory(action,details){
  const rec={id:uid(),ts:new Date().toISOString(),action,details};
  let arr=await lfHistory.getItem("records")||[];
  arr.push(rec);
  if(arr.length>400) arr.shift();
  await lfHistory.setItem("records",arr);
}
async function renderHistory(){
  const box=document.getElementById("historyBox");
  const arr=(await lfHistory.getItem("records")||[]).slice().reverse();
  box.innerHTML=arr.map(r=>`
    <div class="item">
      <div class="item-row">
        <div class="left">
          <div class="name">${r.action}</div>
          <div class="meta">${new Date(r.ts).toLocaleString()}</div>
        </div>
        <div>${(r.details||"")}</div>
      </div>
    </div>`).join("");
}
document.getElementById("btnHistory").onclick=async()=>{
  await renderHistory();
  document.getElementById("historyOverlay").style.display="flex";
  document.body.style.overflow="hidden";
};
document.getElementById("historyClose").onclick=()=>{
  document.getElementById("historyOverlay").style.display="none";
  document.body.style.overflow="";
};

/***** –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ *****/
function buildAllNamesIndex(){
  const set=new Set(); db.categories.forEach(c=> (c.items||[]).forEach(it=> set.add((it.name||"").trim().toLowerCase()) )); return set;
}
function attachSuggestions(input){
  const wrap=document.createElement('div'); wrap.style.position='relative'; input.parentNode.insertBefore(wrap,input); wrap.appendChild(input);
  const sug=document.createElement('div'); sug.className='suggestions'; sug.style.display='none'; wrap.appendChild(sug);
  input.addEventListener('input',()=>{
    const q=(input.value||"").trim().toLowerCase();
    if(!q){sug.style.display='none';sug.innerHTML='';return;}
    const names=[...buildAllNamesIndex()].filter(n=>n.includes(q)).slice(0,30);
    if(names.length===0){sug.style.display='none';sug.innerHTML='';return;}
    sug.innerHTML=names.map(n=>`<div>${n}</div>`).join(''); sug.style.display='block';
  });
  sug.addEventListener('click',e=>{ if(e.target && e.target.tagName==='DIV'){ input.value=e.target.textContent; sug.style.display='none'; } });
  document.addEventListener('click',ev=>{ if(!wrap.contains(ev.target)) sug.style.display='none'; });
}

/***** PREVIEW ‚Äî –∫–∞—Å–∫–∞–¥ + –º–æ–¥–∞–ª—å–Ω—ã–π –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç *****/
const $cascade=document.getElementById('cascadeBox');
const $msOverlay=document.getElementById('msOverlay');
const $msTitle=document.getElementById('msTitle');
const $msSearch=document.getElementById('msSearch');
const $msGrid=document.getElementById('msGrid');
const $msApply=document.getElementById('msApply');
const $msCancel=document.getElementById('msCancel');
const $msClose=document.getElementById('msClose');
const $msAll=document.getElementById('msAll');
const $msNone=document.getElementById('msNone');
let msCtx=null;

function dropChildrenSelections(parentCatId){
  const children=db.categories.filter(c=>c.parentCategoryId===parentCatId);
  for(const ch of children){ delete selected[ch.id]; dropChildrenSelections(ch.id); }
}

function openMultiModal(cat,items){
  msCtx={catId:cat.id, items:[...items], temp:new Set(selected[cat.id] instanceof Set?selected[cat.id]:[])};
  $msTitle.textContent=cat.name; $msSearch.value=""; renderMsGrid();
  $msOverlay.style.display='flex'; document.body.style.overflow='hidden';
}
function closeMultiModal(){ msCtx=null; $msOverlay.style.display='none'; document.body.style.overflow=''; }
function renderMsGrid(){
  if(!msCtx) return; const q=($msSearch.value||"").trim().toLowerCase(); $msGrid.innerHTML="";
  msCtx.items.filter(it=>!q || it.name.toLowerCase().includes(q)).forEach(it=>{
    const row=document.createElement('label'); row.className='modal-item';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=msCtx.temp.has(it.id);
    cb.onchange=()=>{ if(cb.checked) msCtx.temp.add(it.id); else msCtx.temp.delete(it.id); };
    const name=document.createElement('div'); name.textContent=it.name;
    row.append(cb,name); $msGrid.appendChild(row);
  });
}
$msSearch.oninput=renderMsGrid;
$msAll.onclick=()=>{ if(!msCtx) return; msCtx.items.forEach(it=>msCtx.temp.add(it.id)); renderMsGrid(); };
$msNone.onclick=()=>{ if(!msCtx) return; msCtx.temp.clear(); renderMsGrid(); };
$msApply.onclick=()=>{ if(!msCtx) return; selected[msCtx.catId]=new Set(msCtx.temp); saveSelected(); renderPreview(); updatePolygonVisibility(); closeMultiModal(); };
$msCancel.onclick=closeMultiModal; $msClose.onclick=closeMultiModal;

function renderPreview(){
  $cascade.innerHTML=""; clearMarkers();
  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel'; box.dataset.catId=cat.id;
    const head=document.createElement('div'); head.className='collapse-head';
    const caret=document.createElement('div'); caret.className='caret';
    const h=document.createElement('h4'); h.textContent=cat.name;
    head.append(caret,h); box.appendChild(head);
    const body=document.createElement('div'); body.className='section-body';

    let parentIds=null;
    if(cat.parentCategoryId){
      const parentSelected=getSelectedIds(cat.parentCategoryId);
      if(parentSelected.length===0){
        const note=document.createElement('div'); note.className='note'; note.textContent='–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏: '+(db.categories.find(c=>c.id===cat.parentCategoryId)?.name||'—Ä–æ–¥–∏—Ç–µ–ª—è');
        body.appendChild(note); box.appendChild(body); $cascade.appendChild(box); head.onclick=()=>box.classList.toggle('collapsed'); return;
      }
      parentIds=parentSelected;
    }

    let items=(cat.items||[]); if(parentIds){ items=items.filter(it=>it.parentId && parentIds.includes(it.parentId)); }
    if(items.length===0){ const note=document.createElement('div'); note.className='note gray'; note.textContent='–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤'; body.appendChild(note); box.appendChild(body); $cascade.appendChild(box); head.onclick=()=>box.classList.toggle('collapsed'); return; }

    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.style.width='100%';
      sel.innerHTML=`<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>`+items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      if(typeof selected[cat.id]==='string') sel.value=selected[cat.id]||"";
      sel.onchange=()=>{ selected[cat.id]=sel.value||null; dropChildrenSelections(cat.id); saveSelected(); renderPreview(); updatePolygonVisibility(); };
      body.appendChild(sel);
    }else{
      const multi=document.createElement('div'); multi.className='multi-select';
      const btn=document.createElement('div'); btn.className='multi-select-btn';
      const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();
      function txt(){ if(set.size===0) btn.textContent='–í—ã–±—Ä–∞—Ç—å...'; else{ const names=items.filter(x=>set.has(x.id)).map(x=>x.name); btn.textContent = names.length<=5 ? names.join(', ') : `–í—ã–±—Ä–∞–Ω–æ: ${names.length}`; } }
      txt(); btn.onclick=()=>openMultiModal(cat,items); multi.append(btn); body.appendChild(multi);
    }

    box.appendChild(body); $cascade.appendChild(box); head.onclick=()=>box.classList.toggle('collapsed');
  });

  // –º–∞—Ä–∫–µ—Ä—ã: –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±–æ—Ä ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ; –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
  let totalSelected=0;
  const selectedIdsByCat=new Map();
  for(const cat of db.categories){ const ids=getSelectedIds(cat.id); if(ids.length){ totalSelected+=ids.length; selectedIdsByCat.set(cat.id,new Set(ids)); } }

  if(totalSelected>0){
    // —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    for(const cat of db.categories){
      const idsSet=selectedIdsByCat.get(cat.id); if(!idsSet) continue;
      (cat.items||[]).forEach(it=>{ if(idsSet.has(it.id)&&it.lat!=null&&it.lng!=null) addMarkerForItem(it,cat); });
    }
  }else{
    // –≤—ã–±–æ—Ä –ø—É—Å—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
    db.categories.forEach(cat=> (cat.items||[]).forEach(it=>{ if(it.lat!=null && it.lng!=null) addMarkerForItem(it,cat); }));
  }

  updatePolygonVisibility();
}

// –≥–ª–æ–±–∞–ª—å–Ω—ã–µ Select All / Clear All (–¥–ª—è —á–µ–∫–±–æ–∫—Å-–∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ select-–∫–∞—Ç–µ–≥–æ—Ä–∏–π)
document.getElementById('btnSelectAll').onclick=()=>{ 
  db.categories.forEach(cat=>{
    if(cat.type==='checkbox'){ const ids=(cat.items||[]).map(i=>i.id); selected[cat.id]=new Set(ids); }
    if(cat.type==='select'){ if((cat.items||[])[0]) selected[cat.id]=(cat.items||[])[0].id; }
  }); saveSelected(); renderPreview(); updatePolygonVisibility();
};
document.getElementById('btnClearAll').onclick=()=>{ 
  db.categories.forEach(cat=>{ if(cat.type==='checkbox'){ selected[cat.id]=new Set(); } if(cat.type==='select'){ selected[cat.id]=null; } });
  saveSelected(); renderPreview(); updatePolygonVisibility();
};

/***** GLOBAL SEARCH *****/
const $search=document.getElementById('globalSearch');
const $results=document.getElementById('searchResults');
if($search&&$results){
  $search.oninput=()=>{
    const q=$search.value.trim().toLowerCase(); $results.innerHTML=""; if(!q) return;
    const out=[]; db.categories.forEach(cat=> (cat.items||[]).forEach(it=>{ if(it.name.toLowerCase().includes(q)) out.push({cat:cat,it:it}); }));
    out.forEach(r=>{
      const row=document.createElement('div'); row.textContent=`${r.it.name} (${r.cat.name})`;
      row.onclick=()=>{
        if(r.cat.type==='select') selected[r.cat.id]=r.it.id;
        else{ if(!(selected[r.cat.id] instanceof Set)) selected[r.cat.id]=new Set(); selected[r.cat.id].add(r.it.id); }
        saveSelected(); renderPreview(); updatePolygonVisibility();
        if(r.it.lat!=null && r.it.lng!=null) map.setView([r.it.lat,r.it.lng],14);
        $search.value=""; $results.innerHTML="";
      };
      $results.appendChild(row);
    });
  };
}
</script>
<script>
/***** –†–ï–î–ê–ö–¢–û–† (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + —ç–ª–µ–º–µ–Ω—Ç—ã) *****/
const $editor=document.getElementById('editorTab');
function moveArrayItem(arr,fromIdx,toIdx){ if(fromIdx===toIdx) return; const item=arr.splice(fromIdx,1)[0]; arr.splice(toIdx,0,item); }
function sortAZ(){ db.categories.sort((a,b)=>a.name.localeCompare(b.name)); for(const cat of db.categories){ if(cat.items) cat.items.sort((a,b)=>a.name.localeCompare(b.name)); } }

async function exportCategory(cat){
  const fullCat=JSON.parse(JSON.stringify(cat));
  // –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º iconData
  if(fullCat.iconKey && !fullCat.iconData){ try{ fullCat.iconData=await lfIcons.getItem(fullCat.iconKey)||null; }catch(e){} }
  for(const it of (fullCat.items||[])){
    if(it.iconKey && !it.iconData){ try{ it.iconData=await lfIcons.getItem(it.iconKey)||null; }catch(e){} }
  }
  const payload={ categories:[fullCat], polygons:[] };
  const safeName=(fullCat.name||'category').replace(/[^a-zA-Z0-9_\-–∞-—è–ê-–Ø ]/g,'_').slice(0,40).trim().replace(/\s+/g,'_');
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`category_${safeName}_v39_0R.json`; a.click();
}

function renderEditor(){
  $editor.innerHTML="";

  // –±–ª–æ–∫ "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è"
  const create=document.createElement('div'); create.className='panel';
  if(collapsedCats.has('newCat')) create.classList.add('collapsed');

  const head=document.createElement('div'); head.className='collapse-head';
  const caret=document.createElement('div'); caret.className='caret';
  const title=document.createElement('h3'); title.textContent='–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è';
  head.append(caret,title); create.appendChild(head);

  const body=document.createElement('div'); body.className='section-body';
  body.innerHTML=`
    <div class="row">
      <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
      <select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <select id="newCatParent">
        <option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
        ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
    </div>
    <div class="row">
      <span class="preview-icon" id="newIconPreview">icon</span>
      <input type="color" id="newCatColor" value="#3388ff"/>
      <select id="newCatShape"><option value="circle">–ö—Ä—É–≥</option><option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option><option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option></select>
      <input type="file" id="newCatIcon" accept="image/png,image/svg+xml"/>
      <button id="btnIconFeather">Feather</button>
      <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>`;
  create.appendChild(body);
  head.onclick=()=>{
    if(collapsedCats.has('newCat')) collapsedCats.delete('newCat'); else collapsedCats.add('newCat');
    setCollapsedSet('collapsedCats_v1',collapsedCats); create.classList.toggle('collapsed');
  };
  $editor.appendChild(create);

  const newIconInput=body.querySelector('#newCatIcon');
  const newIconPreview=body.querySelector('#newIconPreview');
  let newIconData=null;
  newIconInput.onchange=e=>{
    const f=e.target.files[0]; if(!f){newIconData=null;newIconPreview.textContent='icon';return;}
    const r=new FileReader(); r.onload=ev=>{newIconData=ev.target.result;newIconPreview.innerHTML=`<img src="${newIconData}">`;}; r.readAsDataURL(f);
  };
  body.querySelector('#btnIconFeather').onclick=()=>openIconPicker({mode:'cat_new',cat:null});
  body.querySelector('#btnAddCat').onclick=async()=>{
    const name=body.querySelector('#newCatName').value.trim(); if(!name) return;
    const type=body.querySelector('#newCatType').value;
    const parent=body.querySelector('#newCatParent').value||null;
    const color=body.querySelector('#newCatColor').value;
    const shape=body.querySelector('#newCatShape').value;
    const cat={id:uid(),name,type,parentCategoryId:parent,color,shape,items:[]};
    if(icoCtx && icoCtx.mode==='cat_new' && selectedIconName){ const svg=feather.icons[selectedIconName].toSvg({stroke:'#fff'}); newIconData='data:image/svg+xml;utf8,'+encodeURIComponent(svg); }
    if(newIconData){cat.iconData=newIconData;}
    db.categories.push(cat);
    await commit({action:"–°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è",details:`${name} (${type})`});
  };

  // –ø–∞–Ω–µ–ª—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  const headPanel=document.createElement('div'); headPanel.className='panel';
  const headRow=document.createElement('div'); headRow.className='row';
  const hTitle=document.createElement('h3'); hTitle.textContent='–ö–∞—Ç–µ–≥–æ—Ä–∏–∏';
  const btnSortAZ=document.createElement('button'); btnSortAZ.textContent='–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å A‚ÜíZ'; btnSortAZ.onclick=()=>{ sortAZ(); commit({action:"–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ A‚ÜíZ",details:"–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã"}); };
  headRow.append(hTitle,btnSortAZ); headPanel.appendChild(headRow); $editor.appendChild(headPanel);

  // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  db.categories.forEach(cat=>{
    const sec=document.createElement('div'); sec.className='panel draggable'; if(collapsedCats.has(cat.id)) sec.classList.add('collapsed'); sec.dataset.catId=cat.id;

    const head=document.createElement('div'); head.className='collapse-head';
    const caret=document.createElement('div'); caret.className='caret';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    head.append(caret,title);

    const toolsTop=document.createElement('div'); toolsTop.className='tools';
    const btnUp=document.createElement('button'); btnUp.textContent='‚ñ≤'; btnUp.onclick=()=>{const idx=db.categories.findIndex(c=>c.id===cat.id); if(idx>0){ moveArrayItem(db.categories,idx,idx-1); commit({action:"–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",details:`${cat.name} –≤–≤–µ—Ä—Ö`}); }};
    const btnDown=document.createElement('button'); btnDown.textContent='‚ñº'; btnDown.onclick=()=>{const idx=db.categories.findIndex(c=>c.id===cat.id); if(idx<db.categories.length-1){ moveArrayItem(db.categories,idx,idx+1); commit({action:"–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",details:`${cat.name} –≤–Ω–∏–∑`}); }};
    const btnSortItemsAZ=document.createElement('button'); btnSortItemsAZ.textContent='A‚ÜíZ —ç–ª–µ–º–µ–Ω—Ç—ã'; btnSortItemsAZ.onclick=()=>{ cat.items.sort((a,b)=>a.name.localeCompare(b.name)); commit({action:"–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ A‚ÜíZ",details:`${cat.name}`}); };
    const btnExportCat=document.createElement('button'); btnExportCat.textContent='–≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'; btnExportCat.onclick=()=>exportCategory(cat);
    toolsTop.append(btnUp,btnDown,btnSortItemsAZ,btnExportCat);

    const headWrap=document.createElement('div'); headWrap.style.display='flex'; headWrap.style.justifyContent='space-between'; headWrap.style.alignItems='center';
    headWrap.append(head,toolsTop); sec.appendChild(headWrap);

    const body=document.createElement('div'); body.className='section-body';

    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name; inpName.onchange=()=>{cat.name=inpName.value.trim(); commit({action:"–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è",details:`${cat.name}`});};
    const selType=document.createElement('select'); ['select','checkbox'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(cat.type===t)o.selected=true;selType.appendChild(o);}); selType.onchange=()=>{cat.type=selType.value; commit({action:"–¢–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑–º–µ–Ω—ë–Ω",details:`${cat.name} ‚Üí ${selType.value}`});};
    const selParent=document.createElement('select'); selParent.innerHTML=`<option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join(''); selParent.onchange=()=>{cat.parentCategoryId=selParent.value||null; commit({action:"–†–æ–¥–∏—Ç–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",details:`${cat.name} ‚Üí ${selParent.value||'–Ω–µ—Ç'}`});};
    const col=document.createElement('input'); col.type='color'; col.value=cat.color||'#3388ff'; col.onchange=()=>{cat.color=col.value; commit({action:"–¶–≤–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",details:`${cat.name}`});};
    const shape=document.createElement('select'); ['circle','square','triangle'].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if((cat.shape||'circle')===s)o.selected=true;shape.appendChild(o);}); shape.onchange=()=>{cat.shape=shape.value; commit({action:"–§–æ—Ä–º–∞ –º–∞—Ä–∫–µ—Ä–∞",details:`${cat.name} ‚Üí ${shape.value}`});};
    const iconPrev=document.createElement('span'); iconPrev.className='preview-icon'; iconPrev.innerHTML=cat.iconData?`<img src="${cat.iconData}">`:'icon';
    const iconInput=document.createElement('input'); iconInput.type='file'; iconInput.accept='image/png,image/svg+xml'; iconInput.style.display='none';
    const iconBtn=document.createElement('button'); iconBtn.textContent='üñº'; iconBtn.onclick=()=>iconInput.click();
    iconInput.onchange=e=>{
      const f=e.target.files[0];
      if(!f){ delete cat.iconData; iconPrev.textContent='icon'; commit({action:"–ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—á–∏—â–µ–Ω–∞",details:cat.name}); return; }
      const r=new FileReader(); r.onload=ev=>{ cat.iconData=ev.target.result; iconPrev.innerHTML=`<img src="${cat.iconData}">`; commit({action:"–ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–º–µ–Ω–µ–Ω–∞",details:cat.name}); }; r.readAsDataURL(f);
    };
    const iconFeatherBtn=document.createElement('button'); iconFeatherBtn.textContent='Feather'; iconFeatherBtn.onclick=()=>openIconPicker({mode:'cat',cat});
    const btnClearIcon=document.createElement('button'); btnClearIcon.textContent='‚úñ –∏–∫–æ–Ω–∫–∞'; btnClearIcon.onclick=()=>{delete cat.iconData; iconPrev.textContent='icon'; commit({action:"–ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É–¥–∞–ª–µ–Ω–∞",details:cat.name});};
    cfg.append(inpName,selType,selParent,col,shape,iconPrev,iconBtn,iconInput,iconFeatherBtn,btnClearIcon);
    body.appendChild(cfg);

    // —Å–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ + –º–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    const list=document.createElement('div'); list.className='list'; list.dataset.catId=cat.id;
    const massBar=document.createElement('div'); massBar.className='row'; massBar.style.display='none';
    const btnMassDelete=document.createElement('button'); btnMassDelete.textContent='–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
    const btnMassMove=document.createElement('button'); btnMassMove.textContent='–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤...';
    const btnMassIcon=document.createElement('button'); btnMassIcon.textContent='–ù–∞–∑–Ω–∞—á–∏—Ç—å –∏–∫–æ–Ω–∫—É';
    massBar.append(btnMassDelete,btnMassMove,btnMassIcon); body.appendChild(massBar);
    const selectedSet=new Set(); function updateMassBar(){ massBar.style.display = selectedSet.size>0 ? 'flex' : 'none'; }

    (cat.items||[]).forEach(it=>{
      const row=document.createElement('div'); row.className='item-row draggable'; row.dataset.itemId=it.id;
      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'‚Äî'} lng:${it.lng??'‚Äî'}`;
      left.append(nm,meta);

      const tools=document.createElement('div'); tools.className='tools';
      const selCb=document.createElement('input'); selCb.type='checkbox'; selCb.onchange=()=>{ if(selCb.checked) selectedSet.add(it.id); else selectedSet.delete(it.id); updateMassBar(); };
      const edit=document.createElement('button'); edit.textContent='‚úé'; edit.onclick=()=>{const nn=prompt('–ù–æ–≤–æ–µ –∏–º—è',it.name); if(nn!=null){it.name=(nn.trim()||it.name); commit({action:"–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω —ç–ª–µ–º–µ–Ω—Ç",details:`${cat.name} ‚Üí ${it.name}`});}};
      const upBtn=document.createElement('button'); upBtn.textContent='‚ñ≤'; upBtn.onclick=()=>{ const idx=cat.items.findIndex(x=>x.id===it.id); if(idx>0){ moveArrayItem(cat.items,idx,idx-1); commit({action:"–≠–ª–µ–º–µ–Ω—Ç –≤–≤–µ—Ä—Ö",details:`${cat.name} ‚Üí ${it.name}`}); } };
      const downBtn=document.createElement('button'); downBtn.textContent='‚ñº'; downBtn.onclick=()=>{ const idx=cat.items.findIndex(x=>x.id===it.id); if(idx<cat.items.length-1){ moveArrayItem(cat.items,idx,idx+1); commit({action:"–≠–ª–µ–º–µ–Ω—Ç –≤–Ω–∏–∑",details:`${cat.name} ‚Üí ${it.name}`}); } };
      const place=document.createElement('button'); place.textContent='üìç'; place.onclick=()=>{
        alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è: '+it.name);
        map.once('click', e=>{
          it.lat=e.latlng.lat; it.lng=e.latlng.lng; commit({action:"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–æ–º",details:`${it.name} (${it.lat.toFixed(5)}, ${it.lng.toFixed(5)})`}); map.setView([it.lat,it.lng],14);
        });
      };
      const manual=document.createElement('button'); manual.textContent='‚å®'; manual.title='–í–≤–µ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é';
      manual.onclick=()=>{
        const s=prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: lat,lng', (it.lat!=null&&it.lng!=null)?`${it.lat},${it.lng}`:'');
        if(!s) return; const parts=s.split(',').map(x=>parseFloat(x.trim()));
        if(parts.length!==2 || isNaN(parts[0])||isNaN(parts[1]) || parts[0]<-90||parts[0]>90||parts[1]<-180||parts[1]>180){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'); return; }
        it.lat=parts[0]; it.lng=parts[1]; meta.textContent=`lat:${it.lat} lng:${it.lng}`; commit({action:"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é",details:`${it.name} (${it.lat}, ${it.lng})`});
      };
      const setIconBtn=document.createElement('button'); setIconBtn.textContent='Feather'; setIconBtn.onclick=()=>openIconPicker({mode:'item',cat, itemId:it.id});
      const clearBtn=document.createElement('button'); clearBtn.textContent='üóë –º–µ—Ç–∫–∞'; clearBtn.onclick=()=>{it.lat=null; it.lng=null; commit({action:"–°–±—Ä–æ—à–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã",details:`${it.name}`});};
      const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger'; del.onclick=()=>{if(confirm('–£–¥–∞–ª–∏—Ç—å "'+it.name+'"?')){cat.items=cat.items.filter(x=>x.id!==it.id); commit({action:"–£–¥–∞–ª—ë–Ω —ç–ª–µ–º–µ–Ω—Ç",details:`${it.name} –∏–∑ ${cat.name}`});}};

      row.onclick=()=>{ if(it.lat!=null&&it.lng!=null){ map.setView([it.lat,it.lng],14); } };
      tools.append(selCb,edit,upBtn,downBtn,place,manual,setIconBtn,clearBtn,del);
      row.append(left,tools); list.appendChild(row);
    });
    body.appendChild(list);

    // –º–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    btnMassDelete.onclick=()=>{ if(selectedSet.size===0) return; if(!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${selectedSet.size})?`)) return; cat.items=cat.items.filter(it=>!selectedSet.has(it.id)); const n=selectedSet.size; selectedSet.clear(); commit({action:"–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ",details:`${cat.name}, count=${n}`}); };
    btnMassMove.onclick=()=>{ if(selectedSet.size===0) return; const destId=prompt('ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', (db.categories.find(c=>c.id!==cat.id)||{}).id||""); if(!destId) return;
      const dest=db.categories.find(c=>c.id===destId); if(!dest){alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');return;}
      const moving=cat.items.filter(it=>selectedSet.has(it.id)); cat.items=cat.items.filter(it=>!selectedSet.has(it.id)); dest.items.push(...moving); const n=moving.length; selectedSet.clear(); commit({action:"–ú–∞—Å—Å–æ–≤–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ",details:`${cat.name} ‚Üí ${dest.name}, count=${n}`});
    };
    btnMassIcon.onclick=()=>{ if(selectedSet.size===0) return; openIconPicker({mode:'mass',cat,itemIds:selectedSet}); };

    // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ + –ø–æ–¥—Å–∫–∞–∑–∫–∏
    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
    const parentPicker=document.createElement('select');
    if(cat.parentCategoryId){
      const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
      parentPicker.innerHTML=`<option value="">(–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+(parentCat?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }else{ parentPicker.innerHTML=`<option value="">(—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω)</option>`; }
    const addBtn=document.createElement('button'); addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å';
    addBtn.onclick=()=>{ const nm=inp.value.trim(); if(!nm) return; cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:parentPicker.value||null}); inp.value=''; commit({action:"–î–æ–±–∞–≤–ª–µ–Ω —ç–ª–µ–º–µ–Ω—Ç",details:`${nm} –≤ ${cat.name}`}); };
    addRow.append(inp,parentPicker,addBtn); body.appendChild(addRow);
    attachSuggestions(inp);

    sec.appendChild(body);
    head.onclick=()=>{
      if(collapsedCats.has(cat.id)) collapsedCats.delete(cat.id); else collapsedCats.add(cat.id);
      setCollapsedSet('collapsedCats_v1',collapsedCats); sec.classList.toggle('collapsed');
    };

    // drag&drop –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    sec.draggable=true;
    sec.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({type:'cat',catId:cat.id}));
      sec.classList.add('dragging');
    });
    sec.addEventListener('dragend',()=>sec.classList.remove('dragging'));
    sec.addEventListener('dragover',e=>{ e.preventDefault(); sec.classList.add('dropzone-hover'); });
    sec.addEventListener('dragleave',()=>sec.classList.remove('dropzone-hover'));
    sec.addEventListener('drop',e=>{
      e.preventDefault(); sec.classList.remove('dropzone-hover');
      let payload={}; try{ payload=JSON.parse(e.dataTransfer.getData('text/plain')||'{}'); }catch(_){}
      if(payload.type!=='cat') return;
      const fromIdx=db.categories.findIndex(c=>c.id===payload.catId);
      const toIdx  =db.categories.findIndex(c=>c.id===sec.dataset.catId);
      if(fromIdx<0||toIdx<0||fromIdx===toIdx) return; moveArrayItem(db.categories,fromIdx,toIdx); commit({action:"D&D –∫–∞—Ç–µ–≥–æ—Ä–∏—è",details:`${db.categories[toIdx].name}`});
    });

    // drag&drop —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    [...list.children].forEach(row=>{
      row.draggable=true;
      row.addEventListener('dragstart',e=>{
        e.dataTransfer.setData('text/plain', JSON.stringify({type:'item',catId:cat.id,itemId:row.dataset.itemId}));
        row.classList.add('dragging');
      });
      row.addEventListener('dragend',()=>row.classList.remove('dragging'));
      row.addEventListener('dragover',e=>{ e.preventDefault(); row.classList.add('dropzone-hover'); });
      row.addEventListener('dragleave',()=>row.classList.remove('dropzone-hover'));
      row.addEventListener('drop',e=>{
        e.preventDefault(); row.classList.remove('dropzone-hover');
        let payload={}; try{ payload=JSON.parse(e.dataTransfer.getData('text/plain')||'{}'); }catch(_){}
        if(payload.type!=='item' || payload.catId!==cat.id) return;
        const fromIdx=cat.items.findIndex(x=>x.id===payload.itemId);
        const toIdx  =cat.items.findIndex(x=>x.id===row.dataset.itemId);
        if(fromIdx<0||toIdx<0||fromIdx===toIdx) return; moveArrayItem(cat.items,fromIdx,toIdx); commit({action:"D&D —ç–ª–µ–º–µ–Ω—Ç",details:`${cat.name}`});
      });
    });

    $editor.appendChild(sec);
  });
}

/***** TABS *****/
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

/***** EXPORT/IMPORT/RESET *****/
document.getElementById('btnExport').onclick=async ()=>{
  const full=JSON.parse(JSON.stringify(db));
  for(const cat of full.categories){
    if(cat.iconKey && !cat.iconData){ try{ cat.iconData=await lfIcons.getItem(cat.iconKey)||null; }catch(e){} }
    for(const it of (cat.items||[])){
      if(it.iconKey && !it.iconData){ try{ it.iconData=await lfIcons.getItem(it.iconKey)||null; }catch(e){} }
    }
  }
  for(const p of (full.polygons||[])){
    if(!p.geojson){ try{ p.geojson=await lfGeo.getItem(p.id)||null; }catch(e){} }
  }
  const blob=new Blob([JSON.stringify(full,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_full_v39_0R.json'; a.click();
};

document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ()=>{
    try{
      let obj=JSON.parse(r.result); if(obj && obj.db) obj=obj.db;
      if(!Array.isArray(obj.categories)) throw new Error('–ù–µ—Ç categories');
      if(!Array.isArray(obj.polygons))   obj.polygons=[];
      for(const cat of obj.categories){
        if(!cat.id) cat.id=uid();
        if(cat.iconData){ const key=cat.iconKey||`cat_${cat.id}`; await lfIcons.setItem(key,cat.iconData); cat.iconKey=key; }
        for(const it of (cat.items||[])){
          if(!it.id) it.id=uid();
          if(it.iconData){ const key=it.iconKey||`item_${it.id}`; await lfIcons.setItem(key,it.iconData); it.iconKey=key; }
        }
      }
      for(const p of obj.polygons){ if(!p.id) p.id=uid(); if(p.geojson){ await lfGeo.setItem(p.id,p.geojson); } }
      localStorage.setItem(KEY, JSON.stringify({
        categories:obj.categories.map(c=>({
          id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId||null,
          color:c.color,shape:c.shape,iconKey:c.iconKey||null,
          items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId||null,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
        })),
        polygons:(obj.polygons||[]).map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
      }));
      db = await loadDB();
      loadSelected(); pushHistory(); renderAll(); resumeEditingIfNeeded(); updatePolygonVisibility();
      alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
      await logHistory("–ò–º–ø–æ—Ä—Ç",`categories=${db.categories.length}, polygons=${db.polygons.length}`);
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
  };
  r.readAsText(f);
};

document.getElementById('btnReset').onclick=()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){
    localStorage.removeItem(KEY);
    localStorage.removeItem('selected_v1');
    localStorage.removeItem('polyEditingId');
    localStorage.removeItem('collapsedPolygons_v1');
    localStorage.removeItem('collapsedCats_v1');
    lfIcons.clear().then(()=>{}); lfGeo.clear().then(()=>{}); lfHistory.clear().then(()=>{});
    location.reload();
  }
};

/***** MAIN RENDER *****/
async function renderAll(){
  rebuildPolys();
  renderEditor();
  renderPreview();
  renderPolyList();
}

/***** RESUME EDIT MODE *****/
function resumeEditingIfNeeded(){
  const id=localStorage.getItem('polyEditingId'); if(!id) return;
  const layer=polyIndex.get(id); if(!layer) return;

  if(L.EditToolbar && L.EditToolbar.Edit){
    if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); }
    polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
    polyEditToolbar.enable(); polyEditing=true;

    polyFG.eachLayer(x=>{
      if(x===layer){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
      else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
    });
  }

  setEditingTarget(id); layer.addTo(map); map.fitBounds(layer.getBounds());
}

/***** –°–¢–ê–†–¢ *****/
let db=null;
(async()=>{
  db = await loadDB();
  loadSelected();
  pushHistory(); // –ø–µ—Ä–≤–∏—á–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç
  await renderAll();
  resumeEditingIfNeeded();
  // feather –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ (–µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º <i data-feather>)
  if(window.feather && feather.replace) feather.replace();
})();
</script>
</body>
</html>
