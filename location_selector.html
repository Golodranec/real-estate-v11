<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v39.0R ‚Äî Feather, –∏—Å—Ç–æ—Ä–∏—è, —ç–∫—Å–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</title>

<!-- Leaflet + –ø–ª–∞–≥–∏–Ω—ã -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<!-- Feather icons (SVG-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞) -->
<script src="https://unpkg.com/feather-icons"></script>

<!-- localForage -->
<script src="https://unpkg.com/localforage@1.10.0/dist/localforage.js"></script>

<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:460px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
h4{margin:0 0 8px 0}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{border:1px solid var(--border);border-radius:8px;padding:10px;background:#111a2a}
.item-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
.note{background:#0e1524;border:1px dashed #32405a;padding:8px;border-radius:8px;color:#9fb0c8}
.note.gray{opacity:.6}
#map{width:100%;height:100%}
.preview-icon{width:20px;height:20px;border-radius:4px;border:1px solid #31405a;background:#0f1624;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview-icon img{max-width:100%;max-height:100%;display:block}

/* –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç */
.multi-select{position:relative;width:100%}
.multi-select-btn{width:100%;padding:6px 8px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.multi-select-menu{position:absolute;top:100%;left:0;right:0;background:var(--panel2);border:1px solid var(--border);border-radius:12px;z-index:2000;max-height:260px;overflow:auto;display:none;text-align:left}
.multi-select.open .multi-select-menu{display:block}
.multi-select-menu label{display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer}
.multi-select-menu label:hover{background:#1f293d}
.multi-select-menu input[type="checkbox"]{
  appearance:none;-webkit-appearance:none;
  width:16px;height:16px;border:2px solid var(--accent);border-radius:4px;
  background:#1a2234;cursor:pointer;position:relative;flex:0 0 16px
}
.multi-select-menu input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
.multi-select-menu input[type="checkbox"]:checked::after{content:"‚úî";position:absolute;top:-2px;left:2px;font-size:14px;color:#fff}

/* –ø–æ–∏—Å–∫ */
#globalSearch{width:100%;padding:6px 8px;margin-bottom:8px;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.search-results{max-height:200px;overflow:auto;margin-top:6px}
.search-results div{padding:4px 6px;border-bottom:1px solid var(--border);cursor:pointer}
.search-results div:hover{background:#1f293d}

/* –ø–æ–ª–∏–≥–æ–Ω—ã */
.item.active{border:1px solid var(--accent);background:#1f2d44}
#polySearch{width:100%;padding:6px 8px;margin:8px 0;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}

/* —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–π */
.collapse-head{display:flex;align-items:center;gap:8px;cursor:pointer}
.caret{width:22px;height:22px;border:1px solid var(--border);border-radius:6px;background:#1a2234;display:flex;align-items:center;justify-content:center}
.caret::after{content:"‚ñæ";font-size:12px;line-height:1}
.collapsed .caret::after{content:"‚ñ∏"}
.section-body{margin-top:8px}
.collapsed .section-body{display:none}

/* –º–æ–¥–∞–ª–∫–∞ –∏–∫–æ–Ω–æ–∫ */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:5000}
.modal-content{background:#1a2234;padding:20px;border-radius:12px;max-width:680px;max-height:80vh;overflow:auto;border:1px solid var(--border)}
.icon-grid{display:grid;grid-template-columns:repeat(auto-fill,40px);gap:10px}
.icon-grid div{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:8px;cursor:pointer}
.icon-grid div:hover{background:#2a334a}
#iconSearch{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff;margin-bottom:10px}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v39.0R</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <button id="btnExportCat">–≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
  <button id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnInfo">–ò–Ω—Ñ–æ</button>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Å–∫–∞–¥–∞</h3>
      <input id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º..."/>
      <div id="searchResults" class="search-results"></div>
      <div class="help">–í –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞—Ö –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∏ –°–Ω—è—Ç—å –≤—Å–µ. –ú–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º.</div>
      <div id="cascadeBox" style="margin-top:8px"></div>

      <div class="sep"></div>
      <h3>–ü–æ–ª–∏–≥–æ–Ω—ã</h3>
      <input id="polyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞"/>
      <input type="color" id="polyColor" value="#ff4d4f"/>
      <div class="row">
        <button id="btnPolyNew">–ù–æ–≤—ã–π</button>
        <button id="btnPolyEdit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btnPolyStop">–°—Ç–æ–ø</button>
        <button id="btnPolyUndo">Undo</button>
        <button id="btnPolyRedo">Redo</button>
      </div>
      <input id="polySearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª–∏–≥–æ–Ω–∞–º..."/>
      <div id="polyList" class="list"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–∫–∏ -->
<div id="iconModal" class="modal">
  <div class="modal-content">
    <input id="iconSearch" placeholder="–ü–æ–∏—Å–∫ –∏–∫–æ–Ω–∫–∏..."/>
    <div id="iconGrid" class="icon-grid"></div>
    <div style="text-align:right;margin-top:10px">
      <button id="iconCloseBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Leaflet —Å–∫—Ä–∏–ø—Ç—ã -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
/***** STORAGE + DB *****/
const KEY="dict_v39_0R";
const lfIcons=localforage.createInstance({name:"dict_icons_v390R"}); // reserve –ø–æ–¥ –≤–Ω–µ—à–Ω–∏–µ –∏–∫–æ–Ω–∫–∏, –µ—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è
const lfGeo=localforage.createInstance({name:"dict_geo_v390R"});
const lfHistory=localforage.createInstance({name:"dict_history_v390R"});

function uid(){return Math.random().toString(36).slice(2,9);}

function normalize(obj){
  if(!obj||typeof obj!=="object")obj={categories:[],polygons:[]};
  if(!Array.isArray(obj.categories)) obj.categories=[];
  if(!Array.isArray(obj.polygons)) obj.polygons=[];
  obj.categories.forEach(c=>{
    if(!("id" in c))c.id=uid();
    if(!("type" in c))c.type="select";
    if(!("items" in c))c.items=[];
    if(!("color" in c))c.color="#3388ff";
    if(!("shape" in c))c.shape="circle";
    if(!("parentCategoryId" in c))c.parentCategoryId=null;
    if(!("iconSvg" in c))c.iconSvg=null;
    c.items.forEach(it=>{
      if(!("id" in it))it.id=uid();
      if(!("name" in it))it.name="–ë–µ–∑ –∏–º–µ–Ω–∏";
      if(!("lat" in it))it.lat=null;
      if(!("lng" in it))it.lng=null;
      if(!("parentId" in it))it.parentId=null;
      if(!("iconSvg" in it))it.iconSvg=null;
    });
  });
  obj.polygons.forEach(p=>{
    if(!("id" in p))p.id=uid();
    if(!("name" in p))p.name="–ü–æ–ª–∏–≥–æ–Ω";
    if(!("color" in p))p.color="#ff4d4f";
    if(!("visible" in p))p.visible=true;
  });
}

// –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
async function logHistory(action, details){
  const rec={time:new Date().toISOString(),action,details};
  try{
    let arr=(await lfHistory.getItem("log"))||[];
    arr.push(rec);
    await lfHistory.setItem("log",arr);
  }catch(e){}
}
async function getHistoryLog(){ try{return await lfHistory.getItem("log")||[];}catch(e){return [];} }

// —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ª–µ–≥–∫–∏–π —Å–Ω–∏–º–æ–∫ –≤ LS, —Ç—è–∂–µ–ª–æ–µ ‚Äî –≤ IndexedDB)
async function save(obj=db){
  normalize(obj);
  const lite={
    categories:obj.categories.map(c=>({
      id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId,
      color:c.color,shape:c.shape,iconSvg:c.iconSvg||null,
      items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId,lat:it.lat,lng:it.lng,iconSvg:it.iconSvg||null}))
    })),
    polygons:obj.polygons.map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
  };
  localStorage.setItem(KEY,JSON.stringify(lite));
  // –ø–æ–ª–∏–≥–æ–Ω—ã –≤ IndexedDB
  for(const p of obj.polygons){ if(p.geojson) await lfGeo.setItem(p.id,p.geojson); }
}

async function loadDB(){
  const raw=localStorage.getItem(KEY);
  let obj={categories:[],polygons:[]};
  if(raw){try{obj=JSON.parse(raw)||{};}catch(e){}}
  normalize(obj);
  for(const p of obj.polygons){ if(!p.geojson){ try{p.geojson=await lfGeo.getItem(p.id)||null;}catch(e){} } }
  return obj;
}
/***** SELECTED STATE *****/
let selected={};
function saveSelected(){
  const out={}; for(const [k,v] of Object.entries(selected)){ out[k]=v instanceof Set?Array.from(v):v; }
  localStorage.setItem('selected_v39',JSON.stringify(out));
}
function loadSelected(){
  try{
    const raw=localStorage.getItem('selected_v39'); if(!raw) return;
    const obj=JSON.parse(raw)||{}; selected={};
    for(const [k,v] of Object.entries(obj)){
      const cat=(db?.categories||[]).find(c=>c.id===k);
      if(cat&&cat.type==='checkbox') selected[k]=new Set(Array.isArray(v)?v:[]);
      else selected[k]=v||null;
    }
  }catch(_){selected={};}
}

/***** COLLAPSE STATE *****/
function getCollapsedSet(key){ try{ return new Set(JSON.parse(localStorage.getItem(key)||"[]")); }catch(_){ return new Set(); } }
function setCollapsedSet(key, set){ localStorage.setItem(key, JSON.stringify([...set])); }
const collapsedPolygons = getCollapsedSet('collapsedPolygons_v39');
const collapsedCats     = getCollapsedSet('collapsedCats_v39');

/***** MAP + MARKERS *****/
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let cluster=L.markerClusterGroup();
map.addLayer(cluster);
function clearMarkers(){cluster.clearLayers();}

function svgBadge(html, color){
  return `<div style="width:22px;height:22px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid ${color}">${html}</div>`;
}
function markerIcon(cat,it=null){
  if(it && it.iconSvg) return L.divIcon({className:"custom-svg",html:svgBadge(it.iconSvg,cat.color||'#3388ff'),iconSize:[24,24],iconAnchor:[12,12]});
  if(cat.iconSvg)    return L.divIcon({className:"custom-svg",html:svgBadge(cat.iconSvg,cat.color||'#3388ff'),iconSize:[24,24],iconAnchor:[12,12]});
  const color=cat.color||"#3388ff"; const shape=cat.shape||"circle"; let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html,iconSize:[20,20],iconAnchor:[10,10]});
}
function addMarkerForItem(it,cat){
  if(it.lat==null||it.lng==null) return;
  const m=L.marker([it.lat,it.lng],{icon:markerIcon(cat,it), _itemId: it.id, title: it.name||''});
  m.bindPopup(`<b>${it.name||'–ë–µ–∑ –∏–º–µ–Ω–∏'}</b><br/>${it.lat?.toFixed?it.lat.toFixed(6):it.lat}, ${it.lng?.toFixed?it.lng.toFixed(6):it.lng}<br/><button onclick="removeMarkerById('${it.id}')">üóë –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É</button>`);
  cluster.addLayer(m);
}
window.removeMarkerById=function(id){
  for(const c of db.categories){
    const it=(c.items||[]).find(x=>x.id===id);
    if(it){it.lat=null;it.lng=null;logHistory("–£–¥–∞–ª–µ–Ω–∞ –º–µ—Ç–∫–∞", it.name||id);break;}
  }
  const toRemove=[]; cluster.eachLayer(m=>{ if(m.options?._itemId===id) toRemove.push(m); });
  toRemove.forEach(m=>cluster.removeLayer(m));
  save(); renderAll();
};

/***** FEATHER ICONS MODAL *****/
const $iconModal=document.getElementById('iconModal');
const $iconGrid=document.getElementById('iconGrid');
const $iconSearch=document.getElementById('iconSearch');
const $iconCloseBtn=document.getElementById('iconCloseBtn');

let iconApplyTarget=null; // {type:'category'|'item'|'category_new', catId, itemId}
function openIconModal(target){
  iconApplyTarget=target;
  $iconGrid.innerHTML="";
  const names=Object.keys(feather.icons);
  names.forEach(name=>{
    const wrap=document.createElement('div');
    wrap.innerHTML=feather.icons[name].toSvg({width:18,height:18,stroke:'#1f2937'});
    wrap.title=name;
    wrap.onclick=()=>{
      const svg=feather.icons[name].toSvg({width:18,height:18,stroke:'#1f2937'});
      if(target.type==='category'){
        const cat=db.categories.find(c=>c.id===target.catId);
        if(cat){cat.iconSvg=svg; save(); logHistory("–ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", `${cat.name} = ${name}`); renderAll();}
      }else if(target.type==='item'){
        const cat=db.categories.find(c=>c.id===target.catId);
        const it=cat?.items.find(i=>i.id===target.itemId);
        if(it){it.iconSvg=svg; save(); logHistory("–ò–∫–æ–Ω–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞", `${it.name} = ${name}`); renderAll();}
      }else if(target.type==='category_new'){
        // –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–∏–º —á–µ—Ä–µ–∑ –∫–æ–ª–±—ç–∫ –≤ create-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        window.__tmpNewCatIconSvg=svg;
        document.getElementById('newIconPreview').innerHTML=svg;
      }
      $iconModal.style.display='none';
    };
    $iconGrid.appendChild(wrap);
  });
  $iconSearch.value="";
  $iconSearch.oninput=()=>{
    const q=$iconSearch.value.trim().toLowerCase();
    [...$iconGrid.children].forEach(div=>{
      const title=div.title?.toLowerCase()||"";
      div.style.display=title.includes(q)?"flex":"none";
    });
  };
  $iconModal.style.display='flex';
}
function closeIconModal(){ $iconModal.style.display='none'; }
$iconCloseBtn.onclick=closeIconModal;
$iconModal.addEventListener('click',e=>{ if(e.target===$iconModal) closeIconModal(); });

/***** POLYGONS CORE + HISTORY *****/
const polyFG=new L.FeatureGroup(); map.addLayer(polyFG);
const polyIndex=new Map();
const historyById=new Map();
function getPolyHist(id){ if(!historyById.has(id)) historyById.set(id,{stack:[],index:-1}); return historyById.get(id); }
function pushPolyHist(p){ const h=getPolyHist(p.id); const snap=JSON.parse(JSON.stringify(p.geojson)); if(h.index<h.stack.length-1) h.stack.splice(h.index+1); h.stack.push(snap); h.index=h.stack.length-1; }
function applyPolyHist(p,dir){ const h=getPolyHist(p.id); const next=h.index+dir; if(next<0||next>=h.stack.length) return false; h.index=next; const snap=h.stack[h.index]; p.geojson=JSON.parse(JSON.stringify(snap)); const old=polyIndex.get(p.id); if(old) polyFG.removeLayer(old); const l=layerFromGeo(p.geojson,p.color); polyFG.addLayer(l); polyIndex.set(p.id,l); if(p.visible===false) map.removeLayer(l); return true; }
function layerFromGeo(geo,c){ let l=null; L.geoJSON(geo,{style:{color:c||'#ff4d4f',weight:2,fillOpacity:.12}}).eachLayer(x=>l=x); return l; }
function rebuildPolys(){ polyIndex.clear(); polyFG.clearLayers(); for(const p of db.polygons){ if(!p.geojson) continue; const l=layerFromGeo(p.geojson,p.color); if(!l) continue; polyFG.addLayer(l); polyIndex.set(p.id,l); if(p.visible===false) map.removeLayer(l); } updatePolygonVisibility(); }

/***** POLYGON UI *****/
const $polyList=document.getElementById('polyList');
const $polyName=document.getElementById('polyName');
const $polyColor=document.getElementById('polyColor');
const $polySearch=document.getElementById('polySearch');

document.getElementById('btnPolyNew').onclick=()=>{ new L.Draw.Polygon(map,{shapeOptions:{color:$polyColor.value||'#ff4d4f',weight:2,fillOpacity:.12}}).enable(); };
let polyEditToolbar=null, polyEditing=false, polyEditingTargetId=null;

document.getElementById('btnPolyEdit').onclick=()=>{ if(polyEditing) return; polyEditingTargetId=null; localStorage.removeItem('polyEditingId'); polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG}); polyEditToolbar.enable(); polyEditing=true; };
document.getElementById('btnPolyStop').onclick=stopEditing;
function stopEditing(){ if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); polyEditing=false; map.fire(L.Draw.Event.EDITSTOP);} polyEditingTargetId=null; localStorage.removeItem('polyEditingId'); }
document.getElementById('btnPolyUndo').onclick=()=>{ if(!polyEditingTargetId) return; const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return; if(applyPolyHist(p,-1)){ save(db); renderPolyList(); updatePolygonVisibility(); } };
document.getElementById('btnPolyRedo').onclick=()=>{ if(!polyEditingTargetId) return; const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return; if(applyPolyHist(p,+1)){ save(db); renderPolyList(); updatePolygonVisibility(); } };

map.on(L.Draw.Event.CREATED,async e=>{
  if(!(e.layer instanceof L.Polygon)) return;
  const layer=e.layer;
  layer.setStyle({color:$polyColor.value||'#ff4d4f',weight:2,fillOpacity:.12});
  polyFG.addLayer(layer);
  const rec={ id:uid(), name:($polyName?.value||`–ü–æ–ª–∏–≥–æ–Ω ${db.polygons.length+1}`).trim(), color:$polyColor?.value||'#ff4d4f', visible:true, geojson:layer.toGeoJSON() };
  db.polygons.push(rec);
  polyIndex.set(rec.id,layer);
  pushPolyHist(rec);
  await save(db);
  await logHistory("–°–æ–∑–¥–∞–Ω –ø–æ–ª–∏–≥–æ–Ω", rec.name);
  renderPolyList(); updatePolygonVisibility();
});
map.on(L.Draw.Event.EDITSTOP,async ()=>{ for(const p of db.polygons){ const l=polyIndex.get(p.id); if(l) p.geojson=l.toGeoJSON(); } await save(db); renderPolyList(); updatePolygonVisibility(); });
map.on('draw:editvertex', ()=>{ if(!polyEditingTargetId) return; const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return; const l=polyIndex.get(p.id); if(!l) return; p.geojson=l.toGeoJSON(); pushPolyHist(p); });

function setEditingTarget(id){ polyEditingTargetId=id||null; if(id) localStorage.setItem('polyEditingId',id); else localStorage.removeItem('polyEditingId'); renderPolyList(); updatePolygonVisibility(); }

function renderPolyList(){
  if(!$polyList) return;
  const q=($polySearch?.value||"").trim().toLowerCase();
  const prevScroll=$polyList.scrollTop;
  $polyList.innerHTML='';

  db.polygons.filter(p=>!q || (p.name||'').toLowerCase().includes(q)).forEach(p=>{
    const wrapper=document.createElement('div'); wrapper.className='item'+(p.id===polyEditingTargetId?' active':''); if(collapsedPolygons.has(p.id)) wrapper.classList.add('collapsed');
    const head=document.createElement('div'); head.className='collapse-head';
    const caret=document.createElement('div'); caret.className='caret';
    const title=document.createElement('div'); title.className='name'; title.textContent=p.name||'–ü–æ–ª–∏–≥–æ–Ω';
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`id: ${p.id}`;
    head.append(caret,title,meta);
    head.onclick=()=>{ if(collapsedPolygons.has(p.id)) collapsedPolygons.delete(p.id); else collapsedPolygons.add(p.id); setCollapsedSet('collapsedPolygons_v39',collapsedPolygons); wrapper.classList.toggle('collapsed'); };
    wrapper.appendChild(head);

    const body=document.createElement('div'); body.className='section-body';
    const row1=document.createElement('div'); row1.className='item-row';
    const nameInput=document.createElement('input'); nameInput.value=p.name||'–ü–æ–ª–∏–≥–æ–Ω';
    nameInput.onchange=async()=>{p.name=nameInput.value.trim()||p.name; await save(db); renderPolyList(); updatePolygonVisibility();};
    const color=document.createElement('input'); color.type='color'; color.value=p.color||'#ff4d4f';
    color.onchange=async()=>{p.color=color.value;const l=polyIndex.get(p.id);if(l&&l.setStyle) l.setStyle({color:p.color});await save(db);};
    row1.append(nameInput,color);

    const row2=document.createElement('div'); row2.className='tools';
    const toggle=document.createElement('button'); toggle.textContent=p.visible!==false?'–°–∫—Ä—ã—Ç—å':'–ü–æ–∫–∞–∑–∞—Ç—å';
    toggle.onclick=async()=>{p.visible=!(p.visible!==false); const l=polyIndex.get(p.id); if(l){ if(p.visible) l.addTo(map); else map.removeLayer(l);} await save(db); renderPolyList(); updatePolygonVisibility();};
    const focus=document.createElement('button'); focus.textContent='–§–æ–∫—É—Å'; focus.onclick=()=>{const l=polyIndex.get(p.id);if(l){ l.addTo(map); map.fitBounds(l.getBounds()); }};
    const editBtn=document.createElement('button'); editBtn.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    editBtn.onclick=()=>{const l=polyIndex.get(p.id); if(l){ l.addTo(map); if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); } polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG}); polyEditToolbar.enable(); polyEditing=true; polyFG.eachLayer(x=>{ if(x===l){ if(x.editing && !x.editing._enabled) x.editing.enable(); } else{ if(x.editing && x.editing._enabled) x.editing.disable(); } }); setEditingTarget(p.id); map.fitBounds(l.getBounds()); const h=getPolyHist(p.id); if(h.stack.length===0){ pushPolyHist(p); } } };
    const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger';
    del.onclick=async()=>{if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω?')) return; const l=polyIndex.get(p.id); if(l) polyFG.removeLayer(l); polyIndex.delete(p.id); db.polygons=db.polygons.filter(x=>x.id!==p.id); await lfGeo.removeItem(p.id); await save(db); if(polyEditingTargetId===p.id){ setEditingTarget(null);} await logHistory("–£–¥–∞–ª—ë–Ω –ø–æ–ª–∏–≥–æ–Ω", p.name); renderPolyList(); updatePolygonVisibility();};

    row2.append(toggle,focus,editBtn,del);
    body.append(row1,row2);
    wrapper.appendChild(body);
    $polyList.appendChild(wrapper);
  });

  $polyList.scrollTop=prevScroll;
}
$polySearch.oninput=renderPolyList;
/***** –ü–†–Ø–ú–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û–õ–ò–ì–û–ù–û–í –ü–û –í–´–ë–û–†–£ *****/
function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId);
  const v=selected[catId];
  if(!v) return [];
  return(cat&&cat.type==='checkbox')?Array.from(v):(v?[v]:[]);
}
function getSelectedItemNames(){
  const names=new Set();
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    if(!ids.length) continue;
    (cat.items||[]).forEach(it=>{if(ids.includes(it.id)) names.add(it.name);});
  }
  return names;
}
function updatePolygonVisibility(){
  const names=getSelectedItemNames();
  for(const p of db.polygons){
    const layer=polyIndex.get(p.id); if(!layer) continue;
    const filtered=(p.visible!==false)&&(names.size?names.has(p.name):true);
    const forceVisible=(polyEditingTargetId && p.id===polyEditingTargetId);
    if(filtered||forceVisible) layer.addTo(map); else map.removeLayer(layer);
  }
}

/***** EDITOR (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + —ç–ª–µ–º–µ–Ω—Ç—ã) *****/
const $editor=document.getElementById('editorTab');
function renderEditor(){
  $editor.innerHTML="";

  // –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
  const create=document.createElement('div'); create.className='panel';
  const head=document.createElement('div'); head.className='collapse-head';
  const caret=document.createElement('div'); caret.className='caret';
  const title=document.createElement('h3'); title.textContent='–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è';
  head.append(caret,title); create.appendChild(head);
  const body=document.createElement('div'); body.className='section-body';
  body.innerHTML=`
    <div class="row">
      <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
      <select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <select id="newCatParent">
        <option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
        ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
    </div>
    <div class="row">
      <span class="preview-icon" id="newIconPreview">icon</span>
      <input type="color" id="newCatColor" value="#3388ff"/>
      <select id="newCatShape"><option value="circle">–ö—Ä—É–≥</option><option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option><option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option></select>
      <button id="btnPickLibIcon">üñº –í—ã–±—Ä–∞—Ç—å –∏–∫–æ–Ω–∫—É</button>
      <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>`;
  create.appendChild(body);
  head.onclick=()=>{ create.classList.toggle('collapsed'); };
  $editor.appendChild(create);

  window.__tmpNewCatIconSvg=null;
  body.querySelector('#btnPickLibIcon').onclick=()=>openIconModal({type:'category_new'});

  body.querySelector('#btnAddCat').onclick=async()=>{
    const name=body.querySelector('#newCatName').value.trim(); if(!name) return;
    const type=body.querySelector('#newCatType').value;
    const parent=body.querySelector('#newCatParent').value||null;
    const color=body.querySelector('#newCatColor').value;
    const shape=body.querySelector('#newCatShape').value;
    const cat={id:uid(),name,type,parentCategoryId:parent,color,shape,items:[],iconSvg:window.__tmpNewCatIconSvg||null};
    db.categories.push(cat); await save(); await logHistory("–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è", name); renderAll();
  };

  // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å dnd –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑)
  db.categories.forEach((cat)=>{
    const sec=document.createElement('div'); sec.className='panel'; sec.draggable=true;

    const head=document.createElement('div'); head.className='collapse-head';
    const caret=document.createElement('div'); caret.className='caret';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    head.append(caret,title); sec.appendChild(head);

    const body=document.createElement('div'); body.className='section-body';

    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name;
    inpName.onchange=()=>{const old=cat.name; cat.name=inpName.value.trim(); save(); logHistory("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è", `${old} ‚Üí ${cat.name}`); renderAll();};
    const selType=document.createElement('select'); ['select','checkbox'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(cat.type===t)o.selected=true;selType.appendChild(o);});
    selType.onchange=()=>{cat.type=selType.value; save(); renderAll();};
    const selParent=document.createElement('select'); selParent.innerHTML=`<option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join('');
    selParent.onchange=()=>{cat.parentCategoryId=selParent.value||null; save(); renderAll();};
    const col=document.createElement('input'); col.type='color'; col.value=cat.color||'#3388ff'; col.onchange=()=>{cat.color=col.value; save(); renderAll();};
    const shape=document.createElement('select'); ['circle','square','triangle'].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if((cat.shape||'circle')===s)o.selected=true;shape.appendChild(o);});
    shape.onchange=()=>{cat.shape=shape.value; save(); renderAll();};
    const iconPrev=document.createElement('span'); iconPrev.className='preview-icon'; iconPrev.innerHTML=cat.iconSvg?cat.iconSvg:'icon';
    const btnLibIcon=document.createElement('button'); btnLibIcon.textContent='üñº'; btnLibIcon.onclick=()=>openIconModal({type:'category',catId:cat.id});
    const btnClearIcon=document.createElement('button'); btnClearIcon.textContent='‚úñ –∏–∫–æ–Ω–∫–∞'; btnClearIcon.onclick=()=>{cat.iconSvg=null; iconPrev.textContent='icon'; save(); renderAll();};
    cfg.append(inpName,selType,selParent,col,shape,iconPrev,btnLibIcon,btnClearIcon);
    body.appendChild(cfg);

    // —ç–ª–µ–º–µ–Ω—Ç—ã (drag&drop, –∏–∫–æ–Ω–∫–∏, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
    const list=document.createElement('div'); list.className='list';
    let dragId=null;
    (cat.items||[]).forEach((it)=>{
      const line=document.createElement('div'); line.className='item-row'; line.draggable=true;
      line.addEventListener('dragstart',e=>{dragId=it.id; line.style.opacity=.5;});
      line.addEventListener('dragend',e=>{dragId=null; line.style.opacity=1;});
      line.addEventListener('dragover',e=>{
        e.preventDefault();
        const fromIdx=cat.items.findIndex(x=>x.id===dragId);
        const toIdx=cat.items.findIndex(x=>x.id===it.id);
        if(fromIdx!==-1 && toIdx!==-1 && fromIdx!==toIdx){
          const moved=cat.items.splice(fromIdx,1)[0];
          cat.items.splice(toIdx,0,moved);
          save(); renderAll();
        }
      });

      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'‚Äî'} lng:${it.lng??'‚Äî'}`;
      left.append(nm,meta);

      const tools=document.createElement('div'); tools.className='tools';
      const edit=document.createElement('button'); edit.textContent='‚úé';
      edit.onclick=()=>{const nn=prompt('–ù–æ–≤–æ–µ –∏–º—è',it.name); if(nn!=null){const old=it.name; it.name=(nn.trim()||it.name); save(); logHistory("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω —ç–ª–µ–º–µ–Ω—Ç", `${old} ‚Üí ${it.name}`); renderAll();}};
      const iconBtn=document.createElement('button'); iconBtn.textContent='üñº'; iconBtn.onclick=()=>openIconModal({type:'item',catId:cat.id,itemId:it.id});
      const clearIconBtn=document.createElement('button'); clearIconBtn.textContent='‚úñ –∏–∫–æ–Ω–∫–∞'; clearIconBtn.onclick=()=>{it.iconSvg=null; save(); renderAll();};
      const place=document.createElement('button'); place.textContent='üìç';
      place.onclick=()=>{
        const coord=prompt('–í–≤–µ–¥–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã lat,lng –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç–æ –∏ –∫–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ', it.lat!=null&&it.lng!=null?`${it.lat},${it.lng}`:'');
        if(coord && coord.includes(',')){
          const [a,b]=coord.split(',').map(s=>parseFloat(s.trim()));
          if(!isNaN(a)&&!isNaN(b)){ it.lat=a; it.lng=b; save(); logHistory("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é", `${it.name}: ${a}, ${b}`); renderAll(); map.setView([it.lat,it.lng],14); return; }
        }
        alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è: '+it.name);
        map.once('click', e=>{
          it.lat=e.latlng.lat; it.lng=e.latlng.lng; save();
          meta.textContent=`lat:${it.lat.toFixed(5)} lng:${it.lng.toFixed(5)}`;
          addMarkerForItem(it,cat);
          map.setView([it.lat,it.lng],14);
          logHistory("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –∫–ª–∏–∫—É", `${it.name}: ${it.lat}, ${it.lng}`);
        });
      };
      const clearBtn=document.createElement('button'); clearBtn.textContent='üóë –º–µ—Ç–∫–∞';
      clearBtn.onclick=()=>{it.lat=null; it.lng=null; save(); logHistory("–°–±—Ä–æ—à–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã", it.name); renderAll();};
      const del=document.createElement('button'); del.textContent='‚ùå'; del.className='danger';
      del.onclick=()=>{if(confirm('–£–¥–∞–ª–∏—Ç—å "'+it.name+'"?')){cat.items=cat.items.filter(x=>x.id!==it.id); save(); logHistory("–£–¥–∞–ª—ë–Ω —ç–ª–µ–º–µ–Ω—Ç", it.name); renderAll();}};

      line.onclick=()=>{ if(it.lat!=null&&it.lng!=null){ map.setView([it.lat,it.lng],14); } };
      tools.append(edit,iconBtn,clearIconBtn,place,clearBtn,del);
      line.append(left,tools); list.appendChild(line);
    });
    body.appendChild(list);

    // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ (–ø–æ–¥—Å–∫–∞–∑–∫–∏ + —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
    const addRow=document.createElement('div'); addRow.className='row'; addRow.style.position='relative';
    const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
    const sugg=document.createElement('div'); sugg.className='search-results'; sugg.style.display='none'; sugg.style.position='absolute'; sugg.style.top='38px'; sugg.style.left='0'; sugg.style.right='0'; sugg.style.zIndex='2000';
    inp.oninput=()=>{
      const v=inp.value.trim().toLowerCase(); sugg.innerHTML=""; if(!v){sugg.style.display='none';return;}
      const names=new Set();
      db.categories.forEach(c=>c.items.forEach(it=>{ if(it.name && it.name.toLowerCase().includes(v) && !names.has(it.name)){ names.add(it.name); const row=document.createElement('div'); row.textContent=it.name; row.onclick=()=>{inp.value=it.name; sugg.style.display='none';}; sugg.appendChild(row);} }));
      sugg.style.display=sugg.children.length?'block':'none';
    };
    const coordInp=document.createElement('input'); coordInp.placeholder='lat,lng';
    const parentPicker=document.createElement('select');
    if(cat.parentCategoryId){
      const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
      parentPicker.innerHTML=`<option value="">(–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>`+(parentCat?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }else{
      parentPicker.innerHTML=`<option value="">(—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω)</option>`;
    }
    const addBtn=document.createElement('button'); addBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å';
    addBtn.onclick=()=>{
      const nm=inp.value.trim()||'–ù–æ–≤—ã–π'; let lat=null,lng=null;
      if(coordInp.value && coordInp.value.includes(',')){ const [a,b]=coordInp.value.split(',').map(s=>parseFloat(s.trim())); if(!isNaN(a)&&!isNaN(b)){ lat=a; lng=b; } }
      cat.items.push({id:uid(),name:nm,lat,lng,parentId:parentPicker.value||null,iconSvg:null});
      inp.value=''; coordInp.value=''; sugg.style.display='none';
      save(); logHistory("–î–æ–±–∞–≤–ª–µ–Ω —ç–ª–µ–º–µ–Ω—Ç", nm); renderAll();
    };
    addRow.append(inp,coordInp,parentPicker,addBtn, sugg);
    body.appendChild(addRow);

    // –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const catTools=document.createElement('div'); catTools.className='tools';
    const up=document.createElement('button'); up.textContent='‚ñ≤'; up.title='–í–≤–µ—Ä—Ö';
    up.onclick=()=>{const i=db.categories.findIndex(x=>x.id===cat.id); if(i>0){const mv=db.categories.splice(i,1)[0]; db.categories.splice(i-1,0,mv); save(); renderAll();}};
    const down=document.createElement('button'); down.textContent='‚ñº'; down.title='–í–Ω–∏–∑';
    down.onclick=()=>{const i=db.categories.findIndex(x=>x.id===cat.id); if(i<db.categories.length-1){const mv=db.categories.splice(i,1)[0]; db.categories.splice(i+1,0,mv); save(); renderAll();}};
    const delCat=document.createElement('button'); delCat.textContent='–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é'; delCat.className='danger';
    delCat.onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –≤—Å–µ –µ—ë —ç–ª–µ–º–µ–Ω—Ç—ã?')){ db.categories=db.categories.filter(x=>x.id!==cat.id); save(); logHistory("–£–¥–∞–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è", cat.name); renderAll(); } };
    const sortAZ=document.createElement('button'); sortAZ.textContent='A‚Üí–Ø'; sortAZ.title='–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É';
    sortAZ.onclick=()=>{ cat.items.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''),'ru',{sensitivity:'base'})); save(); renderAll(); };
    catTools.append(up,down,sortAZ,delCat);
    body.appendChild(catTools);

    // dnd –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    sec.addEventListener('dragstart',ev=>{ev.dataTransfer.setData('cid',cat.id); sec.classList.add('dragging');});
    sec.addEventListener('dragend',()=>sec.classList.remove('dragging'));
    sec.addEventListener('dragover',ev=>{
      ev.preventDefault();
      const fromId=ev.dataTransfer.getData('cid');
      const fromIdx=db.categories.findIndex(c=>c.id===fromId);
      const toIdx=db.categories.findIndex(c=>c.id===cat.id);
      if(fromIdx!==-1&&toIdx!==-1&&fromIdx!==toIdx){
        const moved=db.categories.splice(fromIdx,1)[0];
        db.categories.splice(toIdx,0,moved);
        save(); renderAll();
      }
    });

    sec.appendChild(body);
    head.onclick=()=>{ if(collapsedCats.has(cat.id)) collapsedCats.delete(cat.id); else collapsedCats.add(cat.id); setCollapsedSet('collapsedCats_v39',collapsedCats); sec.classList.toggle('collapsed'); };
    if(collapsedCats.has(cat.id)) sec.classList.add('collapsed');
    $editor.appendChild(sec);
  });
}

/***** PREVIEW (–º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç—ã –∫–∞–∫ –Ω–∞ –ê–≤–∏—Ç–æ + –∫–Ω–æ–ø–∫–∏ –í—Å–µ/–°–Ω—è—Ç—å + —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤) *****/
const $cascade=document.getElementById('cascadeBox');
function setSelectedForCat(cat, val){
  if(cat.type==='checkbox'){
    selected[cat.id]=val instanceof Set?val:new Set(Array.isArray(val)?val:(val?[val]:[]));
  }else{
    selected[cat.id]=val||null;
  }
  saveSelected();
}
function renderPreview(){
  $cascade.innerHTML="";
  const ctrl=document.createElement('div'); ctrl.className='row';
  const btnAll=document.createElement('button'); btnAll.textContent='–í—ã–±—Ä–∞—Ç—å –≤—Å—ë';
  btnAll.onclick=()=>{ db.categories.forEach(c=>{ if(c.type==='checkbox'){ setSelectedForCat(c, new Set((c.items||[]).map(i=>i.id))); } else if(c.items[0]) { setSelectedForCat(c, c.items[0].id); } }); renderPreview(); updateMarkers(); updatePolygonVisibility(); };
  const btnClr=document.createElement('button'); btnClr.textContent='–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë'; btnClr.className='danger';
  btnClr.onclick=()=>{ selected={}; saveSelected(); renderPreview(); updateMarkers(); updatePolygonVisibility(); };
  ctrl.append(btnAll,btnClr); $cascade.appendChild(ctrl);

  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel'; box.dataset.catId=cat.id;
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);

    let parentIds=null;
    if(cat.parentCategoryId){
      const parentSelected=getSelectedIds(cat.parentCategoryId);
      if(parentSelected.length===0){
        const note=document.createElement('div'); note.className='note'; note.textContent='–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏: '+(db.categories.find(c=>c.id===cat.parentCategoryId)?.name||'—Ä–æ–¥–∏—Ç–µ–ª—è');
        box.appendChild(note); $cascade.appendChild(box); return;
      }
      parentIds=parentSelected;
    }

    let items=(cat.items||[]);
    if(parentIds){ items=items.filter(it=>it.parentId && parentIds.includes(it.parentId)); }
    if(items.length===0){ const note=document.createElement('div'); note.className='note gray'; note.textContent='–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤'; box.appendChild(note); $cascade.appendChild(box); return; }

    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.style.width='100%';
      sel.innerHTML=`<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>`+items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      const cur=typeof selected[cat.id]==='string'?selected[cat.id]:null; if(cur) sel.value=cur;
      sel.onchange=()=>{ setSelectedForCat(cat, sel.value||null); renderPreview(); updateMarkers(); updatePolygonVisibility(); };
      box.appendChild(sel);
    }else{
      const multi=document.createElement('div'); multi.className='multi-select';
      const btn=document.createElement('div'); btn.className='multi-select-btn'; btn.textContent='–í—ã–±—Ä–∞—Ç—å...';
      const menu=document.createElement('div'); menu.className='multi-select-menu';
      const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();

      function updateBtnText(){
        if(set.size===0){ btn.textContent='–í—ã–±—Ä–∞—Ç—å...'; }
        else{
          const names=items.filter(x=>set.has(x.id)).map(x=>x.name);
          btn.textContent = names.length<=5 ? names.join(', ') : `–í—ã–±—Ä–∞–Ω–æ: ${names.length}`;
        }
      }
      updateBtnText();

      // —à–∞–ø–∫–∞ –º–µ–Ω—é
      const headTools=document.createElement('div'); headTools.style.display='flex'; headTools.style.gap='6px'; headTools.style.padding='6px 10px'; headTools.style.borderBottom='1px solid #1f2a40';
      const bAll=document.createElement('button'); bAll.textContent='–í—Å–µ';
      bAll.onclick=(ev)=>{ev.stopPropagation(); items.forEach(it=>set.add(it.id)); setSelectedForCat(cat,set); updateBtnText(); renderPreview(); updateMarkers(); updatePolygonVisibility();};
      const bClr=document.createElement('button'); bClr.textContent='–°–Ω—è—Ç—å'; bClr.onclick=(ev)=>{ev.stopPropagation(); set.clear(); setSelectedForCat(cat,set); updateBtnText(); renderPreview(); updateMarkers(); updatePolygonVisibility();};
      headTools.append(bAll,bClr); menu.appendChild(headTools);

      items.forEach(it=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; cb.checked=set.has(it.id);
        cb.onchange=(ev)=>{ ev.stopPropagation(); if(cb.checked) set.add(it.id); else set.delete(it.id); setSelectedForCat(cat,set); updateBtnText(); updateMarkers(); updatePolygonVisibility(); };
        lbl.append(cb,document.createTextNode(it.name)); menu.appendChild(lbl);
      });

      btn.onclick=(ev)=>{ ev.stopPropagation(); document.querySelectorAll('.multi-select.open').forEach(ms=>{ if(ms!==multi) ms.classList.remove('open'); }); multi.classList.toggle('open'); };
      multi.append(btn,menu); box.appendChild(multi);
    }

    $cascade.appendChild(box);
  });

  document.addEventListener('click', e=>{
    document.querySelectorAll('.multi-select.open').forEach(ms=>{ if(!ms.contains(e.target)) ms.classList.remove('open'); });
  });

  updateMarkers();
  updatePolygonVisibility();
}

/***** –ú–ê–†–ö–ï–†–´ –ü–û –¢–ï–ö–£–©–ï–ú–£ –§–ò–õ–¨–¢–†–£ *****/
function updateMarkers(){
  clearMarkers();
  db.categories.forEach(cat=>{
    const ids=getSelectedIds(cat.id);
    const idsSet=new Set(ids);
    (cat.items||[]).forEach(it=>{
      const allowed = (cat.type==='checkbox') ? idsSet.has(it.id) : (selected[cat.id] ? selected[cat.id]===it.id : false);
      if(allowed && it.lat!=null && it.lng!=null) addMarkerForItem(it,cat);
    });
  });
}
/***** SEARCH (—ç–ª–µ–º–µ–Ω—Ç—ã) *****/
const $search=document.getElementById('globalSearch');
const $results=document.getElementById('searchResults');
$search.oninput=()=>{
  const q=$search.value.trim().toLowerCase();
  $results.innerHTML="";
  if(!q) return;
  const out=[];
  db.categories.forEach(cat=>{
    (cat.items||[]).forEach(it=>{
      if((it.name||'').toLowerCase().includes(q)){ out.push({cat,it}); }
    });
  });
  out.forEach(r=>{
    const row=document.createElement('div');
    row.textContent=`${r.it.name} (${r.cat.name})`;
    row.onclick=()=>{
      if(r.cat.type==='select') selected[r.cat.id]=r.it.id;
      else{
        if(!(selected[r.cat.id] instanceof Set)) selected[r.cat.id]=new Set();
        selected[r.cat.id].add(r.it.id);
      }
      saveSelected(); renderPreview(); updatePolygonVisibility();
      if(r.it.lat!=null && r.it.lng!=null) map.setView([r.it.lat,r.it.lng],14);
      $search.value=""; $results.innerHTML="";
    };
    $results.appendChild(row);
  });
};

/***** EXPORT/IMPORT/INFO *****/
document.getElementById('btnExport').onclick=async ()=>{
  const full=JSON.parse(JSON.stringify(db));
  for(const p of full.polygons){ if(!p.geojson){ try{ p.geojson=await lfGeo.getItem(p.id)||null; }catch(e){} } }
  const blob=new Blob([JSON.stringify(full,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_full_v39_0R.json'; a.click();
};

document.getElementById('btnExportCat').onclick=()=>{
  const info=db.categories.map(c=>`${c.name} ‚Äî ${c.id}`).join('\n');
  const id=prompt(`–í–≤–µ–¥–∏ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:\n\n${info}\n\nID:`); if(!id) return;
  const cat=db.categories.find(c=>c.id===id.trim()); if(!cat){ alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
  const data={categories:[cat],polygons:[]};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`category_${cat.name}_v39_0R.json`; a.click();
};

document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ()=>{
    try{
      let obj=JSON.parse(r.result);
      if(obj && obj.db) obj=obj.db;
      if(!Array.isArray(obj.categories)) throw new Error('–ù–µ—Ç categories');
      if(!Array.isArray(obj.polygons))   obj.polygons=[];
      normalize(obj);
      for(const p of obj.polygons){ if(p.geojson){ await lfGeo.setItem(p.id,p.geojson); } }
      db=obj;
      await save(db);
      await logHistory("–ò–º–ø–æ—Ä—Ç", `–ö–∞—Ç–µ–≥–æ—Ä–∏–π: ${db.categories.length}, –ø–æ–ª–∏–≥–æ–Ω–æ–≤: ${db.polygons.length}`);
      renderAll();
      alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
  };
  r.readAsText(f);
};

document.getElementById('btnInfo').onclick=async ()=>{
  const cats=db.categories.length;
  const items=db.categories.reduce((acc,c)=>acc+(c.items?c.items.length:0),0);
  const withGeo=db.categories.reduce((acc,c)=>acc+c.items.filter(i=>i.lat!=null&&i.lng!=null).length,0);
  const polys=db.polygons.length;
  const hist=(await getHistoryLog())||[];
  alert(
    `–ö–∞—Ç–µ–≥–æ—Ä–∏–π: ${cats}\n`+
    `–≠–ª–µ–º–µ–Ω—Ç–æ–≤: ${items}\n`+
    `–° –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏: ${withGeo}\n`+
    `–ü–æ–ª–∏–≥–æ–Ω–æ–≤: ${polys}\n`+
    `–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: ${hist.length} –∑–∞–ø–∏—Å–µ–π`
  );
};

/***** RESET *****/
document.getElementById('btnReset').onclick=()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){
    localStorage.removeItem(KEY);
    localStorage.removeItem('selected_v39');
    localStorage.removeItem('polyEditingId');
    localStorage.removeItem('collapsedPolygons_v39');
    localStorage.removeItem('collapsedCats_v39');
    lfIcons.clear().then(()=>{}); lfGeo.clear().then(()=>{}); lfHistory.clear().then(()=>{});
    location.reload();
  }
};

/***** TABS *****/
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

/***** MAIN RENDER *****/
async function renderAll(){
  rebuildPolys();
  renderEditor();
  renderPreview();
  renderPolyList();
}

/***** START *****/
let db=null;
(async()=>{
  db = await loadDB();
  loadSelected();
  await renderAll();

  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–∞
  const id=localStorage.getItem('polyEditingId');
  if(id){
    const layer=polyIndex.get(id);
    if(layer){
      if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); }
      polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
      polyEditToolbar.enable(); polyEditing=true;
      polyFG.eachLayer(x=>{
        if(x===layer){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
        else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
      });
      setEditingTarget(id);
      layer.addTo(map);
      map.fitBounds(layer.getBounds());
    }
  }
})();
</script>
<script>feather.replace()</script>
</body>
</html>
