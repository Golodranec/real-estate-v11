<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v9</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0b0f16;--panel:#121826;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:380px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:#172133;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
input,select{width:100%;padding:6px;border-radius:6px;border:1px solid #31405a;background:#0f1624;color:#fff}
.row{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin:6px 0}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:6px;padding:6px 8px;background:#111a2a}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
.tools{display:flex;gap:6px}
#map{width:100%;height:100%}
.checkbox-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px}
.checkbox-grid label{display:flex;align-items:center;gap:4px;background:#111a2a;padding:4px 6px;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v9</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label><input type="file" id="fileImport" style="display:none"><button>–ò–º–ø–æ—Ä—Ç</button></label>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel"><h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Å–∫–∞–¥–∞</h3><div id="cascadeBox"></div></div>
  </aside>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ====== STORAGE ====== */
const KEY="dict_v9";
let db = JSON.parse(localStorage.getItem(KEY) || "null");
if(!db){
  db={categories:[]};
  save();
}
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ====== MAP ====== */
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let markers=[];
function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
function addMarker(lat,lng,label){ const m=L.marker([lat,lng]).addTo(map).bindPopup(label); markers.push(m); }

/* ====== EDITOR ====== */
const $editor=$("#editorTab");
function renderEditor(){
  $editor.innerHTML="";

  const addPanel=document.createElement("div"); addPanel.className="panel";
  addPanel.innerHTML=`<h3>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
    <div class="row"><input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/></div>
    <div class="row"><select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select></div>
    <div class="row"><select id="newCatParent"><option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join("")}</select></div>
    <div class="row"><button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>`;
  $editor.appendChild(addPanel);

  db.categories.forEach(cat=>{
    const sec=document.createElement("div"); sec.className="panel";
    const h=document.createElement("h3"); h.textContent=cat.name+` (${cat.type})`; sec.appendChild(h);

    const optsRow=document.createElement("div"); optsRow.className="row";
    const editBtn=document.createElement("button"); editBtn.textContent="‚úé –†–µ–¥.";
    editBtn.onclick=()=>{ 
      const nn=prompt("–ù–∞–∑–≤–∞–Ω–∏–µ",cat.name); if(!nn) cat.name=cat.name; else cat.name=nn;
      const nt=prompt("–¢–∏–ø (select/checkbox)",cat.type); if(nt==="select"||nt==="checkbox") cat.type=nt;
      const pid=prompt("id —Ä–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ –ø—É—Å—Ç–æ",cat.parentCategoryId||"");
      cat.parentCategoryId=pid||null;
      save(); renderAll();
    };
    const delBtn=document.createElement("button"); delBtn.textContent="‚ùå"; delBtn.className="danger";
    delBtn.onclick=()=>{ if(confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?")){ db.categories=db.categories.filter(c=>c.id!==cat.id); save(); renderAll(); } };
    optsRow.append(editBtn,delBtn); sec.appendChild(optsRow);

    const list=document.createElement("div"); list.className="list";
    cat.items?.forEach((it,idx)=>{
      const line=document.createElement("div"); line.className="item";
      const name=document.createElement("div"); name.className="name"; name.textContent=it.name;
      const tools=document.createElement("div"); tools.className="tools";
      const edit=document.createElement("button"); edit.textContent="‚úé";
      edit.onclick=()=>{ const nn=prompt("–ù–æ–≤–æ–µ –∏–º—è",it.name); if(nn){ it.name=nn; save(); renderAll(); } };
      const place=document.createElement("button"); place.textContent="üìç";
      place.onclick=()=>{ alert("–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è "+it.name); map.once("click", e=>{it.lat=e.latlng.lat; it.lng=e.latlng.lng; save(); renderAll();}); };
      const del=document.createElement("button"); del.textContent="‚ùå"; del.className="danger";
      del.onclick=()=>{ if(confirm("–£–¥–∞–ª–∏—Ç—å?")){ cat.items.splice(idx,1); save(); renderAll(); } };
      tools.append(edit,place,del); line.append(name,tools); list.appendChild(line);
    });
    sec.appendChild(list);

    const row=document.createElement("div"); row.className="row";
    const inp=document.createElement("input"); inp.placeholder="–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç";
    const parSel=document.createElement("select");
    parSel.innerHTML=`<option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>${(db.categories.find(c=>c.id===cat.parentCategoryId)?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join("")}`;
    const btn=document.createElement("button"); btn.textContent="+";
    btn.onclick=()=>{ const nm=inp.value.trim()||"–ù–æ–≤—ã–π"; cat.items=cat.items||[]; cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:parSel.value||null}); save(); renderAll(); };
    row.append(inp,parSel,btn); sec.appendChild(row);

    $editor.appendChild(sec);
  });

  $("#btnAddCat").onclick=()=>{ 
    const nm=$("#newCatName").value.trim(); if(!nm) return;
    const tp=$("#newCatType").value;
    const pid=$("#newCatParent").value||null;
    db.categories.push({id:uid(),name:nm,type:tp,parentCategoryId:pid,items:[]});
    save(); renderAll();
  };
}

/* ====== PREVIEW ====== */
const $cascade=$("#cascadeBox");
function renderPreview(){
  $cascade.innerHTML=""; clearMarkers();
  let selected={};
  function renderLevel(cat,parentVal){
    const wrap=document.createElement("div"); wrap.className="panel";
    const title=document.createElement("h4"); title.textContent=cat.name; wrap.appendChild(title);
    let items=(cat.items||[]).filter(it=>(!cat.parentCategoryId)||it.parentId===parentVal);
    if(cat.type==="select"){
      const sel=document.createElement("select");
      sel.innerHTML="<option value=''>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>"+items.map(it=>`<option value='${it.id}'>${it.name}</option>`).join("");
      sel.onchange=()=>{ selected[cat.id]=sel.value; renderCascade(); };
      wrap.appendChild(sel);
    }else if(cat.type==="checkbox"){
      const grid=document.createElement("div"); grid.className="checkbox-grid";
      items.forEach(it=>{
        const label=document.createElement("label");
        const cb=document.createElement("input"); cb.type="checkbox"; cb.value=it.id;
        cb.onchange=()=>{ if(cb.checked){ if(it.lat&&it.lng) addMarker(it.lat,it.lng,it.name); }else{ renderCascade(); } };
        label.append(cb,document.createTextNode(it.name)); grid.appendChild(label);
      });
      wrap.appendChild(grid);
    }
    $cascade.appendChild(wrap);
  }
  function renderCascade(){
    $cascade.innerHTML=""; clearMarkers();
    let chain=[...db.categories];
    let parentVal=null;
    for(const cat of chain){
      if(cat.parentCategoryId && !selected[cat.parentCategoryId]) break;
      parentVal=selected[cat.parentCategoryId]||null;
      renderLevel(cat,parentVal);
    }
  }
  renderCascade();
}

/* ====== UTILS ====== */
function renderAll(){ renderEditor(); renderPreview(); }
function $(s){ return document.querySelector(s); }

/* ====== EXPORT/IMPORT ====== */
$("#btnExport").onclick=()=>{ const blob=new Blob([JSON.stringify(db,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="dict_v9.json"; a.click(); };
$("#fileImport").onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ db=JSON.parse(r.result); save(); renderAll(); alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!"); }catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞"); } }; r.readAsText(f); };
$("#btnReset").onclick=()=>{ if(confirm("–û—á–∏—Å—Ç–∏—Ç—å?")){ localStorage.removeItem(KEY); location.reload(); } };

/* ====== TAB SWITCH ====== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const which=tab.dataset.tab;
    $("#editorTab").style.display=(which==="editor")?"block":"none";
    $("#previewTab").style.display=(which==="preview")?"block":"none";
  };
});

/* ====== INIT ====== */
renderAll();
</script>
</body>
</html>
