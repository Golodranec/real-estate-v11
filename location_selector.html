<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v38.6 ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω—ã–π + IndexedDB</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
:root{
  --bg:#0b0f16;--panel:#121826;--panel2:#172133;--border:#273248;
  --text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}

/* header */
header{display:flex;gap:8px;align-items:center;padding:10px 12px;
  background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);
  background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;
  padding:3px 8px;font-weight:700}

/* tabs */
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}

/* layout */
main{display:grid;grid-template-columns:460px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);
  border-radius:12px;padding:10px;margin-bottom:10px}
h3,h4{margin:0 0 8px 0}

/* inputs */
input,select,textarea{
  width:100%;padding:8px;border-radius:8px;
  border:1px solid #31405a;background:#0f1624;color:#e7f1ff
}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;
  border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:#111a2a}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px}
.drag-handle{cursor:grab;opacity:.8}
.dragging{opacity:.5;outline:1px dashed var(--accent)}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
.note{background:#0e1524;border:1px dashed #32405a;padding:8px;border-radius:8px;color:#9fb0c8}
.note.gray{opacity:.6}
#map{width:100%;height:100%}

/* preview icons */
.preview-icon{width:20px;height:20px;border-radius:4px;border:1px solid #31405a;
  background:#0f1624;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview-icon img{max-width:100%;max-height:100%;display:block}

/* –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç */
.multi-select{position:relative;width:100%}
.multi-select-btn{width:100%;padding:6px 8px;background:#1a2234;
  border:1px solid var(--border);border-radius:6px;cursor:pointer;text-align:left;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.multi-select-menu{position:absolute;top:100%;left:0;right:0;background:var(--panel2);
  border:1px solid var(--border);border-radius:12px;z-index:2000;max-height:260px;
  overflow:auto;display:none;text-align:left}
.multi-select.open .multi-select-menu{display:block}
.multi-select-menu label{display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer}
.multi-select-menu label:hover{background:#1f293d}
.multi-select-menu input[type="checkbox"]{
  appearance:none;-webkit-appearance:none;
  width:16px;height:16px;border:2px solid var(--accent);border-radius:4px;
  background:#1a2234;cursor:pointer;position:relative;flex:0 0 16px
}
.multi-select-menu input[type="checkbox"]:checked{
  background:var(--accent);border-color:var(--accent);
}
.multi-select-menu input[type="checkbox"]:checked::after{
  content:"‚úî";position:absolute;top:-2px;left:2px;font-size:14px;color:#fff
}

/* –ø–æ–∏—Å–∫ */
#globalSearch{width:100%;padding:6px 8px;margin-bottom:8px;
  border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.search-results{max-height:200px;overflow:auto;margin-top:6px}
.search-results div{padding:4px 6px;border-bottom:1px solid var(--border);cursor:pointer}
.search-results div:hover{background:#1f293d}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v38.6</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <button id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Å–∫–∞–¥–∞</h3>
      <input id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º..."/>
      <div id="searchResults" class="search-results"></div>
      <div class="help">–î–æ 5 –Ω–∞–∑–≤–∞–Ω–∏–π –≤–∏–¥–Ω–æ –≤ –∫–Ω–æ–ø–∫–µ, –¥–∞–ª—å—à–µ —Å—á—ë—Ç—á–∏–∫. –ö–ª–∏–∫–∏ –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç –º–µ–Ω—é.</div>
      <div id="cascadeBox" style="margin-top:8px"></div>
    </div>
    <div class="panel">
      <h3>–ü–æ–ª–∏–≥–æ–Ω—ã</h3>
      <input id="polyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞"/>
      <div class="row">
        <button id="btnNewPoly">–ù–æ–≤—ã–π</button>
        <button id="btnEditPoly">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btnStopPoly">–°—Ç–æ–ø</button>
      </div>
      <div id="polyList" class="list" style="margin-top:8px"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
/***** STORAGE (IndexedDB + fallback) *****/
const DB_NAME="dict_v38_6";
const STORE_NAME="data";
let dbCache=null;

// –æ—Ç–∫—Ä—ã—Ç—å IndexedDB
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains(STORE_NAME)){
        db.createObjectStore(STORE_NAME);
      }
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}

// —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
async function saveDB(data){
  try{
    const db=await openDB();
    const tx=db.transaction(STORE_NAME,"readwrite");
    tx.objectStore(STORE_NAME).put(data,"root");
    return tx.complete;
  }catch(err){
    console.warn("IndexedDB save failed, fallback localStorage",err);
    localStorage.setItem(DB_NAME,JSON.stringify(data));
  }
}

// –∑–∞–≥—Ä—É–∑–∏—Ç—å
async function loadDB(){
  try{
    const db=await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction(STORE_NAME,"readonly");
      const req=tx.objectStore(STORE_NAME).get("root");
      req.onsuccess=()=>{
        if(req.result){normalize(req.result);resolve(req.result);}
        else{const fresh={categories:[],polygons:[]};saveDB(fresh);resolve(fresh);}
      };
      req.onerror=()=>reject(req.error);
    });
  }catch(err){
    console.warn("IndexedDB load failed, fallback localStorage",err);
    const raw=localStorage.getItem(DB_NAME);
    if(raw){try{const obj=JSON.parse(raw);normalize(obj);return obj;}catch(e){}}
    const fresh={categories:[],polygons:[]};saveDB(fresh);return fresh;
  }
}

function uid(){return Math.random().toString(36).slice(2,9);}

function normalize(obj){
  if(!obj||typeof obj!=="object") obj={categories:[],polygons:[]};
  if(!Array.isArray(obj.categories)) obj.categories=[];
  if(!Array.isArray(obj.polygons)) obj.polygons=[];
  obj.categories.forEach(c=>{
    if(!("type" in c))c.type="select";
    if(!("items" in c))c.items=[];
    if(!("color" in c))c.color="#3388ff";
    if(!("shape" in c))c.shape="circle";
    if(!("parentCategoryId" in c))c.parentCategoryId=null;
    c.items.forEach(it=>{
      if(!("id" in it))it.id=uid();
      if(!("name" in it))it.name="–ë–µ–∑ –∏–º–µ–Ω–∏";
      if(!("lat" in it))it.lat=null;
      if(!("lng" in it))it.lng=null;
      if(!("parentId" in it))it.parentId=null;
    });
  });
  obj.polygons.forEach(p=>{
    if(!("id" in p))p.id=uid();
    if(!("name" in p))p.name="–ü–æ–ª–∏–≥–æ–Ω";
    if(!("color" in p))p.color="#ff0000";
    if(!("latlngs" in p))p.latlngs=[];
  });
}
/***** MAP + CLUSTERS *****/
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let cluster=L.markerClusterGroup();
map.addLayer(cluster);
function clearMarkers(){cluster.clearLayers();}

function markerIcon(cat){
  if(cat.iconData){
    return L.icon({iconUrl:cat.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  }
  const color=cat.color||"#3388ff";
  const shape=cat.shape||"circle";
  let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html,iconSize:[20,20],iconAnchor:[10,10]});
}

function addMarkerForItem(it,cat){
  if(it.lat==null||it.lng==null) return;
  const m=L.marker([it.lat,it.lng],{icon:markerIcon(cat)});
  m.bindPopup(`<b>${it.name}</b><br/><button onclick="removeMarkerById('${it.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>`);
  cluster.addLayer(m);
}
window.removeMarkerById=function(id){
  for(const c of db.categories){
    const it=(c.items||[]).find(x=>x.id===id);
    if(it){it.lat=null;it.lng=null;break;}
  }
  saveDB(db); renderAll();
};

/***** POLYGONS *****/
let polyIndex=new Map();
function rebuildPolys(){
  for(const [id,l] of polyIndex.entries()){map.removeLayer(l);}
  polyIndex.clear();
  db.polygons.forEach(p=>{
    if(!p.latlngs||p.latlngs.length===0) return;
    const l=L.polygon(p.latlngs,{color:p.color||"#ff0000"});
    polyIndex.set(p.id,l);
    if(p.visible!==false) l.addTo(map);
  });
}

function updatePolygonVisibility(){
  for(const [pid,l] of polyIndex.entries()){
    const p=db.polygons.find(x=>x.id===pid); if(!p) continue;
    if(p.visible===false){map.removeLayer(l);continue;}
    let show=false;
    db.categories.forEach(cat=>{
      const ids=getSelectedIds(cat.id);
      if(ids.length>0) show=true;
    });
    if(show){ if(!map.hasLayer(l)) map.addLayer(l);} else { if(map.hasLayer(l)) map.removeLayer(l);}
  }
}

// —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞
let drawing=false;
let tempPoly=null;
document.getElementById("btnNewPoly").onclick=()=>{
  drawing=true;
  tempPoly=L.polygon([], {color:"#ff0000"}).addTo(map);
  map.on("click", polyAddPoint);
};
document.getElementById("btnStopPoly").onclick=stopDrawing;
function polyAddPoint(e){
  if(!drawing) return;
  tempPoly.addLatLng(e.latlng);
}
function stopDrawing(){
  if(drawing){
    const name=document.getElementById("polyName").value.trim()||"–ü–æ–ª–∏–≥–æ–Ω";
    const color="#ff0000";
    const latlngs=tempPoly.getLatLngs()[0].map(ll=>[ll.lat,ll.lng]);
    const poly={id:uid(),name,color,latlngs,visible:true};
    db.polygons.push(poly);
    saveDB(db);
    drawing=false;
    map.off("click", polyAddPoint);
    renderAll();
  }
}
/***** EDITOR *****/
const $editor=document.getElementById('editorTab');
function renderEditor(){
  $editor.innerHTML="";

  // –Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
  const create=document.createElement('div');create.className='panel';
  create.innerHTML=`
    <h3>–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
    <div class="row">
      <input id="newCatName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
      <select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <select id="newCatParent">
        <option value="">(–Ω–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
        ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
    </div>
    <div class="row">
      <span class="preview-icon" id="newIconPreview">icon</span>
      <input type="color" id="newCatColor" value="#3388ff"/>
      <select id="newCatShape"><option value="circle">–ö—Ä—É–≥</option><option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option><option value="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option></select>
      <input type="file" id="newCatIcon" accept="image/png,image/svg+xml"/>
      <button id="btnAddCat">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>`;
  $editor.appendChild(create);

  const newIconInput=create.querySelector('#newCatIcon');
  const newIconPreview=create.querySelector('#newIconPreview');
  let newIconData=null;
  newIconInput.onchange=e=>{
    const f=e.target.files[0]; if(!f){newIconData=null;newIconPreview.textContent='icon';return;}
    const r=new FileReader(); r.onload=ev=>{newIconData=ev.target.result;newIconPreview.innerHTML=`<img src="${newIconData}">`;}; r.readAsDataURL(f);
  };
  create.querySelector('#btnAddCat').onclick=()=>{
    const name=document.getElementById('newCatName').value.trim(); if(!name) return;
    const type=document.getElementById('newCatType').value;
    const parent=document.getElementById('newCatParent').value||null;
    const color=document.getElementById('newCatColor').value;
    const shape=document.getElementById('newCatShape').value;
    const cat={id:uid(),name,type,parentCategoryId:parent,color,shape,items:[]};
    if(newIconData) cat.iconData=newIconData;
    db.categories.push(cat); saveDB(db); renderAll();
  };

  // —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  db.categories.forEach((cat,ci)=>{
    const sec=document.createElement('div'); sec.className='panel';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    sec.appendChild(title);

    // —ç–ª–µ–º–µ–Ω—Ç—ã
    const list=document.createElement('div'); list.className='list';
    (cat.items||[]).forEach((it,ii)=>{
      const line=document.createElement('div'); line.className='item';
      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'‚Äî'} lng:${it.lng??'‚Äî'}`;
      left.append(nm,meta);

      const tools=document.createElement('div'); tools.className='tools';
      const place=document.createElement('button'); place.textContent='üìç';
      place.onclick=()=>{
        alert('–ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è: '+it.name);
        map.once('click', e=>{
          it.lat=e.latlng.lat; it.lng=e.latlng.lng; saveDB(db);
          meta.textContent=`lat:${it.lat.toFixed(5)} lng:${it.lng.toFixed(5)}`;
          addMarkerForItem(it,cat);
          map.setView([it.lat,it.lng],14);
        });
      };
      const clearBtn=document.createElement('button'); clearBtn.textContent='üóë';
      clearBtn.onclick=()=>{it.lat=null;it.lng=null; saveDB(db); renderAll();};
      line.onclick=()=>{ if(it.lat!=null&&it.lng!=null) map.setView([it.lat,it.lng],14); };
      tools.append(place,clearBtn);
      line.append(left,tools); list.appendChild(line);
    });
    sec.appendChild(list);

    // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
    const addBtn=document.createElement('button'); addBtn.textContent='+';
    addBtn.onclick=()=>{
      const nm=inp.value.trim()||'–ù–æ–≤—ã–π';
      cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:null});
      inp.value=''; saveDB(db); renderAll();
    };
    addRow.append(inp,addBtn); sec.appendChild(addRow);

    $editor.appendChild(sec);
  });
}

/***** PREVIEW *****/
const $cascade=document.getElementById('cascadeBox');
let selected={};
function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId);
  const v=selected[catId];
  if(!v) return [];
  return (cat && cat.type==='checkbox')?Array.from(v):(v?[v]:[]);
}
function renderPreview(){
  $cascade.innerHTML="";
  clearMarkers();
  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel'; box.dataset.catId=cat.id;
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);

    let items=(cat.items||[]);
    if(items.length===0){
      const note=document.createElement('div'); note.className='note gray'; note.textContent='–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤';
      box.appendChild(note); $cascade.appendChild(box); return;
    }
    if(cat.type==='select'){
      const sel=document.createElement('select');
      sel.innerHTML=`<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>`+items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      if(typeof selected[cat.id]==='string') sel.value=selected[cat.id]||"";
      sel.onchange=()=>{ selected[cat.id]=sel.value||null; renderPreview(); };
      box.appendChild(sel);
    }else{
      const multi=document.createElement('div'); multi.className='multi-select';
      const btn=document.createElement('div'); btn.className='multi-select-btn'; btn.textContent='–í—ã–±—Ä–∞—Ç—å...';
      const menu=document.createElement('div'); menu.className='multi-select-menu';
      const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();
      function updateBtnText(){
        if(set.size===0){ btn.textContent='–í—ã–±—Ä–∞—Ç—å...'; }
        else{const names=items.filter(x=>set.has(x.id)).map(x=>x.name);
          btn.textContent=names.length<=5?names.join(', '):`–í—ã–±—Ä–∞–Ω–æ: ${names.length}`;}
      }
      updateBtnText();
      items.forEach(it=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; cb.checked=set.has(it.id);
        cb.onchange=()=>{ if(cb.checked) set.add(it.id); else set.delete(it.id);
          selected[cat.id]=set; updateBtnText(); renderPreview(); };
        lbl.append(cb,document.createTextNode(it.name));
        menu.appendChild(lbl);
      });
      btn.onclick=()=>{document.querySelectorAll('.multi-select.open').forEach(ms=>ms.classList.remove('open'));multi.classList.toggle('open');};
      multi.append(btn,menu); box.appendChild(multi);
    }
    $cascade.appendChild(box);
  });

  // markers
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    for(const id of ids){
      const it=(cat.items||[]).find(x=>x.id===id);
      if(it && it.lat!=null && it.lng!=null) addMarkerForItem(it,cat);
    }
  }
  // polygons
  rebuildPolys();
  updatePolygonVisibility();
}

/***** SEARCH *****/
const $search=document.getElementById('globalSearch');
const $results=document.getElementById('searchResults');
$search.oninput=()=>{
  const q=$search.value.trim().toLowerCase();
  $results.innerHTML=""; if(!q) return;
  db.categories.forEach(cat=>{
    (cat.items||[]).forEach(it=>{
      if(it.name.toLowerCase().includes(q)){
        const row=document.createElement('div');
        row.textContent=`${it.name} (${cat.name})`;
        row.onclick=()=>{
          if(cat.type==='select') selected[cat.id]=it.id;
          else{ if(!(selected[cat.id] instanceof Set)) selected[cat.id]=new Set(); selected[cat.id].add(it.id); }
          renderPreview();
          if(it.lat!=null&&it.lng!=null) map.setView([it.lat,it.lng],14);
          $search.value=""; $results.innerHTML="";
        };
        $results.appendChild(row);
      }
    });
  });
};

/***** EXPORT/IMPORT + INIT *****/
document.getElementById('btnExport').onclick=()=>{
  normalize(db);
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_v38.6.json'; a.click();
};
document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async()=>{
    try{
      let obj=JSON.parse(r.result);
      normalize(obj); db=obj; await saveDB(db); selected={}; renderAll(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
  };
  r.readAsText(f);
};
document.getElementById('btnReset').onclick=()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){ indexedDB.deleteDatabase(DB_NAME); localStorage.removeItem(DB_NAME); location.reload(); } };

document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

let db=null;
(async()=>{ db=await loadDB(); renderAll(); })();
function renderAll(){ renderEditor(); renderPreview(); }
</script>
</body>
</html>
