<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v38.9R — undo/redo + массовые действия + подсказки + иконки + статистика</title>

<!-- Leaflet + плагины -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<!-- localForage -->
<script src="https://unpkg.com/localforage@1.10.0/dist/localforage.js"></script>

<style>
:root{
  --bg:#0b0f16;--panel:#121826;--panel2:#172133;--panel3:#0f1624;
  --border:#273248;--text:#d7e2f2;--muted:#9fb0c8;
  --accent:#4aa8ff;--danger:#ef4444;--overlay:rgba(10,14,22,.75)
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:var(--text);cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:460px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
#map{width:100%;height:100%}
.draggable{cursor:grab}
.dragging{opacity:.5}
/* модалки */
.modal-overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:5000}
.modal{width:min(980px,90vw);max-height:85vh;background:var(--panel);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;overflow:hidden}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);background:var(--panel3)}
.modal-title{font-weight:700}
.modal-close{border:1px solid var(--border);background:#1a2234;border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.modal-body{padding:12px 14px;overflow:auto}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border);background:var(--panel3)}
.modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
@media (max-width:1024px){.modal-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.modal-grid{grid-template-columns:1fr}}
.modal-item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #1f2a40;border-radius:8px;background:#0f1624}
.modal-item input[type="checkbox"]{width:18px;height:18px;appearance:none;-webkit-appearance:none;border:2px solid var(--accent);border-radius:4px;background:#0f1624;position:relative;cursor:pointer;flex:0 0 18px}
.modal-item input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
.modal-item input[type="checkbox"]:checked::after{content:"✔";position:absolute;top:-2px;left:2px;color:#fff;font-size:14px}
/* подсказки */
.suggestions{position:absolute;background:var(--panel2);border:1px solid var(--border);border-radius:8px;z-index:3000;max-height:200px;overflow:auto;width:100%}
.suggestions div{padding:6px 8px;cursor:pointer}
.suggestions div:hover{background:#1f293d}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v38.9R</span>
  <button id="btnExport">Экспорт</button>
  <button id="btnImport">Импорт</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnReset" class="danger">Сброс</button>
  <button id="btnInfo">Инфо</button>
  <button id="btnUndo">Undo</button>
  <button id="btnRedo">Redo</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">Редактор</div>
  <div class="tab" data-tab="preview">Предпросмотр</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel"><h3>Предпросмотр</h3><div id="cascadeBox"></div></div>
  </aside>
  <div id="map"></div>
</main>

<!-- модалки -->
<div id="msOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <div id="msTitle" class="modal-title">Выбор</div>
      <div id="msClose" class="modal-close">✖</div>
    </div>
    <div class="modal-body"><div id="msGrid" class="modal-grid"></div></div>
    <div class="modal-actions">
      <button id="msApply">Применить</button>
      <button id="msCancel" class="danger">Отмена</button>
    </div>
  </div>
</div>

<div id="iconsOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Библиотека иконок</div><div id="iconsClose" class="modal-close">✖</div></div>
    <div class="modal-body"><div id="iconsGrid" class="modal-grid"></div></div>
  </div>
</div>

<div id="infoOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Статистика</div><div id="infoClose" class="modal-close">✖</div></div>
    <div class="modal-body"><div id="infoBox"></div></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
const KEY="dict_v389R";
const lfIcons=localforage.createInstance({name:"dict_icons_v389R"});
const lfGeo=localforage.createInstance({name:"dict_geo_v389R"});
let db=null;
function uid(){return Math.random().toString(36).slice(2,9);}
function normalize(o){if(!o||typeof o!=="object")o={categories:[],polygons:[]};if(!Array.isArray(o.categories))o.categories=[];o.categories.forEach(c=>{if(!c.id)c.id=uid();if(!c.type)c.type="select";if(!c.items)c.items=[];});}

/* === История действий === */
let historyStack=[],historyIndex=-1;
function pushHistory(){const snap=JSON.stringify(db);if(historyIndex<historyStack.length-1)historyStack.splice(historyIndex+1);historyStack.push(snap);historyIndex=historyStack.length-1;}
function undo(){if(historyIndex>0){historyIndex--;db=JSON.parse(historyStack[historyIndex]);renderAll();}}
function redo(){if(historyIndex<historyStack.length-1){historyIndex++;db=JSON.parse(historyStack[historyIndex]);renderAll();}}
document.getElementById('btnUndo').onclick=()=>undo();
document.getElementById('btnRedo').onclick=()=>redo();

/* === Иконки === */
const builtinIcons=[
  {name:"Дом",svg:"<svg width='20' height='20'><rect x='4' y='8' width='12' height='8' fill='white' stroke='black'/></svg>"},
  {name:"Метро",svg:"<svg width='20' height='20'><circle cx='10' cy='10' r='8' fill='red'/></svg>"},
  {name:"Офис",svg:"<svg width='20' height='20'><rect x='6' y='4' width='8' height='12' fill='blue'/></svg>"}
];
</script>
<script>
/* === Хранилище и коммиты (история + сохранение) === */
async function save(obj=db){
  normalize(obj);
  const lite={
    categories:obj.categories.map(c=>({
      id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId||null,
      color:c.color||"#3388ff",shape:c.shape||"circle",iconKey:c.iconKey||null,
      items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId||null,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
    })),
    polygons:(obj.polygons||[]).map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
  };
  localStorage.setItem(KEY,JSON.stringify(lite));
  // иконки
  for(const cat of obj.categories){
    if(cat.iconData){
      const key=cat.iconKey||`cat_${cat.id}`;
      await lfIcons.setItem(key,cat.iconData);
      cat.iconKey=key;
    }
    for(const it of (cat.items||[])){
      if(it.iconData){
        const key=it.iconKey||`item_${it.id}`;
        await lfIcons.setItem(key,it.iconData);
        it.iconKey=key;
      }
    }
  }
  // полигоны
  for(const p of (obj.polygons||[])){
    if(p.geojson) await lfGeo.setItem(p.id,p.geojson);
  }
}
async function loadDB(){
  const raw=localStorage.getItem(KEY);
  let obj={categories:[],polygons:[]};
  if(raw){try{obj=JSON.parse(raw)||{};}catch(e){}}
  normalize(obj);
  // подтянуть иконки
  for(const cat of obj.categories){
    if(cat.iconKey&&!cat.iconData){
      try{cat.iconData=await lfIcons.getItem(cat.iconKey)||null;}catch(e){}
    }
    for(const it of (cat.items||[])){
      if(it.iconKey&&!it.iconData){
        try{it.iconData=await lfIcons.getItem(it.iconKey)||null;}catch(e){}
      }
    }
  }
  // подтянуть геометрию
  for(const p of (obj.polygons||[])){
    if(!p.geojson){
      try{p.geojson=await lfGeo.getItem(p.id)||null;}catch(e){}
    }
  }
  db=obj;
  // первичный снапшот истории один раз
  if(historyStack.length===0){pushHistory();}
  return obj;
}
async function commit(){await save(db);pushHistory();renderAll();}

/* === Выбор в предпросмотре (persist) === */
let selected={};
function saveSelected(){
  const out={};
  for(const [k,v] of Object.entries(selected)){ out[k]=v instanceof Set?Array.from(v):v; }
  localStorage.setItem('selected_v1',JSON.stringify(out));
}
function loadSelected(){
  try{
    const raw=localStorage.getItem('selected_v1'); if(!raw) return;
    const obj=JSON.parse(raw)||{}; selected={};
    for(const [k,v] of Object.entries(obj)){
      const cat=(db?.categories||[]).find(c=>c.id===k);
      if(cat&&cat.type==='checkbox') selected[k]=new Set(Array.isArray(v)?v:[]);
      else selected[k]=v||null;
    }
  }catch(_){selected={};}
}

/* === Сворачивания === */
function getCollapsedSet(key){ try{ return new Set(JSON.parse(localStorage.getItem(key)||"[]")); }catch(_){ return new Set(); } }
function setCollapsedSet(key, set){ localStorage.setItem(key, JSON.stringify([...set])); }
const collapsedPolygons = getCollapsedSet('collapsedPolygons_v1');
const collapsedCats     = getCollapsedSet('collapsedCats_v1');

/* === Карта === */
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let cluster=L.markerClusterGroup(); map.addLayer(cluster);
function clearMarkers(){cluster.clearLayers();}
function markerIcon(cat,it=null){
  if(it && it.iconData) return L.icon({iconUrl:it.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  if(cat.iconData) return L.icon({iconUrl:cat.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  const color=cat.color||"#3388ff"; const shape=cat.shape||"circle"; let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html,iconSize:[20,20],iconAnchor:[10,10]});
}
function addMarkerForItem(it,cat){
  if(it.lat==null||it.lng==null) return;
  const m=L.marker([it.lat,it.lng],{icon:markerIcon(cat,it), _itemId: it.id});
  m.bindPopup(`<b>${it.name}</b><br/><button onclick="removeMarkerById('${it.id}')">🗑 Удалить метку</button>`);
  cluster.addLayer(m);
}
window.removeMarkerById=function(id){
  for(const c of db.categories){
    const it=(c.items||[]).find(x=>x.id===id);
    if(it){it.lat=null;it.lng=null;break;}
  }
  const toRemove=[]; cluster.eachLayer(m=>{ if(m.options?._itemId===id) toRemove.push(m); });
  toRemove.forEach(m=>cluster.removeLayer(m));
  commit();
};

/* === Полигоны (с историей по id как было) === */
const polyFG=new L.FeatureGroup(); map.addLayer(polyFG);
const polyIndex=new Map();
const historyById=new Map(); // id -> {stack:[], index}
function getHistoryByPoly(id){ if(!historyById.has(id)) historyById.set(id,{stack:[],index:-1}); return historyById.get(id); }
function pushPolyHistory(p){
  const h=getHistoryByPoly(p.id);
  const snap=JSON.parse(JSON.stringify(p.geojson));
  if(h.index<h.stack.length-1) h.stack.splice(h.index+1);
  h.stack.push(snap); h.index=h.stack.length-1;
}
function applyPolyHistory(p,dir){
  const h=getHistoryByPoly(p.id); const next=h.index+dir;
  if(next<0||next>=h.stack.length) return false;
  h.index=next; const snap=h.stack[h.index];
  p.geojson=JSON.parse(JSON.stringify(snap));
  const old=polyIndex.get(p.id); if(old) polyFG.removeLayer(old);
  const l=layerFromGeo(p.geojson,p.color); polyFG.addLayer(l); polyIndex.set(p.id,l);
  if(p.visible===false) map.removeLayer(l);
  return true;
}
function layerFromGeo(geo,c){ let l=null; L.geoJSON(geo,{style:{color:c||'#ff4d4f',weight:2,fillOpacity:.12}}).eachLayer(x=>l=x); return l; }
function rebuildPolys(){
  polyIndex.clear(); polyFG.clearLayers();
  for(const p of (db.polygons||[])){
    if(!p.geojson) continue;
    const l=layerFromGeo(p.geojson,p.color);
    if(!l) continue; polyFG.addLayer(l); polyIndex.set(p.id,l);
    if(p.visible===false) map.removeLayer(l);
  }
  updatePolygonVisibility();
}

/* === UI полигонов === */
const $polyList=document.createElement('div');
const $polyName=document.createElement('input'); $polyName.placeholder='Название полигона';
const $polyColor=document.createElement('input'); $polyColor.type='color'; $polyColor.value='#ff4d4f';
const $polySearch=document.createElement('input'); $polySearch.placeholder='Поиск по полигонам...';

function mountPolygonPanel(){
  // Встраиваем в правую колонку в раздел «Предпросмотр» как в 38.8.2R
  const previewTab=document.getElementById('previewTab');
  const panel=document.createElement('div'); panel.className='panel';
  panel.innerHTML=`
    <h3>Полигоны</h3>
  `;
  const row=document.createElement('div'); row.className='row';
  const btnNew=document.createElement('button'); btnNew.textContent='Новый';
  btnNew.onclick=()=>{ new L.Draw.Polygon(map,{shapeOptions:{color:$polyColor.value||'#ff4d4f',weight:2,fillOpacity:.12}}).enable(); };
  const btnEdit=document.createElement('button'); btnEdit.textContent='Редактировать';
  const btnStop=document.createElement('button'); btnStop.textContent='Стоп';
  const btnUndo=document.createElement('button'); btnUndo.textContent='Undo';
  const btnRedo=document.createElement('button'); btnRedo.textContent='Redo';
  row.append(btnNew,btnEdit,btnStop,btnUndo,btnRedo);

  panel.appendChild($polyName);
  panel.appendChild($polyColor);
  panel.appendChild(row);
  panel.appendChild($polySearch);
  $polyList.className='list';
  panel.appendChild($polyList);

  previewTab.appendChild(panel);

  let polyEditToolbar=null, polyEditing=false, polyEditingTargetId=null;

  btnEdit.onclick=()=>{
    if(polyEditing) return;
    polyEditingTargetId=null;
    localStorage.removeItem('polyEditingId');
    polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
    polyEditToolbar.enable(); polyEditing=true;
  };
  btnStop.onclick=()=>{
    if(polyEditing&&polyEditToolbar){polyEditToolbar.disable(); polyEditing=false; map.fire(L.Draw.Event.EDITSTOP);}
    polyEditingTargetId=null; localStorage.removeItem('polyEditingId');
  };
  btnUndo.onclick=()=>{
    if(!polyEditingTargetId) return;
    const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
    if(applyPolyHistory(p,-1)){ save(db).then(()=>{ renderPolyList(); updatePolygonVisibility(); }); }
  };
  btnRedo.onclick=()=>{
    if(!polyEditingTargetId) return;
    const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
    if(applyPolyHistory(p,+1)){ save(db).then(()=>{ renderPolyList(); updatePolygonVisibility(); }); }
  };

  map.on(L.Draw.Event.CREATED,async e=>{
    if(!(e.layer instanceof L.Polygon)) return;
    const layer=e.layer;
    layer.setStyle({color:$polyColor.value||'#ff4d4f',weight:2,fillOpacity:.12});
    polyFG.addLayer(layer);
    const rec={id:uid(),name:($polyName?.value||`Полигон ${(db.polygons||[]).length+1}`).trim(),color:$polyColor?.value||'#ff4d4f',visible:true,geojson:layer.toGeoJSON()};
    (db.polygons||(db.polygons=[])).push(rec);
    polyIndex.set(rec.id,layer);
    pushPolyHistory(rec);
    await commit();
  });

  map.on(L.Draw.Event.EDITSTOP,async ()=>{
    for(const p of (db.polygons||[])){
      const l=polyIndex.get(p.id); if(l) p.geojson=l.toGeoJSON();
    }
    await commit();
  });

  map.on('draw:editvertex', ()=>{
    if(!polyEditingTargetId) return;
    const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
    const l=polyIndex.get(p.id); if(!l) return;
    p.geojson=l.toGeoJSON(); pushPolyHistory(p);
    // сохранится на EDITSTOP, история — в памяти
  });

  function setEditingTarget(id){
    polyEditingTargetId=id||null;
    if(id) localStorage.setItem('polyEditingId',id); else localStorage.removeItem('polyEditingId');
    renderPolyList();
    updatePolygonVisibility();
  }

  function renderPolyList(){
    const q=($polySearch?.value||"").trim().toLowerCase();
    const prevScroll=$polyList.scrollTop;
    $polyList.innerHTML='';
    (db.polygons||[])
      .filter(p=>!q || (p.name||'').toLowerCase().includes(q))
      .forEach(p=>{
        const wrapper=document.createElement('div'); wrapper.className='item';
        const head=document.createElement('div'); head.className='item-row';
        const left=document.createElement('div'); left.className='left';
        const nm=document.createElement('div'); nm.className='name'; nm.textContent=p.name||'Полигон';
        const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`id: ${p.id}`;
        left.append(nm,meta);
        const tools=document.createElement('div'); tools.className='tools';
        const toggle=document.createElement('button'); toggle.textContent=p.visible!==false?'Скрыть':'Показать';
        toggle.onclick=async()=>{p.visible=!(p.visible!==false); const l=polyIndex.get(p.id); if(l){ if(p.visible) l.addTo(map); else map.removeLayer(l);} await commit();};
        const focus=document.createElement('button'); focus.textContent='Фокус';
        focus.onclick=()=>{const l=polyIndex.get(p.id);if(l){ l.addTo(map); map.fitBounds(l.getBounds()); }};
        const editBtn=document.createElement('button'); editBtn.textContent='Редактировать';
        editBtn.onclick=()=>{
          const l=polyIndex.get(p.id);
          if(l){
            l.addTo(map);
            if(polyEditToolbar){ try{polyEditToolbar.disable();}catch(_){}} 
            polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
            polyEditToolbar.enable(); 
            polyFG.eachLayer(x=>{
              if(x===l){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
              else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
            });
            setEditingTarget(p.id);
            map.fitBounds(l.getBounds());
            const h=getHistoryByPoly(p.id); if(h.stack.length===0){ pushPolyHistory(p); }
          }
        };
        const del=document.createElement('button'); del.textContent='❌'; del.className='danger';
        del.onclick=async()=>{if(!confirm('Удалить полигон?')) return; const l=polyIndex.get(p.id); if(l) polyFG.removeLayer(l); polyIndex.delete(p.id); db.polygons=db.polygons.filter(x=>x.id!==p.id); await lfGeo.removeItem(p.id); await commit();};

        tools.append(toggle,focus,editBtn,del);
        head.append(left,tools);
        wrapper.append(head);
        $polyList.appendChild(wrapper);
      });
    $polyList.scrollTop=prevScroll;
  }
  $polySearch.oninput=renderPolyList;
  // первичный рендер
  renderPolyList();

  // восстановление таргета
  const savedId=localStorage.getItem('polyEditingId');
  if(savedId){
    const l=polyIndex.get(savedId);
    if(l){
      // включаем режим редактирования для сохранённого
      if(polyEditToolbar){ try{polyEditToolbar.disable();}catch(_){}} 
      polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
      polyEditToolbar.enable();
      polyFG.eachLayer(x=>{
        if(x===l){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
        else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
      });
    }
  }
}

/* === Видимость полигонов по выбранным элементам === */
function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId);
  const v=selected[catId];
  if(!v) return [];
  return(cat&&cat.type==='checkbox')?Array.from(v):(v?[v]:[]);
}
function getSelectedItemNames(){
  const names=new Set();
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    if(!ids.length) continue;
    (cat.items||[]).forEach(it=>{if(ids.includes(it.id)) names.add(it.name);});
  }
  return names;
}
function updatePolygonVisibility(){
  const names=getSelectedItemNames();
  for(const p of (db.polygons||[])){
    const layer=polyIndex.get(p.id); if(!layer) continue;
    const filtered=(p.visible!==false)&&(names.size?names.has(p.name):true);
    if(filtered) layer.addTo(map); else map.removeLayer(layer);
  }
}

/* === Библиотека иконок (модалка) === */
const $iconsOverlay=document.getElementById('iconsOverlay');
const $iconsClose=document.getElementById('iconsClose');
const $iconsGrid=document.getElementById('iconsGrid');
function openIconsLib(onPick){
  $iconsGrid.innerHTML="";
  builtinIcons.forEach(icon=>{
    const cell=document.createElement('div'); cell.className='modal-item';
    const prev=document.createElement('div'); prev.innerHTML=icon.svg;
    const name=document.createElement('div'); name.textContent=icon.name;
    cell.append(prev,name);
    cell.style.cursor='pointer';
    cell.onclick=()=>{ onPick(icon.svg); closeIconsLib(); };
    $iconsGrid.appendChild(cell);
  });
  $iconsOverlay.style.display='flex'; document.body.style.overflow='hidden';
}
function closeIconsLib(){ $iconsOverlay.style.display='none'; document.body.style.overflow=''; }
$iconsClose.onclick=closeIconsLib;

/* === Статистика (модалка «Инфо») === */
const $infoOverlay=document.getElementById('infoOverlay');
const $infoClose=document.getElementById('infoClose');
const $infoBox=document.getElementById('infoBox');
document.getElementById('btnInfo').onclick=()=>{
  const cats=db.categories.length;
  let items=0, itemsWithCoords=0;
  db.categories.forEach(c=>{
    items+=(c.items||[]).length;
    (c.items||[]).forEach(it=>{ if(it.lat!=null&&it.lng!=null) itemsWithCoords++; });
  });
  const polys=(db.polygons||[]).length;
  $infoBox.innerHTML=`
    <div class="list">
      <div class="item"><div class="item-row"><div class="left"><div class="name">Категорий</div><div class="meta">всего</div></div><div>${cats}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">Элементов</div><div class="meta">всего</div></div><div>${items}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">С координатами</div><div class="meta">элементы</div></div><div>${itemsWithCoords}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">Полигонов</div><div class="meta">всего</div></div><div>${polys}</div></div></div>
    </div>`;
  $infoOverlay.style.display='flex'; document.body.style.overflow='hidden';
};
$infoClose.onclick=()=>{$infoOverlay.style.display='none'; document.body.style.overflow='';};

/* === Подсказки при добавлении === */
function buildAllNamesIndex(){
  const set=new Set();
  db.categories.forEach(c=> (c.items||[]).forEach(it=> set.add((it.name||"").trim().toLowerCase()) ));
  return set;
}
function attachSuggestions(input){
  const wrap=document.createElement('div'); wrap.style.position='relative'; input.parentNode.insertBefore(wrap,input); wrap.appendChild(input);
  const sug=document.createElement('div'); sug.className='suggestions'; sug.style.display='none'; wrap.appendChild(sug);
  input.addEventListener('input',()=>{
    const q=(input.value||"").trim().toLowerCase();
    if(!q){sug.style.display='none';sug.innerHTML='';return;}
    const names=[...buildAllNamesIndex()].filter(n=>n.includes(q)).slice(0,30);
    if(names.length===0){sug.style.display='none';sug.innerHTML='';return;}
    sug.innerHTML=names.map(n=>`<div>${n}</div>`).join('');
    sug.style.display='block';
  });
  sug.addEventListener('click',e=>{
    if(e.target && e.target.tagName==='DIV'){ input.value=e.target.textContent; sug.style.display='none'; }
  });
  document.addEventListener('click',ev=>{ if(!wrap.contains(ev.target)) sug.style.display='none'; });
}

/* === Предпросмотр (модальный мультиселект и поиск) === */
const $msOverlay=document.getElementById('msOverlay');
const $msTitle=document.getElementById('msTitle');
const $msClose=document.getElementById('msClose');
const $msCancel=document.getElementById('msCancel');
const $msApply=document.getElementById('msApply');
const $msGrid=document.getElementById('msGrid');
let msCtx=null; // {catId, items:[...], temp:Set<string>}
function openMultiModal(cat, items){
  msCtx={catId:cat.id, items:[...items], temp:new Set(selected[cat.id] instanceof Set?selected[cat.id]:[])};
  $msTitle.textContent=cat.name;
  renderMsGrid();
  $msOverlay.style.display='flex';
  document.body.style.overflow='hidden';
}
function closeMultiModal(){ msCtx=null; $msOverlay.style.display='none'; document.body.style.overflow=''; }
function renderMsGrid(){
  if(!msCtx) return;
  $msGrid.innerHTML="";
  msCtx.items.forEach(it=>{
    const row=document.createElement('label'); row.className='modal-item';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=msCtx.temp.has(it.id);
    cb.onchange=()=>{ if(cb.checked) msCtx.temp.add(it.id); else msCtx.temp.delete(it.id); };
    const name=document.createElement('div'); name.textContent=it.name;
    row.append(cb,name); $msGrid.appendChild(row);
  });
}
$msApply.onclick=()=>{ if(!msCtx)return; selected[msCtx.catId]=new Set(msCtx.temp); saveSelected(); renderPreview(); updatePolygonVisibility(); closeMultiModal(); };
$msCancel.onclick=closeMultiModal; $msClose.onclick=closeMultiModal;
</script>
<script>
/* === Редактор: категории/элементы + массовые действия + сортировки + drag&drop === */
const $editor=document.getElementById('editorTab');

function moveArrayItem(arr, fromIdx, toIdx){
  if(fromIdx===toIdx) return;
  const item=arr.splice(fromIdx,1)[0];
  arr.splice(toIdx,0,item);
}
function sortAZ(){
  db.categories.sort((a,b)=>a.name.localeCompare(b.name));
  for(const cat of db.categories){
    if(cat.items) cat.items.sort((a,b)=>a.name.localeCompare(b.name));
  }
}

function renderEditor(){
  $editor.innerHTML="";

  // панель управления категориями
  const headPanel=document.createElement('div'); headPanel.className='panel';
  const headRow=document.createElement('div'); headRow.className='row';
  const hTitle=document.createElement('h3'); hTitle.textContent='Категории';
  const btnSortAZ=document.createElement('button'); btnSortAZ.textContent='Сортировать A→Z';
  btnSortAZ.onclick=()=>{ sortAZ(); commit(); };
  headRow.append(hTitle,btnSortAZ);
  headPanel.appendChild(headRow);
  $editor.appendChild(headPanel);

  // новая категория
  const create=document.createElement('div'); create.className='panel';
  if(collapsedCats.has('newCat')) create.classList.add('collapsed');
  const head=document.createElement('div'); head.className='collapse-head';
  const caret=document.createElement('div'); caret.className='caret';
  const title=document.createElement('h3'); title.textContent='Новая категория';
  head.append(caret,title); create.appendChild(head);
  const body=document.createElement('div'); body.className='section-body';
  body.innerHTML=`
    <div class="row">
      <input id="newCatName" placeholder="Название"/>
      <select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <select id="newCatParent">
        <option value="">(нет родителя)</option>
        ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
    </div>
    <div class="row">
      <span class="preview-icon" id="newIconPreview">icon</span>
      <input type="color" id="newCatColor" value="#3388ff"/>
      <select id="newCatShape"><option value="circle">Круг</option><option value="square">Квадрат</option><option value="triangle">Треугольник</option></select>
      <input type="file" id="newCatIcon" accept="image/png,image/svg+xml"/>
      <button id="btnIconLib">📚</button>
      <button id="btnAddCat">+ Добавить</button>
    </div>`;
  create.appendChild(body);
  head.onclick=()=>{
    if(collapsedCats.has('newCat')) collapsedCats.delete('newCat'); else collapsedCats.add('newCat');
    setCollapsedSet('collapsedCats_v1',collapsedCats);
    create.classList.toggle('collapsed');
  };
  $editor.appendChild(create);

  const newIconInput=body.querySelector('#newCatIcon');
  const newIconPreview=body.querySelector('#newIconPreview');
  let newIconData=null;
  newIconInput.onchange=e=>{
    const f=e.target.files[0]; if(!f){newIconData=null;newIconPreview.textContent='icon';return;}
    const r=new FileReader(); r.onload=ev=>{newIconData=ev.target.result;newIconPreview.innerHTML=`<img src="${newIconData}">`;}; r.readAsDataURL(f);
  };
  body.querySelector('#btnIconLib').onclick=()=>openIconsLib(svg=>{
    // сохраняем SVG как data URI
    const data=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
    newIconData=data; newIconPreview.innerHTML=`<img src="${data}">`;
  });
  body.querySelector('#btnAddCat').onclick=async()=>{
    const name=body.querySelector('#newCatName').value.trim(); if(!name) return;
    const type=body.querySelector('#newCatType').value;
    const parent=body.querySelector('#newCatParent').value||null;
    const color=body.querySelector('#newCatColor').value;
    const shape=body.querySelector('#newCatShape').value;
    const cat={id:uid(),name,type,parentCategoryId:parent,color,shape,items:[]};
    if(newIconData){cat.iconData=newIconData;}
    db.categories.push(cat); await commit();
  };

  // список категорий
  db.categories.forEach((cat)=>{
    const sec=document.createElement('div'); sec.className='panel draggable';
    if(collapsedCats.has(cat.id)) sec.classList.add('collapsed');
    sec.dataset.catId=cat.id;

    const head=document.createElement('div'); head.className='collapse-head';
    const caret=document.createElement('div'); caret.className='caret';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    head.append(caret,title);

    const toolsTop=document.createElement('div'); toolsTop.className='tools';
    const btnUp=document.createElement('button'); btnUp.textContent='▲';
    btnUp.onclick=()=>{const idx=db.categories.findIndex(c=>c.id===cat.id); if(idx>0){ moveArrayItem(db.categories,idx,idx-1); commit(); }};
    const btnDown=document.createElement('button'); btnDown.textContent='▼';
    btnDown.onclick=()=>{const idx=db.categories.findIndex(c=>c.id===cat.id); if(idx<db.categories.length-1){ moveArrayItem(db.categories,idx,idx+1); commit(); }};
    const btnSortItemsAZ=document.createElement('button'); btnSortItemsAZ.textContent='A→Z элементы';
    btnSortItemsAZ.onclick=()=>{ cat.items.sort((a,b)=>a.name.localeCompare(b.name)); commit(); };
    toolsTop.append(btnUp,btnDown,btnSortItemsAZ);

    const headWrap=document.createElement('div'); headWrap.style.display='flex'; headWrap.style.justifyContent='space-between'; headWrap.style.alignItems='center';
    headWrap.append(head,toolsTop);
    sec.appendChild(headWrap);

    const body=document.createElement('div'); body.className='section-body';

    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name;
    inpName.onchange=()=>{cat.name=inpName.value.trim(); commit();};
    const selType=document.createElement('select'); ['select','checkbox'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(cat.type===t)o.selected=true;selType.appendChild(o);});
    selType.onchange=()=>{cat.type=selType.value; commit();};
    const selParent=document.createElement('select'); selParent.innerHTML=`<option value="">(нет родителя)</option>`+db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join('');
    selParent.onchange=()=>{cat.parentCategoryId=selParent.value||null; commit();};
    const col=document.createElement('input'); col.type='color'; col.value=cat.color||'#3388ff'; col.onchange=()=>{cat.color=col.value; commit();};
    const shape=document.createElement('select'); ['circle','square','triangle'].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if((cat.shape||'circle')===s)o.selected=true;shape.appendChild(o);});
    shape.onchange=()=>{cat.shape=shape.value; commit();};
    const iconPrev=document.createElement('span'); iconPrev.className='preview-icon'; iconPrev.innerHTML=cat.iconData?`<img src="${cat.iconData}">`:'icon';
    const iconInput=document.createElement('input'); iconInput.type='file'; iconInput.accept='image/png,image/svg+xml'; iconInput.style.display='none';
    const iconBtn=document.createElement('button'); iconBtn.textContent='🖼';
    iconBtn.onclick=()=>iconInput.click();
    iconInput.onchange=e=>{
      const f=e.target.files[0];
      if(!f){ delete cat.iconData; iconPrev.textContent='icon'; commit(); return; }
      const r=new FileReader(); r.onload=ev=>{ cat.iconData=ev.target.result; iconPrev.innerHTML=`<img src="${cat.iconData}">`; commit(); }; r.readAsDataURL(f);
    };
    const iconLibBtn=document.createElement('button'); iconLibBtn.textContent='📚';
    iconLibBtn.onclick=()=>openIconsLib(svg=>{
      cat.iconData=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`; iconPrev.innerHTML=`<img src="${cat.iconData}">`; commit();
    });
    const btnClearIcon=document.createElement('button'); btnClearIcon.textContent='✖ иконка';
    btnClearIcon.onclick=()=>{delete cat.iconData; iconPrev.textContent='icon'; commit();};
    cfg.append(inpName,selType,selParent,col,shape,iconPrev,iconBtn,iconInput,iconLibBtn,btnClearIcon);
    body.appendChild(cfg);

    /* === ЭЛЕМЕНТЫ категории === */
    const list=document.createElement('div'); list.className='list'; list.dataset.catId=cat.id;

    // панель массовых действий (появляется, если выбрано >0)
    const massBar=document.createElement('div'); massBar.className='row'; massBar.style.display='none';
    const btnMassDelete=document.createElement('button'); btnMassDelete.textContent='Удалить выбранные';
    const btnMassMove=document.createElement('button'); btnMassMove.textContent='Переместить в...';
    const btnMassIcon=document.createElement('button'); btnMassIcon.textContent='Назначить иконку';
    massBar.append(btnMassDelete,btnMassMove,btnMassIcon);
    body.appendChild(massBar);

    const selectedSet=new Set(); // локальный выбор для массовых действий

    function updateMassBar(){
      massBar.style.display = selectedSet.size>0 ? 'flex' : 'none';
    }

    (cat.items||[]).forEach((it)=>{
      const line=document.createElement('div'); line.className='item-row draggable'; line.dataset.itemId=it.id;

      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'—'} lng:${it.lng??'—'}`;
      left.append(nm,meta);

      const tools=document.createElement('div'); tools.className='tools';
      const selCb=document.createElement('input'); selCb.type='checkbox';
      selCb.onchange=()=>{ if(selCb.checked) selectedSet.add(it.id); else selectedSet.delete(it.id); updateMassBar(); };

      const edit=document.createElement('button'); edit.textContent='✎';
      edit.onclick=()=>{const nn=prompt('Новое имя',it.name); if(nn!=null){it.name=(nn.trim()||it.name); commit();}};
      const upBtn=document.createElement('button'); upBtn.textContent='▲';
      upBtn.onclick=()=>{ const idx=cat.items.findIndex(x=>x.id===it.id); if(idx>0){ moveArrayItem(cat.items,idx,idx-1); commit(); } };
      const downBtn=document.createElement('button'); downBtn.textContent='▼';
      downBtn.onclick=()=>{ const idx=cat.items.findIndex(x=>x.id===it.id); if(idx<cat.items.length-1){ moveArrayItem(cat.items,idx,idx+1); commit(); } };
      const place=document.createElement('button'); place.textContent='📍';
      place.onclick=()=>{
        alert('Кликни по карте для: '+it.name);
        map.once('click', e=>{
          it.lat=e.latlng.lat; it.lng=e.latlng.lng; commit();
          map.setView([it.lat,it.lng],14);
        });
      };
      const clearBtn=document.createElement('button'); clearBtn.textContent='🗑 метка';
      clearBtn.onclick=()=>{it.lat=null; it.lng=null; commit();};
      const del=document.createElement('button'); del.textContent='❌'; del.className='danger';
      del.onclick=()=>{if(confirm('Удалить "'+it.name+'"?')){cat.items=cat.items.filter(x=>x.id!==it.id); commit();}};

      line.onclick=()=>{ if(it.lat!=null&&it.lng!=null){ map.setView([it.lat,it.lng],14); } };
      tools.append(selCb,edit,upBtn,downBtn,place,clearBtn,del);
      line.append(left,tools); list.appendChild(line);
    });
    body.appendChild(list);

    // массовые действия — обработчики
    btnMassDelete.onclick=()=>{
      if(selectedSet.size===0) return;
      if(!confirm(`Удалить выбранные (${selectedSet.size})?`)) return;
      cat.items=cat.items.filter(it=>!selectedSet.has(it.id));
      selectedSet.clear(); commit();
    };
    btnMassMove.onclick=()=>{
      if(selectedSet.size===0) return;
      const destId=prompt('ID категории-назначения (или оставь пустым для отмены):', db.categories.find(c=>c.id!==cat.id)?.id||"");
      if(!destId) return;
      const dest=db.categories.find(c=>c.id===destId); if(!dest){alert('Категория не найдена');return;}
      const moving=cat.items.filter(it=>selectedSet.has(it.id));
      cat.items=cat.items.filter(it=>!selectedSet.has(it.id));
      dest.items.push(...moving);
      selectedSet.clear(); commit();
    };
    btnMassIcon.onclick=()=>{
      if(selectedSet.size===0) return;
      openIconsLib(svg=>{
        const data=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
        cat.items.forEach(it=>{ if(selectedSet.has(it.id)) it.iconData=data; });
        selectedSet.clear(); commit();
      });
    };

    // добавление элемента + подсказки
    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='Новый элемент';
    const parentPicker=document.createElement('select');
    if(cat.parentCategoryId){
      const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
      parentPicker.innerHTML=`<option value="">(без родителя)</option>`+(parentCat?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }else{
      parentPicker.innerHTML=`<option value="">(родитель не задан)</option>`;
    }
    const addBtn=document.createElement('button'); addBtn.textContent='+ Добавить';
    addBtn.onclick=()=>{ const nm=inp.value.trim(); if(!nm) return; cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:parentPicker.value||null}); inp.value=''; commit(); };
    addRow.append(inp,parentPicker,addBtn); body.appendChild(addRow);
    attachSuggestions(inp); // автоподсказки

    sec.appendChild(body);
    head.onclick=()=>{
      if(collapsedCats.has(cat.id)) collapsedCats.delete(cat.id); else collapsedCats.add(cat.id);
      setCollapsedSet('collapsedCats_v1',collapsedCats);
      sec.classList.toggle('collapsed');
    };

    // drag&drop КАТЕГОРИЙ
    sec.draggable=true;
    sec.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain',JSON.stringify({catId:cat.id}));
      sec.classList.add('dragging');
    });
    sec.addEventListener('dragend',()=>sec.classList.remove('dragging'));
    sec.addEventListener('dragover',e=>{ e.preventDefault(); });
    sec.addEventListener('drop',e=>{
      e.preventDefault();
      const payload=JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
      if(!payload.catId) return;
      const fromIdx=db.categories.findIndex(c=>c.id===payload.catId);
      const toIdx  =db.categories.findIndex(c=>c.id===sec.dataset.catId);
      if(fromIdx<0 || toIdx<0 || fromIdx===toIdx) return;
      moveArrayItem(db.categories,fromIdx,toIdx); commit();
    });

    // drag&drop ЭЛЕМЕНТОВ внутри категории
    [...list.children].forEach(row=>{
      row.draggable=true;
      row.addEventListener('dragstart',e=>{
        e.dataTransfer.setData('text/plain',JSON.stringify({catId:cat.id,itemId:row.dataset.itemId}));
        row.classList.add('dragging');
      });
      row.addEventListener('dragend',()=>row.classList.remove('dragging'));
      row.addEventListener('dragover',e=>{ e.preventDefault(); });
      row.addEventListener('drop',e=>{
        e.preventDefault();
        const payload=JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
        if(payload.catId!==cat.id) return; // перенос между категориями через mass move
        const fromIdx=cat.items.findIndex(x=>x.id===payload.itemId);
        const toIdx  =cat.items.findIndex(x=>x.id===row.dataset.itemId);
        if(fromIdx<0 || toIdx<0 || fromIdx===toIdx) return;
        moveArrayItem(cat.items,fromIdx,toIdx); commit();
      });
    });

    $editor.appendChild(sec);
  });
}

/* === Предпросмотр (каскад) === */
function dropChildrenSelections(parentCatId){
  const children=db.categories.filter(c=>c.parentCategoryId===parentCatId);
  for(const ch of children){ delete selected[ch.id]; dropChildrenSelections(ch.id); }
}
const $cascade=document.querySelector('#previewTab .panel:first-child #cascadeBox') || document.getElementById('cascadeBox');
function renderPreview(){
  if(!$cascade) return;
  $cascade.innerHTML=""; clearMarkers();

  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel'; box.dataset.catId=cat.id;
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);

    let parentIds=null;
    if(cat.parentCategoryId){
      const parentSelected=getSelectedIds(cat.parentCategoryId);
      if(parentSelected.length===0){
        const note=document.createElement('div'); note.className='note';
        note.textContent='Сначала выбери: '+(db.categories.find(c=>c.id===cat.parentCategoryId)?.name||'родителя');
        box.appendChild(note); $cascade.appendChild(box); return;
      }
      parentIds=parentSelected;
    }

    let items=(cat.items||[]);
    if(parentIds){ items=items.filter(it=>it.parentId && parentIds.includes(it.parentId)); }
    if(items.length===0){
      const note=document.createElement('div'); note.className='note gray'; note.textContent='Нет элементов';
      box.appendChild(note); $cascade.appendChild(box); return;
    }

    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.style.width='100%';
      sel.innerHTML=`<option value="">— выберите —</option>`+items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      if(typeof selected[cat.id]==='string') sel.value=selected[cat.id]||"";
      sel.onchange=()=>{ selected[cat.id]=sel.value||null; dropChildrenSelections(cat.id); saveSelected(); renderPreview(); updatePolygonVisibility(); };
      box.appendChild(sel);
    }else{
      const multi=document.createElement('div'); multi.className='multi-select';
      const btn=document.createElement('div'); btn.className='multi-select-btn';
      const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();

      function updateBtnText(){
        if(set.size===0){ btn.textContent='Выбрать...'; }
        else{
          const names=items.filter(x=>set.has(x.id)).map(x=>x.name);
          btn.textContent = names.length<=5 ? names.join(', ') : `Выбрано: ${names.length}`;
        }
      }
      updateBtnText();
      btn.onclick=()=>openMultiModal(cat, items);
      multi.append(btn); box.appendChild(multi);
    }

    $cascade.appendChild(box);
  });

  // метки по выбранным
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    for(const id of ids){
      const it=(cat.items||[]).find(x=>x.id===id);
      if(it && it.lat!=null && it.lng!=null) addMarkerForItem(it,cat);
    }
  }
  updatePolygonVisibility();
}

/* === Вкладки === */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

/* === Экспорт/Импорт/Сброс === */
document.getElementById('btnExport').onclick=async ()=>{
  const full=JSON.parse(JSON.stringify(db));
  for(const cat of full.categories){
    if(cat.iconKey && !cat.iconData){ try{ cat.iconData=await lfIcons.getItem(cat.iconKey)||null; }catch(e){} }
    for(const it of (cat.items||[])){
      if(it.iconKey && !it.iconData){ try{ it.iconData=await lfIcons.getItem(it.iconKey)||null; }catch(e){} }
    }
  }
  for(const p of (full.polygons||[])){
    if(!p.geojson){ try{ p.geojson=await lfGeo.getItem(p.id)||null; }catch(e){} }
  }
  const blob=new Blob([JSON.stringify(full,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_full_v38_9R.json'; a.click();
};
document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ()=>{
    try{
      let obj=JSON.parse(r.result);
      if(obj && obj.db) obj=obj.db;
      if(!Array.isArray(obj.categories)) throw new Error('Нет categories');
      if(!Array.isArray(obj.polygons))   obj.polygons=[];

      for(const cat of obj.categories){
        if(!cat.id) cat.id=uid();
        if(cat.iconData){
          const key=cat.iconKey||`cat_${cat.id}`;
          await lfIcons.setItem(key,cat.iconData);
          cat.iconKey=key;
        }
        for(const it of (cat.items||[])){
          if(!it.id) it.id=uid();
          if(it.iconData){
            const key=it.iconKey||`item_${it.id}`;
            await lfIcons.setItem(key,it.iconData);
            it.iconKey=key;
          }
        }
      }
      for(const p of obj.polygons){
        if(!p.id) p.id=uid();
        if(p.geojson){ await lfGeo.setItem(p.id,p.geojson); }
      }

      localStorage.setItem(KEY, JSON.stringify({
        categories:obj.categories.map(c=>({
          id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId||null,
          color:c.color,shape:c.shape,iconKey:c.iconKey||null,
          items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId||null,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
        })),
        polygons:(obj.polygons||[]).map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
      }));
      await loadDB(); loadSelected(); pushHistory(); renderAll();
      alert('Импортировано');
    }catch(err){ alert('Ошибка импорта: '+err.message); }
  };
  r.readAsText(f);
};
document.getElementById('btnReset').onclick=()=>{
  if(confirm('Очистить всё?')){
    localStorage.removeItem(KEY);
    localStorage.removeItem('selected_v1');
    localStorage.removeItem('polyEditingId');
    localStorage.removeItem('collapsedPolygons_v1');
    localStorage.removeItem('collapsedCats_v1');
    lfIcons.clear().then(()=>{}); lfGeo.clear().then(()=>{});
    location.reload();
  }
};

/* === Главный рендер === */
async function renderAll(){
  rebuildPolys();
  renderEditor();
  renderPreview();
}

/* === Старт === */
(async()=>{
  await loadDB();
  loadSelected();
  mountPolygonPanel();
  renderAll();
})();
</script>
</body>
</html>
