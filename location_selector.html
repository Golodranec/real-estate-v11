<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector_v37 — v36 + полигоны</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<!-- Leaflet.Draw -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:#d7e2f2;cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:460px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 8px 0}
h4{margin:0 0 8px 0}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:#111a2a}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px}
.drag-handle{cursor:grab;opacity:.8}
.dragging{opacity:.5;outline:1px dashed var(--accent)}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
.note{background:#0e1524;border:1px dashed #32405a;padding:8px;border-radius:8px;color:#9fb0c8}
.note.gray{opacity:.6}
#map{width:100%;height:100%}
.preview-icon{width:20px;height:20px;border-radius:4px;border:1px solid #31405a;background:#0f1624;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview-icon img{max-width:100%;max-height:100%;display:block}

/* мультиселект */
.multi-select{position:relative;width:100%}
.multi-select-btn{width:100%;padding:6px 8px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.multi-select-menu{position:absolute;top:100%;left:0;right:0;background:var(--panel2);border:1px solid var(--border);border-radius:12px;z-index:2000;max-height:260px;overflow:auto;display:none;text-align:left}
.multi-select.open .multi-select-menu{display:block}
.multi-select-menu label{display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer}
.multi-select-menu label:hover{background:#1f293d}
.multi-select-menu input[type="checkbox"]{
  appearance:none;-webkit-appearance:none;
  width:16px;height:16px;border:2px solid var(--accent);border-radius:4px;
  background:#1a2234;cursor:pointer;position:relative;flex:0 0 16px
}
.multi-select-menu input[type="checkbox"]:checked{
  background:var(--accent);border-color:var(--accent);
}
.multi-select-menu input[type="checkbox"]:checked::after{
  content:"✔";position:absolute;top:-2px;left:2px;font-size:14px;color:#fff
}

/* поиск */
#globalSearch{width:100%;padding:6px 8px;margin-bottom:8px;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.search-results{max-height:200px;overflow:auto;margin-top:6px}
.search-results div{padding:4px 6px;border-bottom:1px solid var(--border);cursor:pointer}
.search-results div:hover{background:#1f293d}

/* полигоны */
.poly-tools .btn{padding:6px 10px}
.poly-list .poly-item{display:flex;justify-content:space-between;align-items:center;gap:8px;border:1px dashed #31405a;background:#10192a}
.poly-left{display:grid;gap:4px}
.poly-name{font-weight:700}
.poly-meta{font-size:12px;color:#9fb0c8}
.poly-right{display:flex;gap:6px;align-items:center}
.dot{width:12px;height:12px;border-radius:50%}
.toggle{display:flex;gap:6px;align-items:center;font-size:12px;color:#9fb0c8}
</style>
</head>
<body>
<header>
  <span class="badge">dictionary v37</span>
  <button id="btnExport">Экспорт</button>
  <button id="btnImport">Импорт</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnReset" class="danger">Сброс</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">Редактор</div>
  <div class="tab" data-tab="preview">Предпросмотр</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>

  <aside class="sidebar" id="previewTab" style="display:none">
    <!-- Новый блок: полигоны -->
    <div class="panel" id="polyPanel">
      <h3>Зоны на карте (полигоны)</h3>
      <div class="row poly-tools">
        <input id="polyName" placeholder="Название зоны (например: Юнусабад-9)" style="flex:1"/>
        <input id="polyColor" type="color" value="#ff4d4f" style="width:56px;padding:0;height:36px"/>
        <button id="btnPolyNew">+ Полигон</button>
        <button id="btnPolyEdit">Редакт.</button>
        <button id="btnPolyStop">Стоп</button>
        <button id="btnPolyShowAll">Показать</button>
        <button id="btnPolyHideAll">Скрыть</button>
      </div>
      <div class="help">Кликай по карте, двойной клик завершает. Редактирование включает перемещение вершин. Площадь и периметр считаются автоматически.</div>
      <div class="sep"></div>
      <div class="list poly-list" id="polyList"></div>
    </div>

    <div class="panel">
      <h3>Предпросмотр каскада</h3>
      <input id="globalSearch" placeholder="Поиск по элементам..."/>
      <div id="searchResults" class="search-results"></div>
      <div class="help">До 5 названий видно в кнопке, дальше счётчик. Клики по чекбоксам не закрывают меню.</div>
      <div id="cascadeBox" style="margin-top:8px"></div>
    </div>
  </aside>

  <div id="map"></div>
</main>

<!-- libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script>
/***** STORAGE (основной словарь, как в v36) *****/
const KEY="dict_v14";
let db=loadDB();
function loadDB(){
  const v14=localStorage.getItem("dict_v14");
  if(v14){try{const obj=JSON.parse(v14);normalize(obj);return obj;}catch(e){}}
  const fresh={categories:[]};save(fresh);return fresh;
}
function save(obj=db){localStorage.setItem(KEY,JSON.stringify(obj));}
function uid(){return Math.random().toString(36).slice(2,9);}
function normalize(obj){
  if(!obj||typeof obj!=="object")obj={categories:[]};
  obj.categories=Array.isArray(obj.categories)?obj.categories:[];
  obj.categories.forEach(c=>{
    if(!("type" in c))c.type="select";
    if(!("items" in c))c.items=[];
    if(!("color" in c))c.color="#3388ff";
    if(!("shape" in c))c.shape="circle";
    if(!("parentCategoryId" in c))c.parentCategoryId=null;
    c.items.forEach(it=>{
      if(!("id" in it))it.id=uid();
      if(!("name" in it))it.name="Без имени";
      if(!("lat" in it))it.lat=null;
      if(!("lng" in it))it.lng=null;
      if(!("parentId" in it))it.parentId=null;
    });
  });
}
/***** POLYGON STORAGE *****/
const POLY_KEY="dict_v37_polygons";
let polyState=loadPolyState();      // {polygons: Array}
function loadPolyState(){
  try{
    const raw=localStorage.getItem(POLY_KEY);
    if(raw){
      const st=JSON.parse(raw);
      if(!st || !Array.isArray(st.polygons)) return {polygons:[]};
      return st;
    }
  }catch(e){}
  return {polygons:[]};
}
function savePolyState(){localStorage.setItem(POLY_KEY,JSON.stringify(polyState));}

function fmtArea(m2){
  if(!m2 && m2!==0) return '-';
  return m2<100000 ? `${m2.toFixed(0)} м²` : `${(m2/10000).toFixed(2)} га`;
}
function fmtPerim(m){return `${m.toFixed(0)} м`;}

/***** MAP + CLUSTERS (как в v36) *****/
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let cluster=L.markerClusterGroup();
map.addLayer(cluster);
function clearMarkers(){cluster.clearLayers();}
function markerIcon(cat){
  if(cat.iconData) return L.icon({iconUrl:cat.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  const color=cat.color||"#3388ff"; const shape=cat.shape||"circle"; let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html,iconSize:[20,20],iconAnchor:[10,10]});
}
function addMarkerForItem(it,cat){
  if(it.lat==null||it.lng==null) return;
  const m=L.marker([it.lat,it.lng],{icon:markerIcon(cat)});
  m.bindPopup(`<b>${it.name}</b><br/><button onclick="removeMarkerById('${it.id}')">🗑 Удалить метку</button>`);
  cluster.addLayer(m);
}
window.removeMarkerById=function(id){
  for(const c of db.categories){
    const it=(c.items||[]).find(x=>x.id===id);
    if(it){it.lat=null;it.lng=null;break;}
  }
  save(); renderAll();
}

/***** POLYGONS RUNTIME *****/
const polyFG=new L.FeatureGroup(); // слои полигонов
map.addLayer(polyFG);

let polyDrawCtl=null;
let polyEditing=false;
let polyEditToolbar=null;
const polyIndex=new Map(); // id -> Leaflet layer

function polygonAreaPerimeter(geojson){
  try{
    const area=turf.area(geojson); // м²
    const line=turf.polygonToLine(geojson);
    const perKm=turf.length(line,{units:'kilometers'});
    return {area, perim: perKm*1000};
  }catch(e){return {area:0, perim:0};}
}

function layerFromGeo(geo,color){
  const g=L.geoJSON(geo,{style:{color:color||'#ff4d4f',weight:2,fillOpacity:0.12}});
  let l=null; g.eachLayer(x=>l=x); return l;
}
function fitLayer(l){try{map.fitBounds(l.getBounds(),{padding:[18,18]})}catch{}}

function rebuildPolygons(){
  polyIndex.clear();
  polyFG.clearLayers();
  for(const p of polyState.polygons){
    const l=layerFromGeo(p.geojson,p.color);
    if(!l) continue;
    l.addTo(polyFG);
    if(p.visible===false) map.removeLayer(l);
    polyIndex.set(p.id,l);
  }
  renderPolyList();
}

/***** POLYGONS UI *****/
const $polyList=document.getElementById('polyList');
const $polyName=document.getElementById('polyName');
const $polyColor=document.getElementById('polyColor');
const $btnPolyNew=document.getElementById('btnPolyNew');
const $btnPolyEdit=document.getElementById('btnPolyEdit');
const $btnPolyStop=document.getElementById('btnPolyStop');
const $btnPolyShowAll=document.getElementById('btnPolyShowAll');
const $btnPolyHideAll=document.getElementById('btnPolyHideAll');

function renderPolyList(){
  $polyList.innerHTML='';
  polyState.polygons.forEach(p=>{
    const row=document.createElement('div'); row.className='item poly-item'; row.dataset.id=p.id;
    const left=document.createElement('div'); left.className='poly-left';
    const name=document.createElement('div'); name.className='poly-name'; name.textContent=p.name||'Без названия';
    const meta=document.createElement('div'); meta.className='poly-meta';
    meta.textContent=`Площадь: ${fmtArea(p.area||0)} · Периметр: ${fmtPerim(p.perim||0)}`;
    left.append(name,meta);

    const right=document.createElement('div'); right.className='poly-right';
    const dot=document.createElement('span'); dot.className='dot'; dot.style.background=p.color||'#ff4d4f';
    const toggle=document.createElement('label'); toggle.className='toggle';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=p.visible!==false;
    toggle.append(cb,document.createTextNode('видим'));

    const btnZoom=document.createElement('button'); btnZoom.textContent='Фокус';
    const btnRename=document.createElement('button'); btnRename.textContent='Переим.';
    const btnColor=document.createElement('button'); btnColor.textContent='Цвет';
    const btnDel=document.createElement('button'); btnDel.textContent='Удалить'; btnDel.className='danger';

    right.append(dot,toggle,btnZoom,btnRename,btnColor,btnDel);
    row.append(left,right); $polyList.appendChild(row);

    cb.onchange=()=>{
      p.visible=cb.checked;
      const l=polyIndex.get(p.id);
      if(l){ p.visible?l.addTo(map):map.removeLayer(l); }
      savePolyState();
    };
    btnZoom.onclick=()=>{ const l=polyIndex.get(p.id); if(l) fitLayer(l); };
    btnRename.onclick=()=>{
      const nn=prompt('Новое имя',p.name||''); if(nn!=null){p.name=nn.trim()||'Без названия'; savePolyState(); renderPolyList();}
    };
    btnColor.onclick=()=>{
      const nv=prompt('Цвет (hex)',p.color||'#ff4d4f'); if(!nv) return;
      p.color=nv;
      const l=polyIndex.get(p.id); if(l && l.setStyle) l.setStyle({color:nv});
      savePolyState(); renderPolyList();
    };
    btnDel.onclick=()=>{
      if(!confirm('Удалить полигон?')) return;
      const l=polyIndex.get(p.id); if(l) polyFG.removeLayer(l);
      polyIndex.delete(p.id);
      polyState.polygons=polyState.polygons.filter(x=>x.id!==p.id);
      savePolyState(); renderPolyList();
    };
  });
}

function bindPolyButtons(){
  // Контрол рисования
  polyDrawCtl=new L.Control.Draw({
    position:'topleft',
    draw:{
      marker:false, polyline:false, rectangle:false, circle:false, circlemarker:false,
      polygon:{allowIntersection:false, showArea:true, guidelineDistance:8,
        shapeOptions:{color:'#ff4d4f',weight:2,fillOpacity:.12}}
    },
    edit:{featureGroup:polyFG, remove:false}
  });
  map.addControl(polyDrawCtl);

  $btnPolyNew.onclick=()=>{
    const opt=polyDrawCtl.options.draw.polygon;
    // цвет из инпута:
    opt.shapeOptions.color=$polyColor.value||'#ff4d4f';
    new L.Draw.Polygon(map,opt).enable();
    // Подсказка визуально оставим в help
  };

  $btnPolyEdit.onclick=()=>{
    if(polyEditing) return;
    polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
    polyEditToolbar.enable();
    polyEditing=true;
  };
  $btnPolyStop.onclick=()=>{
    if(polyEditing && polyEditToolbar){
      polyEditToolbar.disable(); polyEditing=false;
      map.fire(L.Draw.Event.EDITSTOP);
    }
  };

  $btnPolyShowAll.onclick=()=>{
    polyState.polygons.forEach(p=>p.visible=true);
    rebuildPolygons();
    // ничего больше
  };
  $btnPolyHideAll.onclick=()=>{
    polyState.polygons.forEach(p=>p.visible=false);
    rebuildPolygons();
  };
}

/***** CREATED / EDITED *****/
map.on(L.Draw.Event.CREATED, e=>{
  if(!(e.layer instanceof L.Polygon)) return; // игнор прочих
  const layer=e.layer;
  const color=$polyColor.value||'#ff4d4f';
  if(layer.setStyle) layer.setStyle({color,weight:2,fillOpacity:.12});
  polyFG.addLayer(layer);

  const gj=layer.toGeoJSON();
  const m=polygonAreaPerimeter(gj);
  const rec={id:uid(), name:($polyName.value||`Полигон ${polyState.polygons.length+1}`).trim(), color, visible:true, geojson:gj, area:m.area, perim:m.perim};
  polyState.polygons.push(rec);
  polyIndex.set(rec.id,layer);
  savePolyState();
  renderPolyList();
});

map.on(L.Draw.Event.EDITSTOP, ()=>{
  // перебираем все записи и актуализируем геометрию/метрики
  for(const p of polyState.polygons){
    const l=polyIndex.get(p.id);
    if(!l) continue;
    const gj=l.toGeoJSON();
    const m=polygonAreaPerimeter(gj);
    p.geojson=gj; p.area=m.area; p.perim=m.perim;
  }
  savePolyState();
  renderPolyList();
});
/***** EDITOR (как в v36, без изменений логики) *****/
const $editor=document.getElementById('editorTab');
function renderEditor(){
  $editor.innerHTML="";

  // создание категории
  const create=document.createElement('div');create.className='panel';
  create.innerHTML=`
    <h3>Новая категория</h3>
    <div class="row">
      <input id="newCatName" placeholder="Название (Страны, Города, Районы...)"/>
      <select id="newCatType"><option value="select">Select</option><option value="checkbox">Checkbox</option></select>
      <select id="newCatParent">
        <option value="">(нет родителя)</option>
        ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
    </div>
    <div class="row">
      <span class="preview-icon" id="newIconPreview">icon</span>
      <input type="color" id="newCatColor" value="#3388ff"/>
      <select id="newCatShape"><option value="circle">Круг</option><option value="square">Квадрат</option><option value="triangle">Треугольник</option></select>
      <input type="file" id="newCatIcon" accept="image/png,image/svg+xml"/>
      <button id="btnAddCat">+ Добавить</button>
    </div>`;
  $editor.appendChild(create);

  const newIconInput=create.querySelector('#newCatIcon');
  const newIconPreview=create.querySelector('#newIconPreview');
  let newIconData=null;
  newIconInput.onchange=e=>{
    const f=e.target.files[0]; if(!f){newIconData=null;newIconPreview.textContent='icon';return;}
    const r=new FileReader(); r.onload=ev=>{newIconData=ev.target.result;newIconPreview.innerHTML=`<img src="${newIconData}">`;}; r.readAsDataURL(f);
  };
  create.querySelector('#btnAddCat').onclick=()=>{
    const name=document.getElementById('newCatName').value.trim(); if(!name) return;
    const type=document.getElementById('newCatType').value;
    const parent=document.getElementById('newCatParent').value||null;
    const color=document.getElementById('newCatColor').value;
    const shape=document.getElementById('newCatShape').value;
    const cat={id:uid(),name,type,parentCategoryId:parent,color,shape,items:[]};
    if(newIconData) cat.iconData=newIconData;
    db.categories.push(cat); save(); renderAll();
  };

  // список категорий
  db.categories.forEach((cat,ci)=>{
    const sec=document.createElement('div'); sec.className='panel';
    const header=document.createElement('div'); header.className='row';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    header.append(title); sec.appendChild(header);

    const cfg=document.createElement('div'); cfg.className='row';
    const inpName=document.createElement('input'); inpName.value=cat.name;
    const selType=document.createElement('select'); ['select','checkbox'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(cat.type===t)o.selected=true;selType.appendChild(o);});
    const selParent=document.createElement('select'); selParent.innerHTML=`<option value="">(нет родителя)</option>`+db.categories.map(c=>c.id!==cat.id?`<option value="${c.id}" ${cat.parentCategoryId===c.id?'selected':''}>${c.name}</option>`:'').join('');
    const col=document.createElement('input'); col.type='color'; col.value=cat.color||'#3388ff';
    const shape=document.createElement('select'); ['circle','square','triangle'].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if((cat.shape||'circle')===s)o.selected=true;shape.appendChild(o);});
    const iconPrev=document.createElement('span'); iconPrev.className='preview-icon'; iconPrev.innerHTML=cat.iconData?`<img src="${cat.iconData}">`:'icon';
    const btnClearIcon=document.createElement('button'); btnClearIcon.textContent='✖ иконка';
    btnClearIcon.onclick=()=>{delete cat.iconData; iconPrev.textContent='icon'; save();};

    cfg.append(inpName,selType,selParent,col,shape,iconPrev,btnClearIcon);
    sec.appendChild(cfg);

    // элементы
    const list=document.createElement('div'); list.className='list';
    (cat.items||[]).forEach((it,ii)=>{
      const line=document.createElement('div'); line.className='item';
      const left=document.createElement('div'); left.className='left';
      const nm=document.createElement('div'); nm.className='name'; nm.textContent=it.name;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`lat:${it.lat??'—'} lng:${it.lng??'—'}`;
      left.append(nm,meta);

      const tools=document.createElement('div'); tools.className='tools';
      const edit=document.createElement('button'); edit.textContent='✎';
      edit.onclick=()=>{const nn=prompt('Новое имя',it.name); if(nn){it.name=nn.trim(); save(); renderAll();}};
      const place=document.createElement('button'); place.textContent='📍';
      place.onclick=()=>{
        alert('Кликни по карте для: '+it.name);
        map.once('click', e=>{
          it.lat=e.latlng.lat; it.lng=e.latlng.lng; save();
          meta.textContent=`lat:${it.lat.toFixed(5)} lng:${it.lng.toFixed(5)}`;
          addMarkerForItem(it,cat);
          map.setView([it.lat,it.lng],14);
        });
      };
      const clearBtn=document.createElement('button'); clearBtn.textContent='🗑 метка';
      clearBtn.onclick=()=>{it.lat=null; it.lng=null; save(); renderAll();};
      const del=document.createElement('button'); del.textContent='❌'; del.className='danger';
      del.onclick=()=>{if(confirm('Удалить "'+it.name+'"?')){cat.items.splice(ii,1); save(); renderAll();}};

      line.onclick=()=>{ if(it.lat!=null&&it.lng!=null){ map.setView([it.lat,it.lng],14); } };
      tools.append(edit,place,clearBtn,del);
      line.append(left,tools); list.appendChild(line);
    });
    sec.appendChild(list);

    // добавление элемента с выбором родителя
    const addRow=document.createElement('div'); addRow.className='row';
    const inp=document.createElement('input'); inp.placeholder='Новый элемент';
    const parentPicker=document.createElement('select');
    if(cat.parentCategoryId){
      const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
      parentPicker.innerHTML=`<option value="">(без родителя)</option>`+(parentCat?.items||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }else{
      parentPicker.innerHTML=`<option value="">(родитель не задан)</option>`;
    }
    const addBtn=document.createElement('button'); addBtn.textContent='+ Добавить';
    addBtn.onclick=()=>{
      const nm=inp.value.trim()||'Новый';
      cat.items=cat.items||[];
      cat.items.push({id:uid(),name:nm,lat:null,lng:null,parentId:parentPicker.value||null});
      inp.value=''; save(); renderAll();
    };
    addRow.append(inp,parentPicker,addBtn); sec.appendChild(addRow);

    $editor.appendChild(sec);
  });
}

/***** PREVIEW (как в v36) *****/
const $cascade=document.getElementById('cascadeBox');
let selected={};
let reopenMultiCatId=null;

function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId);
  const v=selected[catId];
  if(!v) return [];
  return (cat && cat.type==='checkbox')?Array.from(v):(v?[v]:[]);
}
function dropChildrenSelections(parentCatId){
  const children=db.categories.filter(c=>c.parentCategoryId===parentCatId);
  for(const ch of children){
    delete selected[ch.id];
    dropChildrenSelections(ch.id);
  }
}

function renderPreview(){
  $cascade.innerHTML="";
  clearMarkers();

  db.categories.forEach(cat=>{
    const box=document.createElement('div'); box.className='panel'; box.dataset.catId=cat.id;
    const h=document.createElement('h4'); h.textContent=cat.name; box.appendChild(h);

    let parentIds=null;
    if(cat.parentCategoryId){
      const parentSelected=getSelectedIds(cat.parentCategoryId);
      if(parentSelected.length===0){
        const note=document.createElement('div'); note.className='note';
        note.textContent='Сначала выбери: '+(db.categories.find(c=>c.id===cat.parentCategoryId)?.name||'родителя');
        box.appendChild(note); $cascade.appendChild(box); return;
      }
      parentIds=parentSelected;
    }

    let items=(cat.items||[]);
    if(parentIds){ items=items.filter(it=>it.parentId && parentIds.includes(it.parentId)); }
    if(items.length===0){
      const note=document.createElement('div'); note.className='note gray'; note.textContent='Нет элементов';
      box.appendChild(note); $cascade.appendChild(box); return;
    }

    if(cat.type==='select'){
      const sel=document.createElement('select'); sel.style.width='100%';
      sel.innerHTML=`<option value="">— выберите —</option>`+items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
      if(typeof selected[cat.id]==='string') sel.value=selected[cat.id]||"";
      sel.onchange=()=>{ selected[cat.id]=sel.value||null; dropChildrenSelections(cat.id); renderPreview(); };
      box.appendChild(sel);
    }else{
      const multi=document.createElement('div'); multi.className='multi-select';
      const btn=document.createElement('div'); btn.className='multi-select-btn'; btn.textContent='Выбрать...';
      const menu=document.createElement('div'); menu.className='multi-select-menu';
      const set=selected[cat.id] instanceof Set?selected[cat.id]:new Set();

      function updateBtnText(){
        if(set.size===0){ btn.textContent='Выбрать...'; }
        else{
          const names=items.filter(x=>set.has(x.id)).map(x=>x.name);
          btn.textContent = names.length<=5 ? names.join(', ') : `Выбрано: ${names.length}`;
        }
      }
      updateBtnText();

      items.forEach(it=>{
        const lbl=document.createElement('label');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=it.id; cb.checked=set.has(it.id);
        cb.onchange=()=>{
          if(cb.checked) set.add(it.id); else set.delete(it.id);
          selected[cat.id]=set;
          dropChildrenSelections(cat.id);
          updateBtnText();
          reopenMultiCatId=cat.id;
          renderPreview();
        };
        lbl.append(cb,document.createTextNode(it.name));
        menu.appendChild(lbl);
      });

      btn.onclick=()=>{ multi.classList.toggle('open'); };
      multi.append(btn,menu); box.appendChild(multi);
    }

    $cascade.appendChild(box);
  });

  // метки по выбранным
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    for(const id of ids){
      const it=(cat.items||[]).find(x=>x.id===id);
      if(it && it.lat!=null && it.lng!=null) addMarkerForItem(it,cat);
    }
  }

  // вернуть открытым нужный мультиселект
  if(reopenMultiCatId){
    const panel=$cascade.querySelector(`.panel[data-cat-id="${reopenMultiCatId}"] .multi-select`);
    if(panel) panel.classList.add('open');
    reopenMultiCatId=null;
  }
}
/***** SEARCH *****/
const $search=document.getElementById('globalSearch');
const $results=document.getElementById('searchResults');
$search.oninput=()=>{
  const q=$search.value.trim().toLowerCase();
  $results.innerHTML="";
  if(!q) return;

  const out=[];
  db.categories.forEach(cat=>{
    (cat.items||[]).forEach(it=>{
      if(it.name.toLowerCase().includes(q)){
        out.push({cat,it});
      }
    });
  });
  out.forEach(r=>{
    const row=document.createElement('div');
    row.textContent=`${r.it.name} (${r.cat.name})`;
    row.onclick=()=>{
      if(r.cat.type==='select') selected[r.cat.id]=r.it.id;
      else{
        if(!(selected[r.cat.id] instanceof Set)) selected[r.cat.id]=new Set();
        selected[r.cat.id].add(r.it.id);
      }
      renderPreview();
      if(r.it.lat!=null && r.it.lng!=null) map.setView([r.it.lat,r.it.lng],14);
      $search.value=""; $results.innerHTML="";
    };
    $results.appendChild(row);
  });
};

/***** EXPORT/IMPORT + TABS + INIT *****/
document.getElementById('btnExport').onclick=()=>{
  normalize(db);
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_v37.json'; a.click();
};
document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      let obj=JSON.parse(r.result);
      if(Array.isArray(obj.categories)){} else if(obj&&obj.db&&Array.isArray(obj.db.categories)){obj=obj.db;}
      else throw new Error('Нет поля categories');
      normalize(obj); db=obj; save(); selected={}; renderAll(); alert('Импортировано');
    }catch(err){ alert('Ошибка импорта: '+err.message); }
  };
  r.readAsText(f);
};
document.getElementById('btnReset').onclick=()=>{ if(confirm('Очистить всё?')){ localStorage.removeItem(KEY); localStorage.removeItem(POLY_KEY); location.reload(); } };

document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

function renderAll(){ renderEditor(); renderPreview(); }

rebuildPolygons();
bindPolyButtons();
renderAll();
</script>
</body>
</html>
