<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>location_selector v39.2R — стабилка на базе v38.9R + расширенный импорт/экспорт + предпросмотр</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Leaflet MarkerCluster (на будущее) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- localForage для локального хранения -->
  <script src="https://unpkg.com/localforage@1.10.0/dist/localforage.min.js"></script>

  <!-- Fuse.js для быстрого поиска по спискам -->
  <script src="https://unpkg.com/fuse.js@7.0.0"></script>

  <!-- FileSaver для экспорта JSON -->
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#0f1115;
      --panel:#151923;
      --panel-2:#1c2231;
      --text:#e7eaf1;
      --muted:#97a0b8;
      --accent:#5aa9ff;
      --good:#1db954;
      --warn:#ffcc00;
      --bad:#ff4d4f;
      --border:#2a3245;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .wrap{display:grid;grid-template-columns:360px 1fr;height:100vh;width:100vw;}
    .panel{
      background:var(--panel);
      border-right:1px solid var(--border);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .row{display:grid;grid-template-columns:1fr;gap:8px}
    label{font-size:12px;color:var(--muted)}
    select, input[type="text"], input[type="number"], button, .btn{
      width:100%;
      padding:10px 12px;
      background:var(--panel-2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      font-size:14px;
    }
    select:focus, input:focus{border-color:var(--accent)}
    .btn{cursor:pointer;text-align:center;user-select:none;}
    .btn.inline{width:auto;display:inline-flex;gap:8px;align-items:center;padding:8px 12px}
    .btn.primary{background:var(--accent);border-color:transparent;color:#07131f;font-weight:600}
    .btn.good{background:var(--good);border-color:transparent;color:#07131f;font-weight:600}
    .btn.warn{background:var(--warn);border-color:transparent;color:#111;font-weight:600}
    .btn.bad{background:var(--bad);border-color:transparent;color:#fff;font-weight:600}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .muted{color:var(--muted);font-size:12px}
    .small{font-size:12px}
    .map{height:100vh;width:100%;}
    .card{background:var(--panel-2);border:1px solid var(--border);padding:12px;border-radius:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .hr{height:1px;background:var(--border);margin:6px 0}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{padding:6px 10px;background:#0d1320;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
    .toast{
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#121826;border:1px solid var(--border);color:var(--text);
      padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      z-index:9999;
    }
    .toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-6px)}
    .kbd{
      border:1px solid var(--border);
      padding:2px 6px;border-radius:6px;background:#0b0f18;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:var(--muted)
    }
    a.link{color:var(--accent);text-decoration:none}
    .row .hint{display:flex;justify-content:space-between;align-items:center}
    /* Контрол на карте */
    .coord-control{
      background:rgba(21,25,35,.95);
      border:1px solid var(--border);
      color:var(--text);
      padding:8px;
      border-radius:12px;
      display:flex;
      gap:6px;
      align-items:center;
      backdrop-filter: blur(6px);
    }
    .coord-control input{
      width:120px;
      padding:6px 8px;
      background:var(--panel-2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:8px;
      font-size:12px;
      outline:none;
    }
    .coord-control button{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--accent);
      color:#07131f;
      font-weight:600;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="panel">
      <div class="row">
        <div class="hint">
          <strong>location_selector v39.2R</strong>
          <span class="muted">на базе v38.9R • предпросмотр • расширенный импорт/экспорт</span>
        </div>
        <div class="chips">
          <span class="chip">LS API совместим</span>
          <span class="chip">Undo Redo</span>
          <span class="chip">GeoJSON</span>
          <span class="chip">Local cache</span>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <label for="search">Быстрый поиск по спискам</label>
          <input id="search" type="text" placeholder="введите город, район или улицу"/>
        </div>
        <div class="hr"></div>
        <div class="row">
          <label for="city">Город</label>
          <select id="city"></select>
        </div>
        <div class="row">
          <label for="district">Район</label>
          <select id="district"></select>
        </div>
        <div class="row">
          <label for="street">Улица</label>
          <select id="street"></select>
        </div>
        <div class="row">
          <label for="note">Подсказка к адресу</label>
          <input id="note" type="text" placeholder="ориентир, подъезд, этаж"/>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div class="hint"><label>Координаты</label><span class="muted">клик по карте ставит маркер</span></div>
          <div class="grid-2">
            <input id="lat" type="number" step="0.000001" placeholder="широта"/>
            <input id="lng" type="number" step="0.000001" placeholder="долгота"/>
          </div>
          <div class="toolbar">
            <button class="btn inline" id="setFromInputs">Поставить по вводу</button>
            <button class="btn inline" id="copyCoords">Скопировать</button>
            <button class="btn inline bad" id="clearMarker">Убрать маркер</button>
          </div>
          <div class="muted small">Горячие клавиши: <span class="kbd">Ctrl</span> + клик — быстрый маркер. <span class="kbd">Del</span> — удалить выбранное.</div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div class="hint"><label>Фигура на карте</label><span class="muted">полигон/полилиния/окружность</span></div>
          <div class="toolbar">
            <button class="btn inline" id="btnFit">Показать объект</button>
            <button class="btn inline bad" id="btnClearShape">Очистить фигуру</button>
          </div>
          <div class="muted small">Используй инструменты рисования слева на карте</div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div class="hint"><label>Предпросмотр</label><span class="muted">скрывает/показывает метки и фигуры</span></div>
          <div class="toolbar">
            <label style="display:flex;align-items:center;gap:8px">
              <input id="previewToggle" type="checkbox"/>
              <span>Показывать объекты на карте</span>
            </label>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <label>История</label>
          <div class="toolbar">
            <button class="btn inline" id="undoBtn">Отменить</button>
            <button class="btn inline" id="redoBtn">Повторить</button>
            <button class="btn inline warn" id="resetBtn">Сбросить всё</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <label>Импорт и экспорт состояния</label>
          <div class="toolbar">
            <button class="btn primary" id="exportBtn">Экспорт JSON</button>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
            <button class="btn" id="importBtn">Импорт JSON</button>
          </div>
          <div class="muted small">Структура включает ids, адресную строку, координаты, GeoJSON и версию.</div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <label>Импорт и экспорт категорий</label>
          <div class="toolbar">
            <button class="btn" id="exportCategoriesBtn">Экспорт категорий</button>
            <input type="file" id="importCategoriesFile" accept="application/json" style="display:none"/>
            <button class="btn" id="importCategoriesBtn">Импорт категорий</button>
          </div>
          <div class="muted small">Частичное обновление: совпавшие id — обновляются, новые — добавляются. Остальное не трогаем.</div>
        </div>
      </div>

      <div class="row small muted">
        Советы
        <ul style="margin:6px 0 0 16px;padding:0;line-height:1.4">
          <li>Щелкни на карте — поставится маркер (если включен предпросмотр, он будет виден)</li>
          <li>Рисуй полигоны, чтобы сохранить зону</li>
          <li>Все действия пишутся в историю</li>
        </ul>
      </div>
    </aside>
    <main>
      <div id="map" class="map"></div>
    </main>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* =========================
   Данные по умолчанию (демо)
   ========================= */
const demoData = {
  cities: [
    {
      id: "tashkent",
      name: "Ташкент",
      center: [41.3111, 69.2797],
      zoom: 12,
      districts: [
        {
          id: "yunusabad",
          name: "Юнусабад",
          streets: [
            { id: "bogishamol", name: "Богишамол" },
            { id: "amirsamarkandiy", name: "Амир Самаркандий" },
            { id: "minor", name: "Минор" }
          ]
        },
        {
          id: "mirzo_ulugbek",
          name: "Мирзо Улугбек",
          streets: [
            { id: "buyuk_ipaк_yuli", name: "Буюк Ипак Йули" },
            { id: "sayram", name: "Сайрам" }
          ]
        },
        {
          id: "chilanzar",
          name: "Чиланзар",
          streets: [
            { id: "bunyodkor", name: "Бунёдкор" },
            { id: "qipchoq", name: "Кипчак" }
          ]
        }
      ]
    }
  ]
};

/* =========================
   Утилиты
   ========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function toast(msg, ms=1600){
  const el = $("#toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), ms);
}

function saveFile(name, text){
  const blob = new Blob([text], {type: "application/json;charset=utf-8"});
  saveAs(blob, name);
}

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(36).slice(2,9);
}

/* =========================
   Хранилище и история
   ========================= */
const store = localforage.createInstance({ name: "location_selector_v39_2R" });

const defaultState = {
  version: "v39.2R",
  cityId: null,
  districtId: null,
  streetId: null,
  note: "",
  marker: null,          // { lat, lng }
  geometry: null,        // GeoJSON
  previewEnabled: false, // ВАЖНО: показывать ли объекты на карте
  updatedAt: Date.now()
};

let state = structuredClone(defaultState);
let undoStack = [];
let redoStack = [];

async function loadState(){
  const data = await store.getItem("state");
  if(data){
    state = data;
  }
  const u = await store.getItem("history");
  if(u) undoStack = u;
  const r = await store.getItem("history_redo");
  if(r) redoStack = r;
}

async function persist(){
  state.updatedAt = Date.now();
  await store.setItem("state", state);
  await store.setItem("history", undoStack);
  await store.setItem("history_redo", redoStack);
}

function pushHistory(){
  undoStack.push(JSON.parse(JSON.stringify(state)));
  if(undoStack.length>200) undoStack.shift();
  redoStack.length = 0;
  persist();
}

function applyState(newState, push=false){
  if(push) pushHistory();
  state = JSON.parse(JSON.stringify(newState));
  refreshUIFromState();
  refreshMapFromState();
  persist();
}

/* =========================
   Работа с картой
   ========================= */
let map, drawnItems;
let pointLayer = null; // маркер (в слое)
let shapeLayer = null; // фигура (в слое)

function initMap(){
  map = L.map("map", {
    zoomControl: true,
    attributionControl: false
  }).setView([41.3111, 69.2797], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 20
  }).addTo(map);

  drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Контрол ввода координат прямо на карте
  const CoordControl = L.Control.extend({
    onAdd: function(){
      const container = L.DomUtil.create("div", "coord-control");
      container.innerHTML = `
        <input id="ctrl-lat" type="number" step="0.000001" placeholder="широта">
        <input id="ctrl-lng" type="number" step="0.000001" placeholder="долгота">
        <button id="ctrl-add">Добавить</button>
      `;
      L.DomEvent.disableClickPropagation(container);
      return container;
    },
    onRemove: function(){}
  });
  const coordControl = new CoordControl({ position: "topleft" });
  map.addControl(coordControl);

  setTimeout(()=>{
    const addBtn = document.getElementById("ctrl-add");
    addBtn?.addEventListener("click", ()=>{
      const lat = parseFloat(document.getElementById("ctrl-lat").value);
      const lng = parseFloat(document.getElementById("ctrl-lng").value);
      if(isFinite(lat) && isFinite(lng)){
        setMarker(lat, lng, true);
        toast("Маркер установлен по вводу");
      } else {
        toast("Введи корректные координаты");
      }
    });
  }, 0);

  // Leaflet Draw
  const drawControl = new L.Control.Draw({
    draw: {
      polygon: { allowIntersection: false, showArea: true },
      polyline: true,
      rectangle: true,
      circle: true,
      marker: true,
      circlemarker: false
    },
    edit: { featureGroup: drawnItems, remove: true }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED, function (e) {
    const type = e.layerType;
    const layer = e.layer;

    if(type === "marker"){
      // Сохраняем только один маркер в состоянии
      const {lat, lng} = layer.getLatLng();
      setMarker(lat, lng, true);
      toast("Маркер добавлен");
    } else {
      // Сохраняем одну фигуру
      shapeLayer = layer;
      state.geometry = shapeLayer.toGeoJSON();
      if(state.previewEnabled){
        drawnItems.addLayer(shapeLayer);
      }
      pushHistory();
      persist();
      toast("Фигура сохранена");
    }
  });

  map.on(L.Draw.Event.EDITED, function () {
    if(shapeLayer){
      state.geometry = shapeLayer.toGeoJSON();
      pushHistory();
      persist();
      toast("Фигура обновлена");
    }
    if(pointLayer){
      const {lat,lng} = pointLayer.getLatLng();
      state.marker = {lat, lng};
      $("#lat").value = lat.toFixed(6);
      $("#lng").value = lng.toFixed(6);
      pushHistory();
      persist();
      toast("Маркер обновлен");
    }
  });

  // Ctrl + клик — быстрый маркер (сохраняем, но показываем только при предпросмотре)
  map.on("click", (e)=>{
    if(e.originalEvent && (e.originalEvent.ctrlKey || e.originalEvent.metaKey)){
      setMarker(e.latlng.lat, e.latlng.lng, true);
      toast("Маркер сохранён");
    }
  });

  // Delete — очищает сохраненные объекты
  document.addEventListener("keydown", (ev)=>{
    if(ev.key === "Delete"){
      clearMarker();
      clearShape();
      toast("Очищено");
    }
  });
}

function setMarker(lat, lng, push=true){
  // Сохраняем в состояние
  state.marker = {lat:Number(lat), lng:Number(lng)};
  $("#lat").value = Number(lat).toFixed(6);
  $("#lng").value = Number(lng).toFixed(6);

  // Обновляем визуал только если включен предпросмотр
  if(pointLayer){
    drawnItems.removeLayer(pointLayer);
    pointLayer = null;
  }
  if(state.previewEnabled){
    pointLayer = L.marker([lat, lng]);
    drawnItems.addLayer(pointLayer);
    map.panTo([lat, lng]);
  }
  if(push) pushHistory();
  persist();
}

function clearMarker(push=true){
  if(pointLayer){
    drawnItems.removeLayer(pointLayer);
    pointLayer = null;
  }
  state.marker = null;
  if(push) pushHistory();
  persist();
}

function clearShape(push=true){
  if(shapeLayer){
    drawnItems.removeLayer(shapeLayer);
    shapeLayer = null;
  }
  state.geometry = null;
  if(push) pushHistory();
  persist();
}

function fitObject(){
  if(!state.previewEnabled){
    toast("Включи предпросмотр");
    return false;
  }
  if(shapeLayer){
    map.fitBounds(shapeLayer.getBounds(), {padding:[20,20]});
    return true;
  }
  if(pointLayer){
    map.setView(pointLayer.getLatLng(), 17);
    return true;
  }
  toast("Нечего показывать");
  return false;
}

/* =========================
   UI и каскадные списки
   ========================= */
let DATA = demoData;

function populateCities(){
  const sel = $("#city");
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = ""; opt0.textContent = "Выбери город";
  sel.appendChild(opt0);

  for(const c of DATA.cities){
    const o = document.createElement("option");
    o.value = c.id;
    o.textContent = c.name;
    sel.appendChild(o);
  }
  if(state.cityId){
    sel.value = state.cityId;
  }
}

function populateDistricts(){
  const sel = $("#district");
  sel.innerHTML = "";
  const city = DATA.cities.find(c=>c.id===state.cityId);
  const opt0 = document.createElement("option");
  opt0.value = ""; opt0.textContent = city ? "Выбери район" : "Сначала выбери город";
  sel.appendChild(opt0);
  if(!city) return;

  for(const d of city.districts){
    const o = document.createElement("option");
    o.value = d.id; o.textContent = d.name;
    sel.appendChild(o);
  }
  if(state.districtId){
    sel.value = state.districtId;
  }
}

function populateStreets(){
  const sel = $("#street");
  sel.innerHTML = "";
  const city = DATA.cities.find(c=>c.id===state.cityId);
  const dist = city ? city.districts.find(d=>d.id===state.districtId) : null;
  const opt0 = document.createElement("option");
  opt0.value = ""; opt0.textContent = dist ? "Выбери улицу" : "Сначала выбери район";
  sel.appendChild(opt0);
  if(!dist) return;

  for(const s of dist.streets){
    const o = document.createElement("option");
    o.value = s.id; o.textContent = s.name;
    sel.appendChild(o);
  }
  if(state.streetId){
    sel.value = state.streetId;
  }
}

function refreshUIFromState(){
  $("#note").value = state.note || "";
  const prev = $("#previewToggle");
  if(prev) prev.checked = !!state.previewEnabled;
  populateCities();
  populateDistricts();
  populateStreets();
  // координаты
  if(state.marker){
    $("#lat").value = state.marker.lat.toFixed(6);
    $("#lng").value = state.marker.lng.toFixed(6);
  } else {
    $("#lat").value = "";
    $("#lng").value = "";
  }
}

function refreshMapFromState(){
  // центр на город
  const city = DATA.cities.find(c=>c.id===state.cityId) || DATA.cities[0];
  if(city){
    map.setView(city.center, city.zoom || 12);
  }
  // Перерисовываем слои с учетом предпросмотра
  if(pointLayer){
    drawnItems.removeLayer(pointLayer);
    pointLayer = null;
  }
  if(shapeLayer){
    drawnItems.removeLayer(shapeLayer);
    shapeLayer = null;
  }
  if(state.previewEnabled){
    if(state.marker){
      pointLayer = L.marker([state.marker.lat, state.marker.lng]);
      drawnItems.addLayer(pointLayer);
    }
    if(state.geometry){
      shapeLayer = L.geoJSON(state.geometry).getLayers()[0];
      if(shapeLayer) drawnItems.addLayer(shapeLayer);
    }
  }
}

/* =========================
   Поиск
   ========================= */
let fuseIndex = null;

function buildFuse(){
  const list = [];
  for(const c of DATA.cities){
    list.push({type:"city", id:c.id, name:c.name});
    for(const d of c.districts){
      list.push({type:"district", id:d.id, name:d.name, cityId:c.id});
      for(const s of d.streets){
        list.push({type:"street", id:s.id, name:s.name, cityId:c.id, districtId:d.id});
      }
    }
  }
  fuseIndex = new Fuse(list, { keys:["name"], threshold:0.3 });
}

function handleSearch(q){
  if(!fuseIndex || !q || q.trim().length<2) return;
  const res = fuseIndex.search(q.trim()).slice(0,5);
  if(res.length===0){ toast("Ничего не найдено"); return; }
  const item = res[0].item;
  if(item.type==="city"){
    state.cityId = item.id;
    state.districtId = null;
    state.streetId = null;
  } else if(item.type==="district"){
    state.cityId = item.cityId;
    state.districtId = item.id;
    state.streetId = null;
  } else if(item.type==="street"){
    state.cityId = item.cityId;
    state.districtId = item.districtId;
    state.streetId = item.id;
  }
  applyState(state, true);
  toast("Выбрано по поиску");
}

/* =========================
   Экспорт/Импорт состояния
   ========================= */
function makeAddressString(){
  const city = DATA.cities.find(c=>c.id===state.cityId);
  const dist = city ? city.districts.find(d=>d.id===state.districtId) : null;
  const strt = dist ? dist.streets.find(s=>s.id===state.streetId) : null;
  const parts = [];
  if(city) parts.push(city.name);
  if(dist) parts.push(dist.name);
  if(strt) parts.push(strt.name);
  if(state.note) parts.push(state.note);
  return parts.join(", ");
}

function exportJSON(){
  const payload = {
    version: state.version || "v39.2R",
    ids: {
      cityId: state.cityId,
      districtId: state.districtId,
      streetId: state.streetId
    },
    address: makeAddressString(),
    note: state.note || "",
    marker: state.marker, // {lat,lng} или null
    geometry: state.geometry, // GeoJSON или null
    previewEnabled: !!state.previewEnabled,
    updatedAt: new Date(state.updatedAt || Date.now()).toISOString()
  };
  saveFile(`location_selector_state_${Date.now()}.json`, JSON.stringify(payload, null, 2));
  toast("Экспорт состояния готов");
}

function readFileAsText(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(fr.result);
    fr.onerror = reject;
    fr.readAsText(file, "utf-8");
  });
}

async function importJSON(file){
  try{
    const text = await readFileAsText(file);
    const payload = JSON.parse(text);
    const newState = JSON.parse(JSON.stringify(state));
    newState.cityId = payload.ids?.cityId ?? state.cityId ?? null;
    newState.districtId = payload.ids?.districtId ?? state.districtId ?? null;
    newState.streetId = payload.ids?.streetId ?? state.streetId ?? null;
    newState.marker = payload.marker ?? state.marker ?? null;
    newState.geometry = payload.geometry ?? state.geometry ?? null;
    newState.note = payload.note ?? state.note ?? "";
    if(typeof payload.previewEnabled === "boolean"){
      newState.previewEnabled = payload.previewEnabled;
    }
    applyState(newState, true);
    toast("Импорт состояния выполнен");
  }catch(err){
    console.error(err);
    toast("Ошибка импорта состояния");
  }
}

/* =========================
   Экспорт/Импорт КАТЕГОРИЙ (справочников)
   ========================= */
function exportCategories(){
  const payload = {
    version: state.version || "v39.2R",
    type: "categories",
    categories: JSON.parse(JSON.stringify(DATA))
  };
  saveFile(`location_selector_categories_${Date.now()}.json`, JSON.stringify(payload, null, 2));
  toast("Экспорт категорий готов");
}

function mergeArraysById(targetArr, sourceArr, childKeys=[]){
  const byId = new Map(targetArr.map(x=>[x.id,x]));
  for(const item of sourceArr){
    if(!item || !item.id) continue;
    if(byId.has(item.id)){
      const t = byId.get(item.id);
      // Обновляем простые поля
      for(const [k,v] of Object.entries(item)){
        if(k==="id") continue;
        if(childKeys.includes(k)) continue;
        t[k] = v;
      }
      // Рекурсивно мержим дочерние массивы
      for(const ck of childKeys){
        if(Array.isArray(item[ck])){
          if(!Array.isArray(t[ck])) t[ck] = [];
          mergeArraysById(t[ck], item[ck], ck==="districts" ? ["streets"] : []);
        }
      }
    } else {
      targetArr.push(JSON.parse(JSON.stringify(item)));
    }
  }
}

async function importCategories(file){
  try{
    const text = await readFileAsText(file);
    const payload = JSON.parse(text);
    const src = payload.categories || payload.data || payload;
    if(!src || !Array.isArray(src.cities)){
      toast("Неверный формат категорий");
      return;
    }
    // Мержим без перетирания всего
    mergeArraysById(DATA.cities, src.cities, ["districts"]);
    buildFuse();
    refreshUIFromState();
    refreshMapFromState();
    toast("Категории импортированы");
  }catch(err){
    console.error(err);
    toast("Ошибка импорта категорий");
  }
}

/* =========================
   API наружу
   ========================= */
window.LocationSelector = {
  getState: ()=>JSON.parse(JSON.stringify(state)),
  getAddress: ()=>makeAddressString(),
  setData: (data)=>{
    if(!data || !Array.isArray(data.cities)) return false;
    DATA = data;
    buildFuse();
    refreshUIFromState();
    refreshMapFromState();
    toast("Данные обновлены");
    return true;
  },
  setSelection: ({cityId, districtId, streetId})=>{
    if(cityId!==undefined) state.cityId = cityId;
    if(districtId!==undefined) state.districtId = districtId;
    if(streetId!==undefined) state.streetId = streetId;
    applyState(state, true);
  },
  setMarker: (lat, lng)=> setMarker(lat, lng, true),
  clearMarker: ()=> clearMarker(true),
  clearShape: ()=> clearShape(true),
  focus: ()=> fitObject(),
  export: ()=> exportJSON(),
  exportCategories: ()=> exportCategories(),
  importCategoriesFromObject: (obj)=>{
    if(!obj) return false;
    const src = obj.categories || obj.data || obj;
    if(!src || !Array.isArray(src.cities)) return false;
    mergeArraysById(DATA.cities, src.cities, ["districts"]);
    buildFuse();
    refreshUIFromState();
    refreshMapFromState();
    toast("Категории импортированы");
    return true;
  },
  setPreview: (enabled)=>{
    state.previewEnabled = !!enabled;
    refreshMapFromState();
    persist();
  }
};

/* =========================
   Инициализация
   ========================= */
async function main(){
  await loadState();
  initMap();
  populateCities();
  populateDistricts();
  populateStreets();
  buildFuse();
  refreshUIFromState();
  refreshMapFromState();
  toast("Готово");

  $("#previewToggle").addEventListener("change", (e)=>{
    state.previewEnabled = e.target.checked;
    refreshMapFromState();
    persist();
  });

  $("#city").addEventListener("change", e=>{
    const val = e.target.value || null;
    const c = DATA.cities.find(c=>c.id===val);
    pushHistory();
    state.cityId = val;
    state.districtId = null;
    state.streetId = null;
    if(c){
      map.setView(c.center, c.zoom || 12);
    }
    persist();
    refreshUIFromState();
  });

  $("#district").addEventListener("change", e=>{
    pushHistory();
    state.districtId = e.target.value || null;
    state.streetId = null;
    persist();
    refreshUIFromState();
  });

  $("#street").addEventListener("change", e=>{
    pushHistory();
    state.streetId = e.target.value || null;
    persist();
  });

  $("#note").addEventListener("input", e=>{
    state.note = e.target.value;
    persist();
  });

  $("#search").addEventListener("keydown", e=>{
    if(e.key==="Enter"){
      handleSearch(e.target.value);
    }
  });

  $("#setFromInputs").addEventListener("click", ()=>{
    const lat = parseFloat($("#lat").value);
    const lng = parseFloat($("#lng").value);
    if(isFinite(lat) && isFinite(lng)){
      setMarker(lat, lng, true);
      toast("Маркер установлен");
    } else {
      toast("Введи корректные координаты");
    }
  });

  $("#copyCoords").addEventListener("click", async ()=>{
    const coords = state.marker ? `${state.marker.lat.toFixed(6)}, ${state.marker.lng.toFixed(6)}` : "";
    if(!coords){ toast("Нет координат"); return; }
    try{
      await navigator.clipboard.writeText(coords);
      toast("Координаты скопированы");
    }catch{ toast("Не удалось скопировать"); }
  });

  $("#clearMarker").addEventListener("click", ()=>{
    clearMarker(true);
    toast("Маркер убран");
  });

  $("#btnFit").addEventListener("click", ()=>{
    fitObject();
  });

  $("#btnClearShape").addEventListener("click", ()=>{
    clearShape(true);
    toast("Фигура очищена");
  });

  $("#undoBtn").addEventListener("click", ()=>{
    if(undoStack.length===0){ toast("История пуста"); return; }
    const prev = undoStack.pop();
    redoStack.push(JSON.parse(JSON.stringify(state)));
    applyState(prev, false);
  });

  $("#redoBtn").addEventListener("click", ()=>{
    if(redoStack.length===0){ toast("Нечего повторять"); return; }
    const next = redoStack.pop();
    undoStack.push(JSON.parse(JSON.stringify(state)));
    applyState(next, false);
  });

  $("#resetBtn").addEventListener("click", async ()=>{
    pushHistory();
    state = structuredClone(defaultState);
    await persist();
    refreshUIFromState();
    refreshMapFromState();
    toast("Сброс выполнен");
  });

  $("#exportBtn").addEventListener("click", exportJSON);

  $("#importBtn").addEventListener("click", ()=> $("#importFile").click());
  $("#importFile").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if(file) importJSON(file);
    e.target.value = "";
  });

  $("#exportCategoriesBtn").addEventListener("click", exportCategories);

  $("#importCategoriesBtn").addEventListener("click", ()=> $("#importCategoriesFile").click());
  $("#importCategoriesFile").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if(file) importCategories(file);
    e.target.value = "";
  });
}

document.addEventListener("DOMContentLoaded", main);
</script>
</body>
</html>
