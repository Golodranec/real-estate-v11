<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector v39.3R fix4 stable ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã + –ø–ª–æ—â–∞–¥—å –≤ –æ–±—ã—á–Ω–æ–º, –¥–ª–∏–Ω—ã –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, –∫–Ω–æ–ø–∫–∞ –í—ã–±—Ä–∞—Ç—å</title>

<!-- Leaflet + –ø–ª–∞–≥–∏–Ω—ã -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<!-- localForage -->
<script src="https://unpkg.com/localforage@1.10.0/dist/localforage.js"></script>

<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--panel3:#0f1624;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444;--overlay:rgba(10,14,22,.75)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:var(--text);cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:460px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3,h4{margin:0 0 8px 0}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{border:1px solid var(--border);border-radius:8px;padding:10px;background:#111a2a}
.item-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
.note{background:#0e1524;border:1px dashed #32405a;padding:8px;border-radius:8px;color:#9fb0c8}
.note.gray{opacity:.6}
#map{width:100%;height:100%;position:relative}
.preview-icon{width:20px;height:20px;border-radius:4px;border:1px solid #31405a;background:#0f1624;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview-icon img{max-width:100%;max-height:100%;display:block}

/* –ø–æ–∏—Å–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º */
#globalSearch{width:100%;padding:6px 8px;margin-bottom:8px;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.search-results{max-height:200px;overflow:auto;margin-top:6px}
.search-results div{padding:4px 6px;border-bottom:1px solid var(--border);cursor:pointer}
.search-results div:hover{background:#1f293d}

/* —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–π */
.collapse-head{display:flex;align-items:center;gap:8px;cursor:pointer}
.caret{width:22px;height:22px;border:1px solid var(--border);border-radius:6px;background:#1a2234;display:flex;align-items:center;justify-content:center}
.caret::after{content:"‚ñæ";font-size:12px;line-height:1}
.collapsed .caret::after{content:"‚ñ∏"}
.section-body{margin-top:8px}
.collapsed .section-body{display:none}

/* –º–æ–¥–∞–ª–∫–∏ */
.modal-overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:5000}
.modal{width:min(980px,90vw);max-height:85vh;background:var(--panel);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;overflow:hidden}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);background:var(--panel3)}
.modal-title{font-weight:700}
.modal-close{border:1px solid var(--border);background:#1a2234;border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.modal-body{padding:12px 14px;overflow:auto}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border);background:var(--panel3)}
.modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
@media (max-width:1024px){.modal-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.modal-grid{grid-template-columns:1fr}}
.modal-item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #1f2a40;border-radius:8px;background:#0f1624}
.modal-item input[type="checkbox"]{appearance:none;-webkit-appearance:none;width:16px;height:16px;border:2px solid var(--accent);border-radius:4px;background:#1a2234;cursor:pointer;position:relative;flex:0 0 16px}
.modal-item input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
.modal-item input[type="checkbox"]:checked::after{content:"‚úî";position:absolute;top:-2px;left:2px;font-size:14px;color:#fff}

/* –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
.suggestions{position:absolute;background:var(--panel2);border:1px solid var(--border);border-radius:8px;z-index:3000;max-height:200px;overflow:auto;width:100%}
.suggestions div{padding:6px 8px;cursor:pointer}
.suggestions div:hover{background:#1f293d}

/* drag */
.draggable{cursor:grab}
.dragging{opacity:.5}
.dropzone-hover{outline:2px dashed var(--accent);outline-offset:4px}

/* –ø–ª–∞–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
.coord-tool{position:absolute;z-index:4000;display:grid;gap:6px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px;width:260px}
.coord-tool h4{margin:0 0 6px 0;font-size:14px;cursor:move;user-select:none}
.coord-tool .row{display:flex;gap:6px}
.coord-tool .row input{flex:1}
.coord-tool .row button{white-space:nowrap}
.coord-tool .help{font-size:12px;color:var(--muted)}

/* –∫–Ω–æ–ø–∫–∞ –í—ã–±—Ä–∞—Ç—å –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ */
.multi-select-btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#1a2234;color:var(--text);cursor:pointer}
.multi-select-btn:hover{border-color:var(--accent);background:#212b41}

/* –ø–æ–¥–ø–∏—Å–∏ –º–µ—Ç—Ä–∏–∫ */
.poly-label{background:rgba(10,14,22,.85);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;white-space:nowrap}
</style>
</head>
<body>
<header>
  <span class="badge">location_selector v39.3R fix4</span>
  <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç (–≤—Å—ë)</button>
  <button id="btnImport">–ò–º–ø–æ—Ä—Ç (–≤—Å—ë)</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnInfo">–ò–Ω—Ñ–æ</button>
  <button id="btnUndo">Undo</button>
  <button id="btnRedo">Redo</button>
  <button id="btnReset" class="danger">–°–±—Ä–æ—Å</button>

  <span class="badge" style="margin-left:12px">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span>
  <button id="btnMeasure">–õ–∏–Ω–µ–π–∫–∞</button>
  <button id="btnDrawPoint">–¢–æ—á–∫–∞</button>
  <button id="btnDrawLine">–õ–∏–Ω–∏—è</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
  <div class="tab" data-tab="preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Å–∫–∞–¥–∞</h3>
      <input id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º..."/>
      <div id="searchResults" class="search-results"></div>
      <div class="row">
        <button id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
        <button id="btnClearAll" class="danger">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
      </div>
      <div class="help">–ß–µ–∫–±–æ–∫—Å-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ –±–æ–ª—å—à–æ–º —Å–ø–∏—Å–∫–µ –∫–∞–∫ –Ω–∞ –ê–≤–∏—Ç–æ. –í–Ω—É—Ç—Ä–∏ —Ç–æ–∂–µ –µ—Å—Ç—å ¬´–í—ã–±—Ä–∞—Ç—å –≤—Å—ë / –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë¬ª.</div>
      <div id="cascadeBox" style="margin-top:8px"></div>

      <div class="sep"></div>
      <h3>–ü–æ–ª–∏–≥–æ–Ω—ã</h3>
      <input id="polyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞"/>
      <input type="color" id="polyColor" value="#ff4d4f"/>
      <div class="row">
        <button id="btnPolyNew">–ù–æ–≤—ã–π</button>
        <button id="btnPolyEdit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btnPolyStop">–°—Ç–æ–ø</button>
        <button id="btnPolyUndo">Undo</button>
        <button id="btnPolyRedo">Redo</button>
      </div>
      <input id="polySearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª–∏–≥–æ–Ω–∞–º..."/>
      <div id="polyList" class="list"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>

<!-- –ú–æ–¥–∞–ª–∫–∏ -->
<div id="msOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <div id="msTitle" class="modal-title">–í—ã–±–æ—Ä</div>
      <div id="msClose" class="modal-close">‚úñ</div>
    </div>
    <div class="modal-body">
      <div class="row">
        <input id="msSearch" class="grow" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å–ø–∏—Å–∫—É..."/>
        <button id="msAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
        <button id="msNone" class="danger">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
      </div>
      <div id="msGrid" class="modal-grid"></div>
    </div>
    <div class="modal-actions">
      <button id="msApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button id="msCancel" class="danger">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<div id="iconsOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–∫–æ–Ω–æ–∫</div><div id="iconsClose" class="modal-close">‚úñ</div></div>
    <div class="modal-body"><div id="iconsGrid" class="modal-grid"></div></div>
  </div>
</div>

<div id="infoOverlay" class="modal-overlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div><div id="infoClose" class="modal-close">‚úñ</div></div>
    <div class="modal-body"><div id="infoBox"></div></div>
  </div>
</div>

<div id="importDialog" class="modal-overlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">–ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ</div><div id="importClose" class="modal-close">‚úñ</div></div>
    <div class="modal-body"><div id="importMessage"></div></div>
    <div class="modal-actions">
      <button id="btnOverwrite">–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å</button>
      <button id="btnSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="btnApplyAll">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º</button>
    </div>
  </div>
</div>

<!-- –ü–ª–∞–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
<div id="coordTool" class="coord-tool" style="display:none">
  <h4 id="coordDrag">–ú–µ—Ç–∫–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º</h4>
  <div class="row">
    <input id="coordLat" placeholder="–®–∏—Ä–æ—Ç–∞" inputmode="decimal"/>
    <input id="coordLng" placeholder="–î–æ–ª–≥–æ—Ç–∞" inputmode="decimal"/>
  </div>
  <div class="row">
    <button id="btnCoordFind">–ù–∞–π—Ç–∏</button>
    <button id="btnCoordAdd">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button id="btnCoordClear" class="danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>
  <div class="help">–ü–µ—Ä–µ—Ç–∞—â–∏ –æ–∫–Ω–æ –≤ —É–¥–æ–±–Ω—ã–π —É–≥–æ–ª. –ü–æ–∫–∞–∑ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–∞—Ä—Ç–µ (–≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ –ª–µ–∑–µ–º).</div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã –∫–∞—Ä—Ç -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil@0.10.2/src/leaflet.geometryutil.js"></script>

<script>
/***** STORAGE + DB *****/
const KEY="dict_v38_3R";
const lfIcons=localforage.createInstance({name:"dict_icons_v383R"});
const lfGeo=localforage.createInstance({name:"dict_geo_v383R"});

function uid(){return Math.random().toString(36).slice(2,9);}

function normalize(obj){
  if(!obj||typeof obj!=="object")obj={categories:[],polygons:[]};
  if(!Array.isArray(obj.categories)) obj.categories=[];
  if(!Array.isArray(obj.polygons)) obj.polygons=[];
  obj.categories.forEach(c=>{
    if(!("id" in c))c.id=uid();
    if(!("type" in c))c.type="select";
    if(!("items" in c))c.items=[];
    if(!("color" in c))c.color="#3388ff";
    if(!("shape" in c))c.shape="circle";
    if(!("parentCategoryId" in c))c.parentCategoryId=null;
    (c.items||[]).forEach(it=>{
      if(!("id" in it))it.id=uid();
      if(!("name" in it))it.name="–ë–µ–∑ –∏–º–µ–Ω–∏";
      if(!("lat" in it))it.lat=null;
      if(!("lng" in it))it.lng=null;
      if(!("parentId" in it))it.parentId=null;
    });
  });
  obj.polygons.forEach(p=>{
    if(!("id" in p))p.id=uid();
    if(!("name" in p))p.name="–ü–æ–ª–∏–≥–æ–Ω";
    if(!("color" in p))p.color="#ff4d4f";
    if(!("visible" in p))p.visible=true;
    if(!("metricsEnabled" in p))p.metricsEnabled=true; // –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ—Ç—Ä–∏–∫
  });
}

async function save(obj=db){
  normalize(obj);
  const lite={
    categories:obj.categories.map(c=>({
      id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId,
      color:c.color,shape:c.shape,iconKey:c.iconKey||null,
      items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
    })),
    polygons:obj.polygons.map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible,metricsEnabled:p.metricsEnabled}))
  };
  localStorage.setItem(KEY,JSON.stringify(lite));

  for(const cat of obj.categories){
    if(cat.iconData){
      const key=cat.iconKey||`cat_${cat.id}`;
      await lfIcons.setItem(key,cat.iconData);
      cat.iconKey=key;
    }
    for(const it of (cat.items||[])){
      if(it.iconData){
        const key=it.iconKey||`item_${it.id}`;
        await lfIcons.setItem(key,it.iconData);
        it.iconKey=key;
      }
    }
  }
  for(const p of obj.polygons){
    if(p.geojson) await lfGeo.setItem(p.id,p.geojson);
  }
}

async function loadDB(){
  const raw=localStorage.getItem(KEY);
  let obj={categories:[],polygons:[]};
  if(raw){try{obj=JSON.parse(raw)||{};}catch(e){}}
  normalize(obj);
  for(const cat of obj.categories){
    if(cat.iconKey&&!cat.iconData){
      try{cat.iconData=await lfIcons.getItem(cat.iconKey)||null;}catch(e){}
    }
    for(const it of (cat.items||[])){
      if(it.iconKey&&!it.iconData){
        try{it.iconData=await lfIcons.getItem(it.iconKey)||null;}catch(e){}
      }
    }
  }
  for(const p of obj.polygons){
    if(!p.geojson){
      try{p.geojson=await lfGeo.getItem(p.id)||null;}catch(e){}
    }
  }
  return obj;
}

/***** GLOBAL HISTORY *****/
let historyStack=[],historyIndex=-1,historyLimit=80;
function pushHistory(){
  const snap=JSON.stringify(db);
  if(historyIndex<historyStack.length-1) historyStack.splice(historyIndex+1);
  historyStack.push(snap);
  if(historyStack.length>historyLimit){ historyStack.shift(); historyIndex=historyStack.length-1; } else { historyIndex=historyStack.length-1; }
}
async function commit(){ await save(db); pushHistory(); renderAll(); }
function undo(){ if(historyIndex>0){ historyIndex--; db=JSON.parse(historyStack[historyIndex]); renderAll(); } }
function redo(){ if(historyIndex<historyStack.length-1){ historyIndex++; db=JSON.parse(historyStack[historyIndex]); renderAll(); } }
document.getElementById('btnUndo').onclick=undo;
document.getElementById('btnRedo').onclick=redo;

/***** COLLAPSE STATE *****/
function getCollapsedSet(key){ try{ return new Set(JSON.parse(localStorage.getItem(key)||"[]")); }catch(_){ return new Set(); } }
function setCollapsedSet(key,set){ localStorage.setItem(key,JSON.stringify([...set])); }
const collapsedPolygons=getCollapsedSet('collapsedPolygons_v1');
const collapsedCats=getCollapsedSet('collapsedCats_v1');

/***** MAP + MARKERS *****/
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let cluster=L.markerClusterGroup(); map.addLayer(cluster);
function clearMarkers(){cluster.clearLayers();}
function markerIcon(cat,it){
  if(it && it.iconData) return L.icon({iconUrl:it.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  if(cat.iconData) return L.icon({iconUrl:cat.iconData,iconSize:[24,24],iconAnchor:[12,12]});
  const color=cat.color||"#3388ff",shape=cat.shape||"circle";let html="";
  if(shape==="circle") html=`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`;
  if(shape==="square") html=`<div style="background:${color};width:18px;height:18px;border:2px solid #fff"></div>`;
  if(shape==="triangle") html=`<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid ${color}"></div>`;
  return L.divIcon({className:"custom-icon",html:html,iconSize:[20,20],iconAnchor:[10,10]});
}
function addMarkerForItem(it,cat){
  if(it.lat==null||it.lng==null) return;
  const m=L.marker([it.lat,it.lng],{icon:markerIcon(cat,it),_itemId:it.id});
  m.bindPopup(`<b>${it.name}</b><br/><button onclick="removeMarkerById('${it.id}')">üóë –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É</button>`);
  cluster.addLayer(m);
}
window.removeMarkerById=function(id){
  for(const c of db.categories){ const it=(c.items||[]).find(x=>x.id===id); if(it){it.lat=null;it.lng=null;break;} }
  const toRemove=[]; cluster.eachLayer(m=>{ if(m.options && m.options._itemId===id) toRemove.push(m); });
  toRemove.forEach(m=>cluster.removeLayer(m));
  commit();
};

/***** POLYGONS CORE + HISTORY + METRICS *****/
const polyFG=new L.FeatureGroup(); map.addLayer(polyFG);
const polyIndex=new Map();
const historyById=new Map(); // id -> {stack:[],index}

/* –ø–æ–¥–ø–∏—Å–∏: –ø–ª–æ—â–∞–¥—å (–≤—Å–µ–≥–¥–∞ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ) –∏ –¥–ª–∏–Ω—ã —Ä—ë–±–µ—Ä (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ) */
const polyAreaLabels=new Map();      // id -> L.marker
const polyEdgeLabelGroups=new Map(); // id -> L.LayerGroup

function getHistoryPoly(id){ if(!historyById.has(id)) historyById.set(id,{stack:[],index:-1}); return historyById.get(id); }
function pushHistoryPoly(p){
  const h=getHistoryPoly(p.id);
  const snap=JSON.parse(JSON.stringify(p.geojson));
  if(h.index<h.stack.length-1) h.stack.splice(h.index+1);
  h.stack.push(snap); h.index=h.stack.length-1;
}
function applyHistoryPoly(p,dir){
  const h=getHistoryPoly(p.id), next=h.index+dir;
  if(next<0||next>=h.stack.length) return false;
  h.index=next; const snap=h.stack[h.index];
  p.geojson=JSON.parse(JSON.stringify(snap));
  const old=polyIndex.get(p.id); if(old) polyFG.removeLayer(old);
  const l=layerFromGeo(p.geojson,p.color); polyFG.addLayer(l); polyIndex.set(p.id,l);
  if(p.visible===false) map.removeLayer(l);
  refreshPolygonMetrics(p.id);
  return true;
}
function layerFromGeo(geo,c){ let l=null; L.geoJSON(geo,{style:{color:c||'#ff4d4f',weight:2,fillOpacity:.12}}).eachLayer(x=>l=x); return l; }

function formatArea(m2){ return m2>1e6 ? (m2/1e6).toFixed(2)+' –∫–º¬≤' : Math.round(m2)+' –º¬≤'; }
function formatLen(m){ return m>1000 ? (m/1000).toFixed(2)+' –∫–º' : Math.round(m)+' –º'; }

function buildAreaLabel(p){
  const old=polyAreaLabels.get(p.id);
  if(old){ map.removeLayer(old); polyAreaLabels.delete(p.id); }
  if(!p.metricsEnabled) return;
  const l=polyIndex.get(p.id); if(!l) return;
  let rings=l.getLatLngs();
  if(Array.isArray(rings) && Array.isArray(rings[0])) rings=rings[0];
  if(!rings || rings.length<3) return;
  const area=L.GeometryUtil.geodesicArea(rings);
  const pos=l.getBounds().getCenter();
  const lbl=L.marker(pos,{interactive:false,icon:L.divIcon({className:"",html:`<div class="poly-label">–ü–ª–æ—â–∞–¥—å: ${formatArea(area)}</div>`})});
  if(map.hasLayer(l)) lbl.addTo(map);
  polyAreaLabels.set(p.id,lbl);
}

function buildEdgeLabels(p){
  const oldGrp=polyEdgeLabelGroups.get(p.id);
  if(oldGrp){ map.removeLayer(oldGrp); polyEdgeLabelGroups.delete(p.id); }
  if(!p.metricsEnabled) return;
  if(polyEditingTargetId!==p.id) return; // –¥–ª–∏–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ

  const l=polyIndex.get(p.id); if(!l) return;
  let rings=l.getLatLngs();
  if(Array.isArray(rings) && Array.isArray(rings[0])) rings=rings[0];
  if(!rings || rings.length<2) return;

  const grp=L.layerGroup();
  for(let i=0;i<rings.length;i++){
    const a=rings[i], b=rings[(i+1)%rings.length];
    const mid=L.latLng( (a.lat+b.lat)/2, (a.lng+b.lng)/2 );
    const segLen=L.GeometryUtil.length([a,b]); // –≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–∞—è –¥–ª–∏–Ω–∞ –æ—Ç—Ä–µ–∑–∫–∞
    const mk=L.marker(mid,{interactive:false,icon:L.divIcon({className:"",html:`<div class="poly-label">${formatLen(segLen)}</div>`})});
    grp.addLayer(mk);
  }
  grp.addTo(map);
  polyEdgeLabelGroups.set(p.id,grp);
}
function clearEdgeLabels(pId){
  const grp=polyEdgeLabelGroups.get(pId);
  if(grp){ map.removeLayer(grp); polyEdgeLabelGroups.delete(pId); }
}
function refreshPolygonMetrics(pId){
  const p=db.polygons.find(x=>x.id===pId); if(!p) return;
  buildAreaLabel(p);       // –ø–ª–æ—â–∞–¥—å ‚Äî –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–∏–≥–æ–Ω–∞)
  clearEdgeLabels(pId);    // —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–ª–∏–Ω—ã
  buildEdgeLabels(p);      // –¥–ª–∏–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
}

function rebuildPolys(){
  for(const [,lbl] of polyAreaLabels){ map.removeLayer(lbl); } polyAreaLabels.clear();
  for(const [,grp] of polyEdgeLabelGroups){ map.removeLayer(grp); } polyEdgeLabelGroups.clear();

  polyIndex.clear(); polyFG.clearLayers();
  for(const p of db.polygons){
    if(!p.geojson) continue;
    const l=layerFromGeo(p.geojson,p.color); if(!l) continue;
    polyFG.addLayer(l); polyIndex.set(p.id,l);
    if(p.visible===false) map.removeLayer(l);
  }
  updatePolygonVisibility();
  for(const p of db.polygons) refreshPolygonMetrics(p.id);
}

/***** SELECTED STATE + VISIBILITY (–ª–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–æ–ª–∏–≥–æ–Ω–æ–≤) *****/
let selected={};
function saveSelected(){
  const out={};
  for(const [k,v] of Object.entries(selected)){ out[k]=v instanceof Set?Array.from(v):v; }
  localStorage.setItem('selected_v1',JSON.stringify(out));
}
function loadSelected(){
  try{
    const raw=localStorage.getItem('selected_v1'); if(!raw) return;
    const obj=JSON.parse(raw)||{}; selected={};
    for(const [k,v] of Object.entries(obj)){
      const cat=(db?.categories||[]).find(c=>c.id===k);
      if(cat&&cat.type==='checkbox') selected[k]=new Set(Array.isArray(v)?v:[]);
      else selected[k]=v||null;
    }
  }catch(_){selected={};}
}
function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId); const v=selected[catId];
  if(!v) return []; return(cat&&cat.type==='checkbox')?Array.from(v):(v?[v]:[]);
}
function getSelectedItemNames(){
  const names=new Set();
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    if(!ids.length) continue;
    (cat.items||[]).forEach(it=>{if(ids.includes(it.id)) names.add(it.name);});
  }
  return names;
}
function updatePolygonVisibility(){
  const names=getSelectedItemNames();
  for(const p of db.polygons){
    const layer=polyIndex.get(p.id); if(!layer) continue;
    const filtered=(p.visible!==false) && (names.size ? names.has(p.name) : false);
    const forceVisible=(polyEditingTargetId && p.id===polyEditingTargetId);
    if(filtered||forceVisible) layer.addTo(map); else map.removeLayer(layer);

    // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å –ø–ª–æ—â–∞–¥–∏ —Å –≤–∏–¥–∏–º–æ—Å—Ç—å—é
    const lbl=polyAreaLabels.get(p.id);
    if(lbl){
      if(map.hasLayer(layer) && p.metricsEnabled) lbl.addTo(map); else map.removeLayer(lbl);
    }
  }
}
</script>
<script>
/***** Select All / Clear All (—á–µ–∫–±–æ–∫—Å—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π) *****/
document.getElementById('btnSelectAll').onclick=()=>{
  db.categories.forEach(cat=>{
    if(cat.type==='checkbox'){
      const ids=(cat.items||[]).map(i=>i.id);
      selected[cat.id]=new Set(ids);
    }
  });
  saveSelected(); renderPreview(); updatePolygonVisibility();
};
document.getElementById('btnClearAll').onclick=()=>{
  db.categories.forEach(cat=>{
    if(cat.type==='checkbox'){ selected[cat.id]=new Set(); }
    if(cat.type==='select'){ selected[cat.id]=null; }
  });
  saveSelected(); renderPreview(); updatePolygonVisibility();
};

/***** GLOBAL SEARCH —Å –∑—É–º–æ–º *****/
const $search=document.getElementById('globalSearch');
const $results=document.getElementById('searchResults');
if($search&&$results){
  $search.oninput=()=>{
    const q=$search.value.trim().toLowerCase(); $results.innerHTML=""; if(!q) return;
    const out=[];
    db.categories.forEach(cat=>(cat.items||[]).forEach(it=>{
      if(it.name.toLowerCase().includes(q)) out.push({cat,it});
    }));
    out.forEach(r=>{
      const row=document.createElement('div');
      row.textContent=`${r.it.name} (${r.cat.name})`;
      row.onclick=()=>{
        if(r.cat.type==='select') selected[r.cat.id]=r.it.id;
        else{
          if(!(selected[r.cat.id] instanceof Set)) selected[r.cat.id]=new Set();
          selected[r.cat.id].add(r.it.id);
        }
        saveSelected(); renderPreview(); updatePolygonVisibility();
        if(r.it.lat!=null && r.it.lng!=null){
          map.setView([r.it.lat,r.it.lng],16);
          setTimeout(()=>map.setView([r.it.lat,r.it.lng],17),200);
        }
        $search.value=""; $results.innerHTML="";
      };
      $results.appendChild(row);
    });
  };
}

/***** –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ö–ê–¢–ï–ì–û–†–ò–ô *****/
function renderPreview(){
  const $box=document.getElementById('cascadeBox'); $box.innerHTML="";
  db.categories.forEach(cat=>{
    const sec=document.createElement('div'); sec.className='panel';
    const head=document.createElement('div'); head.className='collapse-head'; head.innerHTML=`<h4>${cat.name}</h4>`;
    sec.appendChild(head);
    const body=document.createElement('div'); body.className='section-body';
    (cat.items||[]).forEach(it=>{
      const row=document.createElement('div'); row.className='item-row';
      const name=document.createElement('span'); name.textContent=it.name;
      const btn=document.createElement('button'); btn.className='multi-select-btn'; btn.textContent='–í—ã–±—Ä–∞—Ç—å';
      btn.onclick=()=>{
        if(cat.type==='select'){ selected[cat.id]=it.id; }
        else{
          if(!(selected[cat.id] instanceof Set)) selected[cat.id]=new Set();
          selected[cat.id].add(it.id);
        }
        saveSelected(); renderPreview();
      };
      row.append(name,btn); body.appendChild(row);
    });
    sec.appendChild(body); $box.appendChild(sec);
  });
}

/***** –†–ï–î–ê–ö–¢–û–† –ö–ê–¢–ï–ì–û–†–ò–ô *****/
const $editor=document.getElementById('editorTab');
function moveArrayItem(arr,fromIdx,toIdx){
  if(fromIdx===toIdx) return;
  const item=arr.splice(fromIdx,1)[0]; arr.splice(toIdx,0,item);
}
function sortAZ(){
  db.categories.sort((a,b)=>a.name.localeCompare(b.name));
  for(const cat of db.categories){ if(cat.items) cat.items.sort((a,b)=>a.name.localeCompare(b.name)); }
}

function renderEditor(){
  $editor.innerHTML="";
  // –ø–∞–Ω–µ–ª—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  const headPanel=document.createElement('div'); headPanel.className='panel';
  const headRow=document.createElement('div'); headRow.className='row';
  const hTitle=document.createElement('h3'); hTitle.textContent='–ö–∞—Ç–µ–≥–æ—Ä–∏–∏';
  const btnSortAZ=document.createElement('button'); btnSortAZ.textContent='–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å A‚ÜíZ';
  btnSortAZ.onclick=()=>{ sortAZ(); commit(); };
  headRow.append(hTitle,btnSortAZ); headPanel.appendChild(headRow); $editor.appendChild(headPanel);

  db.categories.forEach(cat=>{
    const sec=document.createElement('div'); sec.className='panel draggable'; if(collapsedCats.has(cat.id)) sec.classList.add('collapsed'); sec.dataset.catId=cat.id;

    const head=document.createElement('div'); head.className='collapse-head';
    const caret=document.createElement('div'); caret.className='caret';
    const title=document.createElement('h3'); title.textContent=cat.name+` (${cat.type})`;
    head.append(caret,title);

    const toolsTop=document.createElement('div'); toolsTop.className='tools';
    const btnUp=document.createElement('button'); btnUp.textContent='‚ñ≤';
    btnUp.onclick=()=>{const idx=db.categories.findIndex(c=>c.id===cat.id); if(idx>0){ moveArrayItem(db.categories,idx,idx-1); commit(); }};
    const btnDown=document.createElement('button'); btnDown.textContent='‚ñº';
    btnDown.onclick=()=>{const idx=db.categories.findIndex(c=>c.id===cat.id); if(idx<db.categories.length-1){ moveArrayItem(db.categories,idx,idx+1); commit(); }};
    const btnSortItemsAZ=document.createElement('button'); btnSortItemsAZ.textContent='A‚ÜíZ —ç–ª–µ–º–µ–Ω—Ç—ã';
    btnSortItemsAZ.onclick=()=>{ cat.items.sort((a,b)=>a.name.localeCompare(b.name)); commit(); };
    const btnDeleteCat=document.createElement('button'); btnDeleteCat.textContent='–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é'; btnDeleteCat.className='danger';
    btnDeleteCat.onclick=()=>{ if(confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${cat.name}" –∏ –≤—Å–µ –µ—ë —ç–ª–µ–º–µ–Ω—Ç—ã?`)){ db.categories=db.categories.filter(c=>c.id!==cat.id); dropChildrenSelections(cat.id); commit(); } };
    toolsTop.append(btnUp,btnDown,btnSortItemsAZ,btnDeleteCat);

    const headWrap=document.createElement('div');
    headWrap.style.display='flex'; headWrap.style.justifyContent='space-between'; headWrap.style.alignItems='center';
    headWrap.append(head,toolsTop); sec.appendChild(headWrap);

    // —Å–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const body=document.createElement('div'); body.className='section-body';
    const list=document.createElement('div'); list.className='list'; list.dataset.catId=cat.id;
    (cat.items||[]).forEach(it=>{
      const row=document.createElement('div'); row.className='item-row';
      row.innerHTML=`<span>${it.name}</span>`;
      list.appendChild(row);
    });
    body.appendChild(list); sec.appendChild(body);
    $editor.appendChild(sec);
  });
}

/***** –†–ï–î–ê–ö–¢–û–† –ü–û–õ–ò–ì–û–ù–û–í *****/
function setEditingTarget(pid){
  polyEditingTargetId=pid;
  for(const p of db.polygons){ refreshPolygonMetrics(p.id); }
}
function renderPolyList(){
  const $list=document.getElementById('polyList'); $list.innerHTML="";
  db.polygons.forEach(p=>{
    const row=document.createElement('div'); row.className='item-row';
    row.innerHTML=`<span>${p.name||'–ë–µ–∑ –∏–º–µ–Ω–∏'}</span>`;
    const tools=document.createElement('div'); tools.className='tools';
    const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=(p.metricsEnabled!==false);
    chk.onchange=()=>{ p.metricsEnabled=chk.checked; save(db); refreshPolygonMetrics(p.id); };
    const btnEdit=document.createElement('button'); btnEdit.textContent='‚úè';
    btnEdit.onclick=()=>{ setEditingTarget(p.id); };
    const btnDel=document.createElement('button'); btnDel.textContent='‚ùå'; btnDel.className='danger';
    btnDel.onclick=()=>{
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω?')) return;
      const l=polyIndex.get(p.id); if(l) polyFG.removeLayer(l);
      polyIndex.delete(p.id);
      const lbl=polyAreaLabels.get(p.id); if(lbl) map.removeLayer(lbl);
      clearEdgeLabels(p.id);
      db.polygons=db.polygons.filter(x=>x.id!==p.id);
      save(db); renderPolyList();
    };
    tools.append(chk,btnEdit,btnDel); row.appendChild(tools);
    $list.appendChild(row);
  });
}
</script>
let polyEditToolbar=null, polyEditing=false;

function getHistoryPoly(id){
  if(!historyById.has(id)) historyById.set(id,{stack:[],index:-1});
  return historyById.get(id);
}
function pushHistoryPoly(p){
  const h=getHistoryPoly(p.id);
  const snap=JSON.parse(JSON.stringify(p.geojson));
  if(h.index<h.stack.length-1) h.stack.splice(h.index+1);
  h.stack.push(snap); h.index=h.stack.length-1;
}
function applyHistoryPoly(p,dir){
  const h=getHistoryPoly(p.id), next=h.index+dir;
  if(next<0||next>=h.stack.length) return false;
  h.index=next;
  const snap=h.stack[h.index];
  p.geojson=JSON.parse(JSON.stringify(snap));
  const old=polyIndex.get(p.id); if(old) polyFG.removeLayer(old);
  const l=layerFromGeo(p.geojson,p.color); polyFG.addLayer(l); polyIndex.set(p.id,l);
  if(p.visible===false) map.removeLayer(l);
  refreshPolygonMetrics(p.id);
  return true;
}
function layerFromGeo(geo,c){ let l=null; L.geoJSON(geo,{style:{color:c||'#ff4d4f',weight:2,fillOpacity:.12}}).eachLayer(x=>l=x); return l; }

function formatArea(m2){ return m2>1e6 ? (m2/1e6).toFixed(2)+' –∫–º¬≤' : Math.round(m2)+' –º¬≤'; }
function formatLen(m){ return m>1000 ? (m/1000).toFixed(2)+' –∫–º' : Math.round(m)+' –º'; }

function buildAreaLabel(p){
  const old=polyAreaLabels.get(p.id);
  if(old){ map.removeLayer(old); polyAreaLabels.delete(p.id); }
  if(p.metricsEnabled===false) return;

  const l=polyIndex.get(p.id); if(!l) return;
  let rings=l.getLatLngs();
  if(Array.isArray(rings) && Array.isArray(rings[0])) rings=rings[0];
  if(!rings || rings.length<3) return;

  const area=L.GeometryUtil.geodesicArea(rings);
  const pos=l.getBounds().getCenter();
  const lbl=L.marker(pos,{interactive:false,icon:L.divIcon({className:"",html:`<div class="poly-label">–ü–ª–æ—â–∞–¥—å: ${formatArea(area)}</div>`})});
  if(map.hasLayer(l)) lbl.addTo(map);
  polyAreaLabels.set(p.id,lbl);
}

function buildEdgeLabels(p){
  const oldGrp=polyEdgeLabelGroups.get(p.id);
  if(oldGrp){ map.removeLayer(oldGrp); polyEdgeLabelGroups.delete(p.id); }
  if(p.metricsEnabled===false) return;
  if(polyEditingTargetId!==p.id) return; // –¥–ª–∏–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ

  const l=polyIndex.get(p.id); if(!l) return;
  let rings=l.getLatLngs();
  if(Array.isArray(rings) && Array.isArray(rings[0])) rings=rings[0];
  if(!rings || rings.length<2) return;

  const grp=L.layerGroup();
  for(let i=0;i<rings.length;i++){
    const a=rings[i], b=rings[(i+1)%rings.length];
    const mid=L.latLng( (a.lat+b.lat)/2, (a.lng+b.lng)/2 );
    const segLen=L.GeometryUtil.length([a,b]);
    const mk=L.marker(mid,{interactive:false,icon:L.divIcon({className:"",html:`<div class="poly-label">${formatLen(segLen)}</div>`})});
    grp.addLayer(mk);
  }
  grp.addTo(map);
  polyEdgeLabelGroups.set(p.id,grp);
}
function clearEdgeLabels(pId){
  const grp=polyEdgeLabelGroups.get(pId);
  if(grp){ map.removeLayer(grp); polyEdgeLabelGroups.delete(pId); }
}
function refreshPolygonMetrics(pId){
  const p=db.polygons.find(x=>x.id===pId); if(!p) return;
  buildAreaLabel(p);       // –ø–ª–æ—â–∞–¥—å ‚Äî –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
  clearEdgeLabels(p.id);   // –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∏ –¥–ª–∏–Ω
  buildEdgeLabels(p);      // –¥–ª–∏–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
}

function rebuildPolys(){
  // —É–±—Ä–∞—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∏
  for(const [,lbl] of polyAreaLabels){ map.removeLayer(lbl); } polyAreaLabels.clear();
  for(const [,grp] of polyEdgeLabelGroups){ map.removeLayer(grp); } polyEdgeLabelGroups.clear();

  polyIndex.clear(); polyFG.clearLayers();
  for(const p of db.polygons){
    if(!p.geojson) continue;
    const l=layerFromGeo(p.geojson,p.color);
    if(!l) continue;
    polyFG.addLayer(l); polyIndex.set(p.id,l);
    if(p.visible===false) map.removeLayer(l);
  }
  updatePolygonVisibility();
  for(const p of db.polygons) refreshPolygonMetrics(p.id);
}

/***** –ö–ù–û–ü–ö–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–û–õ–ò–ì–û–ù–û–í *****/
document.getElementById('btnPolyNew').onclick=()=>{
  new L.Draw.Polygon(map,{shapeOptions:{color:'#ff4d4f',weight:2,fillOpacity:.12}}).enable();
};
document.getElementById('btnPolyEdit').onclick=()=>{
  if(polyEditing) return;
  polyEditingTargetId=null; localStorage.removeItem('polyEditingId');
  polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
  polyEditToolbar.enable(); polyEditing=true;
};
document.getElementById('btnPolyStop').onclick=stopPolyEditing;
function stopPolyEditing(){
  if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); polyEditing=false; map.fire(L.Draw.Event.EDITSTOP); }
  if(polyEditingTargetId){ clearEdgeLabels(polyEditingTargetId); }
  polyEditingTargetId=null; localStorage.removeItem('polyEditingId');
}
document.getElementById('btnPolyUndo').onclick=()=>{
  if(!polyEditingTargetId) return;
  const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
  if(applyHistoryPoly(p,-1)){ save(db).then(()=>{ renderPolyList(); updatePolygonVisibility(); refreshPolygonMetrics(p.id); }); }
};
document.getElementById('btnPolyRedo').onclick=()=>{
  if(!polyEditingTargetId) return;
  const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
  if(applyHistoryPoly(p,+1)){ save(db).then(()=>{ renderPolyList(); updatePolygonVisibility(); refreshPolygonMetrics(p.id); }); }
};

/***** –°–û–ë–´–¢–ò–Ø –†–ò–°–û–í–ê–ù–ò–Ø *****/
map.on(L.Draw.Event.CREATED,async e=>{
  if(e.layerType==="polygon" && (e.layer instanceof L.Polygon)){
    const layer=e.layer; layer.setStyle({color:'#ff4d4f',weight:2,fillOpacity:.12});
    polyFG.addLayer(layer);
const rec = {
  id: uid(),
  name: (document.getElementById('polyName')?.value || `–ü–æ–ª–∏–≥–æ–Ω ${db.polygons.length+1}`).trim(),
  color: (document.getElementById('polyColor')?.value || '#ff4d4f'),
  visible: true,
  metricsEnabled: true,
  geojson: layer.toGeoJSON()
};
    db.polygons.push(rec); polyIndex.set(rec.id,layer); pushHistoryPoly(rec); await commit();
    refreshPolygonMetrics(rec.id);
  } else {
    // —Ç–æ—á–∫–∞/–ª–∏–Ω–∏—è ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ db)
    if(e.layer) e.layer.addTo(map);
  }
});

map.on(L.Draw.Event.EDITSTOP,async ()=>{
  for(const p of db.polygons){
    const l=polyIndex.get(p.id); if(l) p.geojson=l.toGeoJSON();
  }
  await commit();
  for(const p of db.polygons) refreshPolygonMetrics(p.id);
});

map.on('draw:editvertex', ()=>{
  if(!polyEditingTargetId) return;
  const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
  const l=polyIndex.get(p.id); if(!l) return;
  p.geojson=l.toGeoJSON(); pushHistoryPoly(p);
  refreshPolygonMetrics(p.id);
});

function setEditingTarget(id){
  if(polyEditingTargetId) clearEdgeLabels(polyEditingTargetId);
  polyEditingTargetId=id||null;
  if(id) localStorage.setItem('polyEditingId',id); else localStorage.removeItem('polyEditingId');
  renderPolyList(); updatePolygonVisibility();
  if(id){ refreshPolygonMetrics(id); }
}

/***** –ú–û–î–ê–õ–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö–ò –ò–ö–û–ù–û–ö *****/
const builtinIcons=[
  {name:"–î–æ–º",svg:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#fff' d='M3 10L12 3l9 7v10H4z'/></svg>"},
  {name:"–ú–µ—Ç—Ä–æ",svg:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='9' fill='#e11d48'/><path d='M7 16l5-9 5 9' stroke='#fff' stroke-width='2' fill='none'/></svg>"},
  {name:"–û—Ñ–∏—Å",svg:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='6' y='3' width='12' height='18' rx='2' fill='#60a5fa'/><path d='M9 7h2M9 11h2M9 15h2M13 7h2M13 11h2M13 15h2' stroke='#0b1020' stroke-width='1.5'/></svg>"},
  {name:"–®–∫–æ–ª–∞",svg:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 3l9 5-9 5-9-5 9-5z' fill='#fbbf24'/><path d='M5 12v5l7 4 7-4v-5' stroke='#fbbf24' fill='none'/></svg>"},
  {name:"–ü–∞—Ä–∫–æ–≤–∫–∞",svg:"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='4' y='4' width='16' height='16' rx='3' fill='#22d3ee'/><path d='M9 16V8h5a3 3 0 010 6H9z' fill='#0b1020'/></svg>"}
];
const $iconsOverlay=document.getElementById('iconsOverlay');
const $iconsClose=document.getElementById('iconsClose');
const $iconsGrid=document.getElementById('iconsGrid');
function openIconsLib(onPick){
  $iconsGrid.innerHTML="";
  builtinIcons.forEach(icon=>{
    const cell=document.createElement('div'); cell.className='modal-item';
    const data="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(icon.svg)));
    const prev=document.createElement('span'); prev.className='preview-icon'; prev.innerHTML=`<img src="${data}">`;
    const name=document.createElement('div'); name.textContent=icon.name;
    cell.append(prev,name); cell.style.cursor='pointer';
    cell.onclick=()=>{ onPick(data); closeIconsLib(); };
    $iconsGrid.appendChild(cell);
  });
  $iconsOverlay.style.display='flex'; document.body.style.overflow='hidden';
}
function closeIconsLib(){ $iconsOverlay.style.display='none'; document.body.style.overflow=''; }
$iconsClose.onclick=closeIconsLib;

/***** –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ò–Ω—Ñ–æ) *****/
const $infoOverlay=document.getElementById('infoOverlay');
const $infoClose=document.getElementById('infoClose');
const $infoBox=document.getElementById('infoBox');
document.getElementById('btnInfo').onclick=()=>{
  const cats=db.categories.length;
  let items=0, itemsWithCoords=0;
  db.categories.forEach(c=>{items+=(c.items||[]).length;(c.items||[]).forEach(it=>{ if(it.lat!=null&&it.lng!=null) itemsWithCoords++; });});
  const polys=(db.polygons||[]).length;
  $infoBox.innerHTML=`
    <div class="list">
      <div class="item"><div class="item-row"><div class="left"><div class="name">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div><div class="meta">–≤—Å–µ–≥–æ</div></div><div>${cats}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">–≠–ª–µ–º–µ–Ω—Ç–æ–≤</div><div class="meta">–≤—Å–µ–≥–æ</div></div><div>${items}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">–° –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏</div><div class="meta">—ç–ª–µ–º–µ–Ω—Ç—ã</div></div><div>${itemsWithCoords}</div></div></div>
      <div class="item"><div class="item-row"><div class="left"><div class="name">–ü–æ–ª–∏–≥–æ–Ω–æ–≤</div><div class="meta">–≤—Å–µ–≥–æ</div></div><div>${polys}</div></div></div>
    </div>`;
  $infoOverlay.style.display='flex'; document.body.style.overflow='hidden';
};
$infoClose.onclick=()=>{$infoOverlay.style.display='none'; document.body.style.overflow='';};

/***** –≠–ö–°–ü–û–†–¢ / –ò–ú–ü–û–†–¢ –í–°–ï–ì–û *****/
document.getElementById('btnExport').onclick=async ()=>{
  const full=JSON.parse(JSON.stringify(db));
  for(const cat of full.categories){
    if(cat.iconKey && !cat.iconData){ try{ cat.iconData=await lfIcons.getItem(cat.iconKey)||null; }catch(e){} }
    for(const it of (cat.items||[])){
      if(it.iconKey && !it.iconData){ try{ it.iconData=await lfIcons.getItem(it.iconKey)||null; }catch(e){} }
    }
  }
  for(const p of (full.polygons||[])){
    if(!p.geojson){ try{ p.geojson=await lfGeo.getItem(p.id)||null; }catch(e){} }
  }
  const blob=new Blob([JSON.stringify(full,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_full_v39_3R.json'; a.click();
};

document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ()=>{
    try{
      let obj=JSON.parse(r.result); if(obj && obj.db) obj=obj.db;
      if(!Array.isArray(obj.categories)) throw new Error('–ù–µ—Ç categories');
      if(!Array.isArray(obj.polygons))   obj.polygons=[];
      for(const cat of obj.categories){
        if(!cat.id) cat.id=uid();
        if(cat.iconData){ const key=cat.iconKey||`cat_${cat.id}`; await lfIcons.setItem(key,cat.iconData); cat.iconKey=key; }
        for(const it of (cat.items||[])){
          if(!it.id) it.id=uid();
          if(it.iconData){ const key=it.iconKey||`item_${it.id}`; await lfIcons.setItem(key,it.iconData); it.iconKey=key; }
        }
      }
      for(const p of obj.polygons){ if(!p.id) p.id=uid(); if(p.geojson){ await lfGeo.setItem(p.id,p.geojson); } }
      localStorage.setItem(KEY, JSON.stringify({
        categories:obj.categories.map(c=>({
          id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId||null,
          color:c.color,shape:c.shape,iconKey:c.iconKey||null,
          items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId||null,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
        })),
        polygons:(obj.polygons||[]).map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible,metricsEnabled:(p.metricsEnabled!==false)}))
      }));
      db = await loadDB();
      loadSelected(); pushHistory(); renderAll(); resumeEditingIfNeeded(); updatePolygonVisibility();
      alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
  };
  r.readAsText(f);
};

/***** –ü–õ–ê–í–ê–Æ–©–ï–ï –û–ö–ù–û –ö–û–û–†–î–ò–ù–ê–¢ (—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∞) *****/
const $coordTool=document.getElementById('coordTool');
const $coordLat=document.getElementById('coordLat');
const $coordLng=document.getElementById('coordLng');
const $btnCoordFind=document.getElementById('btnCoordFind');
const $btnCoordAdd=document.getElementById('btnCoordAdd');
const $btnCoordClear=document.getElementById('btnCoordClear');
let tempMarker=null;

// –ø–µ—Ä–µ–Ω–æ—Å–∏–º –æ–∫–Ω–æ –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞—Ä—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
document.getElementById('map').appendChild($coordTool);
(function restoreCoordToolPos(){
  const pos=JSON.parse(localStorage.getItem('coordToolPos')||'null');
  if(pos){ $coordTool.style.left=pos.left; $coordTool.style.top=pos.top; }
  else{ $coordTool.style.right='12px'; $coordTool.style.top='12px'; }
})();
$coordTool.style.display='grid';

// –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –∫–∞—Ä—Ç—ã
(function enableDrag(){
  const handle=document.getElementById('coordDrag');
  let sx=0,sy=0,ox=0,oy=0,isDown=false;
  handle.addEventListener('mousedown',e=>{isDown=true;sx=e.clientX;sy=e.clientY; const r=$coordTool.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault();});
  document.addEventListener('mousemove',e=>{
    if(!isDown) return;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    const mapRect=document.getElementById('map').getBoundingClientRect();
    let left=ox+dx, top=oy+dy;
    const toolRect=$coordTool.getBoundingClientRect();
    const w=toolRect.width, h=toolRect.height;
    if(left<mapRect.left) left=mapRect.left;
    if(top<mapRect.top) top=mapRect.top;
    if(left+w>mapRect.right) left=mapRect.right-w;
    if(top+h>mapRect.bottom) top=mapRect.bottom-h;
    $coordTool.style.left=(left-mapRect.left)+'px';
    $coordTool.style.top =(top -mapRect.top )+'px';
    $coordTool.style.right='auto';
  });
  document.addEventListener('mouseup',()=>{
    if(!isDown) return; isDown=false;
    const style=getComputedStyle($coordTool);
    localStorage.setItem('coordToolPos', JSON.stringify({left:style.left, top:style.top}));
  });
})();

function setTempMarker(lat,lng){
  if(tempMarker){ map.removeLayer(tempMarker); tempMarker=null; }
  tempMarker=L.marker([lat,lng],{draggable:true}).addTo(map);
  tempMarker.on('dragend',()=>{
    const p=tempMarker.getLatLng(); $coordLat.value=p.lat.toFixed(6); $coordLng.value=p.lng.toFixed(6);
  });
  map.setView([lat,lng],16);
}

$btnCoordFind.onclick=()=>{
  const lat=parseFloat($coordLat.value), lng=parseFloat($coordLng.value);
  if(Number.isFinite(lat)&&Number.isFinite(lng)) setTempMarker(lat,lng);
  else alert('–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
};
$btnCoordClear.onclick=()=>{
  if(tempMarker){ map.removeLayer(tempMarker); tempMarker=null; }
  $coordLat.value=''; $coordLng.value='';
};
$btnCoordAdd.onclick=()=>{
  if(!tempMarker){ alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ "–ù–∞–π—Ç–∏"'); return; }
  const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏ (—ç–ª–µ–º–µ–Ω—Ç–∞):','–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è'); if(!name) return;
  const catNames=db.categories.map(c=>c.name).join(', ');
  const catName=prompt('–í –∫–∞–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å? –î–æ—Å—Ç—É–ø–Ω—ã: '+catNames);
  const cat=db.categories.find(c=>c.name===catName);
  if(!cat){ alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
  let parentId=null;
  if(cat.parentCategoryId){
    const parentCat=db.categories.find(c=>c.id===cat.parentCategoryId);
    if(parentCat && (parentCat.items||[]).length){
      const parentName=prompt(`–í—ã–±–µ—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—è –∏–∑ "${parentCat.name}" (—Ç–æ—á–Ω–æ–µ –∏–º—è)`, parentCat.items[0].name);
      const parentItem=parentCat.items.find(i=>i.name===parentName);
      if(parentItem) parentId=parentItem.id;
    }
  }
  const p=tempMarker.getLatLng();
  cat.items.push({id:uid(),name:name.trim(),lat:p.lat,lng:p.lng,parentId});
  commit();
  alert('–ú–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: '+cat.name);
};

/***** –ò–ù–°–¢–†–£–ú–ï–ù–¢–´: –ª–∏–Ω–µ–π–∫–∞ / –ª–∏–Ω–∏—è / —Ç–æ—á–∫–∞ *****/
function enableMeasure(){
  alert('–†–µ–∂–∏–º –ª–∏–Ω–µ–π–∫–∏: —Å—Ç–∞–≤—å —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å.');
  const drawer=new L.Draw.Polyline(map,{shapeOptions:{color:'#4aa8ff',weight:3,dashArray:'6,6'}});
  drawer.enable();
  const onCreated=(e)=>{
    const layer=e.layer.addTo(map);
    const latlngs=layer.getLatLngs();
    const dist=L.GeometryUtil.length(latlngs);
    alert('–î–ª–∏–Ω–∞: '+formatLen(dist));
    map.off(L.Draw.Event.CREATED,onCreated);
  };
  map.on(L.Draw.Event.CREATED,onCreated);
}
document.getElementById('btnMeasure').onclick=()=>enableMeasure();
document.getElementById('btnDrawLine').onclick=()=>{
  const drawer=new L.Draw.Polyline(map,{shapeOptions:{color:'#23d1b5',weight:3}});
  drawer.enable();
  const onCreated=(e)=>{ e.layer.addTo(map); map.off(L.Draw.Event.CREATED,onCreated); };
  map.on(L.Draw.Event.CREATED,onCreated);
};
document.getElementById('btnDrawPoint').onclick=()=>{
  const drawer=new L.Draw.Marker(map,{});
  drawer.enable();
  const onCreated=(e)=>{ e.layer.addTo(map); map.off(L.Draw.Event.CREATED,onCreated); };
  map.on(L.Draw.Event.CREATED,onCreated);
};

/***** RESET *****/
document.getElementById('btnReset').onclick=()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')){
    localStorage.removeItem(KEY);
    localStorage.removeItem('selected_v1');
    localStorage.removeItem('polyEditingId');
    localStorage.removeItem('collapsedPolygons_v1');
    localStorage.removeItem('collapsedCats_v1');
    localStorage.removeItem('coordToolPos');
    lfIcons.clear().then(()=>{}); lfGeo.clear().then(()=>{});
    location.reload();
  }
};

/***** –í–ö–õ–ê–î–ö–ò *****/
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const which=tab.dataset.tab;
    document.getElementById('editorTab').style.display=which==='editor'?'block':'none';
    document.getElementById('previewTab').style.display=which==='preview'?'block':'none';
  };
});

/***** –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï: –ü–ï–†–ï–°–ß–Å–¢ –í–ò–î–ò–ú–û–°–¢–ò –ü–û–õ–ò–ì–û–ù–ê –ü–û –í–´–ë–û–†–£ *****/
function getSelectedIds(catId){
  const cat=db.categories.find(x=>x.id===catId); const v=selected[catId];
  if(!v) return []; return(cat&&cat.type==='checkbox')?Array.from(v):(v?[v]:[]);
}
function getSelectedItemNames(){
  const names=new Set();
  for(const cat of db.categories){
    const ids=getSelectedIds(cat.id);
    if(!ids.length) continue;
    (cat.items||[]).forEach(it=>{if(ids.includes(it.id)) names.add(it.name);});
  }
  return names;
}
function updatePolygonVisibility(){
  const names=getSelectedItemNames();
  for(const p of db.polygons){
    const layer=polyIndex.get(p.id); if(!layer) continue;
    const filtered=(p.visible!==false) && (names.size ? names.has(p.name) : false);
    const forceVisible=(polyEditingTargetId && p.id===polyEditingTargetId);
    if(filtered||forceVisible) layer.addTo(map); else map.removeLayer(layer);
    // –ø–ª–æ—â–∞–¥—å —Ç–æ–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
    const lbl=polyAreaLabels.get(p.id);
    if(lbl){
      if(map.hasLayer(layer) && (p.metricsEnabled!==false)) lbl.addTo(map); else map.removeLayer(lbl);
    }
  }
}

/***** MAIN RENDER *****/
async function renderAll(){
  rebuildPolys();
  renderEditor();
  renderPreview();
  renderPolyList();
}

/***** –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–û–õ–ò–ì–û–ù–ê *****/
function resumeEditingIfNeeded(){
  const id=localStorage.getItem('polyEditingId'); if(!id) return;
  const layer=polyIndex.get(id); if(!layer) return;

  if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); }
  polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
  polyEditToolbar.enable(); polyEditing=true;

  polyFG.eachLayer(x=>{
    if(x===layer){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
    else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
  });

  setEditingTarget(id); layer.addTo(map); map.fitBounds(layer.getBounds());
}

/***** –°–¢–ê–†–¢ *****/
let db=null, selected={};
(async()=>{
  db = await loadDB();
  loadSelected();
  pushHistory();           // –ø–µ—Ä–≤–∏—á–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç –∏—Å—Ç–æ—Ä–∏–∏ (–µ—Å–ª–∏ –æ–Ω —É —Ç–µ–±—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —á–∞—Å—Ç–∏ 1)
  await renderAll();
  resumeEditingIfNeeded();
})();
</script>
