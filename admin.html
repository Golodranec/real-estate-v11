<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (–¥–µ—Ä–µ–≤–æ + dnd + layout + preview)</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
  :root{--bg:#0f1115;--panel:#161a22;--muted:#1f2530;--line:#2a3140;--text:#e6e6e6;--accent:#5b9cff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui}
  header{padding:10px;background:var(--panel);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .tabs{display:flex;gap:8px}
  .tab{padding:6px 12px;background:#2a3140;border-radius:6px;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff}
  button{padding:6px 10px;border-radius:6px;border:1px solid transparent;cursor:pointer}
  .btn{background:var(--accent);color:#fff}
  .btn.secondary{background:#2a3140;color:#fff}
  .btn.ghost{background:transparent;border:1px solid #2a3140;color:#e6e6e6}
  main{display:grid;grid-template-columns:1fr 1fr;min-height:90vh}
  .panel{padding:12px;overflow:auto}
  h3{margin:6px 0}
  .chip{padding:2px 6px;border-radius:999px;background:#2a3140;color:#cfe; font-size:12px}

  /* –¥–µ—Ä–µ–≤–æ */
  .tree{list-style:none;margin:0;padding-left:0}
  .tree .node-card{background:var(--muted);border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0}
  .node-head{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .node-head input[type="text"]{padding:6px;border-radius:6px;border:1px solid #333;background:#111722;color:#fff;min-width:200px}
  .node-body{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  .node-col{background:#121721;border:1px solid #283142;border-radius:10px;padding:10px}
  .node-col h4{margin:0 0 8px 0;font-size:13px;color:#cfd8e3}
  .list{min-height:10px}
  .item{background:#1b2230;border:1px solid #2f3a4c;border-radius:8px;padding:6px 8px;margin:6px 0;display:flex;align-items:center;gap:6px}
  .item input[type="text"]{padding:6px;border-radius:6px;border:1px solid #333;background:#111722;color:#fff;flex:1}
  .inline{display:flex;gap:6px;align-items:center}
  select{padding:6px;border-radius:6px;border:1px solid #333;background:#111722;color:#fff}

  /* –º–∞–∫–µ—Ç */
  .canvas{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:80px;gap:6px;background:#0b0d12;border:1px dashed #333;padding:6px;min-height:60vh;border-radius:12px}
  .block{background:#1f2530;border:1px solid #2a3140;border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative;user-select:none}
  .block.drag{opacity:.7;outline:1px dashed #8fb2ff}
  .resize{position:absolute;right:0;bottom:0;width:12px;height:12px;background:var(--accent);cursor:se-resize;border-top-left-radius:3px;border-bottom-right-radius:9px}

  /* –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä */
  .preview-grid{display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:80px;gap:6px;background:#0b0d12;border:1px solid #2a3140;padding:6px;border-radius:12px}
  .preview-block{background:#1a202c;border:1px solid #2a3140;border-radius:10px;padding:10px;overflow:auto}
  .field{margin-bottom:8px}
  .field label{font-size:12px;display:block;margin-bottom:4px;color:#cfd8e3}
  .field input,.field select{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#111722;color:#fff}
</style>
</head>
<body>
<header>
  <div class="tabs">
    <div class="tab active" data-tab="nodes">üå≥ –£–∑–ª—ã</div>
    <div class="tab" data-tab="layout">üñºÔ∏è –ú–∞–∫–µ—Ç</div>
    <div class="tab" data-tab="preview">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
  </div>
  <button class="btn secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label class="btn secondary">–ò–º–ø–æ—Ä—Ç<input id="importInput" type="file" hidden></label>
  <button class="btn ghost" id="resetBtn">–°–±—Ä–æ—Å</button>
  <span class="chip">Drag & drop –¥–ª—è —É–∑–ª–æ–≤, –ø–æ–¥—É–∑–ª–æ–≤, –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –º–∞–∫–µ—Ç–∞</span>
</header>

<main>
  <!-- –£–ó–õ–´ -->
  <section class="panel" id="nodesPanel">
    <h3>–£–∑–ª—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
    <div style="margin-bottom:8px">
      <button class="btn" onclick="addRootNode()">+ –£–∑–µ–ª</button>
    </div>
    <ul class="tree" id="rootNodes" data-path="nodes"></ul>
  </section>

  <!-- –ú–ê–ö–ï–¢ -->
  <section class="panel" id="layoutPanel" style="display:none">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞–∫–µ—Ç–∞</h3>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
      <button class="btn" onclick="addBlock('filters')">–§–∏–ª—å—Ç—Ä—ã</button>
      <button class="btn" onclick="addBlock('map')">–ö–∞—Ä—Ç–∞</button>
      <button class="btn" onclick="addBlock('form')">–§–æ—Ä–º–∞</button>
      <button class="btn" onclick="addBlock('cards')">–°–ø–∏—Å–æ–∫</button>
      <button class="btn" onclick="addBlock('table')">–¢–∞–±–ª–∏—Ü–∞</button>
      <button class="btn" onclick="addBlock('banner')">–†–µ–∫–ª–∞–º–∞</button>
    </div>
    <div class="canvas" id="canvas"></div>
  </section>

  <!-- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† -->
  <section class="panel" id="previewPanel" style="display:none">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div class="preview-grid" id="preview"></div>
  </section>
</main>

<script>
/* ===== –±–∞–∑–∞/—Ö—Ä–∞–Ω–∏–ª–∏—â–µ ===== */
const KEY="admin_final_tree_layout_preview_v2";
const COLS=12, ROW=80, GAP=6;
let data = load() || demoData();
let previewState = {}; // –≤—ã–±–æ—Ä—ã –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ

function load(){try{return JSON.parse(localStorage.getItem(KEY)||"")}catch(e){return null}}
function save(){localStorage.setItem(KEY,JSON.stringify(data))}
function reset(){localStorage.removeItem(KEY);location.reload()}
function demoData(){
  return {
    nodes: [
      {
        name:"–ì–æ—Ä–æ–¥", params:[{label:"–¶–µ–Ω–∞",type:"range"},{label:"–ö–æ–º–Ω–∞—Ç—ã",type:"select",options:["1","2","3","4","5+"]}],
        children:[
          { name:"–¢–∞—à–∫–µ–Ω—Ç",
            params:[{label:"–≠—Ç–∞–∂",type:"number"}],
            children:[
              { name:"–Æ–Ω—É—Å–∞–±–∞–¥", children:[{name:"–ê–±–∞–π",params:[]},{name:"–ú—É–∫–∏–º–∏",params:[]}] },
              { name:"–ß–∏–ª–∞–Ω–∑–∞—Ä", children:[{name:"–ë–µ—Ä—É–Ω–∏",params:[]},{name:"–ì–∞–≥–∞—Ä–∏–Ω–∞",params:[]}] }
            ]
          },
          { name:"–°–∞–º–∞—Ä–∫–∞–Ω–¥",
            children:[
              { name:"–†–µ–≥–∏—Å—Ç–∞–Ω" },
              { name:"–ê—Ñ—Ä–æ—Å–∏—ë–±" }
            ]
          }
        ]
      },
      {
        name:"–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
        children:[
          { name:"–ö–≤–∞—Ä—Ç–∏—Ä–∞", params:[{label:"–ü–ª–æ—â–∞–¥—å",type:"number"}],
            children:[ {name:"–ü—Ä–æ–¥–∞–∂–∞"}, {name:"–ê—Ä–µ–Ω–¥–∞"} ] },
          { name:"–î–æ–º", children:[ {name:"–ü—Ä–æ–¥–∞–∂–∞"}, {name:"–ê—Ä–µ–Ω–¥–∞"} ] },
          { name:"–ö–æ–º–º–µ—Ä—Ü–∏—è", children:[ {name:"–û—Ñ–∏—Å"}, {name:"–°–∫–ª–∞–¥"}, {name:"–ú–∞–≥–∞–∑–∏–Ω"} ] }
        ]
      }
    ],
    layout:[
      {id:1,type:"filters",x:1,y:1,w:4,h:4},
      {id:2,type:"map",x:5,y:1,w:8,h:6},
      {id:3,type:"cards",x:1,y:5,w:12,h:6}
    ]
  }
}

/* ===== –≤–∫–ª–∞–¥–∫–∏ ===== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const id=tab.dataset.tab;
    document.getElementById("nodesPanel").style.display=id==="nodes"?"block":"none";
    document.getElementById("layoutPanel").style.display=id==="layout"?"block":"none";
    document.getElementById("previewPanel").style.display=id==="preview"?"block":"none";
    renderAll();
  }
});

/* ===== —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç/—Å–±—Ä–æ—Å ===== */
document.getElementById("exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="admin-config.json"; a.click(); URL.revokeObjectURL(url);
};
document.getElementById("importInput").addEventListener("change",async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const txt=await f.text(); data=JSON.parse(txt); save(); renderAll();
});
document.getElementById("resetBtn").onclick=reset;

/* ===== —É—Ç–∏–ª–∏—Ç—ã –ø—É—Ç–∏ ===== */
function getByPath(obj, pathArr){
  return pathArr.reduce((o,k)=>o?.[k], obj);
}
function setByPath(obj, pathArr, value){
  const last = pathArr.pop();
  const parent = getByPath(obj, pathArr);
  parent[last]=value;
}
function arrayByPath(pathStr){
  // pathStr –≤–∏–¥–∞: nodes[0].children[2].children ‚Äî –¥–æ—Å—Ç–∞—ë–º –º–∞—Å—Å–∏–≤
  if(!pathStr) return null;
  const parts = pathStr.replace(/\]/g,"").split(/\[|\]\.|\./).filter(Boolean);
  // –Ω–∞–ø—Ä–∏–º–µ—Ä ["nodes","0","children","2","children"]
  let ref = data;
  for(let i=0;i<parts.length;i++){
    const k = isFinite(parts[i]) ? Number(parts[i]) : parts[i];
    ref = ref[k];
  }
  return ref;
}

/* ===== —Ä–µ–Ω–¥–µ—Ä —É–∑–ª–æ–≤/–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å dnd ===== */
function addRootNode(){
  data.nodes.push({name:"–ù–æ–≤—ã–π —É–∑–µ–ª",children:[],params:[]});
  save(); renderNodes();
}
function renderNodes(){
  const root = document.getElementById("rootNodes");
  root.innerHTML = "";
  root.dataset.path = "nodes";
  data.nodes.forEach((node,i)=>{
    root.appendChild(renderNode(node, `nodes[${i}]`));
  });
  // DND –¥–ª—è –∫–æ—Ä–Ω–µ–≤—ã—Ö —É–∑–ª–æ–≤
  makeSortable(root, "nodes", (evt)=>{
    moveInArray(evt, "node");
  });
}
function renderNode(node, path){
  const li = document.createElement("li");
  li.className="node-card";
  li.dataset.path = path;

  // —à–∞–ø–∫–∞ —É–∑–ª–∞
  const head = document.createElement("div");
  head.className="node-head";
  head.innerHTML = `
    <input type="text" value="${escapeHtml(node.name||'')}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–∑–ª–∞" oninput="onRenameNode('${path}', this.value)">
    <button class="btn" onclick="addChild('${path}')">+ –ü–æ–¥—É–∑–µ–ª</button>
    <button class="btn" onclick="addParam('${path}')">+ –ü–∞—Ä–∞–º–µ—Ç—Ä</button>
    <button class="btn ghost" onclick="deleteNode('${path}')">–£–¥–∞–ª–∏—Ç—å</button>
  `;
  li.appendChild(head);

  // —Ç–µ–ª–æ —É–∑–ª–∞: –∫–æ–ª–æ–Ω–∫–∏ ¬´–ü–∞—Ä–∞–º–µ—Ç—Ä—ã¬ª –∏ ¬´–ü–æ–¥—É–∑–ª—ã¬ª
  const body = document.createElement("div");
  body.className="node-body";

  // –∫–æ–ª–æ–Ω–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  const colParams = document.createElement("div");
  colParams.className="node-col";
  colParams.innerHTML = `<h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>`;
  const paramsList = document.createElement("div");
  paramsList.className = "list";
  paramsList.dataset.path = path + ".params";
  (node.params||[]).forEach((p,j)=>{
    const row = document.createElement("div");
    row.className="item";
    row.dataset.index=j;
    row.innerHTML = `
      <input type="text" value="${escapeHtml(p.label||'')}" placeholder="–ú–µ—Ç–∫–∞" oninput="onParamLabel('${path}', ${j}, this.value)">
      <select onchange="onParamType('${path}', ${j}, this.value)">
        <option value="text" ${p.type==='text'?'selected':''}>text</option>
        <option value="number" ${p.type==='number'?'selected':''}>number</option>
        <option value="select" ${p.type==='select'?'selected':''}>select</option>
        <option value="range" ${p.type==='range'?'selected':''}>range</option>
      </select>
      ${p.type==='select'?`<input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" value="${escapeHtml((p.options||[]).join(', '))}" oninput="onParamOptions('${path}', ${j}, this.value)">`:''}
      <button class="btn ghost" onclick="deleteParam('${path}', ${j})">‚úñ</button>
    `;
    paramsList.appendChild(row);
  });
  colParams.appendChild(paramsList);
  body.appendChild(colParams);

  // –∫–æ–ª–æ–Ω–∫–∞ –ø–æ–¥—É–∑–ª–æ–≤
  const colChildren = document.createElement("div");
  colChildren.className="node-col";
  colChildren.innerHTML = `<h4>–ü–æ–¥—É–∑–ª—ã</h4>`;
  const childrenList = document.createElement("ul");
  childrenList.className="tree";
  childrenList.dataset.path = path + ".children";
  (node.children||[]).forEach((ch,k)=>{
    childrenList.appendChild(renderNode(ch, `${path}.children[${k}]`));
  });
  colChildren.appendChild(childrenList);
  body.appendChild(colChildren);

  li.appendChild(body);

  // DND: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  makeSortable(paramsList, "params", (evt)=>{
    moveInArray(evt, "param");
  });
  // DND: –ø–æ–¥—É–∑–ª—ã (–º–µ–∂–¥—É —Å–æ–±–æ–π –∏ –ø–µ—Ä–µ–Ω–æ—Å –∫ –¥—Ä—É–≥–∏–º —É–∑–ª–∞–º)
  makeSortable(childrenList, "nodes", (evt)=>{
    moveInArray(evt, "node");
  });

  return li;
}

function makeSortable(container, groupName, onEnd){
  Sortable.create(container,{
    animation:150,
    group:{name:groupName, pull:true, put:true},
    handle: undefined,
    onEnd
  });
}
function moveInArray(evt, kind){
  // kind: "node" –∏–ª–∏ "param"
  const fromPathArr = evt.from.dataset.path;
  const toPathArr   = evt.to.dataset.path;
  if(!fromPathArr || !toPathArr) return;
  const fromArray = arrayByPath(fromPathArr);
  const toArray   = arrayByPath(toPathArr);
  if(!fromArray || !toArray) return;

  // —ç–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –¥–≤–∏–≥–∞–µ–º
  const moved = fromArray.splice(evt.oldIndex,1)[0];
  toArray.splice(evt.newIndex,0,moved);

  save();
  renderNodes();
}

/* ==== —É–∑–ª—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: –¥–µ–π—Å—Ç–≤–∏—è ==== */
function onRenameNode(path, val){
  const ref = getByPath(data, pathToArray(path));
  ref.name = val; save();
}
function addChild(path){
  const list = getByPath(data, pathToArray(path + ".children")) || [];
  list.push({name:"–ü–æ–¥—É–∑–µ–ª",children:[],params:[]});
  setByPath(data, pathToArray(path + ".children"), list);
  save(); renderNodes();
}
function addParam(path){
  const list = getByPath(data, pathToArray(path + ".params")) || [];
  list.push({label:"–ü–∞—Ä–∞–º–µ—Ç—Ä",type:"text"});
  setByPath(data, pathToArray(path + ".params"), list);
  save(); renderNodes();
}
function deleteNode(path){
  const parentPath = path.replace(/\.\w+\[\d+\]$/,""); // –æ–±—Ä–µ–∂–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç
  const index = +path.match(/\[(\d+)\]$/)[1];
  const list = getByPath(data, pathToArray(parentPath)) || [];
  list.splice(index,1);
  setByPath(data, pathToArray(parentPath), list);
  save(); renderNodes();
}
function onParamLabel(path, idx, val){
  const p = getByPath(data, pathToArray(path + `.params[${idx}]`));
  p.label = val; save();
}
function onParamType(path, idx, val){
  const p = getByPath(data, pathToArray(path + `.params[${idx}]`));
  p.type = val;
  if(val!=="select") delete p.options;
  save(); renderNodes();
}
function onParamOptions(path, idx, csv){
  const p = getByPath(data, pathToArray(path + `.params[${idx}]`));
  p.options = csv.split(",").map(s=>s.trim()).filter(Boolean);
  save();
}
function deleteParam(path, idx){
  const list = getByPath(data, pathToArray(path + `.params`)) || [];
  list.splice(idx,1);
  setByPath(data, pathToArray(path + `.params`), list);
  save(); renderNodes();
}

/* ===== –º–∞–∫–µ—Ç: drag + resize ===== */
const canvas=document.getElementById("canvas");
let drag=null, size=null;

function addBlock(type){
  data.layout.push({id:Date.now(),type,x:1,y:1,w:4,h:2});
  save(); renderLayout(); renderPreview();
}
function delBlock(id){
  data.layout=data.layout.filter(b=>b.id!==id);
  save(); renderLayout(); renderPreview();
}
function renderLayout(){
  canvas.innerHTML="";
  data.layout.forEach(b=>{
    const el=document.createElement("div");
    el.className="block";
    el.style.gridColumn=`${b.x}/span ${b.w}`;
    el.style.gridRow=`${b.y}/span ${b.h}`;
    el.innerHTML=`${labelByType(b.type)}<div class="resize"></div>`;
    // drag
    el.addEventListener("mousedown",e=>{
      if(e.target.classList.contains("resize"))return;
      e.preventDefault();
      const rect=canvas.getBoundingClientRect(),cellW=rect.width/COLS,cellH=ROW+GAP;
      drag={block:b,startX:e.clientX,startY:e.clientY,startGX:b.x,startGY:b.y,cellW,cellH,el};
      el.classList.add("drag");
      window.addEventListener("mousemove",onDragMove);
      window.addEventListener("mouseup",onDragEnd);
    });
    // resize
    el.querySelector(".resize").addEventListener("mousedown",e=>{
      e.stopPropagation();
      const rect=canvas.getBoundingClientRect(),cellW=rect.width/COLS;
      size={block:b,startX:e.clientX,startY:e.clientY,startW:b.w,startH:b.h,cellW};
      window.addEventListener("mousemove",onResizeMove);
      window.addEventListener("mouseup",onResizeEnd);
    });
    canvas.appendChild(el);
  });
}
function onDragMove(e){
  if(!drag) return;
  const {block,startX,startY,startGX,startGY,cellW,cellH}=drag;
  let nx=startGX + Math.round((e.clientX-startX)/cellW);
  let ny=startGY + Math.round((e.clientY-startY)/cellH);
  nx=Math.max(1,Math.min(COLS-block.w+1,nx));
  ny=Math.max(1,ny);
  block.x=nx; block.y=ny;
  save(); renderLayout();
}
function onDragEnd(){
  if(!drag) return;
  drag.el.classList.remove("drag");
  drag=null;
  window.removeEventListener("mousemove",onDragMove);
  window.removeEventListener("mouseup",onDragEnd);
  renderPreview();
}
function onResizeMove(e){
  if(!size) return;
  const {block,startX,startY,startW,startH,cellW}=size;
  let w=startW + Math.round((e.clientX-startX)/cellW);
  let h=startH + Math.round((e.clientY-startY)/ROW);
  w=Math.max(1,Math.min(COLS-block.x+1,w));
  h=Math.max(1,h);
  block.w=w; block.h=h;
  save(); renderLayout();
}
function onResizeEnd(){
  size=null;
  window.removeEventListener("mousemove",onResizeMove);
  window.removeEventListener("mouseup",onResizeEnd);
  renderPreview();
}
function labelByType(t){
  return ({
    filters:"–§–∏–ª—å—Ç—Ä—ã",
    map:"–ö–∞—Ä—Ç–∞",
    form:"–§–æ—Ä–º–∞",
    cards:"–°–ø–∏—Å–æ–∫",
    table:"–¢–∞–±–ª–∏—Ü–∞",
    banner:"–†–µ–∫–ª–∞–º–∞"
  })[t]||t;
}

/* ===== –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ===== */
function renderPreview(){
  const wrap=document.getElementById("preview");
  wrap.innerHTML="";
  data.layout.forEach(b=>{
    const el=document.createElement("div");
    el.className="preview-block";
    el.style.gridColumn=`${b.x}/span ${b.w}`;
    el.style.gridRow=`${b.y}/span ${b.h}`;
    if(b.type==="map"){ el.innerHTML="üó∫Ô∏è –ö–∞—Ä—Ç–∞"; }
    if(b.type==="filters"){ el.innerHTML="<h4>–§–∏–ª—å—Ç—Ä—ã</h4>"; renderPreviewFilters(el); }
    if(b.type==="form"){ el.innerHTML="<h4>–§–æ—Ä–º–∞</h4>"; renderPreviewForm(el); }
    if(b.type==="cards"){ el.innerHTML="üìã –°–ø–∏—Å–æ–∫"; }
    if(b.type==="table"){ el.innerHTML="üìä –¢–∞–±–ª–∏—Ü–∞"; }
    if(b.type==="banner"){ el.innerHTML="<div style='background:#223355;padding:20px;border-radius:8px'>–†–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫</div>"; }
    wrap.appendChild(el);
  });
}
function renderPreviewFilters(container){
  // –ü—Ä–∞–≤–∏–ª–æ: –∫–∞–∂–¥—ã–π –∫–æ—Ä–Ω–µ–≤–æ–π —É–∑–µ–ª = –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Å–∫–∞–¥–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ select'–æ–≤ (–ø–æ –µ–≥–æ –ø–æ–¥–¥–µ—Ä–µ–≤—É)
  data.nodes.forEach((root, idx)=>{
    drawTreeSelect(container, root, `root${idx}`);
    // + –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è:
    renderParams(container, root.params||[], `${root.name}`);
  });
}
function drawTreeSelect(container, node, chainKey){
  // —Ä–µ–Ω–¥–µ—Ä –ø–æ —É—Ä–æ–≤–Ω—è–º: –ø–æ–∫–∞ –µ—Å—Ç—å children ‚Äî —Å—Ç—Ä–æ–∏–º select
  let levelNodes = [node]; // —Å—Ç–∞—Ä—Ç—É–µ–º —Å —Ç–µ–∫—É—â–µ–≥–æ —É–∑–ª–∞, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ children
  let level = -1; // -1 –æ–∑–Ω–∞—á–∞–µ—Ç: —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å ‚Äî –¥–µ—Ç–∏ —Ç–µ–∫—É—â–µ–≥–æ node
  while(true){
    const current = (level<0 ? levelNodes[0].children : levelNodes); // –ø–µ—Ä–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: –¥–µ—Ç–∏ –∫–æ—Ä–Ω—è
    if(!current || !current.length) break;

    const val = (previewState[chainKey]||[])[level+1];
    const sel = document.createElement("select");
    sel.innerHTML = "<option value=''>‚Äî</option>" + current.map(n=>`<option ${val===n.name?'selected':''}>${escapeHtml(n.name)}</option>`).join("");
    const box = document.createElement("div"); box.className="field";
    box.innerHTML=`<label>${node.name}${level>=0?` ‚Äî —É—Ä–æ–≤–µ–Ω—å ${level+2}`:''}</label>`;
    box.appendChild(sel); container.appendChild(box);

    sel.onchange = ()=>{
      const chain = (previewState[chainKey]||[]).slice(0, level+1);
      if(sel.value) chain[level+1] = sel.value;
      previewState[chainKey]=chain; renderPreview();
    };

    // –Ω–∞–π–¥—ë–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏ –ø–æ–π–¥—ë–º –≤–Ω–∏–∑
    const chosen = current.find(n=>n.name === val);
    if(chosen && chosen.children && chosen.children.length){
      levelNodes = chosen.children;
      level++;
    }else{
      break;
    }
  }
}
function renderParams(container, params, titlePrefix){
  (params||[]).forEach(p=>{
    const box=document.createElement("div"); box.className="field";
    box.innerHTML=`<label>${escapeHtml(titlePrefix)} ‚Äî ${escapeHtml(p.label||'')}</label>`;
    if(p.type==="range"){
      box.innerHTML+=`<div style="display:flex;gap:6px"><input placeholder="–æ—Ç"><input placeholder="–¥–æ"></div>`;
    }else if(p.type==="select"){
      const opts=(p.options||[]).map(o=>`<option>${escapeHtml(o)}</option>`).join("");
      box.innerHTML+=`<select><option>‚Äî</option>${opts}</select>`;
    }else if(p.type==="number"){
      box.innerHTML+=`<input type="number">`;
    }else{
      box.innerHTML+=`<input type="text">`;
    }
    container.appendChild(box);
  });
}
function renderPreviewForm(container){
  // –î–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—Å–µ—Ö —É–∑–ª–æ–≤ (–∫–∞–∫ –ø—Ä–∏–º–µ—Ä)
  data.nodes.forEach(root=>{
    renderParams(container, root.params||[], root.name);
    (root.children||[]).forEach(ch=>{
      renderParams(container, ch.params||[], `${root.name} ‚Üí ${ch.name}`);
    });
  });
}

/* ===== helpers ===== */
function escapeHtml(s){return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
function pathToArray(path){
  // "nodes[0].children[2]" -> ["nodes",0,"children",2]
  const out=[];
  path.replace(/\.?([a-zA-Z_]\w*)|\[(\d+)\]/g,(_,k,i)=>{ out.push(k!==undefined?k:Number(i)) });
  return out;
}

/* ===== —Å—Ç–∞—Ä—Ç ===== */
function renderAll(){ renderNodes(); renderLayout(); renderPreview(); }
renderAll();
</script>
</body>
</html>
