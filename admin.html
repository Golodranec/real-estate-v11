<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Äî —Ä—è–¥—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ + –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Å–≤—è–∑–∏</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
  :root{--bg:#0f1115;--panel:#161a22;--muted:#1f2530;--line:#2a3140;--text:#e6e6e6;--accent:#5b9cff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui}
  header{padding:10px;background:var(--panel);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .tabs{display:flex;gap:8px}
  .tab{padding:6px 12px;background:#2a3140;border-radius:6px;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff}
  button{padding:6px 10px;border-radius:6px;border:1px solid transparent;cursor:pointer}
  .btn{background:var(--accent);color:#fff}
  .btn.secondary{background:#2a3140;color:#fff}
  .btn.ghost{background:transparent;border:1px solid #2a3140;color:#e6e6e6}
  input,select,textarea{padding:8px;border-radius:8px;border:1px solid #333;background:#111722;color:#fff}
  main{display:grid;grid-template-columns:1fr 1fr;min-height:92vh}
  .panel{padding:12px;overflow:auto}
  h3{margin:6px 0}
  .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .item{display:flex;gap:6px;align-items:center;background:var(--muted);border:1px solid var(--line);border-radius:10px;padding:8px;margin:6px 0;flex-wrap:wrap}
  .item .grow{flex:1;min-width:160px}
  .group{border:1px solid var(--line);border-radius:10px;padding:10px;margin:10px 0}
  .group h4{margin:0 0 8px 0;color:#cfd8e3}
  .list{display:flex;flex-wrap:wrap;gap:8px}
  .filter-chip{display:flex;gap:6px;align-items:center;background:#1a202c;border:1px solid #2a3140;border-radius:10px;padding:8px}
  .filter-chip input,.filter-chip select{height:34px}
  .canvas{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:80px;gap:6px;background:#0b0d12;border:1px dashed #333;padding:6px;min-height:60vh;border-radius:12px}
  .block{background:#1f2530;border:1px solid #2a3140;border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative;user-select:none}
  .block.drag{opacity:.7;outline:1px dashed #8fb2ff}
  .resize{position:absolute;right:0;bottom:0;width:12px;height:12px;background:var(--accent);cursor:se-resize;border-top-left-radius:3px;border-bottom-right-radius:9px}
  .block .close{position:absolute;top:4px;right:4px;background:#e53e3e;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;color:#fff;font-size:14px;line-height:20px;text-align:center}
  .block .close:hover{background:#ff6b6b}
  .preview-grid{display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:80px;gap:6px;background:#0b0d12;border:1px solid #2a3140;padding:6px;border-radius:12px}
  .preview-block{background:#1a202c;border:1px solid #2a3140;border-radius:10px;padding:10px;overflow:auto}
  .filters-row{display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin-bottom:10px}
  .field{margin-bottom:8px;min-width:140px}
  .field label{display:block;margin-bottom:4px;font-size:12px;color:#cfd8e3}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .card{width:min(1000px,96vw);max-height:90vh;overflow:auto;background:#0b0f17;border:1px solid #263042;border-radius:12px;padding:14px}
  textarea{width:100%;min-height:220px;padding:10px;border-radius:8px;border:1px solid #333;background:#0f1522;color:#fff;resize:vertical}
  .hint{color:#9fb3d6;font-size:12px;margin-top:6px}
  .toast{position:fixed;bottom:18px;right:18px;background:#1f2530;border:1px solid #2a3140;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(8px);transition:opacity .2s, transform .2s;z-index:100}
  .toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<header>
  <div class="tabs">
    <div class="tab active" data-tab="filters">‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã –∏ —Ä—è–¥—ã</div>
    <div class="tab" data-tab="fields">üìù –ü–æ–ª—è —Ñ–æ—Ä–º—ã</div>
    <div class="tab" data-tab="layout">üñºÔ∏è –ú–∞–∫–µ—Ç</div>
    <div class="tab" data-tab="preview">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
  </div>
  <button class="btn secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label class="btn secondary">–ò–º–ø–æ—Ä—Ç<input id="importInput" type="file" hidden></label>
  <button class="btn ghost" id="resetBtn">–°–±—Ä–æ—Å</button>
</header>

<main>
  <!-- –§–ò–õ–¨–¢–†–´ -->
  <section class="panel" id="filtersPanel">
    <h3>–†—è–¥—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤</h3>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" onclick="addGroup()">+ –†—è–¥</button>
      <button class="btn" onclick="addFilter()">+ –§–∏–ª—å—Ç—Ä</button>
    </div>
    <div id="groupsWrap"></div>
    <hr>
    <h3>–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã (—Ç–∞–±–ª–∏—Ü–∞)</h3>
    <div id="filtersTable"></div>
  </section>

  <!-- –ü–û–õ–Ø -->
  <section class="panel" id="fieldsPanel" style="display:none">
    <h3>–ü–æ–ª—è —Ñ–æ—Ä–º—ã</h3>
    <div id="fieldsList"></div>
    <button class="btn" onclick="addField()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
  </section>

  <!-- –ú–ê–ö–ï–¢ -->
  <section class="panel" id="layoutPanel" style="display:none">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞–∫–µ—Ç–∞</h3>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" onclick="addBlock('filters')">–§–∏–ª—å—Ç—Ä—ã</button>
      <button class="btn" onclick="addBlock('map')">–ö–∞—Ä—Ç–∞</button>
      <button class="btn" onclick="addBlock('form')">–§–æ—Ä–º–∞</button>
      <button class="btn" onclick="addBlock('cards')">–°–ø–∏—Å–æ–∫</button>
      <button class="btn" onclick="addBlock('table')">–¢–∞–±–ª–∏—Ü–∞</button>
      <button class="btn" onclick="addBlock('banner')">–†–µ–∫–ª–∞–º–∞</button>
    </div>
    <div class="canvas" id="canvas"></div>
  </section>

  <!-- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† -->
  <section class="panel" id="previewPanel" style="display:none">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div class="preview-grid" id="preview"></div>
  </section>
</main>

<!-- –ú–û–î–ê–õ–ö–ò -->
<div class="modal" id="modal">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong id="modalTitle">–†–µ–¥–∞–∫—Ç–æ—Ä</strong>
      <button class="btn ghost" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- —Ç–æ—Å—Ç -->
<div class="toast" id="toast"></div>
<script>
/* ===== –¥–∞–Ω–Ω—ã–µ ===== */
const KEY="admin_groups_cascade_v1";
const COLS=12, ROW=80, GAP=6;
let data = load() || demoData();
let previewState = {}; // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ

function load(){try{return JSON.parse(localStorage.getItem(KEY)||"")}catch(e){return null}}
function save(){localStorage.setItem(KEY,JSON.stringify(data))}
function resetAll(){localStorage.removeItem(KEY);location.reload()}

/* –¥–µ–º–æ */
function demoData(){
  return {
    groups:[
      {id:1, name:"–í–µ—Ä—Ö–Ω—è—è –ª–∏–Ω–∏—è", filters:["country","city","district","category","subcategory","type"]},
      {id:2, name:"–ù–∏–∂–Ω—è—è –ª–∏–Ω–∏—è", filters:["price","rooms"]}
    ],
    filters:[
      {label:"–°—Ç—Ä–∞–Ω–∞", field:"country", type:"select", options:["–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"], rules:[]},
      {label:"–ì–æ—Ä–æ–¥", field:"city", type:"select", options:["–¢–∞—à–∫–µ–Ω—Ç","–°–∞–º–∞—Ä–∫–∞–Ω–¥"], rules:[
        {path:["–°—Ç—Ä–∞–Ω–∞","–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"], options:["–¢–∞—à–∫–µ–Ω—Ç","–°–∞–º–∞—Ä–∫–∞–Ω–¥"]}
      ]},
      {label:"–†–∞–π–æ–Ω", field:"district", type:"select", options:[], rules:[
        {path:["–ì–æ—Ä–æ–¥","–¢–∞—à–∫–µ–Ω—Ç"], options:["–Æ–Ω—É—Å–∞–±–∞–¥","–ß–∏–ª–∞–Ω–∑–∞—Ä"]},
        {path:["–ì–æ—Ä–æ–¥","–°–∞–º–∞—Ä–∫–∞–Ω–¥"], options:["–†–µ–≥–∏—Å—Ç–∞–Ω","–ê—Ñ—Ä–æ—Å–∏—ë–±"]}
      ]},
      {label:"–ö–∞—Ç–µ–≥–æ—Ä–∏—è", field:"category", type:"select", options:["–ö–≤–∞—Ä—Ç–∏—Ä–∞","–ö–æ–º–º–µ—Ä—Ü–∏—è"], rules:[]},
      {label:"–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è", field:"subcategory", type:"select", options:[], rules:[
        {path:["–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–ö–≤–∞—Ä—Ç–∏—Ä–∞"], options:["–ü—Ä–æ–¥–∞–∂–∞","–ê—Ä–µ–Ω–¥–∞","–û–±–º–µ–Ω"]},
        {path:["–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–ö–æ–º–º–µ—Ä—Ü–∏—è"], options:["–ü—Ä–æ–¥–∞–∂–∞","–ê—Ä–µ–Ω–¥–∞"]}
      ]},
      {label:"–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏", field:"type", type:"select", options:[], rules:[
        {path:["–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–ö–≤–∞—Ä—Ç–∏—Ä–∞","–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è","–ü—Ä–æ–¥–∞–∂–∞"], options:["–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞","–í—Ç–æ—Ä–∏—á–∫–∞"]},
        {path:["–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–ö–≤–∞—Ä—Ç–∏—Ä–∞","–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è","–ê—Ä–µ–Ω–¥–∞"], options:["–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è","–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è"]},
        {path:["–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–ö–æ–º–º–µ—Ä—Ü–∏—è","–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è","–ü—Ä–æ–¥–∞–∂–∞"], options:["–û—Ñ–∏—Å","–°–∫–ª–∞–¥"]}
      ]},
      {label:"–¶–µ–Ω–∞", field:"price", type:"range"},
      {label:"–ö–æ–º–Ω–∞—Ç—ã", field:"rooms", type:"select", options:["1","2","3","4","5+"]}
    ],
    fields:[
      {label:"–ó–∞–≥–æ–ª–æ–≤–æ–∫", id:"title", type:"text"},
      {label:"–û–ø–∏—Å–∞–Ω–∏–µ", id:"desc", type:"textarea"},
      {label:"–¢–µ–ª–µ—Ñ–æ–Ω", id:"phone", type:"text"}
    ],
    layout:[
      {id:1,type:"filters",x:1,y:1,w:12,h:2},
      {id:2,type:"map",x:1,y:3,w:7,h:6},
      {id:3,type:"cards",x:8,y:3,w:5,h:6}
    ]
  }
}

/* ===== –≤–∫–ª–∞–¥–∫–∏ ===== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const id=tab.dataset.tab;
    document.getElementById("filtersPanel").style.display=id==="filters"?"block":"none";
    document.getElementById("fieldsPanel").style.display=id==="fields"?"block":"none";
    document.getElementById("layoutPanel").style.display=id==="layout"?"block":"none";
    document.getElementById("previewPanel").style.display=id==="preview"?"block":"none";
    renderAll();
  }
});

/* ===== —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç ===== */
const exportBtn=document.getElementById("exportBtn");
const importInput=document.getElementById("importInput");
const resetBtn=document.getElementById("resetBtn");

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT=setTimeout(()=>t.classList.remove("show"),1800);
}

exportBtn.onclick=()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="admin-config.json"; a.click(); URL.revokeObjectURL(url);
  showToast("–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");
};
importInput.addEventListener("change",async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const txt=await f.text(); data=JSON.parse(txt); save(); renderAll();
    showToast("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");
  }catch(err){
    console.error(err);
    showToast("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
  }
});
resetBtn.onclick=resetAll;
/* ===== —É—Ç–∏–ª–∫–∏ ===== */
function escapeHtml(s){return (s||"").replace(/[&<>\"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
function byField(field){return data.filters.find(f=>f.field===field)}
function ensureGroupsContainExistingFilters(){
  const all = new Set(data.filters.map(f=>f.field));
  data.groups.forEach(g=>g.filters.forEach(x=>all.delete(x)));
  const missing = [...all];
  if(missing.length){
    if(!data.groups.length) data.groups.push({id:Date.now(),name:"–õ–∏–Ω–∏—è",filters:[]});
    data.groups[0].filters.push(...missing);
  }
}

/* ===== –†–Ø–î–´ –ò –§–ò–õ–¨–¢–†–´ (UI) ===== */
function addGroup(){ data.groups.push({id:Date.now(),name:"–ù–æ–≤—ã–π —Ä—è–¥",filters:[]}); save(); renderGroups(); }
function addFilter(){
  const f={label:"–§–∏–ª—å—Ç—Ä",field:"field_"+Date.now(),type:"select",options:[],rules:[]};
  data.filters.push(f);
  if(!data.groups.length) data.groups.push({id:Date.now(),name:"–õ–∏–Ω–∏—è",filters:[]});
  data.groups[0].filters.push(f.field);
  save(); renderGroups(); renderFiltersTable(); renderPreview();
}

function renderGroups(){
  ensureGroupsContainExistingFilters();
  const wrap=document.getElementById("groupsWrap"); wrap.innerHTML="";
  data.groups.forEach((g,gi)=>{
    const box=document.createElement("div"); box.className="group";
    box.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <h4 contenteditable oninput="data.groups[${gi}].name=this.innerText;save()">${escapeHtml(g.name)}</h4>
        </div>
        <div class="row">
          <button class="btn ghost" onclick="deleteGroup(${gi})">–£–¥–∞–ª–∏—Ç—å —Ä—è–¥</button>
        </div>
      </div>
      <div class="list" id="group_${g.id}" data-group="${g.id}"></div>
    `;
    wrap.appendChild(box);

    const list = box.querySelector(".list");
    g.filters.forEach(field=>{
      const f=byField(field); if(!f) return;
      const chip=document.createElement("div"); chip.className="filter-chip"; chip.dataset.field=f.field;
      chip.innerHTML=`
        <input class="grow" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${escapeHtml(f.label||"")}" oninput="onFilterChange('${f.field}','label',this.value)">
        <input placeholder="field" value="${escapeHtml(f.field)}" oninput="onFilterRenameField('${f.field}', this.value)">
        <select onchange="onFilterChange('${f.field}','type',this.value)">
          <option value="select" ${f.type==='select'?'selected':''}>select</option>
          <option value="range" ${f.type==='range'?'selected':''}>range</option>
          <option value="text" ${f.type==='text'?'selected':''}>text</option>
          <option value="number" ${f.type==='number'?'selected':''}>number</option>
        </select>
        ${f.type==='select'?`
          <button class="btn" onclick="openOptions('${f.field}')">–ó–Ω–∞—á–µ–Ω–∏—è</button>
          <button class="btn secondary" onclick="openRules('${f.field}')">–°–≤—è–∑–∏</button>
        `:''}
        <select onchange="moveFilterToGroup('${f.field}', this.value)">
          ${data.groups.map(gr=>`<option value="${gr.id}" ${gr.id===g.id?'selected':''}>${escapeHtml(gr.name)}</option>`).join('')}
        </select>
        <button class="btn ghost" onclick="removeFilter('${f.field}')">‚úñ</button>
      `;
      list.appendChild(chip);
    });

    Sortable.create(list,{animation:150,group:{name:"filters_dnd",pull:true,put:true},onEnd:e=>{
      const fromId=+e.from.dataset.group, toId=+e.to.dataset.group;
      const from=data.groups.find(x=>x.id===fromId);
      const to=data.groups.find(x=>x.id===toId);
      const moved=from.filters.splice(e.oldIndex,1)[0];
      to.filters.splice(e.newIndex,0,moved);
      save(); renderGroups(); renderPreview();
    }});
  });
}

function deleteGroup(gi){
  const id=data.groups[gi].id; const fields=data.groups[gi].filters;
  if(data.groups.length>1){
    const dest=(gi===0?1:0);
    data.groups[dest].filters.push(...fields);
    data.groups.splice(gi,1);
  }else{
    data.groups[gi].filters=[];
  }
  save(); renderGroups(); renderPreview();
}

function onFilterChange(field,key,val){
  const f=byField(field); if(!f) return;
  f[key]=val; save();
  if(key==='type') renderGroups();
  renderFiltersTable(); renderPreview();
}
function onFilterRenameField(oldField,newField){
  if(!newField || oldField===newField) return;
  if(byField(newField)){ alert("–¢–∞–∫–æ–π field —É–∂–µ –µ—Å—Ç—å"); return; }
  const f=byField(oldField); f.field=newField;
  data.groups.forEach(g=>g.filters=g.filters.map(x=>x===oldField?newField:x));
  save(); renderGroups(); renderFiltersTable(); renderPreview();
}
function moveFilterToGroup(field, groupId){
  groupId=+groupId;
  data.groups.forEach(g=>g.filters=g.filters.filter(x=>x!==field));
  const target=data.groups.find(x=>x.id===groupId);
  target.filters.push(field);
  save(); renderGroups(); renderPreview();
}
function removeFilter(field){
  data.groups.forEach(g=>g.filters=g.filters.filter(x=>x!==field));
  data.filters = data.filters.filter(f=>f.field!==field);
  delete previewState[field];
  save(); renderGroups(); renderFiltersTable(); renderPreview();
}
/* ===== —Ç–∞–±–ª–∏—Ü–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–Ω–∏–∂–µ) ===== */
function renderFiltersTable(){
  const box=document.getElementById("filtersTable"); box.innerHTML="";
  data.filters.forEach(f=>{
    const row=document.createElement("div"); row.className="item";
    row.innerHTML=`
      <div class="grow"><b>${escapeHtml(f.label)}</b> <span style="opacity:.8">(${escapeHtml(f.field)})</span></div>
      <div>—Ç–∏–ø: ${f.type}</div>
      ${f.type==='select'?`<button class="btn" onclick="openOptions('${f.field}')">–ó–Ω–∞—á–µ–Ω–∏—è</button>
      <button class="btn secondary" onclick="openRules('${f.field}')">–°–≤—è–∑–∏</button>`:''}
    `;
    box.appendChild(row);
  });
}

/* ===== –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Å–≤—è–∑–∏ ===== */
function openOptions(field){
  const f=byField(field);
  openModal(`–ó–Ω–∞—á–µ–Ω–∏—è: ${f.label}`, `
    <p>–í–≤–µ–¥–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:</p>
    <textarea id="optArea">${(f.options||[]).join(", ")}</textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="saveOptions('${field}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  `);
}
function saveOptions(field){
  const f=byField(field);
  const val=document.getElementById("optArea").value;
  f.options = val.split(",").map(s=>s.trim()).filter(Boolean);
  save(); closeModal(); renderPreview();
}

/*
  –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª–∞:
  –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞:
    –ü—É—Ç—å = –∑–Ω–∞—á–µ–Ω–∏—è
  –≥–¥–µ –ü—É—Ç—å ‚Äî —Ü–µ–ø–æ—á–∫–∞ ¬´–ú–µ—Ç–∫–∞1 > –ó–Ω–∞—á–µ–Ω–∏–µ1 > ...¬ª
*/
function openRules(field){
  const f=byField(field);
  const lines=(f.rules||[]).map(r=>`${r.path.join(" > ")} = ${(r.options||[]).join(", ")}`).join("\n");
  openModal(`–°–≤—è–∑–∏ (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ): ${f.label}`, `
    <p>–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ. –ü—É—Ç—å —Å–ª–µ–≤–∞, –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–ø—Ä–∞–≤–∞.</p>
    <p class="hint">–ü—Ä–∏–º–µ—Ä—ã:<br>
    –ö–∞—Ç–µ–≥–æ—Ä–∏—è > –ö–≤–∞—Ä—Ç–∏—Ä–∞ = –ü—Ä–æ–¥–∞–∂–∞, –ê—Ä–µ–Ω–¥–∞, –û–±–º–µ–Ω<br>
    –ö–∞—Ç–µ–≥–æ—Ä–∏—è > –ö–≤–∞—Ä—Ç–∏—Ä–∞ > –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è > –ü—Ä–æ–¥–∞–∂–∞ = –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞, –í—Ç–æ—Ä–∏—á–∫–∞</p>
    <textarea id="rulesArea">${lines}</textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="saveRules('${field}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  `);
}
function saveRules(field){
  const f=byField(field);
  const txt=document.getElementById("rulesArea").value;
  f.rules=[];
  txt.split("\n").forEach(line=>{
    if(!line.trim()) return;
    const parts=line.split("=");
    if(parts.length<2) return;
    const left=parts[0].trim();
    const right=parts[1].trim();
    const path=left.split(">").map(s=>s.trim()).filter(Boolean);
    const options=right.split(",").map(s=>s.trim()).filter(Boolean);
    if(path.length && options.length) f.rules.push({path, options});
  });
  save(); closeModal(); renderPreview();
}
/* ===== –ü–û–õ–Ø ===== */
function addField(){
  data.fields.push({label:"–ü–æ–ª–µ",id:"id_"+Date.now(),type:"text"});
  save(); renderFields(); renderPreview();
}
function renderFields(){
  const list=document.getElementById("fieldsList"); list.innerHTML="";
  data.fields.forEach((f,i)=>{
    const row=document.createElement("div"); row.className="item";
    row.innerHTML=`
      <input class="grow" placeholder="–ú–µ—Ç–∫–∞" value="${escapeHtml(f.label||"")}" oninput="data.fields[${i}].label=this.value;save();renderPreview()">
      <input placeholder="id" value="${escapeHtml(f.id||"")}" oninput="data.fields[${i}].id=this.value;save();renderPreview()">
      <select onchange="data.fields[${i}].type=this.value;save();renderPreview()">
        <option value="text" ${f.type==='text'?'selected':''}>text</option>
        <option value="number" ${f.type==='number'?'selected':''}>number</option>
        <option value="select" ${f.type==='select'?'selected':''}>select</option>
        <option value="textarea" ${f.type==='textarea'?'selected':''}>textarea</option>
      </select>
      <button class="btn ghost" onclick="data.fields.splice(${i},1);save();renderFields();renderPreview()">‚úñ</button>
    `;
    list.appendChild(row);
  });
  Sortable.create(list,{animation:150,onEnd:e=>{
    const moved=data.fields.splice(e.oldIndex,1)[0];
    data.fields.splice(e.newIndex,0,moved); save(); renderPreview();
  }});
}

/* ===== –ú–ê–ö–ï–¢ ===== */
const canvas=document.getElementById("canvas");
function addBlock(type){
  data.layout.push({id:Date.now(),type,x:1,y:1,w:4,h:2});
  save(); renderLayout(); renderPreview();
}
function renderLayout(){
  canvas.innerHTML="";
  data.layout.forEach((b,idx)=>{
    const el=document.createElement("div"); el.className="block";
    el.style.gridColumn=`${b.x}/span ${b.w}`; el.style.gridRow=`${b.y}/span ${b.h}`;
    el.innerHTML=`${labelByType(b.type)}<div class="resize"></div><button class="close" onclick="removeBlock(${idx})">√ó</button>`;
    canvas.appendChild(el);
  });
}
function removeBlock(i){ data.layout.splice(i,1); save(); renderLayout(); renderPreview(); }

function labelByType(t){return {filters:"–§–∏–ª—å—Ç—Ä—ã",map:"–ö–∞—Ä—Ç–∞",form:"–§–æ—Ä–º–∞",cards:"–°–ø–∏—Å–æ–∫",table:"–¢–∞–±–ª–∏—Ü–∞",banner:"–†–µ–∫–ª–∞–º–∞"}[t]||t}

/* ===== –ü–†–ï–î–ü–†–û–°–ú–û–¢–† ===== */
function renderPreview(){
  const box=document.getElementById("preview"); box.innerHTML="";
  data.layout.forEach(b=>{
    const el=document.createElement("div"); el.className="preview-block";
    el.style.gridColumn=`${b.x}/span ${b.w}`; el.style.gridRow=`${b.y}/span ${b.h}`;
    el.textContent=labelByType(b.type);
    box.appendChild(el);
  });
}

/* ===== –ú–û–î–ê–õ–ö–ò ===== */
function openModal(title, bodyHtml){
  const m=document.getElementById("modal");
  document.getElementById("modalTitle").textContent=title;
  document.getElementById("modalBody").innerHTML=bodyHtml;
  m.style.display="flex";
}
function closeModal(){document.getElementById("modal").style.display="none"}

/* ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –í–°–ï–ì–û ===== */
function renderAll(){
  renderGroups();
  renderFiltersTable();
  renderFields();
  renderLayout();
  renderPreview();
}
renderAll();
</script>
</body>
</html>
