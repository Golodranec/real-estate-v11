<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — каскадные фильтры</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
body{margin:0;background:#0f1115;color:#e6e6e6;font:14px system-ui}
header{padding:10px;background:#161a22;display:flex;gap:10px}
button{padding:6px 12px;border-radius:6px;border:none;cursor:pointer}
.btn{background:#5b9cff;color:#fff}
.draggable-item{display:flex;gap:6px;align-items:center;margin-bottom:6px;padding:6px;background:#1f2530;border:1px solid #2a3140;border-radius:6px}
input,select{padding:4px;background:#111722;border:1px solid #333;border-radius:4px;color:#fff}
.field{margin-bottom:6px}
.field label{display:block;font-size:12px;color:#ccc}
.field input,.field select{width:100%;padding:6px;background:#111722;border:1px solid #333;border-radius:4px;color:#fff}
.preview-grid{display:grid;grid-template-columns:1fr;gap:6px;padding:10px}
.preview-block{background:#1a202c;padding:8px;border-radius:6px}
</style>
</head>
<body>
<header>
  <button class="btn" onclick="addFilter()">Добавить фильтр</button>
  <button class="btn" onclick="reset()">Сброс</button>
</header>

<main style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px">
  <section>
    <h3>Фильтры</h3>
    <div id="filtersList"></div>
  </section>
  <section>
    <h3>Предпросмотр</h3>
    <div id="preview" class="preview-grid"></div>
  </section>
</main>

<script>
const KEY="admin-linked";
let data = load() || {filtersConfig:[
  {label:"Категория",field:"category",type:"select",options:["Квартира","Дом","Коммерция"]},
  {label:"Подкатегория",field:"subCategory",type:"select-linked",parent:"category",
   options:{
     "Квартира":["Продажа","Аренда"],
     "Дом":["Продажа","Аренда"],
     "Коммерция":["Офис","Склад","Магазин"]
   }},
  {label:"Тип сделки",field:"dealType",type:"select-linked",parent:"subCategory",
   options:{
     "Продажа":["Новострой","Вторичка"],
     "Аренда":["Посуточно","Долгосрочно"]
   }}
]};
function save(){localStorage.setItem(KEY,JSON.stringify(data))}
function load(){try{return JSON.parse(localStorage.getItem(KEY)||"")}catch(e){return null}}
function reset(){localStorage.removeItem(KEY);location.reload()}

function addFilter(){
  data.filtersConfig.push({label:"Новый фильтр",field:"field",type:"select"});save();renderFilters();renderPreview();
}

function renderFilters(){
  const list=document.getElementById("filtersList");list.innerHTML="";
  data.filtersConfig.forEach((f,i)=>{
    const div=document.createElement("div");div.className="draggable-item";
    div.innerHTML=`
      <input value="${f.label}" oninput="data.filtersConfig[${i}].label=this.value;save();renderPreview()">
      <input value="${f.field}" oninput="data.filtersConfig[${i}].field=this.value;save();renderPreview()">
      <select onchange="data.filtersConfig[${i}].type=this.value;save();renderFilters();renderPreview()">
        <option value="select" ${f.type==='select'?'selected':''}>select</option>
        <option value="range" ${f.type==='range'?'selected':''}>range</option>
        <option value="text" ${f.type==='text'?'selected':''}>text</option>
        <option value="select-linked" ${f.type==='select-linked'?'selected':''}>select-linked</option>
      </select>
      <button onclick="data.filtersConfig.splice(${i},1);save();renderFilters();renderPreview()">✖</button>`;
    list.appendChild(div);
  });
  Sortable.create(list,{animation:150,onEnd:evt=>{
    const moved=data.filtersConfig.splice(evt.oldIndex,1)[0];
    data.filtersConfig.splice(evt.newIndex,0,moved);save();renderPreview();
  }});
}

function renderPreview(){
  const preview=document.getElementById("preview");preview.innerHTML="";
  const state={};
  data.filtersConfig.forEach(f=>{
    if(f.type==="select"){
      let sel=document.createElement("select");
      sel.innerHTML="<option>—</option>"+(f.options||[]).map(o=>`<option>${o}</option>`).join("");
      sel.onchange=()=>{state[f.field]=sel.value;renderPreview()};
      let wrap=document.createElement("div");wrap.className="field";
      wrap.innerHTML=`<label>${f.label}</label>`;wrap.appendChild(sel);
      preview.appendChild(wrap);
    }
    if(f.type==="select-linked"){
      const parentVal=state[f.parent];
      if(parentVal && f.options[parentVal]){
        let sel=document.createElement("select");
        sel.innerHTML="<option>—</option>"+f.options[parentVal].map(o=>`<option>${o}</option>`).join("");
        sel.onchange=()=>{state[f.field]=sel.value;renderPreview()};
        let wrap=document.createElement("div");wrap.className="field";
        wrap.innerHTML=`<label>${f.label}</label>`;wrap.appendChild(sel);
        preview.appendChild(wrap);
      }
    }
    if(f.type==="range"){
      let wrap=document.createElement("div");wrap.className="field";
      wrap.innerHTML=`<label>${f.label}</label><input placeholder="от"><input placeholder="до">`;
      preview.appendChild(wrap);
    }
    if(f.type==="text"){
      let wrap=document.createElement("div");wrap.className="field";
      wrap.innerHTML=`<label>${f.label}</label><input placeholder="${f.field}">`;
      preview.appendChild(wrap);
    }
  });
}
renderFilters();renderPreview();
</script>
</body>
</html>
