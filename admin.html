<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin v13.9.5 — Фильтры • Поля • Макет • Форма объектов • Предпросмотр</title>
<style>
  :root{
    --bg:#0f1115; --card:#161a22; --line:#242938; --text:#e8eaf0;
    --blue:#4da3ff; --chip:#242938; --green:#4dff91; --red:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;background:var(--card);padding:12px 16px;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:18px}
  .version-badge{position:fixed;right:10px;top:10px;background:var(--chip);border:1px solid var(--line);padding:4px 8px;border-radius:8px;font-size:12px;opacity:.9}
  a,button{cursor:pointer}
  .tabs{display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--line);background:linear-gradient(0deg,transparent,rgba(255,255,255,.02))}
  .tab{padding:8px 10px;border:1px solid var(--line);border-bottom:none;border-radius:8px 8px 0 0;background:var(--card);opacity:.75}
  .tab.active{opacity:1;border-color:var(--blue)}
  .container{padding:16px;display:grid;gap:16px;grid-template-columns:1fr}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  .card h2{margin:0 0 10px;font-size:16px}
  input,select,button,textarea{padding:8px;border-radius:8px;border:1px solid var(--line);background:#0d1016;color:var(--text)}
  .btn{background:var(--blue);border:1px solid var(--blue);color:#001428;font-weight:600}
  .ghost{background:transparent;border:1px solid var(--blue);color:var(--blue)}
  .danger{background:transparent;border:1px solid var(--red);color:var(--red)}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
  .row{display:flex;align-items:center;gap:8px}
  .hint{font-size:12px;opacity:.8}
  .ok{color:var(--green)} .bad{color:var(--red)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .th,.td{padding:8px;border:1px solid var(--line);background:#0d1016;vertical-align:top}
  .th{background:#0f141d;font-weight:600}
  .td:first-child,.th:first-child{border-radius:8px 0 0 8px}
  .td:last-child,.th:last-child{border-radius:0 8px 8px 0}
  .drag-handle{cursor:grab;user-select:none}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:var(--chip);font-size:12px}
  .preview-box{display:flex;flex-wrap:wrap;gap:10px}
  .field{display:flex;flex-direction:column;gap:6px;min-width:200px}
  .field label{font-size:13px;opacity:.85}
  .field .inline{display:flex;gap:8px;flex-wrap:wrap}
  .divider{height:1px;background:var(--line);margin:10px 0}
  .sticky-footer{position:sticky;bottom:0;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:8px;display:flex;justify-content:space-between;align-items:center}
  .muted{opacity:.7}
  .badge{display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:6px;background:var(--chip);font-size:12px}
  .list{display:grid;gap:8px}
  .k-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid var(--line);border-radius:8px;padding:8px;background:#0d1016}
</style>
</head>
<body>
  <header>
    <h1>Админка — фильтры, поля, макет, форма объектов</h1>
    <div class="row">
      <span id="syncInfo" class="pill">Синхронизация: <span id="syncState" class="ok">OK</span></span>
    </div>
  </header>
  <div class="version-badge">admin v13.9.5</div>

  <nav class="tabs">
    <button class="tab active" data-tab="filters">Фильтры</button>
    <button class="tab" data-tab="fields">Поля</button>
    <button class="tab" data-tab="layout">Макет</button>
    <button class="tab" data-tab="objform">Форма объектов</button>
    <button class="tab" data-tab="preview">Предпросмотр</button>
    <button class="tab" data-tab="data">Экспорт/импорт</button>
    <span class="pill">Хранилище: localStorage</span>
  </nav>

  <main class="container">
    <!-- ФИЛЬТРЫ -->
    <section id="tab-filters" class="card">
      <h2>Фильтры: nodeTypes, treeNodes, extraParams</h2>
      <div class="grid cols-2">
        <div class="card">
          <h3>Типы узлов (nodeTypes)</h3>
          <div class="toolbar">
            <input id="ntInput" placeholder="например: Категория" />
            <button class="btn" id="ntAdd">Добавить</button>
            <button class="ghost" id="ntReset">Сбросить</button>
          </div>
          <div class="divider"></div>
          <div id="ntList" class="list"></div>
        </div>

        <div class="card">
          <h3>Дерево (treeNodes)</h3>
          <div class="toolbar">
            <input id="tnName" placeholder="Название узла" />
            <select id="tnType"></select>
            <input id="tnOrder" type="number" placeholder="order" style="width:110px" />
            <button class="btn" id="tnAdd">Добавить узел</button>
            <button class="ghost" id="tnReset">Сбросить</button>
          </div>
          <div class="divider"></div>
          <table class="table" id="tnTable">
            <thead>
              <tr>
                <th class="th" style="width:68px">ID</th>
                <th class="th">Название</th>
                <th class="th">Тип</th>
                <th class="th" style="width:80px">order</th>
                <th class="th" style="width:120px">Действия</th>
              </tr>
            </thead>
            <tbody id="tnBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Доп. параметры (extraParams)</h3>
        <div class="toolbar">
          <input id="epName" placeholder="Название параметра (например: Ремонт)" />
          <select id="epCategory"></select>
          <input id="epValues" placeholder="Значения через ;  (например: евро;косметический;черновой)" />
          <button class="btn" id="epAdd">Добавить параметр</button>
          <button class="ghost" id="epReset">Сбросить</button>
        </div>
        <div class="divider"></div>
        <table class="table" id="epTable">
          <thead>
            <tr>
              <th class="th" style="width:68px">ID</th>
              <th class="th">Параметр</th>
              <th class="th">Категория (nodeId)</th>
              <th class="th">Значения</th>
              <th class="th" style="width:120px">Действия</th>
            </tr>
          </thead>
          <tbody id="epBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ПОЛЯ (простая справка + резерв под будущее расширение) -->
    <section id="tab-fields" class="card" hidden>
      <h2>Поля (справочник)</h2>
      <p class="hint">Этот раздел оставлен как контекст к твоей исходной админке. Здесь можно хранить справочные поля или подсказки для макета и формы.</p>
      <div class="k-row">
        <div>Например, подсказки по обязательным полям, шаблоны меток, стандартные диапазоны значений.</div>
        <span class="badge">OK</span>
      </div>
    </section>

    <!-- МАКЕТ -->
    <section id="tab-layout" class="card" hidden>
      <h2>Макет (layoutConfig)</h2>
      <div class="toolbar">
        <button class="btn" id="layoutAddRow">Добавить строку</button>
        <button class="ghost" id="layoutReset">Сбросить</button>
      </div>
      <div class="divider"></div>
      <div id="layoutList" class="list"></div>
      <div class="sticky-footer">
        <span class="hint">Макет хранится в <b>layoutConfig</b>. Можно использовать для расположения виджетов на фронте.</span>
        <button class="ghost" id="layoutExport">Экспорт макета</button>
      </div>
    </section>

    <!-- ФОРМА ОБЪЕКТОВ (новая вкладка) -->
    <section id="tab-objform" class="card" hidden>
      <h2>Форма объектов — включение, порядок, подписи</h2>
      <div class="toolbar">
        <button class="btn" id="ofAddField">Добавить поле</button>
        <button class="ghost" id="ofResetDefaults">Сбросить к стандартным</button>
      </div>
      <div class="divider"></div>
      <table class="table" id="ofTable">
        <thead>
          <tr>
            <th class="th" style="width:34px;">⇅</th>
            <th class="th" style="width:90px;">Вкл</th>
            <th class="th">Ключ</th>
            <th class="th">Метка</th>
            <th class="th" style="width:150px;">Тип</th>
            <th class="th" style="width:110px;">Обяз.</th>
            <th class="th">Значения (select/range)</th>
            <th class="th" style="width:120px;">Действия</th>
          </tr>
        </thead>
        <tbody id="ofBody"></tbody>
      </table>
      <div class="sticky-footer">
        <span class="hint">Настройки сохраняются в <b>objectFormConfig</b>.</span>
        <div class="row">
          <button class="ghost" id="ofExport">Экспорт JSON</button>
          <label class="pill" style="cursor:pointer;">
            Импорт JSON
            <input type="file" id="ofImport" accept=".json" style="display:none">
          </label>
        </div>
      </div>
    </section>

    <!-- ПРЕДПРОСМОТР -->
    <section id="tab-preview" class="card" hidden>
      <h2>Предпросмотр формы «Добавить объект»</h2>
      <div id="previewBox" class="preview-box"></div>
      <div class="divider"></div>
      <p class="hint">На фронте (index.html) форма будет рендериться из <b>objectFormConfig</b> точно так же.</p>
    </section>

    <!-- ДАННЫЕ -->
    <section id="tab-data" class="card" hidden>
      <h2>Экспорт/импорт всего</h2>
      <div class="row" style="flex-wrap:wrap;gap:10px">
        <button class="btn" id="exportAll">Экспорт всего (JSON)</button>
        <label class="pill" style="cursor:pointer;">
          Импорт всего (JSON)
          <input type="file" id="importAll" accept=".json" style="display:none">
        </label>
      </div>
      <p class="hint">Включает: nodeTypes, treeNodes, extraParams, layoutConfig, objectFormConfig.</p>
    </section>
  </main>

<script>
/* ===============================
   Admin v13.9.5 — Data & Helpers
   =============================== */
const LS_NODE_TYPES = "nodeTypes";
const LS_TREE_NODES = "treeNodes";
const LS_EXTRA_PARAMS = "extraParams";
const LS_LAYOUT = "layoutConfig";
const LS_FORM = "objectFormConfig";

const $ = id => document.getElementById(id);
const escapeHtml = (s="") => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function load(key, def){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }catch{ return def; } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function uid(){ return Date.now() + Math.floor(Math.random()*1000); }
function triggerDownload(url, filename){ const a=document.createElement("a"); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); }
function splitValueLabel(s){ const i=s.indexOf(":"); return i===-1 ? [s,s] : [s.slice(0,i), s.slice(i+1)]; }

/* ===============================
   Tabs
   =============================== */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.dataset.tab;
    document.querySelectorAll("main section").forEach(s=>s.hidden = true);
    $("tab-"+id).hidden = false;
    if (id === "preview") renderPreview();
  });
});

/* ===============================
   NodeTypes
   =============================== */
let nodeTypes = load(LS_NODE_TYPES, []);
function renderNodeTypes(){
  const box = $("ntList"); box.innerHTML="";
  nodeTypes.forEach((t,i)=>{
    const row = document.createElement("div");
    row.className="k-row";
    row.innerHTML = `
      <div><b>${escapeHtml(t)}</b></div>
      <div class="row">
        <button class="ghost" data-i="${i}" data-act="up">↑</button>
        <button class="ghost" data-i="${i}" data-act="down">↓</button>
        <button class="danger" data-i="${i}" data-act="del">Удалить</button>
      </div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("button").forEach(b=>{
    b.onclick = () => {
      const i = +b.dataset.i, act = b.dataset.act;
      if (act==="del"){ nodeTypes.splice(i,1); }
      if (act==="up" && i>0){ [nodeTypes[i-1],nodeTypes[i]]=[nodeTypes[i],nodeTypes[i-1]]; }
      if (act==="down" && i<nodeTypes.length-1){ [nodeTypes[i+1],nodeTypes[i]]=[nodeTypes[i],nodeTypes[i+1]]; }
      save(LS_NODE_TYPES,nodeTypes); renderNodeTypes(); renderTreeNodesTypeSelects();
    };
  });
}
$("ntAdd").onclick = () => {
  const v = $("ntInput").value.trim(); if (!v) return;
  nodeTypes.push(v); $("ntInput").value="";
  save(LS_NODE_TYPES,nodeTypes); renderNodeTypes(); renderTreeNodesTypeSelects();
};
$("ntReset").onclick = () => {
  if (!confirm("Сбросить типы?")) return;
  nodeTypes = []; save(LS_NODE_TYPES,nodeTypes); renderNodeTypes(); renderTreeNodesTypeSelects();
};

/* ===============================
   TreeNodes
   =============================== */
let treeNodes = load(LS_TREE_NODES, []); // [{id,name,type,order}]
function renderTreeNodesTypeSelects(){
  const sel = $("tnType"); sel.innerHTML = nodeTypes.map(t=>`<option>${escapeHtml(t)}</option>`).join("");
  const epCat = $("epCategory"); epCat.innerHTML = treeNodes.map(n=>`<option value="${n.id}">${n.id} — ${escapeHtml(n.name)}</option>`).join("");
}
function renderTreeNodes(){
  const body = $("tnBody"); body.innerHTML="";
  treeNodes
    .slice()
    .sort((a,b)=>(a.order||0)-(b.order||0))
    .forEach(n=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="td"><code>${n.id}</code></td>
        <td class="td"><input data-id="${n.id}" data-k="name" value="${escapeHtml(n.name)}" style="width:100%"></td>
        <td class="td"><select data-id="${n.id}" data-k="type">${nodeTypes.map(t=>`<option ${n.type===t?"selected":""}>${escapeHtml(t)}</option>`).join("")}</select></td>
        <td class="td"><input type="number" data-id="${n.id}" data-k="order" value="${n.order||0}" style="width:100%"></td>
        <td class="td" style="text-align:center">
          <button class="danger" data-id="${n.id}" data-act="del">Удалить</button>
        </td>
      `;
      body.appendChild(tr);
    });
  body.querySelectorAll("input,select,button").forEach(el=>{
    el.onchange = () => {
      const id = +el.dataset.id; const k = el.dataset.k; const act = el.dataset.act;
      const ix = treeNodes.findIndex(x=>x.id===id); if (ix===-1) return;
      if (act==="del"){ treeNodes.splice(ix,1); save(LS_TREE_NODES,treeNodes); renderTreeNodes(); renderTreeNodesTypeSelects(); return; }
      if (k==="name") treeNodes[ix].name = el.value;
      if (k==="type") treeNodes[ix].type = el.value;
      if (k==="order") treeNodes[ix].order = isFinite(+el.value)?+el.value:0;
      save(LS_TREE_NODES,treeNodes); renderTreeNodes(); renderTreeNodesTypeSelects();
    };
  });
}
$("tnAdd").onclick = () => {
  const name = $("tnName").value.trim(); if (!name) return;
  const type = $("tnType").value || (nodeTypes[0]||"Тип");
  const order = isFinite(+$("tnOrder").value)? +$("tnOrder").value : 0;
  treeNodes.push({ id: uid(), name, type, order });
  $("tnName").value=""; $("tnOrder").value="";
  save(LS_TREE_NODES,treeNodes); renderTreeNodes(); renderTreeNodesTypeSelects();
};
$("tnReset").onclick = () => {
  if (!confirm("Сбросить дерево?")) return;
  treeNodes = []; save(LS_TREE_NODES,treeNodes); renderTreeNodes(); renderTreeNodesTypeSelects();
};

/* ===============================
   extraParams
   =============================== */
let extraParams = load(LS_EXTRA_PARAMS, []); // [{id,name,categoryId,values[]}]
function renderExtraParams(){
  const body = $("epBody"); body.innerHTML="";
  extraParams.forEach(p=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="td"><code>${p.id}</code></td>
      <td class="td"><input data-id="${p.id}" data-k="name" value="${escapeHtml(p.name)}" style="width:100%"></td>
      <td class="td"><input data-id="${p.id}" data-k="categoryId" value="${p.categoryId}" style="width:100%"></td>
      <td class="td"><input data-id="${p.id}" data-k="values" value="${escapeHtml((p.values||[]).join(';'))}" style="width:100%"></td>
      <td class="td" style="text-align:center"><button class="danger" data-id="${p.id}" data-act="del">Удалить</button></td>
    `;
    body.appendChild(tr);
  });
  body.querySelectorAll("input,button").forEach(el=>{
    el.onchange = () => {
      const id = +el.dataset.id; const k = el.dataset.k; const act = el.dataset.act;
      const ix = extraParams.findIndex(x=>x.id===id); if (ix===-1) return;
      if (act==="del"){ extraParams.splice(ix,1); save(LS_EXTRA_PARAMS,extraParams); renderExtraParams(); return; }
      if (k==="name") extraParams[ix].name = el.value;
      if (k==="categoryId") extraParams[ix].categoryId = isFinite(+el.value)?+el.value:el.value;
      if (k==="values") extraParams[ix].values = (el.value||"").split(";").map(s=>s.trim()).filter(Boolean);
      save(LS_EXTRA_PARAMS,extraParams); renderExtraParams();
    };
  });
}
$("epAdd").onclick = () => {
  const name = $("epName").value.trim(); if (!name) return;
  const cat = +$("epCategory").value || null;
  const values = ($("epValues").value||"").split(";").map(s=>s.trim()).filter(Boolean);
  extraParams.push({ id: uid(), name, categoryId: cat, values });
  $("epName").value=""; $("epValues").value="";
  save(LS_EXTRA_PARAMS,extraParams); renderExtraParams();
};
$("epReset").onclick = () => {
  if (!confirm("Сбросить параметры?")) return;
  extraParams = []; save(LS_EXTRA_PARAMS,extraParams); renderExtraParams();
};

/* ===============================
   Layout
   =============================== */
let layoutConfig = load(LS_LAYOUT, []); // [{id,title,widgets:[{type,ref}] }]
function renderLayout(){
  const box = $("layoutList"); box.innerHTML = "";
  layoutConfig.forEach((row,i)=>{
    const el = document.createElement("div");
    el.className = "k-row";
    el.innerHTML = `
      <div>
        <div class="row" style="gap:6px">
          <input data-i="${i}" data-k="title" value="${escapeHtml(row.title||('Строка '+(i+1)))}" />
          <span class="badge">виджетов: ${(row.widgets||[]).length}</span>
        </div>
        <div class="row" style="margin-top:6px;gap:6px">
          <select data-i="${i}" data-k="wtype">
            <option value="filters">filters</option>
            <option value="map">map</option>
            <option value="results">results</option>
            <option value="form">form</option>
          </select>
          <input data-i="${i}" data-k="wref" placeholder="ref/id (опц.)" />
          <button class="ghost" data-i="${i}" data-act="addw">+ виджет</button>
        </div>
        <div id="wlist-${i}" class="list" style="margin-top:8px"></div>
      </div>
      <div class="row">
        <button class="ghost" data-i="${i}" data-act="up">↑</button>
        <button class="ghost" data-i="${i}" data-act="down">↓</button>
        <button class="danger" data-i="${i}" data-act="del">Удалить</button>
      </div>
    `;
    box.appendChild(el);

    // виджеты списка
    const wl = $("wlist-"+i);
    (row.widgets||[]).forEach((w,j)=>{
      const wrow = document.createElement("div");
      wrow.className = "k-row";
      wrow.innerHTML = `
        <div><b>${escapeHtml(w.type)}</b> <span class="hint">${escapeHtml(w.ref||"")}</span></div>
        <div class="row">
          <button class="ghost" data-i="${i}" data-j="${j}" data-act="wup">↑</button>
          <button class="ghost" data-i="${i}" data-j="${j}" data-act="wdown">↓</button>
          <button class="danger" data-i="${i}" data-j="${j}" data-act="wdel">Удалить</button>
        </div>
      `;
      wl.appendChild(wrow);
    });
  });

  // handlers
  box.querySelectorAll("input,select,button").forEach(el=>{
    el.onclick = el.onchange = () => {
      const i = +el.dataset.i, j = el.dataset.j!==undefined? +el.dataset.j : null;
      const k = el.dataset.k, act = el.dataset.act;
      if (act==="del"){ layoutConfig.splice(i,1); save(LS_LAYOUT,layoutConfig); renderLayout(); return;}
      if (act==="up" && i>0){ [layoutConfig[i-1],layoutConfig[i]]=[layoutConfig[i],layoutConfig[i-1]]; save(LS_LAYOUT,layoutConfig); renderLayout(); return;}
      if (act==="down" && i<layoutConfig.length-1){ [layoutConfig[i+1],layoutConfig[i]]=[layoutConfig[i],layoutConfig[i+1]]; save(LS_LAYOUT,layoutConfig); renderLayout(); return;}
      if (act==="addw"){
        const type = document.querySelector(`select[data-i="${i}"][data-k="wtype"]`).value;
        const ref  = document.querySelector(`input[data-i="${i}"][data-k="wref"]`).value.trim();
        layoutConfig[i].widgets = layoutConfig[i].widgets||[];
        layoutConfig[i].widgets.push({type,ref}); save(LS_LAYOUT,layoutConfig); renderLayout(); return;
      }
      if (act==="wdel"){ layoutConfig[i].widgets.splice(j,1); save(LS_LAYOUT,layoutConfig); renderLayout(); return;}
      if (act==="wup" && j>0){ const ws=layoutConfig[i].widgets; [ws[j-1],ws[j]]=[ws[j],ws[j-1]]; save(LS_LAYOUT,layoutConfig); renderLayout(); return;}
      if (act==="wdown" && j<layoutConfig[i].widgets.length-1){ const ws=layoutConfig[i].widgets; [ws[j+1],ws[j]]=[ws[j],ws[j+1]]; save(LS_LAYOUT,layoutConfig); renderLayout(); return;}
      if (k==="title"){ layoutConfig[i].title = el.value; save(LS_LAYOUT,layoutConfig); }
    };
  });
}
$("layoutAddRow").onclick = ()=>{ layoutConfig.push({id:uid(), title:"Строка", widgets:[]}); save(LS_LAYOUT,layoutConfig); renderLayout(); };
$("layoutReset").onclick = ()=>{ if(confirm("Сбросить макет?")){ layoutConfig=[]; save(LS_LAYOUT,layoutConfig); renderLayout(); } };
$("layoutExport").onclick = ()=>{ const blob=new Blob([JSON.stringify(layoutConfig,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); triggerDownload(url,"layoutConfig.json"); };

/* ===============================
   Object Form (constructor)
   =============================== */
const DEFAULT_FORM_FIELDS = [
  { key:"title",   label:"Заголовок",     type:"text",    required:true,  enabled:true },
  { key:"address", label:"Адрес",         type:"text",    required:false, enabled:true },
  { key:"price",   label:"Цена",          type:"number",  required:false, enabled:true },
  { key:"area",    label:"Площадь, м²",   type:"number",  required:false, enabled:false },
  { key:"rooms",   label:"Комнат",        type:"number",  required:false, enabled:false },
  { key:"floor",   label:"Этаж",          type:"number",  required:false, enabled:false },
  { key:"floors",  label:"Этажность",     type:"number",  required:false, enabled:false },
  { key:"year",    label:"Год постройки", type:"number",  required:false, enabled:false },
  { key:"status",  label:"Статус",        type:"select",  required:false, enabled:true, values:["sale:Продается","rent:Сдается","exchange:Обмен"] },
  { key:"images",  label:"Фотографии",    type:"images",  required:false, enabled:true },
  { key:"coords",  label:"Координаты",    type:"coords",  required:false, enabled:true },
  { key:"location",label:"Локация (каскад)", type:"cascade", required:false, enabled:true },
  { key:"params",  label:"Параметры (чекбоксы)", type:"params", required:false, enabled:true }
];
let objectFormConfig = (()=>{
  const raw = load(LS_FORM, null);
  if (!raw) return DEFAULT_FORM_FIELDS.map(f=>({...f}));
  if (!Array.isArray(raw)) return DEFAULT_FORM_FIELDS.map(f=>({...f}));
  return raw.map(f=>({enabled:false,required:false,type:"text",label:f.key,...f}));
})();

function ofValuesToText(f){
  if (!f || !f.type) return "";
  if (f.type==="select" || f.type==="status"){ return (f.values||[]).join(";"); }
  if (f.type==="range"){ const min=f.min??""; const max=f.max??""; const step=f.step??""; return [min,max,step].join(","); }
  return "";
}
function ofTextToValues(type,text){
  if (type==="select"||type==="status"){
    const arr=(text||"").split(";").map(s=>s.trim()).filter(Boolean); return {values:arr};
  }
  if (type==="range"){
    const [min,max,step]=(text||"").split(",").map(s=>s.trim());
    return {min:isFinite(+min)?+min:undefined,max:isFinite(+max)?+max:undefined,step:isFinite(+step)?+step:undefined};
  }
  return {};
}

function renderObjFormTable(){
  const body = $("ofBody"); body.innerHTML="";
  objectFormConfig.forEach((f,idx)=>{
    const tr = document.createElement("tr");
    tr.draggable = true; tr.dataset.index = idx;
    tr.innerHTML = `
      <td class="td" style="text-align:center"><span class="drag-handle">⠿</span></td>
      <td class="td" style="text-align:center"><input type="checkbox" ${f.enabled?"checked":""} data-act="enabled"></td>
      <td class="td"><code>${escapeHtml(f.key)}</code></td>
      <td class="td"><input data-act="label" value="${escapeHtml(f.label||"")}" style="width:100%"></td>
      <td class="td">
        <select data-act="type" style="width:100%">
          ${["text","number","textarea","select","range","images","coords","cascade","params","status"].map(t=>`<option value="${t}" ${f.type===t?"selected":""}>${t}</option>`).join("")}
        </select>
      </td>
      <td class="td" style="text-align:center"><input type="checkbox" ${f.required?"checked":""} data-act="required"></td>
      <td class="td"><input data-act="values" placeholder="select: value:Label;value2:Label2 | range: min,max,step" value="${escapeHtml(ofValuesToText(f))}" style="width:100%"></td>
      <td class="td" style="text-align:center"><button class="danger" data-act="remove">Удалить</button></td>
    `;
    body.appendChild(tr);
  });

  // drag-n-drop
  body.querySelectorAll("tr").forEach(tr=>{
    tr.addEventListener("dragstart", e=>{ e.dataTransfer.effectAllowed="move"; window.__dragIndex=+tr.dataset.index;});
    tr.addEventListener("dragover", e=>{ e.preventDefault(); e.dataTransfer.dropEffect="move"; });
    tr.addEventListener("drop", e=>{
      e.preventDefault();
      const from = window.__dragIndex, to = +tr.dataset.index;
      if (from===undefined || from===to) return;
      const item = objectFormConfig.splice(from,1)[0];
      objectFormConfig.splice(to,0,item);
      save(LS_FORM,objectFormConfig); renderObjFormTable(); renderPreview();
    });
  });

  // handlers
  body.querySelectorAll("input,select,button").forEach(el=>{
    el.addEventListener("change", onObjFormChange);
    el.addEventListener("click", onObjFormChange);
  });
}
function onObjFormChange(e){
  const tr = e.target.closest("tr"); if (!tr) return;
  const idx = +tr.dataset.index;
  const act = e.target.dataset.act;
  if (act==="enabled"){ objectFormConfig[idx].enabled = e.target.checked; }
  else if (act==="label"){ objectFormConfig[idx].label = e.target.value; }
  else if (act==="type"){ objectFormConfig[idx].type = e.target.value; }
  else if (act==="required"){ objectFormConfig[idx].required = e.target.checked; }
  else if (act==="values"){ objectFormConfig[idx] = {...objectFormConfig[idx], ...ofTextToValues(objectFormConfig[idx].type, e.target.value)}; }
  else if (act==="remove"){ if (confirm("Удалить поле?")) objectFormConfig.splice(idx,1); }
  save(LS_FORM,objectFormConfig); renderObjFormTable(); renderPreview();
}
$("ofAddField").onclick = ()=>{
  const key = prompt("Ключ поля (латиницей):","custom_"+Math.random().toString(36).slice(2,6));
  if (!key) return;
  if (objectFormConfig.some(f=>f.key===key)) return alert("Такой ключ уже есть");
  objectFormConfig.push({key, label:key, type:"text", required:false, enabled:true});
  save(LS_FORM,objectFormConfig); renderObjFormTable(); renderPreview();
};
$("ofResetDefaults").onclick = ()=>{
  if (!confirm("Сбросить конфиг формы к стандартным?")) return;
  objectFormConfig = DEFAULT_FORM_FIELDS.map(f=>({...f}));
  save(LS_FORM,objectFormConfig); renderObjFormTable(); renderPreview();
};
$("ofExport").onclick = ()=>{
  const blob = new Blob([JSON.stringify({objectFormConfig}, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob); triggerDownload(url, "objectFormConfig.json");
};
$("ofImport").addEventListener("change",(e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const j=JSON.parse(fr.result);
      objectFormConfig = Array.isArray(j) ? j : (j.objectFormConfig||[]);
      if(!Array.isArray(objectFormConfig)) throw new Error("Формат не распознан");
      save(LS_FORM,objectFormConfig); renderObjFormTable(); renderPreview();
      alert("Импортирована конфигурация формы");
    }catch(err){ alert("Ошибка импорта: "+err.message); }
  };
  fr.readAsText(file); e.target.value="";
});

/* ===============================
   Preview (форма по objectFormConfig)
   =============================== */
function renderPreview(){
  const box = $("previewBox"); box.innerHTML="";
  const act = objectFormConfig.filter(f=>f.enabled);
  const wrap = document.createElement("div");
  wrap.className = "grid cols-3";

  act.forEach(f=>{
    const cell=document.createElement("div"); cell.className="field";
    const label=document.createElement("label"); label.textContent=f.label||f.key;

    let control=document.createElement("input"); control.style.width="100%";
    switch(f.type){
      case "textarea": control=document.createElement("textarea"); control.rows=3; break;
      case "number":
      case "text": control.type=f.type; break;
      case "select":
      case "status":{
        control=document.createElement("select");
        (f.values||[]).forEach(v=>{
          const [value,name]=splitValueLabel(v);
          const opt=document.createElement("option"); opt.value=value; opt.textContent=name||value;
          control.appendChild(opt);
        });
        break;
      }
      case "range":{
        control=document.createElement("div"); control.className="inline";
        const from=document.createElement("input"); from.type="number"; from.placeholder="min";
        const to=document.createElement("input"); to.type="number"; to.placeholder="max";
        control.appendChild(from); control.appendChild(to);
        break;
      }
      case "images":{
        const btn=document.createElement("button"); btn.textContent="Загрузить фото"; btn.className="ghost";
        control=btn; break;
      }
      case "coords":{
        const btn=document.createElement("button"); btn.textContent="Выбрать на карте"; btn.className="ghost";
        control=btn; break;
      }
      case "cascade":{
        control=document.createElement("div"); control.className="inline";
        ["Страна","Город","Район","Категория","Подкатегория"].forEach(ph=>{
          const s=document.createElement("select"); s.innerHTML=`<option>${ph}</option>`; control.appendChild(s);
        });
        break;
      }
      case "params":{
        control=document.createElement("div"); control.className="inline";
        ["Опция 1","Опция 2","Опция 3"].forEach(t=>{
          const lbl=document.createElement("label"); lbl.className="pill";
          lbl.innerHTML=`<input type="checkbox" style="margin-right:6px">${t}`;
          control.appendChild(lbl);
        });
        break;
      }
    }
    cell.appendChild(label); cell.appendChild(control);
    if (f.required){ const r=document.createElement("span"); r.className="hint"; r.textContent="обязательное"; cell.appendChild(r); }
    wrap.appendChild(cell);
  });

  box.appendChild(wrap);
}

/* ===============================
   Export / Import all
   =============================== */
$("exportAll").onclick = ()=>{
  const dump = {
    nodeTypes, treeNodes, extraParams, layoutConfig, objectFormConfig
  };
  const blob=new Blob([JSON.stringify(dump,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); triggerDownload(url,"admin_dump_v13_9_5.json");
};
$("importAll").addEventListener("change",(e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const j=JSON.parse(fr.result);
      nodeTypes = j.nodeTypes||[]; save(LS_NODE_TYPES,nodeTypes);
      treeNodes = j.treeNodes||[]; save(LS_TREE_NODES,treeNodes);
      extraParams = j.extraParams||[]; save(LS_EXTRA_PARAMS,extraParams);
      layoutConfig = j.layoutConfig||[]; save(LS_LAYOUT,layoutConfig);
      objectFormConfig = j.objectFormConfig||DEFAULT_FORM_FIELDS.map(f=>({...f})); save(LS_FORM,objectFormConfig);
      renderNodeTypes(); renderTreeNodes(); renderExtraParams();
      renderLayout(); renderObjFormTable(); renderPreview(); renderTreeNodesTypeSelects();
      alert("Импортирован полный дамп");
    }catch(err){ alert("Ошибка импорта: "+err.message); }
  };
  fr.readAsText(file); e.target.value="";
});

/* ===============================
   Init
   =============================== */
function updateSyncPill(){
  const has = (nodeTypes.length || treeNodes.length || extraParams.length);
  $("syncState").textContent = has ? "OK" : "пусто";
  $("syncState").className = has ? "ok" : "bad";
}

function init(){
  renderNodeTypes(); renderTreeNodes(); renderExtraParams();
  renderTreeNodesTypeSelects();
  renderLayout();
  renderObjFormTable();
  renderPreview();
  updateSyncPill();
}
window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
