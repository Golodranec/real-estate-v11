<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Builder — Cascade Filters v5 FULL WORK (fix)</title>
<style>
:root{
  --bg:#0b0f16;--panel:#121826;--panel2:#172133;--text:#d7e2f2;--muted:#9fb0c8;
  --border:#273248;--accent:#4aa8ff;--danger:#ef4444;--warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;position:sticky;top:0;z-index:10}
.badge{padding:3px 8px;border-radius:8px;background:#6d28d9;font-weight:700}
.tabs{display:flex;gap:8px;margin-left:8px}
.tab{background:#1a2234;border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:#cfe0ff;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{padding:12px;display:grid;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.btn.warn{background:#3a2a0f;border-color:#7c5a10;color:#fde68a}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff;width:100%}
label{display:block;opacity:.9;margin-bottom:6px}
small.muted{color:#9fb0c8}
.list{display:grid;gap:10px}
.card{background:#172133;border:1px solid var(--border);border-radius:10px;padding:10px}
.card .title-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
.card h3{margin:0}
footer{padding:8px 12px;color:#9fb0c8;font-size:12px;border-top:1px solid var(--border)}
/* Canvas + Preview */
.canvas-wrap{border:1px solid var(--border);border-radius:12px;background:#0d121e;padding:6px;overflow:auto;height:62vh}
.canvas,.preview-grid{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px}
.block,.preview-card{background:#111827;border:1px solid #2b3a5a;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;position:relative}
.block header{display:flex;align-items:center;justify-content:space-between;background:#0f172a;color:#dbe8ff;padding:8px 10px;border-bottom:1px solid #2b3a5a;cursor:grab}
.block header:active{cursor:grabbing}
.block .body{padding:10px;flex:1}
.block .x{background:var(--danger);border:none;color:#fff;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}
.block .resize{position:absolute;right:6px;bottom:6px;width:14px;height:14px;border-right:3px solid #446; border-bottom:3px solid #446; cursor:nwse-resize;opacity:.8}
.block .title{font-weight:600}
.preview-card{border-color:#3a4c6b}
.p-group{border:1px solid #2a3140;border-radius:10px;padding:12px;margin-bottom:12px;background:#17202c;width:100%}
.p-title{font-size:13px;font-weight:600;margin-bottom:10px;color:#cfe0ff}
.p-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;width:100%}
.p-field{min-width:0;width:100%}
.p-field>div{display:flex;gap:8px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 8px;border-radius:8px;background:#0f1624;margin:4px}
.chip .grab{cursor:grab;font-size:12px;opacity:.7}
.chip.dragging{opacity:.5;border-style:dashed}
.dropzone{min-height:38px;border:1px dashed #334; border-radius:8px; padding:8px; background:#0c1220}
.inline{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width: 900px){
  .p-row{grid-template-columns:repeat(2,1fr)}
  .inline{grid-template-columns:1fr}
}
.errorBox{background:#3a0f15;border:1px solid #7f1d1d;color:#fecaca;padding:10px;border-radius:8px;margin:10px 0}
</style>
</head>
<body>
<header>
  <span id="ver" class="badge">cascade-v5-full-work-fix</span>
  <div class="tabs">
    <button class="tab active" data-tab="filters">Фильтры</button>
    <button class="tab" data-tab="fields">Поля</button>
    <button class="tab" data-tab="layout">Макет</button>
    <button class="tab" data-tab="preview">Предпросмотр</button>
  </div>
  <div style="margin-left:auto" class="row">
    <button id="btnExport" class="btn">Экспорт</button>
    <label class="btn"><input id="fileImport" type="file" accept=".json,.txt" style="display:none">Импорт</label>
    <button id="btnReset" class="btn danger" title="Очистить сохранённые настройки и перезапустить">Сброс</button>
  </div>
</header>

<main>
  <!-- ФИЛЬТРЫ -->
  <section id="tab-filters" class="panel"></section>

  <!-- ПОЛЯ -->
  <section id="tab-fields" class="panel" style="display:none"></section>

  <!-- МАКЕТ -->
  <section id="tab-layout" class="panel" style="display:none"></section>

  <!-- ПРЕДПРОСМОТР -->
  <section id="tab-preview" class="panel" style="display:none">
    <div class="canvas-wrap"><div id="preview" class="preview-grid"></div></div>
  </section>
</main>

<footer>
  build: admin_cascade_v5_full_work_fix
</footer>

<script>
/* Глобальная ловушка ошибок — покажем сообщение вместо тихого падения */
window.addEventListener('error', function(e){
  var box=document.createElement('div');
  box.className='errorBox';
  box.textContent='Ошибка JS: '+e.message;
  document.getElementById('tab-filters').prepend(box);
});

/* ================= DATA ================ */
const KEY="admin_cascade_v5_full_work";
let data={
  fields:[
    {label:"Страна",field:"country",type:"select",options:["Узбекистан"]},
    {label:"Город",field:"city",type:"select",parent:"country",dict:{"Узбекистан":["Ташкент","Самарканд"]}},
    {label:"Район",field:"district",type:"select",parent:"city",dict:{
      "Ташкент":["Мирзо-Улугбек","Юнусабад"],"Самарканд":["Центр","Сиаб"]
    }},
    {label:"Улица/Массив",field:"street",type:"select",parent:"district",dict:{
      "Мирзо-Улугбек":["Амира Темура","Буюк Ипак"],"Юнусабад":["Юнус-1","Юнус-9"],
      "Центр":["Регистан","Навои"],"Сиаб":["Газар","Саховат"]
    }},
    {label:"Категория",field:"category",type:"select",options:["Квартира","Коммерция","Земля"]},
    {label:"Подкатегория",field:"subcategory",type:"select",parent:"category",dict:{
      "Квартира":["Аренда","Продажа"],"Коммерция":["Аренда","Продажа"],"Земля":["Продажа"]
    }},
    {label:"Тип жилья",field:"apartment_type",type:"select",parent:"subcategory",
      dict:{"Аренда":["Вторичка","Новостройка"],"Продажа":["Вторичка","Новостройка"]},
      visibleWhen:{category:"Квартира"}},
    {label:"Тип недвижимости",field:"commercial_type",type:"select",parent:"subcategory",
      dict:{"Аренда":["Офис","Склад"],"Продажа":["Магазин","Офис"]},
      visibleWhen:{category:"Коммерция"}},
    {label:"Цена",field:"price",type:"range",rangeLabels:["от","до"]},
    {label:"Площадь",field:"area",type:"range",rangeLabels:["от м²","до м²"]},
    {label:"Этаж",field:"floor",type:"range",rangeLabels:["от","до"]},
    {label:"Этажность дома",field:"floors",type:"range",rangeLabels:["от","до"]}
  ],
  groups:[
    {name:"Верхняя линия",desc:"Основные фильтры",filters:["country","city","district","street","category","subcategory","apartment_type","commercial_type","price","area","floor","floors"]}
  ],
  layout:[
    {id:1,type:"filters",title:"Фильтры",x:1,y:1,w:12,h:6}
  ]
};

let previewState = {};

try{
  var saved=localStorage.getItem(KEY);
  if(saved){
    try{
      var obj=JSON.parse(saved);
      if(obj && typeof obj==='object') data=Object.assign(data, obj);
    }catch(e){ console.warn('Bad saved JSON, ignore'); }
  }
}catch(e){}

/* ================= HELPERS ================ */
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){} }
function byField(name){ return data.fields.find(function(f){ return f.field===name; }); }
function normalize(){
  data.fields.forEach(function(f){
    if(!f.options) f.options=[];
    if(f.type==="range" && !f.rangeLabels) f.rangeLabels=["от","до"];
    if(f.type==="select"){ if(!f.dict) f.dict={}; if(!f.parent) f.parent=""; }
    if(!("desc" in f)) f.desc="";
  });
  data.groups.forEach(function(g){ if(!g.desc) g.desc=""; if(!g.filters) g.filters=[]; });
}

/* ================= TABS ================ */
Array.prototype.forEach.call(document.querySelectorAll('.tab'), function(btn){
  btn.onclick=function(){
    Array.prototype.forEach.call(document.querySelectorAll('.tab'), function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    var tab=btn.getAttribute('data-tab');
    ['filters','fields','layout','preview'].forEach(function(id){
      document.getElementById('tab-'+id).style.display = (id===tab)?'block':'none';
    });
    if(tab==='filters') renderGroups();
    if(tab==='fields') renderFields();
    if(tab==='layout') renderLayout();
    if(tab==='preview') renderPreview();
  };
});

/* ================= FILTER GROUPS ================ */
function addGroup(){ data.groups.push({name:'Новая линия',desc:'',filters:[]}); save(); renderGroups(); renderPreview(); }
function removeGroup(i){ data.groups.splice(i,1); save(); renderGroups(); renderPreview(); }
function addFieldToGroup(gi, fieldName){
  if(data.groups[gi].filters.indexOf(fieldName)===-1){
    data.groups[gi].filters.push(fieldName); save(); renderGroups(); renderPreview();
  }
}
function removeFilter(gIndex, fIndex){ data.groups[gIndex].filters.splice(fIndex,1); save(); renderGroups(); renderPreview(); }

var dragChip=null;
function renderGroups(){
  var box=document.getElementById('tab-filters'); box.innerHTML='';
  var top=document.createElement('div'); top.className='row'; top.style.marginBottom='10px';
  var bAdd=document.createElement('button'); bAdd.className='btn'; bAdd.textContent='+ Ряд'; bAdd.onclick=addGroup; top.appendChild(bAdd);
  box.appendChild(top);

  var list=document.createElement('div'); list.className='list';
  data.groups.forEach(function(g,gi){
    var card=document.createElement('div'); card.className='card';
    var head=document.createElement('div'); head.className='title-row';
    var left=document.createElement('div'); left.className='row';
    var h=document.createElement('h3'); h.textContent=g.name||( 'Линия '+(gi+1) ); left.appendChild(h);
    var meta=document.createElement('small'); meta.className='muted'; meta.textContent=g.desc||''; left.appendChild(meta);
    head.appendChild(left);
    var right=document.createElement('div'); right.className='row';
    var sel=document.createElement('select'); var o0=document.createElement('option'); o0.value=''; o0.textContent='Добавить поле…'; sel.appendChild(o0);
    data.fields.forEach(function(ff){ var o=document.createElement('option'); o.value=ff.field; o.textContent=ff.label+' ('+ff.field+')'; sel.appendChild(o); });
    sel.onchange=function(e){ if(e.target.value){ addFieldToGroup(gi, e.target.value); e.target.value=''; } };
    var del=document.createElement('button'); del.className='btn danger'; del.textContent='Удалить ряд'; del.onclick=function(){ removeGroup(gi); };
    right.appendChild(sel); right.appendChild(del); head.appendChild(right); card.appendChild(head);

    // editors
    var editors=document.createElement('div'); editors.className='inline'; editors.style.margin='8px 0';
    var w1=document.createElement('div'); w1.innerHTML='<label>Заголовок</label>'; var i1=document.createElement('input'); i1.value=g.name||''; i1.oninput=function(e){ data.groups[gi].name=e.target.value; save(); renderPreview(); }; w1.appendChild(i1);
    var w2=document.createElement('div'); w2.innerHTML='<label>Описание</label>'; var i2=document.createElement('input'); i2.value=g.desc||''; i2.oninput=function(e){ data.groups[gi].desc=e.target.value; save(); renderPreview(); }; w2.appendChild(i2);
    editors.appendChild(w1); editors.appendChild(w2); card.appendChild(editors);

    var row=document.createElement('div'); row.className='chips dropzone'; row.setAttribute('data-group', gi);
    (g.filters||[]).forEach(function(fname,fi){
      var f=byField(fname); var chip=document.createElement('div'); chip.className='chip'; chip.draggable=true; chip.setAttribute('data-name', fname);
      chip.innerHTML='<span class="grab">↕</span><small>'+(f ? (f.label||fname) : fname)+'</small>';
      var x=document.createElement('button'); x.className='btn danger'; x.textContent='x'; x.style.padding='2px 6px'; x.onclick=function(){ removeFilter(gi,fi); };
      chip.appendChild(x);
      chip.addEventListener('dragstart', function(){ dragChip={name:fname, fromG:gi, fromIndex:fi}; chip.classList.add('dragging'); });
      chip.addEventListener('dragend', function(){ chip.classList.remove('dragging'); dragChip=null; });
      row.appendChild(chip);
    });
    row.addEventListener('dragover', function(e){ e.preventDefault(); });
    row.addEventListener('drop', function(e){
      e.preventDefault(); var toG=parseInt(row.getAttribute('data-group'),10); if(!dragChip) return;
      var arr=data.groups[dragChip.fromG].filters; var idx=arr.indexOf(dragChip.name); if(idx>-1) arr.splice(idx,1);
      data.groups[toG].filters.push(dragChip.name); save(); renderGroups(); renderPreview();
    });
    card.appendChild(row);
    list.appendChild(card);
  });
  box.appendChild(list);
}

/* ================= FIELDS ================ */
function addField(){
  var n=data.fields.length+1; data.fields.push({label:'Поле '+n, field:'field_'+n, type:'text', desc:''});
  save(); renderFields(); renderPreview();
}
function removeField(i){
  var name=data.fields[i].field;
  data.groups.forEach(function(g){ g.filters = (g.filters||[]).filter(function(n){ return n!==name; }); });
  data.fields.splice(i,1); save(); renderFields(); renderGroups(); renderPreview();
}
function renderFields(){
  var box=document.getElementById('tab-fields'); box.innerHTML='';
  var top=document.createElement('div'); top.className='row'; top.style.justifyContent='space-between'; top.style.marginBottom='8px';
  var h=document.createElement('h3'); h.textContent='Все поля'; top.appendChild(h);
  var add=document.createElement('button'); add.className='btn'; add.textContent='+ Поле'; add.onclick=addField; top.appendChild(add);
  box.appendChild(top);

  var list=document.createElement('div'); list.className='list';
  var fieldNames=data.fields.map(function(f){ return f.field; });

  data.fields.forEach(function(f,i){
    var card=document.createElement('div'); card.className='card';
    var head=document.createElement('div'); head.className='title-row';
    var left=document.createElement('div'); left.className='row';
    var t=document.createElement('h3'); t.textContent=f.label||f.field; left.appendChild(t);
    var meta=document.createElement('small'); meta.className='muted'; meta.textContent=' ('+f.field+')'; left.appendChild(meta);
    head.appendChild(left);
    var r=document.createElement('div'); r.className='row';
    var del=document.createElement('button'); del.className='btn danger'; del.textContent='Удалить'; del.onclick=function(){ removeField(i); };
    r.appendChild(del); head.appendChild(r); card.appendChild(head);

    var grid=document.createElement('div'); grid.className='grid'; grid.style.gridTemplateColumns='repeat(2,1fr)'; grid.style.gap='10px';

    // label
    var w=document.createElement('div'); w.innerHTML='<label>Заголовок</label>';
    var inp=document.createElement('input'); inp.value=f.label||''; inp.oninput=function(e){ data.fields[i].label=e.target.value; save(); renderGroups(); renderPreview(); };
    w.appendChild(inp); grid.appendChild(w);

    // field
    w=document.createElement('div'); w.innerHTML='<label>Имя</label>';
    inp=document.createElement('input'); inp.value=f.field||''; inp.oninput=function(e){ data.fields[i].field=e.target.value; save(); renderGroups(); renderPreview(); };
    w.appendChild(inp); grid.appendChild(w);

    // type
    w=document.createElement('div'); w.innerHTML='<label>Тип</label>';
    var selType=document.createElement('select');
    ['text','number','select','range'].forEach(function(tt){ var o=document.createElement('option'); o.value=tt; o.textContent=tt; if(f.type===tt) o.selected=true; selType.appendChild(o); });
    selType.onchange=function(e){ data.fields[i].type=e.target.value; if(e.target.value!=='select'){ data.fields[i].parent=''; data.fields[i].dict={}; } save(); renderPreview(); renderFields(); };
    w.appendChild(selType); grid.appendChild(w);

    // desc
    w=document.createElement('div'); w.innerHTML='<label>Описание</label>';
    inp=document.createElement('input'); inp.placeholder='подпись/подсказка'; inp.value=f.desc||''; inp.oninput=function(e){ data.fields[i].desc=e.target.value; save(); renderPreview(); };
    w.appendChild(inp); grid.appendChild(w);

    // parent
    var wp=document.createElement('div'); wp.innerHTML='<label>Родитель (для каскада)</label>';
    var selP=document.createElement('select');
    var parOpts=[''].concat( fieldNames.filter(function(n){ return n!==f.field && (byField(n)&&byField(n).type==='select'); }) );
    parOpts.forEach(function(nm){ var o=document.createElement('option'); o.value=nm; o.textContent=nm===''?'(нет)':nm; if((f.parent||'')===nm) o.selected=true; selP.appendChild(o); });
    selP.onchange=function(e){ data.fields[i].parent=e.target.value||''; save(); renderPreview(); renderFields(); };
    wp.appendChild(selP); grid.appendChild(wp);

    // options/dict editor
    var wOD=document.createElement('div');
    if(f.type==='select'){
      if(f.parent){
        wOD.innerHTML='<label>Карта опций (parent=опция1, опция2)</label>';
        var ta=document.createElement('textarea'); ta.rows=5;
        var lines=Object.keys(f.dict||{}).map(function(pk){ return pk+'='+(f.dict[pk]||[]).join(', '); });
        ta.value=lines.join('\n');
        ta.oninput=function(e){
          var map={};
          e.target.value.split('\n').forEach(function(line){
            var t=line.trim(); if(!t) return;
            var parts=t.split('='); var k=parts[0]; var rest=parts.slice(1).join('='); 
            map[k.trim()]=(rest||'').split(',').map(function(s){return s.trim();}).filter(Boolean);
          });
          data.fields[i].dict=map; save(); renderPreview();
        };
        wOD.appendChild(ta);
      }else{
        wOD.innerHTML='<label>Опции (через запятую)</label>';
        var ta2=document.createElement('textarea'); ta2.rows=3; ta2.value=Array.isArray(f.options)?f.options.join(', '):'';
        ta2.oninput=function(e){ data.fields[i].options=e.target.value.split(',').map(function(s){return s.trim();}).filter(Boolean); save(); renderPreview(); };
        wOD.appendChild(ta2);
      }
    }else if(f.type==='range'){
      wOD.innerHTML='<label>Подписи диапазона (левая, правая)</label>';
      var rlab=document.createElement('input'); var L=(f.rangeLabels&&f.rangeLabels[0])||'от'; var R=(f.rangeLabels&&f.rangeLabels[1])||'до';
      rlab.value=L+', '+R; rlab.oninput=function(e){ var p=e.target.value.split(',').map(function(s){return s.trim();}); data.fields[i].rangeLabels=[p[0]||'от', p[1]||'до']; save(); renderPreview(); };
      wOD.appendChild(rlab);
    }else{
      wOD.innerHTML='<label>&nbsp;</label><div class="muted">Для этого типа настроек нет</div>';
    }
    grid.appendChild(wOD);

    // visibleWhen
    var wVW=document.createElement('div'); wVW.innerHTML='<label>Условие отображения (ключ=значение)</label>';
    var vin=document.createElement('input'); vin.placeholder='например: category=Квартира';
    vin.value=f.visibleWhen?(Object.keys(f.visibleWhen)[0]+'='+Object.values(f.visibleWhen)[0]):'';
    vin.oninput=function(e){
      var v=e.target.value.trim();
      if(!v){ data.fields[i].visibleWhen=null; save(); renderPreview(); return; }
      var parts=v.split('='); var k=parts[0]; var val=parts.slice(1).join('=');
      data.fields[i].visibleWhen = k? (function(){ var o={}; o[k.trim()] = (val||'').trim(); return o; })() : null;
      save(); renderPreview();
    };
    wVW.appendChild(vin); grid.appendChild(wVW);

    card.appendChild(grid); list.appendChild(card);
  });
  box.appendChild(list);
}

/* ================= LAYOUT ================ */
var nextId=100, dragState=null, resizeState=null;
function addBlock(type){
  var id=++nextId; data.layout.push({id:id,type:type,title:(type==='filters'?'Фильтры':type.toUpperCase()),x:1,y:1,w:6,h:4});
  save(); renderLayout(); renderPreview();
}
function removeBlock(id){ var i=data.layout.findIndex(function(b){return b.id===id;}); if(i>-1){ data.layout.splice(i,1); save(); renderLayout(); renderPreview(); } }
function clearLayout(){ data.layout=[]; save(); renderLayout(); renderPreview(); }
function autoLayout(){ var col=1,row=1; data.layout.forEach(function(b){ b.w=6;b.h=4;b.x=col;b.y=row; col=(col===1)?7:1; if(col===1) row+=4; }); save(); renderLayout(); renderPreview(); }
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

function renderLayout(){
  var box=document.getElementById('tab-layout'); box.innerHTML='';
  var bar=document.createElement('div'); bar.className='row'; bar.style.marginBottom='10px';
  ['filters','form','cards','table','map'].forEach(function(t){ var b=document.createElement('button'); b.className='btn'; b.textContent='+ '+(t==='filters'?'Фильтры':t.toUpperCase()); b.onclick=function(){ addBlock(t); }; bar.appendChild(b); });
  var bAuto=document.createElement('button'); bAuto.className='btn warn'; bAuto.textContent='Авторасстановка'; bAuto.onclick=autoLayout; bar.appendChild(bAuto);
  var bClr=document.createElement('button'); bClr.className='btn danger'; bClr.textContent='Очистить'; bClr.onclick=clearLayout; bar.appendChild(bClr);
  box.appendChild(bar);

  var wrap=document.createElement('div'); wrap.className='canvas-wrap';
  var grid=document.createElement('div'); grid.className='canvas'; wrap.appendChild(grid); box.appendChild(wrap);

  var rows = data.layout.length ? Math.max.apply(null, data.layout.map(function(b){return b.y+b.h-1;})) : 1;
  grid.style.minHeight=(rows*90 + (rows-1)*6) + 'px';

  data.layout.forEach(function(b){
    var card=document.createElement('div'); card.className='block'; card.setAttribute('data-id', b.id);
    card.style.gridColumn=b.x+'/span '+b.w; card.style.gridRow=b.y+'/span '+b.h;
    var head=document.createElement('header');
    var title=document.createElement('span'); title.className='title'; title.textContent=b.title||b.type;
    title.ondblclick=function(){ var t=prompt('Название блока:', b.title||b.type); if(t!=null){ b.title=t; save(); renderLayout(); renderPreview(); } };
    var rm=document.createElement('button'); rm.className='x'; rm.textContent='x'; rm.onclick=function(){ removeBlock(b.id); };
    head.appendChild(title); head.appendChild(rm);
    head.addEventListener('mousedown', function(e){
      var rect=grid.getBoundingClientRect(); var colW=rect.width/12; var rowH=96;
      dragState={id:b.id, startX:e.clientX, startY:e.clientY, baseX:b.x, baseY:b.y, colW:colW, rowH:rowH};
      document.addEventListener('mousemove', onDragMove); document.addEventListener('mouseup', onDragEnd, {once:true});
    });
    var body=document.createElement('div'); body.className='body'; body.textContent='Секция макета';
    var res=document.createElement('div'); res.className='resize';
    res.addEventListener('mousedown', function(e){
      e.stopPropagation(); var rect=grid.getBoundingClientRect(); var colW=rect.width/12; var rowH=96;
      resizeState={id:b.id, startX:e.clientX, startY:e.clientY, baseW:b.w, baseH:b.h, colW:colW, rowH:rowH};
      document.addEventListener('mousemove', onResizeMove); document.addEventListener('mouseup', onResizeEnd, {once:true});
    });
    card.appendChild(head); card.appendChild(body); card.appendChild(res); grid.appendChild(card);
  });

  function onDragMove(e){
    if(!dragState) return; var b=data.layout.find(function(x){return x.id===dragState.id;}); if(!b) return;
    var dx=e.clientX-dragState.startX; var dy=e.clientY-dragState.startY;
    var gx=Math.round(dragState.baseX + dx/dragState.colW);
    var gy=Math.round(dragState.baseY + dy/dragState.rowH);
    gx=clamp(gx,1,12-(b.w-1)); gy=clamp(gy,1,Math.max(1,gy)); b.x=gx; b.y=gy; renderLayout();
  }
  function onDragEnd(){ if(dragState){ save(); dragState=null; } document.removeEventListener('mousemove', onDragMove); }
  function onResizeMove(e){
    if(!resizeState) return; var b=data.layout.find(function(x){return x.id===resizeState.id;}); if(!b) return;
    var dx=e.clientX-resizeState.startX; var dy=e.clientY-resizeState.startY;
    var gw=Math.round(resizeState.baseW + dx/resizeState.colW);
    var gh=Math.round(resizeState.baseH + dy/resizeState.rowH);
    gw=clamp(gw,1,12-(b.x-1)); gh=clamp(gh,1,24); b.w=gw; b.h=gh; renderLayout();
  }
  function onResizeEnd(){ if(resizeState){ save(); resizeState=null; } document.removeEventListener('mousemove', onResizeMove); }
}

/* ================= PREVIEW ================ */
function buildChildrenMap(){
  var children={};
  data.fields.forEach(function(f){
    if(f.parent){
      if(!children[f.parent]) children[f.parent]=[];
      children[f.parent].push(f.field);
    }
  });
  return children;
}
function computeOptionsFor(f){
  if(f.type!=='select') return [];
  if(f.parent){
    var pv=previewState[f.parent]||'';
    return (f.dict && f.dict[pv]) ? f.dict[pv] : [];
  }
  return Array.isArray(f.options)?f.options:[];
}
function visibleFor(f){
  if(!f.visibleWhen) return true;
  var entries=[]; for(var k in f.visibleWhen){ if(Object.prototype.hasOwnProperty.call(f.visibleWhen,k)){ entries.push([k, f.visibleWhen[k]]); break; } }
  if(!entries.length) return true;
  var pair=entries[0]; var key=pair[0], val=pair[1];
  if(!(key in previewState) || !previewState[key]) return true;
  return previewState[key]===val;
}
function clearDescendants(parentField, childrenMap){
  if(!childrenMap[parentField]) return;
  childrenMap[parentField].forEach(function(ch){
    if(previewState[ch]) delete previewState[ch];
    clearDescendants(ch, childrenMap);
  });
}
function renderPreview(){
  var grid=document.getElementById('preview'); grid.innerHTML='';
  var rows = data.layout.length ? Math.max.apply(null, data.layout.map(function(b){return b.y+b.h-1;})) : 1;
  grid.style.minHeight = (rows*90 + (rows-1)*6) + 'px';

  var children=buildChildrenMap();

  data.layout.forEach(function(b){
    if(b.type!=='filters') return;
    var card=document.createElement('div'); card.className='preview-card';
    card.style.gridColumn=b.x+' / span '+b.w; card.style.gridRow=b.y+' / span '+b.h;

    var wrap=document.createElement('div');
    data.groups.forEach(function(g,gi){
      var group=document.createElement('div'); group.className='p-group';
      var title=document.createElement('div'); title.className='p-title';
      title.textContent = g.name || (gi===0?'Верхняя линия':'Линия '+(gi+1));
      group.appendChild(title);
      if(g.desc){ var d=document.createElement('div'); d.className='muted'; d.style.marginBottom='8px'; d.textContent=g.desc; group.appendChild(d); }
      var row=document.createElement('div'); row.className='p-row';

      (g.filters||[]).forEach(function(name){
        var f=byField(name); if(!f) return;
        var box=document.createElement('div'); box.className='p-field'; box.style.display=visibleFor(f)?'':'none';
        var lab=document.createElement('label'); lab.textContent=(f.label && f.label.trim()) || f.field || 'Без названия'; box.appendChild(lab);

        if(f.type==='select'){
          var sel=document.createElement('select');
          var opts = computeOptionsFor(f);
          var optionsHtml = '<option value=\"\">—</option>' + opts.map(function(o){ return '<option>'+o+'</option>'; }).join('');
          sel.innerHTML = optionsHtml;
          if(previewState[f.field] && opts.indexOf(previewState[f.field])>-1) sel.value=previewState[f.field];
          sel.addEventListener('change', function(){
            previewState[f.field]=sel.value;
            clearDescendants(f.field, children);
            renderPreview();
          });
          box.appendChild(sel);
        }else if(f.type==='range'){
          var div=document.createElement('div'); div.className='row';
          var a=document.createElement('input'); a.placeholder=(f.rangeLabels && f.rangeLabels[0]) || 'от'; a.value = previewState[f.field+'_min']||'';
          var b=document.createElement('input'); b.placeholder=(f.rangeLabels && f.rangeLabels[1]) || 'до'; b.value = previewState[f.field+'_max']||'';
          a.addEventListener('input', function(){ previewState[f.field+'_min']=a.value; });
          b.addEventListener('input', function(){ previewState[f.field+'_max']=b.value; });
          div.appendChild(a); div.appendChild(b); box.appendChild(div);
        }else if(f.type==='number'){
          var num=document.createElement('input'); num.type='number'; num.value = previewState[f.field]||'';
          num.addEventListener('input', function(){ previewState[f.field]=num.value; });
          box.appendChild(num);
        }else{
          var t=document.createElement('input'); t.type='text'; t.value = previewState[f.field]||'';
          t.addEventListener('input', function(){ previewState[f.field]=t.value; });
          box.appendChild(t);
        }
        row.appendChild(box);
      });

      group.appendChild(row); wrap.appendChild(group);
    });

    card.appendChild(wrap);
    grid.appendChild(card);
  });
}

/* ================= EXPORT / IMPORT / RESET ================ */
document.getElementById('btnExport').onclick=function(){
  normalize();
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='admin-cascade-v5.json'; a.click();
};
document.getElementById('fileImport').onchange=function(e){
  var f=e.target.files[0]; if(!f) return; var r=new FileReader();
  r.onload=function(){ try{
      var obj=JSON.parse(r.result);
      if(obj.fields) data.fields=obj.fields;
      if(obj.groups) data.groups=obj.groups;
      if(obj.layout) data.layout=obj.layout;
      normalize(); save();
      previewState={};
      renderGroups(); renderFields(); renderLayout(); renderPreview();
      alert('Импорт выполнен');
    }catch(err){ console.error(err); alert('Ошибка импорта'); }
  };
  r.readAsText(f);
};
document.getElementById('btnReset').onclick=function(){
  try{ localStorage.removeItem(KEY); }catch(e){}
  location.reload();
};

/* ================= INIT ================ */
try{
  normalize();
  renderGroups(); renderFields(); renderLayout(); renderPreview();
}catch(e){
  var box=document.createElement('div'); box.className='errorBox'; box.textContent='Ошибка инициализации: '+e.message;
  document.getElementById('tab-filters').appendChild(box);
}
</script>
</body>
</html>