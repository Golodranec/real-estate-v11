<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin ‚Äî full v4</title>
  <style>
    :root{--bg:#0f1115;--panel:#161a22;--muted:#1f2530;--line:#2a3140;--text:#e6e6e6;--accent:#5b9cff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui}
    header{padding:10px;background:var(--panel);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;margin-right:auto}
    .tab{padding:6px 12px;background:#2a3140;border-radius:6px;cursor:pointer}
    .tab.active{background:var(--accent);color:#fff}
    .btn{padding:6px 10px;border-radius:6px;border:1px solid #2a3140;background:#2a3140;color:#fff;cursor:pointer}
    .btn.ghost{background:transparent}
    .badge{margin-left:8px;font-size:12px;opacity:.75;padding:2px 6px;border:1px solid #2a3140;border-radius:6px}
    main{display:grid;grid-template-columns:1fr 1fr;min-height:90vh}
    .panel{padding:12px;overflow:auto}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #333;background:#111722;color:#fff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .group{border:1px solid var(--line);border-radius:10px;padding:10px;margin:10px 0}
    .group-sep{height:1px;background:var(--line);margin:16px 0;opacity:.7}
    .chip{display:flex;gap:8px;align-items:center;background:#1a202c;border:1px solid #2a3140;border-radius:10px;padding:8px}
    .chip .ar{width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #2a3140;border-radius:6px;background:#0f141d;cursor:pointer}
    .chip .ar:hover{background:#17202c}
    .list{display:flex;gap:8px;flex-wrap:wrap}
    .item{display:flex;gap:8px;align-items:center;background:var(--muted);border:1px solid var(--line);border-radius:10px;padding:8px;margin:6px 0}
    /* Layout */
    .toolbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .canvas-wrap{border:1px solid #2a3140;border-radius:12px;background:#0b0d12;padding:6px;overflow:auto}
    .canvas{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px;min-height:60vh}
    .grid-bg{position:absolute;inset:0;pointer-events:none;background-image:linear-gradient(to right, rgba(255,255,255,.04) 1px, transparent 1px),linear-gradient(to bottom, rgba(255,255,255,.04) 1px, transparent 1px);background-size:calc((100% - 11*6px)/12) 90px}
    .block{background:#1f2530;border:1px solid #2a3140;border-radius:10px;display:flex;align-items:center;justify-content:center;position:absolute;user-select:none;box-shadow:0 0 0 1px rgba(0,0,0,.2) inset}
    .block.dragging{opacity:.85;outline:2px dashed #5b9cff}
    .block .title{position:absolute;left:10px;top:6px;font-size:12px;opacity:.85;cursor:move}
    .block .close{position:absolute;top:6px;right:6px;background:#e53e3e;border:none;border-radius:50%;width:22px;height:22px;color:#fff;cursor:pointer;font-size:14px;line-height:20px;z-index:5}
    .block .resize{position:absolute;right:6px;bottom:6px;width:14px;height:14px;border-radius:3px;background:#5b9cff;cursor:nwse-resize}
    /* Preview */
    .preview-grid{display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px}
    .preview-card{background:#1a202c;border:1px solid #2a3140;border-radius:10px;padding:10px;height:100%;overflow:auto}
    .filters-row{display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin-bottom:8px}
    .field{min-width:160px}
    .field label{display:block;margin-bottom:4px;font-size:12px;color:#cfd8e3}
    /* Toast + footer */
    .toast{position:fixed;right:18px;bottom:18px;background:#1f2530;border:1px solid #2a3140;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(8px);transition:.2s;z-index:50}
    .toast.show{opacity:1;transform:translateY(0)}
    footer{padding:8px 12px;color:#a9b4c7;font-size:12px;border-top:1px solid #2a3140;background:#0d1119;grid-column:1 / -1}
  </style>
</head>
<body>
<header>
  <div class="tabs"><span class="badge" id="verBadge">v8</span>
    <div class="tab active" data-tab="filters">‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã</div>
    <div class="tab" data-tab="fields">üìù –ü–æ–ª—è</div>
    <div class="tab" data-tab="layout">üñºÔ∏è –ú–∞–∫–µ—Ç</div>
    <div class="tab" data-tab="preview">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
  </div>
  <button class="btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label class="btn">–ò–º–ø–æ—Ä—Ç<input id="importInput" type="file" hidden></label>
</header>

<main>
  <!-- Filters -->
  <section class="panel" id="filtersPanel">
    <div class="row" style="margin-bottom:8px">
      <button class="btn" onclick="addGroup()">+ –†—è–¥</button>
      <button class="btn" onclick="addFilter()">+ –§–∏–ª—å—Ç—Ä</button>
    </div>
    <div id="groupsWrap"></div>
    <h3 style="margin-top:16px">–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
    <div id="filtersList"></div>
  </section>

  <!-- Fields -->
  <section class="panel" id="fieldsPanel" style="display:none">
    <div id="fieldsList"></div>
    <button class="btn" onclick="addField()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
  </section>

  <!-- Layout -->
  <section class="panel" id="layoutPanel" style="display:none">
    <div class="toolbar">
      <button class="btn" onclick="addBlock('filters')">+ –§–∏–ª—å—Ç—Ä—ã</button>
      <button class="btn" onclick="addBlock('map')">+ –ö–∞—Ä—Ç–∞</button>
      <button class="btn" onclick="addBlock('form')">+ –§–æ—Ä–º–∞</button>
      <button class="btn" onclick="addBlock('cards')">+ –°–ø–∏—Å–æ–∫</button>
      <button class="btn" onclick="addBlock('table')">+ –¢–∞–±–ª–∏—Ü–∞</button>
      <button class="btn ghost" onclick="clearLayout()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <div class="canvas-wrap">
      <div id="canvas" class="canvas"></div>
      <div class="grid-bg"></div>
    </div>
  </section>

  <!-- Preview -->
  <section class="panel" id="previewPanel" style="display:none">
    <div id="preview" class="preview-grid" style="min-height:200px"></div>
  </section>
</main>

<div class="toast" id="toast"></div>
<footer>build: admin-full-v8</footer>

<script>
// ====== State & utils
const KEY="admin_full_cfg_v8";
let data = JSON.parse(localStorage.getItem(KEY) || '{}');

function sanitizeLayout(){
  if(!Array.isArray(data.layout)) { data.layout=[]; return; }
  data.layout = data.layout.map(b=>{
    const x=Math.max(1, Math.min(12, +b.x||1));
    const w=Math.max(1, Math.min(12, +b.w||1));
    const maxW = 12 - x + 1;
    const w2 = Math.min(w, maxW);
    const y=Math.max(1, +b.y||1);
    const h=Math.max(1, +b.h||1);
    return {id:b.id||Date.now()+Math.random(), type:b.type||'filters', x, y, w:w2, h};
  });
}

if(!Object.keys(data).length){
  data = {
    groups:[{id:1,name:"–í–µ—Ä—Ö–Ω—è—è –ª–∏–Ω–∏—è",filters:["country","city","category"]}],
    filters:[
      {label:"–°—Ç—Ä–∞–Ω–∞",field:"country",type:"select",options:["–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω"],rules:[]},
      {label:"–ì–æ—Ä–æ–¥",field:"city",type:"select",options:["–¢–∞—à–∫–µ–Ω—Ç","–°–∞–º–∞—Ä–∫–∞–Ω–¥"],rules:[]},
      {label:"–ö–∞—Ç–µ–≥–æ—Ä–∏—è",field:"category",type:"select",options:["–ö–≤–∞—Ä—Ç–∏—Ä–∞","–ö–æ–º–º–µ—Ä—Ü–∏—è"],rules:[]},
      {label:"–¶–µ–Ω–∞",field:"price",type:"range"}
    ],
    fields:[
      {label:"–ó–∞–≥–æ–ª–æ–≤–æ–∫",id:"title",type:"text"},
      {label:"–û–ø–∏—Å–∞–Ω–∏–µ",id:"desc",type:"textarea"},
      {label:"–ö–æ–Ω—Ç–∞–∫—Ç",id:"contact",type:"text"}
    ],
    layout:[
      {id:1,type:"filters",x:1,y:1,w:12,h:2},
      {id:2,type:"form",x:1,y:3,w:12,h:3}
    ]
  };
  save();
}
sanitizeLayout();
function save(){ localStorage.setItem(KEY, JSON.stringify(data)); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),1500); }
function byField(field){ return data.filters.find(f=>f.field===field); }

// ====== Tabs
document.querySelectorAll('.tab').forEach(t=>t.onclick = () => {
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const id=t.dataset.tab;
  document.getElementById('filtersPanel').style.display = id==='filters' ? 'block':'none';
  document.getElementById('fieldsPanel').style.display  = id==='fields'  ? 'block':'none';
  document.getElementById('layoutPanel').style.display  = id==='layout'  ? 'block':'none';
  document.getElementById('previewPanel').style.display = id==='preview' ? 'block':'none';
  if(id==='layout') renderLayout();
  if(id==='preview') renderPreview();
});

// ====== Export / Import
document.getElementById('exportBtn').onclick = () => {
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'config.json'; a.click();
  toast('–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
};
document.getElementById('importInput').addEventListener('change', async e => {
  const f=e.target.files?.[0]; if(!f) return;
  try{ const txt=await f.text(); data=JSON.parse(txt); sanitizeLayout(); save(); renderAll(); toast('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω'); }
  catch(err){ toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); }
});

// ====== Filters editor (no focus loss)
function addGroup(){ data.groups.push({id:Date.now(),name:"–ù–æ–≤—ã–π —Ä—è–¥",filters:[]}); save(); renderGroups(); }
function deleteGroup(i){
  const moved=data.groups[i].filters;
  if(data.groups.length>1){ const dst=(i===0?1:0); data.groups[dst].filters.push(...moved); data.groups.splice(i,1); }
  else{ data.groups[i].filters=[]; }
  save(); renderGroups(); renderPreview();
}
function addFilter(){
  const f={label:"–§–∏–ª—å—Ç—Ä",field:"field_"+Date.now(),type:"text",options:[],rules:[]};
  data.filters.push(f);
  if(!data.groups.length) data.groups.push({id:Date.now(),name:"–õ–∏–Ω–∏—è",filters:[]});
  data.groups[0].filters.push(f.field);
  save(); renderGroups(); renderFiltersTable(); renderPreview();
}
function removeFilter(field){
  data.groups.forEach(g=>g.filters=g.filters.filter(x=>x!==field));
  data.filters=data.filters.filter(f=>f.field!==field);
  save(); renderGroups(); renderFiltersTable(); renderPreview();
}

function renderGroups(){
  const wrap=document.getElementById('groupsWrap'); wrap.innerHTML='';
  data.groups.forEach((g,gi)=>{
    if(gi>0){ const sep=document.createElement('div'); sep.className='group-sep'; wrap.append(sep); }
    const box=document.createElement('div'); box.className='group';
    const head=document.createElement('div'); head.className='row';
    const nameInp=document.createElement('input'); nameInp.value=g.name;
    nameInp.oninput=()=>{ data.groups[gi].name=nameInp.value; save(); };
    const del=document.createElement('button'); del.className='btn ghost'; del.textContent='–£–¥–∞–ª–∏—Ç—å —Ä—è–¥'; del.onclick=()=>deleteGroup(gi);
    head.append(nameInp,del); box.append(head);

    const list=document.createElement('div'); list.className='list';
    g.filters.forEach(field=>{
      const f=byField(field); if(!f) return;
      const chip=document.createElement('div'); chip.className='chip';
      const l1=document.createElement('input'); l1.value=f.label; l1.placeholder='–ù–∞–∑–≤–∞–Ω–∏–µ';
      l1.oninput=()=>{ f.label=l1.value; save(); /* –±–µ–∑ —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞ */ };
      const l2=document.createElement('input'); l2.value=f.field; l2.placeholder='field';
      l2.oninput=()=>{ f.field=l2.value; save(); };
      const sel=document.createElement('select');
      ['select','text','number','range'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; if(f.type===t)o.selected=true; sel.appendChild(o); });
      sel.onchange=()=>{ f.type=sel.value; save(); renderPreview(); };

      const toVals=document.createElement('button'); toVals.className='btn'; toVals.textContent='–ó–Ω–∞—á–µ–Ω–∏—è'; toVals.onclick=()=>openOptions(f.field);
      const toRules=document.createElement('button'); toRules.className='btn'; toRules.textContent='–°–≤—è–∑–∏'; toRules.onclick=()=>openRules(f.field);
      const arL=document.createElement('button'); arL.className='ar'; arL.textContent='‚óÄ'; arL.title='–í–ª–µ–≤–æ'; arL.onclick=()=>moveFilterWithinGroup(gi,f.field,-1);
      const arR=document.createElement('button'); arR.className='ar'; arR.textContent='‚ñ∂'; arR.title='–í–ø—Ä–∞–≤–æ'; arR.onclick=()=>moveFilterWithinGroup(gi,f.field,1);
      const arU=document.createElement('button'); arU.className='ar'; arU.textContent='‚ñ≤'; arU.title='–í–≤–µ—Ä—Ö (–≤ –¥—Ä—É–≥–æ–π —Ä—è–¥)'; arU.onclick=()=>moveFilterBetweenGroups(gi,f.field,-1);
      const arD=document.createElement('button'); arD.className='ar'; arD.textContent='‚ñº'; arD.title='–í–Ω–∏–∑ (–≤ –¥—Ä—É–≥–æ–π —Ä—è–¥)'; arD.onclick=()=>moveFilterBetweenGroups(gi,f.field,1);
      const delF=document.createElement('button'); delF.className='btn ghost'; delF.textContent='‚úñ'; delF.onclick=()=>removeFilter(f.field);

      chip.append(arL,arR,arU,arD,l1,l2,sel);
      if(f.type==='select'){ chip.append(toVals,toRules); }
      chip.append(delF);
      list.append(chip);
    });
    box.append(list);
    wrap.append(box);
  });
  renderFiltersTable();
}

function openOptions(field){
  const f=byField(field);
  const html=`<p>–ó–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:</p>
  <textarea id="optArea" style="width:100%;min-height:120px">${(f.options||[]).join(', ')}</textarea>
  <div class="row" style="margin-top:8px"><button class="btn" onclick="saveOptions('${field}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>`;
  openModal('–ó–Ω–∞—á–µ–Ω–∏—è: '+f.label, html);
}
function saveOptions(field){
  const f=byField(field);
  const txt=document.getElementById('optArea').value;
  f.options=txt.split(',').map(s=>s.trim()).filter(Boolean);
  save(); closeModal(); renderPreview(); renderFiltersTable();
}
function openRules(field){
  const f=byField(field);
  const lines=(f.rules||[]).map(r=>`${r.path.join(' > ')} = ${(r.options||[]).join(', ')}`).join('\n');
  const html=`<p>–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞: –ü—É—Ç—å = –∑–Ω–∞—á–µ–Ω–∏—è</p>
  <textarea id="rulesArea" style="width:100%;min-height:160px">${lines}</textarea>
  <div class="row" style="margin-top:8px"><button class="btn" onclick="saveRules('${field}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>`;
  openModal('–°–≤—è–∑–∏: '+f.label, html);
}
function saveRules(field){
  const f=byField(field);
  const txt=document.getElementById('rulesArea').value;
  f.rules=[];
  txt.split('\n').forEach(line=>{
    if(!line.trim()) return;
    const [left,right]=line.split('=');
    if(!right) return;
    const path=left.split('>').map(s=>s.trim()).filter(Boolean);
    const options=right.split(',').map(s=>s.trim()).filter(Boolean);
    if(path.length && options.length) f.rules.push({path,options});
  });
  save(); closeModal(); renderPreview();
}


function moveFilterWithinGroup(gi, field, dir){
  const arr = data.groups[gi].filters;
  const idx = arr.indexOf(field);
  if(idx<0) return;
  const j = idx + dir;
  if(j<0 || j>=arr.length) return;
  [arr[idx], arr[j]] = [arr[j], arr[idx]];
  save(); renderGroups(); renderPreview();
}
function moveFilterBetweenGroups(gi, field, step){
  const to = gi + step;
  if(to<0 || to>=data.groups.length) return;
  const fromArr = data.groups[gi].filters;
  const idx = fromArr.indexOf(field); if(idx<0) return;
  fromArr.splice(idx,1);
  data.groups[to].filters.push(field);
  save(); renderGroups(); renderPreview();
}

function renderFiltersTable(){
  const box=document.getElementById('filtersList'); box.innerHTML='';
  data.filters.forEach(f=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<b style="min-width:180px">${f.label}</b><span>(${f.field})</span><span style="opacity:.8">—Ç–∏–ø: ${f.type}</span>`;
    if(f.type==='select'){
      const b1=document.createElement('button'); b1.className='btn'; b1.textContent='–ó–Ω–∞—á–µ–Ω–∏—è'; b1.onclick=()=>openOptions(f.field);
      const b2=document.createElement('button'); b2.className='btn'; b2.textContent='–°–≤—è–∑–∏'; b2.onclick=()=>openRules(f.field);
      row.append(b1,b2);
    }
    box.append(row);
  });
}

// ====== Fields editor
function addField(){ data.fields.push({label:'–ü–æ–ª–µ',id:'id_'+Date.now(),type:'text'}); save(); renderFields(); renderPreview(); }
function renderFields(){
  const list=document.getElementById('fieldsList'); list.innerHTML='';
  data.fields.forEach((f,i)=>{
    const row=document.createElement('div'); row.className='item';
    const l=document.createElement('input'); l.value=f.label; l.placeholder='–ú–µ—Ç–∫–∞'; l.oninput=()=>{ data.fields[i].label=l.value; save(); };
    const id=document.createElement('input'); id.value=f.id; id.placeholder='id'; id.oninput=()=>{ data.fields[i].id=id.value; save(); };
    const sel=document.createElement('select');
    ['text','number','select','textarea'].forEach(t=>{ const o=document.createElement('option'); o.value=t;o.textContent=t;if(f.type===t)o.selected=true; sel.appendChild(o); });
    sel.onchange=()=>{ data.fields[i].type=sel.value; save(); renderPreview(); };
    const del=document.createElement('button'); del.className='btn ghost'; del.textContent='‚úñ'; del.onclick=()=>{ data.fields.splice(i,1); save(); renderFields(); renderPreview(); };
    row.append(l,id,sel,del); list.append(row);
  });
}

// ====== Layout (drag + resize + delete)
function label(t){ return ({filters:'–§–∏–ª—å—Ç—Ä—ã', map:'–ö–∞—Ä—Ç–∞', form:'–§–æ—Ä–º–∞', cards:'–°–ø–∏—Å–æ–∫', table:'–¢–∞–±–ª–∏—Ü–∞'})[t] || t; }
function addBlock(type){
  const nextY = data.layout.length ? Math.max(...data.layout.map(b=>b.y+b.h-1))+1 : 1;
  data.layout.push({id:Date.now(), type, x:1, y:nextY, w:6, h:2});
  save(); renderLayout();
}
function removeBlock(i){ data.layout.splice(i,1); save(); renderLayout(); renderPreview(); }
function clearLayout(){ data.layout=[]; save(); renderLayout(); renderPreview(); }

let dragInfo=null, resizeInfo=null;
function pxPerCol(canvas){ const style=getComputedStyle(canvas); const gap=parseFloat(style.gap)||6; const total=canvas.clientWidth; const colW=(total-11*gap)/12; return {colW,gap}; }
function pxPerRow(canvas){ const style=getComputedStyle(canvas); const rowH=parseFloat(style.gridAutoRows)||90; const gap=parseFloat(style.gap)||6; return {rowH,gap}; }
function snapToGrid(canvas, left, top, wpx, hpx){
  const {colW,gap} = pxPerCol(canvas);
  const {rowH} = pxPerRow(canvas);
  let col = Math.round(left / (colW+gap)) + 1;
  let row = Math.round(top  / (rowH+gap)) + 1;
  let w   = Math.max(1, Math.round((wpx + gap) / (colW+gap)));
  let h   = Math.max(1, Math.round((hpx + gap) / (rowH+gap)));
  col = Math.max(1, Math.min(12, col));
  if(col + w - 1 > 12) w = 12 - col + 1;
  row = Math.max(1, row);
  return {x:col,y:row,w,h};
}

function renderLayout(){
  sanitizeLayout();

  const canvas=document.getElementById('canvas');
  canvas.innerHTML='';
  const {colW,gap}=pxPerCol(canvas);
  const {rowH}=pxPerRow(canvas);
  const rows = Math.max(1, ...data.layout.map(b=>b.y+b.h-1));
  canvas.style.height = (rows*rowH + (rows-1)*gap) + 'px';

  if(!data.layout.length){
    const p=document.createElement('div'); p.style.position='absolute'; p.style.left='12px'; p.style.top='12px'; p.style.opacity='.85'; p.textContent='–î–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫–∏ —Å –ø–∞–Ω–µ–ª–∏ –≤—ã—à–µ';
    canvas.appendChild(p);
  }

  data.layout.forEach((b,i)=>{
    const el=document.createElement('div'); el.className='block';
    const left = (b.x-1)*(colW+gap);
    const top  = (b.y-1)*(rowH+gap);
    const wpx  = b.w*colW + (b.w-1)*gap;
    const hpx  = b.h*rowH + (b.h-1)*gap;
    el.style.left = left+'px'; el.style.top = top+'px';
    el.style.width = wpx+'px'; el.style.height = hpx+'px';

    el.innerHTML = `<div class="title">${label(b.type)}</div>
                    <button class="close" title="–£–¥–∞–ª–∏—Ç—å" onclick="removeBlock(${i})">√ó</button>
                    <div class="resize" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä"></div>`;

    const title=el.querySelector('.title');
    title.onmousedown = (ev)=>{
      ev.preventDefault();
      dragInfo={i,startX:ev.clientX,startY:ev.clientY,origLeft:left,origTop:top};
      el.classList.add('dragging');
    };
    const handle=el.querySelector('.resize');
    handle.onmousedown = (ev)=>{
      ev.preventDefault();
      resizeInfo={i,startX:ev.clientX,startY:ev.clientY,origW:wpx,origH:hpx};
      el.classList.add('dragging');
    };

    canvas.appendChild(el);
  });

  document.onmousemove = (ev)=>{
    if(dragInfo){
      const canvas=document.getElementById('canvas');
      const dx=ev.clientX - dragInfo.startX;
      const dy=ev.clientY - dragInfo.startY;
      const left = Math.max(0, dragInfo.origLeft + dx);
      const top  = Math.max(0, dragInfo.origTop  + dy);
      const snap = snapToGrid(canvas,left,top, data.layout[dragInfo.i].w* (pxPerCol(canvas).colW) , data.layout[dragInfo.i].h*(pxPerRow(canvas).rowH));
      data.layout[dragInfo.i].x=snap.x; data.layout[dragInfo.i].y=snap.y;
      renderLayout();
    }else if(resizeInfo){
      const canvas=document.getElementById('canvas');
      const dx=ev.clientX - resizeInfo.startX;
      const dy=ev.clientY - resizeInfo.startY;
      const wpx = Math.max(30, resizeInfo.origW + dx);
      const hpx = Math.max(30, resizeInfo.origH + dy);
      const snap = snapToGrid(canvas,0,0,wpx,hpx);
      data.layout[resizeInfo.i].w=snap.w; data.layout[resizeInfo.i].h=snap.h;
      renderLayout();
    }
  };
  document.onmouseup = ()=>{
    if(dragInfo||resizeInfo){ save(); }
    dragInfo=null; resizeInfo=null;
    document.querySelectorAll('.block.dragging').forEach(b=>b.classList.remove('dragging'));
  };
}

// ====== Preview (renders by layout)
let previewState={};
function computeOptions(filter,state,all){
  let base=filter.options||[]; let best=null, depth=-1;
  (filter.rules||[]).forEach(r=>{
    let ok=true, d=0;
    for(let i=0;i<r.path.length;i+=2){
      const label=r.path[i], val=r.path[i+1];
      const pf=all.find(ff=>ff.label===label); if(!pf){ok=false;break;}
      if((state[pf.field]||'')!==val){ok=false;break;}
      d++;
    }
    if(ok && d>depth){best=r; depth=d;}
  });
  return best?best.options:base;
}
function resetDependents(changedField){
  const changed=byField(changedField); if(!changed) return;
  const q=[changed.label], seen=new Set();
  while(q.length){
    const lab=q.shift(); seen.add(lab);
    data.filters.forEach(f=>{
      const uses=(f.rules||[]).some(r=>{for(let i=0;i<r.path.length;i+=2){if(r.path[i]===lab) return true;} return false;});
      if(uses){ delete previewState[f.field]; if(!seen.has(f.label)) q.push(f.label); }
    });
  }
}
function previewFilters(){
  const wrap=document.createElement('div');
  data.groups.forEach(g=>{
    const row=document.createElement('div'); row.className='filters-row';
    g.filters.forEach(field=>{
      const f=byField(field); if(!f) return;
      const box=document.createElement('div'); box.className='field';
      box.innerHTML=`<label>${f.label}</label>`;
      if(f.type==='select'){
        const sel=document.createElement('select');
        const opts=computeOptions(f,previewState,data.filters);
        sel.innerHTML="<option value=''>‚Äî</option>"+opts.map(o=>`<option ${previewState[f.field]===o?'selected':''}>${o}</option>`).join('');
        sel.onchange=()=>{ previewState[f.field]=sel.value; resetDependents(f.field); renderPreview(); };
        box.appendChild(sel);
      }else if(f.type==='range'){
        box.innerHTML+=`<div class="row"><input placeholder="–æ—Ç"><input placeholder="–¥–æ"></div>`;
      }else if(f.type==='number'){
        box.innerHTML+=`<input type="number">`;
      }else{
        box.innerHTML+=`<input type="text">`;
      }
      row.append(box);
    });
    wrap.append(row);
  });
  return wrap;
}
function previewForm(){
  const c=document.createElement('div');
  data.fields.forEach(ff=>{
    const box=document.createElement('div'); box.className='field';
    box.innerHTML=`<label>${ff.label}</label>`;
    if(ff.type==='textarea') box.innerHTML+=`<textarea rows="3"></textarea>`;
    else if(ff.type==='select') box.innerHTML+=`<select><option>‚Äî</option></select>`;
    else if(ff.type==='number') box.innerHTML+=`<input type="number">`;
    else box.innerHTML+=`<input type="text">`;
    c.appendChild(box);
  });
  return c;
}
function renderPreview(){
  const box=document.getElementById('preview'); box.innerHTML='';
  const grid=document.createElement('div'); grid.className='preview-grid'; box.append(grid);
  // match height to layout rows
  const rows = data.layout.length ? Math.max(...data.layout.map(b=>b.y+b.h-1)) : 1;
  grid.style.gridTemplateColumns = 'repeat(12,1fr)';
  grid.style.gridAutoRows = '90px';
  grid.style.gap = '6px';
  grid.style.minHeight = (rows*90 + (rows-1)*6) + 'px';
  data.layout.forEach(b=>{
    const card=document.createElement('div'); card.className='preview-card';
    card.style.gridColumn=`${b.x} / span ${b.w}`; card.style.gridRow=`${b.y} / span ${b.h}`;
    if(b.type==='filters') card.append(previewFilters());
    else if(b.type==='form') card.append(previewForm());
    else if(b.type==='map') card.textContent='üó∫Ô∏è –ö–∞—Ä—Ç–∞';
    else if(b.type==='cards') card.textContent='üìã –°–ø–∏—Å–æ–∫';
    else if(b.type==='table') card.textContent='üìä –¢–∞–±–ª–∏—Ü–∞';
    grid.append(card);
  });
}

// ====== Simple modals
function openModal(title,html){
  const w=document.createElement('div');
  w.style.position='fixed';w.style.inset='0';w.style.background='rgba(0,0,0,.55)';w.style.display='flex';w.style.alignItems='center';w.style.justifyContent='center';w.style.zIndex='99';
  const card=document.createElement('div');card.style.background='#0b0f17';card.style.padding='14px';card.style.border='1px solid #263042';card.style.borderRadius='10px';card.style.maxWidth='min(1000px,96vw)';card.style.maxHeight='90vh';card.style.overflow='auto';
  card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><b>${title}</b><button class="btn ghost" id="x">–ó–∞–∫—Ä—ã—Ç—å</button></div><div>${html}</div>`;
  w.append(card); document.body.append(w); w.querySelector('#x').onclick=()=>w.remove();
}
function closeModal(){ const m=document.querySelector('body>div[style*="position: fixed"][style*="inset: 0"]'); if(m) m.remove(); }

// ====== Initial render
function renderAll(){ renderGroups(); renderFields(); renderLayout(); renderPreview(); }
renderAll();
</script>
</body>
</html>