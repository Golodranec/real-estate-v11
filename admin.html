<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Builder — Cascade Filters v5 FULL WORK + Preview FIX</title>
<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;--accent:#4aa8ff;--danger:#ef4444;--warn:#f59e0b;}
*{box-sizing:border-box}
body{margin:0;background:#0b0f16;color:#d7e2f2;font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;position:sticky;top:0;z-index:10}
.badge{padding:3px 8px;border-radius:8px;background:#6d28d9;font-weight:700}
.tabs{display:flex;gap:8px;margin-left:8px}
.tab{background:#1a2234;border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:#cfe0ff;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{padding:12px;display:grid;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.btn.warn{background:#3a2a0f;border-color:#7c5a10;color:#fde68a}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff;width:100%}
label{display:block;opacity:.9;margin-bottom:6px}
small.muted{color:#9fb0c8}
.list{display:grid;gap:10px}
.card{background:#172133;border:1px solid var(--border);border-radius:10px;padding:10px}
.card .title-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
.card h3{margin:0}
footer{padding:8px 12px;color:#9fb0c8;font-size:12px;border-top:1px solid var(--border)}
.canvas-wrap{border:1px solid var(--border);border-radius:12px;background:#0d121e;padding:6px;overflow:auto;height:62vh}
.canvas,.preview-grid{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px}
.block,.preview-card{background:#111827;border:1px solid #2b3a5a;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;position:relative}
.block header{display:flex;align-items:center;justify-content:space-between;background:#0f172a;color:#dbe8ff;padding:8px 10px;border-bottom:1px solid #2b3a5a;cursor:grab}
.block header:active{cursor:grabbing}
.block .body{padding:10px;flex:1}
.block .x{background:var(--danger);border:none;color:#fff;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}
.block .resize{position:absolute;right:6px;bottom:6px;width:14px;height:14px;border-right:3px solid #446;border-bottom:3px solid #446;cursor:nwse-resize;opacity:.8}
.block .title{font-weight:600}
.preview-card{border-color:#3a4c6b}
.p-group{border:1px solid #2a3140;border-radius:10px;padding:12px;margin-bottom:12px;background:#17202c;width:100%}
.p-title{font-size:13px;font-weight:600;margin-bottom:10px;color:#cfe0ff}
.p-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;width:100%}
.p-field{min-width:0;width:100%}
.p-field>div{display:flex;gap:8px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 8px;border-radius:8px;background:#0f1624;margin:4px}
.chip .grab{cursor:grab;font-size:12px;opacity:.7}
.chip.dragging{opacity:.5;border-style:dashed}
.dropzone{min-height:38px;border:1px dashed #334;border-radius:8px;padding:8px;background:#0c1220}
.inline{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:900px){.p-row{grid-template-columns:repeat(2,1fr)}.inline{grid-template-columns:1fr}}
.errorBox{background:#3a0f15;border:1px solid #7f1d1d;color:#fecaca;padding:10px;border-radius:8px;margin:10px 0}
.preview-section{padding:10px}
.preview-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.preview-card-item{background:#0f1624;border:1px solid #31405a;border-radius:10px;overflow:hidden}
.preview-card-item img{width:100%;height:120px;object-fit:cover;display:block;background:#223}
.preview-card-item .pc-body{padding:10px}
.preview-card-item .pc-title{font-weight:700;margin-bottom:6px}
.preview-table{width:100%;border-collapse:collapse}
.preview-table th,.preview-table td{border:1px solid #31405a;padding:8px;text-align:left}
.preview-map{display:flex;align-items:center;justify-content:center;background:#0f1624;border:1px dashed #3a4c6b;border-radius:10px;height:100%}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
</style>
</head>
<body>
<header>
  <span id="ver" class="badge">cascade-v5-full-work-preview-fix</span>
  <div class="tabs">
    <button class="tab active" data-tab="filters">Фильтры</button>
    <button class="tab" data-tab="fields">Поля</button>
    <button class="tab" data-tab="layout">Макет</button>
    <button class="tab" data-tab="preview">Предпросмотр</button>
  </div>
  <div style="margin-left:auto" class="row">
    <button id="btnExport" class="btn">Экспорт</button>
    <label class="btn"><input id="fileImport" type="file" accept=".json,.txt" style="display:none">Импорт</label>
    <button id="btnReset" class="btn danger">Сброс</button>
  </div>
</header>

<main>
  <section id="tab-filters" class="panel"></section>
  <section id="tab-fields"  class="panel" style="display:none"></section>
  <section id="tab-layout"  class="panel" style="display:none"></section>
  <section id="tab-preview" class="panel" style="display:none">
    <div class="canvas-wrap"><div id="preview" class="preview-grid"></div></div>
  </section>
</main>

<footer>build: admin_cascade_v5_full_work_preview_fix</footer>

<script>
/* Ловец ошибок */
window.addEventListener('error',e=>{
  const box=document.createElement('div');
  box.className='errorBox';
  box.textContent='Ошибка JS: '+e.message;
  document.body.prepend(box);
});

const KEY="admin_cascade_v5_full_work_preview";
let data={
  fields:[
    {label:"Категория",field:"category",type:"select",options:["Квартира","Дом","Коммерция","Земля"]},
    {label:"Подкатегория",field:"subcategory",type:"select",parent:"category",dict:{
      "Квартира":["Аренда","Продажа"],
      "Дом":["Аренда","Продажа"],
      "Коммерция":["Аренда","Продажа"],
      "Земля":["Продажа"]
    }},
    {label:"Количество комнат",field:"rooms",type:"number",visibleWhen:{category:["Квартира","Дом","Коммерция"]}},
    {label:"Тип жилья",field:"apartment_type",type:"select",parent:"subcategory",
      dict:{"Аренда":["Вторичка","Новостройка"],"Продажа":["Вторичка","Новостройка"]},
      visibleWhen:{category:"Квартира"}},
    {label:"Тип недвижимости",field:"commercial_type",type:"select",parent:"subcategory",
      dict:{"Аренда":["Офис","Склад"],"Продажа":["Магазин","Офис"]},
      visibleWhen:{category:"Коммерция"}},
    {label:"Цена",field:"price",type:"range",rangeLabels:["от","до"]},
    {label:"Площадь",field:"area",type:"range",rangeLabels:["от м²","до м²"]}
  ],
  groups:[{name:"Верхняя линия",desc:"Фильтры",filters:["category","subcategory","rooms","apartment_type","commercial_type","price","area"]}],
  layout:[
    {id:1,type:"filters",title:"Фильтры",x:1,y:1,w:12,h:5},
    {id:2,type:"form",title:"Форма",x:1,y:6,w:6,h:5},
    {id:3,type:"cards",title:"Карточки",x:7,y:6,w:6,h:5},
    {id:4,type:"table",title:"Таблица",x:1,y:11,w:12,h:5},
    {id:5,type:"map",title:"Карта",x:1,y:16,w:12,h:6}
  ]
};

let previewState={};

const demoItems=[
  {category:"Квартира",rooms:3,district:"Юнусабад",price:"$120 000",area:"85 м²",title:"Квартира, Юнусабад"},
  {category:"Дом",rooms:5,district:"Чиланзар",price:"$250 000",area:"210 м²",title:"Дом, Чиланзар"},
  {category:"Коммерция",rooms:"офис",district:"Мирзо-Улугбек",price:"$1 200/мес",area:"120 м²",title:"Офис, М.Улугбек"}
];

function save(){localStorage.setItem(KEY,JSON.stringify(data));}
function byField(name){return data.fields.find(f=>f.field===name);}
function visibleFor(f){
  if(!f.visibleWhen) return true;
  let [k,v]=Object.entries(f.visibleWhen)[0];
  if(!(k in previewState) || !previewState[k]) return false;
  if(Array.isArray(v)) return v.includes(previewState[k]);
  return previewState[k]===v;
}
function renderPreview(){
  const box=document.getElementById('preview');
  box.innerHTML='';
  data.layout.forEach(b=>{
    const el=document.createElement('div');
    el.className='block';el.style.gridColumn=b.x+'/span '+b.w;el.style.gridRow=b.y+'/span '+b.h;
    const head=document.createElement('header');head.textContent=b.title;el.appendChild(head);
    const body=document.createElement('div');body.className='body';

    if(b.type==='filters'){
      data.groups.forEach(g=>{
        const gEl=document.createElement('div');gEl.className='p-group';
        const gTitle=document.createElement('div');gTitle.className='p-title';gTitle.textContent=g.name;gEl.appendChild(gTitle);
        const row=document.createElement('div');row.className='p-row';
        g.filters.forEach(fname=>{
          const f=byField(fname);if(!f||!visibleFor(f))return;
          const wrap=document.createElement('div');wrap.className='p-field';
          const lab=document.createElement('label');lab.textContent=f.label;wrap.appendChild(lab);
          let inp;
          if(f.type==='text'||f.type==='number'){inp=document.createElement('input');inp.type=f.type;}
          else if(f.type==='select'){inp=document.createElement('select');(f.options||[]).forEach(o=>{const opt=document.createElement('option');opt.value=o;opt.textContent=o;inp.appendChild(opt);});}
          else if(f.type==='range'){inp=document.createElement('div');inp.textContent=f.rangeLabels?f.rangeLabels.join(' – '):'диапазон';}
          inp.oninput=e=>{previewState[f.field]=e.target.value;renderPreview();};
          wrap.appendChild(inp);row.appendChild(wrap);
        });
        gEl.appendChild(row);body.appendChild(gEl);
      });
    }

    if(b.type==='form'){
      const form=document.createElement('div');form.className='form-grid';
      data.fields.forEach(f=>{
        if(!visibleFor(f))return;
        const wrap=document.createElement('div');const lab=document.createElement('label');lab.textContent=f.label;wrap.appendChild(lab);
        let inp=document.createElement('input');if(f.type==='number')inp.type='number';
        wrap.appendChild(inp);form.appendChild(wrap);
      });
      body.appendChild(form);
    }

    if(b.type==='cards'){
      const grid=document.createElement('div');grid.className='preview-cards';
      demoItems.forEach(it=>{
        const c=document.createElement('div');c.className='preview-card-item';
        const ph=document.createElement('div');ph.style.height='80px';ph.style.background='#223';c.appendChild(ph);
        const cb=document.createElement('div');cb.className='pc-body';
        const t=document.createElement('div');t.className='pc-title';t.textContent=it.title;cb.appendChild(t);
        cb.innerHTML+=it.rooms+' комн. • '+it.area+' • '+it.price;
        c.appendChild(cb);grid.appendChild(c);
      });
      body.appendChild(grid);
    }

    if(b.type==='table'){
      const tbl=document.createElement('table');tbl.className='preview-table';
      const thead=document.createElement('thead');thead.innerHTML='<tr><th>Категория</th><th>Адрес</th><th>Комнаты</th><th>Площадь</th><th>Цена</th></tr>';tbl.appendChild(thead);
      const tb=document.createElement('tbody');
      demoItems.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+it.category+'</td><td>'+it.district+'</td><td>'+it.rooms+'</td><td>'+it.area+'</td><td>'+it.price+'</td>';
        tb.appendChild(tr);
      });
      tbl.appendChild(tb);body.appendChild(tbl);
    }

    if(b.type==='map'){
      const map=document.createElement('div');map.className='preview-map';map.textContent='MAP';body.appendChild(map);
    }

    el.appendChild(body);box.appendChild(el);
  });
}
document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab=btn.getAttribute('data-tab');
    ['filters','fields','layout','preview'].forEach(id=>{
      document.getElementById('tab-'+id).style.display=(id===tab)?'block':'none';
    });
    if(tab==='preview')renderPreview();
  };
});

renderPreview();
</script>
</body>
</html>
