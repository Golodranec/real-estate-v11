<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Builder v26</title>
<style>
:root{
  --bg:#0b0f16;--panel:#121826;--panel2:#172133;--text:#d7e2f2;--muted:#9fb0c8;
  --border:#273248;--accent:#4aa8ff;--danger:#ef4444;--ok:#22c55e;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;position:sticky;top:0;z-index:10}
.badge{padding:3px 8px;border-radius:8px;background:#6d28d9;font-weight:700}
.tabs{display:flex;gap:8px;margin-left:8px}
.tab{background:#1a2234;border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:#cfe0ff;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{padding:12px;display:grid;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:#3a4c6b}
.btn.ok{background:#0f3a1f;border-color:#14532d;color:#c7f9cf}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff;width:100%}
label{display:block;opacity:.9;margin-bottom:6px}

.list{display:grid;gap:10px}
.card{background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:10px}
small.muted{color:var(--muted)}

.canvas-wrap{border:1px solid var(--border);border-radius:12px;background:#0d121e;padding:6px;overflow:auto;height:60vh}
.canvas,.preview-grid{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px}
.block,.preview-card{background:#111827;border:1px solid #2b3a5a;border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
.block header{display:flex;align-items:center;justify-content:space-between;background:#0f172a;color:#dbe8ff;padding:8px 10px;border-bottom:1px solid #2b3a5a}
.block header .x{background:var(--danger);border:none;color:#fff;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}
.block .body{padding:10px;flex:1}

.preview-card{border-color:#3a4c6b}
.p-group{border:1px solid #2a3140;border-radius:10px;padding:12px;margin-bottom:12px;background:#17202c;width:100%}
.p-title{font-size:13px;font-weight:600;margin-bottom:10px;color:#cfe0ff}
.p-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;width:100%}
.p-field{min-width:0;width:100%}
.p-field>div{display:flex;gap:8px}
.toast{position:fixed;right:12px;bottom:12px;background:#0b1322;border:1px solid #33507a;color:#d7ecff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(8px);transition:all .25s;z-index:99}
.toast.show{opacity:1;transform:none}
footer{padding:8px 12px;color:#9fb0c8;font-size:12px;border-top:1px solid var(--border)}
hr.sep{border:0;border-top:1px dashed #2a3650;margin:10px 0}
</style>
</head>
<body>
<header>
  <span id="ver" class="badge">v26</span>
  <div class="tabs">
    <button class="tab active" data-tab="filters">Фильтры</button>
    <button class="tab" data-tab="fields">Поля</button>
    <button class="tab" data-tab="layout">Макет</button>
    <button class="tab" data-tab="preview">Предпросмотр</button>
  </div>
  <div style="margin-left:auto" class="row">
    <button id="btnExport" class="btn">Экспорт</button>
    <label class="btn"><input id="fileImport" type="file" accept=".json,.txt" style="display:none">Импорт</label>
  </div>
</header>

<main>
  <section id="tab-filters" class="panel">
    <div class="row" style="margin-bottom:10px">
      <button class="btn" onclick="addGroup()">+ Ряд</button>
      <button class="btn" onclick="addFilter()">+ Фильтр</button>
    </div>
    <div id="groups" class="list"></div>
  </section>

  <section id="tab-fields" class="panel" style="display:none">
    <h3>Все поля</h3>
    <div id="fields" class="list"></div>
  </section>

  <section id="tab-layout" class="panel" style="display:none">
    <div class="row" style="margin-bottom:10px">
      <button class="btn" onclick="addBlock('filters')">+ Фильтры</button>
      <button class="btn" onclick="addBlock('form')">+ Форма</button>
      <button class="btn" onclick="addBlock('map')">+ Карта</button>
      <button class="btn" onclick="addBlock('cards')">+ Список</button>
      <button class="btn" onclick="addBlock('table')">+ Таблица</button>
      <button class="btn danger" onclick="clearLayout()">Очистить</button>
    </div>
    <div class="canvas-wrap"><div id="canvas" class="canvas"></div></div>
  </section>

  <section id="tab-preview" class="panel" style="display:none">
    <div class="canvas-wrap"><div id="preview" class="preview-grid"></div></div>
  </section>

  <div id="toast" class="toast"></div>
</main>

<footer>
  build: admin-full-v26
</footer>

<script>
// ===== Config storage with migration =====
const KEY = "admin_full_cfg_v26";
(function migrate(){
  try{
    if(!localStorage.getItem(KEY)){
      const any = Object.keys(localStorage).filter(k=>k.startsWith("admin_full_cfg_")).sort().reverse();
      for(const k of any){
        const val = localStorage.getItem(k);
        if(val && val.length>10){ localStorage.setItem(KEY,val); break; }
      }
    }
  }catch(e){console.warn(e)}
})();

// ===== Data model =====
let data = {
  fields: [
    {label:"Страна", field:"country", type:"select", options:["—","Узбекистан","Казахстан"]},
    {label:"Город", field:"city", type:"select", options:["—","Ташкент","Алматы"]},
    {label:"Категория", field:"category", type:"select", options:["—","Квартира","Дом"]},
    {label:"Цена", field:"price", type:"range"}
  ],
  groups: [
    {name:"Верхняя линия", filters:["country","city","category"]},
    {name:"Нижняя линия", filters:["price"]}
  ],
  layout: [
    {id:1, type:"filters", title:"Фильтры", x:1, y:1, w:12, h:5},
    {id:2, type:"cards", title:"Список", x:7, y:6, w:6, h:6},
    {id:3, type:"map", title:"Карта", x:1, y:6, w:6, h:6}
  ]
};

// Load saved
try{
  const saved = localStorage.getItem(KEY);
  if(saved){
    const obj = JSON.parse(saved);
    if(obj && (obj.fields||obj.groups||obj.layout)) data = Object.assign(data, obj);
  }
}catch(e){console.warn("load fail",e)}

function save(){ localStorage.setItem(KEY, JSON.stringify(data)); }

// ===== Tabs =====
document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    ["filters","fields","layout","preview"].forEach(id=>{
      document.getElementById('tab-'+id).style.display = (id===tab)?"block":"none";
    });
    if(tab==="filters"){ renderGroups(); }
    if(tab==="fields"){ renderFields(); }
    if(tab==="layout"){ renderLayout(); }
    if(tab==="preview"){ renderPreview(); }
  };
});

// ===== Toast =====
function showToast(msg,type="info"){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.borderColor= type==="ok" ? "#22c55e" : (type==="err" ? "#ef4444" : "#33507a");
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1800);
}

// ===== Filters UI =====
function byField(name){ return data.fields.find(f=>f.field===name); }

function addGroup(){
  const idx = data.groups.length;
  data.groups.push({name: idx===0?"Верхняя линия":"Нижняя линия", filters:[]});
  save(); renderGroups(); renderPreview();
}
function removeGroup(i){
  data.groups.splice(i,1);
  save(); renderGroups(); renderPreview();
}

function addFilter(){
  if(!data.groups.length) addGroup();
  const n = data.fields.length+1;
  const fieldName = "field_"+n;
  data.fields.push({label:"Новый фильтр "+n, field:fieldName, type:"text"});
  data.groups[0].filters.push(fieldName);
  save(); renderGroups(); renderPreview();
}
function removeFilter(gIndex, fIndex){
  const name = data.groups[gIndex].filters[fIndex];
  // только из группы убираем (само поле оставляем в каталоге)
  data.groups[gIndex].filters.splice(fIndex,1);
  save(); renderGroups(); renderPreview();
}

function renderGroups(){
  const box=document.getElementById('groups'); box.innerHTML="";
  data.groups.forEach((g,gi)=>{
    const card=document.createElement('div'); card.className="card";
    const t=document.createElement('div');
    t.className="row"; t.innerHTML=`<h3 style="margin:0">${g.name||("Линия "+(gi+1))}</h3>`;
    const rm=document.createElement('button'); rm.className="btn danger"; rm.textContent="Удалить ряд";
    rm.onclick=()=>removeGroup(gi);
    t.appendChild(rm);
    card.appendChild(t);
    const row=document.createElement('div'); row.className="row"; row.style.flexWrap="wrap";
    g.filters.forEach((fname,fi)=>{
      const f=byField(fname);
      const chip=document.createElement('div');
      chip.style.cssText="display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 8px;border-radius:8px;background:#0f1624;margin:4px";
      chip.innerHTML=`<small>${f?f.label:fname}</small>`;
      const x=document.createElement('button'); x.className="btn danger"; x.textContent="x";
      x.onclick=()=>removeFilter(gi,fi);
      chip.appendChild(x);
      row.appendChild(chip);
    });
    card.appendChild(row);
    box.appendChild(card);
  });
}

// ===== Fields UI =====
function renderFields(){
  const box=document.getElementById('fields'); box.innerHTML="";
  data.fields.forEach((f,i)=>{
    const el=document.createElement('div'); el.className="card";
    el.innerHTML=`<div class="row"><h3 style="margin:0">${f.label}</h3><small class="muted">(${f.field})</small></div>
    <div class="row"><label>Тип</label>
    <select data-i="${i}">
      <option value="text"${f.type==='text'?' selected':''}>text</option>
      <option value="number"${f.type==='number'?' selected':''}>number</option>
      <option value="select"${f.type==='select'?' selected':''}>select</option>
      <option value="range"${f.type==='range'?' selected':''}>range</option>
    </select></div>`;
    el.querySelector('select').onchange=(e)=>{ data.fields[i].type=e.target.value; save(); renderPreview(); };
    box.appendChild(el);
  });
}

// ===== Layout UI =====
let nextId = 100;
function addBlock(type){
  const id=++nextId;
  data.layout.push({id, type, title: type==='filters'?'Фильтры':type.toUpperCase(), x:1, y:1, w:6, h:4});
  save(); renderLayout(); renderPreview();
}
function removeBlock(id){
  const i=data.layout.findIndex(b=>b.id===id);
  if(i>-1){ data.layout.splice(i,1); save(); renderLayout(); renderPreview(); }
}
function clearLayout(){
  data.layout=[]; save(); renderLayout(); renderPreview();
}

function renderLayout(){
  const grid=document.getElementById('canvas'); grid.innerHTML="";
  const rows = data.layout.length ? Math.max(...data.layout.map(b=>b.y+b.h-1)) : 1;
  grid.style.minHeight = (rows*90 + (rows-1)*6) + "px";
  data.layout.forEach(b=>{
    const card=document.createElement('div'); card.className="block";
    card.style.gridColumn=`${b.x} / span ${b.w}`;
    card.style.gridRow=`${b.y} / span ${b.h}`;
    const head=document.createElement('header'); head.innerHTML=`<span>${b.title||b.type}</span>`;
    const x=document.createElement('button'); x.className="x"; x.textContent="x"; x.title="Удалить";
    x.onclick=()=>removeBlock(b.id);
    head.appendChild(x); card.appendChild(head);
    const body=document.createElement('div'); body.className="body"; body.textContent="Секция макета";
    card.appendChild(body);
    grid.appendChild(card);
  });
}

// ===== Preview =====
const previewState = {};
function computeOptions(f){ return Array.isArray(f.options)?f.options:[]; }
function resetDependents(){}

function previewFilters(){
  const wrap=document.createElement('div');
  data.groups.forEach((g,gi)=>{
    const group=document.createElement('div'); group.className='p-group';
    const title=document.createElement('div'); title.className='p-title';
    title.textContent = g.name || (gi===0?'Верхняя линия':'Нижняя линия'); group.appendChild(title);
    const row=document.createElement('div'); row.className='p-row';
    (g.filters||[]).forEach(name=>{
      const f=byField(name); if(!f) return;
      const box=document.createElement('div'); box.className='p-field';
      const lab=document.createElement('label'); lab.textContent=f.label || f.field; box.appendChild(lab);
      if(f.type==='select'){
        const sel=document.createElement('select');
        const opts=computeOptions(f);
        sel.innerHTML = "<option value=''>—</option>"+opts.map(o=>`<option>${o}</option>`).join('');
        box.appendChild(sel);
      }else if(f.type==='range'){
        const div=document.createElement('div'); div.className='row';
        const a=document.createElement('input'); a.placeholder='от';
        const b=document.createElement('input'); b.placeholder='до';
        div.append(a,b); box.appendChild(div);
      }else if(f.type==='number'){
        const num=document.createElement('input'); num.type='number'; box.appendChild(num);
      }else{
        const t=document.createElement('input'); t.type='text'; box.appendChild(t);
      }
      row.appendChild(box);
    });
    group.appendChild(row); wrap.appendChild(group);
  });
  return wrap;
}

function renderPreview(){
  const grid=document.getElementById('preview'); grid.innerHTML="";
  const rows = data.layout.length ? Math.max(...data.layout.map(b=>b.y+b.h-1)) : 1;
  grid.style.minHeight = (rows*90 + (rows-1)*6) + "px";
  data.layout.forEach(b=>{
    const card=document.createElement('div'); card.className='preview-card';
    card.style.gridColumn=`${b.x} / span ${b.w}`;
    card.style.gridRow=`${b.y} / span ${b.h}`;
    if(b.type==='filters') card.appendChild(previewFilters());
    else {
      const ph=document.createElement('div'); ph.style.padding='10px'; ph.textContent = (b.title||b.type).toUpperCase();
      card.appendChild(ph);
    }
    grid.appendChild(card);
  });
}

// ===== Export / Import =====
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="admin-config.json"; a.click();
  showToast("Экспорт сохранен", "ok");
};
document.getElementById('fileImport').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const obj=JSON.parse(r.result);
      if(obj.fields) data.fields=obj.fields;
      if(obj.groups) data.groups=obj.groups;
      if(obj.layout) data.layout=obj.layout;
      save(); renderGroups(); renderFields(); renderLayout(); renderPreview();
      showToast("Импорт выполнен", "ok");
    }catch(err){ console.error(err); showToast("Ошибка импорта","err"); }
  };
  r.readAsText(f);
};

// Init
renderGroups(); renderFields(); renderLayout();

</script>
</body>
</html>
