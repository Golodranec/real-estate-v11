<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin ‚Äî fresh layout v2</title>
  <style>
    :root{--bg:#0f1115;--panel:#161a22;--muted:#1f2530;--line:#2a3140;--text:#e6e6e6;--accent:#5b9cff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui}
    header{padding:10px;background:var(--panel);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tabs{display:flex;gap:8px}
    .tab{padding:6px 12px;background:#2a3140;border-radius:6px;cursor:pointer}
    .tab.active{background:var(--accent);color:#fff}
    .btn{padding:6px 10px;border-radius:6px;border:1px solid #2a3140;background:#2a3140;color:#fff;cursor:pointer}
    .btn.ghost{background:transparent}
    main{display:grid;grid-template-columns:1fr 1fr;min-height:90vh}
    .panel{padding:12px;overflow:auto}
    /* Layout */
    .toolbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .canvas{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px;background:#0b0d12;border:1px dashed #333;padding:6px;min-height:60vh;border-radius:12px}
    .block{background:#1f2530;border:1px solid #2a3140;border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative;user-select:none}
    .block .close{position:absolute;top:6px;right:6px;background:#e53e3e;border:none;border-radius:50%;width:22px;height:22px;color:#fff;cursor:pointer;font-size:14px;line-height:20px;z-index:5}
    .label{opacity:.9}
    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;background:#1f2530;border:1px solid #2a3140;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(8px);transition:.2s;z-index:50}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
<header>
  <div class="tabs">
    <div class="tab" data-tab="filters">‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã</div>
    <div class="tab" data-tab="fields">üìù –ü–æ–ª—è</div>
    <div class="tab active" data-tab="layout">üñºÔ∏è –ú–∞–∫–µ—Ç</div>
    <div class="tab" data-tab="preview">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
  </div>
  <button class="btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label class="btn">–ò–º–ø–æ—Ä—Ç<input id="importInput" type="file" hidden></label>
</header>

<main>
  <section class="panel" id="filtersPanel" style="display:none">–°–µ–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Å–∫–µ–ª–µ—Ç)</section>
  <section class="panel" id="fieldsPanel" style="display:none">–°–µ–∫—Ü–∏—è –ø–æ–ª–µ–π (—Å–∫–µ–ª–µ—Ç)</section>

  <section class="panel" id="layoutPanel">
    <div class="toolbar">
      <button class="btn" onclick="addBlock('filters')">+ –§–∏–ª—å—Ç—Ä—ã</button>
      <button class="btn" onclick="addBlock('map')">+ –ö–∞—Ä—Ç–∞</button>
      <button class="btn" onclick="addBlock('form')">+ –§–æ—Ä–º–∞</button>
      <button class="btn" onclick="addBlock('cards')">+ –°–ø–∏—Å–æ–∫</button>
      <button class="btn" onclick="addBlock('table')">+ –¢–∞–±–ª–∏—Ü–∞</button>
      <button class="btn ghost" onclick="clearLayout()">–û—á–∏—Å—Ç–∏—Ç—å –º–∞–∫–µ—Ç</button>
    </div>
    <div class="canvas" id="canvas"></div>
  </section>

  <section class="panel" id="previewPanel" style="display:none">
    <div id="previewEmpty" class="label">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤</div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
const KEY="admin_fresh_cfg";
let data = JSON.parse(localStorage.getItem(KEY) || '{"groups":[],"filters":[],"fields":[],"layout":[]}');
function save(){ localStorage.setItem(KEY, JSON.stringify(data)); }

// Tabs
document.querySelectorAll('.tab').forEach(t=>t.onclick = () => {
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const id=t.dataset.tab;
  document.getElementById('filtersPanel').style.display = id==='filters' ? 'block':'none';
  document.getElementById('fieldsPanel').style.display  = id==='fields'  ? 'block':'none';
  document.getElementById('layoutPanel').style.display  = id==='layout'  ? 'block':'none';
  document.getElementById('previewPanel').style.display = id==='preview' ? 'block':'none';
  if(id==='layout') renderLayout();
  if(id==='preview') renderPreview();
});

// Export / Import with toasts
document.getElementById('exportBtn').onclick = () => {
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'config.json'; a.click();
  toast('–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
};

document.getElementById('importInput').addEventListener('change', async e => {
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const txt=await f.text();
    data=JSON.parse(txt);
    save();
    renderLayout(); renderPreview();
    toast('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
  }catch(err){ toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); }
});

function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),1500);
}

// Layout
function addBlock(type){
  const nextY = data.layout.length ? Math.max(...data.layout.map(b=>b.y+b.h-1))+1 : 1;
  data.layout.push({id:Date.now(), type, x:1, y:nextY, w:6, h:2});
  save(); renderLayout();
}
function removeBlock(i){
  data.layout.splice(i,1); save(); renderLayout(); renderPreview();
}
function clearLayout(){ data.layout=[]; save(); renderLayout(); renderPreview(); }

function renderLayout(){
  const c=document.getElementById('canvas'); c.innerHTML='';
  if(!data.layout.length){
    const p=document.createElement('div'); p.className='label'; p.style.gridColumn='1 / span 12'; p.style.gridRow='1 / span 1';
    p.textContent='–î–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫–∏ —Å –ø–∞–Ω–µ–ª–∏ –≤—ã—à–µ'; c.appendChild(p);
  }
  data.layout.forEach((b,i)=>{
    const el=document.createElement('div'); el.className='block';
    el.style.gridColumn = `${b.x} / span ${b.w}`;
    el.style.gridRow    = `${b.y} / span ${b.h}`;
    el.innerHTML = `${label(b.type)}<button class='close' title='–£–¥–∞–ª–∏—Ç—å' onclick='removeBlock(${i})'>√ó</button>`;
    c.appendChild(el);
  });
}

function label(t){ return ({filters:'–§–∏–ª—å—Ç—Ä—ã', map:'–ö–∞—Ä—Ç–∞', form:'–§–æ—Ä–º–∞', cards:'–°–ø–∏—Å–æ–∫', table:'–¢–∞–±–ª–∏—Ü–∞'})[t] || t; }

// Preview (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞)
function renderPreview(){
  const box=document.getElementById('previewPanel');
  box.innerHTML = '<div id="previewEmpty" class="label">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ–π. –ú–∞–∫–µ—Ç: '+ data.layout.length +' –±–ª–æ–∫(–æ–≤)</div>';
}

// Initial render
renderLayout();
</script>
<!-- build: admin-fresh-layout-v2 -->
</body>
</html>