<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (–¥–µ—Ä–µ–≤–æ –∑–Ω–∞—á–µ–Ω–∏–π + –º–∞–∫–µ—Ç + –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
  :root{--bg:#0f1115;--panel:#161a22;--muted:#1f2530;--line:#2a3140;--text:#e6e6e6;--accent:#5b9cff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui}
  header{padding:10px;background:var(--panel);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .tabs{display:flex;gap:8px}
  .tab{padding:6px 12px;background:#2a3140;border-radius:6px;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff}
  button{padding:6px 10px;border-radius:6px;border:1px solid transparent;cursor:pointer}
  .btn{background:var(--accent);color:#fff}
  .btn.secondary{background:#2a3140;color:#fff}
  .btn.ghost{background:transparent;border:1px solid #2a3140;color:#e6e6e6}
  main{display:grid;grid-template-columns:1fr 1fr;min-height:90vh}
  .panel{padding:12px}
  h3{margin:6px 0}
  .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .chip{padding:2px 6px;border-radius:999px;background:#2a3140;color:#cfe; font-size:12px}
  .draggable-item{display:flex;gap:6px;align-items:center;margin-bottom:8px;padding:8px;background:var(--muted);border:1px solid var(--line);border-radius:8px;flex-wrap:wrap}
  .draggable-item input,.draggable-item select{padding:6px;border-radius:6px;border:1px solid #333;background:#111722;color:#fff;min-width:120px}
  .draggable-item button{background:#2a3140;color:#fff;border:1px solid #3b4252;border-radius:6px;padding:6px 10px}
  .tree-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .tree-card{width:min(900px,96vw);max-height:90vh;overflow:auto;background:#0b0f17;border:1px solid #263042;border-radius:12px;padding:14px}
  .tree-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .tree{padding-left:0}
  .tree ul{list-style:none;margin:0;padding-left:18px;border-left:1px dashed #334}
  .tree li{margin:6px 0;position:relative}
  .tree li::before{content:"";position:absolute;left:-10px;top:10px;width:10px;height:1px;background:#334}
  .node{display:flex;gap:6px;align-items:center}
  .node input{padding:6px;border-radius:6px;border:1px solid #333;background:#111722;color:#fff;min-width:180px}
  .node .btn{padding:4px 8px}
  .canvas{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:80px;gap:6px;background:#0b0d12;border:1px dashed #333;padding:6px;min-height:70vh;border-radius:12px}
  .block{background:#1f2530;border:1px solid #2a3140;border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative;user-select:none}
  .block.drag{opacity:.7;outline:1px dashed #8fb2ff}
  .resize{position:absolute;right:0;bottom:0;width:12px;height:12px;cursor:se-resize;background:var(--accent);border-top-left-radius:3px;border-bottom-right-radius:9px}
  .toolbar{position:absolute;top:4px;right:4px;display:flex;gap:4px}
  .toolbar button{padding:2px 6px}
  .preview-grid{display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:80px;gap:6px;background:#0b0d12;border:1px solid #2a3140;padding:6px;border-radius:12px}
  .preview-block{background:#1a202c;border:1px solid #2a3140;border-radius:10px;padding:10px;overflow:auto}
  .field{margin-bottom:8px}
  .field label{font-size:12px;display:block;margin-bottom:4px;color:#cfd8e3}
  .field input,.field select,.field textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#111722;color:#fff}
</style>
</head>
<body>
<header>
  <div class="tabs">
    <div class="tab active" data-tab="content">‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–ª—è</div>
    <div class="tab" data-tab="layout">üñºÔ∏è –ú–∞–∫–µ—Ç</div>
    <div class="tab" data-tab="preview">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
  </div>
  <button class="btn secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
  <label class="btn secondary">–ò–º–ø–æ—Ä—Ç<input id="importInput" type="file" hidden></label>
  <button class="btn ghost" id="resetBtn">–°–±—Ä–æ—Å</button>
  <span class="chip">Drag & resize –≤–∫–ª—é—á–µ–Ω—ã</span>
</header>

<main>
  <!-- –§–ò–õ–¨–¢–†–´ –ò –ü–û–õ–Ø -->
  <section class="panel" id="contentPanel">
    <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
    <div id="filtersList"></div>
    <div class="row">
      <button class="btn" onclick="addFilter()">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
      <span class="chip">–¢–∏–ø—ã: select, range, text, number, tree-select</span>
    </div>
    <hr>
    <h3>–ü–æ–ª—è —Ñ–æ—Ä–º—ã</h3>
    <div id="fieldsList"></div>
    <button class="btn" onclick="addField()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
  </section>

  <!-- –ú–ê–ö–ï–¢ -->
  <section class="panel" id="layoutPanel" style="display:none">
    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞–∫–µ—Ç–∞</h3>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" onclick="addBlock('filters')">–§–∏–ª—å—Ç—Ä—ã</button>
      <button class="btn" onclick="addBlock('map')">–ö–∞—Ä—Ç–∞</button>
      <button class="btn" onclick="addBlock('form')">–§–æ—Ä–º–∞</button>
      <button class="btn" onclick="addBlock('cards')">–°–ø–∏—Å–æ–∫</button>
      <button class="btn" onclick="addBlock('table')">–¢–∞–±–ª–∏—Ü–∞</button>
      <button class="btn" onclick="addBlock('banner')">–†–µ–∫–ª–∞–º–∞</button>
      <button class="btn" onclick="addBlock('gallery')">–ì–∞–ª–µ—Ä–µ—è</button>
    </div>
    <div class="canvas" id="canvas"></div>
  </section>

  <!-- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† -->
  <section class="panel" id="previewPanel" style="display:none">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div class="preview-grid" id="preview"></div>
  </section>
</main>

<!-- –ú–û–î–ê–õ–ö–ê –î–ï–†–ï–í–ê -->
<div class="tree-modal" id="treeModal">
  <div class="tree-card">
    <div class="tree-header">
      <div class="row"><strong>–ó–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞:</strong> <span id="treeTitle" class="chip"></span></div>
      <div class="row">
        <button class="btn" onclick="addRootNode()">–î–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</button>
        <button class="btn ghost" onclick="closeTree()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div class="tree" id="treeContainer"></div>
  </div>
</div>

<script>
/* ===== –±–∞–∑–∞ ===== */
const KEY="admin_tree_layout_preview_v1";
const COLS=12, ROW=80, GAP=6;

let data = load() || {
  filtersConfig: [
    // –ø—Ä–∏–º–µ—Ä —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    { label:"–ì–æ—Ä–æ–¥/–†–∞–π–æ–Ω/–£–ª–∏—Ü–∞", field:"geo", type:"tree-select",
      tree:[
        { value:"–¢–∞—à–∫–µ–Ω—Ç", children:[
          { value:"–Æ–Ω—É—Å–∞–±–∞–¥", children:[ {value:"–ê–±–∞–π"}, {value:"–ú—É–∫–∏–º–∏"} ] },
          { value:"–ß–∏–ª–∞–Ω–∑–∞—Ä", children:[ {value:"–ë–µ—Ä—É–Ω–∏"}, {value:"–ì–∞–≥–∞—Ä–∏–Ω–∞"} ] }
        ]},
        { value:"–°–∞–º–∞—Ä–∫–∞–Ω–¥", children:[
          { value:"–†–µ–≥–∏—Å—Ç–∞–Ω", children:[ {value:"–ù–∞–≤–æ–∏"} ] },
          { value:"–ê—Ñ—Ä–æ—Å–∏—ë–±", children:[ {value:"–ê–º–∏—Ä –¢–µ–º—É—Ä"} ] }
        ]}
      ]
    },
    { label:"–¶–µ–Ω–∞", field:"price", type:"range" },
    { label:"–ö–æ–º–Ω–∞—Ç—ã", field:"rooms", type:"select", options:["1","2","3","4","5+"] }
  ],
  formFields: [
    {label:"–ó–∞–≥–æ–ª–æ–≤–æ–∫", id:"title", type:"text"},
    {label:"–û–ø–∏—Å–∞–Ω–∏–µ", id:"description", type:"textarea"},
    {label:"–¢–µ–ª–µ—Ñ–æ–Ω", id:"phone", type:"text"}
  ],
  layout: [
    {id:1,type:"filters",x:1,y:1,w:4,h:4},
    {id:2,type:"map",x:5,y:1,w:8,h:6},
    {id:3,type:"cards",x:1,y:5,w:12,h:6}
  ]
};

let previewState = {}; // –∑–Ω–∞—á–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤/—É—Ä–æ–≤–Ω–µ–π

function save(){localStorage.setItem(KEY,JSON.stringify(data))}
function load(){try{return JSON.parse(localStorage.getItem(KEY)||"")}catch(e){return null}}
function resetAll(){localStorage.removeItem(KEY);location.reload()}

/* ===== –≤–∫–ª–∞–¥–∫–∏ ===== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const id=tab.dataset.tab;
    document.getElementById("contentPanel").style.display=id==="content"?"block":"none";
    document.getElementById("layoutPanel").style.display=id==="layout"?"block":"none";
    document.getElementById("previewPanel").style.display=id==="preview"?"block":"none";
    renderAll();
  }
});

/* ===== —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç/—Å–±—Ä–æ—Å ===== */
document.getElementById("exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="admin-config.json"; a.click();
  URL.revokeObjectURL(url);
};
document.getElementById("importInput").addEventListener("change",async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const txt=await f.text(); data=JSON.parse(txt); save(); renderAll();
});
document.getElementById("resetBtn").onclick=resetAll;

/* ===== —Ñ–∏–ª—å—Ç—Ä—ã ===== */
function addFilter(){
  data.filtersConfig.push({label:"–ù–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä",field:"field",type:"select",options:[]});
  save(); renderFilters(); renderPreview();
}
function renderFilters(){
  const list=document.getElementById("filtersList"); list.innerHTML="";
  data.filtersConfig.forEach((f,i)=>{
    const row=document.createElement("div"); row.className="draggable-item";
    row.innerHTML=`
      <input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${f.label||""}" oninput="data.filtersConfig[${i}].label=this.value;save();renderPreview()">
      <input placeholder="field (–∞–Ω–≥–ª.)" value="${f.field||""}" oninput="data.filtersConfig[${i}].field=this.value;save();renderPreview()">
      <select onchange="data.filtersConfig[${i}].type=this.value;save();renderFilters();renderPreview()">
        <option value="select" ${f.type==='select'?'selected':''}>select (–ø—Ä–æ—Å—Ç–æ–π)</option>
        <option value="tree-select" ${f.type==='tree-select'?'selected':''}>tree-select (–∫–∞—Å–∫–∞–¥—ã)</option>
        <option value="range" ${f.type==='range'?'selected':''}>range (–æ—Ç‚Äì–¥–æ)</option>
        <option value="text" ${f.type==='text'?'selected':''}>text</option>
        <option value="number" ${f.type==='number'?'selected':''}>number</option>
      </select>
      ${f.type==='select'
        ? `<button class="btn" onclick="openFlatEditor(${i})">–ó–Ω–∞—á–µ–Ω–∏—è</button>`
        : f.type==='tree-select'
          ? `<button class="btn" onclick="openTree(${i})">–û—Ç–∫—Ä—ã—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è</button>`
          : ''
      }
      <button onclick="data.filtersConfig.splice(${i},1);save();renderFilters();renderPreview()">‚úñ</button>
    `;
    list.appendChild(row);
  });
  Sortable.create(list,{animation:150,onEnd:e=>{
    const moved=data.filtersConfig.splice(e.oldIndex,1)[0];
    data.filtersConfig.splice(e.newIndex,0,moved); save(); renderPreview();
  }});
}

/* ===== —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ select (—Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫) ===== */
function openFlatEditor(idx){
  const vals = (data.filtersConfig[idx].options||[]).join(", ");
  const res = prompt("–ó–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:", vals);
  if(res!==null){
    data.filtersConfig[idx].options = res.split(",").map(s=>s.trim()).filter(Boolean);
    save(); renderPreview();
  }
}

/* ===== —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–µ—Ä–µ–≤–∞ ===== */
let treeIdx = null;
const treeModal = document.getElementById("treeModal");
const treeContainer = document.getElementById("treeContainer");
const treeTitle = document.getElementById("treeTitle");

function openTree(idx){
  treeIdx = idx;
  const f = data.filtersConfig[idx];
  if(!f.tree) f.tree = [];
  treeTitle.textContent = f.label || f.field || '–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  renderTree();
  treeModal.style.display="flex";
}
function closeTree(){ treeModal.style.display="none"; treeIdx=null; save(); renderPreview(); }

function addRootNode(){
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:");
  if(!name) return;
  data.filtersConfig[treeIdx].tree.push({value:name, children:[]});
  save(); renderTree();
}
function addChildNode(path){
  const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∑–Ω–∞—á–µ–Ω–∏—è:");
  if(!name) return;
  const node = getNodeByPath(data.filtersConfig[treeIdx].tree, path);
  node.children = node.children || [];
  node.children.push({value:name, children:[]});
  save(); renderTree();
}
function renameNode(path){
  const node = getNodeByPath(data.filtersConfig[treeIdx].tree, path);
  const name = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:", node.value);
  if(!name) return;
  node.value = name;
  save(); renderTree();
}
function deleteNode(path){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ –≤—Å–µ–º–∏ –ø–æ–¥–∑–Ω–∞—á–µ–Ω–∏—è–º–∏?")) return;
  removeNodeByPath(data.filtersConfig[treeIdx].tree, path);
  save(); renderTree();
}

function renderTree(){
  const f = data.filtersConfig[treeIdx];
  treeContainer.innerHTML = buildTreeHTML(f.tree, []);
}
function buildTreeHTML(list, path){
  const ul = document.createElement("ul");
  (list||[]).forEach((n,idx)=>{
    const li = document.createElement("li");
    const p = path.concat(idx);
    li.innerHTML = `
      <div class="node">
        <input value="${escapeHtml(n.value)}" oninput="onInlineRename('${p.join(".")}', this.value)">
        <button class="btn" onclick="addChildNode([${p.join(",")}])">+ –ü–æ–¥–∑–Ω–∞—á–µ–Ω–∏–µ</button>
        <button class="btn secondary" onclick="renameNode([${p.join(",")}])">–ü–µ—Ä–µ–∏–º–µ–Ω.</button>
        <button class="btn ghost" onclick="deleteNode([${p.join(",")}])">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    if(n.children && n.children.length){
      const child = buildTreeHTML(n.children, p);
      li.appendChild(child);
    }
    ul.appendChild(li);
  });
  return ul.outerHTML;
}
function onInlineRename(pathStr, val){
  const path = pathStr.split(".").map(s=>+s);
  const node = getNodeByPath(data.filtersConfig[treeIdx].tree, path);
  node.value = val;
  save();
}
function getNodeByPath(list, path){
  let cur = {children:list};
  path.forEach(i=>{ cur = cur.children[i]; });
  return cur;
}
function removeNodeByPath(list, path){
  if(path.length===1){ list.splice(path[0],1); return; }
  const first = path[0];
  removeNodeByPath(list[first].children, path.slice(1));
}

/* ===== –ø–æ–ª—è —Ñ–æ—Ä–º—ã ===== */
function addField(){
  data.formFields.push({label:"–ù–æ–≤–æ–µ –ø–æ–ª–µ",id:"id",type:"text"});
  save(); renderFields(); renderPreview();
}
function renderFields(){
  const list=document.getElementById("fieldsList"); list.innerHTML="";
  data.formFields.forEach((f,i)=>{
    const row=document.createElement("div"); row.className="draggable-item";
    row.innerHTML=`
      <input placeholder="–ú–µ—Ç–∫–∞" value="${f.label||""}" oninput="data.formFields[${i}].label=this.value;save();renderPreview()">
      <input placeholder="id (–∞–Ω–≥–ª.)" value="${f.id||""}" oninput="data.formFields[${i}].id=this.value;save();renderPreview()">
      <select onchange="data.formFields[${i}].type=this.value;save();renderPreview()">
        <option value="text" ${f.type==='text'?'selected':''}>text</option>
        <option value="number" ${f.type==='number'?'selected':''}>number</option>
        <option value="select" ${f.type==='select'?'selected':''}>select</option>
        <option value="textarea" ${f.type==='textarea'?'selected':''}>textarea</option>
      </select>
      <button onclick="data.formFields.splice(${i},1);save();renderFields();renderPreview()">‚úñ</button>
    `;
    list.appendChild(row);
  });
  Sortable.create(list,{animation:150,onEnd:e=>{
    const moved=data.formFields.splice(e.oldIndex,1)[0];
    data.formFields.splice(e.newIndex,0,moved); save(); renderPreview();
  }});
}

/* ===== –º–∞–∫–µ—Ç: drag + resize ===== */
const canvas=document.getElementById("canvas");
let drag=null, size=null;

function addBlock(type){
  data.layout.push({id:Date.now(),type,x:1,y:1,w:6,h:2});
  save(); renderLayout(); renderPreview();
}
function delBlock(id){
  data.layout=data.layout.filter(b=>b.id!==id);
  save(); renderLayout(); renderPreview();
}
function renderLayout(){
  canvas.innerHTML="";
  data.layout.forEach(b=>{
    const el=document.createElement("div");
    el.className="block";
    el.style.gridColumn=`${b.x}/span ${b.w}`;
    el.style.gridRow=`${b.y}/span ${b.h}`;
    el.innerHTML=`${labelByType(b.type)}<div class="resize"></div>
      <div class="toolbar"><button onclick="delBlock(${b.id})">‚úñ</button></div>`;

    // drag
    el.addEventListener("mousedown",e=>{
      if(e.target.closest(".toolbar") || e.target.classList.contains("resize")) return;
      e.preventDefault();
      const rect=canvas.getBoundingClientRect();
      const cellW=rect.width/COLS;
      const cellH=ROW+GAP;
      drag={block:b,startX:e.clientX,startY:e.clientY,startGX:b.x,startGY:b.y,cellW,cellH,el};
      el.classList.add("drag");
      window.addEventListener("mousemove",onDragMove);
      window.addEventListener("mouseup",onDragEnd);
    });

    // resize
    el.querySelector(".resize").addEventListener("mousedown",e=>{
      e.stopPropagation();
      const rect=canvas.getBoundingClientRect();
      const cellW=rect.width/COLS;
      size={block:b,startX:e.clientX,startY:e.clientY,startW:b.w,startH:b.h,cellW};
      window.addEventListener("mousemove",onResizeMove);
      window.addEventListener("mouseup",onResizeEnd);
    });

    canvas.appendChild(el);
  });
}
function onDragMove(e){
  if(!drag) return;
  const {block,startX,startY,startGX,startGY,cellW,cellH}=drag;
  let nx=startGX + Math.round((e.clientX-startX)/cellW);
  let ny=startGY + Math.round((e.clientY-startY)/cellH);
  nx=Math.max(1,Math.min(COLS-block.w+1,nx));
  ny=Math.max(1,ny);
  block.x=nx; block.y=ny;
  save(); renderLayout();
}
function onDragEnd(){
  if(!drag) return;
  drag.el.classList.remove("drag");
  drag=null;
  window.removeEventListener("mousemove",onDragMove);
  window.removeEventListener("mouseup",onDragEnd);
  renderPreview();
}
function onResizeMove(e){
  if(!size) return;
  const {block,startX,startY,startW,startH,cellW}=size;
  let w=startW + Math.round((e.clientX-startX)/cellW);
  let h=startH + Math.round((e.clientY-startY)/ROW);
  w=Math.max(1,Math.min(COLS-block.x+1,w));
  h=Math.max(1,h);
  block.w=w; block.h=h;
  save(); renderLayout();
}
function onResizeEnd(){
  size=null;
  window.removeEventListener("mousemove",onResizeMove);
  window.removeEventListener("mouseup",onResizeEnd);
  renderPreview();
}
function labelByType(t){
  return ({
    filters:"–§–∏–ª—å—Ç—Ä—ã",
    map:"–ö–∞—Ä—Ç–∞",
    form:"–§–æ—Ä–º–∞",
    cards:"–°–ø–∏—Å–æ–∫",
    table:"–¢–∞–±–ª–∏—Ü–∞",
    banner:"–†–µ–∫–ª–∞–º–∞",
    gallery:"–ì–∞–ª–µ—Ä–µ—è"
  })[t]||t;
}

/* ===== –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ===== */
function renderPreview(){
  const wrap=document.getElementById("preview"); wrap.innerHTML="";
  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞–∫–µ—Ç–∞ (–æ—Å—Ç–∞–≤–∏–º –ø–æ-–ø—Ä–æ—Å—Ç–æ–º—É)
  // –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî —É–±–µ—Ä–∏ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É:
  // previewState = {};
  data.layout.forEach(b=>{
    const el=document.createElement("div");
    el.className="preview-block";
    el.style.gridColumn=`${b.x}/span ${b.w}`;
    el.style.gridRow=`${b.y}/span ${b.h}`;
    if(b.type==="map"){ el.innerHTML="üó∫Ô∏è –ö–∞—Ä—Ç–∞"; }
    if(b.type==="filters"){ el.innerHTML="<h4>–§–∏–ª—å—Ç—Ä—ã</h4>"; renderPreviewFilters(el); }
    if(b.type==="form"){ el.innerHTML="<h4>–§–æ—Ä–º–∞</h4>"; renderPreviewForm(el); }
    if(b.type==="cards"){ el.innerHTML="üìã –°–ø–∏—Å–æ–∫ –º–æ–∫-–æ–±—ä—è–≤–ª–µ–Ω–∏–π"; }
    if(b.type==="table"){ el.innerHTML="üìä –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"; }
    if(b.type==="banner"){ el.innerHTML="<div style='background:#223355;padding:20px;border-radius:8px'>–†–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫</div>"; }
    if(b.type==="gallery"){ el.innerHTML="<div style='display:grid;grid-template-columns:repeat(3,1fr);gap:6px'><div style='background:#333;height:60px'></div><div style='background:#333;height:60px'></div><div style='background:#333;height:60px'></div></div>"; }
    wrap.appendChild(el);
  });
}
function renderPreviewFilters(container){
  data.filtersConfig.forEach(f=>{
    if(f.type==="select"){
      const opts = (f.options||[]);
      const sel = document.createElement("select");
      sel.innerHTML = "<option value=''>‚Äî</option>" + opts.map(o=>`<option ${previewState[f.field]===o?'selected':''}>${o}</option>`).join("");
      sel.onchange = ()=>{ previewState[f.field]=sel.value; renderPreview(); };
      const box = document.createElement("div"); box.className="field";
      box.innerHTML=`<label>${f.label}</label>`;
      box.appendChild(sel); container.appendChild(box);
    }
    if(f.type==="tree-select"){
      // —Ä–∏—Å—É–µ–º –∫–∞—Å–∫–∞–¥—ã –ø–æ –¥–µ—Ä–µ–≤—É
      drawTreeSelect(container, f);
    }
    if(f.type==="range"){
      const box=document.createElement("div"); box.className="field";
      box.innerHTML=`<label>${f.label}</label><div style="display:flex;gap:6px"><input placeholder="–æ—Ç"><input placeholder="–¥–æ"></div>`;
      container.appendChild(box);
    }
    if(f.type==="text"){
      const box=document.createElement("div"); box.className="field";
      box.innerHTML=`<label>${f.label}</label><input placeholder="${f.field}">`;
      container.appendChild(box);
    }
    if(f.type==="number"){
      const box=document.createElement("div"); box.className="field";
      box.innerHTML=`<label>${f.label}</label><input type="number" placeholder="${f.field}">`;
      container.appendChild(box);
    }
  });
}
function drawTreeSelect(container, f){
  const chainKey = `tree:${f.field}`; // –∫–ª—é—á –¥–ª—è —Ü–µ–ø–æ—á–∫–∏ —É—Ä–æ–≤–Ω–µ–π
  const chain = previewState[chainKey] || []; // –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É—Ä–æ–≤–Ω—è–º
  // —Å—Ç—Ä–æ–∏–º —Å–µ–ª–µ–∫—Ç—ã –ø–æ —É—Ä–æ–≤–Ω—è–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ—Ä–µ–≤–∞
  let levelNodes = f.tree || [];
  let level = 0;
  while(levelNodes && levelNodes.length){
    // —Å–µ–ª–µ–∫—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ
    const sel = document.createElement("select");
    sel.innerHTML = "<option value=''>‚Äî</option>" + levelNodes.map(n=>`<option ${chain[level]===n.value?'selected':''}>${escapeHtml(n.value)}</option>`).join("");
    const box = document.createElement("div"); box.className="field";
    box.innerHTML = `<label>${f.label}${level?` ‚Äî —É—Ä–æ–≤–µ–Ω—å ${level+1}`:''}</label>`;
    box.appendChild(sel); container.appendChild(box);

    sel.onchange = ()=>{
      const val = sel.value || "";
      const newChain = chain.slice(0, level); // –æ–±—Ä–µ–∑–∞–µ–º –¥–æ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
      if(val) newChain[level]=val;
      previewState[chainKey]=newChain;
      renderPreview();
    };

    // –∏–¥—ë–º –≤–Ω–∏–∑ –ø–æ –¥–µ—Ä–µ–≤—É —Å–æ–≥–ª–∞—Å–Ω–æ –≤—ã–±–æ—Ä—É
    const chosen = levelNodes.find(n=>n.value===chain[level]);
    if(chosen && chosen.children && chosen.children.length){
      levelNodes = chosen.children;
      level++;
    }else{
      break;
    }
  }
}

/* ===== —Ñ–æ—Ä–º–∞ –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ ===== */
function renderPreviewForm(container){
  data.formFields.forEach(ff=>{
    const box=document.createElement("div"); box.className="field";
    box.innerHTML=`<label>${ff.label}</label>`;
    if(ff.type==="textarea") box.innerHTML+=`<textarea rows="3"></textarea>`;
    else if(ff.type==="select") box.innerHTML+=`<select><option>‚Äî</option></select>`;
    else if(ff.type==="number") box.innerHTML+=`<input type="number">`;
    else box.innerHTML+=`<input type="text">`;
    container.appendChild(box);
  });
}

/* ===== —É—Ç–∏–ª–∏—Ç—ã ===== */
function escapeHtml(s){return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
function renderAll(){ renderFilters(); renderFields(); renderLayout(); renderPreview(); }
renderAll();
</script>
</body>
</html>
