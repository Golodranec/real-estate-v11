<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Builder — Cascade Filters v4 FULL</title>
<style>
:root{
  --bg:#0b0f16;--panel:#121826;--panel2:#172133;--text:#d7e2f2;--muted:#9fb0c8;
  --border:#273248;--accent:#4aa8ff;--danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui}
header{display:flex;gap:8px;padding:10px;border-bottom:1px solid var(--border);background:#0e1420;align-items:center}
.badge{padding:3px 8px;border-radius:8px;background:#6d28d9}
.tab{background:#1a2234;border:1px solid var(--border);padding:6px 10px;border-radius:6px;color:#cfe0ff;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
.panel{padding:12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;margin:10px}
h3{margin:0 0 10px 0}
label{display:block;margin:6px 0 4px}
input,select,textarea{width:100%;padding:6px;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.p-group{margin-bottom:12px;padding:10px;border:1px solid var(--border);border-radius:8px;background:#17202c}
.p-title{font-weight:600;margin-bottom:6px}
.row{display:flex;gap:8px;flex-wrap:wrap}
button{cursor:pointer}
</style>
</head>
<body>
<header>
  <span class="badge">cascade-v4-full</span>
  <button class="tab active" data-tab="filters">Фильтры</button>
  <button class="tab" data-tab="fields">Поля</button>
  <button class="tab" data-tab="layout">Макет</button>
  <button class="tab" data-tab="preview">Предпросмотр</button>
  <div style="margin-left:auto" class="row">
    <button id="btnExport">Экспорт</button>
    <label style="cursor:pointer"><input id="fileImport" type="file" accept=".json,.txt" style="display:none">Импорт</label>
  </div>
</header>

<main>
  <section id="tab-filters" class="panel"></section>
  <section id="tab-fields" class="panel" style="display:none"></section>
  <section id="tab-layout" class="panel" style="display:none"></section>
  <section id="tab-preview" class="panel" style="display:none">
    <div id="preview"></div>
  </section>
</main>

<footer style="padding:8px;color:#9fb0c8;font-size:12px">
  build: admin_cascade_v4_full
</footer>

<script>
let data={
  fields:[
    {label:"Страна",field:"country",type:"select",options:["Узбекистан"]},
    {label:"Город",field:"city",type:"select",parent:"country",dict:{"Узбекистан":["Ташкент","Самарканд"]}},
    {label:"Район",field:"district",type:"select",parent:"city",dict:{
      "Ташкент":["Мирзо-Улугбек","Юнусабад"],"Самарканд":["Центр","Сиаб"]
    }},
    {label:"Улица/Массив",field:"street",type:"select",parent:"district",dict:{
      "Мирзо-Улугбек":["Амира Темура","Буюк Ипак"],"Юнусабад":["Юнус-1","Юнус-9"],
      "Центр":["Регистан","Навои"],"Сиаб":["Газар","Саховат"]
    }},
    {label:"Категория",field:"category",type:"select",options:["Квартира","Коммерция","Земля"]},
    {label:"Подкатегория",field:"subcategory",type:"select",parent:"category",dict:{
      "Квартира":["Аренда","Продажа"],"Коммерция":["Аренда","Продажа"],"Земля":["Продажа"]
    }},
    {label:"Тип жилья",field:"apartment_type",type:"select",parent:"subcategory",
      dict:{"Аренда":["Вторичка","Новостройка"],"Продажа":["Вторичка","Новостройка"]},
      visibleWhen:{category:"Квартира"}},
    {label:"Тип недвижимости",field:"commercial_type",type:"select",parent:"subcategory",
      dict:{"Аренда":["Офис","Склад"],"Продажа":["Магазин","Офис"]},
      visibleWhen:{category:"Коммерция"}},
    {label:"Цена",field:"price",type:"range",rangeLabels:["от","до"]},
    {label:"Площадь",field:"area",type:"range",rangeLabels:["от м²","до м²"]},
    {label:"Этаж",field:"floor",type:"range",rangeLabels:["от","до"]},
    {label:"Этажность дома",field:"floors",type:"range",rangeLabels:["от","до"]}
  ],
  groups:[
    {name:"Верхняя линия",filters:["country","city","district","street","category","subcategory","apartment_type","commercial_type","price","area","floor","floors"]}
  ]
};
let previewState={};

function byField(name){return data.fields.find(f=>f.field===name);}
function computeOptionsFor(f){
  if(f.type!=="select")return[];
  if(f.parent){let pv=previewState[f.parent]||"";return(f.dict&&f.dict[pv])?f.dict[pv]:[];}
  return f.options||[];
}
function visibleFor(f){
  if(!f.visibleWhen)return true;
  let [k,v]=Object.entries(f.visibleWhen)[0];
  if(!(k in previewState))return true;
  return previewState[k]===v;
}
function clearDescendants(parent){
  data.fields.forEach(ch=>{
    if(ch.parent===parent){delete previewState[ch.field];clearDescendants(ch.field);}
  });
}
function renderGroups(){
  const box=document.getElementById('tab-filters');box.innerHTML="";
  data.groups.forEach(g=>{
    const div=document.createElement('div');div.className="p-group";
    div.innerHTML="<div class='p-title'>"+g.name+"</div>";
    g.filters.forEach(fname=>{
      const f=byField(fname);if(!f)return;
      const lab=document.createElement('label');lab.textContent=f.label;
      div.appendChild(lab);
    });
    box.appendChild(div);
  });
}
function renderFields(){
  const box=document.getElementById('tab-fields');box.innerHTML="";
  data.fields.forEach(f=>{
    const div=document.createElement('div');div.className="p-group";
    div.innerHTML="<div class='p-title'>"+f.label+" ("+f.field+")</div>";
    box.appendChild(div);
  });
}
function renderPreview(){
  const box=document.getElementById('preview');box.innerHTML="";
  data.groups.forEach(g=>{
    const div=document.createElement('div');div.className="p-group";
    const title=document.createElement('div');title.className="p-title";title.textContent=g.name;div.appendChild(title);
    g.filters.forEach(fname=>{
      const f=byField(fname);if(!f)return;
      const wrap=document.createElement('div');wrap.style.marginBottom="6px";wrap.style.display=visibleFor(f)?"block":"none";
      const lab=document.createElement('label');lab.textContent=f.label;wrap.appendChild(lab);
      if(f.type==="select"){
        const sel=document.createElement('select');
        const opts=computeOptionsFor(f);
        sel.innerHTML="<option value=''>—</option>"+opts.map(o=>`<option>${o}</option>`).join("");
        sel.value=previewState[f.field]||"";
        sel.onchange=()=>{previewState[f.field]=sel.value;clearDescendants(f.field);renderPreview();};
        wrap.appendChild(sel);
      }else if(f.type==="range"){
        const row=document.createElement('div');row.className="row";
        const a=document.createElement('input');a.placeholder=f.rangeLabels[0];a.value=previewState[f.field+"_min"]||"";
        const b=document.createElement('input');b.placeholder=f.rangeLabels[1];b.value=previewState[f.field+"_max"]||"";
        a.oninput=()=>{previewState[f.field+"_min"]=a.value;};
        b.oninput=()=>{previewState[f.field+"_max"]=b.value;};
        row.append(a,b);wrap.appendChild(row);
      }
      div.appendChild(wrap);
    });
    box.appendChild(div);
  });
}
document.querySelectorAll(".tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    ["filters","fields","layout","preview"].forEach(id=>{
      document.getElementById("tab-"+id).style.display=(btn.dataset.tab===id)?"block":"none";
    });
    if(btn.dataset.tab==="filters")renderGroups();
    if(btn.dataset.tab==="fields")renderFields();
    if(btn.dataset.tab==="preview")renderPreview();
  };
});
document.getElementById("btnExport").onclick=()=>{
 const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
 const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="admin-cascade-v4.json";a.click();
};
document.getElementById("fileImport").onchange=e=>{
 const f=e.target.files[0];if(!f)return;const r=new FileReader();
 r.onload=()=>{try{data=JSON.parse(r.result);renderPreview();}catch(err){alert("Ошибка импорта");}};
 r.readAsText(f);
};
renderGroups();renderFields();renderPreview();
</script>
</body>
</html>