<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Админка — v13.9.5 (dev)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f1115;color:#e8eaf0;padding:20px}
    .card{background:#161a22;border:1px solid #242938;border-radius:12px;padding:16px;margin:16px 0}
    input,select,button,textarea{padding:8px;border-radius:8px;border:1px solid #242938;background:#0d1016;color:#e8eaf0}
    button{cursor:pointer}
    .btn{background:#4da3ff;color:#001428;border-color:#4da3ff}
    .danger{background:#ff6b6b;color:#fff;border-color:#ff6b6b}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    ul.tree{list-style:none;padding-left:20px}
    .muted{opacity:.8;font-size:13px}
    .save-badge{position:fixed;top:12px;right:12px;background:#4da3ff;color:#001428;padding:8px 12px;border-radius:10px;font-size:14px;opacity:0;transition:opacity .3s}
    .save-badge.show{opacity:1}
    a{color:#4da3ff}
    .field-item{display:flex;align-items:center;gap:8px;background:#0d1016;border:1px solid #242938;border-radius:8px;padding:6px;margin-bottom:6px;cursor:grab}
    .field-item input[type="text"]{flex:1}
    .field-item.dragging{opacity:.5}
  </style>
</head>
<body>
<h1>Админка <small style="opacity:.7">v13.9.5 (dev)</small></h1>
<p><a href="index.html">← к каталогу</a></p>
<div id="saveBadge" class="save-badge">Сохранено ✓</div>

<!-- Конструктор полей -->
<div class="card">
  <h3>Поля формы</h3>
  <div id="fieldsList"></div>
  <button id="resetFields" class="danger">Сбросить поля</button>
</div>

<script>
let formFields = JSON.parse(localStorage.getItem("formFields") || "null");

// дефолтные поля
const defaultFields = [
  {id:"title",   label:"Заголовок",    enabled:true},
  {id:"price",   label:"Цена",         enabled:true},
  {id:"area",    label:"Площадь, м²", enabled:true},
  {id:"rooms",   label:"Комнат",      enabled:true},
  {id:"floor",   label:"Этаж",        enabled:true},
  {id:"floors",  label:"Этажность",   enabled:true},
  {id:"year",    label:"Год постройки",enabled:true},
  {id:"address", label:"Адрес",       enabled:true}
];

if (!formFields) formFields = defaultFields;

// helpers
const $=id=>document.getElementById(id), badge=$("saveBadge");
const showSaved=()=>{ badge.classList.add("show"); setTimeout(()=>badge.classList.remove("show"),1100); };
function saveFields(){ localStorage.setItem("formFields", JSON.stringify(formFields)); showSaved(); renderFields(); }

// рендер списка полей
function renderFields(){
  const wrap=$("fieldsList"); wrap.innerHTML="";
  formFields.forEach((f,i)=>{
    const div=document.createElement("div"); div.className="field-item"; div.draggable=true;
    div.dataset.index=i;

    const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=f.enabled;
    chk.onchange=()=>{ f.enabled=chk.checked; saveFields(); };

    const inp=document.createElement("input"); inp.type="text"; inp.value=f.label;
    inp.oninput=()=>{ f.label=inp.value; saveFields(); };

    const lab=document.createElement("span"); lab.textContent=f.id; lab.style.opacity=.6;fontSize="12px";

    div.appendChild(chk); div.appendChild(inp); div.appendChild(lab);
    wrap.appendChild(div);

    // drag&drop
    div.addEventListener("dragstart",()=>{div.classList.add("dragging");});
    div.addEventListener("dragend",()=>{div.classList.remove("dragging"); updateOrder();});
  });

  wrap.addEventListener("dragover", e=>{
    e.preventDefault();
    const dragging=wrap.querySelector(".dragging");
    const after=getDragAfterElement(wrap,e.clientY);
    if(after==null) wrap.appendChild(dragging);
    else wrap.insertBefore(dragging,after);
  });
}

function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll(".field-item:not(.dragging)")];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0 && offset>closest.offset) return {offset:offset,element:child};
    else return closest;
  },{offset:Number.NEGATIVE_INFINITY}).element;
}
function updateOrder(){
  const items=[...document.querySelectorAll(".field-item")];
  formFields=items.map(item=>formFields[+item.dataset.index]);
  saveFields();
}

$("resetFields").onclick=()=>{ if(confirm("Сбросить все поля?")){ formFields=defaultFields; saveFields(); } };

// init
renderFields();
</script>
</body>
</html>
