<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Админка-конструктор + Предпросмотр</title>
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#1f2530; --text:#e6e6e6; --soft:#99a3b3; --accent:#5b9cff;
    --ok:#36c275; --warn:#f0b429; --bad:#f05353;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--accent);text-decoration:none}
  .app{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--panel);border-bottom:1px solid #202634;position:sticky;top:0;z-index:2}
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 12px;border-radius:10px;background:var(--muted);cursor:pointer;user-select:none}
  .tab.active{background:var(--accent);color:#fff}
  .actions{display:flex;gap:8px;align-items:center}
  button,.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.secondary{background:#2a3140}
  .btn.ghost{background:transparent;border:1px solid #2a3140}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid #202634;border-radius:14px;padding:12px}
  .title{font-weight:700;margin:0 0 8px 0}
  .muted{color:var(--soft)}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{background:var(--muted);padding:8px;border-radius:10px;border:1px solid #263044;display:flex;align-items:center;gap:8px}
  .item.dragging{opacity:.5}
  .handle{cursor:grab;font-size:16px;color:#8894a8}
  .grow{flex:1}
  .row{display:flex;gap:8px;align-items:center}
  .row+.row{margin-top:6px}
  input[type="text"],input[type="number"],select,textarea{
    width:100%;background:#0f131b;border:1px solid #263044;border-radius:8px;padding:8px;color:var(--text)
  }
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .divider{height:1px;background:#202634;margin:12px 0}
  /* PREVIEW */
  .preview-wrap{display:flex;flex-direction:column;gap:12px}
  .preview-bar{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .preview-surface{background:#0b0d12;border:1px dashed #2a3140;border-radius:14px;padding:12px}
  .filters-grid,.form-grid{
    display:grid;grid-template-columns:repeat(4,1fr);gap:8px
  }
  .field{background:#0f131b;border:1px solid #263044;border-radius:10px;padding:8px;position:relative}
  .field .lbl{font-size:12px;color:#aab3c2;margin-bottom:4px}
  .field input,.field select{width:100%;background:#0a0d13;border:1px solid #233049;border-radius:8px;padding:8px;color:#dfe6f3}
  .width-badge{
    position:absolute;right:6px;top:6px;font-size:11px;background:#223453;color:#cfe0ff;border:1px solid #36517a;border-radius:999px;padding:2px 6px;cursor:pointer;user-select:none
  }
  .tip{font-size:12px;color:#93a0b5}
  .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .card{background:#0f131b;border:1px solid #263044;border-radius:14px;overflow:hidden}
  .card .ph{background:#111826;height:140px}
  .card .cnt{padding:10px;display:grid;gap:6px}
  .pill{display:inline-block;background:#172235;padding:2px 8px;border-radius:999px;font-size:12px;color:#bcd1ff;border:1px solid #2b4777}
  /* width mapping */
  .w-25{grid-column:span 1}
  .w-50{grid-column:span 2}
  .w-100{grid-column:span 4}
  /* drag styles */
  .draggable{user-select:none}
  .ghost{opacity:.4}
  .empty-note{padding:10px;border:1px dashed #2b3344;border-radius:10px;background:#0d1016}
  /* small */
  @media (max-width:1000px){
    .grid{grid-template-columns:1fr}
    .cards{grid-template-columns:1fr 1fr}
    .filters-grid,.form-grid{grid-template-columns:repeat(2,1fr)}
    .w-100{grid-column:span 2}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="tabs">
      <div class="tab active" data-tab="builder">Конструктор</div>
      <div class="tab" data-tab="preview">Предпросмотр</div>
    </div>
    <div class="actions">
      <label class="btn ghost" for="importInput">Импорт JSON</label>
      <input id="importInput" type="file" accept="application/json" hidden>
      <button class="btn secondary" id="exportBtn">Экспорт JSON</button>
      <button id="resetBtn" class="btn" title="Сбросить к дефолту">Сброс</button>
      <span class="muted">Сохраняется в localStorage автоматически</span>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT BUILDER -->
    <section class="panel" id="builderPanel">
      <h3 class="title">Фильтры поиска</h3>
      <div class="tip">Перетаскивай строки за «⋮⋮». Клик по селекту «Ширина» меняет ширину в предпросмотре.</div>
      <div class="list" id="filtersList"></div>
      <div class="divider"></div>
      <div class="two">
        <select id="newFilterType">
          <option value="select">select</option>
          <option value="range">range</option>
          <option value="checkbox">checkbox</option>
        </select>
        <input id="newFilterField" type="text" placeholder="field (англ.): price, cityId, rooms..." />
      </div>
      <div class="two" style="margin-top:8px">
        <input id="newFilterLabel" type="text" placeholder="Название (для людей): Цена, Город..." />
        <select id="newFilterWidth">
          <option value="25">Ширина 25%</option>
          <option value="50">Ширина 50%</option>
          <option value="100" selected>Ширина 100%</option>
        </select>
      </div>
      <div class="three" style="margin-top:8px">
        <input id="newFilterMin" type="number" placeholder="min (для range)" />
        <input id="newFilterMax" type="number" placeholder="max (для range)" />
        <input id="newFilterStep" type="number" placeholder="шаг (для range)" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="newFilterOptions" type="text" placeholder="опции (для select/checkbox), через запятую" />
        <button id="addFilterBtn">Добавить фильтр</button>
      </div>

      <div class="divider"></div>
      <h3 class="title">Поля формы (объявление)</h3>
      <div class="list" id="fieldsList"></div>
      <div class="divider"></div>
      <div class="two">
        <select id="newFieldType">
          <option value="text">text</option>
          <option value="number">number</option>
          <option value="select">select</option>
          <option value="textarea">textarea</option>
        </select>
        <input id="newFieldId" type="text" placeholder="id (англ.): title, price, area..." />
      </div>
      <div class="two" style="margin-top:8px">
        <input id="newFieldLabel" type="text" placeholder="Метка: Заголовок, Цена..." />
        <select id="newFieldWidth">
          <option value="25">Ширина 25%</option>
          <option value="50">Ширина 50%</option>
          <option value="100" selected>Ширина 100%</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="newFieldOptions" type="text" placeholder="Опции (для select), через запятую" />
        <button id="addFieldBtn">Добавить поле</button>
      </div>
    </section>

    <!-- RIGHT PREVIEW -->
    <section class="panel" id="previewPanel" style="display:none">
      <div class="preview-wrap">
        <div class="preview-bar">
          <div class="row">
            <strong>Предпросмотр сайта</strong>
            <span class="tip">Клик по бейджу ширины на поле — переключает 25/50/100</span>
          </div>
          <div class="row">
            <button class="btn secondary" id="reloadPreview">Обновить</button>
          </div>
        </div>

        <div class="preview-surface">
          <h4 style="margin:0 0 8px">Фильтры</h4>
          <div id="filtersPreview" class="filters-grid"></div>
        </div>

        <div class="preview-surface">
          <h4 style="margin:0 0 8px">Форма добавления</h4>
          <div id="formPreview" class="form-grid"></div>
        </div>

        <div class="preview-surface">
          <h4 style="margin:0 0 8px">Результаты</h4>
          <div class="cards" id="cardsPreview"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/* ==========
   ДАННЫЕ
========== */
const DEFAULT_DATA = {
  filtersConfig: [
    {type:'select', field:'cityId', label:'Город', width:50, options:['1:Ташкент','2:Самарканд']},
    {type:'select', field:'districtId', label:'Район', width:50, options:['11:Мирзо-Улугбек','12:Юнусабад']},
    {type:'range', field:'price', label:'Цена', width:100, min:100, max:1000000, step:100},
    {type:'range', field:'rooms', label:'Комнаты', width:50, min:1, max:10, step:1},
    {type:'range', field:'floor', label:'Этаж', width:50, min:1, max:25, step:1}
  ],
  formFields: [
    {id:'title', label:'Заголовок', type:'text', width:100},
    {id:'price', label:'Цена', type:'number', width:50},
    {id:'area', label:'Площадь (м²)', type:'number', width:50},
    {id:'rooms', label:'Комнат', type:'number', width:50},
    {id:'floor', label:'Этаж', type:'number', width:50},
    {id:'cityId', label:'Город', type:'select', width:50, options:['1:Ташкент','2:Самарканд']},
    {id:'districtId', label:'Район', type:'select', width:50, options:['11:Мирзо-Улугбек','12:Юнусабад']},
    {id:'desc', label:'Описание', type:'textarea', width:100}
  ],
  demoCards: [
    {title:'2-комн в Юнусабаде', price:'78 000 у.е.', tag:'Квартира', img:true},
    {title:'Дача в Чарваке', price:'2 500 000 сум/сутки', tag:'Дача', img:true},
    {title:'3-комн Мирзо-Улугбек', price:'115 000 у.е.', tag:'Квартира', img:true},
    {title:'Дом Самарканд', price:'250 000 у.е.', tag:'Дом', img:true},
    {title:'Участок 6 соток', price:'45 000 у.е.', tag:'Земля', img:true},
    {title:'Лофт в центре', price:'900 у.е./мес', tag:'Аренда', img:true}
  ]
};

const KEY = 'builder-data-v1';
let app = load() || structuredClone(DEFAULT_DATA);

/* ==========
   УТИЛИТЫ
========== */
function save(){ localStorage.setItem(KEY, JSON.stringify(app)); }
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||''); }catch(e){ return null; } }
function reset(){ app = structuredClone(DEFAULT_DATA); save(); renderAll(); }
function widthClass(w){ return w==25?'w-25':(w==50?'w-50':'w-100'); }
function cycleWidth(w){ return w==25?50:(w==50?100:25); }

/* ==========
   UI ПЕРЕКЛЮЧЕНИЕ ТАБОВ
========== */
const tabs = document.querySelectorAll('.tab');
const builderPanel = document.getElementById('builderPanel');
const previewPanel = document.getElementById('previewPanel');
tabs.forEach(t=>{
  t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id = t.dataset.tab;
    builderPanel.style.display = (id==='builder')?'block':'none';
    previewPanel.style.display = (id==='preview')?'block':'none';
    if(id==='preview'){ renderPreview(); }
  });
});

/* ==========
   РЕНДЕР ЛЕВОЙ КОЛОНКИ (СПИСКИ)
========== */
const filtersList = document.getElementById('filtersList');
const fieldsList = document.getElementById('fieldsList');

function renderFiltersList(){
  filtersList.innerHTML = '';
  if(!app.filtersConfig.length){
    filtersList.innerHTML = `<div class="empty-note">Фильтров нет. Добавь ниже.</div>`;
    return;
  }
  app.filtersConfig.forEach((f,idx)=>{
    const el = document.createElement('div');
    el.className='item draggable';
    el.draggable=true;
    el.dataset.index=idx;
    el.innerHTML = `
      <div class="handle" title="Тяни для перестановки">⋮⋮</div>
      <div class="grow">
        <div class="row">
          <strong>${f.label||f.field}</strong>
          <span class="pill">${f.type}</span>
        </div>
        <div class="row">
          <input type="text" data-k="field" value="${f.field||''}" placeholder="field (англ.)" />
          <input type="text" data-k="label" value="${f.label||''}" placeholder="Название (рус.)" />
          <select data-k="width">
            <option value="25" ${f.width==25?'selected':''}>25%</option>
            <option value="50" ${f.width==50?'selected':''}>50%</option>
            <option value="100" ${f.width==100?'selected':''}>100%</option>
          </select>
        </div>
        ${f.type==='range' ? `
          <div class="three" style="margin-top:6px">
            <input type="number" data-k="min" value="${f.min??''}" placeholder="min" />
            <input type="number" data-k="max" value="${f.max??''}" placeholder="max" />
            <input type="number" data-k="step" value="${f.step??''}" placeholder="шаг" />
          </div>
        `:``}
        ${(f.type==='select'||f.type==='checkbox') ? `
          <div class="row" style="margin-top:6px">
            <input type="text" data-k="options" value="${(f.options||[]).join(', ')}" placeholder="опции через запятую" />
          </div>
        `:``}
      </div>
      <button class="btn ghost" data-del>×</button>
    `;
    // inputs binding
    el.querySelectorAll('input,select').forEach(inp=>{
      inp.addEventListener('input',()=>{
        const k = inp.dataset.k;
        let v = inp.value;
        if(['min','max','step','width'].includes(k)) v = Number(v||0);
        if(k==='options') v = v.split(',').map(s=>s.trim()).filter(Boolean);
        f[k]=v; save(); // live save
      });
    });
    el.querySelector('[data-del]').addEventListener('click',()=>{
      app.filtersConfig.splice(idx,1); save(); renderAll();
    });
    enableDrag(el, app.filtersConfig, renderFiltersList);
    filtersList.appendChild(el);
  });
}

function renderFieldsList(){
  fieldsList.innerHTML = '';
  if(!app.formFields.length){
    fieldsList.innerHTML = `<div class="empty-note">Полей нет. Добавь ниже.</div>`;
    return;
  }
  app.formFields.forEach((ff,idx)=>{
    const el = document.createElement('div');
    el.className='item draggable';
    el.draggable=true;
    el.dataset.index=idx;
    el.innerHTML = `
      <div class="handle" title="Тяни">⋮⋮</div>
      <div class="grow">
        <div class="row">
          <strong>${ff.label||ff.id}</strong>
          <span class="pill">${ff.type}</span>
        </div>
        <div class="row">
          <input type="text" data-k="id" value="${ff.id||''}" placeholder="id (англ.)" />
          <input type="text" data-k="label" value="${ff.label||''}" placeholder="Метка (рус.)" />
          <select data-k="width">
            <option value="25" ${ff.width==25?'selected':''}>25%</option>
            <option value="50" ${ff.width==50?'selected':''}>50%</option>
            <option value="100" ${ff.width==100?'selected':''}>100%</option>
          </select>
        </div>
        ${ff.type==='select' ? `
          <div class="row" style="margin-top:6px">
            <input type="text" data-k="options" value="${(ff.options||[]).join(', ')}" placeholder="опции через запятую" />
          </div>
        `:``}
      </div>
      <button class="btn ghost" data-del>×</button>
    `;
    el.querySelectorAll('input,select').forEach(inp=>{
      inp.addEventListener('input',()=>{
        const k = inp.dataset.k;
        let v = inp.value;
        if(k==='width') v = Number(v||0);
        if(k==='options') v = v.split(',').map(s=>s.trim()).filter(Boolean);
        ff[k]=v; save();
      });
    });
    el.querySelector('[data-del]').addEventListener('click',()=>{
      app.formFields.splice(idx,1); save(); renderAll();
    });
    enableDrag(el, app.formFields, renderFieldsList);
    fieldsList.appendChild(el);
  });
}

/* ==========
   DRAG & DROP
========== */
function enableDrag(el, arr, rerender){
  el.addEventListener('dragstart', e=>{
    el.classList.add('dragging');
    e.dataTransfer.setData('text/plain', el.dataset.index);
  });
  el.addEventListener('dragend', ()=>{
    el.classList.remove('dragging');
    rerender(); save();
  });
  el.addEventListener('dragover', e=>{
    e.preventDefault();
    const dragging = document.querySelector('.dragging');
    if(!dragging || dragging===el) return;
    const list = el.parentElement;
    const nodes = [...list.children];
    const currIndex = nodes.indexOf(el);
    const dragIndex = nodes.indexOf(dragging);
    if(currIndex > dragIndex){
      list.insertBefore(dragging, el.nextSibling);
    }else{
      list.insertBefore(dragging, el);
    }
  });
  el.addEventListener('drop', e=>{
    e.preventDefault();
    const list = el.parentElement;
    const nodes = [...list.children];
    const newOrder = nodes.map(n=>arr[Number(n.dataset.index)]);
    arr.length = 0; newOrder.forEach(x=>arr.push(x));
    save(); // rerender вызывается в dragend
  });
}

/* ==========
   КНОПКИ ДОБАВИТЬ
========== */
document.getElementById('addFilterBtn').addEventListener('click', ()=>{
  const type = document.getElementById('newFilterType').value.trim();
  const field = document.getElementById('newFilterField').value.trim();
  const label = document.getElementById('newFilterLabel').value.trim();
  const width = Number(document.getElementById('newFilterWidth').value);
  const min = Number(document.getElementById('newFilterMin').value||0);
  const max = Number(document.getElementById('newFilterMax').value||0);
  const step = Number(document.getElementById('newFilterStep').value||0);
  const optsStr = document.getElementById('newFilterOptions').value.trim();
  if(!field){ alert('Укажи field (англ.)'); return; }
  const item = {type, field, label: label||field, width: width||100};
  if(type==='range'){ item.min=min; item.max=max; item.step=step||1; }
  if(type==='select'||type==='checkbox'){ item.options = optsStr? optsStr.split(',').map(s=>s.trim()).filter(Boolean):[]; }
  app.filtersConfig.push(item); save(); renderFiltersList();
});

document.getElementById('addFieldBtn').addEventListener('click', ()=>{
  const type = document.getElementById('newFieldType').value.trim();
  const id = document.getElementById('newFieldId').value.trim();
  const label = document.getElementById('newFieldLabel').value.trim();
  const width = Number(document.getElementById('newFieldWidth').value);
  const optsStr = document.getElementById('newFieldOptions').value.trim();
  if(!id){ alert('Укажи id (англ.)'); return; }
  const item = {id, label: label||id, type, width: width||100};
  if(type==='select'){ item.options = optsStr? optsStr.split(',').map(s=>s.trim()).filter(Boolean):[]; }
  app.formFields.push(item); save(); renderFieldsList();
});

/* ==========
   ИМПОРТ / ЭКСПОРТ / СБРОС
========== */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(app,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='layout-config.json'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('importInput').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  try{
    const obj = JSON.parse(txt);
    if(obj.filtersConfig) app.filtersConfig = obj.filtersConfig;
    if(obj.formFields) app.formFields = obj.formFields;
    if(obj.demoCards) app.demoCards = obj.demoCards;
    save(); renderAll();
    // переключим на предпросмотр, чтобы сразу увидеть
    document.querySelector('.tab[data-tab="preview"]').click();
  }catch(err){
    alert('Ошибка JSON: '+err.message);
  }
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(confirm('Сбросить к дефолту?')) reset();
});

/* ==========
   ПРЕДПРОСМОТР
========== */
const filtersPreview = document.getElementById('filtersPreview');
const formPreview = document.getElementById('formPreview');
const cardsPreview = document.getElementById('cardsPreview');
document.getElementById('reloadPreview').addEventListener('click', renderPreview);

function renderPreview(){
  // Фильтры
  filtersPreview.innerHTML = '';
  for(const f of app.filtersConfig){
    const el = document.createElement('div');
    el.className = `field ${widthClass(f.width||100)}`;
    el.innerHTML = `
      <div class="width-badge" title="Клик — смена ширины">${f.width||100}%</div>
      <div class="lbl">${f.label||f.field}</div>
      ${f.type==='range' ? `
        <div class="two">
          <input type="number" placeholder="от ${f.min??''}" />
          <input type="number" placeholder="до ${f.max??''}" />
        </div>
      `: f.type==='select' ? `
        <select>${(f.options||[]).map(o=>`<option>${o}</option>`).join('')}</select>
      `: f.type==='checkbox' ? `
        <div class="row" style="flex-wrap:wrap;gap:6px">${(f.options||[]).map(o=>`<label style="display:flex;gap:6px;align-items:center;background:#0a0e15;border:1px solid #233049;padding:4px 8px;border-radius:8px"><input type="checkbox"> ${o}</label>`).join('')}</div>
      `: `
        <input type="text" placeholder="введите значение" />
      `}
    `;
    const badge = el.querySelector('.width-badge');
    badge.addEventListener('click', ()=>{
      f.width = cycleWidth(f.width||100);
      save(); renderPreview(); renderFiltersList();
    });
    filtersPreview.appendChild(el);
  }

  // Форма
  formPreview.innerHTML = '';
  for(const ff of app.formFields){
    const el = document.createElement('div');
    el.className = `field ${widthClass(ff.width||100)}`;
    el.innerHTML = `
      <div class="width-badge" title="Клик — смена ширины">${ff.width||100}%</div>
      <div class="lbl">${ff.label||ff.id}</div>
      ${ff.type==='textarea' ? `<textarea rows="3" placeholder="Введите ${ff.label||ff.id}"></textarea>` :
        ff.type==='select' ? `<select>${(ff.options||[]).map(o=>`<option>${o}</option>`).join('')}</select>` :
        `<input type="${ff.type==='number'?'number':'text'}" placeholder="Введите ${ff.label||ff.id}"/>`
      }
    `;
    el.querySelector('.width-badge').addEventListener('click', ()=>{
      ff.width = cycleWidth(ff.width||100);
      save(); renderPreview(); renderFieldsList();
    });
    formPreview.appendChild(el);
  }

  // Карточки
  cardsPreview.innerHTML = '';
  for(const c of (app.demoCards||[])){
    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `
      <div class="ph"></div>
      <div class="cnt">
        <div class="row" style="justify-content:space-between">
          <strong>${c.title}</strong>
          <span class="pill">${c.tag||'Объявление'}</span>
        </div>
        <div class="row"><span>${c.price||''}</span></div>
        <div class="row"><button class="btn secondary">Открыть</button></div>
      </div>
    `;
    cardsPreview.appendChild(el);
  }
}

/* ==========
   РЕНДЕР ВСЁ
========== */
function renderAll(){
  renderFiltersList();
  renderFieldsList();
  if(document.querySelector('.tab.active')?.dataset.tab==='preview'){
    renderPreview();
  }
}

/* init */
renderAll();
</script>
</body>
</html>
