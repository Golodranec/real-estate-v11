<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin v13.9.5 — Конструктор формы объектов</title>
<style>
  :root{
    --bg:#0f1115; --card:#161a22; --line:#242938; --text:#e8eaf0;
    --blue:#4da3ff; --chip:#242938; --green:#4dff91; --red:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;background:var(--card);padding:12px 16px;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:18px}
  .version-badge{position:fixed;right:10px;top:10px;background:var(--chip);border:1px solid var(--line);padding:4px 8px;border-radius:8px;font-size:12px;opacity:.9}
  a,button{cursor:pointer}
  .tabs{display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--line);background:linear-gradient(0deg,transparent,rgba(255,255,255,.02))}
  .tab{padding:8px 10px;border:1px solid var(--line);border-bottom:none;border-radius:8px 8px 0 0;background:var(--card);opacity:.75}
  .tab.active{opacity:1;border-color:var(--blue)}
  .container{padding:16px;display:grid;gap:16px;grid-template-columns:1fr}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  .card h2{margin:0 0 10px;font-size:16px}
  input,select,button,textarea{padding:8px;border-radius:8px;border:1px solid var(--line);background:#0d1016;color:var(--text)}
  .btn{background:var(--blue);border:1px solid var(--blue);color:#001428;font-weight:600}
  .ghost{background:transparent;border:1px solid var(--blue);color:var(--blue)}
  .danger{background:transparent;border:1px solid var(--red);color:var(--red)}
  .grid{display:grid;gap:10px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
  .row{display:flex;align-items:center;gap:8px}
  .hint{font-size:12px;opacity:.8}
  .ok{color:var(--green)} .bad{color:var(--red)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .th,.td{padding:8px;border:1px solid var(--line);background:#0d1016}
  .th{background:#0f141d;font-weight:600}
  .td:first-child,.th:first-child{border-radius:8px 0 0 8px}
  .td:last-child,.th:last-child{border-radius:0 8px 8px 0}
  .drag-handle{cursor:grab;user-select:none}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:var(--chip);font-size:12px}
  .preview-box{display:flex;flex-wrap:wrap;gap:10px}
  .field{display:flex;flex-direction:column;gap:6px;min-width:200px}
  .field label{font-size:13px;opacity:.85}
  .field .inline{display:flex;gap:8px}
  .divider{height:1px;background:var(--line);margin:10px 0}
  .sticky-footer{position:sticky;bottom:0;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:8px;display:flex;justify-content:space-between;align-items:center}
  .muted{opacity:.7}
</style>
</head>
<body>
  <header>
    <h1>Админка — конструктор формы объектов</h1>
    <div class="row">
      <span id="syncInfo" class="pill">Синхронизация: <span id="syncState" class="ok">OK</span></span>
    </div>
  </header>
  <div class="version-badge">admin v13.9.5</div>

  <nav class="tabs">
    <button class="tab active" data-tab="form">Форма объектов</button>
    <button class="tab" data-tab="filters">Фильтры</button>
    <button class="tab" data-tab="preview">Предпросмотр</button>
    <button class="tab" data-tab="data">Экспорт/импорт</button>
    <span class="pill">Хранилище: localStorage</span>
  </nav>

  <main class="container">
    <!-- ФОРМА ОБЪЕКТОВ -->
    <section id="tab-form" class="card">
      <h2>Форма объектов — включение, порядок и подписи</h2>
      <div class="toolbar">
        <button class="btn" id="addField">Добавить поле</button>
        <button class="ghost" id="resetToDefaults">Сбросить к стандартным</button>
      </div>
      <div class="divider"></div>

      <table class="table" id="fieldsTable">
        <thead>
          <tr>
            <th class="th" style="width:34px;">⇅</th>
            <th class="th" style="width:90px;">Вкл</th>
            <th class="th">Ключ</th>
            <th class="th">Метка</th>
            <th class="th" style="width:150px;">Тип</th>
            <th class="th" style="width:110px;">Обяз.</th>
            <th class="th">Значения (для select/range)</th>
            <th class="th" style="width:120px;">Действия</th>
          </tr>
        </thead>
        <tbody id="fieldsTbody"></tbody>
      </table>

      <div class="sticky-footer">
        <span class="hint">Настройки формы сохраняются автоматически в <b>objectFormConfig</b>.</span>
        <div class="row">
          <button class="ghost" id="exportConfig">Экспорт JSON</button>
          <label class="pill" style="cursor:pointer;">
            Импорт JSON
            <input type="file" id="importConfig" accept=".json" style="display:none">
          </label>
        </div>
      </div>
    </section>

    <!-- ФИЛЬТРЫ (заглушка для контекста проекта, чтобы не терять привычную структуру) -->
    <section id="tab-filters" class="card" hidden>
      <h2>Фильтры (контекст)</h2>
      <p class="muted">Этот раздел оставлен для совместимости. Основные фильтры настраиваются в твоей текущей админке. Здесь мы ничего не ломаем.</p>
      <ul class="hint">
        <li>nodeTypes — типы узлов</li>
        <li>treeNodes — дерево локаций и категорий</li>
        <li>extraParams — дополнительные параметры для фильтров</li>
      </ul>
    </section>

    <!-- ПРЕДПРОСМОТР ФОРМЫ -->
    <section id="tab-preview" class="card" hidden>
      <h2>Предпросмотр формы «Добавить объект»</h2>
      <div id="preview" class="preview-box"></div>
      <div class="divider"></div>
      <p class="hint">Это только предпросмотр рендера формы по конфигу. На боевой странице (index.html) она будет строиться так же.</p>
    </section>

    <!-- ЭКСПОРТ/ИМПОРТ ВСЕХ ДАННЫХ -->
    <section id="tab-data" class="card" hidden>
      <h2>Экспорт/импорт всех данных админки</h2>
      <div class="row" style="flex-wrap:wrap;gap:10px">
        <button class="btn" id="exportAll">Экспорт всего (ZIP не нужен, один JSON)</button>
        <label class="pill" style="cursor:pointer;">
          Импорт всего (JSON)
          <input type="file" id="importAll" accept=".json" style="display:none">
        </label>
      </div>
      <p class="hint">Включает: objectFormConfig, а также (если есть) nodeTypes, treeNodes, extraParams из localStorage.</p>
    </section>
  </main>

<script>
/* ==============================
   Admin v13.9.5 — Form Builder
   ============================== */

const LS_FORM = "objectFormConfig";
const LS_NODE_TYPES = "nodeTypes";
const LS_TREE_NODES = "treeNodes";
const LS_EXTRA_PARAMS = "extraParams";

// Стандартный набор полей формы
const DEFAULT_FIELDS = [
  { key:"title",   label:"Заголовок",     type:"text",    required:true,  enabled:true },
  { key:"address", label:"Адрес",         type:"text",    required:false, enabled:true },
  { key:"price",   label:"Цена",          type:"number",  required:false, enabled:true },
  { key:"area",    label:"Площадь, м²",   type:"number",  required:false, enabled:true },
  { key:"rooms",   label:"Комнат",        type:"number",  required:false, enabled:true },
  { key:"floor",   label:"Этаж",          type:"number",  required:false, enabled:true },
  { key:"floors",  label:"Этажность",     type:"number",  required:false, enabled:true },
  { key:"year",    label:"Год постройки", type:"number",  required:false, enabled:false },
  { key:"status",  label:"Статус",        type:"select",  required:false, enabled:true, values:["sale:Продается","rent:Сдается","exchange:Обмен"] },
  { key:"images",  label:"Фотографии",    type:"images",  required:false, enabled:true },
  { key:"coords",  label:"Координаты",    type:"coords",  required:false, enabled:true },
  // Дополнительно можно хранить каскады локации и параметры:
  { key:"location",label:"Локация (каскад)", type:"cascade", required:false, enabled:true },
  { key:"params",  label:"Параметры (чекбоксы)", type:"params", required:false, enabled:true }
];

// Состояние
let fields = loadFields();
renderFieldsTable();
renderPreview();
updateSyncPill();

/* ---------- Навигация вкладок ---------- */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.dataset.tab;
    document.querySelectorAll("main section").forEach(s=>s.hidden = true);
    document.getElementById("tab-"+id).hidden = false;
    if (id === "preview") renderPreview();
  });
});

/* ---------- Кнопки тулбара ---------- */
document.getElementById("addField").onclick = () => {
  const k = prompt("Ключ поля (латиницей, без пробелов):", "custom_" + Math.random().toString(36).slice(2,6));
  if (!k) return;
  if (fields.some(f=>f.key===k)) { alert("Поле с таким ключом уже есть"); return; }
  fields.push({ key:k, label:k, type:"text", required:false, enabled:true });
  saveFields(); renderFieldsTable();
};

document.getElementById("resetToDefaults").onclick = () => {
  if (!confirm("Сбросить конфигурацию формы к стандартной?")) return;
  fields = DEFAULT_FIELDS.map(f => ({...f}));
  saveFields(); renderFieldsTable(); renderPreview();
};

document.getElementById("exportConfig").onclick = () => {
  const blob = new Blob([JSON.stringify({objectFormConfig:fields}, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  triggerDownload(url, "objectFormConfig.json");
};

document.getElementById("importConfig").addEventListener("change", (e)=>{
  const file = e.target.files?.[0]; if (!file) return;
  const fr = new FileReader();
  fr.onload = () => {
    try {
      const json = JSON.parse(fr.result);
      if (!Array.isArray(json) && !Array.isArray(json?.objectFormConfig)) throw new Error("Неверный формат");
      fields = Array.isArray(json) ? json : json.objectFormConfig;
      saveFields(); renderFieldsTable(); renderPreview();
      alert("Импортирован objectFormConfig");
    } catch(err){
      alert("Ошибка импорта: " + err.message);
    }
  };
  fr.readAsText(file);
  e.target.value = "";
});

/* ---------- Экспорт/импорт ВСЕГО ---------- */
document.getElementById("exportAll").onclick = () => {
  const dump = {
    objectFormConfig: fields,
    nodeTypes: JSON.parse(localStorage.getItem(LS_NODE_TYPES) || "[]"),
    treeNodes: JSON.parse(localStorage.getItem(LS_TREE_NODES) || "[]"),
    extraParams: JSON.parse(localStorage.getItem(LS_EXTRA_PARAMS) || "[]"),
  };
  const blob = new Blob([JSON.stringify(dump, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  triggerDownload(url, "admin_dump_v13_9_5.json");
};

document.getElementById("importAll").addEventListener("change", (e)=>{
  const file = e.target.files?.[0]; if (!file) return;
  const fr = new FileReader();
  fr.onload = () => {
    try {
      const j = JSON.parse(fr.result);
      if (j.objectFormConfig) { fields = j.objectFormConfig; saveFields(); }
      if (j.nodeTypes)   localStorage.setItem(LS_NODE_TYPES, JSON.stringify(j.nodeTypes));
      if (j.treeNodes)   localStorage.setItem(LS_TREE_NODES, JSON.stringify(j.treeNodes));
      if (j.extraParams) localStorage.setItem(LS_EXTRA_PARAMS, JSON.stringify(j.extraParams));
      renderFieldsTable(); renderPreview(); updateSyncPill();
      alert("Импортирован полный дамп");
    } catch(err){
      alert("Ошибка импорта: " + err.message);
    }
  };
  fr.readAsText(file);
  e.target.value = "";
});

/* ---------- Таблица полей ---------- */
function renderFieldsTable(){
  const tb = document.getElementById("fieldsTbody");
  tb.innerHTML = "";
  fields.forEach((f, idx)=>{
    const tr = document.createElement("tr");
    tr.draggable = true;
    tr.dataset.index = idx;

    tr.innerHTML = `
      <td class="td" style="text-align:center"><span class="drag-handle">⠿</span></td>
      <td class="td" style="text-align:center"><input type="checkbox" ${f.enabled?"checked":""} data-action="toggleEnabled"></td>
      <td class="td"><code>${f.key}</code></td>
      <td class="td"><input type="text" value="${escapeHtml(f.label||"")}" data-action="label" style="width:100%"></td>
      <td class="td">
        <select data-action="type" style="width:100%">
          ${["text","number","textarea","select","range","images","coords","cascade","params","status"].map(t=>`<option value="${t}" ${f.type===t?"selected":""}>${t}</option>`).join("")}
        </select>
      </td>
      <td class="td" style="text-align:center"><input type="checkbox" ${f.required?"checked":""} data-action="required"></td>
      <td class="td">
        <input type="text" placeholder="для select: value:Label;value2:Label2 | для range: min,max,step" value="${escapeHtml(valuesToText(f))}" data-action="values" style="width:100%">
      </td>
      <td class="td" style="text-align:center">
        <button class="danger" data-action="remove">Удалить</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  // перетаскивание строк
  tb.querySelectorAll("tr").forEach(tr=>{
    tr.addEventListener("dragstart", onDragStart);
    tr.addEventListener("dragover", onDragOver);
    tr.addEventListener("drop", onDrop);
  });

  // обработчики полей
  tb.querySelectorAll("input,select,button").forEach(el=>{
    el.addEventListener("change", onFieldChange);
    el.addEventListener("click", onFieldChange);
  });
}

/* ---------- DnD ---------- */
let dragIndex = null;
function onDragStart(e){ dragIndex = +e.currentTarget.dataset.index; e.dataTransfer.effectAllowed = "move"; }
function onDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect = "move"; }
function onDrop(e){
  e.preventDefault();
  const toIndex = +e.currentTarget.dataset.index;
  if (dragIndex===null || dragIndex===toIndex) return;
  const item = fields.splice(dragIndex,1)[0];
  fields.splice(toIndex,0,item);
  dragIndex = null;
  saveFields(); renderFieldsTable(); renderPreview();
}

/* ---------- Обработчик изменений в строке ---------- */
function onFieldChange(e){
  const tr = e.target.closest("tr"); if (!tr) return;
  const idx = +tr.dataset.index;
  const act = e.target.dataset.action;
  if (act==="toggleEnabled"){ fields[idx].enabled = e.target.checked; }
  else if (act==="label"){ fields[idx].label = e.target.value; }
  else if (act==="type"){ fields[idx].type = e.target.value; }
  else if (act==="required"){ fields[idx].required = e.target.checked; }
  else if (act==="values"){ fields[idx] = {...fields[idx], ...textToValues(fields[idx].type, e.target.value)}; }
  else if (act==="remove"){ if (confirm("Удалить поле?")) { fields.splice(idx,1); } }
  saveFields(); renderFieldsTable(); renderPreview();
}

/* ---------- Предпросмотр ---------- */
function renderPreview(){
  const box = document.getElementById("preview");
  box.innerHTML = "";
  const active = fields.filter(f=>f.enabled);
  const wrap = document.createElement("div");
  wrap.className = "grid cols-3";

  active.forEach(f=>{
    const cell = document.createElement("div");
    cell.className = "field";
    const label = document.createElement("label");
    label.textContent = f.label || f.key;

    let control = document.createElement("input");
    control.style.width = "100%";

    switch(f.type){
      case "textarea":
        control = document.createElement("textarea");
        control.rows = 3;
        break;
      case "number":
      case "text":
        control.type = f.type;
        break;
      case "select":
      case "status":{
        control = document.createElement("select");
        const vals = f.values || [];
        vals.forEach(v=>{
          const [value, name] = splitValueLabel(v);
          const opt = document.createElement("option");
          opt.value = value; opt.textContent = name || value;
          control.appendChild(opt);
        });
        break;
      }
      case "range":{
        control = document.createElement("div");
        control.className = "inline";
        const from = document.createElement("input"); from.type="number"; from.placeholder="min";
        const to   = document.createElement("input"); to.type="number";   to.placeholder="max";
        control.appendChild(from); control.appendChild(to);
        break;
      }
      case "images":{
        const btn = document.createElement("button"); btn.textContent = "Загрузить фото"; btn.className="ghost";
        control = btn;
        break;
      }
      case "coords":{
        const btn = document.createElement("button"); btn.textContent = "Выбрать на карте"; btn.className="ghost";
        control = btn;
        break;
      }
      case "cascade":{
        control = document.createElement("div");
        control.className = "inline";
        ["Страна","Город","Район","Улица/Массив","Категория","Подкатегория"].forEach(ph=>{
          const s = document.createElement("select");
          s.innerHTML = `<option>${ph}</option>`;
          control.appendChild(s);
        });
        break;
      }
      case "params":{
        control = document.createElement("div");
        control.className = "inline";
        ["Опция 1","Опция 2","Опция 3"].forEach(t=>{
          const lbl = document.createElement("label");
          lbl.className="pill";
          lbl.innerHTML = `<input type="checkbox" style="margin-right:6px">${t}`;
          control.appendChild(lbl);
        });
        break;
      }
    }

    cell.appendChild(label);
    cell.appendChild(control);
    if (f.required){
      const req = document.createElement("span");
      req.className="hint"; req.textContent = "обязательное";
      cell.appendChild(req);
    }
    wrap.appendChild(cell);
  });

  box.appendChild(wrap);
}

/* ---------- Хранилище ---------- */
function loadFields(){
  const raw = localStorage.getItem(LS_FORM);
  if (!raw) return DEFAULT_FIELDS.map(f=>({...f}));
  try{
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) throw new Error("bad");
    // миграции на будущее: гарантия свойств
    return arr.map(f=>({ enabled:false, required:false, type:"text", label:f.key, ...f }));
  }catch{
    return DEFAULT_FIELDS.map(f=>({...f}));
  }
}
function saveFields(){
  localStorage.setItem(LS_FORM, JSON.stringify(fields));
}

/* ---------- Утилиты ---------- */
function valuesToText(f){
  if (!f || !f.type) return "";
  if (f.type==="select" || f.type==="status"){
    return (f.values||[]).join(";");
  }
  if (f.type==="range"){
    const min = f.min ?? ""; const max = f.max ?? ""; const step = f.step ?? "";
    return [min,max,step].join(",");
  }
  return "";
}
function textToValues(type, text){
  if (type==="select" || type==="status"){
    const arr = (text||"").split(";").map(s=>s.trim()).filter(Boolean);
    return { values: arr };
  }
  if (type==="range"){
    const [min,max,step] = (text||"").split(",").map(s=>s.trim());
    return { min:isFinite(+min)?+min:undefined, max:isFinite(+max)?+max:undefined, step:isFinite(+step)?+step:undefined };
  }
  return {};
}
function splitValueLabel(s){
  const i = s.indexOf(":");
  if (i===-1) return [s,s];
  return [s.slice(0,i), s.slice(i+1)];
}
function triggerDownload(url, filename){
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function escapeHtml(str=""){
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function updateSyncPill(){
  const nodeTypes = JSON.parse(localStorage.getItem(LS_NODE_TYPES) || "[]");
  const treeNodes = JSON.parse(localStorage.getItem(LS_TREE_NODES) || "[]");
  const extra     = JSON.parse(localStorage.getItem(LS_EXTRA_PARAMS) || "[]");
  const has = (nodeTypes.length || treeNodes.length || extra.length);
  document.getElementById("syncState").textContent = has ? "OK" : "пусто";
  document.getElementById("syncState").className = has ? "ok" : "bad";
}
</script>
</body>
</html>
