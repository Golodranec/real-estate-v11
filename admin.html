<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin v2 — синхронизировано со Справочником v39.30R</title>
<style>
:root{
  --bg:#0b0f16;--panel:#121826;--panel2:#172133;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;
  --accent:#4aa8ff;--danger:#ef4444;--warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
.header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tab{padding:6px 10px;border-radius:8px;border:1px solid #2b3a5a;background:#1a2234;color:#cfe0ff;cursor:pointer}
.tab.active{background:#2160ff;color:#fff;border-color:#2160ff}
.btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#1a2234;color:var(--text);cursor:pointer}
.btn:hover{border-color:var(--accent)}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.btn.warn{background:#3a2a0f;border-color:#7c5a10;color:#fde68a}
small.muted{color:var(--muted)}
main{padding:12px;display:grid;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
h3{margin:0 0 10px 0;color:#cfe0ff}
h4{margin:0 0 8px 0}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:980px){.grid-4{grid-template-columns:repeat(2,1fr)}}
@media (max-width:720px){.grid-2,.grid-3{grid-template-columns:1fr}}
label{display:block;margin-bottom:4px;color:#cfe0ff}
select,input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
hr.sep{border:0;border-top:1px solid #243048;margin:10px 0}
.kv{display:grid;grid-template-columns:180px 1fr;gap:6px}
.code{background:#0f1624;border:1px solid #31405a;border-radius:8px;padding:8px;font-family:ui-monospace,Consolas,Monaco,monospace;white-space:pre;overflow:auto;max-height:300px}
.tree{display:grid;gap:6px}
.node{padding:8px;border:1px solid #2b3a5a;border-radius:8px;background:#0f1624}
.node .ttl{font-weight:600;margin-bottom:6px}
/* Layout canvas */
.canvas-wrap{border:1px solid var(--border);border-radius:12px;background:#0d121e;padding:6px;overflow:auto;height:62vh}
.canvas{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px}
.block{background:#111827;border:1px solid #2b3a5a;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;position:relative}
.block header{display:flex;align-items:center;justify-content:space-between;background:#0f172a;color:#dbe8ff;padding:8px 10px;border-bottom:1px solid #2b3a5a;cursor:grab}
.block header:active{cursor:grabbing}
.block .body{padding:10px;flex:1}
.block .x{background:var(--danger);border:none;color:#fff;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}
.block .resize{position:absolute;right:6px;bottom:6px;width:14px;height:14px;border-right:3px solid #446;border-bottom:3px solid #446;cursor:nwse-resize;opacity:.8}
.preview-grid{display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px}
.preview-card{background:#111827;border:1px solid #3a4c6b;border-radius:10px;overflow:hidden}
.preview-section{padding:10px}
.p-group{border:1px solid #2a3140;border-radius:10px;padding:12px;margin-bottom:12px;background:#17202c}
.p-title{font-size:13px;font-weight:600;margin-bottom:10px;color:#cfe0ff}
.p-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.p-field>label{opacity:.9}
.preview-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.preview-card-item{background:#0f1624;border:1px solid #31405a;border-radius:10px;overflow:hidden}
.preview-card-item img{width:100%;height:120px;object-fit:cover;background:#223;display:block}
.preview-card-item .pc-body{padding:10px}
.preview-card-item .pc-title{font-weight:700;margin-bottom:6px}
.preview-table{width:100%;border-collapse:collapse}
.preview-table th,.preview-table td{border:1px solid #31405a;padding:8px;text-align:left}
.preview-map{display:flex;align-items:center;justify-content:center;background:#0f1624;border:1px dashed #3a4c6b;border-radius:10px;height:100%}
.err{color:#fca5a5}
.ok{color:#34d399}
</style>
</head>
<body>
<header>
  <span class="badge">admin-v2</span>
  <button class="tab active" data-tab="dict">Справочник</button>
  <button class="tab" data-tab="filters">Фильтры</button>
  <button class="tab" data-tab="fields">Поля</button>
  <button class="tab" data-tab="layout">Макет</button>
  <button class="tab" data-tab="preview">Предпросмотр</button>
  <div class="header-right">
    <span id="state" class="muted"></span>
  </div>
</header>

<main>
  <!-- DICTIONARY -->
  <section id="tab-dict" class="panel">
    <h3>Справочник (источник истины)</h3>
    <div class="grid grid-3">
      <div class="panel">
        <h4>Загрузка</h4>
        <div class="grid grid-2">
          <button id="btnDictReload" class="btn">Обновить из файла</button>
          <label class="btn"><input id="fileDict" type="file" accept=".json,.txt" style="display:none">Импорт JSON</label>
        </div>
        <hr class="sep"/>
        <div class="kv">
          <div>Источник:</div><div id="meta-load" class="muted">—</div>
          <div>Версия:</div><div id="meta-ver" class="muted">—</div>
          <div>Стран:</div><div id="meta-countries" class="muted">—</div>
          <div>Городов:</div><div id="meta-cities" class="muted">—</div>
          <div>Районов:</div><div id="meta-districts" class="muted">—</div>
          <div>Улиц/массивов:</div><div id="meta-streets" class="muted">—</div>
          <div>Категорий:</div><div id="meta-cats" class="muted">—</div>
          <div>Подкатегорий:</div><div id="meta-subcats" class="muted">—</div>
        </div>
      </div>
      <div class="panel" style="grid-column:span 2">
        <h4>Дерево</h4>
        <div id="dictTree" class="tree"></div>
      </div>
      <div class="panel" style="grid-column:span 3">
        <h4>Исходный JSON</h4>
        <pre id="dump" class="code"></pre>
      </div>
    </div>
  </section>

  <!-- FILTERS -->
  <section id="tab-filters" class="panel" style="display:none">
    <h3>Фильтры</h3>
    <div class="panel">
      <h4>Локация</h4>
      <div class="grid grid-4">
        <div><label>Страна</label><select id="country"><option value="">—</option></select></div>
        <div><label>Город</label><select id="city"><option value="">—</option></select></div>
        <div><label>Район</label><select id="district"><option value="">—</option></select></div>
        <div><label>Улица/Массив</label><select id="street"><option value="">—</option></select></div>
      </div>
    </div>
    <div class="panel">
      <h4>Фильтры объекта</h4>
      <div class="grid grid-4">
        <div><label>Категория</label><select id="category"><option value="">—</option></select></div>
        <div><label>Подкатегория</label><select id="subcategory"><option value="">—</option></select></div>
        <div><label>Цена от</label><input id="priceMin" type="number" placeholder="от"></div>
        <div><label>Цена до</label><input id="priceMax" type="number" placeholder="до"></div>
        <div><label>Площадь от</label><input id="areaMin" type="number" placeholder="от м²"></div>
        <div><label>Площадь до</label><input id="areaMax" type="number" placeholder="до м²"></div>
      </div>
    </div>
  </section>

  <!-- FIELDS (extra parameters) -->
  <section id="tab-fields" class="panel" style="display:none">
    <h3>Поля (дополнительные параметры, без локаций)</h3>
    <div class="grid grid-2">
      <div class="panel">
        <h4>Добавить поле</h4>
        <div class="grid grid-2">
          <div><label>Название</label><input id="newFieldLabel" placeholder="Напр. Этаж"></div>
          <div><label>Код</label><input id="newFieldName" placeholder="Напр. floor"></div>
          <div>
            <label>Тип</label>
            <select id="newFieldType">
              <option value="text">text</option>
              <option value="number">number</option>
              <option value="range">range</option>
              <option value="select">select</option>
            </select>
          </div>
          <div><label>Опции (для select, через запятую)</label><input id="newFieldOptions" placeholder="опция1, опция2"></div>
        </div>
        <hr class="sep"/>
        <button id="btnAddField" class="btn">+ Добавить</button>
        <small class="muted">Локации и категории не добавляются здесь — они приходят из Справочника.</small>
      </div>
      <div class="panel">
        <h4>Список полей</h4>
        <div id="extraFieldsList" class="tree"></div>
      </div>
    </div>
  </section>

  <!-- LAYOUT -->
  <section id="tab-layout" class="panel" style="display:none">
    <h3>Макет</h3>
    <div class="grid grid-3">
      <div class="panel">
        <h4>Блоки</h4>
        <div class="grid grid-2">
          <button class="btn" data-add="filters">+ Фильтры</button>
          <button class="btn" data-add="form">+ Форма</button>
          <button class="btn" data-add="cards">+ Карточки</button>
          <button class="btn" data-add="table">+ Таблица</button>
          <button class="btn" data-add="map">+ Карта</button>
        </div>
        <hr class="sep"/>
        <button id="btnAuto" class="btn warn">Авторасстановка</button>
        <button id="btnClear" class="btn danger">Очистить</button>
      </div>
      <div class="panel" style="grid-column:span 2">
        <h4>Холст</h4>
        <div class="canvas-wrap"><div id="layoutCanvas" class="canvas"></div></div>
      </div>
    </div>
  </section>

  <!-- PREVIEW -->
  <section id="tab-preview" class="panel" style="display:none">
    <h3>Предпросмотр</h3>
    <div class="canvas-wrap"><div id="preview" class="preview-grid"></div></div>
  </section>
</main>

<script>
/* ===== Constants & Keys ===== */
const SRC_URL = "/dict_v39_30R.json";
const DICT_CACHE_KEY = "dict_v39_30R_cache";
const EXTRA_FIELDS_KEY = "admin_v2_extra_fields";
const LAYOUT_KEY = "admin_v2_layout";

/* ===== State ===== */
let DICT = null;
let previewState = {};
let extraFields = [];
let layout = [];

/* ===== Helpers ===== */
const $ = sel => document.querySelector(sel);
function setState(msg, ok=true){
  const s = $("#state"); s.textContent = msg; s.className = ok ? "ok" : "err";
}
function uniq(arr){ return Array.from(new Set(arr)); }
function deepGet(obj, path, fallback){ try{ return path.reduce((a,k)=>a?.[k], obj) ?? fallback; }catch(_){ return fallback; } }
function fillOptions(select, arr, withEmpty=true){
  const v = select.value;
  select.innerHTML = (withEmpty?'<option value=\"\">—</option>':'') + (arr||[]).map(x=>`<option>${x}</option>`).join('');
  if(arr && arr.includes(v)) select.value = v;
}

/* ===== Tabs ===== */
document.querySelectorAll('button.tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('button.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('section.panel[id^=\"tab-\"]').forEach(p=>p.style.display='none');
    btn.classList.add('active');
    $('#tab-'+btn.dataset.tab).style.display='block';
    if(btn.dataset.tab==='preview') renderPreview();
    if(btn.dataset.tab==='layout') renderLayout();
  });
});

/* ===== Dictionary load + adapt ===== */
function adaptDictionary(src){
  const version = deepGet(src,['meta','version'],'v39.30R');
  let countries=[];
  let cats=[];
  // locations
  const root = deepGet(src,['locations','country'], null);
  if(root){
    const cc = Array.isArray(root)? root : [root];
    countries = cc.map(co=>({
      name: co.name || 'Страна',
      cities: (co.cities||[]).map(ci=>({
        name: ci.name,
        districts: (ci.districts||[]).map(di=>({
          name: di.name,
          streets: (di.streets||[]).map(st=> typeof st==='string'? st : (st.name||'')).filter(Boolean)
        }))
      }))
    }));
  }
  // categories
  if(Array.isArray(src?.categories)){
    cats = src.categories.map(c=>({name:c.name || c.title || '', children:(c.children||c.items||[]).map(x=> typeof x==='string'? x : (x.name||'')).filter(Boolean)}));
  }
  // fallback demo if empty
  if(countries.length===0){
    countries=[{name:'Узбекистан',cities:[{name:'Ташкент',districts:[{name:'Юнусабад',streets:['Юнус-1','Юнус-9']},{name:'Чиланзар',streets:['Чиланзар-8','Чиланзар-20']}]}]}];
  }
  if(cats.length===0){
    cats=[{name:'Квартира',children:['Аренда','Продажа']},{name:'Дом',children:['Аренда','Продажа']},{name:'Коммерция',children:['Аренда','Продажа']},{name:'Земля',children:['Продажа']}];
  }
  return {version,countries,cats,raw:src};
}

async function fetchDict(){
  $('#meta-load').textContent = 'загрузка...';
  try{
    const res = await fetch(SRC_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const raw = await res.json();
    const adapted = adaptDictionary(raw);
    localStorage.setItem(DICT_CACHE_KEY, JSON.stringify(adapted));
    $('#meta-load').textContent = 'из файла ' + SRC_URL;
    setState('справочник загружен', true);
    return adapted;
  }catch(e){
    let cached=null;
    try{ cached = JSON.parse(localStorage.getItem(DICT_CACHE_KEY)||'null'); }catch(_){}
    if(cached){
      $('#meta-load').textContent = 'из кэша (offline)';
      setState('офлайн режим', true);
      return cached;
    }
    setState('демо-данные (нет файла справочника)', false);
    return adaptDictionary({});
  }
}

function buildTreeHTML(d){
  const wrap=document.createElement('div');
  // locations
  const loc=document.createElement('div'); loc.className='node';
  loc.innerHTML='<div class=\"ttl\">Локации</div>';
  (d.countries||[]).forEach(co=>{
    const n=document.createElement('div'); n.className='node';
    n.innerHTML='<div class=\"ttl\">'+co.name+'</div>';
    (co.cities||[]).forEach(ci=>{
      const n2=document.createElement('div'); n2.className='node';
      n2.innerHTML='<div class=\"ttl\">'+ci.name+'</div>';
      (ci.districts||[]).forEach(di=>{
        const n3=document.createElement('div'); n3.className='node';
        n3.innerHTML='<div class=\"ttl\">'+di.name+'</div><div>'+ (di.streets||[]).join(', ') +'</div>';
        n2.appendChild(n3);
      });
      n.appendChild(n2);
    });
    loc.appendChild(n);
  });
  wrap.appendChild(loc);
  // categories
  const cat=document.createElement('div'); cat.className='node';
  cat.innerHTML='<div class=\"ttl\">Категории</div>';
  (d.cats||[]).forEach(c=>{
    const n=document.createElement('div'); n.className='node';
    n.innerHTML='<div class=\"ttl\">'+c.name+'</div><div>'+ (c.children||[]).join(', ') +'</div>';
    cat.appendChild(n);
  });
  wrap.appendChild(cat);
  return wrap;
}

function updateMeta(d){
  let cities=0, districts=0, streets=0;
  (d.countries||[]).forEach(co=>{
    (co.cities||[]).forEach(ci=>{
      cities++;
      (ci.districts||[]).forEach(di=>{
        districts++;
        streets += (di.streets||[]).length;
      });
    });
  });
  const subcats=(d.cats||[]).reduce((n,c)=> n + (c.children?.length||0), 0);
  $('#meta-ver').textContent = d.version || 'v39.30R';
  $('#meta-countries').textContent = (d.countries||[]).length;
  $('#meta-cities').textContent = cities;
  $('#meta-districts').textContent = districts;
  $('#meta-streets').textContent = streets;
  $('#meta-cats').textContent = (d.cats||[]).length;
  $('#meta-subcats').textContent = subcats;
  $('#dump').textContent = JSON.stringify(d.raw||{}, null, 2);
  const treeHost = $('#dictTree'); treeHost.innerHTML=''; treeHost.appendChild(buildTreeHTML(d));
}

/* ===== Filters (cascade from DICT) ===== */
function renderFiltersFromDict(){
  // country list
  const countries = uniq((DICT.countries||[]).map(c=>c.name).filter(Boolean));
  fillOptions($('#country'), countries);
  // categories
  const cats = uniq((DICT.cats||[]).map(c=>c.name).filter(Boolean));
  fillOptions($('#category'), cats);
  onCountry(); onCategory();
}
function onCountry(){
  const co=$('#country').value;
  const country=(DICT.countries||[]).find(x=>x.name===co);
  const cities=uniq((country?.cities||[]).map(x=>x.name).filter(Boolean));
  fillOptions($('#city'), cities);
  fillOptions($('#district'), []); fillOptions($('#street'), []);
}
function onCity(){
  const co=$('#country').value, ci=$('#city').value;
  const country=(DICT.countries||[]).find(x=>x.name===co);
  const city=(country?.cities||[]).find(x=>x.name===ci);
  const districts=uniq((city?.districts||[]).map(x=>x.name).filter(Boolean));
  fillOptions($('#district'), districts);
  fillOptions($('#street'), []);
}
function onDistrict(){
  const co=$('#country').value, ci=$('#city').value, di=$('#district').value;
  const country=(DICT.countries||[]).find(x=>x.name===co);
  const city=(country?.cities||[]).find(x=>x.name===ci);
  const district=(city?.districts||[]).find(x=>x.name===di);
  const streets=uniq((district?.streets||[]).filter(Boolean));
  fillOptions($('#street'), streets);
}
function onCategory(){
  const cat=$('#category').value;
  const C=(DICT.cats||[]).find(x=>x.name===cat);
  fillOptions($('#subcategory'), uniq((C?.children||[]).filter(Boolean)));
}

/* ===== Extra Fields ===== */
function loadExtraFields(){
  try{ extraFields = JSON.parse(localStorage.getItem(EXTRA_FIELDS_KEY)||'[]'); }catch(_){ extraFields = []; }
  if(!Array.isArray(extraFields)) extraFields=[];
  if(extraFields.length===0){
    extraFields=[
      {label:'Цена', field:'price', type:'range', rangeLabels:['от','до']},
      {label:'Площадь', field:'area', type:'range', rangeLabels:['от м²','до м²']},
      {label:'Комнат', field:'rooms', type:'number'}
    ];
    localStorage.setItem(EXTRA_FIELDS_KEY, JSON.stringify(extraFields));
  }
}
function saveExtraFields(){ localStorage.setItem(EXTRA_FIELDS_KEY, JSON.stringify(extraFields)); }
function renderExtraFieldsList(){
  const host=$('#extraFieldsList'); host.innerHTML='';
  extraFields.forEach((f,idx)=>{
    const div=document.createElement('div'); div.className='node';
    div.innerHTML = '<div class=\"ttl\">'+(f.label||f.field)+' <small class=\"muted\">('+f.field+', '+f.type+')</small></div>';
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px';
    const e1=document.createElement('button'); e1.className='btn'; e1.textContent='↑'; e1.onclick=()=>{ if(idx>0){ const t=extraFields[idx-1]; extraFields[idx-1]=extraFields[idx]; extraFields[idx]=t; saveExtraFields(); renderExtraFieldsList(); } };
    const e2=document.createElement('button'); e2.className='btn'; e2.textContent='↓'; e2.onclick=()=>{ if(idx<extraFields.length-1){ const t=extraFields[idx+1]; extraFields[idx+1]=extraFields[idx]; extraFields[idx]=t; saveExtraFields(); renderExtraFieldsList(); } };
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='Удалить'; del.onclick=()=>{ extraFields.splice(idx,1); saveExtraFields(); renderExtraFieldsList(); };
    row.appendChild(e1); row.appendChild(e2); row.appendChild(del);
    div.appendChild(row); host.appendChild(div);
  });
}
$('#btnAddField')?.addEventListener('click', ()=>{
  const label=$('#newFieldLabel').value.trim();
  const field=$('#newFieldName').value.trim();
  const type=$('#newFieldType').value;
  if(!label||!field){ alert('Укажи название и код'); return; }
  let f={label, field, type};
  if(type==='select'){
    const opts=$('#newFieldOptions').value.split(',').map(s=>s.trim()).filter(Boolean);
    f.options=opts;
  }
  if(type==='range') f.rangeLabels=['от','до'];
  extraFields.push(f); saveExtraFields(); renderExtraFieldsList();
  $('#newFieldLabel').value=''; $('#newFieldName').value=''; $('#newFieldOptions').value='';
});

/* ===== Layout ===== */
function loadLayout(){
  try{ layout = JSON.parse(localStorage.getItem(LAYOUT_KEY)||'[]'); }catch(_){ layout=[]; }
  if(layout.length===0){
    layout=[
      {id:1,type:'filters',title:'Фильтры',x:1,y:1,w:12,h:5},
      {id:2,type:'form',title:'Форма',x:1,y:6,w:6,h:5},
      {id:3,type:'cards',title:'Карточки',x:7,y:6,w:6,h:5},
      {id:4,type:'table',title:'Таблица',x:1,y:11,w:12,h:5},
      {id:5,type:'map',title:'Карта',x:1,y:16,w:12,h:6}
    ];
    saveLayout();
  }
}
function saveLayout(){ localStorage.setItem(LAYOUT_KEY, JSON.stringify(layout)); }
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
let dragState=null, resizeState=null, nextId=100;
function renderLayout(){
  const grid=$('#layoutCanvas'); grid.innerHTML='';
  const rows = layout.length ? Math.max(...layout.map(b=>b.y+b.h-1)) : 1;
  grid.style.minHeight=(rows*90 + (rows-1)*6) + 'px';
  layout.forEach(b=>{
    const card=document.createElement('div'); card.className='block'; card.dataset.id=b.id;
    card.style.gridColumn=b.x+'/span '+b.w; card.style.gridRow=b.y+'/span '+b.h;
    const head=document.createElement('header');
    const t=document.createElement('span'); t.textContent=b.title||b.type;
    t.ondblclick=()=>{ const nv=prompt('Название:', b.title||b.type); if(nv!=null){ b.title=nv; saveLayout(); renderLayout(); renderPreview(); } };
    const x=document.createElement('button'); x.className='x'; x.textContent='x'; x.onclick=()=>{ const i=layout.findIndex(x=>x.id===b.id); if(i>-1){ layout.splice(i,1); saveLayout(); renderLayout(); renderPreview(); } };
    head.appendChild(t); head.appendChild(x);
    head.addEventListener('mousedown', (e)=>{
      const rect=grid.getBoundingClientRect(); const colW=rect.width/12; const rowH=96;
      dragState={id:b.id,startX:e.clientX,startY:e.clientY,baseX:b.x,baseY:b.y,colW,rowH};
      document.addEventListener('mousemove', onDragMove); document.addEventListener('mouseup', onDragEnd, {once:true});
    });
    const body=document.createElement('div'); body.className='body'; body.textContent='Секция макета';
    const res=document.createElement('div'); res.className='resize';
    res.addEventListener('mousedown', (e)=>{
      e.stopPropagation(); const rect=grid.getBoundingClientRect(); const colW=rect.width/12; const rowH=96;
      resizeState={id:b.id,startX:e.clientX,startY:e.clientY,baseW:b.w,baseH:b.h,colW,rowH};
      document.addEventListener('mousemove', onResizeMove); document.addEventListener('mouseup', onResizeEnd, {once:true});
    });
    card.appendChild(head); card.appendChild(body); card.appendChild(res); grid.appendChild(card);
  });
  function onDragMove(e){
    if(!dragState) return; const b=layout.find(x=>x.id===dragState.id); if(!b) return;
    const dx=e.clientX-dragState.startX, dy=e.clientY-dragState.startY;
    let gx=Math.round(dragState.baseX + dx/dragState.colW);
    let gy=Math.round(dragState.baseY + dy/dragState.rowH);
    gx=clamp(gx,1,12-(b.w-1)); gy=clamp(gy,1,Math.max(1,gy)); b.x=gx; b.y=gy; renderLayout();
  }
  function onDragEnd(){ if(dragState){ saveLayout(); dragState=null; } document.removeEventListener('mousemove', onDragMove); }
  function onResizeMove(e){
    if(!resizeState) return; const b=layout.find(x=>x.id===resizeState.id); if(!b) return;
    const dx=e.clientX-resizeState.startX, dy=e.clientY-resizeState.startY;
    let gw=Math.round(resizeState.baseW + dx/resizeState.colW);
    let gh=Math.round(resizeState.baseH + dy/resizestate.rowH);
  }
}
/* fix typo: resizestate -> resizeState */
</script>
<script>
function onResizeMove(e){
  if(!resizeState) return; const b=layout.find(x=>x.id===resizeState.id); if(!b) return;
  const dx=e.clientX-resizeState.startX, dy=e.clientY-resizeState.startY;
  let gw=Math.round(resizeState.baseW + dx/resizeState.colW);
  let gh=Math.round(resizeState.baseH + dy/resizeState.rowH);
  gw=clamp(gw,1,12-(b.x-1)); gh=clamp(gh,1,24); b.w=gw; b.h=gh; renderLayout();
}
function onResizeEnd(){ if(resizeState){ saveLayout(); resizeState=null; } document.removeEventListener('mousemove', onResizeMove); }

document.querySelectorAll('[data-add]').forEach(b=> b.addEventListener('click', ()=>{
  const type=b.getAttribute('data-add'); const id=++nextId;
  layout.push({id,type,title:type==='filters'?'Фильтры':type.toUpperCase(),x:1,y:1,w:6,h:4});
  saveLayout(); renderLayout(); renderPreview();
}));
$('#btnAuto').addEventListener('click', ()=>{
  let col=1,row=1; layout.forEach(b=>{ b.w=6;b.h=4;b.x=col;b.y=row; col=(col===1)?7:1; if(col===1) row+=4; }); saveLayout(); renderLayout(); renderPreview();
});
$('#btnClear').addEventListener('click', ()=>{ layout=[]; saveLayout(); renderLayout(); renderPreview(); });
</script>
<script>
/* ===== Preview ===== */
const demoItems=[
  {category:'Квартира', rooms:3, district:'Юнусабад', price:'$120 000', area:'85 м²', title:'Квартира, Юнусабад', img:'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"640\" height=\"360\"><rect width=\"100%\" height=\"100%\" fill=\"%23223\"/><text x=\"50%\" y=\"50%\" fill=\"%23fff\" font-size=\"28\" text-anchor=\"middle\" dominant-baseline=\"middle\">Фото</text></svg>'},
  {category:'Дом', rooms:5, district:'Чиланзар', price:'$250 000', area:'210 м²', title:'Дом, Чиланзар', img:'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"640\" height=\"360\"><rect width=\"100%\" height=\"100%\" fill=\"%23333\"/><text x=\"50%\" y=\"50%\" fill=\"%23fff\" font-size=\"28\" text-anchor=\"middle\" dominant-baseline=\"middle\">Фото</text></svg>'},
  {category:'Коммерция', rooms:'офис', district:'Мирзо-Улугбек', price:'$1 200/мес', area:'120 м²', title:'Офис, М.Улугбек', img:'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"640\" height=\"360\"><rect width=\"100%\" height=\"100%\" fill=\"%232a2a55\"/><text x=\"50%\" y=\"50%\" fill=\"%23fff\" font-size=\"28\" text-anchor=\"middle\" dominant-baseline=\"middle\">Фото</text></svg>'}
];

function renderPreview(){
  const grid=$('#preview'); grid.innerHTML='';
  const rows = layout.length ? Math.max.apply(null, layout.map(b=>b.y+b.h-1)) : 1;
  grid.style.minHeight=(rows*90 + (rows-1)*6) + 'px';

  layout.forEach(b=>{
    const card=document.createElement('div'); card.className='preview-card';
    card.style.gridColumn=b.x+' / span '+b.w; card.style.gridRow=b.y+' / span '+b.h;
    const section=document.createElement('div'); section.className='preview-section';

    if(b.type==='filters'){
      const g1=document.createElement('div'); g1.className='p-group';
      g1.innerHTML='<div class=\"p-title\">Локация</div>';
      const row1=document.createElement('div'); row1.className='p-row';
      ['country','city','district','street'].forEach(name=>{
        const box=document.createElement('div'); box.className='p-field';
        const lab=document.createElement('label'); lab.textContent={country:'Страна',city:'Город',district:'Район',street:'Улица/Массив'}[name]; box.appendChild(lab);
        const sel=document.createElement('select'); sel.innerHTML=$('#'+name).innerHTML; sel.value=$('#'+name).value||'';
        sel.addEventListener('change',()=>{ previewState[name]=sel.value; });
        box.appendChild(sel); row1.appendChild(box);
      });
      g1.appendChild(row1); section.appendChild(g1);

      const g2=document.createElement('div'); g2.className='p-group';
      g2.innerHTML='<div class=\"p-title\">Категория и параметры</div>';
      const row2=document.createElement('div'); row2.className='p-row';
      ['category','subcategory'].forEach(name=>{
        const box=document.createElement('div'); box.className='p-field';
        const lab=document.createElement('label'); lab.textContent={category:'Категория',subcategory:'Подкатегория'}[name]; box.appendChild(lab);
        const sel=document.createElement('select'); sel.innerHTML=$('#'+name).innerHTML; sel.value=$('#'+name).value||'';
        sel.addEventListener('change',()=>{ previewState[name]=sel.value; });
        box.appendChild(sel); row2.appendChild(box);
      });
      // extra fields render
      extraFields.forEach(f=>{
        const box=document.createElement('div'); box.className='p-field';
        const lab=document.createElement('label'); lab.textContent=f.label||f.field; box.appendChild(lab);
        if(f.type==='range'){
          const r=document.createElement('div'); r.style.display='flex'; r.style.gap='8px';
          const a=document.createElement('input'); a.placeholder=(f.rangeLabels&&f.rangeLabels[0])||'от'; a.value=previewState[f.field+'_min']||''; a.addEventListener('input',()=>{ previewState[f.field+'_min']=a.value; });
          const b2=document.createElement('input'); b2.placeholder=(f.rangeLabels&&f.rangeLabels[1])||'до'; b2.value=previewState[f.field+'_max']||''; b2.addEventListener('input',()=>{ previewState[f.field+'_max']=b2.value; });
          r.appendChild(a); r.appendChild(b2); box.appendChild(r);
        }else if(f.type==='number'){
          const n=document.createElement('input'); n.type='number'; n.value=previewState[f.field]||''; n.addEventListener('input',()=>{ previewState[f.field]=n.value; }); box.appendChild(n);
        }else if(f.type==='select'){
          const sel=document.createElement('select'); sel.innerHTML = '<option value=\"\">—</option>' + (f.options||[]).map(o=>'<option>'+o+'</option>').join('');
          if((f.options||[]).includes(previewState[f.field])) sel.value=previewState[f.field];
          sel.addEventListener('change',()=>{ previewState[f.field]=sel.value; }); box.appendChild(sel);
        }else{ // text
          const t=document.createElement('input'); t.type='text'; t.value=previewState[f.field]||''; t.addEventListener('input',()=>{ previewState[f.field]=t.value; }); box.appendChild(t);
        }
        row2.appendChild(box);
      });
      g2.appendChild(row2); section.appendChild(g2);
    } else if(b.type==='form'){
      const fg=document.createElement('div'); fg.className='grid grid-2';
      ['Имя','Телефон','Email','Комментарий'].forEach((lbl,idx)=>{
        const wrap=document.createElement('div');
        const lab=document.createElement('label'); lab.textContent=lbl; wrap.appendChild(lab);
        const input = (idx===3)? document.createElement('textarea') : document.createElement('input');
        if(idx===1) input.type='tel'; if(idx===2) input.type='email';
        input.placeholder=lbl; wrap.appendChild(input); fg.appendChild(wrap);
      });
      section.appendChild(fg);
    } else if(b.type==='cards'){
      const gridCards=document.createElement('div'); gridCards.className='preview-cards';
      demoItems.forEach(it=>{
        const ci=document.createElement('div'); ci.className='preview-card-item';
        const img=document.createElement('img'); img.src=it.img; ci.appendChild(img);
        const body=document.createElement('div'); body.className='pc-body';
        const ttl=document.createElement('div'); ttl.className='pc-title'; ttl.textContent=it.title; body.appendChild(ttl);
        const adr=document.createElement('div'); adr.textContent='Район: '+it.district; body.appendChild(adr);
        const r=document.createElement('div'); r.textContent='Комнат: '+it.rooms; body.appendChild(r);
        const pr=document.createElement('div'); pr.textContent='Цена: '+it.price+' ('+it.area+')'; body.appendChild(pr);
        ci.appendChild(body); gridCards.appendChild(ci);
      });
      section.appendChild(gridCards);
    } else if(b.type==='table'){
      const table=document.createElement('table'); table.className='preview-table';
      const thead=document.createElement('thead'); thead.innerHTML='<tr><th>Категория</th><th>Район</th><th>Комнат</th><th>Площадь</th><th>Цена</th></tr>'; table.appendChild(thead);
      const tbody=document.createElement('tbody');
      demoItems.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+it.category+'</td><td>'+it.district+'</td><td>'+it.rooms+'</td><td>'+it.area+'</td><td>'+it.price+'</td>';
        tbody.appendChild(tr);
      });
      table.appendChild(tbody); section.appendChild(table);
    } else if(b.type==='map'){
      const m=document.createElement('div'); m.className='preview-map'; m.textContent='MAP (placeholder)';
      section.appendChild(m);
    }
    card.appendChild(section); grid.appendChild(card);
  });
}

/* ===== Boot ===== */
async function boot(){
  // events
  $('#country').addEventListener('change', onCountry);
  $('#city').addEventListener('change', onCity);
  $('#district').addEventListener('change', onDistrict);
  $('#category').addEventListener('change', onCategory);
  $('#btnDictReload').addEventListener('click', async()=>{ DICT = await fetchDict(); updateMeta(DICT); renderFiltersFromDict(); renderPreview(); });
  $('#fileDict').addEventListener('change', async(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{ const raw=JSON.parse(reader.result); const adapted=adaptDictionary(raw);
        localStorage.setItem(DICT_CACHE_KEY, JSON.stringify(adapted)); DICT=adapted; updateMeta(DICT); renderFiltersFromDict(); renderPreview(); setState('импорт справочника (файл)', true);
      }catch(err){ alert('Ошибка JSON'); setState('ошибка импорта', false); }
    };
    reader.readAsText(f);
  });

  // load dict
  DICT = await fetchDict();
  updateMeta(DICT);
  renderFiltersFromDict();

  // extra fields
  loadExtraFields(); renderExtraFieldsList();

  // layout
  loadLayout(); renderLayout();

  setState('готово', true);
}
boot();
</script>
</body>
</html>
