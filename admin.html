<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Builder v27 Preview</title>
<style>
:root{
  --bg:#0b0f16;--panel:#121826;--panel2:#172133;--text:#d7e2f2;--muted:#9fb0c8;
  --border:#273248;--accent:#4aa8ff;--danger:#ef4444;--ok:#22c55e;--warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;position:sticky;top:0;z-index:10}
.badge{padding:3px 8px;border-radius:8px;background:#6d28d9;font-weight:700}
.tabs{display:flex;gap:8px;margin-left:8px}
.tab{background:#1a2234;border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:#cfe0ff;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{padding:12px;display:grid;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:#3a4c6b}
.btn.ok{background:#0f3a1f;border-color:#14532d;color:#c7f9cf}
.btn.warn{background:#3a2a0f;border-color:#7c5a10;color:#fde68a}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff;width:100%}
label{display:block;opacity:.9;margin-bottom:6px}
small.muted{color:var(--muted)}
.list{display:grid;gap:10px}
.card{background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:10px}
.card .title-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
.card h3{margin:0}
.toast{position:fixed;right:12px;bottom:12px;background:#0b1322;border:1px solid #33507a;color:#d7ecff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(8px);transition:all .25s;z-index:99}
.toast.show{opacity:1;transform:none}
footer{padding:8px 12px;color:#9fb0c8;font-size:12px;border-top:1px solid var(--border)}
hr.sep{border:0;border-top:1px dashed #2a3650;margin:10px 0}
/* Canvas + Preview */
.canvas-wrap{border:1px solid var(--border);border-radius:12px;background:#0d121e;padding:6px;overflow:auto;height:62vh}
.canvas,.preview-grid{position:relative;display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:90px;gap:6px}
.block,.preview-card{background:#111827;border:1px solid #2b3a5a;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;position:relative}
.block header{display:flex;align-items:center;justify-content:space-between;background:#0f172a;color:#dbe8ff;padding:8px 10px;border-bottom:1px solid #2b3a5a;cursor:grab}
.block header:active{cursor:grabbing}
.block .body{padding:10px;flex:1}
.block .x{background:var(--danger);border:none;color:#fff;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}
.block .resize{position:absolute;right:6px;bottom:6px;width:14px;height:14px;border-right:3px solid #446; border-bottom:3px solid #446; cursor:nwse-resize;opacity:.8}
.block .title{font-weight:600}
.preview-card{border-color:#3a4c6b}
.p-group{border:1px solid #2a3140;border-radius:10px;padding:12px;margin-bottom:12px;background:#17202c;width:100%}
.p-title{font-size:13px;font-weight:600;margin-bottom:10px;color:#cfe0ff}
.p-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;width:100%}
.p-field{min-width:0;width:100%}
.p-field>div{display:flex;gap:8px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 8px;border-radius:8px;background:#0f1624;margin:4px}
.chip .grab{cursor:grab;font-size:12px;opacity:.7}
.chip.dragging{opacity:.5;border-style:dashed}
.dropzone{min-height:38px;border:1px dashed #334; border-radius:8px; padding:8px; background:#0c1220}
/* Inline editors */
.inline{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width: 900px){
  .p-row{grid-template-columns:repeat(2,1fr)}
  .inline{grid-template-columns:1fr}
}
</style>
</head>
<body>
<header>
  <span id="ver" class="badge">v27-preview</span>
  <div class="tabs">
    <button class="tab active" data-tab="filters">Фильтры</button>
    <button class="tab" data-tab="fields">Поля</button>
    <button class="tab" data-tab="layout">Макет</button>
    <button class="tab" data-tab="preview">Предпросмотр</button>
  </div>
  <div style="margin-left:auto" class="row">
    <button id="btnExport" class="btn">Экспорт</button>
    <label class="btn"><input id="fileImport" type="file" accept=".json,.txt" style="display:none">Импорт</label>
  </div>
</header>

<main>
  <!-- ФИЛЬТРЫ -->
  <section id="tab-filters" class="panel">
    <div class="row" style="margin-bottom:10px">
      <button class="btn" onclick="addGroup()">+ Ряд</button>
      <button class="btn" onclick="addFilter()">+ Фильтр</button>
    </div>
    <div id="groups" class="list"></div>
  </section>

  <!-- ПОЛЯ -->
  <section id="tab-fields" class="panel" style="display:none">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <h3>Все поля</h3>
      <button class="btn" onclick="addField()">+ Поле</button>
    </div>
    <div id="fields" class="list"></div>
  </section>

  <!-- МАКЕТ -->
  <section id="tab-layout" class="panel" style="display:none">
    <div class="row" style="margin-bottom:10px">
      <button class="btn" onclick="addBlock('filters')">+ Фильтры</button>
      <button class="btn" onclick="addBlock('form')">+ Форма</button>
      <button class="btn" onclick="addBlock('map')">+ Карта</button>
      <button class="btn" onclick="addBlock('cards')">+ Список</button>
      <button class="btn" onclick="addBlock('table')">+ Таблица</button>
      <button class="btn warn" onclick="autoLayout()">Авторасстановка</button>
      <button class="btn danger" onclick="clearLayout()">Очистить</button>
    </div>
    <small class="muted">Подсказка: потяни заголовок блока, чтобы переместить. Уголок снизу справа — изменяет размер. Сетка: 12 колонок.</small>
    <div class="canvas-wrap"><div id="canvas" class="canvas"></div></div>
  </section>

  <!-- ПРЕДПРОСМОТР -->
  <section id="tab-preview" class="panel" style="display:none">
    <div class="canvas-wrap"><div id="preview" class="preview-grid"></div></div>
  </section>

  <div id="toast" class="toast"></div>
</main>

<footer>
  build: admin-full-v27-preview
</footer>

<script>
// ===== Storage / Migration =====
const KEY_V27 = "admin_full_cfg_v27";
const KEY_V26 = "admin_full_cfg_v26";

function migrateIfNeeded(){
  try{
    if(!localStorage.getItem(KEY_V27)){
      const v26 = localStorage.getItem(KEY_V26);
      if(v26 && v26.length>10){
        localStorage.setItem(KEY_V27, v26);
      }else{
        const any = Object.keys(localStorage).filter(k=>k.startsWith("admin_full_cfg_")).sort().reverse();
        for(const k of any){
          const val = localStorage.getItem(k);
          if(val && val.length>10){ localStorage.setItem(KEY_V27,val); break; }
        }
      }
    }
  }catch(e){ console.warn(e); }
}
migrateIfNeeded();

let data = {
  fields: [
    {label:"Страна", field:"country", type:"select", options:["—","Узбекистан","Казахстан"], desc:""},
    {label:"Город", field:"city", type:"select", options:["—","Ташкент","Алматы"], desc:""},
    {label:"Категория", field:"category", type:"select", options:["—","Квартира","Дом"], desc:""},
    {label:"Цена", field:"price", type:"range", desc:"Диапазон цены"}
  ],
  groups: [
    {name:"Верхняя линия", desc:"Основные фильтры", filters:["country","city","category"]},
    {name:"Нижняя линия", desc:"Дополнительно", filters:["price"]}
  ],
  layout: [
    {id:1, type:"filters", title:"Фильтры", x:1, y:1, w:12, h:5},
    {id:2, type:"cards", title:"Список", x:7, y:6, w:6, h:6},
    {id:3, type:"map", title:"Карта", x:1, y:6, w:6, h:6}
  ]
};

try{
  const saved = localStorage.getItem(KEY_V27);
  if(saved){
    const obj = JSON.parse(saved);
    if(obj && (obj.fields||obj.groups||obj.layout)) data = Object.assign(data, obj);
  }
}catch(e){ console.warn("load fail",e); }

function save(){ localStorage.setItem(KEY_V27, JSON.stringify(data)); showSavedHint(); }
let saveTimer=null;
function showSavedHint(){ clearTimeout(saveTimer); saveTimer=setTimeout(()=>showToast("Сохранено", "ok"), 250); }

// ===== Tabs =====
document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    ["filters","fields","layout","preview"].forEach(id=>{
      document.getElementById('tab-'+id).style.display = (id===tab)?"block":"none";
    });
    if(tab==="filters"){ renderGroups(); }
    if(tab==="fields"){ renderFields(); }
    if(tab==="layout"){ renderLayout(); }
    if(tab==="preview"){ renderPreview(); }
  };
});

// ===== Toast =====
function showToast(msg,type="info"){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.borderColor= type==="ok" ? "#22c55e" : (type==="err" ? "#ef4444" : (type==="warn" ? "#f59e0b" : "#33507a"));
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1600);
}

// ===== Helpers =====
function byField(name){ return data.fields.find(f=>f.field===name); }
function ensureFieldKey(base){
  let key = base.replace(/\s+/g,'_').replace(/[^\w_]/g,'').toLowerCase() || "field";
  let i=1;
  while(data.fields.some(f=>f.field===key)){ key = base.replace(/\s+/g,'_').toLowerCase()+"_"+(++i); }
  return key;
}

// ===== Filters UI =====
function addGroup(){
  const idx = data.groups.length;
  data.groups.push({name: idx===0?"Верхняя линия":"Новая линия", desc:"", filters:[]});
  save(); renderGroups(); renderPreview();
}
function removeGroup(i){
  data.groups.splice(i,1);
  save(); renderGroups(); renderPreview();
}

function addFilter(){
  if(!data.groups.length) addGroup();
  const n = data.fields.length+1;
  const label = "Новый фильтр "+n;
  const fieldName = ensureFieldKey(label);
  data.fields.push({label, field:fieldName, type:"text", desc:""});
  data.groups[0].filters.push(fieldName);
  save(); renderGroups(); renderFields(); renderPreview();
}
function removeFilter(gIndex, fIndex){
  const name = data.groups[gIndex].filters[fIndex];
  data.groups[gIndex].filters.splice(fIndex,1);
  save(); renderGroups(); renderPreview();
}
let dragChip = null;
function renderGroups(){
  const box=document.getElementById('groups'); box.innerHTML="";
  data.groups.forEach((g,gi)=>{
    const card=document.createElement('div'); card.className="card";
    const titleRow = document.createElement('div'); titleRow.className="title-row";
    const left = document.createElement('div'); left.className="row";
    const h = document.createElement('h3'); h.textContent = g.name || ("Линия "+(gi+1));
    left.appendChild(h);
    titleRow.appendChild(left);
    const right = document.createElement('div'); right.className="row";
    const rm = document.createElement('button'); rm.className="btn danger"; rm.textContent="Удалить ряд";
    rm.onclick=()=>removeGroup(gi);
    right.appendChild(rm);
    titleRow.appendChild(right);
    card.appendChild(titleRow);

    const editors = document.createElement('div'); editors.className="inline";
    const nameWrap = document.createElement('div');
    nameWrap.innerHTML = '<label>Заголовок</label>';
    const nameInput = document.createElement('input');
    nameInput.value = g.name || "";
    nameInput.oninput = (e)=>{ data.groups[gi].name = e.target.value; save(); renderPreview(); };
    nameWrap.appendChild(nameInput);
    const descWrap = document.createElement('div');
    descWrap.innerHTML = '<label>Описание</label>';
    const descInput = document.createElement('input');
    descInput.placeholder="коротко о группе...";
    descInput.value = g.desc || "";
    descInput.oninput = (e)=>{ data.groups[gi].desc = e.target.value; save(); renderPreview(); };
    descWrap.appendChild(descInput);
    editors.appendChild(nameWrap);
    editors.appendChild(descWrap);
    card.appendChild(editors);

    const row = document.createElement('div'); row.className="chips dropzone"; row.dataset.group = gi;
    (g.filters||[]).forEach((fname,fi)=>{
      const f=byField(fname);
      const chip=document.createElement('div'); chip.className="chip"; chip.draggable=true; chip.dataset.name=fname;
      chip.innerHTML=`<span class="grab">↕</span><small>${f?f.label:fname}</small>`;
      const x=document.createElement('button'); x.className="btn danger"; x.textContent="x"; x.style.padding="2px 6px";
      x.onclick=()=>removeFilter(gi,fi);
      chip.appendChild(x);
      chip.addEventListener('dragstart', (e)=>{ dragChip = {name: fname, fromG: gi, fromIndex: fi}; chip.classList.add('dragging'); });
      chip.addEventListener('dragend', (e)=>{ chip.classList.remove('dragging'); dragChip=null; });
      row.appendChild(chip);
    });
    row.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    row.addEventListener('drop', (e)=>{
      e.preventDefault();
      const toG = parseInt(row.dataset.group,10);
      if(!dragChip) return;
      const arr = data.groups[dragChip.fromG].filters;
      const idx = arr.indexOf(dragChip.name);
      if(idx>-1) arr.splice(idx,1);
      data.groups[toG].filters.push(dragChip.name);
      save(); renderGroups(); renderPreview();
    });
    card.appendChild(row);
    box.appendChild(card);
  });
}

// ===== Fields UI =====
function addField(){
  const n = data.fields.length+1;
  const label = "Поле "+n;
  const fieldName = ensureFieldKey(label);
  data.fields.push({label, field:fieldName, type:"text", desc:""});
  save(); renderFields(); renderPreview();
}
function removeField(i){
  const removed = data.fields[i].field;
  data.groups.forEach(g=>{ g.filters = (g.filters||[]).filter(n=>n!==removed); });
  data.fields.splice(i,1);
  save(); renderFields(); renderGroups(); renderPreview();
}
function renderFields(){
  const box=document.getElementById('fields'); box.innerHTML="";
  data.fields.forEach((f,i)=>{
    const el=document.createElement('div'); el.className="card";
    const head=document.createElement('div'); head.className="title-row";
    const left=document.createElement('div'); left.className="row";
    const title=document.createElement('h3'); title.textContent=f.label || f.field;
    left.appendChild(title);
    const meta=document.createElement('small'); meta.className="muted"; meta.textContent=" ("+(f.field)+")";
    left.appendChild(meta);
    head.appendChild(left);
    const right=document.createElement('div'); right.className="row";
    const del=document.createElement('button'); del.className="btn danger"; del.textContent="Удалить";
    del.onclick=()=>removeField(i);
    right.appendChild(del);
    head.appendChild(right);
    el.appendChild(head);

    const grid=document.createElement('div'); grid.className="grid"; grid.style.gridTemplateColumns="repeat(2,1fr)"; grid.style.gap="10px";
    const w1=document.createElement('div'); w1.innerHTML="<label>Заголовок</label>";
    const in1=document.createElement('input'); in1.value=f.label||""; in1.oninput=(e)=>{ data.fields[i].label=e.target.value; save(); renderGroups(); renderPreview(); };
    w1.appendChild(in1); grid.appendChild(w1);
    const w2=document.createElement('div'); w2.innerHTML="<label>Описание</label>";
    const in2=document.createElement('input'); in2.placeholder="подпись/подсказка"; in2.value=f.desc||""; in2.oninput=(e)=>{ data.fields[i].desc=e.target.value; save(); renderPreview(); };
    w2.appendChild(in2); grid.appendChild(w2);
    const w3=document.createElement('div'); w3.innerHTML="<label>Тип</label>";
    const sel=document.createElement('select');
    ["text","number","select","range"].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; if(f.type===t) o.selected=true; sel.appendChild(o); });
    sel.onchange=(e)=>{ data.fields[i].type=e.target.value; save(); renderPreview(); renderFields(); };
    w3.appendChild(sel); grid.appendChild(w3);

    const w4=document.createElement('div');
    if(f.type==="select"){
      w4.innerHTML="<label>Опции (через запятую)</label>";
      const ta=document.createElement('textarea'); ta.rows=3; ta.value=Array.isArray(f.options)?f.options.join(", "):""; ta.oninput=(e)=>{ data.fields[i].options = e.target.value.split(",").map(s=>s.trim()).filter(Boolean); save(); renderPreview(); };
      w4.appendChild(ta);
    }else if(f.type==="range"){
      w4.innerHTML="<label>Подписи для диапазона (левая, правая)</label>";
      const inp=document.createElement('input'); inp.placeholder="например: от, до";
      const left = (f.rangeLabels && f.rangeLabels[0]) || "от"; const right = (f.rangeLabels && f.rangeLabels[1]) || "до";
      inp.value = left+", "+right;
      inp.oninput=(e)=>{ const parts = e.target.value.split(",").map(s=>s.trim()); data.fields[i].rangeLabels = [parts[0]||"от", parts[1]||"до"]; save(); renderPreview(); };
      w4.appendChild(inp);
    }else{ w4.innerHTML="<label>&nbsp;</label><div class='muted'>Для этого типа настроек нет</div>"; }
    grid.appendChild(w4);

    el.appendChild(grid);
    box.appendChild(el);
  });
}
// ===== Layout =====
let nextId = 100;
let dragState = null; let resizeState = null;
function addBlock(type){ const id=++nextId; data.layout.push({id, type, title: type==='filters'?'Фильтры':type.toUpperCase(), x:1, y:1, w:6, h:4}); save(); renderLayout(); renderPreview(); }
function removeBlock(id){ const i=data.layout.findIndex(b=>b.id===id); if(i>-1){ data.layout.splice(i,1); save(); renderLayout(); renderPreview(); } }
function clearLayout(){ data.layout=[]; save(); renderLayout(); renderPreview(); }
function autoLayout(){ let col=1,row=1; data.layout.forEach(b=>{ b.w=6; b.h=4; b.x=col; b.y=row; col = (col===1) ? 7 : 1; if(col===1) row += 4; }); save(); renderLayout(); renderPreview(); }
function clamp(val,min,max){ return Math.max(min, Math.min(max, val)); }
function renderLayout(){ const gridEl=document.getElementById('canvas'); gridEl.innerHTML=""; const rows = data.layout.length ? Math.max(...data.layout.map(b=>b.y+b.h-1)) : 1; gridEl.style.minHeight = (rows*90 + (rows-1)*6) + "px";
  data.layout.forEach(b=>{ const card=document.createElement('div'); card.className="block"; card.dataset.id=b.id; card.style.gridColumn=`${b.x} / span ${b.w}`; card.style.gridRow=`${b.y} / span ${b.h}`;
    const head=document.createElement('header'); const titleSpan=document.createElement('span'); titleSpan.className="title"; titleSpan.textContent=b.title||b.type; titleSpan.ondblclick=()=>{ const t = prompt("Название блока:", b.title||b.type) || b.title; if(t!=null){ b.title = t; save(); renderLayout(); renderPreview(); } }; head.appendChild(titleSpan);
    const rm=document.createElement('button'); rm.className="x"; rm.textContent="x"; rm.onclick=()=>removeBlock(b.id); head.appendChild(rm);
    head.addEventListener('mousedown', (e)=>{ const rect = gridEl.getBoundingClientRect(); const colWidth = rect.width/12; const rowHeight = 96; dragState = { id:b.id, startX:e.clientX, startY:e.clientY, baseX:b.x, baseY:b.y, colWidth, rowHeight }; document.addEventListener('mousemove', onDragMove); document.addEventListener('mouseup', onDragEnd, {once:true}); });
    const body=document.createElement('div'); body.className="body"; body.textContent="Секция макета";
    const res=document.createElement('div'); res.className="resize"; res.addEventListener('mousedown', (e)=>{ e.stopPropagation(); const rect = gridEl.getBoundingClientRect(); const colWidth = rect.width/12; const rowHeight = 96; resizeState = { id:b.id, startX:e.clientX, startY:e.clientY, baseW:b.w, baseH:b.h, colWidth, rowHeight }; document.addEventListener('mousemove', onResizeMove); document.addEventListener('mouseup', onResizeEnd, {once:true}); });
    card.appendChild(head); card.appendChild(body); card.appendChild(res); gridEl.appendChild(card); }); }
function onDragMove(e){ if(!dragState) return; const b = data.layout.find(x=>x.id===dragState.id); if(!b) return; const dx = e.clientX - dragState.startX; const dy = e.clientY - dragState.startY; let gx = Math.round(dragState.baseX + dx / dragState.colWidth); let gy = Math.round(dragState.baseY + dy / dragState.rowHeight); gx = clamp(gx, 1, 12 - (b.w-1)); gy = clamp(gy, 1, Math.max(1, gy)); b.x = gx; b.y = gy; renderLayout(); }
function onDragEnd(){ if(dragState){ save(); dragState=null; } document.removeEventListener('mousemove', onDragMove); }
function onResizeMove(e){ if(!resizeState) return; const b = data.layout.find(x=>x.id===resizeState.id); if(!b) return; const dx = e.clientX - resizeState.startX; const dy = e.clientY - resizeState.startY; let gw = Math.round(resizeState.baseW + dx / resizeState.colWidth); let gh = Math.round(resizeState.baseH + dy / resizeState.rowHeight); gw = clamp(gw, 1, 12 - (b.x-1)); gh = clamp(gh, 1, 24); b.w = gw; b.h = gh; renderLayout(); }
function onResizeEnd(){ if(resizeState){ save(); resizeState=null; } document.removeEventListener('mousemove', onResizeMove); }
// ===== Preview =====
function computeOptions(f){ return Array.isArray(f.options)?f.options:[]; }
function previewFilters(){ const wrap=document.createElement('div'); data.groups.forEach((g,gi)=>{ const group=document.createElement('div'); group.className='p-group'; const title=document.createElement('div'); title.className='p-title'; title.textContent = g.name || (gi===0?'Верхняя линия':'Линия '+(gi+1)); group.appendChild(title); if(g.desc){ const d=document.createElement('div'); d.className='muted'; d.style.marginBottom="8px"; d.textContent=g.desc; group.appendChild(d); } const row=document.createElement('div'); row.className='p-row'; (g.filters||[]).forEach(name=>{ const f=byField(name); if(!f) return; const box=document.createElement('div'); box.className='p-field'; const lab=document.createElement('label'); lab.textContent=f.label || f.field; box.appendChild(lab); if(f.desc){ const hint=document.createElement('small'); hint.className='muted'; hint.textContent=f.desc; box.appendChild(hint); } if(f.type==='select'){ const sel=document.createElement('select'); const opts=computeOptions(f); sel.innerHTML = "<option value=''>—</option>"+opts.map(o=>`<option>${o}</option>`).join(''); box.appendChild(sel); }else if(f.type==='range'){ const div=document.createElement('div'); div.className='row'; const a=document.createElement('input'); a.placeholder=(f.rangeLabels && f.rangeLabels[0]) || 'от'; const b=document.createElement('input'); b.placeholder=(f.rangeLabels && f.rangeLabels[1]) || 'до'; div.append(a,b); box.appendChild(div); }else if(f.type==='number'){ const num=document.createElement('input'); num.type='number'; box.appendChild(num); }else{ const t=document.createElement('input'); t.type='text'; box.appendChild(t); } row.appendChild(box); }); group.appendChild(row); wrap.appendChild(group); }); return wrap; }
function renderPreview(){ const grid=document.getElementById('preview'); grid.innerHTML=""; const rows = data.layout.length ? Math.max(...data.layout.map(b=>b.y+b.h-1)) : 1; grid.style.minHeight = (rows*90 + (rows-1)*6) + "px"; data.layout.forEach(b=>{ const card=document.createElement('div'); card.className='preview-card'; card.style.gridColumn=`${b.x} / span ${b.w}`; card.style.gridRow=`${b.y} / span ${b.h}`; if(b.type==='filters') card.appendChild(previewFilters()); else { const ph=document.createElement('div'); ph.style.padding='10px'; ph.innerHTML = `<b>${(b.title||b.type).toUpperCase()}</b><br><small class="muted">(${b.w}×${b.h} на сетке)</small>`; card.appendChild(ph); } grid.appendChild(card); }); }
// ===== Export / Import =====
document.getElementById('btnExport').onclick=()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="admin-config-v27.json"; a.click(); showToast("Экспорт сохранен", "ok"); };
document.getElementById('fileImport').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.fields) data.fields=obj.fields; if(obj.groups) data.groups=obj.groups; if(obj.layout) data.layout=obj.layout; save(); renderGroups(); renderFields(); renderLayout(); renderPreview(); showToast("Импорт выполнен", "ok"); }catch(err){ console.error(err); showToast("Ошибка импорта","err"); } }; r.readAsText(f); };
// Init
renderGroups(); renderFields(); renderLayout(); renderPreview();
</script>
</body>
</html>
