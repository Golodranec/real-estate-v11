// ======= v13.5.2 =======
console.log("‚úÖ script.js v13.5.2 loaded");

// ======= –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã LS =======
const LS_OBJECTS = "objects";
const LS_FILTERS = "filters_v13_5";
const LS_FAVS    = "favorites_v13_5";

// ======= –î–∞–Ω–Ω—ã–µ =======
let objects = JSON.parse(localStorage.getItem(LS_OBJECTS) || "[]");
let favorites = new Set(JSON.parse(localStorage.getItem(LS_FAVS) || "[]"));
let editingId = null;
let selectedImages = [];
let tempCoords = { lat: null, lng: null };

// ======= –î–µ—Ä–µ–≤–æ/—Ç–∏–ø—ã =======
let treeNodes = JSON.parse(localStorage.getItem("treeNodes") || "[]");
let nodeTypes = JSON.parse(localStorage.getItem("nodeTypes") || "[]");
const defaultTypes = ["–ì–æ—Ä–æ–¥", "–†–∞–π–æ–Ω", "–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è"];
defaultTypes.forEach(t => { if (!nodeTypes.includes(t)) nodeTypes.push(t); });

// üî• —Ç–µ–ø–µ—Ä—å extraParams –≤—Å–µ–≥–¥–∞ –±–µ—Ä—ë–º –∑–∞–Ω–æ–≤–æ
function getExtraParams() {
  return JSON.parse(localStorage.getItem("extraParams") || "[]");
}

// ======= helpers =======
const $ = (id) => document.getElementById(id);
const getNode = (id) => treeNodes.find(n => n.id === id) || null;
const childrenOf = (parentId) => treeNodes.filter(n => n.parent === parentId);
const typed = (type) => treeNodes.filter(n => n.type === type);
const nameById = (id) => (getNode(id)?.name) || "";
const num = v => (v==="" || v==null ? null : +v);

// ======= –∫–∞—Ä—Ç–∞ =======
const map = L.map("map").setView([41.3111, 69.2797], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "¬© OpenStreetMap" }).addTo(map);
const markerLayer = L.layerGroup().addTo(map);
const cluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 45 });
map.addLayer(cluster);
let formMarker = null;

// ======= —Ñ–∏–ª—å—Ç—Ä—ã DOM =======
const cityFilter = $("cityFilter");
const districtFilter = $("districtFilter");
const streetFilter = $("streetFilter");
const categoryFilter = $("categoryFilter");
const statusFilter = $("statusFilter");
const priceMin = $("priceMin"), priceMax = $("priceMax");
const roomsMin = $("roomsMin"), roomsMax = $("roomsMax");
const floorMin = $("floorMin"), floorMax = $("floorMax");
const floorsMin= $("floorsMin"), floorsMax= $("floorsMax");
const areaMin  = $("areaMin"),  areaMax  = $("areaMax");
const yearMin  = $("yearMin"),  yearMax  = $("yearMax");
const houseTypeFilter = $("houseTypeFilter");
const sortSelect = $("sortSelect");
const onlyFav = $("onlyFav");
const resetFilters = $("resetFilters");
const filtersInfo = $("filtersInfo");
const paramsFiltersBox = $("dynamicParamsFilters");
const adminSyncInfo = $("adminSyncInfo");

// ======= —Ñ–æ—Ä–º–∞ DOM =======
const resultsList   = $("resultsList");
const form          = $("objectForm");
const formTitle     = $("formTitle");
const titleInput    = $("title");
const priceInput    = $("price");
const roomsInput    = $("rooms");
const statusInput   = $("status");
const categoryInput = $("category");
const addressInput  = $("address");
const areaInput     = $("area");
const floorInput    = $("floor");
const floorsInput   = $("floors");
const yearInput     = $("year");
const houseTypeSel  = $("houseType");
const imagesInput   = $("images");
const imagePreview  = $("imagePreview");
const pickOnMapBtn  = $("pickOnMap");
const coordsBadge   = $("coordsBadge");
const cancelEditBtn = $("cancelEdit");
const clearFormBtn  = $("clearForm");
const citySel = $("city");
const districtSel = $("district");
const streetSel = $("street");

// ======= —É—Ç–∏–ª–∏—Ç—ã =======
function setOptions(select, items, placeholder) {
  const prev = select.value;
  select.innerHTML = `<option value="">${placeholder}</option>`;
  items.forEach(n => {
    const opt = document.createElement("option");
    opt.value = String(n.id);
    opt.textContent = n.name;
    select.appendChild(opt);
  });
  if (prev && [...select.options].some(o => o.value === prev)) select.value = prev;
}
function showInfo(msg) { filtersInfo.style.display = "block"; filtersInfo.textContent = msg; }
function hideInfo() { filtersInfo.style.display = "none"; }

// ======= –ö–∞—Å–∫–∞–¥ —Ñ–∏–ª—å—Ç—Ä–æ–≤ =======
function initCascadeFilters() {
  setOptions(cityFilter, typed("–ì–æ—Ä–æ–¥"), "–ì–æ—Ä–æ–¥");
  setOptions(districtFilter, [], "–†–∞–π–æ–Ω");
  setOptions(streetFilter, [], "–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞");
  setOptions(categoryFilter, typed("–ö–∞—Ç–µ–≥–æ—Ä–∏—è"), "–ö–∞—Ç–µ–≥–æ—Ä–∏—è");

  cityFilter.onchange = () => {
    const id = cityFilter.value ? +cityFilter.value : null;
    setOptions(districtFilter, id ? childrenOf(id).filter(n=>n.type==="–†–∞–π–æ–Ω") : [], "–†–∞–π–æ–Ω");
    setOptions(streetFilter, [], "–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞");
    buildParamsFilters(); saveFilters(); renderAll();
  };
  districtFilter.onchange = () => {
    const id = districtFilter.value ? +districtFilter.value : null;
    setOptions(streetFilter, id ? childrenOf(id).filter(n=>n.type==="–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞") : [], "–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞");
    saveFilters(); renderAll();
  };
  streetFilter.onchange = () => { saveFilters(); renderAll(); };
  categoryFilter.onchange = () => { buildParamsFilters(); saveFilters(); renderAll(); };
  statusFilter.onchange = () => { saveFilters(); renderAll(); };
  houseTypeFilter.onchange = () => { saveFilters(); renderAll(); };
}

// ======= –ö–∞—Å–∫–∞–¥ —Ñ–æ—Ä–º—ã =======
function initCascadeForm() {
  setOptions(citySel, typed("–ì–æ—Ä–æ–¥"), "–ì–æ—Ä–æ–¥");
  setOptions(districtSel, [], "–†–∞–π–æ–Ω");
  setOptions(streetSel, [], "–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞");
  setOptions(categoryInput, typed("–ö–∞—Ç–µ–≥–æ—Ä–∏—è"), "–ö–∞—Ç–µ–≥–æ—Ä–∏—è");

  citySel.onchange = () => {
    const id = citySel.value ? +citySel.value : null;
    setOptions(districtSel, id ? childrenOf(id).filter(n=>n.type==="–†–∞–π–æ–Ω") : [], "–†–∞–π–æ–Ω");
    setOptions(streetSel, [], "–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞");
  };
  districtSel.onchange = () => {
    const id = districtSel.value ? +districtSel.value : null;
    setOptions(streetSel, id ? childrenOf(id).filter(n=>n.type==="–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞") : [], "–ú–∞—Å—Å–∏–≤ / —É–ª–∏—Ü–∞");
  };

  categoryInput.onchange = () => { renderParamsForm(); };
  renderParamsForm();
}

// ======= –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: —Ñ–æ—Ä–º–∞ =======
function paramsByCategoryId(catId) {
  return getExtraParams().filter(p => p.categoryId === catId);
}
function renderParamsForm() {
  const box = $("dynamicParamsForm");
  box.innerHTML = "";
  const catId = categoryInput.value ? +categoryInput.value : null;
  if (!catId) return;

  const params = paramsByCategoryId(catId);
  params.forEach(p => {
    const group = document.createElement("div");
    group.className = "param-group";
    group.innerHTML = `<div class="param-title">${p.name}</div>`;
    const vals = document.createElement("div");
    vals.className = "param-values";
    (p.values||[]).forEach(val => {
      const chip = document.createElement("label");
      chip.className = "param-chip";
      chip.innerHTML = `<input type="checkbox" data-param="${p.name}" value="${val}" /> <span>${val}</span>`;
      vals.appendChild(chip);
    });
    group.appendChild(vals);
    box.appendChild(group);
  });
}

// ======= –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: —Ñ–∏–ª—å—Ç—Ä—ã =======
function buildParamsFilters() {
  paramsFiltersBox.innerHTML = "";
  const catId = categoryFilter.value ? +categoryFilter.value : null;
  if (!catId) return;

  const params = paramsByCategoryId(catId);
  params.forEach(p => {
    const group = document.createElement("div");
    group.className = "param-group";
    group.innerHTML = `<div class="param-title">${p.name}</div>`;
    const vals = document.createElement("div");
    vals.className = "param-values";
    (p.values||[]).forEach(val => {
      const chip = document.createElement("label");
      chip.className = "param-chip";
      chip.innerHTML = `<input type="checkbox" data-param="${p.name}" value="${val}" /> <span>${val}</span>`;
      chip.querySelector("input").addEventListener("change", ()=>{ saveFilters(); renderAll(); });
      vals.appendChild(chip);
    });
    group.appendChild(vals);
    paramsFiltersBox.appendChild(group);
  });
}

// ======= –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ =======
function updateAdminSyncInfo() {
  const cats = treeNodes.filter(n => n.type === "–ö–∞—Ç–µ–≥–æ—Ä–∏—è").length;
  const params = getExtraParams().length;
  if (cats || params) {
    adminSyncInfo.style.color = "#9aa3b2";
    adminSyncInfo.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${cats} –∫–∞—Ç–µ–≥–æ—Ä–∏–π, ${params} –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ –∞–¥–º–∏–Ω–∫–∏`;
  } else {
    adminSyncInfo.style.color = "#ff6b6b";
    adminSyncInfo.textContent = "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∞–¥–º–∏–Ω–∫–∏";
  }
}

// ======= —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è =======
function applyFilters(list) {
  let res = [...list];
  const categoryName = categoryFilter.value ? nameById(+categoryFilter.value) : "";

  if (categoryName) res = res.filter(o => (o.category||"") === categoryName);

  // –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  const selectedByParam = {};
  paramsFiltersBox.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    if (cb.checked) {
      const p = cb.dataset.param;
      if (!selectedByParam[p]) selectedByParam[p] = new Set();
      selectedByParam[p].add(cb.value);
    }
  });
  Object.keys(selectedByParam).forEach(pname=>{
    const wanted = selectedByParam[pname];
    res = res.filter(o => {
      const got = new Set(o.extra?.[pname] || []);
      for (const val of wanted) { if (got.has(val)) return true; }
      return false;
    });
  });

  return res;
}

// ======= init =======
function init() {
  initCascadeFilters();
  initCascadeForm();
  buildParamsFilters();
  updateAdminSyncInfo();   // üî• –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
  renderAll();
}
init();
