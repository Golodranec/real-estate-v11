
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MySale — i18n patched (Cloudflare)</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Open Sans','Helvetica Neue',Arial,sans-serif;background:#fcfcd9;color:#2a2a2a}
    header{display:flex;align-items:center;gap:12px;background:#c7be10;padding:12px 16px;position:sticky;top:0;z-index:5}
    .logo{font-weight:800;color:#106b00;font-size:28px;letter-spacing:.5px}
    .logo .accent{color:#e37d00}
    .search{flex:1}
    .search input{width:100%;padding:10px 14px;border-radius:10px;border:0;background:#eef1f6}
    .sel{display:flex;align-items:center;gap:8px}
    select,button{border-radius:10px;border:0;padding:10px 14px;background:#ff8c00;color:#111;font-weight:600}
    main{max-width:1150px;margin:24px auto;padding:0 16px}
    h1{font-family:Georgia,serif;text-align:center;color:#ff8c00;font-size:44px;margin:10px 0 26px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:26px}
    .card{background:#fff8d8;border-radius:16px;box-shadow:0 10px 34px rgba(0,0,0,.08);padding:16px;text-align:center}
    .shield{width:140px;height:140px;margin:6px auto 10px;background:linear-gradient(145deg,#169a00,#0f6f00);border-radius:24px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:.95}
    .hint{margin-top:20px;color:#666}
    small.code{background:#000;color:#0f0;padding:2px 6px;border-radius:6px;font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <header>
    <div class="logo">My<span class="accent">Sale</span></div>
    <div class="search"><input placeholder="Поиск" class="i18n" data-i18n-key="search" value=""></div>
    <div class="sel">
      <select id="profile">
        <option>Профиль</option>
        <option>Мои объявления</option>
        <option>Избранное</option>
        <option>Настройки</option>
      </select>
      <select id="lang">
        <option value="ru">RU</option>
        <option value="en">EN</option>
        <option value="uz">UZ</option>
      </select>
    </div>
  </header>

  <main>
    <h1 class="i18n" data-i18n-key="title">Выберите раздел</h1>
    <section class="grid" id="grid">
      <article class="card">
        <div class="shield"></div>
        <div class="i18n" data-i18n-key="realty">Недвижимость</div>
      </article>
      <article class="card">
        <div class="shield"></div>
        <div class="i18n" data-i18n-key="transport">Транспорт</div>
      </article>
      <article class="card">
        <div class="shield"></div>
        <div class="i18n" data-i18n-key="health">Здоровье</div>
      </article>
      <article class="card">
        <div class="shield"></div>
        <div class="i18n" data-i18n-key="electronics">Электроника</div>
      </article>
      <article class="card">
        <div class="shield"></div>
        <div class="i18n" data-i18n-key="jobs">Работа</div>
      </article>
      <article class="card">
        <div class="shield"></div>
        <div class="i18n" data-i18n-key="furniture">Мебель</div>
      </article>
      <article class="card">
        <div class="shield"></div>
        <div class="i18n" data-i18n-key="services">Услуги</div>
      </article>
    </section>
    <p class="hint">
      Демонстрация автоперевода (Cloudflare). Новые слова подхватываются автоматически.
      Ваш endpoint: <small class="code" id="endpointLabel"></small>
    </p>
  </main>

  <div class="toast" id="toast"></div>

  <script>
  // === Настройки ===
  // !!! Замените на свой Cloudflare Workers endpoint, если он другой.
  const API_TRANSLATE = 'https://mute-feather-d42e.smeksy144.workers.dev/api/translate';
  const SOURCE_LANG = 'ru'; // язык исходного текста на странице
  const STORAGE_KEY  = 'mysale_lang';

  // === Вспомогалки ===
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const toast = (msg, ok=true) => {
    const t = $("#toast");
    t.textContent = msg;
    t.style.background = ok ? "#111" : "#b00020";
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  };

  $("#endpointLabel").textContent = API_TRANSLATE;

  // Сохраняем/восстанавливаем выбранный язык
  const langSel = $("#lang");
  document.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem(STORAGE_KEY) || SOURCE_LANG;
    langSel.value = saved;
    applyLanguage(saved);
  });
  langSel.addEventListener('change', () => {
    localStorage.setItem(STORAGE_KEY, langSel.value);
    applyLanguage(langSel.value);
  });

  // Собираем переводимые элементы и их исходные тексты
  function collectTranslatables() {
    const nodes = $$('.i18n');
    const q = [];
    const mapping = []; // [{node, original}]
    nodes.forEach(n => {
      if (!n.dataset.i18nOriginal) n.dataset.i18nOriginal = (n.textContent || '').trim();
      const text = n.dataset.i18nOriginal;
      if (text && !q.includes(text)) q.push(text);
      mapping.push({ node:n, original:text });
    });
    return { q, mapping };
  }

  // Применяем перевод к DOM
  function applyTranslated(mapping, translatedList) {
    const dict = new Map();
    translatedList.forEach((t, idx) => dict.set(t.originalText ?? mapping[idx]?.original, t.translatedText || t));

    mapping.forEach(({node, original}) => {
      node.textContent = dict.get(original) || original || '';
    });
  }

  // Делает запрос к воркеру
  async function translateBatch(q, source, target) {
    const r = await fetch(API_TRANSLATE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ q, source, target })
    });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    // Google v2 форматируем в {translatedText}
    const list = (data?.data?.translations || []).map(t => ({translatedText: t.translatedText, originalText: t.detectedSourceLanguage ? null : null}));
    return list;
  }

  // Главная функция смены языка
  async function applyLanguage(targetLang) {
    const { q, mapping } = collectTranslatables();

    if (targetLang === SOURCE_LANG) {
      // Восстанавливаем оригинальные тексты
      mapping.forEach(({node}) => node.textContent = node.dataset.i18nOriginal || '');
      toast('Язык: ' + targetLang);
      return;
    }
    if (!q.length) return;

    try {
      const translated = await translateBatch(q, SOURCE_LANG, targetLang);
      // translated — в том же порядке, что q
      // Преобразуем к структуре для applyTranslated
      const normalized = translated.map((t, i) => ({translatedText: t.translatedText, originalText: q[i]}));
      applyTranslated(mapping, normalized);
      toast('Переведено: ' + targetLang);
    } catch (e) {
      console.error(e);
      toast('Ошибка перевода: ' + e.message, false);
    }
  }

  // Наблюдатель — автоматически переводит новые узлы с классом .i18n
  const mo = new MutationObserver(() => {
    const current = langSel.value || SOURCE_LANG;
    if (current !== SOURCE_LANG) applyLanguage(current);
  });
  mo.observe(document.body, {childList:true,subtree:true});
  </script>
</body>
</html>
