<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MySale — Витрина (редактор)</title>
  <style>
    :root{
      --bg:#eaf4ff;
      --bg-accent:#cfe7ff;
      --panel:#ffffff;
      --ink:#0b1220;
      --ink-dim:#3b4456;
      --ring:#dbe7ff;
      --chip:#edf4ff;
      --danger:#e11d48;
    }
    .theme--winter{ --bg:#d9eeff; --bg-accent:#bfe1ff; --panel:#fff; --chip:#e8f4ff; --ring:#cfe7ff; }
    .theme--spring{ --bg:#e7ffe7; --bg-accent:#c8ffd1; --panel:#fff; --chip:#e8ffef; --ring:#ccffd9; }
    .theme--summer{ --bg:#fff1cc; --bg-accent:#ffe099; --panel:#fff; --chip:#fff0cc; --ring:#ffe2a8; }
    .theme--autumn{ --bg:#ffe9d5; --bg-accent:#ffd0a6; --panel:#fff; --chip:#ffe7cc; --ring:#ffd9b3; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, var(--bg-accent), transparent 70%),
        radial-gradient(900px 500px at 110% 0%, var(--bg-accent), transparent 60%),
        linear-gradient(180deg, var(--bg), #ffffff);
      min-height:100%;
    }
    header{
      padding:18px 16px; max-width:1200px; margin:0 auto;
      display:grid; grid-template-columns:auto 1fr auto; gap:16px; align-items:center;
    }
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; font-size:28px}
    .logo-badge{width:38px; height:38px; filter: drop-shadow(0 0 6px #22c55e88)}
    .logo-text{ background:linear-gradient(180deg,#1db34e 0%,#30d266 70%); -webkit-background-clip:text; background-clip:text; color:transparent;}
    .logo-text em{font-style:normal; background:linear-gradient(180deg,#ffb02e 0%, #ff7f00 80%); -webkit-background-clip:text; background-clip:text; color:transparent;}

    .search{display:flex; align-items:center; gap:10px; background:var(--panel); border:1px solid var(--ring); border-radius:999px; padding:10px 14px; box-shadow: 0 10px 30px #0001, inset 0 1px 0 #ffffffcc;}
    .search input{border:0; outline:0; flex:1; font-size:16px; background:transparent; padding:8px; color:var(--ink)}
    .icon-btn{appearance:none; border:0; background:var(--ink); color:#fff; padding:10px 14px; border-radius:999px; cursor:pointer}

    .chip{display:inline-flex; gap:8px; align-items:center; background:var(--chip); border:1px solid var(--ring); padding:10px 14px; border-radius:999px; font-size:14px; color:var(--ink-dim)}

    .container{max-width:1200px; margin:10px auto 60px; padding:0 16px}
    .panel{background:var(--panel); border:1px solid var(--ring); border-radius:20px; padding:20px; box-shadow: 0 30px 60px #0002;}
    .toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--ring); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; box-shadow: 0 8px 20px #0000000a;}
    .btn.primary{background:var(--ink); color:#fff}
    .btn.danger{border-color:#fecaca; color:#991b1b; background:#fff1f2}
    .switch{display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none}
    .switch input{appearance:none; width:40px; height:24px; background:#e5e7eb; border-radius:999px; position:relative; outline:0; border:1px solid var(--ring)}
    .switch input:checked{background:#16a34a}
    .switch input::after{content:""; position:absolute; width:18px; height:18px; top:2px; left:2px; border-radius:999px; background:#fff; box-shadow:0 1px 2px #0001; transition:left .2s}
    .switch input:checked::after{left:20px}
    .select, .input, .color{padding:10px 12px; border:1px solid var(--ring); border-radius:10px; background:#fff; font:inherit}

    .grid{display:grid; gap:24px; grid-template-columns: repeat(4, minmax(0,1fr));}
    @media (max-width:1000px){.grid{grid-template-columns: repeat(3, minmax(0,1fr));}}
    @media (max-width:720px){header{grid-template-columns:1fr} .grid{grid-template-columns: repeat(2, minmax(0,1fr));}}

    .cat{display:flex; flex-direction:column; align-items:center; gap:12px; text-align:center; position:relative}
    .shield-wrap{width:160px; aspect-ratio:1; position:relative; filter: drop-shadow(0 10px 10px #00000012) drop-shadow(0 20px 30px #00000010);}
    .shield{width:100%; height:100%; display:block;}
    /* Clip-mask version */
    .shield-wrap{ width:160px; aspect-ratio:100/110; position:relative; filter: drop-shadow(0 10px 12px #0002) drop-shadow(0 20px 30px #0001);}
    .shield-rim{position:absolute; inset:0; width:100%; height:100%; display:block}    
    .plate-clip{position:absolute; inset:0; clip-path:path('M50 18 C43 23 31 25 20 27 v25 c0 16 11 29 30 35 c19-6 30-19 30-35 V27 C69 25 57 23 50 18z'); border-radius:8px; overflow:hidden}    
    .plate-clip img{display:block; width:100%; height:100%; object-fit:cover}
    .plate-clip .anim{opacity:0; transition:opacity .2s ease}
    .cat:hover .plate-clip .anim{opacity:1}
    .cat:hover .plate-clip .poster{opacity:0}

    .label{font-size:18px; font-weight:700; color:var(--ink)}
    .actions{position:absolute; top:10px; right:10px; display:flex; gap:6px; opacity:0; transition:opacity .15s}
    .cat.editable:hover .actions{opacity:1}
    .icon-small{width:30px; height:30px; border-radius:8px; display:grid; place-items:center; background:#ffffffcc; border:1px solid var(--ring); cursor:grab; user-select:none}
    .icon-btn-inline{appearance:none; border:1px solid var(--ring); background:#fff; padding:8px 10px; border-radius:8px; cursor:pointer}
    .badge{position:absolute; top:-8px; left:-8px; background:#0ea5e9; color:#fff; font-weight:700; font-size:12px; padding:4px 8px; border-radius:999px; border:2px solid #fff;}

    /* Hover effects */
    .shield-wrap .plate-slot{transition:transform .25s ease}
    .cat:hover .plate-slot{transform:scale(1.03)}
    .plate-slot image.poster{opacity:1; transition:opacity .2s ease}
    .plate-slot image.anim{opacity:0; transition:opacity .2s ease}
    .cat:hover .plate-slot image.anim{opacity:1}
    .cat:hover .plate-slot image.poster{opacity:0}
    .plate-slot img.poster{opacity:1; transition:opacity .2s ease; width:100%; height:100%; object-fit:cover}
    .plate-slot img.anim{opacity:0; transition:opacity .2s ease; width:100%; height:100%; object-fit:cover}
    .cat:hover .plate-slot img.anim{opacity:1}
    .cat:hover .plate-slot img.poster{opacity:0}

    /* Anim badge */
    .cat[data-anim="1"] .label::after{content:" · anim"; color:#16a34a; font-weight:600}
    /* initial peek to prove media exists */
    .cat.peek .plate-slot img.anim{opacity:1}
    .cat.peek .plate-slot img.poster{opacity:0}

    .shield-wrap::after{content:""; position:absolute; inset:0; background: linear-gradient(120deg, transparent 40%, #ffffff40 50%, transparent 60%); transform:translateX(-120%); transition:transform .7s ease; border-radius:20%; pointer-events:none}
    .cat:hover .shield-wrap::after{ transform:translateX(120%) }

    dialog{border:0; border-radius:16px; padding:0; width:min(560px, 92vw); box-shadow:0 30px 80px #0006}
    .modal{padding:18px}
    .modal h3{margin:0 0 12px 0}
    .modal .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .modal .row > label{display:flex; flex-direction:column; gap:6px}
    .modal footer{display:flex; gap:10px; justify-content:flex-end; margin-top:16px}

    .file{display:none}
  </style>
</head>
<body class="theme--spring">
  <!-- SVG sprite -->
  <svg width="0" height="0" style="position:absolute;visibility:hidden" aria-hidden="true">
    <!-- Logo shield -->
    <symbol id="sym-logo-shield" viewBox="0 0 100 110">
      <defs>
        <linearGradient id="lg-green" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#1db34e"/>
          <stop offset="1" stop-color="#0c7c2f"/>
        </linearGradient>
        <linearGradient id="lg-glow" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#2be36e"/>
          <stop offset="1" stop-color="#14b44e"/>
        </linearGradient>
        <linearGradient id="lg-orange" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#ffb02e"/>
          <stop offset="1" stop-color="#ff7f00"/>
        </linearGradient>
      </defs>
      <path d="M50 5 C40 12 25 15 10 18 v36 c0 23 16 42 40 51 c24-9 40-28 40-51 V18 C75 15 60 12 50 5z" fill="url(#lg-green)" stroke="#063d1a" stroke-width="3"/>
      <path d="M50 9 C41 15 27 17 14 20 v32 c0 21 14 38 36 46 c22-8 36-25 36-46 V20 C73 17 59 15 50 9z" fill="url(#lg-glow)" opacity="0.35"/>
      <path d="M50 18 C43 23 31 25 20 27 v25 c0 16 11 29 30 35 c19-6 30-19 30-35 V27 C69 25 57 23 50 18z" fill="url(#lg-orange)" stroke="#a34b00" stroke-width="2"/>
      <path d="M33 55 l12 12 l23-28" fill="none" stroke="#0f892f" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- Card shield (no check) -->
    <symbol id="sym-card-shield" viewBox="0 0 100 110">
      <path d="M50 5 C40 12 25 15 10 18 v36 c0 23 16 42 40 51 c24-9 40-28 40-51 V18 C75 15 60 12 50 5z" fill="url(#lg-green)" stroke="#063d1a" stroke-width="3"/>
      <path d="M50 9 C41 15 27 17 14 20 v32 c0 21 14 38 36 46 c22-8 36-25 36-46 V20 C73 17 59 15 50 9z" fill="url(#lg-glow)" opacity="0.35"/>
      <path id="card-plate-shape" d="M50 18 C43 23 31 25 20 27 v25 c0 16 11 29 30 35 c19-6 30-19 30-35 V27 C69 25 57 23 50 18z" fill="url(#lg-orange)" stroke="#a34b00" stroke-width="2"/>
    </symbol>
    <clipPath id="clip-card-plate">
      <path d="M50 18 C43 23 31 25 20 27 v25 c0 16 11 29 30 35 c19-6 30-19 30-35 V27 C69 25 57 23 50 18z"/>
    </clipPath>

    <!-- pictos -->
    <symbol id="ico-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/><path d="M20 20 L16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="ico-mic" viewBox="0 0 24 24"><rect x="9" y="3" width="6" height="10" rx="3" fill="currentColor"/><path d="M5 11 a7 7 0 0 0 14 0 M12 18 v3" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></symbol>
    <symbol id="ico-loc" viewBox="0 0 24 24"><path d="M12 22 c6-9 8-12 8-15 a8 8 0 0 0-16 0 c0 3 2 6 8 15z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="7" r="2" fill="currentColor"/></symbol>
    <symbol id="ico-user" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" fill="currentColor"/><path d="M4 21 a8 8 0 0 1 16 0" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-heart" viewBox="0 0 24 24"><path d="M12 20 C-6 8 6 -2 12 6 C18 -2 30 8 12 20z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-plus" viewBox="0 0 24 24"><path d="M12 5 v14 M5 12 h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="ico-pen" viewBox="0 0 24 24"><path d="M14 4 l6 6 l-10 10 H4 v-6 z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></symbol>
    <symbol id="ico-trash" viewBox="0 0 24 24"><path d="M4 7 h16 M9 7 v-2 h6 v2 M6 7 l1 13 h10 l1-13" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></symbol>
    <symbol id="ico-drag" viewBox="0 0 24 24"><path d="M9 7 h6 M9 12 h6 M9 17 h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
  </svg>

  <header class="container">
    <div class="logo">
      <svg class="logo-badge" viewBox="0 0 100 110" aria-hidden="true"><use href="#sym-logo-shield"/></svg>
      <div class="logo-text">My<em>Sale</em></div>
    </div>
    <form class="search" onsubmit="event.preventDefault()">
      <svg aria-hidden="true" width="20" height="20"><use href="#ico-search"/></svg>
      <input type="search" placeholder="Поиск по объявлениям" />
      <button type="button" class="icon-btn" title="Микрофон"><svg aria-hidden="true" width="20" height="20"><use href="#ico-mic"/></svg></button>
      <button type="button" class="icon-btn" title="Геолокация"><svg aria-hidden="true" width="20" height="20"><use href="#ico-loc"/></svg></button>
    </form>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap" data-build="v12R-clipmask">
      <span class="chip"><svg width="18" height="18"><use href="#ico-user"/></svg>Войти</span><span class="chip" id="buildChip">v12R-clipmask</span>
      <span class="chip"><svg width="18" height="18"><use href="#ico-heart"/></svg>Избранное</span>
      <select id="themeSelect" class="select">
        <option value="winter">Зима</option>
        <option value="spring" selected>Весна</option>
        <option value="summer">Лето</option>
        <option value="autumn">Осень</option>
      </select>
    </div>
  </header>

  <main class="container">
    <section class="panel">
      <div class="toolbar">
        <h2 style="margin:0; font-size:22px">Разделы</h2>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap" data-build="v12R-clipmask">
          <label class="switch"><input id="editToggle" type="checkbox"><span>Режим редактирования</span></label>
          <button class="btn primary" id="addBtn"><svg width="18" height="18" style="vertical-align:-3px"><use href="#ico-plus"/></svg> Добавить</button>
          <button class="btn" id="exportBtn">Экспорт JSON</button>
          <button class="btn" id="importBtn">Импорт JSON</button>
          <input id="importFile" class="file" type="file" accept=".json,application/json"/>
          <button class="btn danger" id="resetBtn">Сброс к дефолту</button>
        </div>
      </div>

      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <dialog id="modal">
    <form method="dialog" class="modal" id="modalForm">
      <h3 id="modalTitle">Новый раздел</h3>
      <div class="row">
        <label>Название
          <input class="input" name="title" required placeholder="Напр. Недвижимость"/>
        </label>
        <label>Ссылка (URL)
          <input class="input" name="href" placeholder="/realty"/>
        </label>
        <label>Иконка
          <select class="select" name="icon">
            <option value="ico-house">SVG: Дом</option>
            <option value="emoji">Emoji</option>
            <option value="image">PNG/JPG</option>
            <option value="anim">Анимированный WebP</option>
          </select>
        </label>
        <label>Emoji / Текст иконки
          <input class="input" name="emoji" placeholder="🏠 или буква"/>
        </label>

        <div id="mediaControls" style="display:none; grid-column:1 / -1; border:1px dashed var(--ring); border-radius:10px; padding:10px; gap:10px; align-items:center">
          <div style="font-weight:600">Медиа для щита</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" type="button" id="btnPickPoster">Выбрать постер</button>
            <button class="btn" type="button" id="btnPickAnim">Выбрать анимацию WebP</button>
            <span id="fileInfo" style="color:var(--ink-dim)"></span>
          </div>
          <div id="mediaPreview" style="margin-top:8px; width:140px; aspect-ratio:1/1; border:1px solid var(--ring); border-radius:12px; overflow:hidden; display:none">
            <img id="prevPoster" alt="" style="width:100%; height:100%; object-fit:cover">
          </div>
        </div>

        <label>Цвет щита
          <input class="color" name="color" type="color" value="#25b24d"/>
        </label>
        <label>Бейдж (число)
          <input class="input" name="badge" type="number" min="0" step="1" placeholder="0"/>
        </label>
        <input id="imageInput" class="file" type="file" accept="image/*"/>
        <input id="posterInput" class="file" type="file" accept="image/*"/>
        <input id="animInput" class="file" type="file" accept="image/webp"/>
      </div>
      <footer>
        <button class="btn danger" value="delete" id="deleteBtn" style="display:none"><svg width="16" height="16" style="vertical-align:-3px"><use href="#ico-trash"/></svg> Удалить</button>
        <button class="btn" value="cancel">Отмена</button>
        <button class="btn" type="button" id="previewBtn">Открыть</button>
        <button class="btn primary" value="ok" id="saveBtn" disabled>Сохранить</button>
      </footer>
    </form>
  </dialog>

  
  <template id="cardTpl">
    <article class="cat" draggable="false">
      <div class="shield-wrap">
        <span class="badge" hidden>0</span>
        <svg class="shield shield-rim" viewBox="0 0 100 110" aria-hidden="true">
          <use href="#sym-card-shield"/>
        </svg>
        <div class="plate-clip"></div>
      </div>
      <div class="label"></div>
      <div class="actions" aria-hidden="true">
        <button class="icon-btn-inline edit"><svg width="18" height="18"><use href="#ico-pen"/></svg></button>
        <button class="icon-btn-inline del"><svg width="18" height="18"><use href="#ico-trash"/></svg></button>
        <div class="icon-small drag" title="Перетащить"><svg width="18" height="18"><use href="#ico-drag"/></svg></div>
      </div>
    </article>
  </template>
    

  <script>
    console.log('MySale build: v12R-clipmask');
    console.log('MySale vitrine build: v7R-anim-ui');
    const KEY = 'mysale.categories.v5R';
    const el = s=>document.querySelector(s);
    const els = s=>Array.from(document.querySelectorAll(s));

    const defaults = [
      {id:crypto.randomUUID(), title:'Недвижимость', icon:{type:'svg', name:'ico-house'}, href:'/realty', color:'#25b24d', badge:0},
      {id:crypto.randomUUID(), title:'Транспорт', icon:{type:'svg', name:'ico-car'}, href:'/transport', color:'#25b24d', badge:0},
      {id:crypto.randomUUID(), title:'Здоровье', icon:{type:'svg', name:'ico-clinic'}, href:'/health', color:'#25b24d', badge:0},
      {id:crypto.randomUUID(), title:'Электроника', icon:{type:'svg', name:'ico-phone'}, href:'/electronics', color:'#25b24d', badge:0},
      {id:crypto.randomUUID(), title:'Услуги', icon:{type:'svg', name:'ico-services'}, href:'/services', color:'#25b24d', badge:0},
      {id:crypto.randomUUID(), title:'Для дома и дачи', icon:{type:'svg', name:'ico-home'}, href:'/home', color:'#25b24d', badge:0},
      {id:crypto.randomUUID(), title:'Работа', icon:{type:'svg', name:'ico-worker'}, href:'/jobs', color:'#25b24d', badge:0},
      {id:crypto.randomUUID(), title:'Путешествия', icon:{type:'svg', name:'ico-travel'}, href:'/travel', color:'#25b24d', badge:0},
    ];

    let data = load();
    let editMode = false, dragId = null;

    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return structuredClone(defaults);
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : structuredClone(defaults);
      }catch(e){ return structuredClone(defaults); }
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(data)); }

    function render(){
      const grid = el('#grid'); grid.innerHTML = '';
      data.forEach(item=> grid.appendChild(renderCard(item)));
      els('.cat').forEach(n=>{ n.classList.toggle('editable', editMode); n.setAttribute('draggable', editMode); });
    }

    function renderCard(item){
      const tpl = el('#cardTpl');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.dataset.id = item.id;
      node.querySelector('.label').textContent = item.title;

      const badge = node.querySelector('.badge');
      if(item.badge && Number(item.badge)>0){ badge.textContent=item.badge; badge.hidden=false; } else { badge.hidden=true; }

      const iconSlot = node.querySelector('.plate-clip');
      
      iconSlot.innerHTML='';
      if(item.icon?.type==='anim' && item.icon.poster && item.icon.anim){
        const p = document.createElement('img'); p.src=item.icon.poster; p.className='poster'; p.alt=''; iconSlot.appendChild(p);
        const a = document.createElement('img'); a.src=item.icon.anim; a.className='anim'; a.alt=''; iconSlot.appendChild(a);
      }else if(item.icon?.type==='image' && item.icon.data){
        const p = document.createElement('img'); p.src=item.icon.data; p.className='poster'; p.alt=''; iconSlot.appendChild(p);
      }else if(item.icon?.type==='emoji'){
        const holder = document.createElement('div'); holder.style="display:grid;place-items:center;width:100%;height:100%;font-size:46px";
        holder.textContent = item.icon.value || '⭐'; iconSlot.appendChild(holder);
      }else{
        const svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('viewBox','0 0 100 110'); svg.style.width='100%'; svg.style.height='100%';
        const use = document.createElementNS('http://www.w3.org/2000/svg','use'); use.setAttributeNS('http://www.w3.org/1999/xlink','href','#'+(item.icon?.name||'ico-house'));
        use.setAttribute('transform','translate(10,18) scale(0.85)'); svg.appendChild(use); iconSlot.appendChild(svg);
      }
        

      node.addEventListener('click', (e)=>{
        if(editMode) return;
        if(e.target.closest('.actions,.edit,.del,.drag')) return;
        if(item.href){ window.open(item.href, '_self'); }
      });

      node.querySelector('.edit').addEventListener('click', (e)=>{ e.stopPropagation(); openModal(item); });
      node.querySelector('.del').addEventListener('click', (e)=>{ e.stopPropagation(); if(confirm('Удалить "'+item.title+'"?')){ data = data.filter(x=>x.id!==item.id); save(); render(); } });

      const dragHandle = node.querySelector('.drag');
      dragHandle.addEventListener('pointerdown', (e)=>{ if(!editMode) return; dragId=item.id; node.style.opacity='.5'; node.setPointerCapture(e.pointerId); });
      dragHandle.addEventListener('pointerup', ()=>{ if(!editMode) return; dragId=null; node.style.opacity=''; });
      node.addEventListener('dragstart', e=> e.preventDefault());
      node.addEventListener('pointerenter', ()=>{
        if(!editMode || !dragId || dragId===item.id) return;
        const from = data.findIndex(x=>x.id===dragId);
        const to   = data.findIndex(x=>x.id===item.id);
        if(from<0||to<0) return;
        const [m]=data.splice(from,1); data.splice(to,0,m); save(); render();
      });

      if(item.icon?.type==='anim'){ node.dataset.anim='1'; }
      return node;
    }

    // Modal
    const modal = el('#modal'); const form = el('#modalForm'); let currentId = null;
    const saveBtn = el('#saveBtn');

    function validateModal(){
      const t=form.elements.title.value.trim();
      const h=form.elements.href.value.trim();
      let okTitle = t.length>0;
      let okHref = false;
      if(h.startsWith('/')) okHref = true;
      else{
        try{ new URL(h); okHref = true; }catch(e){ okHref = false; }
      }
      let ok = okTitle && okHref;
      if(form.elements.icon.value==='anim'){ ok = ok && !!form.dataset.posterData && !!form.dataset.animData; }
      saveBtn.disabled = !ok;
      return ok;
    }

    function openModal(item){
      currentId = item?.id || null;
      form.reset();
      el('#deleteBtn').style.display = item ? '' : 'none';
      el('#modalTitle').textContent = item ? 'Редактировать раздел' : 'Новый раздел';
      form.elements.title.value = item?.title || '';
      form.elements.href.value  = item?.href || '';
      form.elements.icon.value  = item?.icon?.type==='emoji' ? 'emoji' :
                                  item?.icon?.type==='image' ? 'image' :
                                  item?.icon?.type==='anim'  ? 'anim'  :
                                  (item?.icon?.name || 'ico-house');
      form.elements.emoji.value = item?.icon?.type==='emoji' ? (item.icon.value||'') : '';
      form.elements.color.value = item?.color || '#25b24d';
      form.elements.badge.value = item?.badge || 0;
      if(item?.icon?.type==='anim'){ form.dataset.posterData=item.icon.poster||''; form.dataset.animData=item.icon.anim||''; } else { form.dataset.posterData=''; form.dataset.animData=''; }
      modal.showModal(); validateModal(); refreshMediaUI();
    }

    form.addEventListener('input', validateModal);
    el('#previewBtn').addEventListener('click', ()=>{
      const h=form.elements.href.value.trim(); if(!h){alert('Сначала укажите ссылку'); return;}
      window.open(h.startsWith('/')?h:h,'_blank','noopener');
    });

    
    // Media controls
    const mediaControls = el('#mediaControls');
    const btnPickPoster = el('#btnPickPoster');
    const btnPickAnim   = el('#btnPickAnim');
    const fileInfo      = el('#fileInfo');
    const mediaPreview  = el('#mediaPreview');
    const prevPoster    = el('#prevPoster');

    function refreshMediaUI() {
      const mode = form.elements.icon.value;
      const poster = form.dataset.posterData || '';
      const anim = form.dataset.animData || '';
      const need = mode === 'anim';
      mediaControls.style.display = need ? 'grid' : 'none';
      fileInfo.textContent = need ? (poster ? 'Постер выбран' : 'Постер не выбран') + ' · ' + (anim ? 'Анимация выбрана' : 'Анимация не выбрана') : '';
      if (need && poster) {
        mediaPreview.style.display = 'block';
        prevPoster.src = poster;
      } else {
        mediaPreview.style.display = 'none';
        prevPoster.removeAttribute('src');
      }
    }
    btnPickPoster?.addEventListener('click', ()=> el('#posterInput').click());
    btnPickAnim?.addEventListener('click', ()=> el('#animInput').click());

    // Submit handled by dialog close value
    modal.addEventListener('close', ()=>{
      if(modal.returnValue==='ok'){
        if(!validateModal()){ alert('Заполните поля'); modal.showModal(); return; }
        const payload = {
          title: form.elements.title.value.trim(),
          href:  form.elements.href.value.trim(),
          color: form.elements.color.value,
          badge: Number(form.elements.badge.value||0),
          icon: null
        };
        const iconSel = form.elements.icon.value;
        if(iconSel==='emoji'){
          payload.icon = {type:'emoji', value: form.elements.emoji.value || '⭐'};
        }else if(iconSel==='image'){
          const dataUrl = form.dataset.imageData || '';
          payload.icon = dataUrl ? {type:'image', data:dataUrl} : {type:'emoji', value:'🖼️'};
        }else if(iconSel==='anim'){
          const poster = form.dataset.posterData || '';
          const anim   = form.dataset.animData || '';
          if(poster && anim){ payload.icon = {type:'anim', poster, anim}; }
          else if(poster){ payload.icon = {type:'image', data:poster}; }
          else{ payload.icon = {type:'emoji', value:'🖼️'}; }
        }else{
          payload.icon = {type:'svg', name: iconSel};
        }

        if(currentId){
          const i=data.findIndex(x=>x.id===currentId); if(i>-1) data[i]={...data[i], ...payload};
        }else{
          data.push({id:crypto.randomUUID(), ...payload});
        }
        save(); render();
      }else if(modal.returnValue==='delete' && currentId){
        data = data.filter(x=>x.id!==currentId); save(); render();
      }
      form.dataset.imageData=''; form.dataset.posterData=''; form.dataset.animData=''; currentId=null;
    });

    // Icon change triggers file pickers
    form.elements.icon.addEventListener('change', ()=>{ refreshMediaUI(); 
      const v=form.elements.icon.value;
      if(v==='image'){ el('#imageInput').click(); }
      else if(v==='anim'){ setTimeout(()=> el('#posterInput').click(), 50); }
    });

    // Image picker (PNG/JPG)
    el('#imageInput').addEventListener('change', (e)=>{
      const f = (e.target && e.target.files && e.target.files[0]) ? e.target.files[0] : null;
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(){ form.dataset.imageData = reader.result; validateModal(); refreshMediaUI(); };
      reader.readAsDataURL(f);
    });

    // Poster for animated WebP
    el('#posterInput').addEventListener('change', (e)=>{
      fileInfo.textContent='Загрузка постера...';
      const f = (e.target && e.target.files && e.target.files[0]) ? e.target.files[0] : null;
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(){ form.dataset.posterData = reader.result; refreshMediaUI(); validateModal(); };
      reader.readAsDataURL(f);
    });

    // Animated WebP
    el('#animInput').addEventListener('change', (e)=>{
      fileInfo.textContent='Загрузка анимации...';
      const f = (e.target && e.target.files && e.target.files[0]) ? e.target.files[0] : null;
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(){ form.dataset.animData = reader.result; refreshMediaUI(); validateModal(); };
      reader.readAsDataURL(f);
    });

    // Edit mode toggle
    el('#editToggle').addEventListener('change', (e)=>{ editMode=e.target.checked; render(); });

    // Export / Import / Reset
    el('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mysale_categories.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    el('#importBtn').addEventListener('click', ()=> el('#importFile').click());
    el('#importFile').addEventListener('change', async e=>{
      const f=e.target.files[0]; if(!f) return;
      try{ const t=await f.text(); const j=JSON.parse(t); if(!Array.isArray(j)) throw new Error('JSON должен быть массивом'); data=j; save(); render(); }
      catch(err){ alert('Ошибка импорта: '+err.message); }
    });
    el('#resetBtn').addEventListener('click', ()=>{ if(confirm('Сбросить витрину к дефолту?')){ data=structuredClone(defaults); save(); render(); } });

    // Themes
    const themes={winter:'theme--winter', spring:'theme--spring', summer:'theme--summer', autumn:'theme--autumn'};
    const themeSelect=el('#themeSelect');
    function applyTheme(n){ document.body.className = themes[n]||'theme--spring'; }
    themeSelect.addEventListener('change', ()=> applyTheme(themeSelect.value)); applyTheme(themeSelect.value);

    render();
  </script>
</body>
</html>
