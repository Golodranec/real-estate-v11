<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Builder Admin</title>
<style>
  body{margin:0;background:#0f1115;color:#e6e6e6;font:14px system-ui}
  header{padding:10px;background:#161a22;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button{padding:6px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn{background:#5b9cff;color:#fff}
  .btn.secondary{background:#2a3140}
  main{display:grid;grid-template-columns:1fr 1fr;min-height:90vh}
  .builder,.preview{padding:10px}
  .canvas{display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:80px;gap:6px;
    background:#0b0d12;border:1px dashed #333;padding:6px;min-height:80vh}
  .block{background:#1f2530;border:1px solid #2a3140;border-radius:8px;display:flex;
    align-items:center;justify-content:center;position:relative;overflow:hidden}
  .block .label{pointer-events:none}
  .block.dragging{opacity:.5}
  .resize{position:absolute;right:0;bottom:0;width:12px;height:12px;cursor:se-resize;background:#5b9cff}
  .toolbar{position:absolute;top:2px;right:2px;display:flex;gap:2px}
  .toolbar button{padding:2px 6px;font-size:11px}
  .preview-surface{background:#0b0d12;border:1px solid #2a3140;padding:10px;border-radius:10px}
  .field{margin-bottom:6px}
  .field label{font-size:12px;color:#ccc;display:block;margin-bottom:2px}
  .field input,.field select,.field textarea{width:100%;padding:6px;border-radius:6px;border:1px solid #333;background:#111722;color:#fff}
  .card{background:#1a202c;border:1px solid #2a3140;border-radius:10px;padding:10px;margin-bottom:8px}
  .banner{background:#223355;color:#fff;padding:20px;text-align:center;border-radius:8px}
  .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
  .gallery div{background:#333;height:60px;border-radius:6px}
</style>
</head>
<body>
<header>
  <button class="btn" onclick="addBlock('map')">–ö–∞—Ä—Ç–∞</button>
  <button class="btn" onclick="addBlock('filters')">–§–∏–ª—å—Ç—Ä—ã</button>
  <button class="btn" onclick="addBlock('form')">–§–æ—Ä–º–∞</button>
  <button class="btn" onclick="addBlock('cards')">–°–ø–∏—Å–æ–∫</button>
  <button class="btn" onclick="addBlock('table')">–¢–∞–±–ª–∏—Ü–∞</button>
  <button class="btn" onclick="addBlock('banner')">–†–µ–∫–ª–∞–º–∞</button>
  <button class="btn" onclick="addBlock('gallery')">–ì–∞–ª–µ—Ä–µ—è</button>
  <button class="btn secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
  <label class="btn secondary">–ò–º–ø–æ—Ä—Ç<input id="importInput" type="file" hidden></label>
  <button class="btn secondary" id="resetBtn">–°–±—Ä–æ—Å</button>
</header>
<main>
  <section class="builder">
    <h3>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h3>
    <div class="canvas" id="canvas"></div>
  </section>
  <section class="preview">
    <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
    <div class="preview-surface" id="preview"></div>
  </section>
</main>
<script>
const KEY="builder-layout-v1";
let layout=load()||[];
function save(){localStorage.setItem(KEY,JSON.stringify(layout))}
function load(){try{return JSON.parse(localStorage.getItem(KEY)||"")}catch(e){return null}}
function reset(){layout=[];save();render()}

const types={
  map:"üó∫Ô∏è –ö–∞—Ä—Ç–∞",
  filters:"üîé –§–∏–ª—å—Ç—Ä—ã",
  form:"üìù –§–æ—Ä–º–∞",
  cards:"üìã –°–ø–∏—Å–æ–∫",
  table:"üìä –¢–∞–±–ª–∏—Ü–∞",
  banner:"üì∞ –†–µ–∫–ª–∞–º–∞",
  gallery:"üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è"
};
function addBlock(type){
  layout.push({id:Date.now(),type,x:1,y:1,w:6,h:2,bg:"#1f2530"});
  save();render()
}

document.getElementById("exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify(layout,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);const a=document.createElement("a");
  a.href=url;a.download="layout.json";a.click();URL.revokeObjectURL(url)
};
document.getElementById("importInput").addEventListener("change",async e=>{
  const f=e.target.files?.[0];if(!f)return;
  const txt=await f.text();try{layout=JSON.parse(txt);save();render()}catch(err){alert("–û—à–∏–±–∫–∞ JSON")}
});
document.getElementById("resetBtn").onclick=()=>{if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥?"))reset()};

function render(){
  const canvas=document.getElementById("canvas");
  const preview=document.getElementById("preview");
  canvas.innerHTML="";preview.innerHTML="";

  // –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Admin.html
  let adminData={};
  try{adminData=JSON.parse(localStorage.getItem("builder-data-v1")||"{}")}catch(e){}

  for(const b of layout){
    const el=document.createElement("div");
    el.className="block";
    el.style.gridColumn=`${b.x}/span ${b.w}`;
    el.style.gridRow=`${b.y}/span ${b.h}`;
    el.style.background=b.bg;
    el.innerHTML=`<div class="label">${types[b.type]}</div>
      <div class="resize"></div>
      <div class="toolbar">
        <button data-del>‚úñ</button>
      </div>`;
    el.querySelector("[data-del]").onclick=()=>{
      layout=layout.filter(x=>x.id!==b.id);save();render()
    };
    // resize
    el.querySelector(".resize").onmousedown=e=>{
      e.preventDefault();
      const startX=e.clientX,startY=e.clientY,startW=b.w,startH=b.h;
      function mm(ev){
        const dx=Math.round((ev.clientX-startX)/50);
        const dy=Math.round((ev.clientY-startY)/50);
        b.w=Math.max(1,Math.min(12,startW+dx));
        b.h=Math.max(1,startH+dy);
        save();render()
      }
      function up(){window.removeEventListener("mousemove",mm);window.removeEventListener("mouseup",up)}
      window.addEventListener("mousemove",mm);
      window.addEventListener("mouseup",up)
    };
    canvas.appendChild(el);

    // preview
    const pv=document.createElement("div");
    pv.style.border="1px solid #333";pv.style.padding="6px";pv.style.margin="4px 0";pv.style.borderRadius="6px";
    // –≤—ã–≤–æ–¥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    if(b.type==="map"){pv.innerHTML="<div style='background:#223;height:200px;border-radius:8px;display:flex;align-items:center;justify-content:center'>üó∫Ô∏è –ö–∞—Ä—Ç–∞</div>"}
    else if(b.type==="filters"){
      pv.innerHTML="<h4>–§–∏–ª—å—Ç—Ä—ã</h4>";
      (adminData.filtersConfig||[]).forEach(f=>{
        const div=document.createElement("div");
        div.className="field";
        div.innerHTML=`<label>${f.label}</label><input placeholder="${f.field}"/>`;
        pv.appendChild(div);
      })
    }
    else if(b.type==="form"){
      pv.innerHTML="<h4>–§–æ—Ä–º–∞</h4>";
      (adminData.formFields||[]).forEach(ff=>{
        const div=document.createElement("div");
        div.className="field";
        div.innerHTML=`<label>${ff.label}</label><input placeholder="${ff.id}"/>`;
        pv.appendChild(div);
      })
    }
    else if(b.type==="cards"){
      pv.innerHTML="<h4>–°–ø–∏—Å–æ–∫</h4>";
      for(let i=0;i<3;i++){pv.innerHTML+=`<div class="card">–û–±—ä—è–≤–ª–µ–Ω–∏–µ ${i+1}</div>`}
    }
    else if(b.type==="table"){
      pv.innerHTML="<h4>–¢–∞–±–ª–∏—Ü–∞</h4><table border=1 width=100% style='border-collapse:collapse'><tr><th>ID</th><th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th></tr><tr><td>1</td><td>–ü—Ä–∏–º–µ—Ä</td></tr></table>";
    }
    else if(b.type==="banner"){
      pv.innerHTML="<div class='banner'>–†–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫</div>";
    }
    else if(b.type==="gallery"){
      pv.innerHTML="<div class='gallery'><div></div><div></div><div></div></div>";
    }
    preview.appendChild(pv);
  }
}
render();
</script>
</body>
</html>
