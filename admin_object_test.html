<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Object Test — v13.9.6</title>
<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--text:#d7e2f2;--muted:#9fb0c8;--border:#273248;--accent:#4aa8ff;--danger:#ef4444;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1420;position:sticky;top:0;z-index:10}
.badge{padding:3px 8px;border-radius:8px;background:#6d28d9;font-weight:700}
.tabs{display:flex;gap:8px;margin-left:8px}
.tab{background:#1a2234;border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:#cfe0ff;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{padding:12px;display:grid;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
h3{margin:0 0 10px 0;color:#cfe0ff}
.btn{background:#1e293b;border:1px solid var(--border);color:#dbe8ff;padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:#3a4c6b}
.btn.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff;width:100%}
label{display:block;opacity:.9;margin-bottom:6px}
small.muted{color:#9fb0c8}
.card{background:#172133;border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:12px}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.preview-form{margin-top:20px;padding:12px;border:1px solid var(--border);border-radius:10px;background:#172133}
</style>
</head>
<body>
<header>
  <span id="ver" class="badge">cascade-v13.9.6-test</span>
  <div class="tabs">
    <button class="tab" data-tab="filters">Фильтры</button>
    <button class="tab" data-tab="fields">Поля</button>
    <button class="tab" data-tab="layout">Макет</button>
    <button class="tab" data-tab="preview">Предпросмотр</button>
    <button class="tab active" data-tab="objects">Форма объектов</button>
  </div>
</header>

<main>
  <section id="tab-filters" class="panel" style="display:none"><em>Пусто</em></section>
  <section id="tab-fields" class="panel" style="display:none"><em>Пусто</em></section>
  <section id="tab-layout" class="panel" style="display:none"><em>Пусто</em></section>
  <section id="tab-preview" class="panel" style="display:none"><em>Пусто</em></section>

  <section id="tab-objects" class="panel">
    <h3>Форма объектов — настройка полей</h3>
    <div class="row">
      <button class="btn" onclick="addObjField()">+ Поле</button>
      <button class="btn warn" onclick="resetObjForm()">Сбросить</button>
      <button class="btn" onclick="exportObjForm()">Экспорт JSON</button>
      <label class="btn"><input type="file" id="importFile" style="display:none"/>Импорт JSON</label>
    </div>
    <div id="objFields" class="grid"></div>
    <div class="preview-form">
      <h3>Мини-просмотр формы «Добавить объект»</h3>
      <form id="objPreview"></form>
    </div>
  </section>
</main>

<footer>build: admin_cascade_v13.9.6-test</footer>

<script>
const OBJFORM_KEY="objectFormConfig";
let objFormConfig=JSON.parse(localStorage.getItem(OBJFORM_KEY)||"[]");

function saveObjForm(){localStorage.setItem(OBJFORM_KEY,JSON.stringify(objFormConfig));}
function resetObjForm(){if(confirm("Сбросить форму объектов?")){objFormConfig=[];saveObjForm();renderObjForm();}}

function addObjField(){
  let i=objFormConfig.length+1;
  objFormConfig.push({label:"Новое поле",name:"field_"+i,type:"text",required:false});
  saveObjForm();renderObjForm();
}
function removeObjField(idx){objFormConfig.splice(idx,1);saveObjForm();renderObjForm();}

function renderObjForm(){
  let box=document.getElementById("objFields"); box.innerHTML="";
  objFormConfig.forEach((f,i)=>{
    let card=document.createElement("div"); card.className="card";
    card.innerHTML=`
      <div class="row"><h3>${f.label}</h3><button class="btn danger" onclick="removeObjField(${i})">Удалить</button></div>
      <div class="form-grid">
        <div><label>Заголовок</label><input value="${f.label}" oninput="objFormConfig[${i}].label=this.value;saveObjForm();renderObjForm();"></div>
        <div><label>Имя поля</label><input value="${f.name}" oninput="objFormConfig[${i}].name=this.value;saveObjForm();"></div>
        <div><label>Тип</label>
          <select onchange="objFormConfig[${i}].type=this.value;saveObjForm();renderObjForm();">
            ${["text","number","select","range","images","coords"].map(t=>`<option value="${t}" ${f.type===t?"selected":""}>${t}</option>`).join("")}
          </select>
        </div>
        <div><label>Обязательное</label><input type="checkbox" ${f.required?"checked":""} onchange="objFormConfig[${i}].required=this.checked;saveObjForm();"></div>
      </div>`;
    if(f.type==="select"){
      let opt=document.createElement("div"); opt.innerHTML=`<label>Опции (через запятую)</label><textarea rows="2">${f.options?f.options.join(", "):""}</textarea>`;
      opt.querySelector("textarea").oninput=function(){objFormConfig[i].options=this.value.split(",").map(s=>s.trim()).filter(Boolean);saveObjForm();renderObjForm();};
      card.appendChild(opt);
    }
    box.appendChild(card);
  });
  renderObjPreview();
}

function renderObjPreview(){
  let form=document.getElementById("objPreview"); form.innerHTML="";
  objFormConfig.forEach(f=>{
    let wrap=document.createElement("div"); wrap.style.marginBottom="8px";
    let lab=document.createElement("label"); lab.textContent=f.label; wrap.appendChild(lab);
    if(f.type==="text"||f.type==="number"){
      let inp=document.createElement("input"); inp.type=f.type; if(f.required) inp.required=true; wrap.appendChild(inp);
    }else if(f.type==="select"){
      let sel=document.createElement("select"); if(f.options) f.options.forEach(o=>{let opt=document.createElement("option");opt.textContent=o;sel.appendChild(opt);}); wrap.appendChild(sel);
    }else if(f.type==="range"){
      let a=document.createElement("input"); let b=document.createElement("input"); a.placeholder="от"; b.placeholder="до"; wrap.appendChild(a); wrap.appendChild(b);
    }else if(f.type==="images"){
      let inp=document.createElement("input"); inp.type="file"; inp.multiple=true; wrap.appendChild(inp);
    }else if(f.type==="coords"){
      let inp=document.createElement("input"); inp.placeholder="lat, lng"; wrap.appendChild(inp);
    }
    form.appendChild(wrap);
  });
}

function exportObjForm(){
  let blob=new Blob([JSON.stringify(objFormConfig,null,2)],{type:"application/json"});
  let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="objectFormConfig.json"; a.click();
}
document.getElementById("importFile").onchange=function(e){
  let f=e.target.files[0]; if(!f)return;
  let r=new FileReader(); r.onload=function(){try{let obj=JSON.parse(r.result); if(Array.isArray(obj)){objFormConfig=obj;saveObjForm();renderObjForm();}}catch(err){alert("Ошибка импорта");}}; r.readAsText(f);
}

renderObjForm();

/* табы */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.onclick=()=>{document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));btn.classList.add("active");
    ["filters","fields","layout","preview","objects"].forEach(id=>{document.getElementById("tab-"+id).style.display=(btn.dataset.tab===id)?"block":"none";});
  };
});
</script>
</body>
</html>
