<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>categories_editor — v22S</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --line:#1f2937; --text:#e5e7eb; --ok:#22c55e;
    --warn:#f59e0b; --err:#ef4444; --field:#0b1220
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial;height:100vh;display:flex;flex-direction:column}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#0b1220;position:sticky;top:0;z-index:10}
  .left,.right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#0b1220;font-size:12px}
  nav.tabs{display:flex;gap:8px;padding:8px;background:#111827;border-bottom:1px solid var(--line)}
  nav.tabs button{padding:8px 12px;border-radius:6px;border:1px solid var(--line);background:#1f2937;color:var(--text);cursor:pointer}
  nav.tabs button.active{background:var(--ok);color:#052e16}
  main{flex:1;overflow:auto;padding:12px;max-width:1200px;margin:0 auto;width:100%}
  button{padding:6px 10px;border-radius:6px;border:1px solid var(--line);background:#1f2937;color:var(--text);cursor:pointer}
  button.primary{background:var(--ok);color:#052e16}
  button.warn{background:var(--warn);color:#3b2306}
  button.danger{background:var(--err);color:#fff}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0;cursor:default}
  .card.collapsed .row{display:none}
  .card h3{margin:0 0 8px 0;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
  label{display:block;font-size:12px;opacity:.9;margin-bottom:4px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid var(--line);background:var(--field);color:var(--text);font:inherit}
  textarea{min-height:60px}
  .mini{font-size:12px;opacity:.75}
  .ghost{opacity:.7}
  .top-actions{display:flex;gap:8px;align-items:center}
  .hidden{display:none}
  /* Preview: 6 cols desktop, 3 cols tablet, 1 col mobile */
  .preview-form { display:grid; gap:16px; grid-template-columns:repeat(6, minmax(0,1fr)); }
  .preview-form .col-1{grid-column:span 1}
  .preview-form .col-2{grid-column:span 2}
  .preview-form .col-3{grid-column:span 3}
  .preview-form .col-4{grid-column:span 4}
  .preview-form .col-5{grid-column:span 5}
  .preview-form .col-6{grid-column:span 6}
  @media (max-width:1100px){
    .preview-form{grid-template-columns:repeat(3, minmax(0,1fr));}
    .preview-form .col-4,.preview-form .col-5,.preview-form .col-6{grid-column:span 3}
    .preview-form .col-3{grid-column:span 3}
    .preview-form .col-2{grid-column:span 2}
    .preview-form .col-1{grid-column:span 1}
  }
  @media (max-width:640px){
    .preview-form{grid-template-columns:1fr;}
    .preview-form [class^="col-"]{grid-column:span 1}
  }
  .hint{font-size:12px;color:#9ca3af;margin-top:2px}
  .inline{display:flex;gap:8px;align-items:center}
  .dropdown{position:relative}
  .filter-select{display:flex;align-items:center;justify-content:space-between;gap:8px;width:100%;padding:8px 10px;background:var(--field);color:var(--text);border:1px solid var(--line);border-radius:8px;cursor:pointer}
  .filter-select .arrow{transition:transform .15s ease}
  .dropdown.open .filter-select .arrow{transform:rotate(180deg)}
  .dropdown-menu{position:absolute;top:calc(100% + 6px);left:0;min-width:100%;background:var(--field);border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:50;display:none;max-height:320px;overflow:auto}
  .dropdown.open .dropdown-menu{display:block}
  .dropdown-menu .item{display:flex;align-items:center;gap:10px;padding:10px 12px;font-size:14px;color:var(--text);cursor:pointer}
  .dropdown-menu .item:hover{background:#1f2937}
  .dropdown-menu .item input{width:18px;height:18px}
  .muted{opacity:.7}
  /* Folder bar */
  .folderbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .title-wrap{display:flex;align-items:center;gap:8px;min-width:0}
  .title-actions{display:flex;align-items:center;gap:8px}
  .title-actions .ghost{width:32px;text-align:center;padding-left:0;padding-right:0}

</style>
</head>
<body>
  <header>
    <div class="left">
      <strong>Категории — редактор с папками</strong>
      <span class="badge">v22S</span>
      <span id="sizeBadge" class="badge">Размер: …</span>
      <span id="statusBadge" class="badge">Сохранено</span>
    </div>
    <div class="right top-actions">
      <button id="collapseAll" class="warn">Свернуть все</button>
      <button id="expandAll" class="warn">Развернуть все</button>
      <button id="undoBtn">↶ Undo</button>
      <button id="redoBtn">↷ Redo</button>
      <input type="file" id="fileInput" accept=".json,application/json" style="display:none">
      <button id="importBtn">Импорт</button>
      <button id="exportBtn" class="primary">Экспорт</button>
      <button id="addBtn">+ Категория</button>
      <button id="clearBtn" class="danger">Очистить</button>
    </div>
  </header>

  <nav class="tabs">
    <button id="tab-editor" class="active">Редактор</button>
    <button id="tab-preview">Предпросмотр</button>
    <button id="tab-help">Справка</button>
  </nav>

  <main>
    <section id="editorSection">
      <div class="card">
        <div class="folderbar">
          <label>Папка</label>
          <select id="folderFilter"></select>
          <label class="mini">Подпапка</label>
          <select id="subFolderFilter"></select>
          <button id="addFolder">+ Папка</button>
          <button id="renameFolder">Переименовать</button>
          <button id="deleteFolder" class="danger">Удалить</button>
        </div>
      </div>
      <div id="list"></div>
    </section>

    <section id="previewSection" class="hidden">
      <form id="previewForm" class="preview-form"></form>
    </section>

    <section id="helpSection" class="hidden">
      <div class="card">
        <h3>Подсказки</h3>
        <ul>
          <li>Плейсхолдер для select — «Все объявления». Он выбран по умолчанию и виден сразу.</li>
          <li>Тип <b>radio</b> — жёсткий выбор (без пустого варианта). Валюта по умолчанию UZS.</li>
          <li>Undo/Redo: кнопки вверху, также Ctrl+Z / Ctrl+Shift+Z.</li>
          <li>Свернуть/развернуть все — только для редактора. У отдельных карточек — иконка «▾» справа от заголовка.</li>
          <li>Сетка предпросмотра — 6 колонок: col-1…col-6. Старые full/half/third мэпятся на col-6/col-3/col-2.</li>
        </ul>
      </div>
    </section>
  </main>

<script>
const $=s=>document.querySelector(s);
const el=(t,p={})=>Object.assign(document.createElement(t),p);
const uid=()=>Math.random().toString(36).slice(2,9);
// --- persist preview & folder selection
const LS_PREVIEW = "categories_editor_v22D_preview";

// === runtime helpers ===

function setCurrentSubFolder(val){
  currentSubFolder = val || "__ALL__";
  try{ localStorage.setItem(LS_SUBFOLDER, currentSubFolder); }catch(e){}
  const s = document.getElementById('subFolderFilter');
  if(s) s.value = currentSubFolder;
  renderEditor();
}
function listSubFoldersSorted(parentId){
  const parent = getFolderById(parentId);
  if(!parent) return [];
  const base = String(parent.title||"").trim();
  return (data.folders||[]).slice()
    .filter(f=>{
      const t=String(f.title||"").trim();
      return t===base || t.startsWith(base + "/");
    })
    .sort((a,b)=>String(a.title||"").localeCompare(String(b.title||"")))
    .map(f=>{
      const rel = String(f.title||"").trim().slice(base.length).replace(/^\//,'');
      const parts=rel.split("/").filter(Boolean);
      const last = parts.length? parts[parts.length-1] : base;
      const depth = parts.length;
      return {id:f.id, last, depth};
    });
}
function setCurrentFolder(val){
  currentFolder = val || "__ALL__";
  try{ localStorage.setItem(LS_FOLDER, currentFolder); }catch(e){}
  // Reset subfolder when parent changes
  currentSubFolder = "__ALL__";
  try{ localStorage.setItem(LS_SUBFOLDER, currentSubFolder); }catch(e){}
  // Reflect in UI
  const fsel = document.getElementById('folderFilter');
  if(fsel) fsel.value = currentFolder;
  const ssel = document.getElementById('subFolderFilter');
  if(ssel) ssel.value = currentSubFolder;
  // Rebuild dropdowns and rerender
  updateFolderFilter();
  renderEditor();
}

function getFolderById(id){ return (data.folders||[]).find(f=>f.id===id) || null; }
function descendantFolderIds(rootId){
  const out=new Set();
  const root=getFolderById(rootId);
  if(!root) return out;
  const base=String(root.title||"").trim();
  (data.folders||[]).forEach(f=>{
    const t=String(f.title||"").trim();
    if(t===base || t.startsWith(base + "/")) out.add(f.id);
  });
  return out;
}
const LS_FOLDER  = "categories_editor_v22D_folder";
const LS_SUBFOLDER = "categories_editor_v22D_subfolder";

function loadPreviewValues(){
  try{ return JSON.parse(localStorage.getItem(LS_PREVIEW)||"{}"); }catch(e){ return {}; }
}
function savePreviewValues(){
  try{ localStorage.setItem(LS_PREVIEW, JSON.stringify(previewValues)); }catch(e){}
}


const LS_KEY="categories_editor_v22D_data";
let data={folders:[],categories:[],collapsed:{}};
function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw) data=JSON.parse(raw); }catch{} }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)); updateSize(); $("#statusBadge").textContent="Сохранено"; }

// History (undo/redo)
const snapshot=()=>JSON.parse(JSON.stringify(data));
let hist=[], future=[], pending=null;
function pushHistory(preSnap){ if(preSnap){ hist.push(preSnap); if(hist.length>50) hist.shift(); future.length=0; } }
function undo(){ if(hist.length){ future.push(snapshot()); data=hist.pop(); save(); renderEditor(); renderPreview(); } }
function redo(){ if(future.length){ hist.push(snapshot()); data=future.pop(); save(); renderEditor(); renderPreview(); } }
$("#undoBtn").onclick=undo; $("#redoBtn").onclick=redo;
document.addEventListener("keydown",e=>{ if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); if(e.shiftKey) redo(); else undo(); } });

const listEl=$("#list");
let currentFolder=(localStorage.getItem(LS_FOLDER)||"__ALL__");
let currentSubFolder=(localStorage.getItem(LS_SUBFOLDER)||"__ALL__");

function migrateIfNeeded(){
// unified setter to sync all folder filters
function setCurrentFolder(val){
  currentFolder = val || "__ALL__";
  localStorage.setItem(LS_FOLDER, currentFolder);
  document.querySelectorAll('#folderFilter, .folderbar select').forEach(s=>{ if(s) s.value=currentFolder; });
  renderEditor();
}

  // Если импортирована старая схема (без folders)
  if(!Array.isArray(data.folders) || !data.folders.length){
    const rootId = "root";
    data.folders = [{id:rootId,title:"(Все)",open:true}];
    data.categories.forEach(c=>{ if(!c.folderId) c.folderId=rootId; });
  }

// ===== Nested folders helpers =====
function getFolderById(id){ return (data.folders||[]).find(f=>f.id===id) || null; }
function listFoldersSorted(){
  const arr=(data.folders||[]).slice().sort((a,b)=>String(a.title||"").localeCompare(String(b.title||"")));
  return arr.map(f=>{
    const parts=String(f.title||"").split("/").filter(Boolean);
    return {id:f.id,title:String(f.title||""),last:parts.length?parts[parts.length-1]:String(f.title||""),depth:Math.max(0,parts.length-1)};
  });
}
function descendantFolderIds(rootId){
  const ids=new Set();
  const root=getFolderById(rootId);
  if(!root) return ids;
  const base=String(root.title||"").trim();
  (data.folders||[]).forEach(f=>{
    const t=String(f.title||"").trim();
    if(t===base || t.startsWith(base + "/")) ids.add(f.id);
  });
  return ids;
}
function populateFolderSelect(selectEl, currentId){
  selectEl.innerHTML="";
  listFoldersSorted().forEach(F=>{
    const label=(F.depth>0? "  ".repeat(F.depth):"") + F.last;
    selectEl.append(new Option(label, F.id, false, F.id===(currentId||"")));
  });
}

  // Гарантия полей
  data.categories.forEach(c=>{
    if(!c.id) c.id=uid();
    if(!c.layout) c.layout="half";
    if(!c.type) c.type="text";
    if(!c.folderId) c.folderId = data.folders[0].id;
  });
  if(typeof data.collapsed!=='object') data.collapsed={};
  try{
    const titleToId = Object.fromEntries((data.folders||[]).map(f=>[String(f.title||""), f.id]));
    data.categories.forEach(c=>{
      if(c.folderId && !getFolderById(c.folderId)){
        const mapped = titleToId[String(c.folderId)] || null;
        if(mapped) c.folderId = mapped;
      }
    });
  }catch{};

}

function updateFolderFilter(){
  const sels = Array.from(document.querySelectorAll('#folderFilter, .folderbar select'));
  if(!sels.length) return;
  const opts = [];
  opts.push({value:"__ALL__", label:"(Все)"});
  const arr=(data.folders||[]).slice().sort((a,b)=>String(a.title||"").localeCompare(String(b.title||"")));
  arr.forEach(f=>{
    const parts=String(f.title||"").split("/").filter(Boolean);
    const label=(parts.length>1? "  ".repeat(parts.length-1):"") + (parts[parts.length-1]||String(f.title||""));
    opts.push({value:f.id,label});
  });
  sels.forEach(sel=>{
    while(sel.firstChild) sel.removeChild(sel.firstChild);
    opts.forEach(o=> sel.append(new Option(o.label, o.value)));
    sel.onchange = ()=> setCurrentFolder(sel.value);
  });
  const target = opts.some(o=>o.value===currentFolder) ? currentFolder : "__ALL__";
  sels.forEach(sel=> sel.value = target);

  // --- subfolder select update
  const subSel = document.getElementById('subFolderFilter');
  if(subSel){
    while(subSel.firstChild) subSel.removeChild(subSel.firstChild);
    const subOpts = [{value:"__ALL__", label:"(Все)"}];
    if(currentFolder !== "__ALL__"){
      listSubFoldersSorted(currentFolder).forEach(sf=>{
        if(sf.depth===0) return;
        const label = (sf.depth>0? "  ".repeat(sf.depth):"") + sf.last;
        subOpts.push({value:sf.id,label});
      });
    }
    subOpts.forEach(o=> subSel.append(new Option(o.label, o.value)));
    subSel.onchange = ()=> setCurrentSubFolder(subSel.value);
    const valid = subOpts.some(o=>o.value===currentSubFolder) ? currentSubFolder : "__ALL__";
    subSel.value = valid;
    try{ localStorage.setItem(LS_SUBFOLDER, subSel.value); }catch(e){}
  }
}


function renderEditor(){
  listEl.innerHTML="";
  // фильтр по папке: (Все) показывает все, включая без папки
  const items = data.categories.filter(c => {
    const activeRoot = (currentFolder==="__ALL__") ? "__ALL__" : (currentSubFolder && currentSubFolder!=="__ALL__" ? currentSubFolder : currentFolder);
    if(activeRoot==="__ALL__") return true;
    const fid=(c.folderId||"");
    const set=descendantFolderIds(activeRoot);
    if(set.has(fid)) return true;
    // fallback via titles if ids unavailable
    const cf=getFolderById(activeRoot), ff=getFolderById(fid);
    if(!cf || !ff) return false;
    const base=String(cf.title||"").trim(), t=String(ff.title||"").trim();
    return t===base || t.startsWith(base + "/");
  });

  items.forEach((f, idx)=>{
    const c=el("div",{className:"card"});
    c.dataset.id=f.id;

    const h=el("h3");
    const leftWrap=el("span",{className:"title-wrap"});
    const titleText = el("span",{textContent:f.title||"Без заголовка"});
    const ghost = el("span",{className:"mini ghost",textContent:`(${f.name||f.id})`});
    leftWrap.append(titleText, ghost);
    const collapseBtn=el("button",{className:"ghost",textContent: data.collapsed[f.id] ? "▸" : "▾"});
    collapseBtn.onclick=(e)=>{ data.collapsed[f.id]=!data.collapsed[f.id]; c.classList.toggle("collapsed", !!data.collapsed[f.id]); save(); };
    const delBtn=el("button",{className:"danger",textContent:"Удалить"});
    delBtn.onclick=()=>{ if(confirm("Удалить категорию и её потомков?")) { pushHistory(snapshot()); removeCategory(f.id);} };
    const rightWrap=el("span",{className:"title-actions"});
    rightWrap.append(collapseBtn, delBtn);
    h.append(leftWrap, rightWrap);
    c.appendChild(h);
    if(data.collapsed[f.id]) c.classList.add("collapsed");

    const r1=el("div",{className:"row"});
    r1.append(wrap("Заголовок", el("input",{value:f.title||"", onfocus:()=>pending=snapshot(), oninput:e=>{f.title=e.target.value; dirty();}})),
               wrap("Имя (ключ)", el("input",{value:f.name||"", onfocus:()=>pending=snapshot(), oninput:e=>{f.name=e.target.value; dirty();}})));
    c.appendChild(r1);

    const r2=el("div",{className:"row"});
    const typeSel=el("select",{onfocus:()=>pending=snapshot(), onchange:e=>{f.type=e.target.value; dirty(); renderEditor();}});
    ["group","text","number","select","radio","checkbox","date","range","multicheck"].forEach(t=> typeSel.append(el("option",{value:t,textContent:t,selected:f.type===t})));
    r2.append(
      wrap("Тип",typeSel),
      wrap("Описание",el("input",{value:f.hint||"", onfocus:()=>pending=snapshot(), oninput:e=>{f.hint=e.target.value; dirty();}}))
    );
    c.appendChild(r2);

    const r3=el("div",{className:"row"});
    const pSel=el("select",{onfocus:()=>pending=snapshot(), onchange:e=>{f.parentId=e.target.value||null; dirty(); renderEditor();}});
    const parentOptions=(currentId)=>{
      const invalid=new Set([currentId]);
      (function mark(id){ data.categories.filter(x=>x.parentId===id).forEach(ch=>{ invalid.add(ch.id); mark(ch.id); }); })(currentId);
      return [{id:"", name:"(нет)"}].concat(
        data.categories.filter(x=>!invalid.has(x.id)).map(x=>({id:x.id,name:`${x.title||x.name||x.id}`}))
      );
    };
    parentOptions(f.id).forEach(o=> pSel.append(el("option",{value:o.id,textContent:o.name,selected:(f.parentId||"")===(o.id||"")})));
    const folderSel=el("select",{onfocus:()=>pending=snapshot(), onchange:e=>{f.folderId=e.target.value; dirty(); renderEditor();}});
    (function(){
      const arr=(data.folders||[]).slice().sort((a,b)=>String(a.title||"").localeCompare(String(b.title||"")));
      arr.forEach(F=>{
        const parts=String(F.title||"").split("/").filter(Boolean);
        const label=(parts.length>1? "  ".repeat(parts.length-1):"") + (parts[parts.length-1]||String(F.title||""));
        folderSel.append(new Option(label, F.id, false, F.id===(f.folderId||"")));
      });
    })();
    r3.append(wrap("Родитель",pSel), wrap("Папка", folderSel));
    c.appendChild(r3);

    const r4=el("div",{className:"row"});
    r4.append(
      wrap("Опции (для select/multicheck/radio)",el("textarea",{value:(f.options||[]).join(', '), onfocus:()=>pending=snapshot(), oninput:e=>{f.options=e.target.value.split(',').map(x=>x.trim()).filter(Boolean); dirty();}})),
      wrap("Карта опций",el("textarea",{value:mapToText(f.map||{}), onfocus:()=>pending=snapshot(), oninput:e=>{f.map=textToMap(e.target.value); dirty();}}))
    );
    c.appendChild(r4);

    const r5 = el("div",{className:"row"});
    const layoutSel = el("select",{onfocus:()=>pending=snapshot(), onchange:e=>{f.layout=e.target.value; dirty(); renderPreview();}});
    ["full","half","third","quarter","sixth","col-1","col-2","col-3","col-4","col-5","col-6"].forEach(t=> layoutSel.append(el("option",{value:t,textContent:t,selected:(f.layout||"half")===t})));
    r5.append(
      wrap("Layout", layoutSel),
      wrap("ID", el("input",{value:f.id||"", onfocus:()=>pending=snapshot(), oninput:e=>{f.id=e.target.value; dirty();}}))
    );
    c.appendChild(r5);

    listEl.appendChild(c);
  });

  const addBtn=el("button",{textContent:"+ Категория"});
  addBtn.onclick=()=>{ pushHistory(snapshot()); addCategory(); };
  listEl.appendChild(addBtn);
}

function dirty(){ pushHistory(pending); pending=null; $("#statusBadge").textContent="Есть несохранённые изменения"; save(); }

function wrap(label,control){const w=el("div");w.append(el("label",{textContent:label}),control);return w;}
function mapToText(mapObj){
  return Object.entries(mapObj||{})
    .map(([k,arr])=>`${k}=${(arr||[]).join(',')}`)
    .join('\n');
}
function textToMap(txt){
  const out = {};
  if(!txt) return out;
  // accept literal "\n" sequences, real newlines and semicolons between sections
  const norm = String(txt).replace(/\\n/g, '\n');
  norm.split(/\r?\n|;/).forEach(line=>{
    const s = String(line).trim();
    if(!s) return;
    const i = s.indexOf('=');
    if(i < 0) return;
    const key = s.slice(0, i).trim();
    const vals = s.slice(i+1).split(',').map(x=>x.trim()).filter(Boolean);
    if(key) out[key] = vals;
  });
  return out;
}

function addCategory(){const fid=(currentFolder&&currentFolder!=="__ALL__")?currentFolder:data.folders[0]?.id; data.categories.push({id:uid(),folderId:fid,title:"Новая категория",name:"",type:"text",hint:"",parentId:null,options:[],map:{},showIf:"",layout:"half"}); save(); renderEditor();}
function removeCategory(id){function rm(fid){data.categories.filter(f=>f.parentId===fid).forEach(ch=>rm(ch.id));data.categories=data.categories.filter(f=>f.id!==fid); delete data.collapsed[fid];}rm(id);save();renderEditor();renderPreview();}

// ===== preview =====
let previewValues=loadPreviewValues();
const DEFAULT_LABEL = "Все объявления";
const previewState = JSON.parse(sessionStorage.getItem('previewState')||'{}');

function parseShowIf(str){
  if(!str) return ()=>true;
  const parts = str.split("&").map(s=>s.trim()).filter(Boolean);
  const tests = parts.map(p=>{
    const [k,v]=p.split("="); if(!k||v===undefined) return ()=>true;
    const allowed = v.split("|").map(s=>s.trim());
    return (vals)=> allowed.includes(String(vals[k] ?? ""));
  });
  return (vals)=> tests.every(t=>t(vals));
}
function visibleByCondition(f){
  const test=parseShowIf(f.showIf||"");
  return test(previewValues);
}
function optionsFor(f){
  let opts = Array.isArray(f.options)?f.options.slice():[];
  if(f.parentId){
    const p = data.categories.find(x=>x.id===f.parentId);
    const pKey = p?.name || p?.id;
    const pVal = previewValues[pKey] ?? previewValues[p?.id] ?? "";
    if(f.map && pVal && f.map[pVal]) opts = f.map[pVal].slice();
  }
  return opts;
}
function ensurePlaceholder(sel){
  if(!sel.options.length || sel.options[0].value!==""){
    sel.insertBefore(new Option(DEFAULT_LABEL,""), sel.firstChild);
  }
}
function assignSelectValue(sel, key){
  const val = previewValues[key] ?? "";
  const exists = Array.from(sel.options).some(o=>o.value===val);
  sel.value = exists ? val : "";
  previewValues[key] = sel.value;
}

function ruPlural(n, forms){
  const n10 = n % 10, n100 = n % 100;
  if(n10===1 && n100!==11) return forms[0];
  if(n10>=2 && n10<=4 && (n100<10 || n100>=20)) return forms[1];
  return forms[2];
}

function makeDropdownMulticheck(fieldDef){
  const key = fieldDef.name || fieldDef.id;
  const baseOpts = optionsFor(fieldDef);
  const items = baseOpts.slice();
  const container = el("div",{className:"dropdown"});
  container.dataset.key = key;
  const toggle = el("button",{type:"button",className:"filter-select"});
  const arrow = el("span",{className:"arrow",textContent:"▾"});
  const valueSpan = el("span",{textContent: DEFAULT_LABEL, className:"value muted"});
  toggle.append(valueSpan,arrow);
  const menu = el("div",{className:"dropdown-menu"});
  const current = new Set((previewValues[key]||[]).filter(Boolean));
  function updateLabel(){
    const chosen = Array.from(current);
    if(chosen.length===0){ valueSpan.textContent = DEFAULT_LABEL; valueSpan.classList.add("muted"); return; }
    valueSpan.classList.remove("muted");
    if(chosen.length<=2){ valueSpan.textContent = chosen.join(", "); }
    else{ valueSpan.textContent = `${chosen.length} ${ruPlural(chosen.length, ['вариант','варианта','вариантов'])}`; }
  }
  items.forEach((opt)=>{
    const row = el("label",{className:"item"});
    const cb = el("input",{type:"checkbox"});
    cb.checked = current.has(opt);
    cb.onchange = (e)=>{
      e.stopPropagation();
      if(cb.checked) current.add(opt); else current.delete(opt);
      previewValues[key] = Array.from(current); savePreviewValues();
      updateLabel();
    };
    row.append(cb, document.createTextNode(opt));
    menu.append(row);
  });
  previewValues[key] = Array.from(current); savePreviewValues();
  updateLabel();
  toggle.onclick = (e)=>{
    e.stopPropagation();
    document.querySelectorAll('.dropdown.open').forEach(dd=>{ if(dd!==container) dd.classList.remove('open'); });
    container.classList.toggle("open");
  };
  document.addEventListener("click", (e)=>{ if(!container.contains(e.target)){ container.classList.remove("open"); } });
  container.append(toggle,menu);
  return container;
}

function layoutToClass(v){
  switch(v){
    case "full": return "col-6";
    case "half": return "col-3";
    case "third": return "col-2";
    case "quarter": return "col-2";      // 2/6
    case "sixth": return "col-1";        // 1/6
    case "col-1":
    case "col-2":
    case "col-3":
    case "col-4":
    case "col-5":
    case "col-6": return v;
    default: return "col-3";
  }
}

function renderPreview(){
  const form=$("#previewForm");
  const sc = form.parentElement.scrollTop;
  form.innerHTML="";
  data.categories.forEach(f=>{
    if(f.type==="group"){
      const sel=el("select");
      ensurePlaceholder(sel);
      (f.options||[]).forEach(o=>sel.append(new Option(o,o)));
      const key=f.name||f.id;
      assignSelectValue(sel, key);
      sel.onchange=()=>{previewValues[key]=sel.value; savePreviewValues(); renderPreview();};
      const w=wrap(f.title||f.name||f.id, sel);
      if(f.hint) w.append(el("div",{className:"hint",textContent:f.hint}));
      w.classList.add(layoutToClass(f.layout||"col-3"));
      form.append(w);
      return;
    }

    if(!visibleByCondition(f)) return;

    let ctrl, w;
    const key=f.name||f.id;

    if(f.type==="select"){
      ctrl=el("select");
      ensurePlaceholder(ctrl);
      optionsFor(f).forEach(o=>{ if(o!==DEFAULT_LABEL) ctrl.append(new Option(o,o)); });
      assignSelectValue(ctrl, key);
      ctrl.onchange=()=>{previewValues[key]=ctrl.value; savePreviewValues(); savePreviewValues();renderPreview();};
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else if(f.type==="radio"){
      const opts=optionsFor(f);
      ctrl=el("select");
      opts.forEach(o=>ctrl.append(new Option(o,o)));
      if(previewValues[key] && opts.includes(previewValues[key])) ctrl.value=previewValues[key];
      else if(opts.length){ ctrl.value=opts[0]; previewValues[key]=opts[0]; }
      ctrl.onchange=()=>{previewValues[key]=ctrl.value; savePreviewValues(); savePreviewValues();};
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else if(f.type==="checkbox"){
      ctrl=el("input",{type:"checkbox"});
      ctrl.checked=!!previewValues[key];
      ctrl.onchange=()=>{previewValues[key]=ctrl.checked; savePreviewValues();};
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else if(f.type==="text"||f.type==="number"||f.type==="date"){
      ctrl=el("input",{type:f.type});
      if(previewValues[key]) ctrl.value=previewValues[key];
      ctrl.oninput=()=>{previewValues[key]=ctrl.value; savePreviewValues(); savePreviewValues();};
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else if(f.type==="range"){
      const box=el("div",{className:"inline"});
      const min=el("input",{type:"number",placeholder:"От"});
      const max=el("input",{type:"number",placeholder:"До"});
      if(previewValues[key]){ min.value=previewValues[key].min||""; max.value=previewValues[key].max||""; }
      min.oninput=()=>{previewValues[key]={...(previewValues[key]||{}),min:min.value}; savePreviewValues();};
      max.oninput=()=>{previewValues[key]={...(previewValues[key]||{}),max:max.value}; savePreviewValues();};
      box.append(min,max);
      w=wrap(f.title||f.name||f.id, box);
    }
    else if(f.type==="multicheck"){
      ctrl = makeDropdownMulticheck(f);
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else{
      return;
    }

    if(f.hint) w.append(el("div",{className:"hint",textContent:f.hint}));
    w.classList.add(layoutToClass(f.layout||"col-3"));
    form.append(w);
  });
  // restore preview scroll
  setTimeout(()=>{ form.parentElement.scrollTop = previewState.scrollTop||sc; },0);
}

// import/export и табы
$("#importBtn").onclick=()=>$("#fileInput").click();
$("#fileInput").onchange=async (e)=>{
  const f=e.target.files && e.target.files[0];
  if(!f) return;
  try{
    const txt=await f.text();
    const json=JSON.parse(txt);
    if(Array.isArray(json.categories) && !json.folders){
      data = {folders:[{id:"root",title:"(Все)",open:true}], categories: json.categories.map(c=>({...c, folderId:"root"})), collapsed:{}};
    }else{ data=json; }
    migrateIfNeeded();
    save(); updateFolderFilter(); renderEditor(); previewValues={}; renderPreview(); alert("Импортировано");
  }catch(err){alert("Ошибка: "+err.message);}
};
$("#exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=el("a",{href:URL.createObjectURL(blob),download:"categories_editor_v22D.json"});
  document.body.appendChild(a);a.click();a.remove();
};
$("#addBtn").onclick=()=>{ pushHistory(snapshot()); addCategory(); };
$("#clearBtn").onclick=()=>{if(confirm("Очистить все?")){ pushHistory(snapshot()); data={folders:[],categories:[],collapsed:{}};migrateIfNeeded();save();renderEditor();previewValues={};renderPreview();}};
$("#tab-editor").onclick=()=>{activate("editor");};
$("#tab-preview").onclick=()=>{activate("preview");};
$("#tab-help").onclick=()=>{activate("help");};

function activate(tab){
  $("#tab-editor").classList.remove("active");
  $("#tab-preview").classList.remove("active");
  $("#tab-help").classList.remove("active");
  $("#editorSection").classList.add("hidden");
  $("#previewSection").classList.add("hidden");
  $("#helpSection").classList.add("hidden");
  if(tab==="editor"){ $("#tab-editor").classList.add("active"); $("#editorSection").classList.remove("hidden"); }
  else if(tab==="preview"){ $("#tab-preview").classList.add("active"); $("#previewSection").classList.remove("hidden"); renderPreview(); }
  else { $("#tab-help").classList.add("active"); $("#helpSection").classList.remove("hidden"); }
}

function updateSize(){
  try{
    const bytes=new Blob([document.documentElement.outerHTML]).size;
    $("#sizeBadge").textContent=`Размер: ${(bytes/1024).toFixed(1)} КБ`;
  }catch{
    $("#sizeBadge").textContent="Размер: ?";
  }
}

// folder ops
$("#addFolder").onclick=()=>{
  const base = (currentFolder && currentFolder!=="__ALL__" ? (getFolderById(currentFolder)?.title||"") : "");
  const suggested = base ? (base + "/Новая папка") : "Новая папка";
  const input = prompt("Название папки:", suggested);
  if(!input) return;
  let title = String(input).trim();
  if(base && !title.startsWith(base + "/")) title = base.replace(/\/+$/,"") + "/" + title.replace(/^\/+/,"");
  title = title.replace(/\s*\/\s*/g,"/").replace(/\/{2,}/g,"/").replace(/^\/|\/$/g,"");
  data.folders.push({id:uid(), title, open:true});
  save(); updateFolderFilter(); setCurrentFolder(currentFolder);
};
$("#renameFolder").onclick=()=>{
  const cur = $("#folderFilter").value;
  if(cur==="__ALL__") return alert("Выберите конкретную папку");
  const f = data.folders.find(x=>x.id===cur); if(!f) return;
  const name=prompt("Новое имя папки",f.title); if(!name) return;
  f.title=name; save(); updateFolderFilter(); renderEditor();
};
$("#deleteFolder").onclick=()=>{
  const cur = $("#folderFilter").value;
  if(cur==="__ALL__") return alert("Выберите конкретную папку");
  const used = data.categories.some(c=>c.folderId===cur);
  if(used) return alert("Папка не пуста. Переместите категории.");
  data.folders = data.folders.filter(f=>f.id!==cur);
  currentFolder="__ALL__"; save(); updateFolderFilter(); renderEditor();
};

// collapse / expand all
$("#collapseAll").onclick=()=>{
  data.categories.forEach(c=>data.collapsed[c.id]=true);
  save(); renderEditor();
};
$("#expandAll").onclick=()=>{
  data.collapsed={};
  save(); renderEditor();
};

// remember preview scroll
window.addEventListener('beforeunload', ()=>{
  previewState.scrollTop = $("#previewForm").parentElement.scrollTop;
  sessionStorage.setItem('previewState', JSON.stringify(previewState));
});

(function init(){
  load();
  migrateIfNeeded();
  if(!data.categories.length){
    data.categories=[
      {id:"sec",name:"Chapter",title:"Раздел",type:"group",options:["Недвижимость","Транспорт","Здоровье"],hint:"Выберите верхний раздел",layout:"third",folderId:data.folders[0].id},
      {id:"cat",name:"category",title:"Категория",type:"select",parentId:"sec",showIf:"Chapter=Недвижимость|Транспорт",map:{
        "Недвижимость":["Квартира","Дома","Коммерция","Земля","Посуточная аренда"],
        "Транспорт":["Легковые автомобили","Грузовые автомобили"]
      },options:[],layout:"third",folderId:data.folders[0].id},
      {id:"sub",name:"Subcategory",title:"Подкатегория",type:"select",parentId:"cat",showIf:"Chapter=Недвижимость & category=Квартира|Дома|Коммерция|Земля|Посуточная аренда",map:{
        "Квартира":["Аренда","Продажа"],
        "Дома":["Аренда","Продажа"],
        "Коммерция":["Аренда","Продажа"],
        "Земля":["Продажа"],
        "Посуточная аренда":["Квартиры","Дома","Хостелы","Гостиницы","Санатории/Дома отдыха"]
      },options:[],layout:"third",folderId:data.folders[0].id},

      {id:"price",name:"Price",title:"Цена (за сутки)",type:"range",parentId:"cat",showIf:"Chapter=Недвижимость & category=Посуточная аренда",layout:"third",folderId:data.folders[0].id},
      {id:"currency",name:"Currency",title:"Валюта",type:"radio",parentId:"cat",showIf:"Chapter=Недвижимость & category=Посуточная аренда",options:["UZS","USD"],layout:"third",folderId:data.folders[0].id},
      {id:"beds",name:"Beds",title:"Количество спальных мест",type:"select",parentId:"cat",showIf:"Chapter=Недвижимость & category=Посуточная аренда",options:["1","2","3","4","5+"],layout:"third",folderId:data.folders[0].id},
      {id:"rules",name:"Rules",title:"Правила",type:"select",parentId:"cat",showIf:"Chapter=Недвижимость & category=Посуточная аренда",options:["Без животных","Без вечеринок","Только некурящие"],layout:"third",folderId:data.folders[0].id},

      {id:"comfort",name:"Comfort",title:"Удобства",type:"multicheck",parentId:"cat",showIf:"Chapter=Недвижимость & category=Посуточная аренда",options:["Микроволновая печь","Утюг","Фен","Холодильник","Wi‑Fi","Телевизор","Кондиционер","Парковка"],layout:"col-6",folderId:data.folders[0].id},
      {id:"infra",name:"Infrastructure",title:"Инфраструктура",type:"select",parentId:"cat",showIf:"Chapter=Недвижимость & category=Посуточная аренда",options:["Метро рядом","Центр города","Магазины поблизости"],layout:"col-3",folderId:data.folders[0].id},
      {id:"food",name:"Food",title:"Питание",type:"select",parentId:"cat",showIf:"Chapter=Недвижимость & category=Посуточная аренда",options:["Без питания","Завтрак включен","Полный пансион"],layout:"col-3",folderId:data.folders[0].id},

      {id:"hotelName",name:"HotelName",title:"Название отеля",type:"text",parentId:"cat",showIf:"Chapter=Недвижимость & category=Посуточная аренда & Subcategory=Гостиницы|Санатории/Дома отдыха",layout:"col-3",folderId:data.folders[0].id},
      {id:"roomCat",name:"RoomCategory",title:"Категория номера",type:"multicheck",parentId:"sub",showIf:"Chapter=Недвижимость & category=Посуточная аренда & Subcategory=Санатории/Дома отдыха|Гостиницы",options:["Эконом","Стандарт","Полулюкс","Люкс","Коттедж"],layout:"col-3",folderId:data.folders[0].id},

      {id:"brand",name:"Brand",title:"Марка авто",type:"select",parentId:"cat",showIf:"Chapter=Транспорт",options:["Chevrolet","Hyundai"],layout:"third",folderId:data.folders[0].id},
      {id:"year",name:"Year",title:"Год выпуска",type:"number",parentId:"cat",showIf:"Chapter=Транспорт",layout:"third",folderId:data.folders[0].id}
    ];
  }
  updateFolderFilter();
  renderEditor();
  renderPreview();
  updateSize();
  hist.length=0; future.length=0;
})();
</script>
</body>
</html>
