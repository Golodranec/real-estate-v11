<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Categories Editor ‚Äî min22G</title>
<style>
:root{--bg:#0f1720;--panel:#111a27;--line:#223049;--text:#e8f1ff;--muted:#9fb2c8;--ok:#18c29c;--warn:#f5a524;--danger:#ef4e4e}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
/* header */
header{position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);background:#0c1522}
.badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
button{background:#0f1b2d;border:1px solid var(--line);color:var(--text);border-radius:8px;padding:6px 10px;cursor:pointer}
button.small{padding:4px 8px;font-size:12px}
button.ok{background:#0f2a22;border-color:#184a3d;color:#98f5d3}
button.danger{background:#2b1416;border-color:#4a2326;color:#ffb3b3}
.wrap{display:grid;grid-template-columns:300px 1fr;gap:0}
aside{border-right:1px solid var(--line);background:#0b1422;min-height:calc(100vh - 50px)}
main{min-height:calc(100vh - 50px)}
/* tree */
.tree{padding:10px}
.node{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:6px;cursor:pointer}
.node.active{background:#14253b}
.node .name{flex:1}
.node .actions{display:none;gap:4px}
.node:hover .actions{display:flex}
.children{margin-left:14px;border-left:1px dashed var(--line);padding-left:8px}
/* list */
.section{padding:12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
.card{background:#0f1d32;border:1px solid var(--line);border-radius:10px;margin:10px 0;overflow:hidden}
.card .head{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--line);background:#0f1b2c}
.card .head .sp{flex:1}
.card .body{padding:10px;display:none}
.card.open .body{display:block}
label{display:block;font-size:12px;color:#9fb2c8;margin-bottom:4px}
input,select,textarea{width:100%;background:#0b1626;border:1px solid var(--line);color:var(--text);border-radius:8px;padding:8px}
textarea{min-height:64px;resize:vertical}
/* preview */
.preview{padding:12px}
.preview .form{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
.preview .cell{grid-column:span 3}
.preview .cell.third{grid-column:span 2}
.preview .cell.full{grid-column:span 6}
.hint{font-size:12px;color:#9bb1cb}
</style>
</head>
<body>
<header>
  <strong>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π</strong>
  <span class="badge" id="ver">min22G</span>
  <span class="badge" id="status">‚Äî</span>
  <div style="margin-left:auto"></div>
  <button id="undo" class="small">‚Ü∂ Undo</button>
  <button id="redo" class="small">‚Ü∑ Redo</button>
  <button id="import" class="small">–ò–º–ø–æ—Ä—Ç</button>
  <button id="export" class="small ok">–≠–∫—Å–ø–æ—Ä—Ç</button>
</header>

<div class="wrap">
  <aside>
    <div class="section">
      <div class="grid">
        <div class="col-12">
          <label>–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∞–ø–∫—É –≤ —Ç–µ–∫—É—â–µ–π</label>
          <div class="grid">
            <div class="col-8"><input id="newFolderName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏"/></div>
            <div class="col-4"><button id="addFolder" class="small">+ –ü–∞–ø–∫–∞</button></div>
          </div>
        </div>
      </div>
    </div>
    <div class="tree" id="tree"></div>
  </aside>

  <main>
    <div class="section">
      <div class="grid">
        <div class="col-8"><button id="addCat" class="small">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button></div>
        <div class="col-4" style="text-align:right">
          <button id="collapseAll" class="small">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
          <button id="expandAll" class="small">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        </div>
      </div>
      <div id="list"></div>
    </div>

    <div class="section">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
      <div class="preview">
        <div class="form" id="preview"></div>
        <div class="hint">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (localStorage).</div>
      </div>
    </div>
  </main>
</div>

<input id="file" type="file" hidden accept=".json,.txt"/>

<script>
// ====== Data model (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ-–∏–Ω–≤–∞–∑–∏–≤–Ω–æ) ======
// Flat categories + "folderPath" ('–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å/–ö–≤–∞—Ä—Ç–∏—Ä–∞').
// –ù–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞–µ–º. –°—Ç–∞—Ä—ã–µ –ø–æ–ª—è –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å.
const KEY_DATA='cats_min22G';
const KEY_PREVIEW='cats_min22G_preview';
const KEY_SCROLL='cats_min22G_scroll';

let data = load() || seed();
let cwd = ""; // —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å –ø–∞–ø–∫–∏, "" = –∫–æ—Ä–µ–Ω—å
let history = []; let hIndex=-1;

const $=s=>document.querySelector(s);
const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2,9);
function clone(x){return JSON.parse(JSON.stringify(x));}

function seed(){
  return {
    version:'min22G',
    categories:[
      {id:uid(), folderPath:"–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å", title:"–†–∞–∑–¥–µ–ª", key:"Chapter", type:"select", options:["–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å","–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç"], layout:"half"},
      {id:uid(), folderPath:"–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å", title:"–ö–∞—Ç–µ–≥–æ—Ä–∏—è", key:"category", type:"select", options:["–ö–≤–∞—Ä—Ç–∏—Ä—ã","–î–æ–º–∞","–ü–æ—Å—É—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞"], layout:"half"},
      {id:uid(), folderPath:"–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å/–ü–æ—Å—É—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞", title:"–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è", key:"Subcategory", type:"select", options:["–ö–≤–∞—Ä—Ç–∏—Ä—ã","–î–æ–º–∞","–•–æ—Å—Ç–µ–ª—ã","–ì–æ—Å—Ç–∏–Ω–∏—Ü—ã","–°–∞–Ω–∞—Ç–æ—Ä–∏–∏/–î–æ–º–∞ –æ—Ç–¥—ã—Ö–∞"], layout:"third"},
      {id:uid(), folderPath:"–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å/–ü–æ—Å—É—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞", title:"–¶–µ–Ω–∞ (–∑–∞ —Å—É—Ç–∫–∏)", key:"Price", type:"range", layout:"third"},
      {id:uid(), folderPath:"–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å/–ü–æ—Å—É—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞", title:"–í–∞–ª—é—Ç–∞", key:"Currency", type:"radio", options:["UZS","USD"], layout:"third"},
      {id:uid(), folderPath:"–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å/–ü–æ—Å—É—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞", title:"–£–¥–æ–±—Å—Ç–≤–∞", key:"Comfort", type:"multicheck", options:["Wi‚ÄëFi","–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä","–¢–µ–ª–µ–≤–∏–∑–æ—Ä","–ü–∞—Ä–∫–æ–≤–∫–∞","–ö—É—Ö–Ω—è"], layout:"full"}
    ]
  };
}

function load(){ try{ return JSON.parse(localStorage.getItem(KEY_DATA)||""); }catch(e){ return null; } }
function save(push=true){
  localStorage.setItem(KEY_DATA, JSON.stringify(data));
  if(push){
    const snap=JSON.stringify(data);
    history = history.slice(0,hIndex+1);
    history.push(snap); if(history.length>50) history.shift();
    hIndex = history.length-1;
  }
  $('#status').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
}
function undo(){ if(hIndex>0){ hIndex--; data=JSON.parse(history[hIndex]); renderAll(); }}
function redo(){ if(hIndex<history.length-1){ hIndex++; data=JSON.parse(history[hIndex]); renderAll(); }}

function renderAll(){ renderTree(); renderList(); renderPreview(); }

/* ====== Tree ====== */
function buildTree(){
  const root={name:"", children:{}};
  data.categories.forEach(c=>{
    const parts=(c.folderPath||"").split('/').filter(Boolean);
    let node=root;
    parts.forEach(p=> node=node.children[p]||(node.children[p]={name:p,children:{}}) );
  });
  return root;
}
function renderTree(){
  const root=buildTree();
  const host=$("#tree"); host.innerHTML="";
  // –ö–æ—Ä–µ–Ω—å
  const rootRow=document.createElement('div'); rootRow.className='node'+(cwd===""?' active':'');
  rootRow.innerHTML=`<span>üìÅ</span><span class="name">(–ö–æ—Ä–µ–Ω—å)</span><span class="actions"><button class="small" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button></span>`;
  rootRow.querySelector('[data-act=open]').onclick=()=>{ cwd=""; renderAll(); };
  host.appendChild(rootRow);
  // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  function draw(node, path){
    Object.keys(node.children).sort().forEach(k=>{
      const p = path? path+"/"+k : k;
      const row=document.createElement('div');
      row.className='node'+(p===cwd?' active':'');
      row.innerHTML=`<span>üìÅ</span><span class="name">${k}</span><span class="actions">
        <button class="small" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button class="small" data-act="add">+ –í–Ω—É—Ç—Ä—å</button>
        <button class="small danger" data-act="del">–£–¥–∞–ª–∏—Ç—å</button>
      </span>`;
      row.querySelector('[data-act=open]').onclick=()=>{ cwd=p; renderAll(); };
      row.querySelector('[data-act=add]').onclick=()=>{
        const nm = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∞–ø–∫–∏'); if(!nm) return;
        data.categories.push({id:uid(), folderPath:(p? p+'/'+nm : nm), title:"", key:"", type:"text", options:[], layout:"third"});
        save(); renderAll();
      };
      row.querySelector('[data-act=del]').onclick=()=>{
        const used = data.categories.some(c=> (c.folderPath||"").startsWith(p));
        if(used && !confirm('–í –ø–∞–ø–∫–µ –µ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –£–¥–∞–ª–∏—Ç—å –≤—Å—ë?')) return;
        data.categories = data.categories.filter(c=> !(c.folderPath||"").startsWith(p));
        if(cwd.startsWith(p)) cwd=""; save(); renderAll();
      };
      host.appendChild(row);
      const ch=document.createElement('div'); ch.className='children'; host.appendChild(ch);
      draw(node.children[k], p);
    });
  }
  draw(root, "");
}

/* ====== List ====== */
function renderList(){
  const host=$("#list"); host.innerHTML="";
  const items = data.categories.filter(c=> (c.folderPath||"")===cwd);
  items.forEach(c=> host.appendChild(card(c)) );
}
function card(c){
  const el=document.createElement('div'); el.className='card open';
  el.innerHTML=`
    <div class="head">
      <strong>${c.title||'–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}</strong>
      <span class="badge">${c.key||'key'}</span>
      <span class="sp"></span>
      <button class="small" data-act="toggle">‚ñæ</button>
      <button class="small" data-act="dup">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="small danger" data-act="del">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
    <div class="body">
      <div class="grid">
        <div class="col-6"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input data-k="title" value="${esc(c.title)}"></div>
        <div class="col-6"><label>–ò–º—è (–∫–ª—é—á)</label><input data-k="key" value="${esc(c.key)}"></div>
        <div class="col-3"><label>–¢–∏–ø</label>
          <select data-k="type">
            ${['select','radio','multicheck','text','range','number','checkbox'].map(t=>`<option ${c.type===t?'selected':''}>${t}</option>`).join('')}
          </select>
        </div>
        <div class="col-3"><label>Layout</label>
          <select data-k="layout">
            ${['full','half','third'].map(t=>`<option ${((c.layout||'half')===t)?'selected':''}>${t}</option>`).join('')}
          </select>
        </div>
        <div class="col-6"><label>–ü–∞–ø–∫–∞</label>
          <input data-k="folderPath" value="${esc(c.folderPath||'')}" placeholder="–ü—Ä–∏–º–µ—Ä: –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å/–ü–æ—Å—É—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞">
        </div>
        <div class="col-12"><label>–û–ø—Ü–∏–∏ (–ø–æ —Å—Ç—Ä–æ–∫–µ, –ø–µ—Ä–≤–∞—è ‚Äî ¬´–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è¬ª)</label>
          <textarea data-k="options">${esc((c.options||[]).join('\n'))}</textarea>
        </div>
        <div class="col-12"><label>–£—Å–ª–æ–≤–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (showIf)</label>
          <input data-k="showIf" value="${esc(c.showIf||'')}">
        </div>
      </div>
    </div>`;
  el.querySelector('[data-act=toggle]').onclick=()=> el.classList.toggle('open');
  el.querySelector('[data-act=del]').onclick=()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?'))return; data.categories=data.categories.filter(x=>x.id!==c.id); save(); renderAll(); };
  el.querySelector('[data-act=dup]').onclick=()=>{ const cp=clone(c); cp.id=uid(); data.categories.push(cp); save(); renderAll(); };
  el.querySelectorAll('[data-k]').forEach(inp=>{
    inp.oninput=()=>{
      const k=inp.dataset.k;
      let v=inp.value;
      if(k==='options'){ v=inp.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); if(!v.length || v[0]!=='–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è') v=['–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', ...v]; }
      c[k]=v; save(); renderPreview();
      if(k==='title') el.querySelector('strong').textContent=c.title||'–ö–∞—Ç–µ–≥–æ—Ä–∏—è';
      if(k==='key') el.querySelector('.badge').textContent=c.key||'key';
      if(k==='folderPath'){ renderTree(); renderList(); }
    };
  });
  return el;
}
function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));}

/* ====== Preview ====== */
function renderPreview(){
  const host=$("#preview"); const scPane = host.parentElement.parentElement;
  const prevScroll = scPane.scrollTop;
  host.innerHTML="";
  const items = data.categories.filter(c=> (c.folderPath||"")===cwd);
  const bag = getPreviewBag();
  items.forEach(c=>{
    if(c.showIf && !checkShowIf(c.showIf, bag)) return;
    const cell=document.createElement('div');
    cell.className='cell '+(c.layout==='full'?'full':c.layout==='third'?'third':'');
    const lab=document.createElement('div'); lab.className='hint'; lab.textContent=c.title||c.key; cell.appendChild(lab);
    let ctl;
    const key=c.key||c.id;
    if(c.type==='text'){ ctl=document.createElement('input'); ctl.value=bag[key]??''; ctl.oninput=()=>{bag[key]=ctl.value; setPreviewBag(bag);} }
    else if(c.type==='range'){
      const box=document.createElement('div'); box.style.display='flex'; box.style.gap='8px';
      const a=document.createElement('input'); a.type='number'; a.placeholder='–û—Ç'; a.value=bag[key]?.min??'';
      const b=document.createElement('input'); b.type='number'; b.placeholder='–î–æ'; b.value=bag[key]?.max??'';
      [a,b].forEach(i=>i.oninput=()=>{bag[key]={min:a.value,max:b.value}; setPreviewBag(bag);});
      box.append(a,b); ctl=box;
    } else if(c.type==='multicheck'){
      ctl=document.createElement('select'); ctl.multiple=true; ctl.size=Math.min(7,(c.options||[]).length);
      (c.options||['–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è']).forEach(o=>ctl.append(new Option(o,o)));
      (Array.isArray(bag[key])?bag[key]:[]).forEach(v=>{ const opt=[...ctl.options].find(x=>x.value===v); if(opt) opt.selected=true; });
      ctl.onchange=()=>{bag[key]=Array.from(ctl.selectedOptions).map(o=>o.value).filter(v=>v!=='–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è'); setPreviewBag(bag);};
    } else if(c.type==='radio'){
      ctl=document.createElement('select');
      (c.options?.length?c.options:['UZS','USD']).forEach(o=>ctl.append(new Option(o,o)));
      ctl.value=bag[key] ?? ctl.options[0].value;
      ctl.onchange=()=>{bag[key]=ctl.value; setPreviewBag(bag);};
    } else { // select / number / checkbox => select-–ø–æ–¥–æ–±–Ω—ã–π
      ctl=document.createElement('select'); const opts=(c.options?.length?c.options:['–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è']);
      opts.forEach(o=>ctl.append(new Option(o,o))); ctl.value = (bag[key] && opts.includes(bag[key]))?bag[key]:'–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è';
      ctl.onchange=()=>{bag[key]=ctl.value; setPreviewBag(bag);};
    }
    cell.appendChild(ctl); host.appendChild(cell);
  });
  // restore scroll
  setTimeout(()=>{ scPane.scrollTop = +localStorage.getItem(KEY_SCROLL)||prevScroll; },0);
}
function checkShowIf(expr, bag){
  try{
    return expr.split("&").map(s=>s.trim()).filter(Boolean).every(tok=>{
      const [k,v]=tok.split("=").map(x=>x?.trim()); if(!k||v==null) return true;
      const cur = bag[k]; if(cur==null) return false;
      if(Array.isArray(cur)) return cur.includes(v);
      return String(cur)===v;
    });
  }catch(e){ return true; }
}
function getPreviewBag(){ try{ return JSON.parse(localStorage.getItem(KEY_PREVIEW)||"{}"); }catch(e){ return {}; } }
function setPreviewBag(b){ localStorage.setItem(KEY_PREVIEW, JSON.stringify(b)); }

/* ====== toolbar ====== */
$('#collapseAll').onclick=()=>$$('#list .card').forEach(c=>c.classList.remove('open'));
$('#expandAll').onclick=()=>$$('#list .card').forEach(c=>c.classList.add('open'));
$('#addFolder').onclick=()=>{
  const nm=$('#newFolderName').value.trim(); if(!nm) return;
  const p = cwd ? (cwd+'/'+nm) : nm;
  data.categories.push({id:uid(), folderPath:p, title:"", key:"", type:"text", options:[], layout:"third"});
  save(); $('#newFolderName').value=""; renderAll();
};
$('#addCat').onclick=()=>{
  const item={id:uid(), folderPath:cwd, title:'–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è', key:'field_'+uid(), type:'select', options:['–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è'], layout:'third'};
  data.categories.push(item); save(); renderAll();
};
$('#undo').onclick=undo; $('#redo').onclick=redo;
$('#export').onclick=()=>{
  const a=document.createElement('a'); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  a.href=URL.createObjectURL(blob); a.download='categories_min22G.json'; a.click();
};
$('#import').onclick=()=>$('#file').click();
$('#file').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt=await f.text(); const json=JSON.parse(txt);
    if(Array.isArray(json.categories)){ data=json; save(false); renderAll(); }
    else alert('–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω —Ñ–æ—Ä–º–∞—Ç');
  }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); }
  e.target.value='';
};

/* ====== preview scroll persist ====== */
const prevPane = document.querySelector('#preview').parentElement.parentElement;
prevPane.addEventListener('scroll',()=> localStorage.setItem(KEY_SCROLL, prevPane.scrollTop||0) );

/* ====== init ====== */
(function(){
  save(false); // seed history without pushing twice
  renderAll();
  // restore preview scroll
  const sc = +localStorage.getItem(KEY_SCROLL)||0; prevPane.scrollTop = sc;
})();
</script>
</body>
</html>
