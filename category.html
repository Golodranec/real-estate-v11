<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Categories Editor ‚Äî v22E</title>
<style>
:root{
  --bg:#0f1621; --panel:#111c2a; --panel-2:#0d1723; --muted:#9fb3c8;
  --text:#e6eef7; --brand:#19d3da; --accent:#ffd166; --danger:#ef476f;
  --ok:#06d6a0; --line:#243447;
  --card:#132238; --hover:#1b2a41;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial
}
header{
  position:sticky;top:0;z-index:5;
  background:linear-gradient(180deg,var(--panel),var(--panel-2));
  border-bottom:1px solid var(--line);
  padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap
}
header .title{font-weight:700;margin-right:auto}
.btn{
  background:#16283c;border:1px solid #214; color:#d8e7ff; padding:8px 10px;
  border-radius:10px;cursor:pointer;user-select:none;transition:.15s;
}
.btn:hover{background:var(--hover)}
.btn.ghost{background:transparent;border-color:var(--line);color:var(--muted)}
.btn.ok{background:var(--ok);color:#001b1e;border-color:transparent}
.btn.danger{background:var(--danger);color:#fff;border-color:transparent}
.btn.small{padding:5px 8px;font-size:12px;border-radius:8px}
.badge{background:#112031;border:1px solid var(--line);padding:4px 6px;border-radius:8px;color:var(--muted)}

#wrap{height:calc(100% - 64px);display:grid;grid-template-columns: 1fr 1fr;gap:0;border-top:1px solid var(--line)}
.panel{height:100%;overflow:auto;background:var(--panel-2)}
.panel h3{margin:12px 12px 8px;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.02em}

.tools{display:flex;gap:6px;flex-wrap:wrap}

.box{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-6{grid-column: span 6}.col-4{grid-column:span 4}.col-2{grid-column:span 2}

.card{background:#0f1d32;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.card + .card{margin-top:10px}
.card__head{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line);background:#11213a}
.card__title{font-weight:600}
.card__hint{margin-left:6px;color:var(--muted);font-size:12px}
.card__actions{margin-left:auto;display:flex;gap:6px}
.card__body{padding:12px;display:none}
.card.open .card__body{display:block}
.card__grid{display:grid;gap:8px;grid-template-columns:160px 1fr}

input[type="text"],input[type="number"],select,textarea{
  width:100%;background:#0b1728;border:1px solid var(--line);color:var(--text);
  border-radius:10px;padding:8px 10px;outline:none
}
textarea{min-height:80px;resize:vertical}
label.small{font-size:12px;color:var(--muted)}

.folderbar{display:flex;gap:8px;align-items:center;margin:12px}
.folderbar .path{display:flex;gap:6px;flex-wrap:wrap}
.folderbar .crumb{background:#0e1a2a;border:1px solid var(--line);padding:6px 10px;border-radius:10px}
.folderbar .crumb.current{background:#13243b;color:#fff}

.folder{margin:12px}
.folder__header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.folder__title{font-weight:700}
.folder__list{display:flex;flex-direction:column;gap:8px}

.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}

.preview-grid{display:grid;grid-template-columns:repeat(6, 1fr);gap:12px}
.preview-grid .cell{grid-column: span 2}
.preview-grid .cell.cell-3{grid-column: span 3}
.preview-grid .cell.cell-6{grid-column: span 6}

select.inline{appearance:none;background:#0b1728 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="10"><path fill="%23a9c1d6" d="M1 2 L7 8 L13 2"/></svg>') no-repeat right 8px center;padding-right:28px}

.footer-note{color:#83a0b8;font-size:12px;text-align:center;margin:10px}
</style>
</head>
<body>
<header>
  <div class="title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä <span class="badge" id="ver">v22E</span></div>
  <div class="tools">
    <button class="btn small" id="collapseAll">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
    <button class="btn small" id="expandAll">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
    <span class="badge" id="status">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
    <button class="btn small" id="undoBtn">‚Ü∂ Undo</button>
    <button class="btn small" id="redoBtn">‚Ü∑ Redo</button>
    <button class="btn small" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
    <button class="btn small" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
  </div>
</header>

<div id="wrap">
  <aside class="panel" id="editor">
    <div class="folderbar">
      <span class="label small">–ü—É—Ç—å:</span>
      <div class="path" id="path"></div>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="btn small" id="addFolderBtn">+ –ü–∞–ø–∫–∞</button>
        <button class="btn small" id="addCategoryBtn">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
      </div>
    </div>
    <div class="box">
      <div class="folder__list" id="list"></div>
    </div>
  </aside>

  <main class="panel" id="previewPanel">
    <div class="box">
      <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
      <div class="preview-grid" id="preview"></div>
    </div>
    <div class="footer-note">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
  </main>
</div>

<input type="file" accept=".json,.txt" id="fileInput" hidden />

<script>
/* ======= persistence helpers ======= */
const LS_KEY = 'ce_v22E_data';
const LS_PREVIEW = 'ce_v22E_preview';
const LS_SCROLL = 'ce_v22E_scroll';
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const uid = ()=>'id'+Math.random().toString(36).slice(2,9);

/* ======= default dataset ======= */
const DEFAULT_DATA = {
  version:'v22E',
  root: {
    id: 'root',
    title: '(–í—Å–µ)',
    type: 'folder',
    children: [
      { id: uid(), type:'folder', title: '–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', children:[]},
      { id: uid(), type:'folder', title: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', children:[] }
    ]
  }
};

let data = load();
let cwd = data.root; // current folder pointer
const history = []; let hIndex = -1;

function pushHistory(){
  // limit history to 50
  history.splice(hIndex+1);
  history.push(JSON.stringify(data));
  if(history.length>50) history.shift();
  hIndex = history.length-1;
  setStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', true);
  save();
}
function undo(){ if(hIndex>0){ hIndex--; data = JSON.parse(history[hIndex]); navigate(pathIds()); render(); }}
function redo(){ if(hIndex < history.length-1){ hIndex++; data = JSON.parse(history[hIndex]); navigate(pathIds()); render(); }}

function setStatus(msg, ok){ const s=$('#status'); s.textContent=msg; s.style.color= ok?'#83ffa9':'#ffd1a4'; }

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
function load(){ try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):structuredClone(DEFAULT_DATA);}catch(e){return structuredClone(DEFAULT_DATA);} }

/* ======= path helpers ======= */
function pathArray(node=cwd){
  const arr=[]; let p=node;
  while(p){ arr.unshift(p); if(p===data.root) break; p=findParent(p.id); }
  return arr;
}
function pathIds(){ return pathArray().map(n=>n.id); }
function navigate(ids){
  let node=data.root;
  for(const id of ids.slice(1)){ node = (node.children||[]).find(x=>x.id===id) || node; }
  cwd=node;
}

/* ======= render ======= */
function render(){
  renderPath();
  renderFolder();
  renderPreview();
}
function renderPath(){
  const bar=$('#path'); bar.innerHTML='';
  const arr=pathArray();
  arr.forEach((n,i)=>{
    const b=document.createElement('button');
    b.className='btn small ghost crumb'+(i===arr.length-1?' current':'');
    b.textContent=n.title;
    b.onclick=()=>{ cwd=n; render(); };
    bar.appendChild(b);
  });
}
function renderFolder(){
  const list=$('#list'); list.innerHTML='';
  (cwd.children||[]).forEach(item=>{
    if(item.type==='folder'){ list.appendChild(folderRow(item)); }
    else list.appendChild(categoryCard(item));
  });
}

function folderRow(folder){
  const row=document.createElement('div');
  row.className='card';
  row.innerHTML=`
    <div class="card__head">
      <div class="card__title">üìÅ ${folder.title}</div>
      <div class="card__actions">
        <button class="btn small" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button class="btn small" data-act="rename">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
        <button class="btn small danger" data-act="del">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>`;
  row.querySelector('[data-act=open]').onclick=()=>{ cwd=folder; render(); };
  row.querySelector('[data-act=rename]').onclick=()=>{
    const t=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏', folder.title); if(!t) return;
    folder.title=t; pushHistory(); render(); };
  row.querySelector('[data-act=del]').onclick=()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É –∏ –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ?'))return;
    removeById(folder.id); pushHistory(); render();
  };
  return row;
}

function categoryCard(f){
  const card=document.createElement('div');
  card.className='card open';
  card.dataset.id=f.id;
  const layoutClass = layoutToCols(f.layout||'half');

  card.innerHTML=`
  <div class="card__head">
    <div class="card__title">${f.title||'–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}</div>
    <div class="card__hint">(${f.key||'key'})</div>
    <div class="card__actions">
      <button class="btn small" data-act="toggle">‚ØÜ</button>
      <button class="btn small" data-act="dup">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn small danger" data-act="del">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
  <div class="card__body">
    <div class="kv"><label class="small">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" value="${f.title||''}" data-field="title"></div>
    <div class="kv"><label class="small">–ò–º—è (–∫–ª—é—á)</label><input type="text" value="${f.key||''}" data-field="key"></div>
    <div class="kv"><label class="small">–¢–∏–ø</label>
      <select data-field="ctype" class="inline">
        <option value="select" ${f.ctype==='select'?'selected':''}>select</option>
        <option value="multicheck" ${f.ctype==='multicheck'?'selected':''}>multicheck</option>
        <option value="radio" ${f.ctype==='radio'?'selected':''}>radio (–∂—ë—Å—Ç–∫–∏–π)</option>
        <option value="text" ${f.ctype==='text'?'selected':''}>text</option>
        <option value="range" ${f.ctype==='range'?'selected':''}>range</option>
      </select>
    </div>
    <div class="kv"><label class="small">–†–æ–¥–∏—Ç–µ–ª—å</label>
      <select data-field="parent" class="inline"><option value="">(–Ω–µ—Ç)</option>${ optionsForSelect(allCategoryKeys(), f.parent) }</select>
    </div>
    <div class="kv"><label class="small">–£—Å–ª–æ–≤–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</label><input type="text" placeholder="–ø—Ä–∏–º–µ—Ä: Chapter=–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å & category=–ü–æ—Å—É—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞" data-field="showIf" value="${f.showIf||''}"></div>
    <div class="kv"><label class="small">–û–ø—Ü–∏–∏ (–ø–æ –æ–¥–Ω–æ–π –≤ —Å—Ç—Ä–æ–∫–µ)</label><textarea data-field="options">${(f.options||[]).join('\n')}</textarea></div>
    <div class="kv"><label class="small">Layout</label>
      <select data-field="layout" class="inline">
        <option value="full" ${f.layout==='full'?'selected':''}>full (1/1)</option>
        <option value="half" ${(!f.layout||f.layout==='half')?'selected':''}>half (1/2)</option>
        <option value="third" ${f.layout==='third'?'selected':''}>third (1/3)</option>
        <option value="sixth" ${f.layout==='sixth'?'selected':''}>sixth (1/6)</option>
      </select>
    </div>
  </div>`;

  card.querySelector('[data-act=toggle]').onclick=()=>card.classList.toggle('open');
  card.querySelector('[data-act=dup]').onclick=()=>{ const copy=structuredClone(f); copy.id=uid(); cwd.children.push(copy); pushHistory(); render(); };
  card.querySelector('[data-act=del]').onclick=()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?'))return; removeById(f.id); pushHistory(); render(); };

  // value change handlers
  $$('[data-field]', card).forEach(el=>{
    el.oninput = () => {
      const field = el.getAttribute('data-field');
      if(field==='options'){ f.options = el.value.split('\n').map(s=>s.trim()).filter(Boolean); }
      else f[field] = el.value;
      pushHistory(); renderPreview(); // re-render preview only
      // update title in header instantly
      if(field==='title') card.querySelector('.card__title').textContent = f.title || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';
      if(field==='key') card.querySelector('.card__hint').textContent = '('+(f.key||'key')+')';
    };
  });
  return card;
}

function layoutToCols(layout){
  switch(layout){
    case 'full': return 'col-12';
    case 'third': return 'col-4';
    case 'sixth': return 'col-2';
    default: return 'col-6';
  }
}

/* ======= preview ======= */
function renderPreview(){
  const grid = $('#preview'); grid.innerHTML='';

  // flatten categories of current folder only
  const cats = (cwd.children||[]).filter(x=>x.type==='category');

  cats.forEach(f=>{
    // condition check by simple contains of key=value from preview state
    if(f.showIf && !checkCondition(f.showIf)) return;

    const cell = document.createElement('div');
    cell.className = 'cell '+ (f.layout==='full'?'cell-6': (f.layout==='third'?'':'') ); // grid columns defined by CSS

    const label = document.createElement('label'); label.className='small'; label.textContent = f.title || f.key;
    cell.appendChild(label);

    let ctrl;
    const state = loadPreview();
    const key = f.key || f.id;

    if(f.ctype==='text'){
      ctrl = document.createElement('input'); ctrl.type='text'; ctrl.value = state[key] ?? '';
      ctrl.oninput=()=>{state[key]=ctrl.value; savePreview(state)};
    }else if(f.ctype==='range'){
      const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='8px';
      const a = document.createElement('input'); a.type='number'; a.placeholder='–û—Ç'; a.style.flex='1'; a.value = state[key]?.min ?? '';
      const b = document.createElement('input'); b.type='number'; b.placeholder='–î–æ'; b.style.flex='1'; b.value = state[key]?.max ?? '';
      [a,b].forEach(inp=>inp.oninput=()=>{state[key]={min:a.value,max:b.value}; savePreview(state)});
      wrap.append(a,b); ctrl=wrap;
    }else if(f.ctype==='multicheck'){
      const dd = makeDropdownMulti(f, state[key]); ctrl=dd.el; dd.onChange(v=>{state[key]=v; savePreview(state)});
    }else if(f.ctype==='radio'){
      const dd = makeDropdownSingle(f, state[key] ?? (f.options?.[0]??'')); ctrl=dd.el; dd.onChange(v=>{state[key]=v; savePreview(state)});
    }else{ // default select
      const dd = makeDropdownSingle(f, state[key] ?? '–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', ['–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è',...(f.options||[])]);
      ctrl=dd.el; dd.onChange(v=>{state[key]=v; savePreview(state)});
    }
    grid.appendChild(cell);
    cell.appendChild(ctrl);
  });
  // restore scroll
  const sc = +(localStorage.getItem(LS_SCROLL)||0); $('#previewPanel').scrollTop = sc;
}

/* dropdowns */
function makeDropdownSingle(f, value, opts){
  const options = opts || (['–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', ...(f.options||[])]);
  const sel = document.createElement('select'); sel.className='inline';
  options.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; sel.appendChild(op); });
  if(!options.includes(value)) value=options[0]; sel.value=value;
  sel.onchange=()=>dd._onChange(sel.value);
  const dd = { el: sel, onChange: fn=>dd._onChange=fn, _onChange:()=>{} };
  return dd;
}
function makeDropdownMulti(f, value){
  const opts = ['–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', ...(f.options||[])];
  const sel = document.createElement('select'); sel.className='inline'; sel.multiple=true; sel.size=Math.min(7,opts.length);
  opts.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; sel.appendChild(op); });
  (Array.isArray(value)?value:[]).forEach(v=>{ const op=[...sel.options].find(o=>o.value===v); if(op) op.selected=true; });
  sel.onchange=()=>{
    const vals=[...sel.selectedOptions].map(o=>o.value).filter(v=>v!=='–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è');
    dd._onChange(vals);
  };
  const dd = { el: sel, onChange: fn=>dd._onChange=fn, _onChange:()=>{} };
  return dd;
}

function checkCondition(expr){
  // very lightweight: split by &, expect "key=value" tokens; use preview state
  try{
    const st=loadPreview();
    return expr.split('&').map(s=>s.trim()).every(tok=>{
      const [k,v]=tok.split('=').map(x=>x?.trim());
      if(!k||v==null) return true;
      const cur = st[k];
      if(cur==null) return false;
      if(typeof cur==='object'){ return Object.values(cur).includes(v); }
      return String(cur)===v;
    });
  }catch(e){ return true; }
}

/* ======= add/remove helpers ======= */
function removeById(id, node=data.root){
  if(!node.children) return false;
  const i=node.children.findIndex(x=>x.id===id);
  if(i>-1){ node.children.splice(i,1); return true; }
  for(const ch of node.children){ if(removeById(id,ch)) return true; }
  return false;
}
function findParent(id, node=data.root, parent=null){
  if(node.id===id) return parent;
  for(const ch of node.children||[]){
    const r = findParent(id, ch, node);
    if(r) return r;
  }
  return null;
}
function findById(id, node=data.root){
  if(node.id===id) return node;
  for(const ch of node.children||[]){ const r=findById(id,ch); if(r) return r; }
  return null;
}
function allCategoryKeys(node=cwd, out=[]){
  for(const ch of node.children||[]){
    if(ch.type==='category') out.push(ch.key||ch.id);
  }
  return out;
}
function optionsForSelect(arr, sel){
  return arr.map(v=>`<option value="${escapeHtml(v)}" ${sel===v?'selected':''}>${escapeHtml(v)}</option>`).join('');
}
function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* ======= preview persistence ======= */
function loadPreview(){try{ return JSON.parse(localStorage.getItem(LS_PREVIEW)||'{}'); }catch(e){ return {}; }}
function savePreview(st){ localStorage.setItem(LS_PREVIEW, JSON.stringify(st)); }

/* ======= controls ======= */
$('#collapseAll').onclick=()=>{$$('#list .card').forEach(c=>c.classList.remove('open'));};
$('#expandAll').onclick=()=>{$$('#list .card').forEach(c=>c.classList.add('open'));};
$('#undoBtn').onclick=undo; $('#redoBtn').onclick=redo;

$('#addFolderBtn').onclick=()=>{
  const t=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏','–ù–æ–≤–∞—è –ø–∞–ø–∫–∞'); if(!t) return;
  cwd.children ||= []; cwd.children.push({id:uid(), type:'folder', title:t, children:[]}); pushHistory(); render();
};
$('#addCategoryBtn').onclick=()=>{
  const f={ id:uid(), type:'category', title:'–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è', key:'key_'+Math.random().toString(36).slice(2,6),
            ctype:'select', layout:'half', options:['–í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è'] };
  cwd.children ||= []; cwd.children.push(f); pushHistory(); render();
};

$('#exportBtn').onclick=()=>{
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='categories_editor_full_v22E.json'; a.click();
};
$('#importBtn').onclick=()=>$('#fileInput').click();
$('#fileInput').onchange=async e=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const txt=await file.text(); const obj=JSON.parse(txt);
    if(obj && obj.root){ data=obj; cwd=data.root; pushHistory(); render(); }
  }catch(err){ alert('–§–∞–π–ª –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω'); }
  e.target.value='';
};

/* ======= scroll save ======= */
$('#previewPanel').addEventListener('scroll',()=>{
  localStorage.setItem(LS_SCROLL, $('#previewPanel').scrollTop);
});

/* ======= boot ======= */
(function init(){
  // seed history
  pushHistory();
  render();
  // restore scroll
  const sc=+(localStorage.getItem(LS_SCROLL)||0); $('#previewPanel').scrollTop=sc;
})();
</script>
</body>
</html>
