<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Categories Editor — v22N2</title>
<style>
:root{
  --bg:#0f1624; --panel:#121a2b; --card:#0e1726; --line:#21314b;
  --text:#e6eefc; --muted:#9fb1c8; --accent:#39c5ff; --danger:#ff5a74; --ok:#35d487;
}
*{box-sizing:border-box}
html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
button,select,input,textarea{font:inherit;color:inherit}
.header{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:linear-gradient(0deg,rgba(15,22,36,.85),rgba(15,22,36,.95))}
.badge{border:1px solid var(--line);background:#0a1322;color:#b8c7df;border-radius:999px;padding:2px 8px;font-size:12px}
.btn{background:#0a1424;border:1px solid var(--line);color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:#2a3b5b}
.btn.ok{background:#0f2a1e;border-color:#244f3c}
.btn.danger{background:#2a0f14;border-color:#5a2630}
.container{max-width:1400px;margin:0 auto;padding:12px}
.grid{display:grid;grid-template-columns:380px 1fr;gap:14px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
.panel>h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);color:#b5c7df;font-size:15px}
.pad{padding:12px}
label{display:block;margin:6px 0 4px;color:#aac1db;font-size:12px}
input[type=text],input[type=number],input[type=date],select,textarea{
  width:100%;background:var(--card);border:1px solid var(--line);border-radius:10px;color:var(--text);padding:8px 10px
}
textarea{min-height:64px;resize:vertical}
.hr{height:1px;background:var(--line);margin:10px 0}
.item{border:1px solid var(--line);border-radius:12px;background:var(--card);margin:10px 0;overflow:hidden}
.item-h{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
.item-h .title{font-weight:600}
.item-b{display:none;padding:10px 12px}
.item.open .item-b{display:block}
.kv{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;padding:8px 0;border-top:1px dashed rgba(255,255,255,.06)}
.kv:first-child{border-top:none}
.small{font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.indent select option{white-space:pre}
.preview{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
.col-1{grid-column:span 1}.col-2{grid-column:span 2}.col-3{grid-column:span 3}
.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}
@media(max-width:1100px){.grid{grid-template-columns:1fr}.preview{grid-template-columns:repeat(3,1fr)}}
@media(max-width:640px){.preview{grid-template-columns:1fr} [class^=col-]{grid-column:1 / -1}}
.hint{color:#93a7c2;font-size:12px;margin-top:2px}
.dropdown{position:relative}
.dbtn{display:flex;justify-content:space-between;align-items:center;gap:8px;width:100%;padding:8px 10px;background:var(--card);border:1px solid var(--line);border-radius:10px;cursor:pointer}
.menu{position:absolute;top:calc(100% + 6px);left:0;min-width:100%;max-height:300px;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.35);display:none;z-index:50}
.dropdown.open .menu{display:block}
.menu .row{display:flex;gap:8px;align-items:center;padding:8px 10px;cursor:pointer}
.menu .row:hover{background:#0f1b2c}
</style>
</head>
<body>
<div class="header">
  <div class="flex">
    <strong>Категории — редактор</strong>
    <span class="badge">v22N2</span>
    <span id="sizeBadge" class="badge">…</span>
    <span id="statusBadge" class="badge">Сохранено</span>
  </div>
  <div class="flex">
    <button id="collapseAll" class="btn">Свернуть</button>
    <button id="expandAll" class="btn">Развернуть</button>
    <button id="undoBtn" class="btn">↶ Undo</button>
    <button id="redoBtn" class="btn">↷ Redo</button>
    <input id="fileInput" type="file" accept=".json,application/json" style="display:none">
    <button id="importBtn" class="btn">Импорт</button>
    <button id="exportBtn" class="btn ok">Экспорт</button>
    <button id="clearBtn" class="btn danger">Очистить</button>
  </div>
</div>

<div class="container">
  <div class="grid">
    <div class="panel">
      <h3>Папки</h3>
      <div class="pad">
        <label>Текущая папка</label>
        <select id="folderFilter" class="indent"></select>
        <div class="hr"></div>
        <label>Создать/переименовать</label>
        <div class="flex">
          <input id="folderInput" type="text" placeholder="Например: Недвижимость/Квартиры/Посуточная"/>
          <button id="saveFolder" class="btn ok">Сохранить</button>
          <button id="delFolder" class="btn danger">Удалить</button>
        </div>
        <div class="hr"></div>
        <div class="small">Вложенность через «/». Выбранная папка сохраняется и восстанавливается.</div>
      </div>
    </div>

    <div class="panel">
      <h3>Категории</h3>
      <div class="pad">
        <div class="flex">
          <button id="addCat" class="btn ok">+ Категория</button>
          <span id="pathLabel" class="small"></span>
        </div>
        <div id="list"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h3>Предпросмотр</h3>
    <div class="pad">
      <form id="previewForm" class="preview"></form>
      <div class="small">Значения фильтров сохраняются в localStorage и восстанавливаются.</div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";
  const $ = (s,ctx=document)=>ctx.querySelector(s);
  function el(tag, props){
    const n=document.createElement(tag);
    if(props){
      for(const [k,v] of Object.entries(props)){
        if(k==='dataset' && v && typeof v==='object'){
          for(const [dk,dv] of Object.entries(v)) n.dataset[dk]=dv;
        } else {
          try{ n[k]=v; }catch{ /* ignore readonly setters */ }
        }
      }
    }
    return n;
  }
  const uid = ()=>Math.random().toString(36).slice(2,9);

  const LS_DATA='cat:data:v22N2';
  const LS_PREV='cat:preview:v22N2';
  const LS_FOLD='cat:folder:v22N2';
  const LS_SCROLL='cat:scroll:v22N2';

  let data = load(LS_DATA)||seed();
  let preview = load(LS_PREV)||{};
  let collapsed = data.collapsed||{};
  let currentFolder = localStorage.getItem(LS_FOLD) || '__ALL__';

  function load(k){ try{return JSON.parse(localStorage.getItem(k)||'null');}catch{return null} }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function touch(){ save(LS_DATA, data); save(LS_PREV, preview); localStorage.setItem(LS_FOLD, currentFolder); updateSize(); $('#statusBadge').textContent='Сохранено'; }

  function seed(){
    return {
      folders:[{id:'root', title:'(Все)', parentId:null}],
      categories:[],
      collapsed:{}
    };
  }
  function ensureRoot(){ if(!data.folders.some(f=>f.id==='root')) data.folders.unshift({id:'root',title:'(Все)',parentId:null}); }

  // ===== Undo/Redo =====
  const snapshot=()=>JSON.parse(JSON.stringify({data,preview,collapsed,currentFolder}));
  let hist=[], future=[], pending=null;
  function push(){ if(pending){ hist.push(pending); if(hist.length>80) hist.shift(); future.length=0; pending=null; } }
  function undo(){ if(!hist.length) return; const cur=snapshot(); future.push(cur); const prev=hist.pop(); ({data,preview,collapsed,currentFolder}=JSON.parse(JSON.stringify(prev))); touch(); renderAll(); }
  function redo(){ if(!future.length) return; const cur=snapshot(); hist.push(cur); const next=future.pop(); ({data,preview,collapsed,currentFolder}=JSON.parse(JSON.stringify(next))); touch(); renderAll(); }
  $('#undoBtn').onclick=undo; $('#redoBtn').onclick=redo;
  document.addEventListener('keydown',e=>{ if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); if(e.shiftKey) redo(); else undo(); } });

  // ===== Folders =====
  function normalize(path){ return String(path||'').trim().replace(/\\+/g,'/').replace(/\/+/g,'/').replace(/^\/|\/$/g,''); }
  function ensurePath(path){
    path = normalize(path);
    if(!path) return 'root';
    let parent='root', acc='';
    for(const part of path.split('/')){
      acc = acc ? acc + '/' + part : part;
      let node = data.folders.find(f=>f.parentId===parent && f.title===part);
      if(!node){ node={id:uid(), title:part, parentId:parent}; data.folders.push(node); }
      parent = node.id;
    }
    return parent;
  }
  function pathOf(id){
    if(id==='__ALL__' || id==='root') return '/';
    const chain=[]; let f=data.folders.find(x=>x.id===id);
    while(f && f.parentId){ chain.push(f.title); f=data.folders.find(x=>x.id===f.parentId); }
    return '/'+chain.reverse().join('/');
  }
  function updateFolderFilter(){
    const sel = $('#folderFilter'); sel.innerHTML='';
    sel.append(new Option('(Все)','__ALL__'));
    const list = buildTree();
    for(const item of list){ const depth=item.depth; const text = (depth? '  '.repeat(depth):'') + item.path; sel.append(new Option(text,item.id)); }
    if(currentFolder!=='__ALL__' && !list.some(x=>x.id===currentFolder)) currentFolder='__ALL__';
    sel.value=currentFolder;
    sel.onchange=()=>{ currentFolder=sel.value; localStorage.setItem(LS_FOLD,currentFolder); renderEditor(); renderPreview(); };
    $('#pathLabel').textContent = 'Путь: ' + pathOf(currentFolder);
  }
  function buildTree(){
    const out=[];
    function walk(parentId, prefix){
      const kids = data.folders.filter(f=>f.parentId===parentId && f.id!=='root').sort((a,b)=>a.title.localeCompare(b.title,'ru'));
      for(const k of kids){
        const path = (prefix?prefix+'/':'') + k.title;
        const depth = path.split('/').length-1;
        out.push({id:k.id, path, depth});
        walk(k.id, path);
      }
    }
    walk('root','');
    return out;
  }
  function deleteFolderPath(path){
    const id = pathToId(path);
    if(!id) return;
    // refuse delete if any categories inside subtree
    const allIds = new Set([id]);
    (function collect(pid){ data.folders.filter(f=>f.parentId===pid).forEach(ch=>{ allIds.add(ch.id); collect(ch.id); }); })(id);
    if(data.categories.some(c=> allIds.has(c.folderId))) return alert('Папка не пуста. Переместите категории.');
    // remove subtree
    data.folders = data.folders.filter(f=> !allIds.has(f.id));
  }
  function pathToId(path){
    path = normalize(path); if(!path) return 'root';
    let parent='root', node=null;
    for(const part of path.split('/')){
      node = data.folders.find(f=>f.parentId===parent && f.title===part);
      if(!node) return null;
      parent=node.id;
    }
    return node? node.id : 'root';
  }

  $('#saveFolder').onclick = ()=>{
    const val = normalize($('#folderInput').value);
    if(!val) return;
    pending = snapshot();
    const id = ensurePath(val);
    push(); touch(); updateFolderFilter();
    currentFolder=id; localStorage.setItem(LS_FOLD,currentFolder);
    renderEditor(); renderPreview();
    $('#folderInput').value='';
  };
  $('#delFolder').onclick = ()=>{
    const sel = $('#folderFilter'); if(sel.value==='__ALL__') return alert('Выберите конкретную папку');
    pending = snapshot();
    const p = pathOf(sel.value);
    if(!confirm('Удалить папку '+p+'?')) return;
    deleteFolderPath(p);
    currentFolder='__ALL__';
    push(); touch(); updateFolderFilter(); renderEditor(); renderPreview();
  };

  // ===== Categories =====
  function addCategory(){
    const id = uid();
    const folderId = currentFolder==='__ALL__' ? 'root' : currentFolder;
    data.categories.push({
      id, folderId,
      title:'Новая категория', name:'key_'+id,
      type:'select', layout:'col-3',
      options:'Все объявления, Опция 1, Опция 2',
      map:'', hint:'', showIf:''
    });
  }
  function removeCategory(id){
    data.categories = data.categories.filter(c=>c.id!==id);
    delete collapsed[id];
  }
  function wrapKV(label,ctrl){ const w=el('div',{className:'kv'}); const l=el('div',{className:'small',textContent:label}); w.append(l,ctrl); return w; }
  function renderEditor(){
    const list = $('#list'); list.innerHTML='';
    const cats = data.categories.filter(c=> currentFolder==='__ALL__' ? true : c.folderId===currentFolder);
    cats.forEach(cfg=>{
      const card = el('div',{className:'item'+(collapsed[cfg.id]?'':' open')});
      const head = el('div',{className:'item-h'});
      const left = el('div',{className:'flex'});
      left.append(el('span',{className:'title',textContent:cfg.title||'(без названия)'}),
                  el('span',{className:'small',textContent:(cfg.name||'')}));
      const right = el('div',{className:'flex'});
      const tgl = el('button',{className:'btn',textContent: collapsed[cfg.id]?'▸':'▾'});
      tgl.onclick=()=>{ collapsed[cfg.id]=!collapsed[cfg.id]; card.classList.toggle('open'); touch(); };
      const del = el('button',{className:'btn danger',textContent:'Удалить'});
      del.onclick=()=>{ if(confirm('Удалить категорию?')){ pending=snapshot(); removeCategory(cfg.id); push(); touch(); renderEditor(); renderPreview(); } };
      right.append(tgl,del);
      head.append(left,right);
      card.append(head);

      const body = el('div',{className:'item-b'});
      // title / key
      const iTitle = el('input',{type:'text',value:cfg.title||''});
      iTitle.oninput=()=>{ cfg.title=iTitle.value; left.querySelector('.title').textContent=cfg.title||'(без названия)'; pending=pending||snapshot(); };
      const iKey = el('input',{type:'text',value:cfg.name||''});
      iKey.oninput=()=>{ cfg.name=iKey.value.trim(); pending=pending||snapshot(); };
      body.append(wrapKV('Заголовок', iTitle), wrapKV('Ключ', iKey));

      // type / layout
      const iType = el('select',{}); ['select','multicheck','checkbox','radio','text','number','date','range'].forEach(t=> iType.append(new Option(t,t,false,t===cfg.type)));
      iType.onchange=()=>{ cfg.type=iType.value; pending=pending||snapshot(); renderPreview(); };
      const iLayout = el('select',{}); ['col-6','col-5','col-4','col-3','col-2','col-1','full','half','third','sixth'].forEach(t=> iLayout.append(new Option(t,t,false,(cfg.layout||'')===t)));
      iLayout.onchange=()=>{ cfg.layout=iLayout.value; pending=pending||snapshot(); renderPreview(); };
      body.append(wrapKV('Тип', iType), wrapKV('Layout', iLayout));

      // folder
      const iFolder = el('input',{type:'text',value: pathOf(cfg.folderId).slice(1)});
      iFolder.placeholder='Недвижимость/Квартиры';
      iFolder.onchange=()=>{ const id = ensurePath(iFolder.value); cfg.folderId=id; pending=pending||snapshot(); updateFolderFilter(); renderEditor(); };
      body.append(wrapKV('Папка', iFolder));

      // options/map
      const iOpts = el('textarea',{value:String(cfg.options||'')});
      iOpts.oninput=()=>{ cfg.options=iOpts.value; pending=pending||snapshot(); };
      const iMap = el('textarea',{value:String(cfg.map||'')});
      iMap.oninput=()=>{ cfg.map=iMap.value; pending=pending||snapshot(); };
      body.append(wrapKV('Опции (через запятую)', iOpts), wrapKV('Карта key=value по строкам', iMap));

      // hint/showIf
      const iHint = el('input',{type:'text',value:cfg.hint||''});
      iHint.oninput=()=>{ cfg.hint=iHint.value; pending=pending||snapshot(); };
      const iShow = el('input',{type:'text',value:cfg.showIf||''});
      iShow.placeholder='пример: Chapter=Недвижимость & category=Посуточная аренда';
      iShow.oninput=()=>{ cfg.showIf=iShow.value; pending=pending||snapshot(); renderPreview(); };
      body.append(wrapKV('Подсказка', iHint), wrapKV('Условие отображения', iShow));

      card.append(body);
      list.append(card);
    });
    // commit changes if any
    if(pending){ push(); touch(); pending=null; }
  }

  // ===== Preview =====
  const PRE_LABEL='Все объявления';
  function layoutCls(v){
    if(/^col-[1-6]$/.test(v)) return v;
    if(v==='full') return 'col-6';
    if(v==='half') return 'col-3';
    if(v==='third') return 'col-2';
    if(v==='sixth') return 'col-1';
    return 'col-3';
  }
  function parseMap(txt){ const out={}; String(txt||'').split(/\n/).forEach(line=>{ const m=String(line).trim(); if(!m) return; const [k,...rest]=m.split('='); const v=rest.join('=').split(',').map(s=>s.trim()).filter(Boolean); if(k) out[k.trim()]=v; }); return out; }
  function optList(c){
    const map = parseMap(c.map);
    let parentKey=null;
    if(c.showIf && c.showIf.includes('=')){ const t=c.showIf.split('&')[0].trim(); parentKey = t.split('=')[0].trim(); }
    if(parentKey && preview[parentKey] && map[preview[parentKey]]) return map[preview[parentKey]].slice();
    const txt=String(c.options||''); if(!txt.trim()) return [];
    return txt.split(',').map(s=>s.trim()).filter(Boolean);
  }
  function setSelPlaceholder(sel){ if(!sel.options.length || sel.options[0].value!==''){ sel.insertBefore(new Option(PRE_LABEL,''), sel.firstChild); } }
  function assignSelValue(sel,key){ const v=preview[key]??''; const ok=[...sel.options].some(o=>o.value===v); sel.value = ok? v : ''; preview[key]=sel.value; save(LS_PREV,preview); }

  function visibleBy(c){
    const cond = String(c.showIf||'').trim(); if(!cond) return true;
    const tests = cond.split('&').map(s=>s.trim()).filter(Boolean);
    return tests.every(t=>{
      const [k,v] = t.split('=');
      if(v===undefined) return true;
      const variants = v.split('|').map(s=>s.trim());
      return variants.includes(String(preview[k]??''));
    });
  }

  function renderPreview(){
    const form = $('#previewForm');
    const sc = form.parentElement.scrollTop;
    form.innerHTML='';

    const inFolder = data.categories.filter(c=> currentFolder==='__ALL__' ? true : c.folderId===currentFolder);
    for(const c of inFolder){
      if(!visibleBy(c)) continue;
      const wrap = el('div',{className:layoutCls(c.layout||'col-3')});
      const lab = el('label',{textContent:c.title||c.name||c.id}); wrap.append(lab);
      const key = c.name||c.id;
      let ctrl;

      if(c.type==='select'){
        ctrl = el('select',{}); setSelPlaceholder(ctrl);
        for(const o of optList(c)){ if(o!==PRE_LABEL) ctrl.append(new Option(o,o)); }
        assignSelValue(ctrl,key);
        ctrl.onchange=()=>{ preview[key]=ctrl.value; save(LS_PREV,preview); };
      }
      else if(c.type==='radio'){
        ctrl = el('select',{});
        const opts = optList(c);
        if(opts.length) opts.forEach(o=> ctrl.append(new Option(o,o)));
        if(!opts.length) ctrl.append(new Option('(нет опций)',''));
        ctrl.value = String(preview[key]??(opts[0]||''));
        preview[key]=ctrl.value; save(LS_PREV,preview);
        ctrl.onchange=()=>{ preview[key]=ctrl.value; save(LS_PREV,preview); };
      }
      else if(c.type==='multicheck'){
        const dd = el('div',{className:'dropdown'});
        const btn = el('button',{type:'button',className:'dbtn'});
        const valSpan = el('span',{textContent:PRE_LABEL,className:'small'});
        const arr = new Set(String(preview[key]||'').split('|').filter(Boolean));
        const menu = el('div',{className:'menu'});
        function updateText(){
          const list=[...arr];
          valSpan.textContent = list.length ? (list.length<=2 ? list.join(', ') : list.length+' выбрано') : PRE_LABEL;
          valSpan.style.opacity = list.length? '1' : '.75';
        }
        btn.append(valSpan, el('span',{textContent:'▾'}));
        btn.onclick = (e)=>{ e.stopPropagation(); document.querySelectorAll('.dropdown.open').forEach(d=>{if(d!==dd)d.classList.remove('open')}); dd.classList.toggle('open'); };
        document.addEventListener('click', e=>{ if(!dd.contains(e.target)) dd.classList.remove('open'); });
        for(const o of optList(c)){
          const row = el('div',{className:'row'});
          const cb = el('input',{type:'checkbox'}); cb.checked = arr.has(o);
          cb.onchange = ()=>{ if(cb.checked) arr.add(o); else arr.delete(o); preview[key]=[...arr].join('|'); save(LS_PREV,preview); updateText(); };
          row.append(cb, el('span',{textContent:o}));
          menu.append(row);
        }
        updateText();
        dd.append(btn,menu);
        ctrl = dd;
      }
      else if(c.type==='checkbox'){
        const cb = el('input',{type:'checkbox'}); cb.checked = !!preview[key];
        cb.onchange=()=>{ preview[key]=cb.checked; save(LS_PREV,preview); };
        ctrl = cb;
      }
      else if(c.type==='text' || c.type==='number' || c.type==='date'){
        const inp = el('input',{type:(c.type==='text'?'text':c.type)}); inp.value = preview[key]??'';
        inp.oninput=()=>{ preview[key]=inp.value; save(LS_PREV,preview); };
        ctrl = inp;
      }
      else if(c.type==='range'){
        const row = el('div',{className:'flex'});
        const lo = el('input',{type:'number',placeholder:'От',style:'width:100%'});
        const hi = el('input',{type:'number',placeholder:'До',style:'width:100%'});
        const cur = preview[key]||{}; lo.value=cur.min||''; hi.value=cur.max||'';
        const upd = ()=>{ preview[key]={min:lo.value,max:hi.value}; save(LS_PREV,preview); };
        lo.oninput=upd; hi.oninput=upd;
        row.append(lo,hi); ctrl=row;
      } else {
        ctrl = el('div',{className:'small',textContent:'(тип '+c.type+' не поддержан)'});
      }

      wrap.append(ctrl);
      if(c.hint) wrap.append(el('div',{className:'hint',textContent:c.hint}));
      form.append(wrap);
    }
    setTimeout(()=>{ form.parentElement.scrollTop = Number(localStorage.getItem(LS_SCROLL)||0); },0);
  }

  const prevWrap = $('#previewForm').parentElement;
  prevWrap.addEventListener('scroll', ()=>{ localStorage.setItem(LS_SCROLL, prevWrap.scrollTop); });

  // ===== Top actions =====
  $('#addCat').onclick=()=>{ pending=snapshot(); addCategory(); push(); touch(); renderEditor(); renderPreview(); };
  $('#collapseAll').onclick=()=>{ data.categories.forEach(c=> collapsed[c.id]=true); data.collapsed=collapsed; touch(); renderEditor(); };
  $('#expandAll').onclick=()=>{ data.collapsed={}; collapsed={}; touch(); renderEditor(); };
  $('#clearBtn').onclick=()=>{ if(confirm('Очистить все локальные данные?')){ pending=snapshot(); data=seed(); preview={}; collapsed={}; currentFolder='__ALL__'; push(); touch(); renderAll(); } };

  // ===== Import/Export =====
  $('#importBtn').onclick=()=>$('#fileInput').click();
  $('#fileInput').onchange=async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const txt=await f.text(); const json=JSON.parse(txt);
      if(!json || !Array.isArray(json.categories)) throw new Error('wrong format');
      pending=snapshot();
      data = {folders: json.folders && Array.isArray(json.folders) ? json.folders : [{id:'root',title:'(Все)',parentId:null}], categories: json.categories, collapsed: json.collapsed||{}};
      ensureRoot(); preview={}; collapsed=data.collapsed||{}; currentFolder='__ALL__';
      push(); touch(); renderAll(); alert('Импортировано');
    }catch(err){ alert('Ошибка импорта'); }
    e.target.value='';
  };
  $('#exportBtn').onclick=()=>{
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=el('a',{href:URL.createObjectURL(blob),download:'categories_editor_v22N2.json'});
    document.body.appendChild(a); a.click(); a.remove();
  };

  function renderAll(){ updateFolderFilter(); renderEditor(); renderPreview(); }
  function updateSize(){ try{ const bytes = new Blob([JSON.stringify({data,preview})]).size; $('#sizeBadge').textContent='Объём: '+bytes+' Б'; }catch{ $('#sizeBadge').textContent='Объём: ?'; } }

  // init
  ensureRoot(); updateFolderFilter(); renderEditor(); renderPreview(); updateSize();
})();
</script>
</body>
</html>
