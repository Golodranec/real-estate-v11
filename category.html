<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>categories_editor_full_v12R — полный редактор (фикс dropdown multicheck)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#0f172a;--panel:#111827;--line:#1f2937;--text:#e5e7eb;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial;height:100vh;display:flex;flex-direction:column}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#0b1220;position:sticky;top:0;z-index:10}
  .left,.right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#0b1220;font-size:12px}
  nav.tabs{display:flex;gap:8px;padding:8px;background:#111827;border-bottom:1px solid var(--line)}
  nav.tabs button{padding:8px 12px;border-radius:6px;border:1px solid var(--line);background:#1f2937;color:var(--text);cursor:pointer}
  nav.tabs button.active{background:var(--ok);color:#052e16}
  main{flex:1;overflow:auto;padding:12px;max-width:1200px;margin:0 auto;width:100%}
  button{padding:6px 10px;border-radius:6px;border:1px solid var(--line);background:#1f2937;color:var(--text);cursor:pointer}
  button.primary{background:var(--ok);color:#052e16}
  button.warn{background:var(--warn);color:#3b2306}
  button.danger{background:var(--err);color:#3b0a0a}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0;cursor:grab}
  .card.dragging{opacity:0.5}
  .card h3{margin:0 0 8px 0;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
  label{display:block;font-size:12px;opacity:.9;margin-bottom:4px}
  input,select,textarea{width:100%;padding:6px;border-radius:6px;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;font:inherit}
  textarea{min-height:60px}
  .mini{font-size:12px;opacity:.75}
  .ghost{opacity:.7}
  .top-actions{display:flex;gap:8px;align-items:center}
  .hidden{display:none}

  /* Сетка предпросмотра */
  .preview-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
  .preview-form .full { grid-column: span 2; }
  .preview-form .half { grid-column: span 1; }
  .preview-form .third { grid-column: span 1; }

  .hint{font-size:12px;color:#9ca3af;margin-top:2px}
  .divider{height:1px;background:var(--line);margin:8px 0}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:8px}
  .help{font-size:12px;opacity:.8}
  .inline{display:flex;gap:8px;align-items:center}

  /* Dropdown Multicheck в стиле select */
  .dropdown{position:relative}
  .dropdown-toggle{display:flex;align-items:center;justify-content:space-between;gap:8px;width:100%;padding:8px 10px;background:#ffffff;color:#111;border:1px solid #cfd4dc;border-radius:8px;cursor:pointer}
  .dropdown-toggle .arrow{transition:transform .15s ease}
  .dropdown.open .dropdown-toggle .arrow{transform:rotate(180deg)}
  .dropdown-menu{position:absolute;top:calc(100% + 6px);left:0;min-width:100%;background:#ffffff;border:1px solid #cfd4dc;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:50;display:none;max-height:280px;overflow:auto}
  .dropdown.open .dropdown-menu{display:block}
  .dropdown-menu .item{display:flex;align-items:center;gap:10px;padding:10px 12px;font-size:14px;cursor:pointer;color:#111}
  .dropdown-menu .item:hover{background:#f3f4f6}
  .dropdown-menu .item input{width:18px;height:18px}
</style>
</head>
<body>
  <header>
    <div class="left">
      <strong>Категории — полный редактор</strong>
      <span class="badge">v12R</span>
      <span id="sizeBadge" class="badge">Размер: …</span>
      <span id="statusBadge" class="badge">Сохранено</span>
    </div>
    <div class="right top-actions">
      <input type="file" id="fileInput" accept=".json,application/json" style="display:none">
      <button id="importBtn">Импорт</button>
      <button id="exportBtn" class="primary">Экспорт</button>
      <button id="addBtn">+ Категория</button>
      <button id="clearBtn" class="danger">Очистить</button>
    </div>
  </header>

  <nav class="tabs">
    <button id="tab-editor" class="active">Редактор</button>
    <button id="tab-preview">Предпросмотр</button>
    <button id="tab-help">Справка</button>
  </nav>

  <main>
    <section id="editorSection">
      <div id="list"></div>
    </section>

    <section id="previewSection" class="hidden">
      <form id="previewForm" class="preview-form"></form>
    </section>

    <section id="helpSection" class="hidden">
      <div class="card">
        <h3>Подсказки</h3>
        <div class="kv">
          <div>Условия</div><div><code>key=val1|val2</code> и AND: <code>key1=... & key2=...</code></div>
          <div>Layout</div><div><code>full</code>, <code>half</code>, <code>third</code></div>
          <div>Типы</div><div><b>range</b> (От/До), <b>multicheck</b> (выпадающий список галочек)</div>
          <div>ID</div><div>внутренний уникальный идентификатор блока. Менять не нужно.</div>
        </div>
      </div>
    </section>
  </main>

<script>
const $=s=>document.querySelector(s);
const el=(t,p={})=>Object.assign(document.createElement(t),p);
const uid=()=>Math.random().toString(36).slice(2,9);

const LS_KEY="categories_editor_full_v12R_data";
let data={categories:[]};
function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw) data=JSON.parse(raw); }catch{} }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)); updateSize(); $("#statusBadge").textContent="Сохранено"; }

const listEl=$("#list");
let dragSrcId=null;

function renderEditor(){
  listEl.innerHTML="";
  const parentOptions=(currentId=null)=>{
    const invalid=new Set();
    if(currentId){
      invalid.add(currentId);
      (function markChildren(id){
        data.categories.filter(f=>f.parentId===id).forEach(ch=>{invalid.add(ch.id);markChildren(ch.id)});
      })(currentId);
    }
    const opts=[{id:"", name:"(нет)"}].concat(
      data.categories.filter(f=>!invalid.has(f.id)).map(f=>({id:f.id,name:`${f.title||f.name||f.id}`}))
    );
    return opts;
  };

  data.categories.forEach((f, idx)=>{
    const c=el("div",{className:"card",draggable:true});
    c.dataset.id=f.id;

    c.ondragstart=(e)=>{dragSrcId=f.id;c.classList.add("dragging");e.dataTransfer.effectAllowed="move";};
    c.ondragend=()=>{c.classList.remove("dragging");};
    c.ondragover=(e)=>{e.preventDefault();};
    c.ondrop=(e)=>{
      e.preventDefault();
      const srcIndex=data.categories.findIndex(x=>x.id===dragSrcId);
      const targetIndex=idx;
      if(srcIndex>=0 && targetIndex>=0 && srcIndex!==targetIndex){
        const moved=data.categories.splice(srcIndex,1)[0];
        data.categories.splice(targetIndex,0,moved);
        save();renderEditor();renderPreview();
      }
    };

    const h=el("h3");
    h.append(el("span",{textContent:f.title||"Без заголовка"}), el("span",{className:"mini ghost",textContent:`(${f.name||f.id})`}));
    const delBtn=el("button",{className:"danger",textContent:"Удалить"});
    delBtn.onclick=()=>{ if(confirm("Удалить категорию и её потомков?")) removeCategory(f.id); };
    h.append(delBtn);
    c.appendChild(h);

    const r1=el("div",{className:"row"});
    r1.append(wrap("Заголовок", el("input",{value:f.title||"", oninput:e=>{f.title=e.target.value; dirty();}})),
               wrap("Имя (ключ)", el("input",{value:f.name||"", oninput:e=>{f.name=e.target.value; dirty();}})));
    c.appendChild(r1);

    const r2=el("div",{className:"row"});
    const typeSel=el("select",{onchange:e=>{f.type=e.target.value; dirty(); renderEditor();}});
    ["group","text","number","select","checkbox","date","range","multicheck"].forEach(t=> typeSel.append(el("option",{value:t,textContent:t,selected:f.type===t})));
    r2.append(wrap("Тип",typeSel),
              wrap("Описание",el("input",{value:f.hint||"", oninput:e=>{f.hint=e.target.value; dirty();}})));
    c.appendChild(r2);

    const r3=el("div",{className:"row"});
    const pSel=el("select",{onchange:e=>{f.parentId=e.target.value||null; dirty(); renderEditor();}});
    parentOptions(f.id).forEach(o=> pSel.append(el("option",{value:o.id,textContent:o.name,selected:(f.parentId||"")===(o.id||"")})));
    r3.append(wrap("Родитель",pSel),
              wrap("Условие отображения",el("input",{value:f.showIf||"",placeholder:"key=val1|val2 [& key2=...]", oninput:e=>{f.showIf=e.target.value; dirty();}})));
    c.appendChild(r3);

    const r4=el("div",{className:"row"});
    r4.append(wrap("Опции (для select/multicheck)",el("textarea",{value:(f.options||[]).join(', '), oninput:e=>{f.options=e.target.value.split(',').map(x=>x.trim()).filter(Boolean); dirty();}})),
              wrap("Карта опций",el("textarea",{value:mapToText(f.map||{}), oninput:e=>{f.map=textToMap(e.target.value); dirty();}})));
    c.appendChild(r4);

    const r5=el("div",{className:"row"});
    const layoutSel=el("select",{onchange:e=>{f.layout=e.target.value; dirty();}});
    ["full","half","third"].forEach(t=> layoutSel.append(el("option",{value:t,textContent:t,selected:(f.layout||"half")===t})));
    r5.append(wrap("Layout",layoutSel),
              wrap("ID",el("input",{value:f.id||"",oninput=e=>{f.id=e.target.value; dirty();}})));
    c.appendChild(r5);

    listEl.appendChild(c);
  });

  const addBtn=el("button",{textContent:"+ Категория"});
  addBtn.onclick=addCategory;
  listEl.appendChild(addBtn);
}

function dirty(){ $("#statusBadge").textContent="Есть несохранённые изменения"; save(); }

function wrap(label,control){const w=el("div");w.append(el("label",{textContent:label}),control);return w;}
function mapToText(mapObj){return Object.entries(mapObj).map(([k,arr])=>`${k}=${arr.join(',')}`).join("\n");}
function textToMap(txt){const out={};txt.split(/\n/).forEach(l=>{const [k,v]=l.split('=');if(k) out[k.trim()]=(v||'').split(',').map(x=>x.trim()).filter(Boolean)});return out;}
function addCategory(){data.categories.push({id:uid(),title:"Новая категория",name:"",type:"text",hint:"",parentId:null,options:[],map:{},showIf:"",layout:"half"}); save(); renderEditor();}
function removeCategory(id){function rm(fid){data.categories.filter(f=>f.parentId===fid).forEach(ch=>rm(ch.id));data.categories=data.categories.filter(f=>f.id!==fid);}rm(id);save();renderEditor();renderPreview();}

// ===== preview =====
let previewValues={};
function parseShowIf(str){
  if(!str) return ()=>true;
  const parts = str.split("&").map(s=>s.trim()).filter(Boolean);
  const tests = parts.map(p=>{
    const [k,v]=p.split("="); if(!k||v===undefined) return ()=>true;
    const allowed = v.split("|").map(s=>s.trim());
    return (vals)=> allowed.includes(String(vals[k] ?? ""));
  });
  return (vals)=> tests.every(t=>t(vals));
}
function visibleByCondition(f){
  const test=parseShowIf(f.showIf||"");
  return test(previewValues);
}
function optionsFor(f){
  let opts = Array.isArray(f.options)?f.options.slice():[];
  if(f.parentId){
    const p = data.categories.find(x=>x.id===f.parentId);
    const pKey = p?.name || p?.id;
    const pVal = previewValues[pKey];
    if(f.map && pVal && f.map[pVal]) opts = f.map[pVal].slice();
  }
  return opts;
}

function makeDropdownMulticheck(fieldDef){
  const key = fieldDef.name || fieldDef.id;
  const allLabel = "Все объявления";
  const baseOpts = optionsFor(fieldDef);
  const items = (baseOpts[0]===allLabel?baseOpts:[allLabel, ...baseOpts]);

  const container = el("div",{className:"dropdown"});
  const toggle = el("button",{type:"button",className:"dropdown-toggle"});
  const arrow = el("span",{className:"arrow",textContent:"▾"});
  const valueSpan = el("span",{textContent: allLabel});
  toggle.append(valueSpan,arrow);

  const menu = el("div",{className:"dropdown-menu"});
  const current = new Set(previewValues[key]||[]);

  items.forEach((opt, idx)=>{
    const row = el("label",{className:"item"});
    const cb = el("input",{type:"checkbox"});
    cb.checked = current.size ? current.has(opt) : (opt===allLabel);
    cb.onchange = (e)=>{
      e.stopPropagation();
      let set = new Set(previewValues[key]||[]);
      if(opt===allLabel){
        if(cb.checked){ set = new Set(items); }
        else{ set.clear(); }
        // Синхронизируем все чекбоксы, кроме первого (самого "все")
        menu.querySelectorAll('label.item input').forEach((x,i)=>{ if(i>0) x.checked = cb.checked; });
      }else{
        if(cb.checked) set.add(opt); else set.delete(opt);
        const allBox = menu.querySelector('label.item input');
        if(allBox){ allBox.checked = set.size === items.length; }
      }
      previewValues[key] = Array.from(set);
      valueSpan.textContent = (previewValues[key].length && previewValues[key].length<4)
         ? previewValues[key].filter(v=>v!==allLabel).join(", ")
         : allLabel;
    };
    row.append(cb, document.createTextNode(opt));
    menu.append(row);
  });

  toggle.onclick = (e)=>{ e.stopPropagation(); container.classList.toggle("open"); };
  // Закрываем по клику вне меню, но НЕ закрываем при клике внутри меню
  document.addEventListener("click", (e)=>{
    if(!container.contains(e.target)){ container.classList.remove("open"); }
  });

  container.append(toggle,menu);
  return container;
}

function renderPreview(){
  const form=$("#previewForm");
  form.innerHTML="";
  data.categories.forEach(f=>{
    if(f.type==="group"){
      const sel=el("select");
      sel.append(el("option",{value:"",textContent:"—"}));
      (f.options||[]).forEach(o=>sel.append(el("option",{value:o,textContent:o})));
      const key=f.name||f.id;
      if(previewValues[key]) sel.value=previewValues[key];
      sel.onchange=()=>{previewValues[key]=sel.value;renderPreview();};
      const w=wrap(f.title||f.name||f.id, sel);
      if(f.hint) w.append(el("div",{className:"hint",textContent:f.hint}));
      if(f.layout) w.classList.add(f.layout);
      form.append(w);
      return;
    }

    if(!visibleByCondition(f)) return;

    let ctrl, w;
    const key=f.name||f.id;

    if(f.type==="select"){
      ctrl=el("select");
      ctrl.append(el("option",{value:"",textContent:"—"}));
      optionsFor(f).forEach(o=>ctrl.append(el("option",{value:o,textContent:o})));
      if(previewValues[key]) ctrl.value=previewValues[key];
      ctrl.onchange=()=>{previewValues[key]=ctrl.value;renderPreview();};
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else if(f.type==="checkbox"){
      ctrl=el("input",{type:"checkbox"});
      ctrl.checked=!!previewValues[key];
      ctrl.onchange=()=>{previewValues[key]=ctrl.checked;};
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else if(f.type==="text"||f.type==="number"||f.type==="date"){
      ctrl=el("input",{type:f.type});
      if(previewValues[key]) ctrl.value=previewValues[key];
      ctrl.oninput=()=>{previewValues[key]=ctrl.value;};
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else if(f.type==="range"){
      const box=el("div",{className:"inline"});
      const min=el("input",{type:"number",placeholder:"От"});
      const max=el("input",{type:"number",placeholder:"До"});
      if(previewValues[key]){ min.value=previewValues[key].min||""; max.value=previewValues[key].max||""; }
      min.oninput=()=>{previewValues[key]={...(previewValues[key]||{}),min:min.value};};
      max.oninput=()=>{previewValues[key]={...(previewValues[key]||{}),max:max.value};};
      box.append(min,max);
      w=wrap(f.title||f.name||f.id, box);
    }
    else if(f.type==="multicheck"){
      ctrl = makeDropdownMulticheck(f);
      w=wrap(f.title||f.name||f.id, ctrl);
    }
    else{
      return;
    }

    if(f.hint) w.append(el("div",{className:"hint",textContent:f.hint}));
    if(f.layout) w.classList.add(f.layout);
    form.append(w);
  });
}

// ===== import/export and tabs =====
$("#importBtn").onclick=()=>$("#fileInput\").click();
$("#fileInput").onchange=async e=>{const f=e.target.files?.[0];if(!f) return;try{const txt=await f.text();const json=JSON.parse(txt);if(Array.isArray(json.categories)) data=json; else if(Array.isArray(json.items)) data={categories:json.items};save();renderEditor();previewValues={};renderPreview();alert(\"Импортировано\");}catch(err){alert(\"Ошибка: \"+err.message);}};
$("#exportBtn").onclick=()=>{const blob=new Blob([JSON.stringify(data,null,2)],{type:\"application/json\"});const a=el(\"a\",{href:URL.createObjectURL(blob),download:\"categories_editor_full_v12R.json\"});document.body.appendChild(a);a.click();a.remove();};
$("#addBtn").onclick=addCategory;
$("#clearBtn").onclick=()=>{if(confirm(\"Очистить все?\")){data={categories:[]};save();renderEditor();previewValues={};renderPreview();}};
$("#tab-editor").onclick=()=>{activate(\"editor\");};
$("#tab-preview").onclick=()=>{activate(\"preview\");};
$("#tab-help").onclick=()=>{activate(\"help\");};

function activate(tab){
  $(\"#tab-editor\").classList.remove(\"active\");
  $(\"#tab-preview\").classList.remove(\"active\");
  $(\"#tab-help\").classList.remove(\"active\");
  $(\"#editorSection\").classList.add(\"hidden\");
  $(\"#previewSection\").classList.add(\"hidden\");
  $(\"#helpSection\").classList.add(\"hidden\");
  if(tab===\"editor\"){ $(\"#tab-editor\").classList.add(\"active\"); $(\"#editorSection\").classList.remove(\"hidden\"); }
  else if(tab===\"preview\"){ $(\"#tab-preview\").classList.add(\"active\"); $(\"#previewSection\").classList.remove(\"hidden\"); renderPreview(); }
  else { $(\"#tab-help\").classList.add(\"active\"); $(\"#helpSection\").classList.remove(\"hidden\"); }
}

function updateSize(){try{const bytes=new Blob([document.documentElement.outerHTML]).size;$(\"#sizeBadge\").textContent=`Размер: ${(bytes/1024).toFixed(1)} КБ`;}catch{$(\"#sizeBadge\").textContent=\"Размер: ?\";}}

(function init(){
  load();
  if(!data.categories.length){
    data.categories=[
      {id:\"sec\",name:\"Chapter\",title:\"Раздел\",type:\"group\",options:[\"Недвижимость\",\"Транспорт\",\"Здоровье\"],hint:\"Выберите верхний раздел\",layout:\"half\"},
      {id:\"cat\",name:\"category\",title:\"Категория\",type:\"select\",parentId:\"sec\",showIf:\"Chapter=Недвижимость|Транспорт\",map:{
        \"Недвижимость\":[\"Квартира\",\"Дома\",\"Коммерция\",\"Земля\",\"Посуточная аренда\"],
        \"Транспорт\":[\"Легковые автомобили\",\"Грузовые автомобили\"]
      },options:[],layout:\"half\"},
      {id:\"sub\",name:\"Subcategory\",title:\"Подкатегория\",type:\"select\",parentId:\"cat\",showIf:\"category=Квартира|Дома|Коммерция|Земля|Посуточная аренда\",map:{
        \"Квартира\":[\"Аренда\",\"Продажа\"],
        \"Дома\":[\"Аренда\",\"Продажа\"],
        \"Коммерция\":[\"Аренда\",\"Продажа\"],
        \"Земля\":[\"Продажа\"],
        \"Посуточная аренда\":[\"Квартиры\",\"Дома\",\"Хостелы\",\"Гостиницы\",\"Санатории/Дома отдыха\"]
      },options:[],layout:\"half\"},

      {id:\"type\",name:\"TypeOfHousing\",title:\"Тип жилья\",type:\"select\",parentId:\"cat\",showIf:\"Chapter=Недвижимость & category=Квартира\",options:[\"Новостройка\",\"Вторичка\",\"От застройщика\"],layout:\"half\"},

      {id:\"price\",name:\"Price\",title:\"Цена (за сутки)\",type:\"range\",parentId:\"cat\",showIf:\"Chapter=Недвижимость & category=Посуточная аренда\",layout:\"half\"},
      {id:\"beds\",name:\"Beds\",title:\"Количество спальных мест\",type:\"select\",parentId:\"cat\",showIf:\"Chapter=Недвижимость & category=Посуточная аренда\",options:[\"1\",\"2\",\"3\",\"4\",\"5+\"],layout:\"half\"},
      {id:\"rules\",name:\"Rules\",title:\"Правила\",type:\"select\",parentId:\"cat\",showIf:\"Chapter=Недвижимость & category=Посуточная аренда\",options:[\"Без животных\",\"Без вечеринок\",\"Только некурящие\"],layout:\"half\"},
      {id:\"comfort\",name:\"Comfort\",title:\"Удобства\",type:\"multicheck\",parentId:\"cat\",showIf:\"Chapter=Недвижимость & category=Посуточная аренда\",options:[\"Микроволновая печь\",\"Утюг\",\"Фен\",\"Холодильник\",\"Wi‑Fi\",\"Телевизор\",\"Кондиционер\",\"Парковка\"],layout:\"full\"},
      {id:\"infra\",name:\"Infrastructure\",title:\"Инфраструктура\",type:\"select\",parentId:\"cat\",showIf:\"Chapter=Недвижимость & category=Посуточная аренда\",options:[\"Метро рядом\",\"Центр города\",\"Магазины поблизости\"],layout:\"half\"},
      {id:\"food\",name:\"Food\",title:\"Питание\",type:\"select\",parentId:\"cat\",showIf:\"Chapter=Недвижимость & category=Посуточная аренда\",options:[\"Без питания\",\"Завтрак включен\",\"Полный пансион\"],layout:\"half\"},

      {id:\"hotelName\",name:\"HotelName\",title:\"Название отеля\",type:\"text\",parentId:\"cat\",showIf:\"Chapter=Недвижимость & category=Посуточная аренда & Subcategory=Гостиницы|Санатории/Дома отдыха\",layout:\"half\"},
      {id:\"roomCat\",name:\"RoomCategory\",title:\"Категория номера\",type:\"select\",parentId:\"sub\",showIf:\"Chapter=Недвижимость & category=Посуточная аренда & Subcategory=Санатории/Дома отдыха\",options:[\"Эконом\",\"Стандарт\",\"Полулюкс\",\"Люкс\",\"Коттедж\"],layout:\"half\"},

      {id:\"brand\",name:\"Brand\",title:\"Марка авто\",type:\"select\",parentId:\"cat\",showIf:\"Chapter=Транспорт\",options:[\"Chevrolet\",\"Hyundai\"],layout:\"half\"},
      {id:\"year\",name:\"Year\",title:\"Год выпуска\",type:\"number\",parentId:\"cat\",showIf:\"Chapter=Транспорт\",layout:\"half\"}
    ];
  }
  renderEditor();
  renderPreview();
  updateSize();
})();
</script>
</body>
</html>
