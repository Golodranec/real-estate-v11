<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Фильтр v39.29R — редактор как в справочнике</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#374151; --text:#e5e7eb;
    --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --card:#0b1220;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;border-bottom:1px solid #1f2937;background:var(--panel);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:16px;font-weight:600}
  header .pill{padding:2px 8px;border:1px solid #1f2937;border-radius:999px;background:#0b1220}
  .wrap{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 56px)}
  aside{border-right:1px solid #1f2937;background:var(--panel);padding:12px;display:flex;flex-direction:column;gap:12px}
  main{padding:16px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:12px}
  h2{margin:0 0 8px 0;font-size:15px}
  h3{margin:0 0 8px 0;font-size:14px;color:#cbd5e1}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:6px}
  input,select,textarea{background:#0a101c;border:1px solid #1f2937;color:var(--text);border-radius:8px;padding:8px;width:100%}
  textarea{min-height:160px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:12px}
  button{border:1px solid #1f2937;background:#0b1220;color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:var(--accent);color:#052e16;border-color:#16a34a}
  button.warn{background:var(--warn);color:#3b2200;border-color:#b45309}
  button.danger{background:var(--danger);color:#3b0a0a;border-color:#b91c1c}
  button.ghost{background:transparent}
  .sp{flex:1}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .list{max-height:220px;overflow:auto;border:1px solid #1f2937;border-radius:8px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #111827}
  .list-item:last-child{border-bottom:none}
  .muted{color:#9ca3af}
  .badge{padding:2px 6px;border:1px solid #1f2937;border-radius:6px;background:#0b1220;font-size:12px}
  .tabs{display:flex;gap:8px}
  .tabs button.active{outline:2px solid #16a34a}
  .hidden{display:none}
  .note{font-size:12px;color:#9ca3af}
  .hr{height:1px;background:#1f2937;margin:8px 0}
</style>
</head>
<body>
<header>
  <h1>Фильтр v39.29R</h1>
  <span class="pill">режим: офлайн / JSON</span>
  <span class="pill">локальное хранение: localStorage</span>
  <span class="pill">интерфейс как в «Справочнике»</span>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <h2>Навигация</h2>
      <div class="tabs">
        <button id="tab-ui" class="active">Фильтр</button>
        <button id="tab-data">Данные</button>
        <button id="tab-help">Справка</button>
      </div>
    </div>

    <div class="card">
      <h2>Разделы</h2>
      <div class="row">
        <select id="sectionSelect" class="sp"></select>
        <button id="addSectionBtn" title="Добавить раздел">＋</button>
      </div>
      <div class="row">
        <input id="sectionName" placeholder="Название раздела">
        <button id="saveSectionBtn" class="primary">Сохранить</button>
        <button id="delSectionBtn" class="danger">Удалить</button>
      </div>
    </div>

    <div class="card">
      <h2>Категории</h2>
      <div class="row">
        <select id="categorySelect" class="sp"></select>
        <button id="addCategoryBtn" title="Добавить категорию">＋</button>
      </div>
      <div class="row">
        <input id="categoryName" placeholder="Название категории">
        <button id="saveCategoryBtn" class="primary">Сохранить</button>
        <button id="delCategoryBtn" class="danger">Удалить</button>
      </div>
    </div>

    <div class="card">
      <h2>Подкатегории</h2>
      <div class="row">
        <div class="sp"></div>
        <button id="addSubcategoryBtn" title="Добавить подкатегорию">＋</button>
      </div>
      <div class="row">
        <input id="subcategoryName" class="sp" placeholder="Название подкатегории">
        <button id="saveSubcategoryBtn" class="primary">Сохранить</button>
        <button id="delSubcategoryBtn" class="danger">Удалить</button>
      </div>
      <div class="list" id="subcategoriesList"></div>
    </div>
  </aside>

  <main>
    <section id="uiView" class="card">
      <h2>Просмотр фильтра</h2>
      <div class="grid">
        <div class="col card">
          <h3>Раздел</h3>
          <select id="uiSection"></select>
          <div class="note">Выбор раздела подтягивает категории и подкатегории.</div>
        </div>
        <div class="col card">
          <h3>Категория</h3>
          <select id="uiCategory"></select>
          <div class="note">Список зависит от выбранного раздела.</div>
        </div>
        <div class="col card">
          <h3>Подкатегория</h3>
          <select id="uiSubcategory"></select>
          <div class="note">Список зависит от выбранной категории.</div>
        </div>
      </div>
    </section>

    <section id="dataView" class="card hidden">
      <h2>Редактор данных (JSON)</h2>
      <div class="row">
        <input type="file" id="fileInput" accept=".json,application/json">
        <button id="importBtn" class="warn">Импорт из файла</button>
        <button id="exportBtn" class="primary">Экспорт в JSON</button>
        <button id="resetBtn" class="danger">Сброс к дефолту</button>
        <span class="sp"></span>
        <button id="saveLocalBtn">Сохранить в localStorage</button>
        <button id="loadLocalBtn">Загрузить из localStorage</button>
      </div>
      <textarea id="jsonArea" spellcheck="false"></textarea>
      <div class="note">Правь JSON вручную или используй формы в сайдбаре. При ошибке синтаксиса появится уведомление.</div>
    </section>

    <section id="helpView" class="card hidden">
      <h2>Справка</h2>
      <div class="hr"></div>
      <p>Модель данных:</p>
      <pre style="white-space:pre-wrap;background:#0a101c;border:1px solid #1f2937;padding:10px;border-radius:8px;">
{
  "sections": [
    {
      "id": "realty",
      "name": "Недвижимость",
      "categories": [
        {
          "id": "flat",
          "name": "Квартиры",
          "subcategories": [
            {"id": "sale", "name": "Продажа"},
            {"id": "rent", "name": "Аренда"},
            {"id": "exchange", "name": "Обмен"}
          ]
        }
      ]
    }
  ]
}
      </pre>
      <p class="note">Все операции выполняются в браузере. Данные можно хранить в localStorage или экспортировать в файл.</p>
    </section>
  </main>
</div>

<script>
/** ====== Утилиты ====== */
const $ = sel => document.querySelector(sel);
const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
const uid = () => Math.random().toString(36).slice(2,10);

const DEFAULT_DATA = {
  sections: [
    {
      id: "realty",
      name: "Недвижимость",
      categories: [
        {
          id: "flat",
          name: "Квартиры",
          subcategories: [
            { id: "sale", name: "Продажа" },
            { id: "rent", name: "Аренда" },
            { id: "exchange", name: "Обмен" }
          ]
        },
        {
          id: "house",
          name: "Дома",
          subcategories: [
            { id: "sale", name: "Продажа" },
            { id: "rent", name: "Аренда" }
          ]
        },
        {
          id: "commercial",
          name: "Коммерческая недвижимость",
          subcategories: [
            { id: "office", name: "Офисы" },
            { id: "retail", name: "Торговые" }
          ]
        }
      ]
    },
    {
      id: "auto",
      name: "Авто",
      categories: [
        {
          id: "car",
          name: "Легковые",
          subcategories: [
            { id: "sale", name: "Продажа" },
            { id: "rent", name: "Аренда" }
          ]
        },
        {
          id: "truck",
          name: "Грузовые",
          subcategories: [
            { id: "sale", name: "Продажа" }
          ]
        }
      ]
    }
  ]
};

let data = structuredClone(DEFAULT_DATA);

/** ====== Навигация по вкладкам ====== */
const tabs = { ui: $("#tab-ui"), data: $("#tab-data"), help: $("#tab-help") };
const views = { ui: $("#uiView"), data: $("#dataView"), help: $("#helpView") };

Object.entries(tabs).forEach(([k, btn])=>{
  btn.addEventListener("click", ()=>{
    Object.values(tabs).forEach(b=>b.classList.remove("active"));
    Object.values(views).forEach(v=>v.classList.add("hidden"));
    btn.classList.add("active");
    views[k].classList.remove("hidden");
  });
});

/** ====== DOM ссылки ====== */
const sectionSelect = $("#sectionSelect");
const categorySelect = $("#categorySelect");
const subcategoriesList = $("#subcategoriesList");

const sectionName = $("#sectionName");
const categoryName = $("#categoryName");
const subcategoryName = $("#subcategoryName");

const addSectionBtn = $("#addSectionBtn");
const saveSectionBtn = $("#saveSectionBtn");
const delSectionBtn = $("#delSectionBtn");

const addCategoryBtn = $("#addCategoryBtn");
const saveCategoryBtn = $("#saveCategoryBtn");
const delCategoryBtn = $("#delCategoryBtn");

const addSubcategoryBtn = $("#addSubcategoryBtn");
const saveSubcategoryBtn = $("#saveSubcategoryBtn");
const delSubcategoryBtn = $("#delSubcategoryBtn");

const uiSection = $("#uiSection");
const uiCategory = $("#uiCategory");
const uiSubcategory = $("#uiSubcategory");

const jsonArea = $("#jsonArea");
const fileInput = $("#fileInput");
const importBtn = $("#importBtn");
const exportBtn = $("#exportBtn");
const resetBtn = $("#resetBtn");
const saveLocalBtn = $("#saveLocalBtn");
const loadLocalBtn = $("#loadLocalBtn");

/** ====== Рендер селекторов ====== */
function renderSections(selectEl){
  selectEl.innerHTML = "";
  data.sections.forEach(s=>{
    const opt = el("option", { value: s.id, textContent: s.name });
    selectEl.append(opt);
  });
}

function findSectionById(id){ return data.sections.find(s=>s.id===id); }
function findCategory(sec, id){ return sec?.categories.find(c=>c.id===id); }

function renderCategoriesFor(sectionId, selectEl){
  selectEl.innerHTML = "";
  const s = findSectionById(sectionId);
  (s?.categories||[]).forEach(c=>{
    selectEl.append(el("option",{value:c.id, textContent:c.name}));
  });
}

function renderSubcategoriesFor(sectionId, categoryId, selectEl){
  selectEl.innerHTML = "";
  const s = findSectionById(sectionId);
  const c = findCategory(s, categoryId);
  (c?.subcategories||[]).forEach(sc=>{
    selectEl.append(el("option", { value: sc.id, textContent: sc.name }));
  });
}

function renderSubcategoryList(sectionId, categoryId){
  subcategoriesList.innerHTML = "";
  const s = findSectionById(sectionId);
  const c = findCategory(s, categoryId);
  (c?.subcategories||[]).forEach(sc=>{
    const row = el("div",{className:"list-item"});
    row.append(el("span",{textContent: sc.name, className:"sp"}));
    const edit = el("button",{textContent:"✎", title:"Переименовать"});
    const del = el("button",{textContent:"✕", className:"danger", title:"Удалить"});
    edit.addEventListener("click", ()=>{
      subcategoryName.value = sc.name;
      subcategoryName.dataset.editId = sc.id;
    });
    del.addEventListener("click", ()=>{
      c.subcategories = c.subcategories.filter(x=>x.id!==sc.id);
      syncAfterChange();
    });
    row.append(edit, del);
    subcategoriesList.append(row);
  });
}

/** ====== Синхронизация UI и JSON ====== */
function syncEditorsFromData(){
  jsonArea.value = JSON.stringify(data, null, 2);
  // левый сайдбар
  renderSections(sectionSelect);
  const secId = sectionSelect.value || data.sections[0]?.id;
  sectionSelect.value = secId;
  renderCategoriesFor(secId, categorySelect);
  // список подкатегорий
  const catId = categorySelect.value || findSectionById(secId)?.categories?.[0]?.id;
  categorySelect.value = catId;
  renderSubcategoryList(secId, catId);
  // правый просмотр
  renderSections(uiSection);
  uiSection.value = secId;
  renderCategoriesFor(secId, uiCategory);
  uiCategory.value = catId;
  const firstSub = findCategory(findSectionById(secId), catId)?.subcategories?.[0]?.id || "";
  renderSubcategoriesFor(secId, catId, uiSubcategory);
  uiSubcategory.value = firstSub;
}

function syncAfterChange(){
  syncEditorsFromData();
  saveToLocal();
}

/** ====== Обработчики сайдбара ====== */
addSectionBtn.addEventListener("click", ()=>{
  const nid = uid();
  data.sections.push({ id:nid, name:"Новый раздел", categories:[] });
  sectionSelect.value = nid;
  sectionName.value = "Новый раздел";
  syncAfterChange();
});

saveSectionBtn.addEventListener("click", ()=>{
  const sec = findSectionById(sectionSelect.value);
  if(!sec) return;
  sec.name = sectionName.value.trim() || sec.name;
  syncAfterChange();
});

delSectionBtn.addEventListener("click", ()=>{
  const id = sectionSelect.value;
  if(!id) return;
  data.sections = data.sections.filter(s=>s.id!==id);
  syncAfterChange();
});

addCategoryBtn.addEventListener("click", ()=>{
  const sec = findSectionById(sectionSelect.value);
  if(!sec) return;
  const nid = uid();
  sec.categories = sec.categories||[];
  sec.categories.push({ id:nid, name:"Новая категория", subcategories:[] });
  categorySelect.value = nid;
  categoryName.value = "Новая категория";
  syncAfterChange();
});

saveCategoryBtn.addEventListener("click", ()=>{
  const sec = findSectionById(sectionSelect.value);
  const cat = findCategory(sec, categorySelect.value);
  if(!cat) return;
  cat.name = categoryName.value.trim() || cat.name;
  syncAfterChange();
});

delCategoryBtn.addEventListener("click", ()=>{
  const sec = findSectionById(sectionSelect.value);
  if(!sec) return;
  sec.categories = (sec.categories||[]).filter(c=>c.id!==categorySelect.value);
  syncAfterChange();
});

addSubcategoryBtn.addEventListener("click", ()=>{
  const sec = findSectionById(sectionSelect.value);
  const cat = findCategory(sec, categorySelect.value);
  if(!cat) return;
  const nid = uid();
  cat.subcategories = cat.subcategories||[];
  cat.subcategories.push({ id:nid, name:"Новая подкатегория" });
  subcategoryName.value = "Новая подкатегория";
  subcategoryName.dataset.editId = nid;
  syncAfterChange();
});

saveSubcategoryBtn.addEventListener("click", ()=>{
  const sec = findSectionById(sectionSelect.value);
  const cat = findCategory(sec, categorySelect.value);
  if(!cat) return;
  const id = subcategoryName.dataset.editId;
  const name = subcategoryName.value.trim();
  if(!name) return;
  if(id){
    const sc = (cat.subcategories||[]).find(x=>x.id===id);
    if(sc){ sc.name = name; }
  }else{
    const nid = uid();
    cat.subcategories = cat.subcategories||[];
    cat.subcategories.push({ id:nid, name });
    subcategoryName.dataset.editId = nid;
  }
  syncAfterChange();
});

delSubcategoryBtn.addEventListener("click", ()=>{
  const sec = findSectionById(sectionSelect.value);
  const cat = findCategory(sec, categorySelect.value);
  if(!cat) return;
  const id = subcategoryName.dataset.editId;
  if(!id) return;
  cat.subcategories = (cat.subcategories||[]).filter(x=>x.id!==id);
  subcategoryName.value = "";
  subcategoryName.dataset.editId = "";
  syncAfterChange();
});

sectionSelect.addEventListener("change", ()=>{
  const id = sectionSelect.value;
  renderCategoriesFor(id, categorySelect);
  categoryName.value = "";
  subcategoryName.value = "";
  renderSubcategoryList(id, categorySelect.value);
  // правый просмотр
  uiSection.value = id;
  renderCategoriesFor(id, uiCategory);
  uiCategory.value = uiCategory.options[0]?.value||"";
  renderSubcategoriesFor(id, uiCategory.value, uiSubcategory);
});

categorySelect.addEventListener("change", ()=>{
  renderSubcategoryList(sectionSelect.value, categorySelect.value);
  // правый просмотр
  uiCategory.value = categorySelect.value;
  renderSubcategoriesFor(uiSection.value, uiCategory.value, uiSubcategory);
});

/** ====== Просмотр справа ====== */
uiSection.addEventListener("change", ()=>{
  renderCategoriesFor(uiSection.value, uiCategory);
  uiCategory.value = uiCategory.options[0]?.value||"";
  renderSubcategoriesFor(uiSection.value, uiCategory.value, uiSubcategory);
});
uiCategory.addEventListener("change", ()=>{
  renderSubcategoriesFor(uiSection.value, uiCategory.value, uiSubcategory);
});

/** ====== Импорт/Экспорт/LocalStorage ====== */
function download(filename, text){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

importBtn.addEventListener("click", async ()=>{
  const file = fileInput.files?.[0];
  if(!file){ alert("Выберите JSON файл"); return; }
  try{
    const txt = await file.text();
    const json = JSON.parse(txt);
    if(!json.sections) throw new Error("Отсутствует ключ 'sections'");
    data = json;
    syncAfterChange();
    alert("Импорт успешно завершён");
  }catch(e){
    alert("Ошибка импорта: " + e.message);
  }
});

exportBtn.addEventListener("click", ()=>{
  try{
    // если пользователь правил textarea вручную — применим
    const parsed = JSON.parse(jsonArea.value);
    data = parsed;
    syncEditorsFromData();
  }catch(e){
    // если JSON невалиден, не затираем data, просто даём скачать текущее
  }
  download("filter-data.json", JSON.stringify(data, null, 2));
});

resetBtn.addEventListener("click", ()=>{
  if(!confirm("Сбросить к дефолту?")) return;
  data = structuredClone(DEFAULT_DATA);
  syncAfterChange();
});

function saveToLocal(){
  localStorage.setItem("filter_v39_29R", JSON.stringify(data));
}
function loadFromLocal(){
  const raw = localStorage.getItem("filter_v39_29R");
  if(!raw) return false;
  try{
    const json = JSON.parse(raw);
    if(json?.sections){ data = json; return true; }
  }catch{}
  return false;
}

saveLocalBtn.addEventListener("click", ()=>{
  saveToLocal();
  alert("Сохранено в localStorage");
});
loadLocalBtn.addEventListener("click", ()=>{
  if(loadFromLocal()){ syncEditorsFromData(); alert("Загружено из localStorage"); }
  else alert("В localStorage нет сохранённых данных");
});

/** ====== Инициализация ====== */
(function init(){
  loadFromLocal(); // если есть локальные — используем их
  syncEditorsFromData();
})();
</script>
</body>
</html>
