<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>filter_v08R — редактор фильтров (карточки)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#0f172a;--panel:#111827;--line:#1f2937;--text:#e5e7eb;--ok:#22c55e;--err:#ef4444;--warn:#f59e0b}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--line);background:#0b1220;position:sticky;top:0;z-index:10}
  .left, .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#0b1220;font-size:12px}
  main{padding:12px;max-width:1100px;margin:0 auto}
  button{padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#1f2937;color:var(--text);cursor:pointer}
  button.primary{background:var(--ok);color:#052e16}
  button.danger{background:var(--err);color:#3b0a0a}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0;box-shadow:0 0 0 1px rgba(0,0,0,.05) inset}
  .card h3{margin:0 0 6px 0;display:flex;gap:10px;align-items:center}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
  label{display:block;font-size:12px;opacity:.9;margin-bottom:4px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid var(--line);background:#0b1220;color:var(--text);font:inherit}
  textarea{min-height:80px}
  .mini{font-size:12px;opacity:.75}
  .ghost{opacity:.7}
  .top-actions{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
  <header>
    <div class="left">
      <strong>Редактор фильтров</strong>
      <span class="badge">v08R</span>
      <span id="sizeBadge" class="badge">Размер: …</span>
    </div>
    <div class="right top-actions">
      <input type="file" id="fileInput" accept=".json,application/json" style="display:none">
      <button id="importBtn">Импорт</button>
      <button id="exportBtn" class="primary">Экспорт</button>
      <button id="addBtn">+ Фильтр</button>
      <button id="clearBtn" class="danger">Очистить</button>
    </div>
  </header>

  <main>
    <div id="list"></div>
  </main>

<script>
// ===== helpers =====
const $=s=>document.querySelector(s);
const el=(t,p={})=>Object.assign(document.createElement(t),p);
const uid=()=>Math.random().toString(36).slice(2,9);
const clone=o=>JSON.parse(JSON.stringify(o));

// ===== storage =====
const LS_KEY="filter_v08R_data";
let data={filters:[]};

function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw) data=JSON.parse(raw); }catch{} }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)); updateSize(); }

// ===== rendering =====
const listEl=$("#list");

function render(){
  listEl.innerHTML="";
  // parent options depend on existing filters
  const parentOptions=(currentId=null)=>{
    // cannot choose self or descendants
    const invalid=new Set();
    if(currentId){
      invalid.add(currentId);
      (function markChildren(id){
        data.filters.filter(f=>f.parentId===id).forEach(ch=>{invalid.add(ch.id);markChildren(ch.id)});
      })(currentId);
    }
    const opts=[{id:"", name:"(нет)"}].concat(
      data.filters.filter(f=>!invalid.has(f.id)).map(f=>({id:f.id,name:`${f.title||f.name||f.id} (${f.name||""})`}))
    );
    return opts;
  };

  data.filters.forEach(f=>{
    const c=el("div",{className:"card"});
    const h=el("h3");
    h.append(
      el("span",{textContent:f.title||"Без заголовка"}),
      el("span",{className:"mini ghost",textContent:`(${f.name||f.id})`})
    );
    const delBtn=el("button",{className:"danger",textContent:"Удалить"});
    delBtn.onclick=()=>{ if(!confirm("Удалить фильтр?")) return; removeFilter(f.id); };
    h.append(el("span",{className:"sp"}), delBtn);
    c.appendChild(h);

    // row 1: title, name
    const r1=el("div",{className:"row"});
    r1.append(
      wrap("Заголовок", el("input",{value:f.title||"", oninput:e=>{f.title=e.target.value; save(); h.firstChild.textContent=f.title||"Без заголовка";}})),
      wrap("Имя (ключ)", el("input",{value:f.name||"", oninput:e=>{f.name=e.target.value; h.children[1].textContent=`(${f.name||f.id})`; save();}}))
    );
    c.appendChild(r1);

    // row 2: type, hint
    const r2=el("div",{className:"row"});
    const typeSelect=el("select",{onchange:e=>{f.type=e.target.value; save();}});
    ["text","number","select","checkbox","date"].forEach(t=>{
      typeSelect.append(el("option",{value:t,textContent:t,selected:f.type===t}));
    });
    r2.append(
      wrap("Тип", typeSelect),
      wrap("Описание", el("input",{placeholder:"подпись/подсказка", value:f.hint||"", oninput:e=>{f.hint=e.target.value; save();}}))
    );
    c.appendChild(r2);

    // row 3: parent, condition
    const r3=el("div",{className:"row"});
    const pSel=el("select",{onchange:e=>{ f.parentId=e.target.value||null; save(); render(); }});
    parentOptions(f.id).forEach(o=> pSel.append(el("option",{value:o.id, textContent:o.name, selected:(f.parentId||"")===(o.id||"")})) );
    r3.append(
      wrap("Родитель (для каскада)", pSel),
      wrap("Условие отображения (ключ=значение или ключ=знач1|знач2)", el("input",{
        placeholder:"например: category=Квартира|Дом|Коммерция",
        value:f.showIf||"",
        oninput:e=>{f.showIf=e.target.value; save();}
      }))
    );
    c.appendChild(r3);

    // row 4: options and map
    const r4=el("div",{className:"row"});
    r4.append(
      wrap("Опции (через запятую) — для select", el("textarea",{value:(f.options||[]).join(", "), oninput:e=>{
        f.options=e.target.value.split(",").map(x=>x.trim()).filter(Boolean); save();
      }})),
      wrap("Карта опций (parent=опция1, опция2) — для каскада", el("textarea",{value:mapToText(f.map||{}), oninput:e=>{
        f.map=textToMap(e.target.value); save();
      }}))
    );
    c.appendChild(r4);

    // row 5: id and move controls
    const r5=el("div",{className:"row"});
    r5.append(
      wrap("ID (служебный, менять осторожно)", el("input",{value:f.id, oninput:e=>{f.id=e.target.value.trim(); save(); render();}})),
      wrap("Порядок (число, меньше — выше)", el("input",{type:"number",value:Number.isFinite(f.order)?f.order:0, oninput:e=>{f.order=+e.target.value||0; save(); render();}}))
    );
    c.appendChild(r5);

    listEl.appendChild(c);
  });

  // Add button at bottom
  const addBottom=el("div",{style:"display:flex;justify-content:flex-start;margin:12px 0"});
  const addBtn=el("button",{textContent:"+ Фильтр"});
  addBtn.onclick=addFilter;
  addBottom.append(addBtn);
  listEl.append(addBottom);
}

function wrap(labelText, control){
  const w=el("div");
  const lb=el("label",{textContent:labelText});
  w.append(lb, control);
  return w;
}

// map helpers
function mapToText(mapObj){
  return Object.entries(mapObj).map(([k,arr])=>`${k}=${Array.isArray(arr)?arr.join(", "):""}`).join("\n");
}
function textToMap(text){
  const out={};
  text.split(/\n+/).map(l=>l.trim()).filter(Boolean).forEach(line=>{
    const [k,v]=""+line.includes("=")?line.split("="):[line,""];
    const items = (v||"").split(",").map(x=>x.trim()).filter(Boolean);
    if(k) out[k.trim()]=items;
  });
  return out;
}

// data ops
function addFilter(){
  const id=uid();
  data.filters.push({id, name:"", title:"Новый фильтр", type:"text", hint:"", parentId:null, options:[], map:{}, showIf:"", order:data.filters.length});
  save(); render();
}
function removeFilter(id){
  // remove children recursively
  function rm(fid){
    data.filters.filter(f=>f.parentId===fid).forEach(ch=>rm(ch.id));
    data.filters = data.filters.filter(f=>f.id!==fid);
  }
  rm(id);
  save(); render();
}

// sorting by order then title
function sortData(){
  data.filters.sort((a,b)=>{
    const ao=Number.isFinite(a.order)?a.order:0;
    const bo=Number.isFinite(b.order)?b.order:0;
    if(ao!==bo) return ao-bo;
    return (a.title||"").localeCompare(b.title||"");
  });
}

// header size
function updateSize(){
  try{
    const bytes = new Blob([document.documentElement.outerHTML]).size;
    const kb = (bytes/1024).toFixed(1);
    $("#sizeBadge").textContent = `Размер: ${kb} КБ`;
  }catch{ $("#sizeBadge").textContent = "Размер: неизвестно"; }
}

// import/export
$("#importBtn").onclick=()=>$("#fileInput").click();
$("#fileInput").onchange=async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const txt=await f.text(); const json=JSON.parse(txt);
    if(Array.isArray(json.filters)) data=json; else if(Array.isArray(json.items)) data={filters:json.items}; else throw new Error("Ожидается {filters:[...] }");
    sortData(); save(); render(); alert("Импортировано");
  }catch(err){ alert("Ошибка импорта: "+err.message); }
};
$("#exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=el("a",{href:URL.createObjectURL(blob),download:"filters_v08R.json"});
  document.body.appendChild(a); a.click(); a.remove();
};
$("#addBtn").onclick=addFilter;
$("#clearBtn").onclick=()=>{ if(confirm("Очистить все фильтры?")){ data={filters:[]}; save(); render(); }};

// init
(function init(){
  load();
  if(!data.filters.length){
    data.filters = [
      {id:"country", name:"country", title:"Страна", type:"select", hint:"подпись/подсказка", parentId:null, options:["Узбекистан"], map:{}, showIf:"", order:0},
      {id:"city", name:"city", title:"Город", type:"select", hint:"подпись/подсказка", parentId:"country", options:[], map:{"Узбекистан":["Ташкент","Самарканд"]}, showIf:"", order:1}
    ];
  }
  sortData();
  render();
  updateSize();
})();
</script>
</body>
</html>
