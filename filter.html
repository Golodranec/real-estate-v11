<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>filters_admin_v15R_fix1 — редактор с перетаскиванием</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#0f172a;--panel:#111827;--line:#1f2937;--text:#e5e7eb;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;height:100vh;display:flex;flex-direction:column}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--line);background:#0b1220;position:sticky;top:0;z-index:10}
  .left,.right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#0b1220;font-size:12px}
  nav.tabs{display:flex;gap:8px;padding:8px;background:#111827;border-bottom:1px solid var(--line)}
  nav.tabs button{padding:8px 12px;border-radius:6px;border:1px solid var(--line);background:#1f2937;color:var(--text);cursor:pointer}
  nav.tabs button.active{background:var(--ok);color:#052e16}
  main{flex:1;overflow:auto;padding:12px;max-width:1100px;margin:0 auto;width:100%}
  button{padding:6px 10px;border-radius:6px;border:1px solid var(--line);background:#1f2937;color:var(--text);cursor:pointer}
  button.primary{background:var(--ok);color:#052e16}
  button.danger{background:var(--err);color:#3b0a0a}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0;cursor:grab}
  .card.dragging{opacity:0.5}
  .card h3{margin:0 0 6px 0;display:flex;gap:10px;align-items:center}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
  label{display:block;font-size:12px;opacity:.9;margin-bottom:4px}
  input,select,textarea{width:100%;padding:6px;border-radius:6px;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;font:inherit}
  textarea{min-height:60px}
  .mini{font-size:12px;opacity:.75}
  .ghost{opacity:.7}
  .top-actions{display:flex;gap:8px;align-items:center}
  .hidden{display:none}
  .preview-form{display:flex;flex-direction:column;gap:12px}
</style>
</head>
<body>
  <header>
    <div class="left">
      <strong>Фильтры</strong>
      <span class="badge">v15R-fix1</span>
      <span id="sizeBadge" class="badge">Размер: …</span>
    </div>
    <div class="right top-actions">
      <input type="file" id="fileInput" accept=".json,application/json" style="display:none">
      <button id="importBtn">Импорт</button>
      <button id="exportBtn" class="primary">Экспорт</button>
      <button id="addBtn">+ Фильтр</button>
      <button id="clearBtn" class="danger">Очистить</button>
    </div>
  </header>

  <nav class="tabs">
    <button id="tab-editor" class="active">Редактор</button>
    <button id="tab-preview">Предпросмотр</button>
  </nav>

  <main>
    <section id="editorSection">
      <div id="list"></div>
    </section>

    <section id="previewSection" class="hidden">
      <div style="margin-bottom:12px">
        <label>Раздел:
          <select id="sectionSelect"></select>
        </label>
      </div>
      <form id="previewForm" class="preview-form"></form>
    </section>
  </main>

<script>
const $=s=>document.querySelector(s);
const el=(t,p={})=>Object.assign(document.createElement(t),p);
const uid=()=>Math.random().toString(36).slice(2,9);

const LS_KEY="filters_admin_v15R_fix1_data";
let data={filters:[]};
function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw) data=JSON.parse(raw); }catch{} }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)); updateSize(); }

const listEl=$("#list");
let dragSrcId=null;

function renderEditor(){
  listEl.innerHTML="";
  const parentOptions=(currentId=null)=>{
    const invalid=new Set();
    if(currentId){
      invalid.add(currentId);
      (function markChildren(id){
        data.filters.filter(f=>f.parentId===id).forEach(ch=>{invalid.add(ch.id);markChildren(ch.id)});
      })(currentId);
    }
    const opts=[{id:"", name:"(нет)"}].concat(
      data.filters.filter(f=>!invalid.has(f.id)).map(f=>({id:f.id,name:`${f.title||f.name||f.id}`}))
    );
    return opts;
  };

  data.filters.forEach((f, idx)=>{
    const c=el("div",{className:"card",draggable:true});
    c.dataset.id=f.id;

    c.ondragstart=(e)=>{
      dragSrcId=f.id;
      c.classList.add("dragging");
      e.dataTransfer.effectAllowed="move";
    };
    c.ondragend=()=>{c.classList.remove("dragging");};
    c.ondragover=(e)=>{e.preventDefault();};
    c.ondrop=(e)=>{
      e.preventDefault();
      const srcIndex=data.filters.findIndex(x=>x.id===dragSrcId);
      const targetIndex=idx;
      if(srcIndex>=0 && targetIndex>=0 && srcIndex!==targetIndex){
        const moved=data.filters.splice(srcIndex,1)[0];
        data.filters.splice(targetIndex,0,moved);
        save();
        renderEditor();
        renderPreview();
      }
    };

    const h=el("h3");
    h.append(el("span",{textContent:f.title||"Без заголовка"}), el("span",{className:"mini ghost",textContent:`(${f.name||f.id})`}));
    const delBtn=el("button",{className:"danger",textContent:"Удалить"});
    delBtn.onclick=()=>{ if(confirm("Удалить фильтр?")) removeFilter(f.id); };
    h.append(el("span",{className:"sp"}), delBtn);
    c.appendChild(h);

    const r1=el("div",{className:"row"});
    r1.append(wrap("Заголовок", el("input",{value:f.title||"", oninput:e=>{f.title=e.target.value; save();}})),
               wrap("Имя (ключ)", el("input",{value:f.name||"", oninput:e=>{f.name=e.target.value; save();}})));
    c.appendChild(r1);

    const r2=el("div",{className:"row"});
    const typeSel=el("select",{onchange:e=>{f.type=e.target.value; save(); renderEditor();}});
    ["section","text","number","select","checkbox","date"].forEach(t=> typeSel.append(el("option",{value:t,textContent:t,selected:f.type===t})));
    r2.append(wrap("Тип",typeSel),
              wrap("Описание",el("input",{value:f.hint||"", oninput:e=>{f.hint=e.target.value; save();}})));
    c.appendChild(r2);

    const r3=el("div",{className:"row"});
    const pSel=el("select",{onchange:e=>{f.parentId=e.target.value||null; save(); renderEditor();}});
    parentOptions(f.id).forEach(o=> pSel.append(el("option",{value:o.id,textContent:o.name,selected:(f.parentId||"")===(o.id||"")})));
    r3.append(wrap("Родитель",pSel),
              wrap("Условие отображения",el("input",{value:f.showIf||"",placeholder:"ключ=значение|знач2", oninput:e=>{f.showIf=e.target.value; save();}})));
    c.appendChild(r3);

    const r4=el("div",{className:"row"});
    r4.append(wrap("Опции (для select)",el("textarea",{value:(f.options||[]).join(', '), oninput:e=>{f.options=e.target.value.split(',').map(x=>x.trim()).filter(Boolean); save();}})),
              wrap("Карта опций",el("textarea",{value:mapToText(f.map||{}), oninput:e=>{f.map=textToMap(e.target.value); save();}})));
    c.appendChild(r4);

    listEl.appendChild(c);
  });

  const addBtn=el("button",{textContent:"+ Фильтр"});
  addBtn.onclick=addFilter;
  listEl.appendChild(addBtn);
}
function wrap(label,control){const w=el("div");w.append(el("label",{textContent:label}),control);return w;}
function mapToText(mapObj){return Object.entries(mapObj).map(([k,arr])=>`${k}=${arr.join(',')}`).join("\n");}
function textToMap(txt){const out={};txt.split(/\n/).forEach(l=>{const [k,v]=l.split('=');if(k) out[k.trim()]=(v||'').split(',').map(x=>x.trim()).filter(Boolean)});return out;}
function addFilter(){data.filters.push({id:uid(),title:"Новый фильтр",name:"",type:"text",hint:"",parentId:null,options:[],map:{},showIf:""}); save(); renderEditor();}
function removeFilter(id){function rm(fid){data.filters.filter(f=>f.parentId===fid).forEach(ch=>rm(ch.id));data.filters=data.filters.filter(f=>f.id!==fid);}rm(id);save();renderEditor();}

// ===== preview =====
let currentSectionId=null;
let previewValues={};

function sectionList(){ return data.filters.filter(f=>f.type==="section"); }
function childrenOf(pid){ return data.filters.filter(f=>f.parentId===pid && f.type!=="section"); }
function descendantsOf(pid){ const res=[]; const stack=[pid]; while(stack.length){ const id=stack.pop(); const kids=childrenOf(id); kids.forEach(k=>{res.push(k); stack.push(k.id);}); } return res; }

function optionsFor(f){
  let opts = Array.isArray(f.options)?f.options.slice():[];
  if(f.parentId){
    const p = data.filters.find(x=>x.id===f.parentId);
    const pKey = p?.name || p?.id;
    const pVal = previewValues[pKey];
    if(f.map && pVal && f.map[pVal]) opts = f.map[pVal].slice();
  }
  return opts;
}
function visibleByCondition(f){
  if(!f.showIf) return true;
  const [k,v] = f.showIf.split("=");
  if(!k || v===undefined) return true;
  const allowed = v.split("|").map(s=>s.trim());
  return allowed.includes(String(previewValues[k] ?? ""));
}

function renderPreview(){
  const secSel=$("#sectionSelect");
  const secs=sectionList();
  secSel.innerHTML="";
  secs.forEach(s=>secSel.append(el("option",{value:s.id,textContent:s.title||s.name||s.id})));
  if(!secs.length){ $("#previewForm").innerHTML=""; return; }
  if(!currentSectionId || !secs.some(s=>s.id===currentSectionId)) currentSectionId=secs[0].id;
  secSel.value=currentSectionId;

  const form=$("#previewForm");
  form.innerHTML="";
  const list = descendantsOf(currentSectionId);

  list.forEach(f=>{
    if(!visibleByCondition(f)) return;
    let control;
    if(f.type==="select"){
      control = el("select");
      const opts = optionsFor(f);
      control.append(el("option",{value:"",textContent:"—"}));
      opts.forEach(o=>control.append(el("option",{value:o,textContent:o})));
      const key=f.name||f.id;
      if(previewValues[key] && opts.includes(previewValues[key])) control.value=previewValues[key];
    }else if(f.type==="number"||f.type==="date"||f.type==="text"){
      control = el("input",{type: f.type==="number"?"number":f.type==="date"?"date":"text"});
      const key=f.name||f.id; if(previewValues[key]!=null) control.value=previewValues[key];
    }else if(f.type==="checkbox"){
      control = el("input",{type:"checkbox"});
      const key=f.name||f.id; control.checked = !!previewValues[key];
    }else return;

    control.onchange = ()=>{
      const key=f.name||f.id;
      const val = (control.type==="checkbox") ? control.checked : control.value;
      previewValues[key]=val;
      descendantsOf(f.id).forEach(d=>{ const dk=d.name||d.id; delete previewValues[dk]; });
      if(f.type==="select"){
        const opts = optionsFor(f);
        if(val && !opts.includes(val)){ previewValues[key]=""; }
      }
      renderPreview();
    };

    const wrapDiv=el("div");
    wrapDiv.append(el("label",{textContent:f.title||f.name||f.id}), control);
    form.appendChild(wrapDiv);
  });

  secSel.onchange = ()=>{ currentSectionId = secSel.value; previewValues={}; renderPreview(); };
}

// ===== import/export and tabs =====
$("#importBtn").onclick=()=>$("#fileInput").click();
$("#fileInput").onchange=async e=>{const f=e.target.files?.[0];if(!f) return;try{const txt=await f.text();const json=JSON.parse(txt);if(Array.isArray(json.filters)) data=json; else if(Array.isArray(json.items)) data={filters:json.items};save();renderEditor();currentSectionId=null;previewValues={};renderPreview();alert("Импортировано");}catch(err){alert("Ошибка: "+err.message);}};
$("#exportBtn").onclick=()=>{const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});const a=el("a",{href:URL.createObjectURL(blob),download:"filters_admin_v15R_fix1.json"});document.body.appendChild(a);a.click();a.remove();};
$("#addBtn").onclick=addFilter;
$("#clearBtn").onclick=()=>{if(confirm("Очистить все?")){data={filters:[]};save();renderEditor();currentSectionId=null;previewValues={};renderPreview();}};
$("#tab-editor").onclick=()=>{activate("editor");};
$("#tab-preview").onclick=()=>{activate("preview");};

function activate(tab){$("#tab-editor").classList.remove("active");$("#tab-preview").classList.remove("active");$("#editorSection").classList.add("hidden");$("#previewSection").classList.add("hidden");if(tab==="editor"){$("#tab-editor").classList.add("active");$("#editorSection").classList.remove("hidden");}else{$("#tab-preview").classList.add("active");$("#previewSection").classList.remove("hidden");renderPreview();}}

function updateSize(){try{const bytes=new Blob([document.documentElement.outerHTML]).size;$("#sizeBadge").textContent=`Размер: ${(bytes/1024).toFixed(1)} КБ`;}catch{$("#sizeBadge").textContent="Размер: ?";}}

(function init(){load();if(!data.filters.length){data.filters=[
  {id:"realty",name:"realty",title:"Недвижимость",type:"section"},
  {id:"auto",name:"auto",title:"Авто",type:"section"},
  {id:"city",name:"city",title:"Город",type:"select",parentId:"realty",options:["Ташкент","Самарканд"]},
  {id:"price",name:"price",title:"Цена",type:"number",parentId:"realty"},
  {id:"brand",name:"brand",title:"Марка авто",type:"select",parentId:"auto",options:["Chevrolet","Hyundai"]},
  {id:"year",name:"year",title:"Год выпуска",type:"number",parentId:"auto"}
];}renderEditor();updateSize();})();
</script>
</body>
</html>
