<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Fields Preview v01R</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{margin:0;font-family:sans-serif;background:#0f172a;color:#e5e7eb}
  nav{display:flex;gap:8px;padding:8px;background:#1f2937}
  nav button{padding:6px 10px;border:none;border-radius:6px;background:#374151;color:#e5e7eb;cursor:pointer}
  nav button.active{background:#22c55e;color:#052e16}
  section{padding:12px}
  .editor,.card{background:#111827;padding:12px;border-radius:8px;margin-bottom:12px}
  input,select,textarea,button{font:inherit}
  input,select{padding:6px;border-radius:6px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  button{padding:6px 10px;border-radius:6px;border:1px solid #374151;background:#1f2937;color:#e5e7eb;cursor:pointer}
  button.primary{background:#22c55e;color:#052e16}
  button.danger{background:#ef4444;color:#3b0a0a}
  textarea{width:100%;height:220px;background:#0b1220;color:#e5e7eb;border:1px solid #374151;border-radius:6px;padding:8px;font-family:monospace;font-size:13px}
  .row{display:flex;gap:8px;margin:6px 0}
  .sp{flex:1}
</style>
</head>
<body>
  <nav>
    <button id="tab-fields" class="active">Поля</button>
    <button id="tab-json">JSON</button>
    <button id="tab-preview">Предпросмотр</button>
  </nav>

  <section id="view-fields">
    <div class="editor">
      <h2>Редактор полей</h2>
      <label>Название <input id="name"></label>
      <label>Тип поля
        <select id="fieldType">
          <option value="text">Текст</option>
          <option value="number">Число</option>
          <option value="select">Список</option>
        </select>
      </label>
      <label>Родитель
        <select id="parent"></select>
      </label>
      <div class="row">
        <button class="primary" id="saveBtn">Сохранить</button>
        <button class="danger" id="delBtn">Удалить</button>
        <button id="addBtn">Добавить</button>
      </div>
    </div>
    <ul id="list"></ul>
  </section>

  <section id="view-json" class="hidden">
    <div class="card">
      <h2>JSON</h2>
      <div class="row">
        <button id="exportBtn" class="primary">Экспорт</button>
        <button id="resetBtn" class="danger">Сброс</button>
      </div>
      <textarea id="jsonArea"></textarea>
    </div>
  </section>

  <section id="view-preview" class="hidden">
    <div class="card">
      <h2>Предпросмотр</h2>
      <div id="preview"></div>
    </div>
  </section>

<script>
const $=s=>document.querySelector(s);
const el=(t,p={})=>Object.assign(document.createElement(t),p);
const uid=()=>Math.random().toString(36).slice(2,9);
let data={items:[]};
let selectedId=null;

/* Storage */
function load(){try{const raw=localStorage.getItem("fields_v01R");if(raw)data=JSON.parse(raw)}catch{}}
function save(){localStorage.setItem("fields_v01R",JSON.stringify(data))}

/* Render list */
function renderList(){
  list.innerHTML="";
  data.items.forEach(it=>{
    const li=el("li");
    const span=el("span",{textContent:`${it.name} (${it.fieldType})`});
    if(it.id===selectedId)span.style.color="#22c55e";
    span.onclick=()=>select(it.id);
    li.appendChild(span);
    list.appendChild(li);
  });
  jsonArea.value=JSON.stringify(data,null,2);
  renderParentOptions();
  renderPreview();
}
function renderParentOptions(){
  parent.innerHTML="<option value=''>Нет</option>";
  data.items.forEach(it=>{if(it.id!==selectedId)parent.appendChild(el("option",{value:it.id,textContent:it.name}))})
}
function select(id){selectedId=id;const it=data.items.find(x=>x.id===id);if(!it)return;name.value=it.name;fieldType.value=it.fieldType;parent.value=it.parentId||"";renderList()}

/* Buttons */
addBtn.onclick=()=>{const id=uid();data.items.push({id,name:"Новое поле",fieldType:"text",parentId:null});select(id);save();renderList()}
saveBtn.onclick=()=>{if(!selectedId)return;const it=data.items.find(x=>x.id===selectedId);it.name=name.value;it.fieldType=fieldType.value;it.parentId=parent.value||null;save();renderList()}
delBtn.onclick=()=>{if(!selectedId)return;data.items=data.items.filter(x=>x.id!==selectedId);selectedId=null;save();renderList()}
exportBtn.onclick=()=>{const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});const a=el("a",{href:URL.createObjectURL(blob),download:"fields.json"});a.click()}
resetBtn.onclick=()=>{if(confirm("Очистить?")){data={items:[]};selectedId=null;save();renderList()}}

/* Preview */
function renderPreview(){
  preview.innerHTML="";
  data.items.forEach(f=>{
    const row=el("div",{className:"row"});
    row.appendChild(el("label",{className:"sp",textContent:f.name}));
    let inp;if(f.fieldType==="number")inp=el("input",{type:"number"});else if(f.fieldType==="select")inp=el("select");else inp=el("input",{type:"text"});
    row.appendChild(inp);
    preview.appendChild(row);
  });
}

/* Tabs */
function activate(tab){tabFields.classList.remove("active");tabJson.classList.remove("active");tabPreview.classList.remove("active");viewFields.classList.add("hidden");viewJson.classList.add("hidden");viewPreview.classList.add("hidden");if(tab==="fields"){tabFields.classList.add("active");viewFields.classList.remove("hidden")}if(tab==="json"){tabJson.classList.add("active");viewJson.classList.remove("hidden")}if(tab==="preview"){tabPreview.classList.add("active");viewPreview.classList.remove("hidden")}}
tabFields.onclick=()=>activate("fields");tabJson.onclick=()=>activate("json");tabPreview.onclick=()=>activate("preview");

/* Init */
load();renderList();
</script>
</body>
</html>
