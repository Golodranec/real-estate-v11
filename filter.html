<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Фильтр v01R с предпросмотром</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{margin:0;font-family:sans-serif;background:#0f172a;color:#e5e7eb;display:flex;height:100vh}
  aside{width:300px;background:#111827;border-right:1px solid #1f2937;overflow:auto;padding:10px}
  main{flex:1;display:flex;flex-direction:column;padding:12px;overflow:auto}
  h1{margin:0;font-size:16px;padding:10px;background:#1f2937}
  ul{list-style:none;padding-left:20px}
  li{margin:4px 0;cursor:pointer}
  li span{padding:2px 4px;border-radius:4px}
  li span.active{background:#22c55e;color:#052e16}
  .editor{background:#111827;padding:12px;border-radius:8px;display:flex;flex-direction:column;gap:8px;max-width:500px;margin-bottom:20px}
  input,select{padding:6px;border-radius:6px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb}
  button{padding:6px 10px;border-radius:6px;border:1px solid #1f2937;background:#1f2937;color:#e5e7eb;cursor:pointer}
  button.primary{background:#22c55e;color:#052e16}
  button.danger{background:#ef4444;color:#3b0a0a}
  textarea{width:100%;height:200px;background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;border-radius:6px;padding:8px;font-family:monospace;font-size:13px}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .sp{flex:1}
  nav{display:flex;gap:6px;margin-bottom:10px}
  nav button.active{background:#22c55e;color:#052e16}
  .hidden{display:none}
  .card{background:#111827;padding:12px;border-radius:8px;margin-bottom:16px}
</style>
</head>
<body>
  <aside>
    <h1>Элементы</h1>
    <button id="addBtn">Добавить</button>
    <ul id="tree"></ul>
  </aside>
  <main>
    <nav>
      <button id="tab-tree" class="active">Tree</button>
      <button id="tab-json">JSON</button>
      <button id="tab-preview">Preview</button>
    </nav>

    <section id="view-tree">
      <div class="editor">
        <h2>Редактор</h2>
        <label>Название <input id="name"></label>
        <label>Тип
          <select id="type">
            <option value="section">Раздел</option>
            <option value="category">Категория</option>
            <option value="subcategory">Подкатегория</option>
            <option value="field">Поле</option>
          </select>
        </label>
        <label>Родитель
          <select id="parent"></select>
        </label>
        <label id="fieldTypeRow" style="display:none;">Тип поля
          <select id="fieldType">
            <option value="text">Текст</option>
            <option value="number">Число</option>
            <option value="select">Список</option>
          </select>
        </label>
        <div class="row">
          <button class="primary" id="saveBtn">Сохранить</button>
          <button class="danger" id="delBtn">Удалить</button>
        </div>
      </div>
    </section>

    <section id="view-json" class="hidden">
      <h2>JSON</h2>
      <div class="row">
        <button id="exportBtn" class="primary">Экспорт</button>
        <button id="importBtn">Импорт</button>
        <button id="resetBtn" class="danger">Сброс</button>
        <span class="sp"></span>
        <button id="saveLocalBtn">Сохранить LS</button>
        <button id="loadLocalBtn">Загрузить LS</button>
      </div>
      <textarea id="jsonArea"></textarea>
    </section>

    <section id="view-preview" class="hidden">
      <div class="card">
        <h2>Предпросмотр фильтра</h2>
        <div class="row">
          <label class="sp">Раздел <select id="prevSection" class="sp"></select></label>
          <label class="sp">Категория <select id="prevCategory" class="sp"></select></label>
          <label class="sp">Подкатегория <select id="prevSubcategory" class="sp"></select></label>
        </div>
        <div id="fields"></div>
      </div>
    </section>
  </main>

<script>
const treeEl=document.getElementById("tree");
const nameEl=document.getElementById("name");
const typeEl=document.getElementById("type");
const parentEl=document.getElementById("parent");
const fieldTypeRow=document.getElementById("fieldTypeRow");
const fieldTypeEl=document.getElementById("fieldType");
const jsonArea=document.getElementById("jsonArea");

const prevSection=document.getElementById("prevSection");
const prevCategory=document.getElementById("prevCategory");
const prevSubcategory=document.getElementById("prevSubcategory");
const fieldsEl=document.getElementById("fields");

let data={items:[
  {id:"realty",name:"Недвижимость",parentId:null,type:"section"},
  {id:"flat",name:"Квартиры",parentId:"realty",type:"category"},
  {id:"rent",name:"Аренда",parentId:"flat",type:"subcategory"},
  {id:"price",name:"Цена",parentId:null,type:"field",fieldType:"number"},
  {id:"floor",name:"Этаж",parentId:"flat",type:"field",fieldType:"number"}
]};

let selectedId=null;
function uid(){return Math.random().toString(36).slice(2,9)}

function renderTree(){
  treeEl.innerHTML="";
  function build(parentId,ul){
    data.items.filter(it=>it.parentId===parentId).forEach(it=>{
      const li=document.createElement("li");
      const span=document.createElement("span");
      span.textContent=it.name+" ["+it.type+"]";
      if(it.id===selectedId) span.classList.add("active");
      span.onclick=()=>{select(it.id)};
      li.appendChild(span);
      const childUl=document.createElement("ul");
      build(it.id,childUl);
      li.appendChild(childUl);
      ul.appendChild(li);
    });
  }
  build(null,treeEl);
  jsonArea.value=JSON.stringify(data,null,2);
  renderParentOptions();
  renderPreview();
}

function renderParentOptions(){
  parentEl.innerHTML="<option value=''>Нет</option>";
  data.items.forEach(it=>{
    const opt=document.createElement("option");
    opt.value=it.id; opt.textContent=it.name+" ["+it.type+"]";
    parentEl.appendChild(opt);
  });
}

function select(id){
  selectedId=id;
  const it=data.items.find(x=>x.id===id);
  if(!it) return;
  nameEl.value=it.name;
  typeEl.value=it.type;
  parentEl.value=it.parentId||"";
  if(it.type==="field"){fieldTypeRow.style.display="block";fieldTypeEl.value=it.fieldType||"text";}
  else fieldTypeRow.style.display="none";
  renderTree();
}

document.getElementById("addBtn").onclick=()=>{
  const id=uid();
  data.items.push({id,name:"Новый",parentId:null,type:"section"});
  select(id);
  renderTree();
};
document.getElementById("saveBtn").onclick=()=>{
  if(!selectedId) return;
  const it=data.items.find(x=>x.id===selectedId);
  it.name=nameEl.value;
  it.type=typeEl.value;
  it.parentId=parentEl.value||null;
  if(it.type==="field"){it.fieldType=fieldTypeEl.value;fieldTypeRow.style.display="block";}
  else{delete it.fieldType;fieldTypeRow.style.display="none";}
  renderTree();
};
document.getElementById("delBtn").onclick=()=>{
  if(!selectedId) return;
  const removeRec=id=>{
    data.items.filter(x=>x.parentId===id).forEach(ch=>removeRec(ch.id));
    data.items=data.items.filter(x=>x.id!==id);
  };
  removeRec(selectedId);
  selectedId=null;
  renderTree();
};
typeEl.onchange=()=>{
  if(typeEl.value==="field") fieldTypeRow.style.display="block"; else fieldTypeRow.style.display="none";
};

// JSON buttons
document.getElementById("exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="filter-data.json";a.click();
};
document.getElementById("importBtn").onclick=()=>{
  try{const json=JSON.parse(jsonArea.value);if(json.items){data=json;renderTree();}}catch(e){alert("Ошибка JSON");}
};
document.getElementById("resetBtn").onclick=()=>{
  if(confirm("Сбросить?")){data={items:[]};renderTree();}
};
document.getElementById("saveLocalBtn").onclick=()=>{
  localStorage.setItem("filter_v01R",JSON.stringify(data));alert("Сохранено в LS");
};
document.getElementById("loadLocalBtn").onclick=()=>{
  const raw=localStorage.getItem("filter_v01R");if(raw){data=JSON.parse(raw);renderTree();alert("Загружено");}
};

// Preview rendering
function renderPreview(){
  // Sections
  prevSection.innerHTML="<option value=''>--</option>";
  data.items.filter(it=>it.type==="section").forEach(s=>{
    prevSection.append(new Option(s.name,s.id));
  });
  updatePreview();
}
function updatePreview(){
  prevCategory.innerHTML="<option value=''>--</option>";
  prevSubcategory.innerHTML="<option value=''>--</option>";
  fieldsEl.innerHTML="";
  const sec=data.items.find(x=>x.id===prevSection.value);
  if(sec){
    data.items.filter(it=>it.parentId===sec.id && it.type==="category").forEach(c=>{
      prevCategory.append(new Option(c.name,c.id));
    });
  }
  const cat=data.items.find(x=>x.id===prevCategory.value);
  if(cat){
    data.items.filter(it=>it.parentId===cat.id && it.type==="subcategory").forEach(sc=>{
      prevSubcategory.append(new Option(sc.name,sc.id));
    });
  }
  // collect fields: global + attached to sec/cat/subcat
  let fields=data.items.filter(it=>it.type==="field" && !it.parentId);
  if(sec){fields=fields.concat(data.items.filter(it=>it.type==="field"&&it.parentId===sec.id));}
  if(cat){fields=fields.concat(data.items.filter(it=>it.type==="field"&&it.parentId===cat.id));}
  const sub=data.items.find(x=>x.id===prevSubcategory.value);
  if(sub){fields=fields.concat(data.items.filter(it=>it.type==="field"&&it.parentId===sub.id));}
  fields.forEach(f=>{
    const div=document.createElement("div");
    div.textContent=f.name+" ("+(f.fieldType||"text")+")";
    fieldsEl.appendChild(div);
  });
}
prevSection.onchange=updatePreview;
prevCategory.onchange=updatePreview;
prevSubcategory.onchange=updatePreview;

// Tabs
const tabTree=document.getElementById("tab-tree");
const tabJson=document.getElementById("tab-json");
const tabPrev=document.getElementById("tab-preview");
const vTree=document.getElementById("view-tree");
const vJson=document.getElementById("view-json");
const vPrev=document.getElementById("view-preview");
function activate(tab){
  tabTree.classList.remove("active");tabJson.classList.remove("active");tabPrev.classList.remove("active");
  vTree.classList.add("hidden");vJson.classList.add("hidden");vPrev.classList.add("hidden");
  if(tab==="tree"){tabTree.classList.add("active");vTree.classList.remove("hidden");}
  if(tab==="json"){tabJson.classList.add("active");vJson.classList.remove("hidden");}
  if(tab==="preview"){tabPrev.classList.add("active");vPrev.classList.remove("hidden");}
}
tabTree.onclick=()=>activate("tree");
tabJson.onclick=()=>activate("json");
tabPrev.onclick=()=>activate("preview");

renderTree();
</script>
</body>
</html>
