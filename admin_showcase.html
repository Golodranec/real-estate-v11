<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MySale — витрина (админ)</title>
<style>
  :root{
    --bg:#F7E6CA;
    --surface:#FFF5E3;
    --accent:#F27C14;
    --text:#3A2A1A;
    --radius:14px;
    --cols:4;
    --brandSize:48;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.3 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial}
  .app{display:grid;grid-template-columns:320px 1fr;gap:16px;min-height:100%}
  .panel{padding:16px;background:#fff7eb;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06) inset, 0 2px 12px rgba(0,0,0,.04)}
  .panel h3{margin:8px 0 12px;font-size:13px;opacity:.7;text-transform:uppercase;letter-spacing:.05em}
  .panel .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin:8px 0}
  .panel input[type="text"], .panel input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #eadfce;background:#fff}
  .panel input[type="color"]{width:48px;height:36px;padding:0;border:none;background:none}
  .panel button{padding:8px 12px;border:0;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
  .panel .muted{opacity:.7}
  .preview{position:relative;padding:16px;background:linear-gradient(180deg,var(--surface),#fff2dd);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .switch{display:flex;gap:8px;align-items:center;font-weight:600}
  .switch input{width:18px;height:18px}
  .stage{position:relative;min-height:420px;border-radius:16px;padding:24px}
  .brand{display:flex;align-items:center;gap:12px;user-select:none}
  .brand__logo{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 6px 12px rgba(0,0,0,.12));background:transparent;border-radius:12px}
  .brand__name{font-size:var(--brandSize,48px);font-weight:900;letter-spacing:.5px;display:flex;gap:2px;line-height:1}
  .brand__name span{display:inline-block}
  .cards{display:grid;grid-template-columns:repeat(var(--cols),1fr);gap:16px;margin-top:20px}
  .card{padding:16px;background:#fff;border-radius:var(--radius);box-shadow:0 12px 32px rgba(0,0,0,.08), 0 2px 10px rgba(0,0,0,.03)}
  .ghost{pointer-events:none;opacity:.4}
  /* free-move mode */
  .free .movable{position:absolute;cursor:move;user-select:none}
  .dragging{opacity:.8;outline:2px dashed var(--accent)}
  .hint{font-size:12px;opacity:.6}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #e7d7bf;background:#fff;cursor:pointer}
  .grid{display:grid;gap:8px}
  .grid.two{grid-template-columns:1fr 1fr}
</style>
</head>
<body>
<div class="app">
  <aside class="panel">
    <div class="row">
      <button id="saveBtn">Сохранить</button>
      <button id="loadBtn" class="btn">Загрузить</button>
    </div>

    <h3>Бренд</h3>
    <div class="grid">
      <label class="row"><input id="perLetter" type="checkbox"> <span>Пер-буквенные цвета</span></label>
      <div class="row"><input id="brandText" type="text" value="MySale"/><span class="muted">Название</span></div>
      <div class="row"><input id="brandSize" type="number" min="28" max="96" value="48"/><span class="muted">Размер</span></div>
      <div class="row"><input id="brandColor" type="color" value="#1a1a1a"/><span class="muted">Цвет (общий)</span></div>
      <div id="lettersBox" class="grid two" style="display:none"></div>
      <div class="row">
        <input id="logoFile" type="file" accept="image/*"/>
        <span class="muted">Логотип PNG/SVG/JPG</span>
      </div>
      <div class="hint">Логотип хранится локально (LocalStorage). У PNG будет прозрачный фон.</div>
    </div>

    <h3>Тема</h3>
    <div class="grid two">
      <label class="row"><input id="bg" type="color" value="#F7E6CA"><span>Фон</span></label>
      <label class="row"><input id="surface" type="color" value="#FFF5E3"><span>Поверхность</span></label>
      <label class="row"><input id="accent" type="color" value="#F27C14"><span>Акцент</span></label>
      <label class="row"><input id="text" type="color" value="#3A2A1A"><span>Текст</span></label>
      <div class="row"><input id="radius" type="number" min="0" max="30" value="14"/><span>Радиус карточек</span></div>
      <div class="row"><input id="cols" type="number" min="1" max="6" value="4"/><span>Колонки</span></div>
    </div>

    <h3>Экспорт / Импорт</h3>
    <div class="grid">
      <button id="exportBtn" class="btn">Экспорт JSON</button>
      <input id="importFile" class="btn" type="file" accept="application/json"/>
    </div>
  </aside>

  <main class="panel preview">
    <div class="toolbar">
      <label class="switch"><input id="freeMove" type="checkbox"/> <span>Свободное перемещение</span></label>
      <button id="resetPos" class="btn">Сбросить позиции</button>
    </div>

    <div id="stage" class="stage">
      <div id="brand" class="brand movable" data-key="brand">
        <img id="logo" class="brand__logo movable" data-key="logo" alt="logo" src="" />
        <div id="brandName" class="brand__name movable" data-key="brandName"></div>
      </div>

      <section class="cards">
        <div class="card">Карточка</div>
        <div class="card">Карточка</div>
        <div class="card">Карточка</div>
        <div class="card">Карточка</div>
        <div class="card">Карточка</div>
        <div class="card">Карточка</div>
        <div class="card">Карточка</div>
        <div class="card">Карточка</div>
      </section>
    </div>
  </main>
</div>

<script>
const $ = s => document.querySelector(s);
const root = document.documentElement;
const ls = (k,v)=> v===undefined? JSON.parse(localStorage.getItem(k)||'null')
                                 : localStorage.setItem(k,JSON.stringify(v));
const CFG_KEY = 'mysale_admin_cfg_v2';
const POS_KEY = 'mysale_admin_pos_v2';

/* ---------- helpers ---------- */
function setVar(name, val){ root.style.setProperty(name,val); }
function hex(v){ return /^#/.test(v)?v:"#"+v; }

/* ---------- brand text / per-letter coloring ---------- */
function mountBrandText(){
  const name = $('#brandText').value || 'MySale';
  const box = $('#brandName');
  const per = $('#perLetter').checked;
  box.style.fontSize = $('#brandSize').value+'px';
  box.innerHTML = '';
  if(per){
    $('#lettersBox').style.display = 'grid';
    $('#lettersBox').innerHTML = '';
    [...name].forEach((ch,i)=>{
      const span = document.createElement('span');
      span.textContent = ch;
      const color = (ls(CFG_KEY)?.letters||[])[i] || $('#brandColor').value;
      span.style.color = color;
      box.appendChild(span);
      // editor input
      const inp = document.createElement('input');
      inp.type='color'; inp.value = color;
      inp.title = 'Буква «'+(ch||'␣')+'»';
      inp.addEventListener('input',()=>{
        span.style.color = inp.value;
        saveCfg();
      });
      $('#lettersBox').appendChild(inp);
    });
  }else{
    $('#lettersBox').style.display = 'none';
    const span = document.createElement('span');
    span.textContent = name;
    span.style.color = $('#brandColor').value;
    box.appendChild(span);
  }
}

/* ---------- free move (drag) ---------- */
let activeDrag = null, start = null;
function onPointerDown(e){
  if(!$('#freeMove').checked) return;
  const t = e.target.closest('.movable');
  if(!t) return;
  activeDrag = t;
  t.classList.add('dragging');
  const r = t.getBoundingClientRect();
  const s = $('#stage').getBoundingClientRect();
  // ensure absolute position
  if(getComputedStyle(t).position!=='absolute'){
    t.style.position='absolute';
    t.style.left = (r.left - s.left) + 'px';
    t.style.top  = (r.top  - s.top ) + 'px';
  }
  start = {x:e.clientX, y:e.clientY, left:parseFloat(t.style.left||0), top:parseFloat(t.style.top||0)};
  e.preventDefault();
}
function onPointerMove(e){
  if(!activeDrag) return;
  const dx = e.clientX - start.x;
  const dy = e.clientY - start.y;
  activeDrag.style.left = (start.left + dx) + 'px';
  activeDrag.style.top  = (start.top  + dy) + 'px';
}
function onPointerUp(){
  if(!activeDrag) return;
  activeDrag.classList.remove('dragging');
  // persist positions
  const pos = ls(POS_KEY) || {};
  pos[ activeDrag.dataset.key ] = { left: activeDrag.style.left, top: activeDrag.style.top };
  ls(POS_KEY,pos);
  activeDrag=null;
}

function applyPositions(){
  const pos = ls(POS_KEY) || {};
  for(const [key, p] of Object.entries(pos)){
    const el = document.querySelector(`[data-key="${key}"]`);
    if(!el) continue;
    el.style.position='absolute';
    el.style.left = p.left;
    el.style.top  = p.top;
  }
}

$('#freeMove').addEventListener('change', e=>{
  $('#stage').classList.toggle('free', e.target.checked);
  if(e.target.checked){
    // when enabling free move we need to materialize positions
    document.querySelectorAll('.movable').forEach(el=>{
      const r = el.getBoundingClientRect();
      const s = $('#stage').getBoundingClientRect();
      if(getComputedStyle(el).position!=='absolute'){
        el.style.position='absolute';
        el.style.left = (r.left - s.left)+'px';
        el.style.top  = (r.top  - s.top )+'px';
      }
    });
  }else{
    // turn back to normal flow
    document.querySelectorAll('.movable').forEach(el=>{
      el.style.position='';
      el.style.left = '';
      el.style.top  = '';
    });
  }
});

$('#stage').addEventListener('pointerdown', onPointerDown);
window.addEventListener('pointermove', onPointerMove);
window.addEventListener('pointerup', onPointerUp);

$('#resetPos').addEventListener('click',()=>{
  localStorage.removeItem(POS_KEY);
  document.querySelectorAll('.movable').forEach(el=>{
    el.style.position='';
    el.style.left=''; el.style.top='';
  });
});

/* ---------- file upload (logo) ---------- */
$('#logoFile').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  $('#logo').src = url;
  saveCfg();
});

/* ---------- theme ---------- */
['bg','surface','accent','text','radius','cols'].forEach(id=>{
  $('#'+id).addEventListener('input', applyTheme);
});
function applyTheme(){
  setVar('--bg', $('#bg').value);
  setVar('--surface', $('#surface').value);
  setVar('--accent', $('#accent').value);
  setVar('--text', $('#text').value);
  setVar('--radius', $('#radius').value+'px');
  setVar('--cols', $('#cols').value);
}

/* ---------- brand controls ---------- */
$('#brandText').addEventListener('input', ()=>{ mountBrandText(); saveCfg(); });
$('#brandColor').addEventListener('input', ()=>{ mountBrandText(); saveCfg(); });
$('#brandSize').addEventListener('input', ()=>{ mountBrandText(); saveCfg(); });
$('#perLetter').addEventListener('change', ()=>{ mountBrandText(); saveCfg(); });

/* ---------- save / load ---------- */
function collectCfg(){
  const letters = [...$('#brandName').querySelectorAll('span')].map(s=>s.style.color);
  return {
    theme:{
      bg:$('#bg').value, surface:$('#surface').value, accent:$('#accent').value, text:$('#text').value,
      radius:$('#radius').value, cols:$('#cols').value
    },
    brand:{
      text:$('#brandText').value, size:$('#brandSize').value, color:$('#brandColor').value,
      perLetter:$('#perLetter').checked, letters
    },
    logo: $('#logo').src || null
  };
}
function applyCfg(cfg){
  if(!cfg) return;
  const t = cfg.theme||{};
  $('#bg').value=t.bg||'#F7E6CA';
  $('#surface').value=t.surface||'#FFF5E3';
  $('#accent').value=t.accent||'#F27C14';
  $('#text').value=t.text||'#3A2A1A';
  $('#radius').value=t.radius||14;
  $('#cols').value=t.cols||4;
  applyTheme();

  const b = cfg.brand||{};
  $('#brandText').value = b.text||'MySale';
  $('#brandSize').value = b.size||48;
  $('#brandColor').value = b.color||'#1a1a1a';
  $('#perLetter').checked = !!b.perLetter;
  ls(CFG_KEY, cfg); // keep letters for mountBrandText
  mountBrandText();

  if(cfg.logo) $('#logo').src = cfg.logo;
}
function saveCfg(){
  const cfg = collectCfg();
  ls(CFG_KEY,cfg);
}
$('#saveBtn').addEventListener('click',()=>{ saveCfg(); alert('Сохранено в браузере'); });
$('#loadBtn').addEventListener('click',()=>{ applyCfg(ls(CFG_KEY)); applyPositions(); });

/* ---------- export / import ---------- */
$('#exportBtn').addEventListener('click',()=>{
  const data = JSON.stringify({cfg:collectCfg(), pos:ls(POS_KEY)||{}},null,2);
  const blob = new Blob([data],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mysale_vitrine_config.json';
  a.click();
});
$('#importFile').addEventListener('change',async e=>{
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text();
  const {cfg,pos} = JSON.parse(text);
  applyCfg(cfg); ls(CFG_KEY,cfg);
  ls(POS_KEY,pos||{}); applyPositions();
});

/* ---------- init ---------- */
applyCfg(ls(CFG_KEY));  // theme + brand + logo
applyPositions();       // restore positions for free move
</script>
</body>
</html>
