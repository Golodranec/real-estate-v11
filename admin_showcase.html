<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySale ‚Äî –ê–¥–º–∏–Ω –≤–∏—Ç—Ä–∏–Ω—ã</title>
<style>
  :root{
    --bg-from:#F7E6CA;
    --bg-to:#F6B968;
    --surface:#FFFFFF;
    --text:#232A1A;
    --accent:#FF7A00;
    --radius:16px;
    --cols:4;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{display:flex;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:
    linear-gradient(180deg,var(--bg-from),var(--bg-to)) fixed}
  aside{width:320px;min-width:300px;background:#fff8;
        backdrop-filter: blur(6px); border-right:1px solid #0001;padding:14px;overflow:auto}
  aside h2{margin:10px 0 6px;font-size:13px;color:#0008}
  label{display:block;font-size:12px;color:#0008;margin:8px 0 4px}
  input[type="text"],input[type="number"]{width:100%;padding:8px 10px;border:1px solid #0002;border-radius:8px;background:#fff}
  input[type="color"]{width:44px;height:34px;border:1px solid #0003;border-radius:6px;background:#fff;vertical-align:middle}
  .row{display:flex;gap:10px;align-items:center}
  .row input[type="text"]{flex:1}
  .btn{display:inline-flex;gap:6px;align-items:center;padding:8px 12px;border-radius:10px;border:1px solid #0002;background:#fff;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .section{padding:10px;border:1px dashed #0001;border-radius:12px;background:#fff6;margin-bottom:10px}
  small.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#666}
  main{flex:1;position:relative;overflow:auto}
  .stage{min-height:100%;padding:32px 24px}
  .brand{position:absolute;left:32px;top:24px;display:flex;align-items:center;gap:10px;user-select:none}
  .brand .logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:#fff7;backdrop-filter:blur(4px)}
  .brand .logo img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .brand .name{font-size:54px;font-weight:800;letter-spacing:.5px;display:flex;gap:0 .6ch}
  .brand .name span{display:inline-block}
  .search{position:absolute;left:50%;transform:translateX(-50%);top:110px;display:flex;gap:8px;width:min(800px,86vw)}
  .search input{flex:1;padding:12px 14px;border-radius:14px;border:1px solid #0002;background:#ffff}
  .search button{padding:12px 16px;border:1px solid #0000;border-radius:14px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .grid{position:relative;margin-top:180px;display:grid;grid-template-columns:repeat(var(--cols),minmax(240px,1fr));gap:26px}
  .card{position:relative;background:var(--surface);border-radius:var(--radius);box-shadow:
        0 10px 30px #0001, 0 2px 0 1px #00000008 inset;border:1px solid #00000014;padding:14px 14px 16px;transition:.15s}
  .card.dragging{opacity:.8;transform:scale(.98)}
  .card .icon{font-size:26px}
  .card .title{margin:8px 0 4px;font-size:18px;font-weight:800;color:var(--accent);}
  .card .hint{font-size:12.5px;color:#0009}
  .card a.pin{position:absolute;right:10px;top:8px;font-size:18px;color:#aaa;text-decoration:none}
  .card .title,.card .hint,.card .icon{position:relative}
  .circle{border-radius:9999px!important}
  .free .grid{display:block}
  .free .card{position:absolute}
  .badge{position:fixed;right:16px;top:12px;font:12px ui-monospace;background:#000b;color:#fff;padding:6px 10px;border-radius:999px}
  .hidden{display:none!important}
</style>
</head>
<body>
  <aside>
    <div class="toolbar">
      <button class="btn" id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
      <button class="btn" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button class="btn" id="btnUndo">Undo</button>
      <button class="btn" id="btnRedo">Redo</button>
    </div>

    <div class="section">
      <h2>–ë—Ä–µ–Ω–¥</h2>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="brandName" type="text" value="MySale"/>
      <div class="row">
        <label>–¶–≤–µ—Ç–∞ (HEX —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
      </div>
      <input id="brandColors" type="text" value="#ff6a00,#0ea21a"/>
      <div class="row" style="margin-top:6px">
        <label>–õ–æ–≥–æ—Ç–∏–ø (PNG/SVG)</label>
      </div>
      <input id="logoFile" type="file" accept="image/png,image/svg+xml"/>
      <div class="row">
        <label><input id="lockBrand" type="checkbox"/> –ó–∞–∫—Ä–µ–ø–∏—Ç—å –±—Ä–µ–Ω–¥</label>
        <label><input id="lockLogo" type="checkbox"/> –ó–∞–∫—Ä–µ–ø–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</label>
      </div>
      <small class="mono">–°–æ–≤–µ—Ç: PNG —Å–æ —Å–ª–æ–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ ‚Äî –±–µ–∑ –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞.</small>
    </div>

    <div class="section">
      <h2>–¢–µ–º–∞</h2>
      <div class="row">
        <div><label>–§–æ–Ω –æ—Ç</label><input id="bgFrom" type="color" value="#F7E6CA"/></div>
        <div><label>–§–æ–Ω –¥–æ</label><input id="bgTo" type="color" value="#F6B968"/></div>
      </div>
      <div class="row">
        <div><label>–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å</label><input id="surface" type="color" value="#FFFFFF"/></div>
        <div><label>–¢–µ–∫—Å—Ç</label><input id="textColor" type="color" value="#232A1A"/></div>
        <div><label>–ê–∫—Ü–µ–Ω—Ç</label><input id="accent" type="color" value="#FF7A00"/></div>
      </div>
      <div class="row">
        <div style="flex:1"><label>–†–∞–¥–∏—É—Å –∫–∞—Ä—Ç–æ—á–µ–∫ (px)</label><input id="radius" type="number" min="0" max="120" value="16"/></div>
        <div style="flex:1"><label>–ö–æ–ª–æ–Ω–∫–∏</label><input id="cols" type="number" min="1" max="6" value="4"/></div>
      </div>
    </div>

    <div class="section">
      <h2>–†–µ–∂–∏–º</h2>
      <div class="row">
        <label><input id="freeMove" type="checkbox"/> –°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</label>
        <button class="btn" id="btnResetPos">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏</button>
      </div>
    </div>

    <div class="section">
      <h2>–ö–∞—Ä—Ç–æ—á–∫–∏</h2>
      <div class="row" style="gap:6px">
        <button class="btn" id="btnAddCard">+ –ö–∞—Ä—Ç–æ—á–∫–∞</button>
        <button class="btn" id="btnDelCard">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <label>–í—ã–±–æ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏</label>
      <select id="selCard"></select>

      <label>–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏/—Å–∏–º–≤–æ–ª)</label>
      <input id="cardIcon" type="text" placeholder="üè†"/>

      <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
      <input id="cardTitle" type="text"/>

      <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
      <input id="cardHint" type="text"/>

      <label>–°—Å—ã–ª–∫–∞ (URL)</label>
      <input id="cardUrl" type="text" placeholder="https://..."/>

      <div class="row">
        <div style="flex:1"><label>–®–∏—Ä–∏–Ω–∞ (px)</label><input id="cardW" type="number" min="160" max="520" value="260"/></div>
        <div style="flex:1"><label>–í—ã—Å–æ—Ç–∞ (px)</label><input id="cardH" type="number" min="120" max="520" value="150"/></div>
      </div>

      <div class="row">
        <label><input id="shapeCircle" type="checkbox"/> –ö—Ä—É–≥</label>
      </div>

      <h2>–ü–æ–∑–∏—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ (—Å–º–µ—â–µ–Ω–∏—è)</h2>
      <div class="row">
        <div style="flex:1"><label>dx –∑–∞–≥–æ–ª–æ–≤–∫–∞</label><input id="dxTitle" type="number" value="0"/></div>
        <div style="flex:1"><label>dy –∑–∞–≥–æ–ª–æ–≤–∫–∞</label><input id="dyTitle" type="number" value="0"/></div>
      </div>
      <div class="row">
        <div style="flex:1"><label>dx –ø–æ–¥–ø–∏—Å–∏</label><input id="dxHint" type="number" value="0"/></div>
        <div style="flex:1"><label>dy –ø–æ–¥–ø–∏—Å–∏</label><input id="dyHint" type="number" value="0"/></div>
      </div>
    </div>

    <div class="section">
      <h2>–ü–æ–∏—Å–∫</h2>
      <div class="row">
        <label><input id="showSearch" type="checkbox" checked/> –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞</label>
      </div>
    </div>

    <div class="section">
      <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
      <small class="mono">–ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è. –ö–Ω–æ–ø–∫–∏ Undo/Redo ‚Äî –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏.</small>
    </div>
  </aside>

  <main>
    <div class="stage" id="stage">
      <div class="badge" id="modeBadge">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>

      <div class="brand" id="brand">
        <div class="logo" id="logoBox"><img id="logoImg" alt="logo"/></div>
        <div class="name" id="brandNameView"></div>
      </div>

      <div class="search" id="searchBar">
        <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤, —É—Å–ª—É–≥ –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...">
        <button id="searchClear" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>

      <div class="grid" id="grid"></div>
    </div>
  </main>

<script>
(() => {
  const qs = s=>document.querySelector(s);
  const qsa = s=>Array.from(document.querySelectorAll(s));

  const state = {
    brand:{ name:"MySale", colors:["#ff6a00","#0ea21a"], logo:null, lockBrand:false, lockLogo:false },
    theme:{ bgFrom:"#F7E6CA", bgTo:"#F6B968", surface:"#FFFFFF", text:"#232A1A", accent:"#FF7A00", radius:16, cols:4 },
    ui:{ free:false, showSearch:true },
    cards:[],
    sel:-1,
    history:[], hi:-1
  };

  function applyTheme(){
    const r = document.documentElement.style;
    r.setProperty('--bg-from', state.theme.bgFrom);
    r.setProperty('--bg-to', state.theme.bgTo);
    r.setProperty('--surface', state.theme.surface);
    r.setProperty('--text', state.theme.text);
    r.setProperty('--accent', state.theme.accent);
    r.setProperty('--radius', state.theme.radius+'px');
    r.setProperty('--cols', state.theme.cols);
    document.body.classList.toggle('free', state.ui.free);
    qs('#modeBadge').textContent = state.ui.free? '–°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ':'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
    qs('#searchBar').classList.toggle('hidden', !state.ui.showSearch);
  }

  function renderBrand(){
    const box = qs('#brandNameView');
    box.innerHTML = '';
    const letters = Array.from(state.brand.name);
    const palette = state.brand.colors.length? state.brand.colors: ['#ff6a00'];
    letters.forEach((ch,i)=>{
      const span = document.createElement('span');
      span.textContent = ch;
      span.style.color = palette[i%palette.length];
      box.appendChild(span);
    });
    const img = qs('#logoImg');
    if(state.brand.logo){ img.src = state.brand.logo; img.classList.remove('hidden'); }
    else { img.removeAttribute('src'); }
  }

  function newCard(){
    return {icon:'üè†', title:'–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞', hint:'–û–ø–∏—Å–∞–Ω–∏–µ', url:'#',
            x:0, y:0, w:260, h:150, circle:false, dxT:0, dyT:0, dxH:0, dyH:0};
  }

  function cardTpl(m, idx){
    const el = document.createElement('div');
    el.className='card';
    if(m.circle) el.classList.add('circle');
    el.style.width = m.w+'px';
    el.style.height = m.h+'px';
    if(state.ui.free){
      el.style.left = (m.x||0)+'px';
      el.style.top  = (m.y||0)+'px';
    }
    el.dataset.idx = idx;
    el.innerHTML = `
      <a class="pin" href="#">üîó</a>
      <div class="icon" style="transform: translate(${0}px,${0}px);">${m.icon||''}</div>
      <div class="title" style="transform: translate(${m.dxT||0}px,${m.dyT||0}px);">${m.title||''}</div>
      <div class="hint"  style="transform: translate(${m.dxH||0}px,${m.dyH||0}px);">${m.hint||''}</div>`;

    // Click behavior
    el.addEventListener('click', (e)=>{
      if(state.ui.free) return;
      const a = e.target.closest('.pin');
      if(a){ e.preventDefault(); window.open(m.url || '#','_blank'); return;}
      window.open(m.url || '#','_blank');
    });

    if(state.ui.free){
      makeDraggable(el, (dx,dy, up)=>{
        m.x = Math.max(0,(m.x||0)+dx);
        m.y = Math.max(0,(m.y||0)+dy);
        el.style.left = m.x+'px';
        el.style.top = m.y+'px';
        if(up) pushHistory();
      });
    }

    el.addEventListener('pointerdown',()=>{ selectCard(idx); });
    return el;
  }

  function makeDraggable(node, onMove){
    let sx,sy;
    const mm = (ev)=>{
      const dx = ev.clientX - sx, dy = ev.clientY - sy;
      onMove(dx,dy,false);
      sx = ev.clientX; sy = ev.clientY;
    };
    const up = (ev)=>{
      document.removeEventListener('pointermove',mm);
      document.removeEventListener('pointerup',up);
      onMove(0,0,true);
      node.classList.remove('dragging');
    };
    node.addEventListener('pointerdown',(ev)=>{
      if(ev.button!==0) return;
      sx=ev.clientX; sy=ev.clientY;
      node.classList.add('dragging');
      document.addEventListener('pointermove',mm);
      document.addEventListener('pointerup',up);
    });
  }

  function renderCards(){
    const grid = qs('#grid'); grid.innerHTML='';
    state.cards.forEach((m,i)=> grid.appendChild(cardTpl(m,i)));
    rebuildSel();
  }

  function rebuildSel(){
    const sel = qs('#selCard'); sel.innerHTML='';
    state.cards.forEach((m,i)=>{
      const o = document.createElement('option');
      o.value=i; o.textContent = (i+1)+'. '+(m.title||'–ö–∞—Ä—Ç–æ—á–∫–∞');
      sel.appendChild(o);
    });
    if(state.sel>=0 && state.sel<state.cards.length) sel.value=state.sel;
    fillEditor();
  }

  function selectCard(i){
    state.sel = i;
    rebuildSel();
  }

  function fillEditor(){
    qs('#brandName').value = state.brand.name;
    qs('#brandColors').value = state.brand.colors.join(',');
    qs('#lockBrand').checked = state.brand.lockBrand;
    qs('#lockLogo').checked = state.brand.lockLogo;
    qs('#bgFrom').value = state.theme.bgFrom;
    qs('#bgTo').value = state.theme.bgTo;
    qs('#surface').value = state.theme.surface;
    qs('#textColor').value = state.theme.text;
    qs('#accent').value = state.theme.accent;
    qs('#radius').value = state.theme.radius;
    qs('#cols').value = state.theme.cols;
    qs('#freeMove').checked = state.ui.free;
    qs('#showSearch').checked = state.ui.showSearch;

    const m = state.cards[state.sel];
    const disabled = !m;
    ['cardIcon','cardTitle','cardHint','cardUrl','cardW','cardH','shapeCircle','dxTitle','dyTitle','dxHint','dyHint'].forEach(id=> qs('#'+id).disabled = disabled);
    if(!m) return;
    qs('#cardIcon').value = m.icon||'';
    qs('#cardTitle').value= m.title||'';
    qs('#cardHint').value = m.hint||'';
    qs('#cardUrl').value  = m.url||'';
    qs('#cardW').value = m.w||260;
    qs('#cardH').value = m.h||150;
    qs('#shapeCircle').checked = !!m.circle;
    qs('#dxTitle').value = m.dxT||0;
    qs('#dyTitle').value = m.dyT||0;
    qs('#dxHint').value = m.dxH||0;
    qs('#dyHint').value = m.dyH||0;
  }

  function applyFromEditor(){
    state.brand.name = qs('#brandName').value;
    state.brand.colors = qs('#brandColors').value.split(',').map(s=>s.trim()).filter(Boolean);
    state.brand.lockBrand = qs('#lockBrand').checked;
    state.brand.lockLogo = qs('#lockLogo').checked;
    state.theme.bgFrom = qs('#bgFrom').value;
    state.theme.bgTo   = qs('#bgTo').value;
    state.theme.surface= qs('#surface').value;
    state.theme.text   = qs('#textColor').value;
    state.theme.accent = qs('#accent').value;
    state.theme.radius = +qs('#radius').value||16;
    state.theme.cols   = +qs('#cols').value||4;
    state.ui.free = qs('#freeMove').checked;
    state.ui.showSearch = qs('#showSearch').checked;

    const m = state.cards[state.sel];
    if(m){
      m.icon = qs('#cardIcon').value;
      m.title= qs('#cardTitle').value;
      m.hint = qs('#cardHint').value;
      m.url  = qs('#cardUrl').value;
      m.w    = +qs('#cardW').value||260;
      m.h    = +qs('#cardH').value||150;
      m.circle = qs('#shapeCircle').checked;
      m.dxT = +qs('#dxTitle').value||0;
      m.dyT = +qs('#dyTitle').value||0;
      m.dxH = +qs('#dxHint').value||0;
      m.dyH = +qs('#dyHint').value||0;
    }

    applyTheme();
    renderBrand();
    renderCards();
    pushHistory(false);
  }

  const fileSave = (name, text)=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text],{type:'application/json'}));
    a.download = name;
    a.click(); URL.revokeObjectURL(a.href);
  };

  function exportJSON(){
    const json = JSON.stringify(state, null, 2);
    fileSave('mysale_showcase.json', json);
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        Object.assign(state, data);
        state.hi = -1; state.history = [];
        applyTheme(); renderBrand(); renderCards(); rebuildSel();
        pushHistory(false);
      }catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e.message); }
    };
    reader.readAsText(file);
  }

  function snapshot(){
    const {history,hi} = state;
    const snap = JSON.stringify({brand:state.brand, theme:state.theme, ui:state.ui, cards:state.cards, sel:state.sel});
    return snap;
  }
  function pushHistory(advance=true){
    const snap = snapshot();
    if(state.history[state.hi]===snap) return;
    state.history = state.history.slice(0,state.hi+1);
    state.history.push(snap); state.hi = state.history.length-1;
    if(advance) saveLocal();
  }
  function gotoHistory(hi){
    if(hi<0 || hi>=state.history.length) return;
    const data = JSON.parse(state.history[hi]);
    state.brand=data.brand; state.theme=data.theme; state.ui=data.ui;
    state.cards=data.cards; state.sel=data.sel;
    state.hi = hi;
    applyTheme(); renderBrand(); renderCards(); rebuildSel();
    saveLocal();
  }

  function saveLocal(){ localStorage.setItem('mysale_showcase_admin', JSON.stringify(state)); }
  function loadLocal(){
    try{ const j = localStorage.getItem('mysale_showcase_admin');
      if(j){ const data = JSON.parse(j); Object.assign(state,data); }
    }catch(e){}
  }

  function initDefault(){
    if(!state.cards.length){
      state.cards = [
        {icon:'üè†', title:'–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', hint:'–ö–≤–∞—Ä—Ç–∏—Ä—ã, –¥–æ–º–∞, –∫–æ–º–º–µ—Ä—Ü–∏—è', url:'#', x:0,y:0,w:260,h:150,circle:false,dxT:0,dyT:0,dxH:0,dyH:0},
        {icon:'üöó', title:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', hint:'–õ–µ–≥–∫–æ–≤—ã–µ, –≥—Ä—É–∑–æ–≤—ã–µ', url:'#', x:300,y:0,w:260,h:150,circle:false,dxT:0,dyT:0,dxH:0,dyH:0},
        {icon:'üíº', title:'–†–∞–±–æ—Ç–∞', hint:'–í–∞–∫–∞–Ω—Å–∏–∏', url:'#', x:600,y:0,w:260,h:150,circle:false},
        {icon:'üíª', title:'–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', hint:'–¢–µ–ª–µ—Ñ–æ–Ω—ã –∏ –ü–ö', url:'#', x:0,y:180,w:260,h:150,circle:false},
        {icon:'üß∞', title:'–£—Å–ª—É–≥–∏', hint:'–°–µ—Ä–≤–∏—Å –∏ –ø–æ–º–æ—â—å', url:'#', x:300,y:180,w:260,h:150,circle:false},
        {icon:'üõãÔ∏è', title:'–ú–µ–±–µ–ª—å', hint:'–î–æ–º –∏ –¥–∞—á–∞', url:'#', x:600,y:180,w:260,h:150,circle:false}
      ];
    }
  }

  function bind(){
    qs('#btnExport').onclick = exportJSON;
    qs('#btnImport').onclick = ()=>{
      const i = document.createElement('input');
      i.type='file'; i.accept='application/json,.json';
      i.onchange = ()=> i.files[0] && importJSON(i.files[0]);
      i.click();
    };
    qs('#btnUndo').onclick = ()=> gotoHistory(state.hi-1);
    qs('#btnRedo').onclick = ()=> gotoHistory(state.hi+1);

    ['brandName','brandColors','bgFrom','bgTo','surface','textColor','accent','radius','cols','freeMove','showSearch','lockBrand','lockLogo']
      .forEach(id => qs('#'+id).addEventListener('input', applyFromEditor));

    qs('#searchClear').onclick = ()=> qs('#searchInput').value='';

    qs('#logoFile').onchange = (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{ state.brand.logo = reader.result; renderBrand(); pushHistory(); };
      reader.readAsDataURL(f);
    };

    qs('#btnAddCard').onclick = ()=>{ state.cards.push(newCard()); state.sel = state.cards.length-1; applyFromEditor(); renderCards(); rebuildSel(); pushHistory(); };
    qs('#btnDelCard').onclick = ()=>{
      if(state.sel<0) return;
      state.cards.splice(state.sel,1); state.sel = Math.min(state.sel, state.cards.length-1);
      renderCards(); rebuildSel(); pushHistory();
    };
    qs('#selCard').onchange = (e)=>{ state.sel = +e.target.value; fillEditor(); };

    ['cardIcon','cardTitle','cardHint','cardUrl','cardW','cardH','shapeCircle','dxTitle','dyTitle','dxHint','dyHint']
      .forEach(id => qs('#'+id).addEventListener('input', applyFromEditor));

    qs('#btnResetPos').onclick = ()=>{
      state.cards.forEach((m,i)=>{ m.x = (i%3)*300; m.y = Math.floor(i/3)*180; });
      renderCards(); pushHistory();
    };

    const brand = qs('#brand'), logo = qs('#logoBox');
    makeDraggable(brand,(dx,dy,up)=>{
      if(!state.ui.free || state.brand.lockBrand) return;
      brand.style.left = (brand.offsetLeft + dx) + 'px';
      brand.style.top  = (brand.offsetTop  + dy) + 'px';
      if(up) pushHistory();
    });
    makeDraggable(logo,(dx,dy,up)=>{
      if(!state.ui.free || state.brand.lockLogo) return;
      logo.style.transform = `translate(${((logo._tx||0)+dx)}px,${((logo._ty||0)+dy)}px)`;
      logo._tx = (logo._tx||0)+dx; logo._ty=(logo._ty||0)+dy;
      if(up) pushHistory();
    });
  }

  function init(){
    loadLocal(); initDefault();
    applyTheme(); renderBrand(); renderCards(); rebuildSel(); bind();
    pushHistory(false);
  }

  init();
})();
</script>
</body>
</html>
