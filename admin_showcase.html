<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MySale ‚Äî –∞–¥–º–∏–Ω–∫–∞ –≤–∏—Ç—Ä–∏–Ω—ã (–ø–æ–ª–Ω–∞—è)</title>
<style>
:root{
  --bg:#F8EAD6;
  --surface:#FFF5E6;
  --primary:#F27C14;
  --text:#3A2A1A;
  --card-radius:16px;
  --gap:18px;
  --shadow:0 8px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font:16px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
}
/* layout */
.wrapper{display:grid; grid-template-columns:340px 1fr; gap:24px; padding:20px;}
@media (max-width:1000px){.wrapper{grid-template-columns:1fr}}
.panel{
  background:var(--surface);
  border-radius:20px;
  box-shadow:var(--shadow);
  padding:16px;
}
h2{margin:0 0 12px 0; font-size:18px}
label{font-size:12px; display:block; opacity:.7; margin:12px 0 6px}
input[type="text"],input[type="number"],input[type="url"],input[type="color"],textarea,select{
  width:100%; border:1px solid rgba(0,0,0,.08); border-radius:10px; padding:10px 12px; background:#fff; outline:none;
}
textarea{min-height:72px; resize:vertical}
.row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.actions{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
button{
  background:var(--primary); color:#fff; border:0; border-radius:10px; padding:10px 14px; cursor:pointer;
  box-shadow:0 2px 0 rgba(0,0,0,.08); font-weight:600;
}
button.secondary{background:#fff; color:var(--text); border:1px solid rgba(0,0,0,.1)}
button.ghost{background:transparent; border:1px dashed rgba(0,0,0,.25); color:var(--text)}
small.help{display:block; opacity:.6; margin-top:6px}
.grid{
  display:grid;
  gap:var(--gap);
  grid-template-columns:repeat(var(--cols,4),1fr);
}
@media (max-width:1200px){.grid{grid-template-columns:repeat(var(--cols,3),1fr)}}
@media (max-width:900px){.grid{grid-template-columns:repeat(var(--cols,2),1fr)}}
@media (max-width:640px){.grid{grid-template-columns:repeat(var(--cols,1),1fr)}}
.card{
  background:#fff;
  border-radius:var(--card-radius);
  box-shadow:var(--shadow);
  padding:18px;
  user-select:none;
  cursor:grab;
}
.card.dragging{opacity:.5}
.card .icon{font-size:42px; line-height:1; margin-bottom:10px}
.card .title{font-size:18px; font-weight:800; margin:0 0 6px}
.card .sub{opacity:.6; font-size:13px; margin:0}
.toolbar{
  display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px
}
.brand{
  display:flex; align-items:center; gap:12px;
}
.brand .logo{width:48px; height:48px; border-radius:14px; overflow:hidden; background:transparent; display:grid; place-items:center; box-shadow:var(--shadow)}
.brand .logo img{max-width:100%; max-height:100%; object-fit:contain}
.brand .text{font-size:28px; font-weight:900; letter-spacing:.2px}
.kbd{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#00000010; padding:2px 6px; border-radius:6px}
.list{display:flex; flex-direction:column; gap:10px; max-height:36vh; overflow:auto}
.item{background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:10px; padding:10px; display:grid; grid-template-columns:28px 1fr auto; gap:10px; align-items:center}
.item .dot{width:28px;height:28px;border-radius:8px;background:var(--primary);display:grid; place-items:center; color:#fff; font-weight:900}
.item button{padding:6px 10px}
.footer{opacity:.65; font-size:12px; margin-top:8px}
hr{border:0; border-top:1px solid rgba(0,0,0,.08); margin:14px 0}
input[type="file"]{border:0}
.switch{display:flex; align-items:center; gap:8px}
.switch input{accent-color:var(--primary)}
.badge{font-size:12px; background:#0000000f; padding:3px 8px; border-radius:999px}

  .card.free .icon, .card.free .title, .card.free .sub{
    position:absolute; cursor:grab; background:rgba(255,255,255,.6); padding:2px 6px; border-radius:8px;
  }

</style>
</head>
<body>
  <div class="wrapper">
    <!-- LEFT: SETTINGS -->
    <div class="panel" id="settings">
      <div class="toolbar">
        <div class="brand">
          <div class="logo"><img id="logoImg" alt=""></div>
          <div class="text" id="brandText">mysale</div>
        </div>
        <div class="actions">
          <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="secondary" id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </div>

      <h2>–ë—Ä–µ–Ω–¥</h2>
      <div class="actions"><button class="secondary" id="toggleLetterEditor">–ü–µ—Ä-–±—É–∫–≤–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞</button></div>
      <div id="letterEditor" class="list" style="display:none"></div>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input type="text" id="inpBrandText" placeholder="mysale">
      <div class="row">
        <div>
          <label>–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (px)</label>
          <input type="number" id="inpBrandSize" min="20" max="120" value="40">
        </div>
        <div>
          <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø (PNG/SVG/JPG)</label>
          <input type="file" id="inpLogo" accept="image/*">
          <small class="help">–§–∞–π–ª —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (localStorage)</small>
        </div>
      </div>

      <hr>
      <h2>–¢–µ–º–∞</h2>
      <div class="row">
        <div>
          <label>–§–æ–Ω</label>
          <div style="display:flex;gap:6px;align-items:center"><input type="color" id="colorBg"><input type="text" id="colorBgHex" placeholder="#RRGGBB" style="width:110px"></div>
        </div>
        <div>
          <label>–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å</label>
          <div style="display:flex;gap:6px;align-items:center"><input type="color" id="colorSurface"><input type="text" id="colorSurfaceHex" placeholder="#RRGGBB" style="width:110px"></div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>–ê–∫—Ü–µ–Ω—Ç</label>
          <div style="display:flex;gap:6px;align-items:center"><input type="color" id="colorPrimary"><input type="text" id="colorPrimaryHex" placeholder="#RRGGBB" style="width:110px"></div>
        </div>
        <div>
          <label>–¢–µ–∫—Å—Ç</label>
          <div style="display:flex;gap:6px;align-items:center"><input type="color" id="colorText"><input type="text" id="colorTextHex" placeholder="#RRGGBB" style="width:110px"></div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>–†–∞–¥–∏—É—Å –∫–∞—Ä—Ç–æ—á–µ–∫ (px)</label>
          <input type="number" id="inpRadius" min="0" max="40" value="16">
        </div>
        <div>
          <label>–ö–æ–ª–æ–Ω–∫–∏</label>
          <input type="number" id="inpCols" min="1" max="6" value="4">
        </div>
      </div>

      <div class="actions">
        <button class="secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <label class="switch"><input type="file" id="importFile" hidden><button class="secondary" id="importBtn">–ò–º–ø–æ—Ä—Ç JSON</button></label>
        <button class="ghost" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>

      <hr>
      <h2>–ö–∞—Ä—Ç–æ—á–∫–∏</h2>
      <div class="actions">
        <button id="addCard">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        <span class="badge">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</span>
      </div>
      <div class="list" id="cardsList"></div>
      <div class="footer">–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ <span class="kbd">localStorage</span>. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ JSON –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.</div>
    </div>

    <!-- RIGHT: PREVIEW -->
    <div class="panel">
      <div class="toolbar">
        <div class="brand">
          <div class="logo"><img id="logoImgPreview" alt=""></div>
          <div class="text" id="brandTextPreview">mysale</div>
        </div>
        <div class="badge">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
          <label class="switch"><input type="checkbox" id="freeMoveToggle"> –°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</label>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

<script>
const key = 'mysale_vitrine_state_v1';

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const state = {
  brand: { text:'mysale', size:40, logo:'' },
  theme: { bg:'#F8EAD6', surface:'#FFF5E6', primary:'#F27C14', text:'#3A2A1A', radius:16, cols:4 },
  cards: [
    {icon:'üè†', title:'–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', sub:'–ü—Ä–æ–¥–∞–∂–∞, –∞—Ä–µ–Ω–¥–∞', url:'#', newTab:true},
    {icon:'üöó', title:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', sub:'–ê–≤—Ç–æ, –º–æ—Ç–æ, –∑–∞–ø—á–∞—Å—Ç–∏', url:'#', newTab:true},
    {icon:'üíª', title:'–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', sub:'–¢–µ–ª–µ—Ñ–æ–Ω—ã, –Ω–æ—É—Ç–±—É–∫–∏', url:'#', newTab:true},
    {icon:'üíº', title:'–†–∞–±–æ—Ç–∞', sub:'–í–∞–∫–∞–Ω—Å–∏–∏, —Ä–µ–∑—é–º–µ', url:'#', newTab:true},
    {icon:'üõ†Ô∏è', title:'–£—Å–ª—É–≥–∏', sub:'–°–µ—Ä–≤–∏—Å, —Ä–µ–º–æ–Ω—Ç', url:'#', newTab:true},
    {icon:'üõãÔ∏è', title:'–ú–µ–±–µ–ª—å', sub:'–î–æ–º –∏ –¥–∞—á–∞', url:'#', newTab:true},
    {icon:'üëï', title:'–ú–æ–¥–∞', sub:'–û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å', url:'#', newTab:true},
    {icon:'üö¥', title:'–•–æ–±–±–∏', sub:'–°–ø–æ—Ä—Ç –∏ –æ—Ç–¥—ã—Ö', url:'#', newTab:true},
  ]
};

// ---------- persistence ----------
function saveToLS(){
  localStorage.setItem(key, JSON.stringify(state));
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).');
}
function loadFromLS(){
  const s = localStorage.getItem(key);
  if(!s) return;
  try{ 
    const obj = JSON.parse(s);
    if(obj && obj.brand && obj.theme && Array.isArray(obj.cards)){
      Object.assign(state.brand, obj.brand);
      Object.assign(state.theme, obj.theme);
      state.cards.splice(0,state.cards.length, ...obj.cards);
    }
  }catch(e){console.error(e)}
}

function exportJSON(){
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mysale_vitrine_state.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

function importJSON(file){
  const fr = new FileReader();
  fr.onload = e=>{
    try{
      const obj = JSON.parse(e.target.result);
      if(obj.brand && obj.theme && Array.isArray(obj.cards)){
        Object.assign(state.brand, obj.brand);
        Object.assign(state.theme, obj.theme);
        state.cards = obj.cards;
        renderAll();
      }else alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON');
    }catch(err){ alert('–û—à–∏–±–∫–∞ JSON: '+err.message) }
  };
  fr.readAsText(file);
}

// ---------- helpers ----------
function applyTheme(){
  document.documentElement.style.setProperty('--bg', state.theme.bg);
  document.documentElement.style.setProperty('--surface', state.theme.surface);
  document.documentElement.style.setProperty('--primary', state.theme.primary);
  document.documentElement.style.setProperty('--text', state.theme.text);
  document.documentElement.style.setProperty('--card-radius', state.theme.radius+'px');
  document.querySelector('.panel:nth-child(2) .grid').style.setProperty('--cols', state.theme.cols);
}

function setBrand(){
  $('#brandText').textContent = state.brand.text;
  $('#brandText').style.fontSize = state.brand.size+'px';
  $('#brandTextPreview').textContent = state.brand.text;
  $('#brandTextPreview').style.fontSize = state.brand.size+'px';
  $('#logoImg').src = state.brand.logo || '';
  $('#logoImgPreview').src = state.brand.logo || '';
  $('#inpBrandText').value = state.brand.text;
  $('#inpBrandSize').value = state.brand.size;
}

function updateInputs(){
  $('#colorBg').value = state.theme.bg;
  $('#colorSurface').value = state.theme.surface;
  $('#colorPrimary').value = state.theme.primary;
  $('#colorText').value = state.theme.text;
  $('#inpRadius').value = state.theme.radius;
  $('#inpCols').value = state.theme.cols;
}

function createCardEl(card, idx){
  const el = document.createElement('div');
  el.className = 'card';
  el.draggable = true;
  el.innerHTML = `
    <div class="icon">${card.icon||'üì¶'}</div>
    <h3 class="title">${card.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
    <p class="sub">${card.sub||''}</p>
  `;
  if(card.bg) el.style.background = card.bg;
  if(card.color) el.style.color = card.color;
  // click
  el.addEventListener('click', e=>{
    if(card.url){
      if(card.newTab) window.open(card.url, '_blank');
      else location.href = card.url;
    }
  });
  // drag & drop
  el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', idx); el.classList.add('dragging'); });
  el.addEventListener('dragend', e=>{ el.classList.remove('dragging'); });
  el.addEventListener('dragover', e=>{ e.preventDefault(); });
  el.addEventListener('drop', e=>{
    e.preventDefault();
    const from = +e.dataTransfer.getData('text/plain');
    const to = idx;
    if(from===to) return;
    const [item] = state.cards.splice(from,1);
    state.cards.splice(to,0,item);
    renderAll();
  });
  return el;
}

function renderGrid(){
  const grid = $('#grid');
  grid.innerHTML='';
  state.cards.forEach((c,i)=> grid.appendChild(createCardEl(c,i)));
}

function renderCardsList(){
  const list = $('#cardsList');
  list.innerHTML='';
  state.cards.forEach((c,i)=>{
    const it = document.createElement('div');
    it.className='item';
    it.innerHTML = `
      <div class="dot">${(c.icon||'üîñ').slice(0,2)}</div>
      <div>
        <div style="font-weight:700">${c.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
        <div style="opacity:.65; font-size:12px">${c.url||'–°—Å—ã–ª–∫–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞'}</div>
      </div>
      <div style="display:flex; gap:6px">
        <button class="secondary" data-edit>–†–µ–¥.</button>
        <button class="ghost" data-dup title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å">–î—É–±–ª—å</button>
        <button class="ghost" data-del title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
      </div>
    `;
    it.querySelector('[data-edit]').onclick=()=> openCardEditor(i);
    it.querySelector('[data-del]').onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?')){ state.cards.splice(i,1); renderAll(); } };
    it.querySelector('[data-dup]').onclick=()=>{ state.cards.splice(i+1,0, JSON.parse(JSON.stringify(c))); renderAll(); };
    list.appendChild(it);
  });
}

function openCardEditor(i){
  const c = state.cards[i];
  const dlg = document.createElement('div');
  Object.assign(dlg.style,{
    position:'fixed', inset:'0', background:'rgba(0,0,0,.35)', display:'grid', placeItems:'center', zIndex:9999
  });
  dlg.innerHTML = `
  <div class="panel" style="width:min(700px, 92vw)">
    <h2>–ö–∞—Ä—Ç–æ—á–∫–∞</h2>
    <div class="row">
      <div><label>–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label><input type="text" id="eIcon" value="${c.icon||''}" placeholder="üè†"></div>
      <div><label>–û—Ç–∫—Ä—ã–≤–∞—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</label><div class="switch"><input type="checkbox" id="eTab" ${c.newTab?'checked':''}><span>target=_blank</span></div></div>
    </div>
    <div class="row">
      <div><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" id="eTitle" value="${c.title||''}"></div>
      <div><label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label><input type="text" id="eSub" value="${c.sub||''}"></div>
    </div>
    <label>–°—Å—ã–ª–∫–∞ (URL)</label><input type="url" id="eUrl" value="${c.url||''}" placeholder="https://...">
    <div class="row">
      <div><label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label><input type="color" id="eBg" value="${c.bg||'#ffffff'}"></div>
      <div><label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label><input type="color" id="eColor" value="${c.color||'#000000'}"></div>
    </div>
    <div class="actions" style="justify-content:space-between">
      <button class="secondary" id="close">–û—Ç–º–µ–Ω–∞</button>
      <div style="display:flex; gap:8px">
        <button class="ghost" id="remove">–£–¥–∞–ª–∏—Ç—å</button>
        <button id="apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>`;
  dlg.onclick = e=>{ if(e.target===dlg) dlg.remove(); };
  dlg.querySelector('#close').onclick=()=> dlg.remove();
  dlg.querySelector('#remove').onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?')){ state.cards.splice(i,1); dlg.remove(); renderAll(); } };
  dlg.querySelector('#apply').onclick=()=>{
    c.icon = dlg.querySelector('#eIcon').value || 'üîñ';
    c.title = dlg.querySelector('#eTitle').value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    c.sub = dlg.querySelector('#eSub').value || '';
    c.url = dlg.querySelector('#eUrl').value || '';
    c.bg = dlg.querySelector('#eBg').value || '#ffffff';
    c.color = dlg.querySelector('#eColor').value || '#000000';
    c.newTab = dlg.querySelector('#eTab').checked;
    dlg.remove();
    renderAll();
  };
  document.body.appendChild(dlg);
}

function renderAll(){
  // theme
  applyTheme();
  // brand
  setBrand();
  // lists
  renderGrid();
  renderCardsList();
  // inputs
  updateInputs();
}

// ---------- bindings ----------
$('#saveBtn').onclick = saveToLS;
$('#loadBtn').onclick = ()=>{ loadFromLS(); renderAll(); };
$('#exportBtn').onclick = exportJSON;
$('#importBtn').onclick = ()=> $('#importFile').click();
$('#importFile').onchange = e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); };
$('#resetBtn').onclick = ()=>{ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º?')){ localStorage.removeItem(key); location.reload(); } };
$('#addCard').onclick = ()=>{ state.cards.push({icon:'üÜï', title:'–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞', sub:'–û–ø–∏—Å–∞–Ω–∏–µ', url:'#', newTab:true}); renderAll(); };

// theme inputs
$('#colorBg').oninput = e=>{ state.theme.bg = e.target.value; applyTheme(); };
$('#colorSurface').oninput = e=>{ state.theme.surface = e.target.value; applyTheme(); };
$('#colorPrimary').oninput = e=>{ state.theme.primary = e.target.value; applyTheme(); };
$('#colorText').oninput = e=>{ state.theme.text = e.target.value; applyTheme(); };
$('#inpRadius').oninput = e=>{ state.theme.radius = +e.target.value; applyTheme(); };
$('#inpCols').oninput = e=>{ state.theme.cols = Math.max(1, Math.min(6, +e.target.value||4)); applyTheme(); };

// brand inputs
$('#inpBrandText').oninput = e=>{ state.brand.text = e.target.value; setBrand(); };
$('#inpBrandSize').oninput = e=>{ state.brand.size = +e.target.value||40; setBrand(); };
$('#inpLogo').onchange = e=>{
  const f = e.target.files[0];
  if(!f) return;
  const fr = new FileReader();
  fr.onload = ev=>{ state.brand.logo = ev.target.result; setBrand(); };
  fr.readAsDataURL(f);
};

// init
loadFromLS();
renderAll();

// === HEX <-> normalize ===
function normHex(v){ v=v.trim(); if(!v) return null; if(v[0]!=='#') v='#'+v; if(!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v)) return null; if(v.length===4){v='#'+v[1]+v[1]+v[2]+v[2]+v[3]+v[3]} return v.toUpperCase() }

// === Per-letter logo editor state ===
if(!state.brandLetters){ state.brandLetters = (state.brand.text||'mysale').split('').map(ch=>({ch, color:'#F27C14'})); }

function buildLetterEditor(){
  const box = document.getElementById('letterEditor');
  box.innerHTML = '';
  state.brandLetters.forEach((L, i)=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="dot">${L.ch}</div>
      <div>
        <div style="display:flex; gap:8px; align-items:center">
          <input type="text" data-k="ch" value="${L.ch}" style="width:60px">
          <input type="color" data-k="color" value="${L.color}">
          <input type="text" data-k="hex" value="${L.color}" style="width:100px">
        </div>
      </div>
      <div>
        <button class="ghost" data-up>‚Üë</button>
        <button class="ghost" data-down>‚Üì</button>
        <button class="secondary" data-del>‚úï</button>
      </div>`;
    row.querySelector('[data-k="ch"]').oninput = e=>{ L.ch = (e.target.value||' ').slice(0,1) ; renderBrandLetters(); };
    const color = row.querySelector('[data-k="color"]');
    const hex = row.querySelector('[data-k="hex"]');
    color.oninput = e=>{ L.color = e.target.value; hex.value=L.color; renderBrandLetters(); };
    hex.onchange = e=>{ const v=normHex(e.target.value)||L.color; L.color=v; color.value=v; renderBrandLetters(); };
    row.querySelector('[data-up"]').onclick = ()=>{ if(i>0){ const t=state.brandLetters.splice(i,1)[0]; state.brandLetters.splice(i-1,0,t); buildLetterEditor(); renderBrandLetters(); } };
    row.querySelector('[data-down"]').onclick = ()=>{ if(i<state.brandLetters.length-1){ const t=state.brandLetters.splice(i,1)[0]; state.brandLetters.splice(i+1,0,t); buildLetterEditor(); renderBrandLetters(); } };
    row.querySelector('[data-del"]').onclick = ()=>{ state.brandLetters.splice(i,1); buildLetterEditor(); renderBrandLetters(); };
    box.appendChild(row);
  });
  const add = document.createElement('button'); add.className='ghost'; add.textContent='+ –ë—É–∫–≤–∞';
  add.onclick = ()=>{ state.brandLetters.push({ch:'*', color:'#F27C14'}); buildLetterEditor(); renderBrandLetters(); };
  box.appendChild(add);
}

function renderBrandLetters(){
  const t = state.brandLetters.map(x=>`<span style="color:${x.color};font-weight:900">${x.ch}</span>`).join('');
  document.getElementById('brandText').innerHTML = t || '&nbsp;';
  document.getElementById('brandTextPreview').innerHTML = t || '&nbsp;';
  saveToLS();
}

document.getElementById('toggleLetterEditor').onclick = ()=>{
  const el = document.getElementById('letterEditor');
  el.style.display = el.style.display==='none' ? 'block':'none';
  if(el.style.display==='block') buildLetterEditor();
};

// === Sync HEX text boxes with color pickers ===
function syncHexInputs(){
  colorBgHex.value = state.theme.bg;
  colorSurfaceHex.value = state.theme.surface;
  colorPrimaryHex.value = state.theme.primary;
  colorTextHex.value = state.theme.text;
}
syncHexInputs();

colorBgHex.onchange = e=>{ const v=normHex(e.target.value); if(v){ state.theme.bg=v; colorBg.value=v; applyTheme(); saveToLS(); e.target.value=v; } else e.target.value=state.theme.bg; };
colorSurfaceHex.onchange = e=>{ const v=normHex(e.target.value); if(v){ state.theme.surface=v; colorSurface.value=v; applyTheme(); saveToLS(); e.target.value=v; } else e.target.value=state.theme.surface; };
colorPrimaryHex.onchange = e=>{ const v=normHex(e.target.value); if(v){ state.theme.primary=v; colorPrimary.value=v; applyTheme(); saveToLS(); e.target.value=v; } else e.target.value=state.theme.primary; };
colorTextHex.onchange = e=>{ const v=normHex(e.target.value); if(v){ state.theme.text=v; colorText.value=v; applyTheme(); saveToLS(); e.target.value=v; } else e.target.value=state.theme.text; };

[colorBg,colorSurface,colorPrimary,colorText].forEach(inp=> inp.addEventListener('input', syncHexInputs));

// === Free move inside cards ===
if(!state.freeMove){ state.freeMove=false; }
if(!state.cards.every(c=>c.x&&c.y)){ state.cards.forEach(c=>{ c.x={icon:12,title:62,sub:62}; c.y={icon:16,title:16,sub:44}; }); }

const freeToggle = document.getElementById('freeMoveToggle');
if(freeToggle){
  freeToggle.checked = state.freeMove;
  freeToggle.onchange = ()=>{ state.freeMove = freeToggle.checked; renderAll(); saveToLS(); };
}

const _createCardEl_orig = createCardEl;
createCardEl = function(card, idx){
  const el = _createCardEl_orig(card, idx);
  if(state.freeMove){
    el.classList.add('free');
    const icon = el.querySelector('.icon');
    const title = el.querySelector('.title');
    const sub = el.querySelector('.sub');
    const setPos=(node,k)=>{
      if(!node) return;
      node.style.left = (card.x?.[k]??12)+'px';
      node.style.top  = (card.y?.[k]??12)+'px';
      node.draggable = true;
      node.addEventListener('dragstart',ev=>{
        const r = el.getBoundingClientRect();
        const r2 = node.getBoundingClientRect();
        ev.dataTransfer.setData('text/plain', JSON.stringify({k, dx:ev.clientX-r2.left, dy:ev.clientY-r2.top, ox:r.left, oy:r.top}));
      });
    };
    setPos(icon,'icon'); setPos(title,'title'); setPos(sub,'sub');
    el.addEventListener('dragover',ev=>ev.preventDefault());
    el.addEventListener('drop',ev=>{
      ev.preventDefault();
      const data = JSON.parse(ev.dataTransfer.getData('text/plain')||'{}');
      if(!data.k) return;
      const x = Math.round(ev.clientX - data.ox - data.dx);
      const y = Math.round(ev.clientY - data.oy - data.dy);
      card.x[data.k]=Math.max(0,x); card.y[data.k]=Math.max(0,y);
      saveToLS(); renderAll();
    });
  }
  return el;
};

// Simple undo/redo (snapshot before applyTheme/render heavy ops could be added globally)
if(!window._hist){ window._hist = {u:[], r:[]}; }
function push(){ _hist.u.push(JSON.stringify(state)); _hist.r.length=0; }
function undo2(){ if(!_hist.u.length) return; _hist.r.push(JSON.stringify(state)); state=JSON.parse(_hist.u.pop()); renderAll(); saveToLS(); }
function redo2(){ if(!_hist.r.length) return; _hist.u.push(JSON.stringify(state)); state=JSON.parse(_hist.r.pop()); renderAll(); saveToLS(); }
document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && (e.key==='z' || e.key==='Z')){ e.preventDefault(); undo2(); }
  if(e.ctrlKey && (e.key==='y' || e.key==='Y')){ e.preventDefault(); redo2(); }
});

</script>
</body>
</html>
