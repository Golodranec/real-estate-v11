<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MySale ‚Äî –≤–∏—Ç—Ä–∏–Ω–∞ (–∞–¥–º–∏–Ω v3)</title>
<style>
  :root{
    --bg:#f7e2ca;
    --accent:#f47b0a;
    --card:#fff4e8;
    --text:#2b2b2b;
    --radius:18px;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  .toolbar{
    position:sticky;top:0;z-index:10;
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    padding:14px 16px;
    background:linear-gradient(180deg,#fff8f0,rgba(255,248,240,.8));
    border-bottom:1px solid #f0d6b9;
    backdrop-filter:saturate(1.1) blur(4px);
  }
  .toolbar .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:0;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);
       border-radius:10px;padding:9px 12px;cursor:pointer;font-weight:600}
  .btn:hover{background:#fff7ef}
  .switch{display:inline-flex;gap:8px;align-items:center;font-weight:600}
  .switch input{accent-color:var(--accent);transform:scale(1.1)}

  .page{max-width:1120px;margin:28px auto;padding:0 16px}
  /* LOGO */
  .logo-wrap{display:flex;gap:14px;align-items:center;margin:8px 0 18px}
  .logo-img{
    width:56px;height:56px;border-radius:14px;
    background:transparent; /* –≤–∞–∂–Ω–æ –¥–ª—è PNG –±–µ–∑ —Ñ–æ–Ω–∞ */
    display:grid;place-items:center;overflow:hidden;
    box-shadow:0 6px 18px rgba(0,0,0,.07);
  }
  .logo-img img{max-width:100%;max-height:100%;display:block;}

  .brand{display:flex;gap:2px;align-items:flex-end;flex-wrap:wrap}
  .brand .letter{
    font-weight:900;font-size:44px;line-height:1;
    letter-spacing:.5px; cursor:pointer; user-select:none;
  }
  .brand .letter[contenteditable="true"]{outline:2px dashed rgba(0,0,0,.1);outline-offset:4px;border-radius:6px;padding:2px 4px}

  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:18px}
  @media (max-width:960px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
  .card{
    position:relative;
    border-radius:var(--radius);
    background:var(--card);
    padding:16px;
    box-shadow:0 10px 20px rgba(0,0,0,.06), inset 0 0 0 1px rgba(244,123,10,.06);
    min-height:140px;
    overflow:hidden;
  }
  .card .movable{
    position:relative; /* switches to absolute in ‚Äúfree move‚Äù mode */
    display:inline-flex; gap:6px; align-items:center;
    padding:3px 6px;
    border-radius:8px;
  }
  .card .movable[data-type="icon"]{font-size:34px}
  .card .movable[data-type="title"]{font-weight:800;font-size:18px}
  .card .movable[data-type="hint"]{font-size:12px;opacity:.7}

  .card.free .movable{
    position:absolute; 
    cursor:grab;
    background:rgba(255,255,255,.7);
    box-shadow:0 3px 10px rgba(0,0,0,.06);
  }
  .ghost{opacity:.6}
  .small{font-size:12px;opacity:.8}
  .stack-ind{margin-left:8px;font-size:12px;opacity:.7}

  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .col{display:flex;flex-direction:column;gap:6px}
  input[type="text"],input[type="url"],input[type="number"]{
    padding:8px 10px;border-radius:10px;border:1px solid #efd0b0;background:#fff;min-width:180px
  }
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;
        background:#fff;border:1px solid #efd0b0}
  .colorbox{display:flex;align-items:center;gap:6px}
  .colorbox input[type="color"]{width:34px;height:34px;border:0;padding:0;background:none}
  .colorbox input[type="text"]{width:88px}
  .muted{opacity:.7}
</style>
</head>
<body>
  <div class="toolbar">
    <div class="group">
      <button class="btn" id="undoBtn">Undo</button>
      <button class="btn" id="redoBtn">Redo</button>
      <span class="stack-ind" id="stackInfo"></span>
    </div>
    <div class="group">
      <label class="switch"><input type="checkbox" id="moveToggle"> –°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</label>
    </div>
    <div class="group">
      <label class="chip">–§–æ–Ω HEX <input id="bgHex" type="text" value="#f7e2ca"></label>
      <span class="muted">–∏–ª–∏</span>
      <label class="chip">RGB 
        <input id="bgR" type="number" min="0" max="255" value="247">
        <input id="bgG" type="number" min="0" max="255" value="226">
        <input id="bgB" type="number" min="0" max="255" value="202">
      </label>
    </div>
  </div>

  <div class="page">
    <div class="logo-wrap">
      <div class="logo-img">
        <img id="logoImg" alt="logo">
      </div>
      <div class="col">
        <div class="row">
          <label class="chip">PNG –ª–æ–≥–æ—Ç–∏–ø
            <input id="logoFile" type="file" accept=".png,.svg,.webp,.jpg,.jpeg">
          </label>
          <label class="chip">–†–∞–∑–º–µ—Ä <input id="logoSize" type="number" min="28" max="160" value="56">px</label>
          <span class="muted">–§–æ–Ω –ª–æ–≥–æ—Ç–∏–ø–∞ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π.</span>
        </div>
        <div class="row brand" id="brand">
          <!-- –±—É–∫–≤—ã –±—Ä–µ–Ω–¥–∞ (–æ—Ç–¥–µ–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ) -->
        </div>
        <div id="brandColors" class="row"></div>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

<script>
const $ = (s,root=document)=>root.querySelector(s);
const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

// ====== STATE & UNDO/REDO ======
const STORAGE_KEY = "mysale_admin_v3_state";
let state = {
  bg:"#f7e2ca",
  brand:[{ch:"m",color:"#ff7a00"},{ch:"y",color:"#ff7a00"},{ch:"s",color:"#ff7a00"},{ch:"a",color:"#ff7a00"},{ch:"l",color:"#ff7a00"},{ch:"e",color:"#ff7a00"}],
  logo:{src:"", size:56},
  freeMove:false,
  cards:[
    {icon:"üè†",title:"–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å",hint:"Real Estate", x:{icon:12,title:62,hint:62}, y:{icon:16,title:16,hint:44}, href:"#"},
    {icon:"üöó",title:"–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç",   hint:"Cars",        x:{icon:12,title:62,hint:62}, y:{icon:16,title:16,hint:44}, href:"#"},
    {icon:"üíª",title:"–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞", hint:"Electronics",x:{icon:12,title:62,hint:62}, y:{icon:16,title:16,hint:44}, href:"#"},
    {icon:"üß∞",title:"–£—Å–ª—É–≥–∏",      hint:"Services",   x:{icon:12,title:62,hint:62}, y:{icon:16,title:16,hint:44}, href:"#"},
    {icon:"üõã",title:"–ú–µ–±–µ–ª—å",      hint:"Furniture",  x:{icon:12,title:62,hint:62}, y:{icon:16,title:16,hint:44}, href:"#"},
    {icon:"üëï",title:"–ú–æ–¥–∞",        hint:"Fashion",    x:{icon:12,title:62,hint:62}, y:{icon:16,title:16,hint:44}, href:"#"},
    {icon:"üö≤",title:"–•–æ–±–±–∏",       hint:"Hobbies",    x:{icon:12,title:62,hint:62}, y:{icon:16,title:16,hint:44}, href:"#"},
    {icon:"üíº",title:"–†–∞–±–æ—Ç–∞",      hint:"Jobs",       x:{icon:12,title:62,hint:62}, y:{icon:16,title:16,hint:44}, href:"#"},
  ]
};

// Undo/Redo stacks
let undoStack = [];
let redoStack = [];
function pushHistory(){
  undoStack.push(JSON.stringify(state));
  redoStack.length = 0; // clear redo on new action
  updateStackInfo();
}
function undo(){
  if(!undoStack.length) return;
  redoStack.push(JSON.stringify(state));
  state = JSON.parse(undoStack.pop());
  save(); render();
  updateStackInfo();
}
function redo(){
  if(!redoStack.length) return;
  undoStack.push(JSON.stringify(state));
  state = JSON.parse(redoStack.pop());
  save(); render();
  updateStackInfo();
}
function updateStackInfo(){
  $('#stackInfo').textContent = `‚Ü∂ ${undoStack.length} ¬∑ ${redoStack.length} ‚Ü∑`;
}

// ====== STORAGE ======
function load(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    if(s) state = {...state, ...JSON.parse(s)};
  }catch(e){console.warn(e)}
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// ====== HELPERS ======
function hexToRgb(hex){
  hex = hex.replace('#','');
  if(hex.length===3) hex = hex.split('').map(x=>x+x).join('');
  const int = parseInt(hex,16);
  return {r:(int>>16)&255,g:(int>>8)&255,b:int&255};
}
function rgbToHex(r,g,b){
  const toHex=x=>('0'+Math.max(0,Math.min(255,x)).toString(16)).slice(-2);
  return '#'+toHex(r)+toHex(g)+toHex(b);
}

// ====== RENDER ======
function render(){
  // bg
  document.documentElement.style.setProperty('--bg', state.bg);
  const {r,g,b} = hexToRgb(state.bg);
  bgHex.value = state.bg.toLowerCase();
  bgR.value=r; bgG.value=g; bgB.value=b;

  // move mode
  $('#moveToggle').checked = !!state.freeMove;

  // logo
  if(state.logo.src){
    $('#logoImg').src = state.logo.src;
  }else{
    $('#logoImg').src = '';
  }
  $('.logo-img').style.width = state.logo.size+'px';
  $('.logo-img').style.height = state.logo.size+'px';

  // brand
  const brand = $('#brand');
  brand.innerHTML='';
  state.brand.forEach((b,i)=>{
    const span = document.createElement('span');
    span.className='letter';
    span.style.color=b.color;
    span.textContent=b.ch;
    span.dataset.index=i;
    span.title='–ö–ª–∏–∫–Ω–∏—Ç–µ 2 —Ä–∞–∑–∞, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—É–∫–≤—É';
    span.addEventListener('dblclick',()=>{
      span.contentEditable = "true";
      span.focus();
    });
    span.addEventListener('blur',()=>{
      span.contentEditable = "false";
      const ch = span.textContent.trim().slice(0,1)||'¬∑';
      if(state.brand[i].ch!==ch){ pushHistory(); state.brand[i].ch=ch; save(); }
      span.textContent = state.brand[i].ch;
    });
    brand.appendChild(span);
  });

  // brand color controls
  const bc = $('#brandColors'); bc.innerHTML='';
  state.brand.forEach((b,i)=>{
    const box = document.createElement('label');
    box.className='colorbox';
    box.innerHTML = `
      <span class="small">–ë—É–∫–≤–∞ ${i+1}</span>
      <input type="color" value="${b.color}">
      <input type="text" value="${b.color.toLowerCase()}">
    `;
    const [picker,hex] = box.querySelectorAll('input');
    picker.addEventListener('input',e=>{
      pushHistory();
      state.brand[i].color = e.target.value;
      save(); render();
    });
    hex.addEventListener('change',e=>{
      let v = e.target.value.trim();
      if(!/^#?[0-9a-f]{3}([0-9a-f]{3})?$/i.test(v)) { e.target.value = state.brand[i].color; return; }
      if(v[0]!=='#') v = '#'+v;
      pushHistory();
      state.brand[i].color = v;
      save(); render();
    });
    bc.appendChild(box);
  });

  // cards
  const grid = $('#grid'); grid.innerHTML='';
  state.cards.forEach((c,idx)=>{
    const card = document.createElement('div');
    card.className='card'+(state.freeMove?' free':'');

    const icon = document.createElement('div');
    icon.className='movable'; icon.dataset.type='icon'; icon.textContent=c.icon;
    const title = document.createElement('div');
    title.className='movable'; title.dataset.type='title'; title.textContent=c.title;
    title.contentEditable = "true";
    title.addEventListener('blur', ()=>{ 
      const v = title.textContent.trim(); if(v!==c.title){ pushHistory(); c.title=v; save(); }
    });
    const hint = document.createElement('div');
    hint.className='movable'; hint.dataset.type='hint'; hint.textContent=c.hint;
    hint.contentEditable="true";
    hint.addEventListener('blur', ()=>{
      const v = hint.textContent.trim(); if(v!==c.hint){ pushHistory(); c.hint=v; save(); }
    });

    // position for free move
    ['icon','title','hint'].forEach(k=>{
      const el = (k==='icon'?icon:k==='title'?title:hint);
      if(state.freeMove){
        el.style.left = (c.x?.[k]??12)+'px';
        el.style.top  = (c.y?.[k]??12)+'px';
      }else{
        el.style.left=''; el.style.top='';
      }
    });

    // dragging in free move mode
    if(state.freeMove){
      [icon,title,hint].forEach(el=>{
        el.draggable=true;
        el.addEventListener('dragstart',ev=>{
          el.classList.add('ghost');
          const rect = card.getBoundingClientRect();
          const r2 = el.getBoundingClientRect();
          ev.dataTransfer.setData('text/plain', JSON.stringify({
            type: el.dataset.type,
            dx: ev.clientX - r2.left,
            dy: ev.clientY - r2.top,
            rect: {x:rect.left,y:rect.top}
          }));
        });
        el.addEventListener('dragend',()=>el.classList.remove('ghost'));
      });
      card.addEventListener('dragover',ev=>ev.preventDefault());
      card.addEventListener('drop',ev=>{
        ev.preventDefault();
        const data = JSON.parse(ev.dataTransfer.getData('text/plain'));
        const type = data.type;
        const x = ev.clientX - data.rect.x - data.dx;
        const y = ev.clientY - data.rect.y - data.dy;
        // clamp
        const cr = card.getBoundingClientRect();
        const maxX = cr.width - 20, maxY = cr.height - 20;
        pushHistory();
        c.x[type] = Math.max(0,Math.min(maxX, Math.round(x)));
        c.y[type] = Math.max(0,Math.min(maxY, Math.round(y)));
        save(); render();
      });
    }

    // link
    const link = document.createElement('a');
    link.href = c.href || '#';
    link.target = "_blank";
    link.className='small'; link.textContent='–°—Å—ã–ª–∫–∞';
    link.style.position='absolute'; link.style.right='12px'; link.style.bottom='10px';

    // reorder support: drag whole card
    card.draggable=true;
    card.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain', idx);
      setTimeout(()=>card.classList.add('ghost'),0);
    });
    card.addEventListener('dragend',()=>card.classList.remove('ghost'));
    card.addEventListener('dragover',e=>e.preventDefault());
    card.addEventListener('drop',e=>{
      e.preventDefault();
      const from = +e.dataTransfer.getData('text/plain');
      const to = idx;
      if(from===to) return;
      pushHistory();
      const item = state.cards.splice(from,1)[0];
      state.cards.splice(to,0,item);
      save(); render();
    });

    card.appendChild(icon);
    card.appendChild(title);
    card.appendChild(hint);
    card.appendChild(link);
    grid.appendChild(card);
  });
}

// ====== UI BINDINGS ======
$('#undoBtn').addEventListener('click',undo);
$('#redoBtn').addEventListener('click',redo);

$('#moveToggle').addEventListener('change',e=>{
  pushHistory();
  state.freeMove = e.target.checked;
  save(); render();
});

// background (HEX + RGB sync)
const bgHex = $('#bgHex'), bgR=$('#bgR'), bgG=$('#bgG'), bgB=$('#bgB');
bgHex.addEventListener('change',e=>{
  let v = e.target.value.trim();
  if(!/^#?[0-9a-f]{3}([0-9a-f]{3})?$/i.test(v)) { e.target.value = state.bg; return; }
  if(v[0]!=='#') v = '#'+v;
  pushHistory();
  state.bg=v; save(); render();
});
[bgR,bgG,bgB].forEach(inp=>{
  inp.addEventListener('input',()=>{
    const r=+bgR.value||0, g=+bgG.value||0, b=+bgB.value||0;
    pushHistory();
    state.bg = rgbToHex(r,g,b);
    save(); render();
  });
});

// logo upload & size
$('#logoFile').addEventListener('change',e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    pushHistory();
    state.logo.src = String(ev.target.result);
    save(); render();
  };
  reader.readAsDataURL(f);
});
$('#logoSize').addEventListener('input',e=>{
  pushHistory();
  state.logo.size = Math.max(28, Math.min(160, +e.target.value||56));
  save(); render();
});

// bootstrap
function init(){
  try{
    const s = localStorage.getItem("mysale_admin_v3_state");
    if(s){ state = {...state, ...JSON.parse(s)} }
  }catch(e){}
  render(); $('#stackInfo').textContent = '‚Ü∂ 0 ¬∑ 0 ‚Ü∑';
}
init();
</script>
</body>
</html>