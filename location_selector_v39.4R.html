<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>location_selector v39.4R — площадь в центре + размеры рёбер только в режиме редактирования</title>

<!-- Leaflet + плагины -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<!-- localForage -->
<script src="https://unpkg.com/localforage@1.10.0/dist/localforage.js"></script>

<style>
:root{--bg:#0b0f16;--panel:#121826;--panel2:#172133;--panel3:#0f1624;--border:#273248;--text:#d7e2f2;--muted:#9fb0c8;--accent:#4aa8ff;--danger:#ef4444;--overlay:rgba(10,14,22,.75)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0e1420;border-bottom:1px solid var(--border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#1a2234;color:var(--text);cursor:pointer}
button:hover{border-color:var(--accent)}
button.danger{background:#3a0f15;border-color:#7f1d1d;color:#fecaca}
.badge{background:#23314d;border:1px solid #334567;border-radius:8px;padding:3px 8px;font-weight:700}
.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);background:#121826}
.tab{padding:6px 12px;background:#1a2234;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.tab.active{background:#2160ff;color:#fff}
main{display:grid;grid-template-columns:460px 1fr;height:calc(100vh - 94px)}
.sidebar{padding:10px;border-right:1px solid var(--border);background:#121826;overflow:auto}
.panel{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
h3,h4{margin:0 0 8px 0}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #31405a;background:#0f1624;color:#e7f1ff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.list{display:grid;gap:6px}
.item{border:1px solid var(--border);border-radius:8px;padding:10px;background:#111a2a}
.item-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.item .left{display:grid;gap:2px}
.item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.item .meta{color:var(--muted);font-size:12px}
.tools{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.sep{height:1px;background:#243048;margin:8px 0}
.help{font-size:12px;color:#9fb0c8}
.note{background:#0e1524;border:1px dashed #32405a;padding:8px;border-radius:8px;color:#9fb0c8}
.note.gray{opacity:.6}
#map{width:100%;height:100%;position:relative}
.preview-icon{width:20px;height:20px;border-radius:4px;border:1px solid #31405a;background:#0f1624;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview-icon img{max-width:100%;max-height:100%;display:block}

/* поиск по элементам */
#globalSearch{width:100%;padding:6px 8px;margin-bottom:8px;border-radius:6px;border:1px solid var(--border);background:#0f1624;color:#fff}
.search-results{max-height:200px;overflow:auto;margin-top:6px}
.search-results div{padding:4px 6px;border-bottom:1px solid var(--border);cursor:pointer}
.search-results div:hover{background:#1f293d}

/* сворачивание секций */
.collapse-head{display:flex;align-items:center;gap:8px;cursor:pointer}
.caret{width:22px;height:22px;border:1px solid var(--border);border-radius:6px;background:#1a2234;display:flex;align-items:center;justify-content:center}
.caret::after{content:"▾";font-size:12px;line-height:1}
.collapsed .caret::after{content:"▸"}
.section-body{margin-top:8px}
.collapsed .section-body{display:none}

/* модалки */
.modal-overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:5000}
.modal{width:min(980px,90vw);max-height:85vh;background:var(--panel);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;overflow:hidden}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);background:var(--panel3)}
.modal-title{font-weight:700}
.modal-close{border:1px solid var(--border);background:#1a2234;border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.modal-body{padding:12px 14px;overflow:auto}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border);background:var(--panel3)}
.modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
@media (max-width:1024px){.modal-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:640px){.modal-grid{grid-template-columns:1fr}}
.modal-item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #1f2a40;border-radius:8px;background:#0f1624}
.modal-item input[type="checkbox"]{appearance:none;-webkit-appearance:none;width:16px;height:16px;border:2px solid var(--accent);border-radius:4px;background:#1a2234;cursor:pointer;position:relative;flex:0 0 16px}
.modal-item input[type="checkbox"]:checked{background:var(--accent);border-color:var(--accent)}
.modal-item input[type="checkbox"]:checked::after{content:"✔";position:absolute;top:-2px;left:2px;font-size:14px;color:#fff}

/* подсказки */
.suggestions{position:absolute;background:var(--panel2);border:1px solid var(--border);border-radius:8px;z-index:3000;max-height:200px;overflow:auto;width:100%}
.suggestions div{padding:6px 8px;cursor:pointer}
.suggestions div:hover{background:#1f293d}

/* drag */
.draggable{cursor:grab}
.dragging{opacity:.5}
.dropzone-hover{outline:2px dashed var(--accent);outline-offset:4px}

/* плавающее окно координат */
.coord-tool{position:absolute;z-index:4000;display:grid;gap:6px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px;width:260px}
.coord-tool h4{margin:0 0 6px 0;font-size:14px;cursor:move;user-select:none}
.coord-tool .row{display:flex;gap:6px}
.coord-tool .row input{flex:1}
.coord-tool .row button{white-space:nowrap}
.coord-tool .help{font-size:12px;color:var(--muted)}

/* новая кнопка мультиселекта */
.multi-select-btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#1a2234;color:var(--text);cursor:pointer}
.multi-select-btn:hover{border-color:var(--accent);background:#212b41}

/* центр. метка площади */
.poly-center-label{background:rgba(10,14,22,.85);color:#fff;padding:4px 8px;border-radius:8px;font-size:14px;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.35)}
/* метки длин рёбер */
.poly-edge-label{background:rgba(33,96,255,.9);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px;font-weight:700;white-space:nowrap}
</style>
</head>
<body>
<header>
  <span class="badge">location_selector v39.4R</span>
  <button id="btnExport">Экспорт (всё)</button>
  <button id="btnImport">Импорт (всё)</button>
  <input type="file" id="fileImport" accept=".json,.txt" style="display:none"/>
  <button id="btnInfo">Инфо</button>
  <button id="btnUndo">Undo</button>
  <button id="btnRedo">Redo</button>
  <button id="btnReset" class="danger">Сброс</button>

  <span style="margin-left:12px" class="badge">Инструменты</span>
  <button id="btnMeasure">Линейка</button>
  <button id="btnDrawPoint">Точка</button>
  <button id="btnDrawLine">Линия</button>
</header>

<div class="tabs">
  <div class="tab active" data-tab="editor">Редактор</div>
  <div class="tab" data-tab="preview">Предпросмотр</div>
</div>

<main>
  <aside class="sidebar" id="editorTab"></aside>
  <aside class="sidebar" id="previewTab" style="display:none">
    <div class="panel">
      <h3>Предпросмотр каскада</h3>
      <input id="globalSearch" placeholder="Поиск по элементам..."/>
      <div id="searchResults" class="search-results"></div>
      <div class="row">
        <button id="btnSelectAll">Выбрать всё</button>
        <button id="btnClearAll" class="danger">Сбросить всё</button>
      </div>
      <div class="help">Чекбокс-категории открываются в большом списке как на Авито. Внутри тоже есть «Выбрать всё / Сбросить всё».</div>
      <div id="cascadeBox" style="margin-top:8px"></div>

      <div class="sep"></div>
      <h3>Полигоны</h3>
      <div class="row">
        <input id="polyName" placeholder="Название полигона"/>
        <input type="color" id="polyColor" value="#ff4d4f"/>
      </div>
      <div class="row">
        <button id="btnPolyNew">Новый</button>
        <button id="btnPolyEdit">Редактировать</button>
        <button id="btnPolyStop">Стоп</button>
        <button id="btnPolyUndo">Undo</button>
        <button id="btnPolyRedo">Redo</button>
      </div>

      <!-- Новый переключатель: показывать размеры рёбер (только в режиме редактирования) -->
      <label style="display:flex;align-items:center;gap:8px;margin-top:8px">
        <input type="checkbox" id="chkShowEdges"/>
        Показать размеры (длины рёбер) при редактировании
      </label>

      <input id="polySearch" placeholder="Поиск по полигонам..."/>
      <div id="polyList" class="list"></div>
    </div>
  </aside>
  <div id="map"></div>
</main>

<!-- Модалки (иконки/инфо/импорт) опущены для краткости версии, функционал не изменён -->

<!-- Скрипты карт -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil@0.10.2/src/leaflet.geometryutil.js"></script>

<script>
/* ===== БАЗА ХРАНИЛИЩА (как в v39.3R) ===== */
const KEY="dict_v38_3R"; // сохраняем совместимость
const lfIcons=localforage.createInstance({name:"dict_icons_v383R"});
const lfGeo=localforage.createInstance({name:"dict_geo_v383R"});

function uid(){return Math.random().toString(36).slice(2,9);}
function normalize(obj){
  if(!obj||typeof obj!=="object")obj={categories:[],polygons:[]};
  if(!Array.isArray(obj.categories)) obj.categories=[];
  if(!Array.isArray(obj.polygons)) obj.polygons=[];
  obj.categories.forEach(c=>{
    if(!("id" in c))c.id=uid();
    if(!("type" in c))c.type="select";
    if(!("items" in c))c.items=[];
    if(!("color" in c))c.color="#3388ff";
    if(!("shape" in c))c.shape="circle";
    if(!("parentCategoryId" in c))c.parentCategoryId=null;
    (c.items||[]).forEach(it=>{
      if(!("id" in it))it.id=uid();
      if(!("name" in it))it.name="Без имени";
      if(!("lat" in it))it.lat=null;
      if(!("lng" in it))it.lng=null;
      if(!("parentId" in it))it.parentId=null;
    });
  });
  obj.polygons.forEach(p=>{
    if(!("id" in p))p.id=uid();
    if(!("name" in p))p.name="Полигон";
    if(!("color" in p))p.color="#ff4d4f";
    if(!("visible" in p))p.visible=true;
  });
}
async function save(obj=db){
  normalize(obj);
  const lite={
    categories:obj.categories.map(c=>({
      id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId,
      color:c.color,shape:c.shape,iconKey:c.iconKey||null,
      items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))
    })),
    polygons:obj.polygons.map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
  };
  localStorage.setItem(KEY,JSON.stringify(lite));
  for(const cat of obj.categories){
    if(cat.iconData){ const key=cat.iconKey||`cat_${cat.id}`; await lfIcons.setItem(key,cat.iconData); cat.iconKey=key; }
    for(const it of (cat.items||[])){
      if(it.iconData){ const key=it.iconKey||`item_${it.id}`; await lfIcons.setItem(key,it.iconData); it.iconKey=key; }
    }
  }
  for(const p of obj.polygons){ if(p.geojson) await lfGeo.setItem(p.id,p.geojson); }
}
async function loadDB(){
  const raw=localStorage.getItem(KEY);
  let obj={categories:[],polygons:[]};
  if(raw){ try{ obj=JSON.parse(raw)||{}; }catch(e){} }
  normalize(obj);
  for(const cat of obj.categories){
    if(cat.iconKey&&!cat.iconData){ try{cat.iconData=await lfIcons.getItem(cat.iconKey)||null;}catch(e){} }
    for(const it of (cat.items||[])){
      if(it.iconKey&&!it.iconData){ try{it.iconData=await lfIcons.getItem(it.iconKey)||null;}catch(e){} }
    }
  }
  for(const p of obj.polygons){ if(!p.geojson){ try{p.geojson=await lfGeo.getItem(p.id)||null;}catch(e){} } }
  return obj;
}

/* ===== КАРТА ===== */
let map=L.map('map').setView([41.3111,69.2797],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let cluster=L.markerClusterGroup(); map.addLayer(cluster);
function clearMarkers(){cluster.clearLayers();}

/* ===== ПОЛИГОНЫ ===== */
const polyFG=new L.FeatureGroup(); map.addLayer(polyFG);
const polyIndex=new Map();
/* Центральные подписи площади */
const polyCenterLabels=new Map();
/* Подписи длин рёбер активного полигона */
let edgeLabels=[]; // массив L.marker
let polyEditing=false, polyEditToolbar=null, polyEditingTargetId=null;
/* чекбокс "Показать размеры" */
let showEdges=false;
const $chkShowEdges=document.getElementById('chkShowEdges');
$chkShowEdges.addEventListener('change',()=>{
  showEdges=$chkShowEdges.checked;
  refreshEdgeLabels();
});

function formatArea(m2){ return m2>1e6 ? (m2/1e6).toFixed(2)+' км²' : Math.round(m2)+' м²'; }
function formatLen(m){ return m>1000 ? (m/1000).toFixed(2)+' км' : Math.round(m)+' м'; }

function layerFromGeo(geo,c){ let l=null; L.geoJSON(geo,{style:{color:c||'#ff4d4f',weight:2,fillOpacity:.12}}).eachLayer(x=>l=x); return l; }

function rebuildPolys(){
  // очистка
  polyIndex.clear(); polyFG.clearLayers();
  for(const [id,lbl] of polyCenterLabels){ map.removeLayer(lbl); }
  polyCenterLabels.clear();
  clearEdgeLabels();

  for(const p of db.polygons){
    if(!p.geojson) continue;
    const l=layerFromGeo(p.geojson,p.color); if(!l) continue;
    polyFG.addLayer(l); polyIndex.set(p.id,l);
    if(p.visible===false) map.removeLayer(l);
    setCenterLabel(p);
  }
  updatePolygonVisibility();
}

/* === Центральная метка площадей: "<Название> + S=XXX м²" === */
function setCenterLabel(p){
  const layer=polyIndex.get(p.id); if(!layer||!layer.getBounds) return;
  // извлекаем координаты первого контура
  const rings = (layer.getLatLngs()[0]||[]);
  if(!rings.length) return;
  const area = L.GeometryUtil.geodesicArea(rings);
  const txt  = `${p.name||'Полигон'} + S=${formatArea(area)}`;

  const pos=layer.getBounds().getCenter();
  let lbl=polyCenterLabels.get(p.id);
  if(!lbl){
    lbl=L.marker(pos,{interactive:false,icon:L.divIcon({className:"",html:`<div class="poly-center-label">${txt}</div>`})}).addTo(map);
    polyCenterLabels.set(p.id,lbl);
  }else{
    lbl.setLatLng(pos);
    if(lbl._icon) lbl._icon.innerHTML = `<div class="poly-center-label">${txt}</div>`;
  }
}

/* === Подписи длин рёбер для активного полигона (только при редактировании) === */
function clearEdgeLabels(){
  edgeLabels.forEach(m=>{ try{ map.removeLayer(m); }catch(_){ } });
  edgeLabels=[];
}
function refreshEdgeLabels(){
  clearEdgeLabels();
  if(!polyEditing || !showEdges || !polyEditingTargetId) return;
  const l=polyIndex.get(polyEditingTargetId);
  if(!l) return;
  const rings=l.getLatLngs()[0]||[];
  if(rings.length<2) return;

  for(let i=0;i<rings.length-1;i++){
    const a=rings[i], b=rings[i+1];
    const mid=L.latLng( (a.lat+b.lat)/2, (a.lng+b.lng)/2 );
    const segLen = L.latLng(a).distanceTo(L.latLng(b));
    const m = L.marker(mid,{interactive:false,icon:L.divIcon({className:"",html:`<div class="poly-edge-label">${formatLen(segLen)}</div>`})}).addTo(map);
    edgeLabels.push(m);
  }
  // если полигон замкнут, последний сегмент между последней и первой точкой
  if(rings.length>2){
    const a=rings[rings.length-1], b=rings[0];
    const mid=L.latLng( (a.lat+b.lat)/2, (a.lng+b.lng)/2 );
    const segLen = L.latLng(a).distanceTo(L.latLng(b));
    const m = L.marker(mid,{interactive:false,icon:L.divIcon({className:"",html:`<div class="poly-edge-label">${formatLen(segLen)}</div>`})}).addTo(map);
    edgeLabels.push(m);
  }
}

/* === История по полигонам (локальная) === */
const historyById=new Map();
function getHistoryPoly(id){ if(!historyById.has(id)) historyById.set(id,{stack:[],index:-1}); return historyById.get(id); }
function pushHistoryPoly(p){
  const h=getHistoryPoly(p.id);
  const snap=JSON.parse(JSON.stringify(p.geojson));
  if(h.index<h.stack.length-1) h.stack.splice(h.index+1);
  h.stack.push(snap); h.index=h.stack.length-1;
}
function applyHistoryPoly(p,dir){
  const h=getHistoryPoly(p.id), next=h.index+dir;
  if(next<0||next>=h.stack.length) return false;
  h.index=next; const snap=h.stack[h.index];
  p.geojson=JSON.parse(JSON.stringify(snap));
  const old=polyIndex.get(p.id); if(old) polyFG.removeLayer(old);
  const l=layerFromGeo(p.geojson,p.color); polyFG.addLayer(l); polyIndex.set(p.id,l);
  if(p.visible===false) map.removeLayer(l);
  setCenterLabel(p);
  if(p.id===polyEditingTargetId) refreshEdgeLabels();
  return true;
}

/* === РЕНДЕР СПИСКА ПОЛИГОНОВ === */
const $polyList=document.getElementById('polyList');
const $polyName=document.getElementById('polyName');
const $polyColor=document.getElementById('polyColor');
const $polySearch=document.getElementById('polySearch');

function renderPolyList(){
  const q=($polySearch?.value||"").trim().toLowerCase();
  const prevScroll=$polyList.scrollTop; $polyList.innerHTML='';

  db.polygons.filter(p=>!q || (p.name||'').toLowerCase().includes(q)).forEach(p=>{
    const wrapper=document.createElement('div'); wrapper.className='item';
    const head=document.createElement('div'); head.className='item-row';
    const left=document.createElement('div'); left.className='left';
    const name=document.createElement('div'); name.className='name'; name.textContent=p.name||'Полигон';
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`id: ${p.id}`;
    left.append(name,meta);

    const tools=document.createElement('div'); tools.className='tools';
    const color=document.createElement('input'); color.type='color'; color.value=p.color||'#ff4d4f';
    color.onchange=async()=>{ p.color=color.value; const l=polyIndex.get(p.id); if(l&&l.setStyle) l.setStyle({color:p.color}); await save(db); setCenterLabel(p); };
    const toggle=document.createElement('button'); toggle.textContent=p.visible!==false?'Скрыть':'Показать';
    toggle.onclick=async()=>{ p.visible=!(p.visible!==false); const l=polyIndex.get(p.id); if(l){ if(p.visible) l.addTo(map); else map.removeLayer(l);} await save(db); setCenterLabel(p); };
    const focus=document.createElement('button'); focus.textContent='Фокус';
    focus.onclick=()=>{ const l=polyIndex.get(p.id); if(l){ l.addTo(map); map.fitBounds(l.getBounds()); } };
    const editBtn=document.createElement('button'); editBtn.textContent='Редактировать';
    editBtn.onclick=()=>startPolyEditing(p.id);
    const del=document.createElement('button'); del.textContent='❌'; del.className='danger';
    del.onclick=async()=>{ if(!confirm('Удалить полигон?')) return;
      const l=polyIndex.get(p.id); if(l) polyFG.removeLayer(l); polyIndex.delete(p.id);
      db.polygons=db.polygons.filter(x=>x.id!==p.id); await lfGeo.removeItem(p.id); await save(db);
      const lbl=polyCenterLabels.get(p.id); if(lbl){ map.removeLayer(lbl); polyCenterLabels.delete(p.id); }
      if(polyEditingTargetId===p.id) stopPolyEditing();
      renderPolyList();
    };
    tools.append(color,toggle,focus,editBtn,del);
    head.append(left,tools);
    wrapper.append(head);
    $polyList.appendChild(wrapper);
  });
  $polyList.scrollTop=prevScroll;
}
$polySearch.oninput=renderPolyList;

/* === СОЗДАНИЕ/РЕДАКТИРОВАНИЕ === */
document.getElementById('btnPolyNew').onclick=()=>{
  new L.Draw.Polygon(map,{shapeOptions:{color:$polyColor.value||'#ff4d4f',weight:2,fillOpacity:.12}}).enable();
};
document.getElementById('btnPolyEdit').onclick=()=>{ if(!polyEditing) { enableEditToolbar(); } };
document.getElementById('btnPolyStop').onclick=stopPolyEditing;
document.getElementById('btnPolyUndo').onclick=()=>{
  if(!polyEditingTargetId) return; const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
  if(applyHistoryPoly(p,-1)){ save(db).then(()=>{ renderPolyList(); }); }
};
document.getElementById('btnPolyRedo').onclick=()=>{
  if(!polyEditingTargetId) return; const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
  if(applyHistoryPoly(p,+1)){ save(db).then(()=>{ renderPolyList(); }); }
};

function enableEditToolbar(){
  polyEditToolbar=new L.EditToolbar.Edit(map,{featureGroup:polyFG});
  polyEditToolbar.enable(); polyEditing=true;
}
function stopPolyEditing(){
  if(polyEditing&&polyEditToolbar){ polyEditToolbar.disable(); polyEditing=false; map.fire(L.Draw.Event.EDITSTOP); }
  polyEditingTargetId=null; clearEdgeLabels();
}
function startPolyEditing(id){
  const l=polyIndex.get(id);
  if(!l) return;
  if(!polyEditing) enableEditToolbar();
  polyFG.eachLayer(x=>{
    if(x===l){ if(x.editing && !x.editing._enabled) x.editing.enable(); }
    else{ if(x.editing && x.editing._enabled) x.editing.disable(); }
  });
  polyEditingTargetId=id;
  refreshEdgeLabels();
  const p=db.polygons.find(x=>x.id===id);
  if(p) setCenterLabel(p);
}

map.on(L.Draw.Event.CREATED,async e=>{
  if(e.layerType==="polygon" && (e.layer instanceof L.Polygon)){
    const layer=e.layer; layer.setStyle({color:$polyColor.value||'#ff4d4f',weight:2,fillOpacity:.12});
    polyFG.addLayer(layer);
    const rec={id:uid(),name:($polyName?.value||`Полигон ${db.polygons.length+1}`).trim(),color:$polyColor?.value||'#ff4d4f',visible:true,geojson:layer.toGeoJSON()};
    db.polygons.push(rec); polyIndex.set(rec.id,layer); pushHistoryPoly(rec); await save(db);
    setCenterLabel(rec);
    renderPolyList();
  } else {
    if(e.layer) e.layer.addTo(map);
  }
});

map.on(L.Draw.Event.EDITSTOP,async ()=>{
  for(const p of db.polygons){
    const l=polyIndex.get(p.id); if(l) p.geojson=l.toGeoJSON();
    setCenterLabel(p);
  }
  clearEdgeLabels(); // в обычном режиме рёбра чистые
  await save(db);
  renderPolyList();
});

map.on('draw:editvertex', ()=>{
  if(!polyEditingTargetId) return;
  const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
  const l=polyIndex.get(p.id); if(!l) return;
  p.geojson=l.toGeoJSON(); pushHistoryPoly(p);
  setCenterLabel(p);
  refreshEdgeLabels();
});

/* ====== ОСТАЛЬНЫЕ ЧАСТИ ПРИЛОЖЕНИЯ (усечённый UI без потери полигон-фич) ====== */
let db=null;

/* — простые заглушки категорий и предпросмотра (для совместимости) — */
function markerIcon(){ return L.divIcon({className:"custom-icon",html:`<div style="background:#3388ff;width:18px;height:18px;border-radius:50%;border:2px solid #fff"></div>`,iconSize:[20,20],iconAnchor:[10,10]}); }
function addMarkerForItem(it){ if(it.lat==null||it.lng==null) return; const m=L.marker([it.lat,it.lng],{icon:markerIcon(),_itemId:it.id,draggable:true}); m.addTo(cluster); }
function getSelectedItemNames(){ return new Set(); } // в этой сборке полигоны показываются всегда, если включены вручную
function updatePolygonVisibility(){
  for(const p of db.polygons){
    const layer=polyIndex.get(p.id); if(!layer) continue;
    const filtered=(p.visible!==false);
    if(filtered) layer.addTo(map); else map.removeLayer(layer);
    setCenterLabel(p);
  }
}

function renderEditor(){
  const $editor=document.getElementById('editorTab');
  $editor.innerHTML="";
  const info=document.createElement('div'); info.className='panel';
  info.innerHTML="<h3>Редактор категорий (сокращённая версия)</h3><div class='help'>Функции категорий и предпросмотра урезаны, фокус этого билда — полигоны: площадь в центре и размеры рёбер при редактировании.</div>";
  $editor.appendChild(info);

  // Простая панель "Переименовать активный полигон"
  const polyPanel=document.createElement('div'); polyPanel.className='panel';
  polyPanel.innerHTML=`<h3>Полигон: название и цвет</h3>
    <div class="row">
      <input id="polyNameTop" placeholder="Название"/> 
      <input id="polyColorTop" type="color" value="#ff4d4f"/>
      <button id="applyPolyNameColor">Применить к активному</button>
    </div>`;
  $editor.appendChild(polyPanel);

  const $nameTop=polyPanel.querySelector('#polyNameTop');
  const $colorTop=polyPanel.querySelector('#polyColorTop');
  polyPanel.querySelector('#applyPolyNameColor').onclick=async()=>{
    if(!polyEditingTargetId){ alert('Сначала включи Редактировать и выбери полигон'); return; }
    const p=db.polygons.find(x=>x.id===polyEditingTargetId); if(!p) return;
    if($nameTop.value.trim()) p.name=$nameTop.value.trim();
    if($colorTop.value) p.color=$colorTop.value;
    const l=polyIndex.get(p.id); if(l&&l.setStyle) l.setStyle({color:p.color});
    await save(db); setCenterLabel(p); renderPolyList();
  };
}
function renderPreview(){ /* опущено */ }

/* ====== Экспорт/импорт, инфо и пр. ====== */
document.getElementById('btnExport').onclick=async ()=>{
  const full=JSON.parse(JSON.stringify(db));
  for(const p of (full.polygons||[])){ if(!p.geojson){ try{ p.geojson=await lfGeo.getItem(p.id)||null; }catch(e){} } }
  const blob=new Blob([JSON.stringify(full,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dict_full_v39_4R.json'; a.click();
};
document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ()=>{
    try{
      let obj=JSON.parse(r.result); if(obj && obj.db) obj=obj.db;
      if(!Array.isArray(obj.categories)) obj.categories=[];
      if(!Array.isArray(obj.polygons))   obj.polygons=[];
      for(const p of obj.polygons){ if(!p.id) p.id=uid(); if(p.geojson){ await lfGeo.setItem(p.id,p.geojson); } }
      localStorage.setItem(KEY, JSON.stringify({
        categories:obj.categories.map(c=>({id:c.id,name:c.name,type:c.type,parentCategoryId:c.parentCategoryId||null,color:c.color,shape:c.shape,iconKey:c.iconKey||null,items:(c.items||[]).map(it=>({id:it.id,name:it.name,parentId:it.parentId||null,lat:it.lat,lng:it.lng,iconKey:it.iconKey||null}))})),
        polygons:(obj.polygons||[]).map(p=>({id:p.id,name:p.name,color:p.color,visible:p.visible}))
      }));
      db = await loadDB();
      pushHistory(); renderAll();
      alert('Импортировано');
    }catch(err){ alert('Ошибка импорта: '+err.message); }
  };
  r.readAsText(f);
};
document.getElementById('btnInfo').onclick=()=>{
  const polys=(db.polygons||[]).length;
  alert('Полигонов: '+polys);
};
document.getElementById('btnUndo').onclick=()=>{ if(historyStack.length&&historyIndex>0){ historyIndex--; db=JSON.parse(historyStack[historyIndex]); renderAll(); } };
document.getElementById('btnRedo').onclick=()=>{ if(historyStack.length&&historyIndex<historyStack.length-1){ historyIndex++; db=JSON.parse(historyStack[historyIndex]); renderAll(); } };
document.getElementById('btnReset').onclick=()=>{
  if(confirm('Очистить всё?')){
    localStorage.removeItem(KEY);
    lfIcons.clear().then(()=>{}); lfGeo.clear().then(()=>{});
    location.reload();
  }
};

/* ====== Глобальная история (минимальная) ====== */
let historyStack=[],historyIndex=-1,historyLimit=80;
function pushHistory(){
  const snap=JSON.stringify(db);
  if(historyIndex<historyStack.length-1) historyStack.splice(historyIndex+1);
  historyStack.push(snap);
  if(historyStack.length>historyLimit){ historyStack.shift(); historyIndex=historyStack.length-1; } else { historyIndex=historyStack.length-1; }
}

/* ====== РЕНДЕР ВСЕГО ====== */
async function renderAll(){
  rebuildPolys();
  renderEditor();
  renderPreview();
  renderPolyList();
}

/* ====== СТАРТ ====== */
let dbReady=false;
(async()=>{
  db = await loadDB();
  pushHistory();
  await renderAll();
  dbReady=true;
})();
</script>
</body>
</html>